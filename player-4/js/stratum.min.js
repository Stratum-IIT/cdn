(function(){"use strict";try{if(typeof document<"u"){var e=document.createElement("style");e.appendChild(document.createTextNode(".Lub8lEDq{position:relative;width:100%;height:100%;overflow:hidden;background-color:#fff}.Lub8lEDq .gAt88WSK,.Lub8lEDq .f-yoEwGQ{pointer-events:none;position:absolute;overflow:hidden;top:0;left:0;width:100%;height:100%}.f-yoEwGQ ._3Au4Qe-K{position:absolute}.f-yoEwGQ textarea._3Au4Qe-K{resize:none;overflow:hidden}.f-yoEwGQ textarea._3Au4Qe-K,.f-yoEwGQ input[type=text]._3Au4Qe-K{outline:none;margin:0;padding:0;box-sizing:border-box;border:inset 2px}.b9uJR8ps{position:relative;width:100%;max-width:800px;height:420px;margin:40px auto;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;background:#fafafa}.Zvmz0cJJ{position:absolute;inset:0;background:#00000080;display:none;align-items:center;justify-content:center;padding:16px}.Zvmz0cJJ._6pvXMwET{display:flex}._8OpWP1FD{width:min(520px,100%);background:#fff;border-radius:16px;box-shadow:0 10px 30px #00000040;padding:20px}._8OpWP1FD header{display:flex;align-items:center;gap:12px;margin-bottom:12px}._8OpWP1FD h2{margin:0;font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}._8OpWP1FD p{margin:8px 0 16px;color:#4b5563;font-size:14px}.-RCrm1Nm{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:8px 0 20px}.GMXl88rY{height:40px;display:flex;align-items:center;padding:0 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;color:#374151;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}._95llu-Ce{display:flex;justify-content:flex-end;gap:10px}.wpDiowrl{height:40px;padding:0 14px;border:1px solid transparent;border-radius:10px;background:#111827;color:#fff;font:500 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;cursor:pointer}.wpDiowrl input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}label.wpDiowrl{position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 14px;border-radius:10px;background:#111827;color:#fff;font:500 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;cursor:pointer}label.wpDiowrl input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;display:none}.wpDiowrl:focus-visible{outline:2px solid #6366f1;outline-offset:2px}.wpDiowrl:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.wpDiowrl.uxkYldVD{background:#fff;color:#111827;border-color:#e5e7eb}")),document.head.appendChild(e)}}catch(o){console.error("vite-plugin-css-injected-by-js",o)}})();
var stratumPlayer=(function(lt){"use strict";const er=document.createElement("a");function Yr(e,t){const r=URL.createObjectURL(e);er.href=r,er.download=t,er.click(),setTimeout(()=>URL.revokeObjectURL(r),1e3)}function zr(e,t){t.target===e&&t.preventDefault()}class Fe{constructor(t=window){this.frameId=0,this.runner=t.requestAnimationFrame}get running(){return this.frameId!==0}run(t){if(this.running)return;const{runner:r}=this,s=()=>{this.frameId=t()?r(s):0};this.frameId=r(s)}stop(){this.running&&(cancelAnimationFrame(this.frameId),this.frameId=0)}}function On(e){return new Promise((t,r)=>{const s=new Image;s.onload=()=>t(s),s.onerror=()=>r(new Error(`Ошибка загрузки ${e}`)),s.src=e})}const Rt={baseUrl:"./content"};function We(e){return e.startsWith("blob:")?e:Rt.legacyMode||e.startsWith("library")||e.startsWith("icons")?`${Rt.baseUrl}/${e}`:`${Rt.baseUrl}/${e[0]}/${e}`}const Mn=["gray","blue","navy","gray","#b5b5b5","white","black","black","black","white","gray","gray","gray","navy","white","#b5b5b5","gray","gray","black","gray","white"],at=1<<24,Ot=2<<24,qr=4<<24;function vn(e){const t=parseInt(e);if(!isNaN(t))return t;const r=e.toLowerCase().trim();if(r.startsWith("rgb")){const s=r.split("(")[1].split(")")[0].split(",").map(i=>parseInt(i));return s[0]|s[1]<<8|s[2]<<16}return r.startsWith("transparent")?at:r.startsWith("syscolor")?Ot|parseInt(r.split("(")[1].split(")")[0]):0}function tr(e){if(e&at)return null;const t=e&255;if(e&Ot)return Mn[t]||"black";const r=e>>8&255,s=e>>16&255;return e&qr?`rgba(${t},${r},${s}, 0.5)`:`rgb(${t},${r},${s})`}function Kr(e,t,r,s){const i=s==="transparent"?at:s==="syscolor"?Ot:s==="editor"?qr:0;return e&255|(t&255)<<8|(r&255)<<16|i}function Sn(e){return e&255}function An(e){return e>>8&255}function Nn(e){return e>>16&255}function In(e){if(e&at)return"Transparent";const t=e&255;if(e&Ot)return`SysColor(${t})`;const r=e>>8&255,s=e>>16&255;return`rgb(${t},${r},${s})`}const Ve=1,rr=2,sr=4,ir=8;function ze(e){return e>>8&31}const xn=1,Pn=2,Dn=4,kn=8;/**
Copyright (c) 2020 Egor Nepomnyaschih @license (MIT)
*/const be=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Zr=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function Mt(e){if(e>=Zr.length)throw new Error("Unable to parse base64 string.");const t=Zr[e];if(t===255)throw new Error("Unable to parse base64 string.");return t}function Jr(e){let t="",r,s=e.length;for(r=2;r<s;r+=3)t+=be[e[r-2]>>2],t+=be[(e[r-2]&3)<<4|e[r-1]>>4],t+=be[(e[r-1]&15)<<2|e[r]>>6],t+=be[e[r]&63];return r===s+1&&(t+=be[e[r-2]>>2],t+=be[(e[r-2]&3)<<4],t+="=="),r===s&&(t+=be[e[r-2]>>2],t+=be[(e[r-2]&3)<<4|e[r-1]>>4],t+=be[(e[r-1]&15)<<2],t+="="),t}function Qr(e){if(e.length%4!==0)throw new Error("Unable to parse base64 string.");const t=e.indexOf("=");if(t!==-1&&t<e.length-2)throw new Error("Unable to parse base64 string.");let r=e.endsWith("==")?2:e.endsWith("=")?1:0,s=e.length,i=new Uint8Array(3*(s/4)),n;for(let l=0,a=0;l<s;l+=4,a+=3)n=Mt(e.charCodeAt(l))<<18|Mt(e.charCodeAt(l+1))<<12|Mt(e.charCodeAt(l+2))<<6|Mt(e.charCodeAt(l+3)),i[a]=n>>16,i[a+1]=n>>8&255,i[a+2]=n&255;return i.subarray(0,i.length-r)}const _e=[...Array.from({length:128},(e,t)=>String.fromCharCode(t)),"Ђ","Ѓ","‚","ѓ","„","…","†","‡","€","‰","Љ","‹","Њ","Ќ","Ћ","Џ","ђ","‘","’","“","”","•","–","—","","™","љ","›","њ","ќ","ћ","џ"," ","Ў","ў","Ћ","¤","Ґ","¦","§","Ё","©","Є","«","¬","","®","Ї","°","±","І","і","ґ","µ","¶","·","ё","№","є","»","ј","Ѕ","ѕ","ї","А","Б","В","Г","Д","Е","Ж","З","И","Й","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ъ","Ы","Ь","Э","Ю","Я","а","б","в","г","д","е","ж","з","и","й","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я"];function nr(e){return Array.from(e).map(t=>_e[t]).join("")}const vt=32,Ln=10;function es(e){return new Uint8Array([...e].map(t=>{const r=_e.indexOf(t);return r>-1?r:vt}))}class Ne{constructor(){this.listeners=new Set,this.listenersOnce=new Set}add(t){this.listeners.add(t)}addOnce(t){this.listenersOnce.add(t)}remove(t){this.listeners.delete(t),this.listenersOnce.delete(t)}dispatch(...t){this.listeners.forEach(r=>r(...t)),this.listenersOnce.forEach(r=>r(...t)),this.listenersOnce.clear()}}new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare;/**
 * Gauss-Jordan elimination by lovasoa (https://github.com/lovasoa) @license (MIT)
 */class or{constructor(t,r){this.data=new Array(t.length);for(let s=0,i=t[0].length;s<t.length;s++){this.data[s]=new Array(i);for(let n=0;n<i;n++)this.data[s][n]=t[s][n]}if(r){if(typeof r[0]!="object")for(let s=0;s<r.length;s++)r[s]=[r[s]];this.mirror=new or(r)}}swap(t,r){this.mirror&&this.mirror.swap(t,r);const s=this.data[t];this.data[t]=this.data[r],this.data[r]=s}multline(t,r){this.mirror&&this.mirror.multline(t,r);const s=this.data[t];for(let i=s.length-1;i>=0;i--)s[i]*=r}addmul(t,r,s){this.mirror&&this.mirror.addmul(t,r,s);const i=this.data[t],n=this.data[r];for(let l=i.length-1;l>=0;l--)i[l]=i[l]+s*n[l]}hasNullLine(t){for(let r=0;r<this.data[t].length;r++)if(this.data[t][r]!==0)return!1;return!0}gauss(){let t=0;const r=this.data.length,s=this.data[0].length,i=[];for(let n=0;n<s;n++){let l=0,a=0;for(let u=t;u<r;u++){const d=this.data[u][n];Math.abs(d)>Math.abs(l)&&(a=u,l=d)}if(l===0)i.push(t);else{this.multline(a,1/l),this.swap(a,t);for(let u=0;u<r;u++)u!==t&&this.addmul(u,t,-this.data[u][n])}t++}for(let n=0;n<i.length;n++)if(!this.mirror.hasNullLine(i[n]))throw new Error("singular matrix");return this.mirror.data}}function Gn(e){const{a:t,b:r}=e,s=new or(t,r).gauss();if(s.length>0&&s[0].length===1)for(let i=0;i<s.length;i++)s[i]=s[i][0];return s}function ts(e,t,r,s){const i=r-e,n=s-t;return Math.sqrt(i*i+n*n)}function rs(e,t,r,s,i){for(let n=t?0:2,l=t?e.length-2:0;n<e.length;l=n,n+=2){const a=e[n],u=e[n+1],d=e[l],p=e[l+1],_=a-d,T=u-p,m=_*_+T*T;if(m===0&&ts(s,i,d,p)<=r)return l/2;let R=((s-d)*_+(i-p)*T)/m;if(R=Math.max(0,Math.min(1,R)),ts(s,i,d+R*_,p+R*T)<=r)return l/2}return-1}function Bn(e,t,r){let s=!1;for(let i=0,n=e.length-2;i<e.length;n=i,i+=2){const l=e[i],a=e[i+1],u=e[n],d=e[n+1];(a<=r&&r<d||d<=r&&r<a)&&d-a!==0&&t>(u-l)*(r-a)/(d-a)+l&&(s=!s)}return s}function Cn(e){const t=e[0]*(e[4]*e[8]-e[7]*e[5])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]);return[(e[4]*e[8]-e[7]*e[5])/t,(e[2]*e[7]-e[1]*e[8])/t,(e[1]*e[5]-e[2]*e[4])/t,(e[5]*e[6]-e[3]*e[8])/t,(e[0]*e[8]-e[2]*e[6])/t,(e[3]*e[2]-e[0]*e[5])/t,(e[3]*e[7]-e[6]*e[4])/t,(e[6]*e[1]-e[0]*e[7])/t,(e[0]*e[4]-e[3]*e[1])/t]}class Re{constructor(t){this.m=new Map,t?.forEach(([r,s])=>this.set(r,s))}set(t,r){const s=this.m.get(t);return s?s.add(r):this.m.set(t,new Set([r])),this}get(t){return this.m.get(t)??null}delete(t){return this.m.delete(t)}forEach(t){return this.m.forEach(t)}[Symbol.iterator](){return this.m.entries()}values(){return this.m.values()}}const Un=[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","!","∀","#","∃","%","&","∍","(",")","*","+",",","−",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","≅","Α","Β","Χ","Δ","Ε","Φ","Γ","Η","Ι","ϑ","Κ","Λ","Μ","Ν","Ο","Π","Θ","Ρ","Σ","Τ","Υ","ς","Ω","Ξ","Ψ","Ζ","[","∴","]","⊥","_","‾","α","β","χ","δ","ε","φ","γ","η","ι","ϕ","κ","λ","μ","ν","ο","π","θ","ρ","σ","τ","υ","ϖ","ω","ξ","ψ","ζ","{","|","}","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","€","ϒ","′","≤","⁄","∞","ƒ","♣","♦","♥","♠","↔","←","↑","→","↓","°","±","″","≥","×","∝","∂","•","÷","≠","≡","≈","…","⏐","⎯","↵","ℵ","ℑ","ℜ","℘","⊗","⊕","∅","∩","∪","⊃","⊇","⊄","⊂","⊆","∈","∉","∠","∇","®","©","™","∏","√","⋅","¬","∧","∨","⇔","⇐","⇑","⇒","⇓","◊","〈","®","©","™","∑","⎛","⎜","⎝","⎡","⎢","⎣","⎧","⎨","⎩","⎪"," ","〉","∫","⌠","⎮","⌡","⎞","⎟","⎠","⎤","⎥","⎦","⎫","⎬","⎭"," "];function Fn(e){let t="";for(let r=0;r<e.length;++r){let s=_e.indexOf(e[r]);s===142?s=163:s<0&&(s=0),t+=Un[s]}return t}class ue extends Map{static freeKey(t,r){let s=r||0;for(;t.has(++s););return s}static freeNegativeKey(t){let r=0;for(;t.has(--r););return r}}function ss(e){return e||void 0}function is(e){return(e&e-1)===0}function ns(e){return new Array().concat(...e)}function os(e,t){const r=[];for(const s of e)t(s)&&r.push(s);return r}function cs(e,t){return e.filter(r=>r!==t)}function Wn(e,t){const r=[];for(const s of e){const i=t(s);i&&r.push(i)}return r}function Vn(e){return Math.round(e*1e5)/1e5}class $e{constructor(t,r,{key:s,data:i}){this.scene=t,this.m=r,this.subs=new Set,this.key=s||ue.freeKey(r),this.key>0&&this.m.set(this.key,this),this.data=i?{...i}:{}}delete(){return this.subs.size?!1:(this.key>0&&this.m.delete(this.key),this.key=0,!0)}toJSON(){const{key:t,data:r}=this;let s;for(const i in r)typeof r[i]<"u"&&((s||={})[i]=r[i]);return s?{key:t,data:s}:{key:t}}}class qe extends $e{constructor(t,r){super(t,t.objects,r),this.parent=null,this._deletedByParent=!1;const{x:s,y:i,width:n,height:l,attrib:a}=r;this.x=s??0,this.y=i??0,this.width=n??0,this.height=l??0,this.attrib=a??0}delete(){if(super.delete(),this._deletedByParent)return!0;const{parent:t,scene:r}=this;return t?.set({children:t.children.filter(s=>s.key)}),r.set({order:r.order.filter(s=>s.key)}),!0}set(t){const{attrib:r,x:s,y:i,width:n,height:l}=t;this.attrib=r??this.attrib;let a=!1;{const u=(s??this.x)-this.x,d=(i??this.y)-this.y;(u!==0||d!==0)&&(this._virtualMoved(u,d),a=!0)}if(n||l){const u=this.width||1,d=this.height||1,p=n&&n>0?n:u,_=l&&l>0?l:d,T=p/u,m=_/d;(T!==1||m!==1)&&(this._virtualResized(this.x,this.y,T,m),a=!0)}return a&&this.parent?._childChanged(),this.scene._dirty=!0,this}rotate(t,{x:r,y:s}={x:this.x,y:this.y}){return t===0?this:(this._virtualRotated(r,s,t),this.parent?._childChanged(),this)}_virtualUpdateBBox(t,r,s,i){this.x=t,this.y=r,this.width=s,this.height=i}_virtualMoved(t,r){this._virtualUpdateBBox(this.x+t,this.y+r,this.width,this.height)}_virtualResized(t,r,s,i){const n=t+(this.x-t)*s,l=r+(this.y-r)*i,a=(this.width||1)*s,u=(this.height||1)*i;this._virtualUpdateBBox(n,l,a,u)}_virtualRotated(t,r,s){const i=Math.sin(s),n=Math.cos(s),l=this.x-t,a=this.y-r,u=l*n-a*i+t,d=l*i+a*n+r;this._virtualUpdateBBox(u,d,this.width,this.height)}toJSON(){const{attrib:t,height:r,width:s,x:i,y:n}=this;return{...super.toJSON(),attrib:t,height:r,width:s,x:i,y:n}}toString(){return"Графический элемент"}}class $n extends qe{constructor(t,r,s){super(t,s),this.type="group",this.children=[],this.set({...s,children:r})}delete(t){return this.children.forEach(r=>{r._deletedByParent=!0,r.delete(t)}),super.delete()}set(t,r){typeof t.children<"u"&&(this.children.forEach(i=>i.parent=null),this.children=t.children,this.children.forEach(i=>i.parent=this),this.children.length>0?this._childChanged():(this._virtualUpdateBBox(this.x,this.y,0,0),this.parent?._childChanged()));const{attrib:s}=t;return typeof s<"u"&&!r&&this.children.forEach(i=>i.set({attrib:s})),super.set(t)}_childChanged(){let t=1/0,r=-1/0,s=1/0,i=-1/0;this.children.forEach(n=>{t=Math.min(t,n.x),s=Math.min(s,n.y),r=Math.max(r,n.x+n.width),i=Math.max(i,n.y+n.height)}),this._virtualUpdateBBox(t,s,r-t,i-s),this.parent?._childChanged()}_virtualMoved(t,r){if(this.children.length===0){super._virtualMoved(t,r);return}this.children.forEach(s=>s._virtualMoved(t,r)),this._virtualUpdateBBox(this.x+t,this.y+r,this.width,this.height)}_virtualResized(t,r,s,i){if(this.children.length===0){super._virtualResized(t,r,s,i);return}let n=1/0,l=-1/0,a=1/0,u=-1/0;this.children.forEach(d=>{d._virtualResized(t,r,s,i),n=Math.min(n,d.x),a=Math.min(a,d.y),l=Math.max(l,d.x+d.width),u=Math.max(u,d.y+d.height)}),this._virtualUpdateBBox(n,a,l-n,u-a)}_virtualRotated(t,r,s){if(this.children.length===0){super._virtualRotated(t,r,s);return}let i=1/0,n=-1/0,l=1/0,a=-1/0;this.children.forEach(u=>{u._virtualRotated(t,r,s),i=Math.min(i,u.x),l=Math.min(l,u.y),n=Math.max(n,u.x+u.width),a=Math.max(a,u.y+u.height)}),this._virtualUpdateBBox(i,l,n-i,a-l)}*descendants(t){for(const r of this.children)t&&r.key<=0||(r.type==="group"&&(yield*r.descendants(t)),yield r)}toJSON(){const{type:t}=this,{x:r,y:s,width:i,height:n,...l}=super.toJSON(),a=this.children.filter(u=>u.key>0).map(u=>u.key);return{...l,type:t,children:a}}toString(){return"Группа"}}class jn{constructor(){this.type="scene",this._dirty=!0,this.x=0,this.y=0,this.order=[],this.background=null,this.hiddenLayers=0,this.grid=null,this.cursor=null,this.selectUnselectable=!1,this.disableInputs=!1,this.objects=new Map,this.pens=new Map,this.brushes=new Map,this.images=new Map,this.imagesOpaque=new Map,this.strings=new Map,this.fonts=new Map,this.texts=new Map,this.oninputchanged=null}set({x:t=this.x,y:r=this.y,order:s=this.order,hiddenLayers:i=this.hiddenLayers,selectUnselectable:n=this.selectUnselectable,disableInputs:l=this.disableInputs,grid:a=this.grid,background:u=this.background,cursor:d=this.cursor}){if(this.background!==u&&(this.background?.subs.delete(this),this.background=u,this.background?.subs.add(this)),this.disableInputs!==l){const p=l?"none":"auto";this.objects.forEach(_=>{_.type==="input"&&(_._html.style.pointerEvents=p)})}return this.x=Math.round(t),this.y=Math.round(r),this.order=s,this.hiddenLayers=i,this.selectUnselectable=n,this.disableInputs=l,this.grid=a,this.cursor=d,this}pick(t,r){const{order:s,hiddenLayers:i,selectUnselectable:n}=this;for(let l=s.length-1;l>=0;--l){const a=s[l],u=a.attrib,d=u&Ve,p=u&rr,_=u&sr,T=u&ir,m=ze(u);if(d||T&&!n||!p&&1<<m&i||_)continue;let R=t-a.x,N=r-a.y,O=0;if(a.type==="line"){if(a.pen)O=a.pen.width/2||.5;else if(!a.brush)continue;O=Math.max(O,4)}else if(a.type==="textView"||a.type==="imageView"){const k=Math.sin(-a.angle),L=Math.cos(-a.angle),U=R*L-N*k,F=R*k+N*L;R=U,N=F}if(!(R<-O||R>a.width+O||N<-O||N>a.height+O)&&!(a.type==="line"&&!a.inside(R,N,O)))return a}return null}fromJSON(t){this.set({...t,background:void 0,order:void 0}).merge(t,"exact");const r=t.background&&this.brushes.get(t.background);r&&this.set({background:r})}toJSON(){const{background:t,x:r,y:s,hiddenLayers:i,selectUnselectable:n,grid:l,pens:a,brushes:u,images:d,imagesOpaque:p,fonts:_,strings:T,texts:m,objects:R,order:N}=this;return{background:t?.key,x:r,y:s,hiddenLayers:i,selectUnselectable:n,grid:l,pens:[...a.values()].map(O=>O.toJSON()),brushes:[...u.values()].map(O=>O.toJSON()),images:[...d.values()].map(O=>O.toJSON()),imagesOpaque:[...p.values()].map(O=>O.toJSON()),fonts:[..._.values()].map(O=>O.toJSON()),strings:[...T.values()].map(O=>O.toJSON()),texts:[...m.values()].map(O=>O.toJSON()),objects:[...R.values()].map(O=>O.toJSON()),order:N.filter(O=>O.key>0).map(O=>O.key)}}merge(t,r="free",s){const i=r==="free"?0:-1;function n(I,X){return r==="exact"?X?{...I,...X}:I:{...I,...X,key:i}}const l=t.pens?.map(I=>[I.key,this.pen(n(I))]),a=t.images?.map(I=>[I.key,this.image(I,n(I))]),u=t.imagesOpaque?.map(I=>[I.key,this.image(I,n(I,{opaque:!0}))]),d=t.fonts?.map(I=>[I.key,this.font(n(I))]),p=t.strings?.map(I=>[I.key,this.string(I.text||"",n(I))]),_=l?new Map(l):this.pens,T=a?new Map(a):this.images,m=u?new Map(u):this.imagesOpaque,R=d?new Map(d):this.fonts,N=p?new Map(p):this.strings,O=t.brushes?.map(I=>{const X=I.image&&m.get(I.image)||null;return[I.key,this.brush(n(I,{image:X}))]}),k=O?new Map(O):this.brushes,L=t.texts?.map(I=>{const X=I.parts.map((K,J)=>{const he=R.get(K.font)||Ie(`Текст #${I.key}[${J}]: Шрифт #${K.font} не существует`),le=N.get(K.string)||Ie(`Текст #${I.key}[${J}]: Строка #${K.string} не существует`);return{...K,font:he,string:le}});return[I.key,this.text(X,n(I))]}),U=L?new Map(L):this.texts,F=[],j=t.objects?.map(I=>{switch(I.type){case"line":{const X=I.pen&&_.get(I.pen)||null,K=I.brush&&k.get(I.brush)||null;return[I.key,this.line(I.coords,n(I,{pen:X,brush:K}))]}case"imageView":{const K=(I.opaque?m:T).get(I.image)||Ie(`ImageView (opaque: ${I.opaque}) #${I.key}: Изображение #${I.image} не существует`);return[I.key,this.imageView(K,n(I))]}case"textView":{const X=U.get(I.text)||Ie(`TextView #${I.key}: Текст #${I.text} не существует`);return[I.key,this.textView(X,n(I))]}case"input":{const X=I.font&&R.get(I.font)||null;return[I.key,this.input(I.inputType,n(I,{font:X}))]}case"videoView":return[I.key,this.video(We(I.src),n(I))];case"group":{const X=this.group([],n(I));return F.push({g:X,o:I}),[I.key,X]}case"3dView":throw Error(`Объект #${I.key} является 3D проекцией. Они еще не реализованы.`)}}),B=new Map(j);for(const{g:I,o:X}of F){const K=X.children.map(J=>B.get(J)||Ie(`Группа #${I.key}: Объект #${J} не существует.`));I.set({children:K})}const D=t.order?.map(I=>{const X=B.get(I)||Ie(`Объект #${I} не существует и не может быть отображен.`);return X.type==="group"&&Ie(`Объект #${I} является группой и не может быть отображен.`),X});return!s&&D?.length&&this.set({order:this.order.concat(D)}),{objects:B,brushes:k,fonts:R,images:T,imagesOpaque:m,pens:_,strings:N,texts:U,order:D||[]}}_exist(t,r){return r&&r.key&&r.key>0&&t.get(r.key)}_not(t,r){return r&&r.key&&r.key>0&&t.get(r.key)&&Ie(`Объект #${r.key} уже существует`),!0}group(t,r={}){return this._not(this.objects,r)&&new $n(this,t,r)}line(t,r){return this._not(this.objects,r)&&this._line(t,r)}imageView(t,r){return this._not(this.objects,r)&&this._imageView(t,r)}textView(t,r){return this._not(this.objects,r)&&this._textView(t,r)}input(t,r){return this._not(this.objects,r)&&this._input(t,r)}video(t,r){return this._not(this.objects,r)&&this._video(t,r)}pen(t){return this._exist(this.pens,t)||this._pen(t)}brush(t){return this._exist(this.brushes,t)||this._brush(t)}image(t,r){return this._exist(r?.opaque?this.imagesOpaque:this.images,r)||this._image(t,r)}string(t,r){return this._exist(this.strings,r)||this._string(t,r)}font(t){return this._exist(this.fonts,t)||this._font(t)}text(t,r){return this._exist(this.texts,r)||this._text(t,r)}}function Ie(e){throw Error(e)}class Hn extends qe{constructor(t,r,s){const i={...s,width:s.width??r.width,height:s.height??r.height,image:r};super(t,i),this.image=r,this.type="imageView",this.area=null,this.opaque=s.opaque??!1,r.subs.add(this),this.angle=s.angle||0,this.set(i)}set({area:t=this.area,image:r=this.image,...s}){return this.image!==r&&(this.image.subs.delete(this),this.image=r,this.image.subs.add(this)),this.area=t,super.set(s)}_virtualRotated(t,r,s){super._virtualRotated(t,r,s),this.angle+=s}toJSON(){const{image:t,area:r,opaque:s,type:i,angle:n}=this;return{...super.toJSON(),type:i,image:t.key,area:r,opaque:s,angle:n}}delete(t){const{image:r}=this;return r.subs.delete(this),t||r.delete(),super.delete()}toString(){return"Картинка"}}class Xn extends Hn{constructor(t,r,s){super(t,r,s),this._svg=document.createElementNS("http://www.w3.org/2000/svg","image"),this._visible=!0,this._src=null,this._area=null,this._x=0,this._y=0,this._w=0,this._h=0,this._angle=0,this.clipRect=null,this.hasArea=!0,this._svg.setAttribute("preserveAspectRatio","none")}_render(){const t=this.attrib,r=t&Ve,s=ze(t),i=!(r||1<<s&this.scene.hiddenLayers);if(this._visible!==i&&(this._visible=i,i?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!i)return;const n=this.image,l=this._src!==n.realSrc;l&&this._svg.setAttribute("href",this._src=n.realSrc);const a=this.area,u=!!a,d=this.hasArea!==u;this.hasArea=u;const p=this._area!==a||l;if(p){this._area=a;const O=n.width,k=n.height;if(a){const L=Math.min(Math.max(a.x,0),O),U=Math.min(Math.max(a.y,0),k),F=Math.min(Math.max(a.w,0),O-L),j=Math.min(Math.max(a.h,0),k-U);if(!this.clipRect){const{id:D,rect:I}=this.scene._createClipRect();this._svg.setAttribute("clip-path",`url(#${D})`),this.clipRect=I}const{clipRect:B}=this;B.setAttribute("x",L.toString()),B.setAttribute("y",U.toString()),B.setAttribute("width",F.toString()),B.setAttribute("height",j.toString())}else this._svg.removeAttribute("clip-path"),this.clipRect?.remove(),this.clipRect=null}const _=this.x-this.scene.x,T=this.y-this.scene.y,m=this.width,R=this.height,N=this.angle;if(_!==this._x||T!==this._y||this._w!==m||this._h!==R||this._angle!==N||p){const{area:O}=this;this._x=_,this._y=T,this._w=m,this._h=R,this._angle=N;let k=`translate(${_}, ${T}),rotate(${N*180/Math.PI})`;O?k+=`scale(${m/O.w}, ${R/O.h}), translate(${-O.x}, ${-O.y})`:(this._svg.setAttribute("width",m.toString()),this._svg.setAttribute("height",R.toString())),this._svg.setAttribute("transform",k),d&&(u?(this._svg.removeAttribute("width"),this._svg.removeAttribute("height")):(this._svg.setAttribute("width",m.toString()),this._svg.setAttribute("height",R.toString())))}}}class Yn extends qe{constructor(t,r,s){super(t,s),this.inputType=r,this.type="input",this.value="",this.style=0,this.font=null,this.set(s)}set({value:t=this.value,style:r=this.style,font:s=this.font,...i}){return this.value=t,this.style=r,this.font!==s&&(this.font?.subs.delete(this),this.font=s,this.font?.subs.add(this)),super.set(i)}toJSON(){const{inputType:t,style:r,font:s,type:i,value:n}=this;return{...super.toJSON(),type:i,inputType:t,exStyle:0,font:s?.key,style:r,value:n}}delete(t){const{font:r}=this;return r&&(r.subs.delete(this),t||r.delete()),super.delete()}toString(){return`Элемент интерфейса '${this.inputType}'`}}const St={"jf-scene":"Lub8lEDq","jf-scene-svg":"gAt88WSK","jf-scene-html":"f-yoEwGQ","jf-input":"_3Au4Qe-K"},ls=4,zn=64;class qn extends Yn{constructor(t,r,s){super(t,r,s),this._svg=!1,this._visible=!0,this._css=null,this._value="",this._x=0,this._y=0,this._w=0,this._h=0;const{style:i=0}=s;let n;i&ls?n=document.createElement("textarea"):(n=document.createElement("input"),r==="Button"?n.type="button":n.type="text"),r==="Button"?n.addEventListener("click",this):n.addEventListener("input",this),n.tabIndex=-1,n.className=St["jf-input"],n.spellcheck=!1,n.name=`jf-${this.key}`,n.addEventListener("focus",this),n.addEventListener("blur",this),this.st=n.style,this.st.pointerEvents=t.disableInputs?"none":"auto",this._html=n}handleEvent(t){const{scene:r,_html:s,style:i}=this;i&ls&&!(i&zn)&&s.scrollHeight>s.clientHeight&&(s.value=s.value.slice(0,-1)),this.value=this._value=s.value,r.oninputchanged?.({type:t.type,scene:r,target:this})}_render(){const t=this.attrib,r=t&Ve,s=ze(t),i=!(r||1<<s&this.scene.hiddenLayers);if(this._visible!==i&&(this._visible=i,i?this.st.removeProperty("display"):this.st.setProperty("display","none")),!i)return;const n=this.font?.css()||null;if(this._css!==n)if(this._css=n,n){const _=`${n.fontWeight} ${n.fontStyle} ${n.fontSize*.566726660156244}px ${n.fontFamily}`;this.st.setProperty("font",_)}else this.st.removeProperty("font");this._value!==this.value&&(this._html.value=this._value=this.value);const l=this.x-this.scene.x,a=this.y-this.scene.y,u=this.width,d=this.height;this._x!==l&&this.st.setProperty("left",(this._x=l).toString()+"px"),this._y!==a&&this.st.setProperty("top",(this._y=a).toString()+"px"),this._w!==u&&this.st.setProperty("width",(this._w=u).toString()+"px"),this._h!==d&&this.st.setProperty("height",(this._h=d).toString()+"px")}}class Kn extends qe{constructor(t,r,s){super(t,s),this.type="line",this._coordsDirty=!0,this.pen=null,this.brush=null,this.start=null,this.end=null,this.setCoords(r).set(s)}get length(){return this.coords.length/2}set({pen:t=this.pen,brush:r=this.brush,start:s=this.start,end:i=this.end,...n}){return this.pen!==t&&(this.pen?.subs.delete(this),this.pen=t,this.pen?.subs.add(this)),this.brush!==r&&(this.brush?.subs.delete(this),this.brush=r,this.brush?.subs.add(this)),this.start=s,this.end=i,super.set(n)}addPoint({x:t,y:r},s=this.length){const i=s*2,n=this.coords,l=t-this.x,a=r-this.y;return i<0||i>=n.length?n.push(l,a):n.splice(i,0,l,a),this._pointCountChanged(),!0}point(t){const r=t*2,s=this.coords;return r>=0&&r<s.length?{x:s[r]+this.x,y:s[r+1]+this.y}:null}setPoint(t,{x:r,y:s}){const i=t*2,n=this.coords;return i<0||i>=n.length?!1:(n[i+0]=r-this.x,n[i+1]=s-this.y,this._pointCountChanged(),!0)}removePoint(t){const r=t*2,s=this.coords;return s.length<=2||r<0||r>=s.length?!1:(s.splice(r,2),this._pointCountChanged(),!0)}setCoords(t){if(!t.length||t.length%2)throw Error("Количество координат должно быть четным.");return this.x=0,this.y=0,this.coords=t.slice(),this._pointCountChanged(),this}getIntersectionIndex(t,r){const{coords:s,brush:i,pen:n}=this;let l=0;return n&&(l=n.width/2||.5),l=Math.max(l,4),rs(s,!!i,l,t,r)}inside(t,r,s){const{coords:i,brush:n}=this;return n&&Bn(i,t,r)||rs(i,!!n,s,t,r)!==-1}_pointCountChanged(){const t=this.coords;let r=t[0],s=t[1],i=r,n=s;for(let l=2;l<t.length;l+=2){const a=t[l+0],u=t[l+1];a<r&&(r=a),a>i&&(i=a),u<s&&(s=u),u>n&&(n=u)}if(r!==0||s!==0)for(let l=0;l<t.length;l+=2)t[l+0]-=r,t[l+1]-=s;this._virtualUpdateBBox(this.x+r,this.y+s,i-r,n-s),this.parent?._childChanged(),this._coordsDirty=this.scene._dirty=!0}_virtualResized(t,r,s,i){const n=this.coords;for(let u=0;u<n.length;u+=2)n[u+0]*=s,n[u+1]*=i;const l=t+(this.x-t)*s,a=r+(this.y-r)*i;this._virtualUpdateBBox(l,a,this.width*s,this.height*i),this._coordsDirty=!0}_virtualRotated(t,r,s){const i=this.coords,n=t-this.x,l=r-this.y,a=Math.sin(s),u=Math.cos(s);let d=1/0,p=-1/0,_=1/0,T=-1/0;for(let m=0;m<i.length;m+=2){const R=i[m+0]-n,N=i[m+1]-l,O=R*u-N*a+n,k=R*a+N*u+l;i[m+0]=O,i[m+1]=k,O<d&&(d=O),O>p&&(p=O),k<_&&(_=k),k>T&&(T=k)}if(d!==0||_!==0)for(let m=0;m<i.length;m+=2)i[m+0]-=d,i[m+1]-=_;this._virtualUpdateBBox(this.x+d,this.y+_,p-d,T-_),this._coordsDirty=!0}toJSON(){const{coords:t,brush:r,end:s,pen:i,start:n,type:l}=this;return{...super.toJSON(),type:l,coords:t.slice(),brush:r?.key,end:s,pen:i?.key,start:n}}delete(t){const{pen:r,brush:s}=this;return r&&(r.subs.delete(this),t||r.delete()),s&&(s.subs.delete(this),t||s.delete(t)),super.delete()}toString(){return"Полилиния"}}let Zn=0;function Jn(){const e=`mark_${++Zn}`,t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id",e),t.setAttribute("orient","auto"),t.setAttribute("refX","0");const r=document.createElementNS("http://www.w3.org/2000/svg","polyline");return t.appendChild(r),{shape:r,marker:t,id:e}}function as(e,t,r,s){const i=r.width||1,n=r.stroke(),l=t.fill?n:null,a=t.fill?null:n;e.marker.setAttribute("markerWidth",(t.width+i).toString()),e.marker.setAttribute("markerHeight",(t.oy*2+i).toString()),s&&e.marker.setAttribute("refX",t.width.toString()),e.marker.setAttribute("refY",t.oy.toString()),e.marker.setAttribute("markerUnits","userSpaceOnUse"),e.shape.setAttribute("points",t.coords),e.shape.setAttribute("stroke-width",i.toString()),a?e.shape.setAttribute("stroke",a):e.shape.removeAttribute("stroke"),e.shape.setAttribute("fill",l||"none")}function hs(e,t){if(e.angle===0||e.length===0)return null;const r=Math.abs(e.length*Math.sin(e.angle)),s=Math.abs(e.length*Math.cos(e.angle)),i=t?[0,0,s,r,0,r*2]:[s,0,0,r,s,r*2];return{coords:us(i),fill:e.fill??!1,width:s,oy:r}}function us(e){let t="";for(let r=0;r<e.length;r+=2)t+=e[r]+","+e[r+1]+" ";return t}function ds(e){const t=document.createElementNS("http://www.w3.org/2000/svg",e);return t.setAttribute("fill-rule","evenodd"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t}class Qn extends Kn{constructor(t,r,s){super(t,r,s),this._visible=!0,this._width=0,this._stroke=null,this._dash=null,this._fill=null,this._blend=null,this._start=null,this._startMark=null,this._end=null,this._endMark=null,this._x=0,this._y=0,this._svg=ds(this._svgType=s.brush&&r.length>4?"polygon":"polyline")}createMarker(t){const r=Jn();return this.scene.defs.appendChild(r.marker),this._svg.setAttribute(t?"marker-end":"marker-start",`url(#${r.id})`),r}_render(){const t=this.attrib,r=t&Ve,s=t&rr,i=ze(t),n=this.pen,l=this.brush,a=!r&&!!(n||l)&&(!!s||!(1<<i&this.scene.hiddenLayers));if(this._visible!==a&&(this._visible=a,a?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!a)return;const u=this.brush&&this.length>2?"polygon":"polyline";if(this._svgType!==u){this._svgType=u,this._coordsDirty=!0,this._width=0,this._stroke=null,this._dash=null,this._fill=null,this._blend=null,this._start=null,this._startMark=null,this._end=null,this._endMark=null,this._x=0,this._y=0;const L=ds(u);this._svg.parentElement&&this._svg.replaceWith(L),this._svg=L}this._coordsDirty&&(this._coordsDirty=!1,this._svg.setAttribute("points",us(this.coords)));const d=n?.width||1,p=n?.stroke()||null,_=n?.dash()||null;if(this._width!==d){this._width=d;const L=d.toString();this._svg.setAttribute("stroke-width",L),this._startMark?.shape.setAttribute("stroke-width",L),this._endMark?.shape.setAttribute("stroke-width",L)}this._stroke!==p&&(this._stroke=p,p?(this._svg.setAttribute("stroke",p),this._startMark?.shape.setAttribute("stroke",p),this._endMark?.shape.setAttribute("stroke",p)):this._svg.removeAttribute("stroke")),this._dash!==_&&(this._dash=_,_?this._svg.setAttribute("stroke-dasharray",_):this._svg.removeAttribute("stroke-dasharray"));const T=this.length>2&&l?.fill()||"none";this._fill!==T&&(this._fill=T,this._svg.setAttribute("fill",T));const m=l?.blend()||n?.blend()||null;this._blend!==m&&(this._blend=m,m?this._svg.style.setProperty("mix-blend-mode",m):this._svg.style.removeProperty("mix-blend-mode"));const R=n&&(l?null:this.start),N=n&&(l?null:this.end);if(this._start!==R){this._start=R;const L=R&&hs(R,!0);L?as(this._startMark||=this.createMarker(!0),L,n,!0):(this._startMark?.marker.remove(),this._startMark=null)}if(this._end!==N){this._end=N;const L=N&&hs(N,!1);L?as(this._endMark||=this.createMarker(!1),L,n,!1):(this._endMark?.marker.remove(),this._endMark=null)}const O=this.x-this.scene.x,k=this.y-this.scene.y;(O!==this._x||k!==this._y)&&(this._x=O,this._y=k,this._svg.setAttribute("transform",`translate(${O}, ${k})`))}}class eo extends qe{constructor(t,r,s){const i={...s,width:s.width??r.width,height:s.height??r.height,text:r};super(t,i),this.text=r,this.type="textView",r.subs.add(this),this.angle=s.angle??0,this.set({...s,text:r})}set({text:t=this.text,...r}){return this.text!==t&&(this.text.subs.delete(this),this.text=t,this.text.subs.add(this)),super.set(r)}_virtualRotated(t,r,s){super._virtualRotated(t,r,s),this.angle+=s}toJSON(){const{text:t,angle:r,type:s}=this;return{...super.toJSON(),type:s,text:t.key,angle:r}}delete(t){const{text:r}=this;return r.subs.delete(this),t||r.delete(t),super.delete()}toString(){return"Текст"}}function fs(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return e&&(t.setAttribute("x","0px"),t.setAttribute("dy","1.15em")),t}class to{constructor(t,r){this.owner=t,this.part=r,this._strs=[],this._css=null,this._fgcolor=NaN,this.spans=r.string.split().map((s,i)=>fs(i>0))}update(){let t=!1;const{part:r,spans:s}=this,i=r.string.split(),n=r.font.css();if(this._strs!==i){this._strs=i,t=!0,s.length!==i.length&&(this._fgcolor=NaN);let l;for(let a=0;a<i.length;++a){if(a<s.length)l=s[a];else{const d=fs(!0);s.push(d),l.after(d),l=d,this._css=null}let u=i[a];n.isSymbolFont&&(u=Fn(u)),l.textContent=u||"​"}for(;s.length>i.length;)s.pop()?.remove()}if(this._css!==n&&(this._css=n,t=!0,s.forEach(l=>{l.setAttribute("font-family",n.fontFamily),l.setAttribute("font-size",n.fontSize.toString()),l.setAttribute("font-style",n.fontStyle),l.setAttribute("text-decoration",n.textDecoration),l.setAttribute("font-weight",n.fontWeight)})),this._fgcolor!==r.fgcolor){this._fgcolor=r.fgcolor;const l=tr(r.fgcolor)??"transparent";s.forEach(a=>a.setAttribute("fill",l))}return t}}class ro extends eo{constructor(t,r,s){if(super(t,r,s),this._svg=document.createElementNS("http://www.w3.org/2000/svg","text"),this._visible=!0,this._parts=[],this._partsSVG=[],this._sizes={w:0,h:0},this._angle=0,this._x=0,this._y=0,this._svg.setAttribute("dominant-baseline","text-before-edge"),this._svg.setAttribute("alignment-baseline","text-before-edge"),this._svg.setAttribute("letter-spacing","-0.07"),this._svg.style.setProperty("white-space","pre"),this._svg.style.setProperty("user-select","none"),r._textCalc=this._calcSizes.bind(this),!s.width||!s.height){const i=s.width??r.width,n=s.height??r.height;this._virtualUpdateBBox(this.x,this.y,i,n)}}_calcSizes(){const t=this.text?.parts;if(!t||!this.updateParts(t))return this._sizes;const r=this._svg.parentElement;r||this.scene.root.appendChild(this._svg);const{y:s=0,width:i,height:n}=this._svg.getBBox();return r||this._svg.remove(),this._sizes={w:i,h:s+n}}updateParts(t){if(this._parts!==t){this._parts=t;const r=[];this._partsSVG=t.map(s=>{const i=new to(this,s);return r.push(...i.spans),i}),this._svg.replaceChildren(...r)}return this._partsSVG.reduce((r,s)=>s.update()||r,!1)}_render(){const t=this.attrib,r=t&Ve,s=t&rr,i=ze(t),n=this.text?.parts,l=(!!s||!(r||1<<i&this.scene.hiddenLayers))&&!!n;if(this._visible!==l&&(this._visible=l,l?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!l)return;this.updateParts(n);const a=this.x-this.scene.x,u=this.y-this.scene.y,d=this.angle;(a!==this._x||u!==this._y||this._angle!==d)&&(this._x=a,this._y=u,this._angle=d,this._svg.setAttribute("transform",`translate(${a}, ${u}), rotate(${d*180/Math.PI})`))}}class so extends qe{constructor(t,r){super(t,r),this.type="videoView",this.fixed=!1,this.fixed=r.fixed??this.fixed}set(t){return this.fixed=t.fixed??this.fixed,super.set(t)}toJSON(){throw new Error("Method not implemented.")}toString(){return"Видео"}}const cr=Rt;cr.hideVideoControls=!1;class io{constructor(t){this.e=t}get width(){return this.e.videoWidth}get height(){return this.e.videoHeight}}class no extends so{constructor(t,r,s){super(t,s),this._svg=!1,this._html=document.createElement("video"),this.st=this._html.style,this._visible=!0,this._x=0,this._y=0,this._w=0,this._h=0;const i=this._html;i.src=r,this.video=new io(i),this.st.setProperty("position","absolute"),this.st.setProperty("background","black"),cr.hideVideoControls?this.st.setProperty("pointer-events","none"):(i.setAttribute("controls","true"),this.st.setProperty("pointer-events","auto"))}getState(){const t=this._html;return t.paused?t.currentTime?"pause":"stop":"play"}setPosition(t){const r=this._html;return t!==r.currentTime&&(r.currentTime=t),this}getPosition(){return this._html.currentTime}play(){const t=this._html;return t.paused&&t.play(),this}stop(){const t=this._html;return t.paused||t.pause(),this}pause(){const t=this._html;return t.paused||t.pause(),t.currentTime&&(t.currentTime=0),this}_render(){const t=this.attrib,r=t&Ve,s=ze(t),i=!(r||1<<s&this.scene.hiddenLayers);if(this._visible!==i&&(this._visible=i,i?this.st.removeProperty("display"):this.st.setProperty("display","none")),!i)return;const n=this.x-this.scene.x,l=this.y-this.scene.y;if(this._x!==n&&this.st.setProperty("left",(this._x=n).toString()+"px"),this._y!==l&&this.st.setProperty("top",(this._y=l).toString()+"px"),this.fixed){const a=this.width,u=this.height;this._w!==a&&this.st.setProperty("width",(this._w=a).toString()+"px"),this._h!==u&&this.st.setProperty("height",(this._h=u).toString()+"px")}}}class oo extends $e{constructor(t,r){super(t,t.brushes,r),this.type="brush",this.color=0,this.style=0,this.rop=0,this.hatch=0,this.image=null,this.set(r)}set({color:t=this.color,hatch:r=this.hatch,image:s=this.image,rop:i=this.rop,style:n=this.style}){return this.image!==s&&(this.image?.subs.delete(this),this.image=s,this.image?.subs.add(this)),this.color=t,this.style=n,this.rop=i,this.hatch=r,this}toJSON(){const{color:t,hatch:r,image:s,rop:i,style:n}=this;return{...super.toJSON(),color:t,hatch:r,image:s?.key,rop:i,style:n}}delete(t){if(!super.delete())return!1;const{image:r}=this;return r&&(r.subs.delete(this),t||r.delete()),!0}}const co=9,lo=10,ao=0,ho=1,uo=3;class fo extends oo{constructor(){super(...arguments),this._color=NaN,this._cssColor=null}cssColor(){return this._color!==this.color?this._cssColor=tr(this._color=this.color):this._cssColor}blend(){switch(this.rop){case co:return"multiply";case lo:return"multiply";default:return null}}fill(){switch(this.style){case ao:return this.cssColor();case ho:return null;case uo:return this.image?.pattern()??"black";default:return"white"}}}const lr=["Arial","Verdana","Tahoma","Times New Roman","Georgia","Courier New","cursive"],go=lr.map(e=>e.toUpperCase());function po(e){if(!e)return lr[0];if(e==="Symbol")return"Times New Roman";const t=e.toUpperCase(),r=t.endsWith(" CYR")?t.slice(0,t.length-4):t;return lr[Math.max(go.indexOf(r),0)]}class _o extends $e{constructor(t,r){super(t,t.fonts,r),this.name="",this.size=0,this.style=0,this._renderedFont=null,this.set(r)}get actualName(){return this._renderedFont||=po(this.name)}set({name:t=this.name,size:r=this.size,style:s=this.style}){return this.name!==t&&(this.name=t,this._renderedFont=null),this.size=r,this.style=s,this}toJSON(){const{name:t,size:r,style:s}=this;return{...super.toJSON(),name:t,size:r,style:s}}}class Eo extends _o{constructor(){super(...arguments),this._size=NaN,this._style=NaN,this._family="",this._decoration="",this._fstyle="",this._weight="",this._css=this.css()}css(){const{actualName:t,size:r,style:s}=this;let i=!1;if(this._style!==s){this._style=s,i=!0;const n=s&xn,l=s&Pn,a=s&Dn,u=s&kn;this._decoration=`${l?"underline":""} ${a?"line-through":""}`,this._fstyle=n?"italic":"normal",this._weight=u?"bold":"normal"}return this._family!==t&&(this._family=t,i=!0),this._size!==r&&(this._size=r,i=!0),i?this._css={isSymbolFont:this.name==="Symbol",fontFamily:this._family,textDecoration:this._decoration,fontSize:r||15.940224159402327,fontStyle:this._fstyle,fontWeight:this._weight}:this._css}}class wo extends $e{constructor(t,{width:r,height:s,src:i},n){super(t,n.opaque?t.imagesOpaque:t.images,n),this.width=r,this.height=s,this.src=i,this.realSrc=We(i)}toJSON(){const{height:t,src:r,width:s}=this;return{...super.toJSON(),height:t,src:r,width:s}}}let mo=0;class To extends wo{constructor(){super(...arguments),this._pattern=null}pixel(){return 0}setPixel(){return!0}pattern(){if(this._pattern)return this._pattern.url;const t=document.createElementNS("http://www.w3.org/2000/svg","pattern"),r=`patt_${++mo}`;t.setAttribute("id",r),t.setAttribute("patternUnits","userSpaceOnUse"),t.setAttribute("width",this.width.toString()),t.setAttribute("height",this.height.toString());const s=document.createElementNS("http://www.w3.org/2000/svg","image");s.setAttribute("href",this.realSrc),t.appendChild(s),this.scene.defs.appendChild(t);const i=`url(#${r})`;return this._pattern={e:t,url:i},i}}class yo extends $e{constructor(t,r){super(t,t.pens,r),this.color=0,this.style=0,this.rop=0,this.width=0,this.set(r)}set({color:t,rop:r,style:s,width:i}){return this.color=t??this.color,this.style=s??this.style,this.rop=r??this.rop,this.width=i??this.width,this}toJSON(){const{color:t,rop:r,style:s,width:i}=this;return{...super.toJSON(),color:t,rop:r,style:s,width:i}}}const bo=0,Ro=1,Oo=2,Mo=3,vo=4,So=5,Ao=9,No=10;class Io extends yo{constructor(){super(...arguments),this._color=NaN,this._cssColor=null}cssColor(){return this._color!==this.color?this._cssColor=tr(this._color=this.color):this._cssColor}blend(){switch(this.rop){case Ao:return"multiply";case No:return"multiply";default:return null}}stroke(){return this.style===So?null:this.cssColor()}dash(){switch(this.style){case bo:return null;case Ro:return"16 4";case Oo:return"2 4";case Mo:return"16 4 2 4";case vo:return"16 4 2 4 2 4";default:return null}}}class xo extends $e{constructor(t,r,s){super(t,t.strings,s),this.text=r,this.set({...s,text:r})}set({text:t}){return this.text=t??this.text,this}toJSON(){const{text:t}=this;return{...super.toJSON(),text:t}}}class Po extends xo{constructor(){super(...arguments),this._text="",this._parts=[""]}split(){return this._text!==this.text?this._parts=(this._text=this.text).split(`\r
`).join(`
`).split(`
`):this._parts}}class Do{constructor(t,{font:r,string:s,fgcolor:i,bgcolor:n}){this.text=t,this.font=r,this.string=s,this.fgcolor=i||0,this.bgcolor=n??at,r.subs.add(this),s.subs.add(this)}set({font:t=this.font,string:r=this.string,fgcolor:s=this.fgcolor,bgcolor:i=this.bgcolor}){return this.font!==t&&(this.font.subs.delete(this),this.font=t,t.subs.add(this)),this.string!==r&&(this.string.subs.delete(this),this.string=r,r.subs.add(this)),this.fgcolor=s,this.bgcolor=i,this}delete(t){this.font.subs.delete(this),this.string.subs.delete(this),t||(this.font.delete(),this.string.delete())}toJSON(){const{font:t,string:r,fgcolor:s,bgcolor:i}=this;return{font:t.key,string:r.key,fgcolor:s,bgcolor:i}}}class ko extends $e{constructor(t,r,s){super(t,t.texts,s),this.type="text",this.parts=[],this.parts=r.map(i=>this.part(i,!0))}set({parts:t=this.parts},r){return this.parts!==t&&(this.parts.forEach(s=>!t.includes(s)&&s.delete(r)),this.parts=t),this}part(t,r){const s=new Do(this,t);return r||(this.parts=this.parts.concat(s)),s}toJSON(){const t=this.parts.map(r=>r.toJSON());return{...super.toJSON(),parts:t}}delete(t){return super.delete()?(this.parts.forEach(r=>r.delete(t)),!0):!1}}class Lo extends ko{constructor(){super(...arguments),this._textCalc=null}get width(){return this._textCalc?.().w??0}get height(){return this._textCalc?.().h??0}}function gs(e,t,r){const s=new Set(r);let i=0,n=null;t.forEach(l=>{if(s.delete(l),i<r.length&&l===r[i])++i;else{const a=n?n.nextElementSibling:e.firstElementChild;e.insertBefore(l._svg||l._html,a)}n=l._svg||l._html}),s.forEach(l=>(l._svg||l._html).remove())}const ar=new WeakMap;let Go=0;class hr extends jn{constructor(t,r=window){super(),this.prevOrder=[],this.svgOrder=[],this.htmlOrder=[],this.bgRect=null,this._bg=null,this._cursor=null;const s=this.root=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("class",St["jf-scene-svg"]);const i=this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),n=this.htmlRoot=document.createElement("div");n.className=St["jf-scene-html"];const l=this.view=document.createElement("div");l.className=St["jf-scene"],l.addEventListener("selectstart",zr.bind(null,l)),l.addEventListener("contextmenu",zr.bind(null,l)),s.append(i),l.append(s,n),t&&this.fromJSON(t);let a=ar.get(r);a||(a=[new Fe(r),new Set],ar.set(r,a)),a[1].add(this),a[0].run(hr.redrawAll.bind(null,a[1])),this.realWindow=window}static redrawAll(t){return t.forEach(r=>r._render()),t.size>0}dispose(){ar.get(this.realWindow)?.[1].delete(this)}resizeView(t,r){this.view.style.width=t+"px",this.view.style.height=r+"px"}_render(t=!1){if(!t&&!this.view.parentElement)return;const{background:r,prevOrder:s,svgOrder:i,root:n,htmlOrder:l,htmlRoot:a,cursor:u}=this;a.scrollTop!==0&&(a.scrollTop=0),a.scrollLeft!==0&&(a.scrollLeft=0),this._cursor!==u&&(this._cursor=u,this.view.style.cursor=u||"auto");const d=r?.fill()??null;let p=!1;if(p=this._bg!==d)if(this._bg=d,d){if(!this.bgRect){const T=document.createElementNS("http://www.w3.org/2000/svg","rect");T.setAttribute("width","100%"),T.setAttribute("height","100%"),this.bgRect={_svg:T,_render:()=>{}}}this.bgRect._svg.setAttribute("fill",d)}else this.bgRect?._svg.remove(),this.bgRect=null;const _=this.order;if(s!==_||p){const T=this.bgRect?[this.bgRect]:[],m=[];_.forEach(R=>{R._svg?T.push(R):m.push(R)}),i.length>0?gs(n,T,i):n.append(...T.map(R=>R._svg)),l.length>0?gs(a,m,l):m.length>0&&a.append(...m.map(R=>R._html)),this.svgOrder=T,this.htmlOrder=m,this.prevOrder=_}_.forEach(T=>T._render())}toSVG(t,r){const{x:s,y:i,hiddenLayers:n}=this;this.set({x:t.x,y:t.y,hiddenLayers:0}),this._render(!0);let l;return r?(l=this.root,this.dispose()):(l=this.root.cloneNode(!0),this.set({x:s,y:i,hiddenLayers:n}),t&&this._render(!0)),l.removeAttribute("style"),l.removeAttribute("class"),l.setAttribute("viewBox",`0 0 ${t.w} ${t.h}`),l}toBlob(t){const r=this.toSVG(t);r.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttribute("width",t.w+"px"),r.setAttribute("height",t.h+"px"),r.setAttribute("preserveAspectRatio","xMidYMid slice");const i=`<?xml version="1.0"?>\r
`+new XMLSerializer().serializeToString(r);return Promise.resolve(new Blob([i],{type:"image/svg+xml"}))}_line(t,r={}){return new Qn(this,t,r)}_imageView(t,r={}){return new Xn(this,t,r)}_textView(t,r={}){return new ro(this,t,r)}_input(t,r={}){return new qn(this,t,r)}_video(t,r={}){return new no(this,t,r)}_pen(t={}){return new Io(this,t)}_brush(t={}){return new fo(this,t)}_image(t,r={}){return new To(this,t,r)}_string(t,r={}){return new Po(this,t,r)}_font(t={}){return new Eo(this,t)}_text(t,r={}){return new Lo(this,t,r)}_createClipRect(){const t=`clipPath_${++Go}`,r=document.createElementNS("http://www.w3.org/2000/svg","clipPath");r.setAttribute("id",t);const s=document.createElementNS("http://www.w3.org/2000/svg","rect");return r.appendChild(s),this.defs.appendChild(r),{id:t,rect:s}}}const Bo=hr;var x=(e=>(e[e.PI=3.1415926536]="PI",e[e.WORD8=0]="WORD8",e[e.INT8=1]="INT8",e[e.WORD16=2]="WORD16",e[e.INT16=3]="INT16",e[e.WORD32=4]="WORD32",e[e.INT32=5]="INT32",e[e.FLOAT32=6]="FLOAT32",e[e.FLOAT40=7]="FLOAT40",e[e.FLOAT64=8]="FLOAT64",e[e.FLOAT80=9]="FLOAT80",e[e.PEN2D=1]="PEN2D",e[e.BRUSH2D=2]="BRUSH2D",e[e.DIB2D=3]="DIB2D",e[e.DOUBLEDIB2D=4]="DOUBLEDIB2D",e[e.FONT2D=5]="FONT2D",e[e.STRING2D=6]="STRING2D",e[e.TEXT2D=7]="TEXT2D",e[e.SPACE3D=8]="SPACE3D",e[e.TEXTURE3D=9]="TEXTURE3D",e[e.WM_DESTROY=2]="WM_DESTROY",e[e.WM_MOVE=3]="WM_MOVE",e[e.WM_SIZE=5]="WM_SIZE",e[e.WM_CLOSE=16]="WM_CLOSE",e[e.WM_GETMINMAXINFO=36]="WM_GETMINMAXINFO",e[e.WM_COMMAND=273]="WM_COMMAND",e[e.WM_MOUSEMOVE=512]="WM_MOUSEMOVE",e[e.WM_LBUTTONDOWN=513]="WM_LBUTTONDOWN",e[e.WM_LBUTTONUP=514]="WM_LBUTTONUP",e[e.WM_LBUTTONDBLCLK=515]="WM_LBUTTONDBLCLK",e[e.WM_RBUTTONDOWN=516]="WM_RBUTTONDOWN",e[e.WM_RBUTTONUP=517]="WM_RBUTTONUP",e[e.WM_RBUTTONDBLCLK=518]="WM_RBUTTONDBLCLK",e[e.WM_MBUTTONDOWN=519]="WM_MBUTTONDOWN",e[e.WM_MBUTTONUP=520]="WM_MBUTTONUP",e[e.WM_MBUTTONDBLCLK=521]="WM_MBUTTONDBLCLK",e[e.WM_ALLMOUSEMESSAGE=1536]="WM_ALLMOUSEMESSAGE",e[e.WM_ALLKEYMESSAGE=1537]="WM_ALLKEYMESSAGE",e[e.WM_KEYDOWN=256]="WM_KEYDOWN",e[e.WM_KEYUP=257]="WM_KEYUP",e[e.WM_CANCLOSE=1538]="WM_CANCLOSE",e[e.WM_SPACEDONE=1539]="WM_SPACEDONE",e[e.WM_SPACEINIT=1540]="WM_SPACEINIT",e[e.WM_CONTROLNOTIFY=1544]="WM_CONTROLNOTIFY",e[e.WM_HYPERJUMP=1546]="WM_HYPERJUMP",e[e.SIZE_RESTORED=0]="SIZE_RESTORED",e[e.SIZE_MINIMIZED=1]="SIZE_MINIMIZED",e[e.SIZE_MAXIMIZED=2]="SIZE_MAXIMIZED",e[e.SIZE_MAXSHOW=3]="SIZE_MAXSHOW",e[e.SIZE_MAXHIDE=4]="SIZE_MAXHIDE",e[e.OTGROUP2D=3]="OTGROUP2D",e[e.OTRGROUP2D=4]="OTRGROUP2D",e[e.OTGROUP3D=5]="OTGROUP3D",e[e.OTOBJECT3D=10]="OTOBJECT3D",e[e.OTLINE_2D=20]="OTLINE_2D",e[e.OTBITMAP_2D=21]="OTBITMAP_2D",e[e.OTDOUBLEBITMAP_2D=22]="OTDOUBLEBITMAP_2D",e[e.OTTEXT_2D=23]="OTTEXT_2D",e[e.OTVIEW3D_2D=24]="OTVIEW3D_2D",e[e.OTEDITFRAME=50]="OTEDITFRAME",e[e.OTROTATECENTER=51]="OTROTATECENTER",e[e.OTFRAME3D=52]="OTFRAME3D",e[e.OTAXIS3D=53]="OTAXIS3D",e[e.OTPEN2D=101]="OTPEN2D",e[e.OTBRUSH2D=102]="OTBRUSH2D",e[e.OTDIB2D=103]="OTDIB2D",e[e.OTDOUBLEDIB2D=104]="OTDOUBLEDIB2D",e[e.OTFONT2D=105]="OTFONT2D",e[e.OTSTRING2D=106]="OTSTRING2D",e[e.OTTEXT2D=107]="OTTEXT2D",e[e.OTREFTODIB2D=110]="OTREFTODIB2D",e[e.OTREFTODOUBLEDIB2D=111]="OTREFTODOUBLEDIB2D",e[e.ATTRSET=1]="ATTRSET",e[e.ATTRRESET=2]="ATTRRESET",e[e.ATTRPUT=3]="ATTRPUT",e[e.PFC_MOVEOBJECT=32768]="PFC_MOVEOBJECT",e[e.PFC_SETCURRENT=16384]="PFC_SETCURRENT",e[e.PFC_SETFRAME=8192]="PFC_SETFRAME",e[e.PFC_PENS=1]="PFC_PENS",e[e.PFC_BRUHS=2]="PFC_BRUHS",e[e.PFC_DIBS=4]="PFC_DIBS",e[e.PFC_DDIBS=8]="PFC_DDIBS",e[e.PFC_STRINGS=16]="PFC_STRINGS",e[e.PFC_FONTS=32]="PFC_FONTS",e[e.PFC_TEXTS=64]="PFC_TEXTS",e[e.PFC_3D=128]="PFC_3D",e[e.PFC_ALL=255]="PFC_ALL",e[e.OID_RESERVED=32e3]="OID_RESERVED",e[e.OID_RCENTER=32001]="OID_RCENTER",e[e.OID_FRAME2D1=32002]="OID_FRAME2D1",e[e.OID_FRAME2D2=32003]="OID_FRAME2D2",e[e.OID_FRAME2D3=32004]="OID_FRAME2D3",e[e.OID_FRAME2D4=32005]="OID_FRAME2D4",e[e.OID_FRAME2D5=32006]="OID_FRAME2D5",e[e.OID_FRAME2D6=32007]="OID_FRAME2D6",e[e.OID_FRAME2D7=32008]="OID_FRAME2D7",e[e.OID_FRAME2D8=32009]="OID_FRAME2D8",e[e.OID_FRAME2D=32010]="OID_FRAME2D",e[e.OID_AXIS3D=32100]="OID_AXIS3D",e[e.OID_FRAME3D1=32102]="OID_FRAME3D1",e[e.OID_FRAME3D2=32103]="OID_FRAME3D2",e[e.OID_FRAME3D3=32104]="OID_FRAME3D3",e[e.OID_FRAME3D4=32105]="OID_FRAME3D4",e[e.OID_FRAME3D5=32106]="OID_FRAME3D5",e[e.OID_FRAME3D6=32107]="OID_FRAME3D6",e[e.OID_FRAME3D7=32108]="OID_FRAME3D7",e[e.OID_FRAME3D8=32109]="OID_FRAME3D8",e[e.OID_FRAME3D=32110]="OID_FRAME3D",e[e.MB_OK=0]="MB_OK",e[e.MB_OKCANCEL=1]="MB_OKCANCEL",e[e.MB_ABORTRETRYIGNORE=2]="MB_ABORTRETRYIGNORE",e[e.MB_YESNOCANCEL=3]="MB_YESNOCANCEL",e[e.MB_YESNO=4]="MB_YESNO",e[e.MB_RETRYCANCEL=5]="MB_RETRYCANCEL",e[e.MB_TYPEMASK=15]="MB_TYPEMASK",e[e.MB_ICONHAND=16]="MB_ICONHAND",e[e.MB_ICONQUESTION=32]="MB_ICONQUESTION",e[e.MB_ICONEXCLAMATION=48]="MB_ICONEXCLAMATION",e[e.MB_ICONASTERISK=64]="MB_ICONASTERISK",e[e.MB_ICONMASK=240]="MB_ICONMASK",e[e.MB_ICONINFORMATION=64]="MB_ICONINFORMATION",e[e.MB_ICONSTOP=16]="MB_ICONSTOP",e[e.MB_DEFBUTTON1=0]="MB_DEFBUTTON1",e[e.MB_DEFBUTTON2=256]="MB_DEFBUTTON2",e[e.MB_DEFBUTTON3=512]="MB_DEFBUTTON3",e[e.MB_DEFMASK=3840]="MB_DEFMASK",e[e.MB_APPLMODAL=0]="MB_APPLMODAL",e[e.MB_SYSTEMMODAL=4096]="MB_SYSTEMMODAL",e[e.MB_TASKMODAL=8192]="MB_TASKMODAL",e[e.MB_NOFOCUS=32768]="MB_NOFOCUS",e[e.SW_HIDE=0]="SW_HIDE",e[e.SW_SHOWNORMAL=1]="SW_SHOWNORMAL",e[e.SW_NORMAL=1]="SW_NORMAL",e[e.SW_SHOWMINIMIZED=2]="SW_SHOWMINIMIZED",e[e.SW_SHOWMAXIMIZED=3]="SW_SHOWMAXIMIZED",e[e.SW_MAXIMIZE=3]="SW_MAXIMIZE",e[e.SW_SHOWNOACTIVATE=4]="SW_SHOWNOACTIVATE",e[e.SW_SHOW=5]="SW_SHOW",e[e.SW_MINIMIZE=6]="SW_MINIMIZE",e[e.SW_SHOWMINNOACTIVE=7]="SW_SHOWMINNOACTIVE",e[e.SW_SHOWNA=8]="SW_SHOWNA",e[e.SW_RESTORE=9]="SW_RESTORE",e[e.MCIERR_INVALID_DEVICE_ID=257]="MCIERR_INVALID_DEVICE_ID",e[e.MCIERR_UNRECOGNIZED_KEYWORD=259]="MCIERR_UNRECOGNIZED_KEYWORD",e[e.MCIERR_UNRECOGNIZED_COMMAND=261]="MCIERR_UNRECOGNIZED_COMMAND",e[e.MCIERR_HARDWARE=262]="MCIERR_HARDWARE",e[e.MCIERR_INVALID_DEVICE_NAME=263]="MCIERR_INVALID_DEVICE_NAME",e[e.MCIERR_OUT_OF_MEMORY=264]="MCIERR_OUT_OF_MEMORY",e[e.MCIERR_DEVICE_OPEN=265]="MCIERR_DEVICE_OPEN",e[e.MCIERR_CANNOT_LOAD_DRIVER=266]="MCIERR_CANNOT_LOAD_DRIVER",e[e.MCIERR_MISSING_COMMAND_STRING=267]="MCIERR_MISSING_COMMAND_STRING",e[e.MCIERR_PARAM_OVERFLOW=268]="MCIERR_PARAM_OVERFLOW",e[e.MCIERR_MISSING_STRING_ARGUMENT=269]="MCIERR_MISSING_STRING_ARGUMENT",e[e.MCIERR_BAD_INTEGER=270]="MCIERR_BAD_INTEGER",e[e.MCIERR_PARSER_INTERNAL=271]="MCIERR_PARSER_INTERNAL",e[e.MCIERR_DRIVER_INTERNAL=272]="MCIERR_DRIVER_INTERNAL",e[e.MCIERR_MISSING_PARAMETER=273]="MCIERR_MISSING_PARAMETER",e[e.MCIERR_UNSUPPORTED_FUNCTION=274]="MCIERR_UNSUPPORTED_FUNCTION",e[e.MCIERR_FILE_NOT_FOUND=275]="MCIERR_FILE_NOT_FOUND",e[e.MCIERR_DEVICE_NOT_READY=276]="MCIERR_DEVICE_NOT_READY",e[e.MCIERR_INTERNAL=277]="MCIERR_INTERNAL",e[e.MCIERR_DRIVER=278]="MCIERR_DRIVER",e[e.MCIERR_CANNOT_USE_ALL=279]="MCIERR_CANNOT_USE_ALL",e[e.MCIERR_MULTIPLE=280]="MCIERR_MULTIPLE",e[e.MCIERR_EXTENSION_NOT_FOUND=281]="MCIERR_EXTENSION_NOT_FOUND",e[e.MCIERR_OUTOFRANGE=282]="MCIERR_OUTOFRANGE",e[e.MCIERR_FLAGS_NOT_COMPATIBLE=284]="MCIERR_FLAGS_NOT_COMPATIBLE",e[e.MCIERR_FILE_NOT_SAVED=286]="MCIERR_FILE_NOT_SAVED",e[e.MCIERR_DEVICE_TYPE_REQUIRED=287]="MCIERR_DEVICE_TYPE_REQUIRED",e[e.MCIERR_DEVICE_LOCKED=288]="MCIERR_DEVICE_LOCKED",e[e.MCIERR_DUPLICATE_ALIAS=289]="MCIERR_DUPLICATE_ALIAS",e[e.MCIERR_BAD_CONSTANT=290]="MCIERR_BAD_CONSTANT",e[e.MCIERR_MUST_USE_SHAREABLE=291]="MCIERR_MUST_USE_SHAREABLE",e[e.MCIERR_MISSING_DEVICE_NAME=292]="MCIERR_MISSING_DEVICE_NAME",e[e.MCIERR_BAD_TIME_FORMAT=293]="MCIERR_BAD_TIME_FORMAT",e[e.MCIERR_NO_CLOSING_QUOTE=294]="MCIERR_NO_CLOSING_QUOTE",e[e.MCIERR_DUPLICATE_FLAGS=295]="MCIERR_DUPLICATE_FLAGS",e[e.MCIERR_INVALID_FILE=296]="MCIERR_INVALID_FILE",e[e.MCIERR_NULL_PARAMETER_BLOCK=297]="MCIERR_NULL_PARAMETER_BLOCK",e[e.MCIERR_UNNAMED_RESOURCE=298]="MCIERR_UNNAMED_RESOURCE",e[e.MCIERR_NEW_REQUIRES_ALIAS=299]="MCIERR_NEW_REQUIRES_ALIAS",e[e.MCIERR_NOTIFY_ON_AUTO_OPEN=300]="MCIERR_NOTIFY_ON_AUTO_OPEN",e[e.MCIERR_NO_ELEMENT_ALLOWED=301]="MCIERR_NO_ELEMENT_ALLOWED",e[e.MCIERR_NONAPPLICABLE_FUNCTION=302]="MCIERR_NONAPPLICABLE_FUNCTION",e[e.MCIERR_ILLEGAL_FOR_AUTO_OPEN=303]="MCIERR_ILLEGAL_FOR_AUTO_OPEN",e[e.MCIERR_FILENAME_REQUIRED=304]="MCIERR_FILENAME_REQUIRED",e[e.MCIERR_EXTRA_CHARACTERS=305]="MCIERR_EXTRA_CHARACTERS",e[e.MCIERR_DEVICE_NOT_INSTALLED=306]="MCIERR_DEVICE_NOT_INSTALLED",e[e.MCIERR_GET_CD=307]="MCIERR_GET_CD",e[e.MCIERR_SET_CD=308]="MCIERR_SET_CD",e[e.MCIERR_SET_DRIVE=309]="MCIERR_SET_DRIVE",e[e.MCIERR_DEVICE_LENGTH=310]="MCIERR_DEVICE_LENGTH",e[e.MCIERR_DEVICE_ORD_LENGTH=311]="MCIERR_DEVICE_ORD_LENGTH",e[e.MCIERR_NO_INTEGER=312]="MCIERR_NO_INTEGER",e[e.MCIERR_WAVE_OUTPUTSINUSE=320]="MCIERR_WAVE_OUTPUTSINUSE",e[e.MCIERR_WAVE_SETOUTPUTINUSE=321]="MCIERR_WAVE_SETOUTPUTINUSE",e[e.MCIERR_WAVE_INPUTSINUSE=322]="MCIERR_WAVE_INPUTSINUSE",e[e.MCIERR_WAVE_SETINPUTINUSE=323]="MCIERR_WAVE_SETINPUTINUSE",e[e.MCIERR_WAVE_OUTPUTUNSPECIFIED=324]="MCIERR_WAVE_OUTPUTUNSPECIFIED",e[e.MCIERR_WAVE_INPUTUNSPECIFIED=325]="MCIERR_WAVE_INPUTUNSPECIFIED",e[e.MCIERR_WAVE_OUTPUTSUNSUITABLE=326]="MCIERR_WAVE_OUTPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETOUTPUTUNSUITABLE=327]="MCIERR_WAVE_SETOUTPUTUNSUITABLE",e[e.MCIERR_WAVE_INPUTSUNSUITABLE=328]="MCIERR_WAVE_INPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETINPUTUNSUITABLE=329]="MCIERR_WAVE_SETINPUTUNSUITABLE",e[e.MCIERR_SEQ_DIV_INCOMPATIBLE=336]="MCIERR_SEQ_DIV_INCOMPATIBLE",e[e.MCIERR_SEQ_PORT_INUSE=337]="MCIERR_SEQ_PORT_INUSE",e[e.MCIERR_SEQ_PORT_NONEXISTENT=338]="MCIERR_SEQ_PORT_NONEXISTENT",e[e.MCIERR_SEQ_PORT_MAPNODEVICE=339]="MCIERR_SEQ_PORT_MAPNODEVICE",e[e.MCIERR_SEQ_PORT_MISCERROR=340]="MCIERR_SEQ_PORT_MISCERROR",e[e.MCIERR_SEQ_TIMER=341]="MCIERR_SEQ_TIMER",e[e.MCIERR_SEQ_PORTUNSPECIFIED=342]="MCIERR_SEQ_PORTUNSPECIFIED",e[e.MCIERR_SEQ_NOMIDIPRESENT=343]="MCIERR_SEQ_NOMIDIPRESENT",e[e.MCIERR_NO_WINDOW=346]="MCIERR_NO_WINDOW",e[e.MCIERR_CREATEWINDOW=347]="MCIERR_CREATEWINDOW",e[e.MCIERR_FILE_READ=348]="MCIERR_FILE_READ",e[e.MCIERR_FILE_WRITE=349]="MCIERR_FILE_WRITE",e[e.WS_VISIBLE=268435456]="WS_VISIBLE",e[e.WS_DISABLED=134217728]="WS_DISABLED",e[e.WS_CAPTION=12582912]="WS_CAPTION",e[e.WS_BORDER=8388608]="WS_BORDER",e[e.WS_DLGFRAME=4194304]="WS_DLGFRAME",e[e.WS_VSCROLL=2097152]="WS_VSCROLL",e[e.WS_HSCROLL=1048576]="WS_HSCROLL",e[e.WS_SYSMENU=524288]="WS_SYSMENU",e[e.WS_THICKFRAME=262144]="WS_THICKFRAME",e[e.WS_MINIMIZEBOX=131072]="WS_MINIMIZEBOX",e[e.WS_MAXIMIZEBOX=65536]="WS_MAXIMIZEBOX",e[e.WS_GROUP=131072]="WS_GROUP",e[e.WS_TABSTOP=65536]="WS_TABSTOP",e[e.WS_OVERLAPPED=0]="WS_OVERLAPPED",e[e.WS_POPUP=2147483648]="WS_POPUP",e[e.WS_CHILD=1073741824]="WS_CHILD",e[e.IDX_PRIMARY=1]="IDX_PRIMARY",e[e.IDX_UNIQUE=2]="IDX_UNIQUE",e[e.IDX_DESCENDING=4]="IDX_DESCENDING",e[e.IDX_MAINTAINED=8]="IDX_MAINTAINED",e[e.IDX_SUBSET=16]="IDX_SUBSET",e[e.IDX_EXPR=32]="IDX_EXPR",e[e.IDX_IDXOOD=64]="IDX_IDXOOD",e[e.IDX_CASEINSENS=128]="IDX_CASEINSENS",e[e.FLDDBCHAR=513]="FLDDBCHAR",e[e.FLDDBNUM=514]="FLDDBNUM",e[e.FLDDBMEMO=515]="FLDDBMEMO",e[e.FLDDBBOOL=516]="FLDDBBOOL",e[e.FLDDBDATE=517]="FLDDBDATE",e[e.FLDDBFLOAT=518]="FLDDBFLOAT",e[e.FLDDBLOCK=519]="FLDDBLOCK",e[e.FLDDBOLEBLOB=520]="FLDDBOLEBLOB",e[e.FLDDBBINARY=521]="FLDDBBINARY",e[e.FLDDBBYTES=522]="FLDDBBYTES",e[e.BS_PUSHBUTTON=0]="BS_PUSHBUTTON",e[e.BS_DEFPUSHBUTTON=1]="BS_DEFPUSHBUTTON",e[e.BS_CHECKBOX=2]="BS_CHECKBOX",e[e.BS_AUTOCHECKBOX=3]="BS_AUTOCHECKBOX",e[e.BS_RADIOBUTTON=4]="BS_RADIOBUTTON",e[e.BS_3STATE=5]="BS_3STATE",e[e.BS_AUTO3STATE=6]="BS_AUTO3STATE",e[e.BS_GROUPBOX=7]="BS_GROUPBOX",e[e.BS_USERBUTTON=8]="BS_USERBUTTON",e[e.BS_AUTORADIOBUTTON=9]="BS_AUTORADIOBUTTON",e[e.BS_OWNERDRAW=11]="BS_OWNERDRAW",e[e.BS_LEFTTEXT=32]="BS_LEFTTEXT",e[e.ES_LEFT=0]="ES_LEFT",e[e.ES_CENTER=1]="ES_CENTER",e[e.ES_RIGHT=2]="ES_RIGHT",e[e.ES_MULTILINE=4]="ES_MULTILINE",e[e.ES_UPPERCASE=8]="ES_UPPERCASE",e[e.ES_LOWERCASE=16]="ES_LOWERCASE",e[e.ES_PASSWORD=32]="ES_PASSWORD",e[e.ES_AUTOVSCROLL=64]="ES_AUTOVSCROLL",e[e.ES_AUTOHSCROLL=128]="ES_AUTOHSCROLL",e[e.ES_NOHIDESEL=256]="ES_NOHIDESEL",e[e.SBS_HORZ=0]="SBS_HORZ",e[e.SBS_VERT=1]="SBS_VERT",e[e.SBS_TOPALIGN=2]="SBS_TOPALIGN",e[e.SBS_LEFTALIGN=2]="SBS_LEFTALIGN",e[e.SBS_BOTTOMALIGN=4]="SBS_BOTTOMALIGN",e[e.SBS_RIGHTALIGN=4]="SBS_RIGHTALIGN",e[e.SBS_SIZEBOXTOPLEFTALIGN=2]="SBS_SIZEBOXTOPLEFTALIGN",e[e.SBS_SIZEBOXBOTTOMRIGHTALIGN=4]="SBS_SIZEBOXBOTTOMRIGHTALIGN",e[e.SBS_SIZEBOX=8]="SBS_SIZEBOX",e[e.LBS_NOTIFY=1]="LBS_NOTIFY",e[e.LBS_SORT=2]="LBS_SORT",e[e.LBS_NOREDRAW=4]="LBS_NOREDRAW",e[e.LBS_MULTIPLESEL=8]="LBS_MULTIPLESEL",e[e.LBS_OWNERDRAWFIXED=16]="LBS_OWNERDRAWFIXED",e[e.LBS_OWNERDRAWVARIABLE=32]="LBS_OWNERDRAWVARIABLE",e[e.LBS_HASSTRINGS=64]="LBS_HASSTRINGS",e[e.LBS_USETABSTOPS=128]="LBS_USETABSTOPS",e[e.LBS_NOINTEGRALHEIGHT=256]="LBS_NOINTEGRALHEIGHT",e[e.LBS_MULTICOLUMN=512]="LBS_MULTICOLUMN",e[e.LBS_WANTKEYBOARDINPUT=1024]="LBS_WANTKEYBOARDINPUT",e[e.LBS_EXTENDEDSEL=2048]="LBS_EXTENDEDSEL",e[e.CBS_SIMPLE=1]="CBS_SIMPLE",e[e.CBS_DROPDOWN=2]="CBS_DROPDOWN",e[e.CBS_DROPDOWNLIST=3]="CBS_DROPDOWNLIST",e[e.CBS_OWNERDRAWFIXED=16]="CBS_OWNERDRAWFIXED",e[e.CBS_OWNERDRAWVARIABLE=32]="CBS_OWNERDRAWVARIABLE",e[e.CBS_AUTOHSCROLL=64]="CBS_AUTOHSCROLL",e[e.CBS_OEMCONVERT=128]="CBS_OEMCONVERT",e[e.CBS_SORT=256]="CBS_SORT",e[e.CBS_HASSTRINGS=512]="CBS_HASSTRINGS",e[e.CBS_NOINTEGRALHEIGHT=1024]="CBS_NOINTEGRALHEIGHT",e[e.BS_SOLID=0]="BS_SOLID",e[e.BS_NULL=1]="BS_NULL",e[e.BS_HATCHED=2]="BS_HATCHED",e[e.BS_PATTERN=3]="BS_PATTERN",e[e.BS_GRADIENT_LINEAR=10]="BS_GRADIENT_LINEAR",e[e.HS_HORIZONTAL=0]="HS_HORIZONTAL",e[e.HS_VERTICAL=1]="HS_VERTICAL",e[e.HS_FDIAGONAL=2]="HS_FDIAGONAL",e[e.HS_BDIAGONAL=3]="HS_BDIAGONAL",e[e.HS_CROSS=4]="HS_CROSS",e[e.HS_DIAGCROSS=5]="HS_DIAGCROSS",e[e.PS_SOLID=0]="PS_SOLID",e[e.PS_DASH=1]="PS_DASH",e[e.PS_DOT=2]="PS_DOT",e[e.PS_DASHDOT=3]="PS_DASHDOT",e[e.PS_DASHDOTDOT=4]="PS_DASHDOTDOT",e[e.PS_NULL=5]="PS_NULL",e[e.PS_INSIDEFRAME=6]="PS_INSIDEFRAME",e[e.R2_BLACK=1]="R2_BLACK",e[e.R2_NOTMERGEPEN=2]="R2_NOTMERGEPEN",e[e.R2_MASKNOTPEN=3]="R2_MASKNOTPEN",e[e.R2_NOTCOPYPEN=4]="R2_NOTCOPYPEN",e[e.R2_MASKPENNOT=5]="R2_MASKPENNOT",e[e.R2_NOT=6]="R2_NOT",e[e.R2_XORPEN=7]="R2_XORPEN",e[e.R2_NOTMASKPEN=8]="R2_NOTMASKPEN",e[e.R2_MASKPEN=9]="R2_MASKPEN",e[e.R2_NOTXORPEN=10]="R2_NOTXORPEN",e[e.R2_NOP=11]="R2_NOP",e[e.R2_MERGENOTPEN=12]="R2_MERGENOTPEN",e[e.R2_COPYPEN=13]="R2_COPYPEN",e[e.R2_MERGEPENNOT=14]="R2_MERGEPENNOT",e[e.R2_MERGEPEN=15]="R2_MERGEPEN",e[e.R2_WHITE=16]="R2_WHITE",e[e.FILE_ATTRIBUTE_ARCHIVE=32]="FILE_ATTRIBUTE_ARCHIVE",e[e.FILE_ATTRIBUTE_COMPRESSED=2048]="FILE_ATTRIBUTE_COMPRESSED",e[e.FILE_ATTRIBUTE_DIRECTORY=16]="FILE_ATTRIBUTE_DIRECTORY",e[e.FILE_ATTRIBUTE_HIDDEN=2]="FILE_ATTRIBUTE_HIDDEN",e[e.FILE_ATTRIBUTE_NORMAL=128]="FILE_ATTRIBUTE_NORMAL",e[e.FILE_ATTRIBUTE_OFFLINE=4096]="FILE_ATTRIBUTE_OFFLINE",e[e.FILE_ATTRIBUTE_READONLY=1]="FILE_ATTRIBUTE_READONLY",e[e.FILE_ATTRIBUTE_SYSTEM=4]="FILE_ATTRIBUTE_SYSTEM",e[e.FILE_ATTRIBUTE_TEMPORARY=256]="FILE_ATTRIBUTE_TEMPORARY",e[e.VF_LOCAL=2]="VF_LOCAL",e[e.VF_EQVAR=256]="VF_EQVAR",e[e.VF_ARGUMENT=512]="VF_ARGUMENT",e[e.VF_RETURN=1024]="VF_RETURN",e[e.CUR_ARROW=0]="CUR_ARROW",e[e.CUR_CROSS=1]="CUR_CROSS",e[e.CUR_TEXT=2]="CUR_TEXT",e[e.CUR_NO=3]="CUR_NO",e[e.CUR_SIZE=4]="CUR_SIZE",e[e.CUR_SIZENESW=5]="CUR_SIZENESW",e[e.CUR_SIZENS=6]="CUR_SIZENS",e[e.CUR_SIZENWSE=7]="CUR_SIZENWSE",e[e.CUR_SIZEWE=8]="CUR_SIZEWE",e[e.CUR_UPARROW=9]="CUR_UPARROW",e[e.CUR_WAIT=10]="CUR_WAIT",e[e.CUR_LINK=11]="CUR_LINK",e[e.CUR_HELP=12]="CUR_HELP",e[e.SHADOWTYPE_STENCIL_MODULATIVE=18]="SHADOWTYPE_STENCIL_MODULATIVE",e[e.SHADOWTYPE_STENCIL_ADDITIVE=17]="SHADOWTYPE_STENCIL_ADDITIVE",e[e.SHADOWTYPE_TEXTURE_MODULATIVE=34]="SHADOWTYPE_TEXTURE_MODULATIVE",e[e.SHADOWTYPE_TEXTURE_ADDITIVE=33]="SHADOWTYPE_TEXTURE_ADDITIVE",e[e.FOG_NONE=0]="FOG_NONE",e[e.FOG_EXP=1]="FOG_EXP",e[e.FOG_EXP2=2]="FOG_EXP2",e[e.FOG_LINEAR=3]="FOG_LINEAR",e[e.TEX_TYPE_1D=1]="TEX_TYPE_1D",e[e.TEX_TYPE_2D=2]="TEX_TYPE_2D",e[e.TEX_TYPE_3D=3]="TEX_TYPE_3D",e[e.TEX_TYPE_CUBE_MAP=4]="TEX_TYPE_CUBE_MAP",e[e.SBF_ONE=0]="SBF_ONE",e[e.SBF_ZERO=1]="SBF_ZERO",e[e.SBF_DEST_COLOUR=2]="SBF_DEST_COLOUR",e[e.SBF_SOURCE_COLOUR=3]="SBF_SOURCE_COLOUR",e[e.SBF_ONE_MINUS_DEST_COLOUR=4]="SBF_ONE_MINUS_DEST_COLOUR",e[e.SBF_ONE_MINUS_SOURCE_COLOUR=5]="SBF_ONE_MINUS_SOURCE_COLOUR",e[e.SBF_DEST_ALPHA=6]="SBF_DEST_ALPHA",e[e.SBF_SOURCE_ALPHA=7]="SBF_SOURCE_ALPHA",e[e.SBF_ONE_MINUS_DEST_ALPHA=8]="SBF_ONE_MINUS_DEST_ALPHA",e[e.SBF_ONE_MINUS_SOURCE_ALPHA=9]="SBF_ONE_MINUS_SOURCE_ALPHA",e[e.CMPF_ALWAYS_FAIL=0]="CMPF_ALWAYS_FAIL",e[e.CMPF_ALWAYS_PASS=1]="CMPF_ALWAYS_PASS",e[e.CMPF_LESS=2]="CMPF_LESS",e[e.CMPF_LESS_EQUAL=3]="CMPF_LESS_EQUAL",e[e.CMPF_EQUAL=4]="CMPF_EQUAL",e[e.CMPF_NOT_EQUAL=5]="CMPF_NOT_EQUAL",e[e.CMPF_GREATER_EQUAL=6]="CMPF_GREATER_EQUAL",e[e.CMPF_GREATER=7]="CMPF_GREATER",e[e.CULL_NONE=1]="CULL_NONE",e[e.CULL_CLOCKWISE=2]="CULL_CLOCKWISE",e[e.CULL_ANTICLOCKWISE=3]="CULL_ANTICLOCKWISE",e[e.SO_FLAT=0]="SO_FLAT",e[e.SO_GOURAUD=1]="SO_GOURAUD",e[e.SO_PHONG=2]="SO_PHONG",e[e.PM_POINTS=1]="PM_POINTS",e[e.PM_WIREFRAME=2]="PM_WIREFRAME",e[e.PM_SOLID=3]="PM_SOLID",e[e.LT_POINT=0]="LT_POINT",e[e.LT_DIRECTIONAL=1]="LT_DIRECTIONAL",e[e.LT_SPOTLIGHT=2]="LT_SPOTLIGHT",e[e.PT_ORTHOGRAPHIC=0]="PT_ORTHOGRAPHIC",e[e.PT_PERSPECTIVE=1]="PT_PERSPECTIVE",e[e.OT_POINT_LIST=1]="OT_POINT_LIST",e[e.OT_LINE_LIST=2]="OT_LINE_LIST",e[e.OT_LINE_STRIP=3]="OT_LINE_STRIP",e[e.OT_TRIANGLE_LIST=4]="OT_TRIANGLE_LIST",e[e.OT_TRIANGLE_STRIP=5]="OT_TRIANGLE_STRIP",e[e.OT_TRIANGLE_FAN=6]="OT_TRIANGLE_FAN",e[e.BBT_POINT=0]="BBT_POINT",e[e.BBT_ORIENTED_COMMON=1]="BBT_ORIENTED_COMMON",e[e.BBT_ORIENTED_SELF=2]="BBT_ORIENTED_SELF",e[e.BBT_PERPENDICULAR_COMMON=3]="BBT_PERPENDICULAR_COMMON",e[e.BBT_PERPENDICULAR_SELF=4]="BBT_PERPENDICULAR_SELF",e[e.GMM_RELATIVE=0]="GMM_RELATIVE",e[e.GMM_PIXELS=1]="GMM_PIXELS",e[e.GMM_RELATIVE_ASPECT_ADJUSTED=2]="GMM_RELATIVE_ASPECT_ADJUSTED",e[e.GHA_LEFT=0]="GHA_LEFT",e[e.GHA_CENTER=1]="GHA_CENTER",e[e.GHA_RIGHT=2]="GHA_RIGHT",e[e.GVA_TOP=0]="GVA_TOP",e[e.GVA_CENTER=1]="GVA_CENTER",e[e.GVA_BOTTOM=2]="GVA_BOTTOM",e[e.MTHA_LEFT=0]="MTHA_LEFT",e[e.MTHA_CENTER=1]="MTHA_CENTER",e[e.MTVA_BELOW=0]="MTVA_BELOW",e[e.MTVA_ABOVE=1]="MTVA_ABOVE",e[e.MTVA_CENTER=2]="MTVA_CENTER",e[e.PT_BOOL=0]="PT_BOOL",e[e.PT_REAL=1]="PT_REAL",e[e.PT_INT=2]="PT_INT",e[e.PT_UNSIGNED_INT=3]="PT_UNSIGNED_INT",e[e.PT_SHORT=4]="PT_SHORT",e[e.PT_UNSIGNED_SHORT=5]="PT_UNSIGNED_SHORT",e[e.PT_LONG=6]="PT_LONG",e[e.PT_UNSIGNED_LONG=7]="PT_UNSIGNED_LONG",e[e.PT_STRING=8]="PT_STRING",e[e.PT_VECTOR3=9]="PT_VECTOR3",e[e.PT_MATRIX3=10]="PT_MATRIX3",e[e.PT_MATRIX4=11]="PT_MATRIX4",e[e.PT_QUATERNION=12]="PT_QUATERNION",e[e.PT_COLOURVALUE=13]="PT_COLOURVALUE",e[e.NUI_SP_HIP_CENTER=0]="NUI_SP_HIP_CENTER",e[e.NUI_SP_SPINE=1]="NUI_SP_SPINE",e[e.NUI_SP_SHOULDER_CENTER=2]="NUI_SP_SHOULDER_CENTER",e[e.NUI_SP_HEAD=3]="NUI_SP_HEAD",e[e.NUI_SP_SHOULDER_LEFT=4]="NUI_SP_SHOULDER_LEFT",e[e.NUI_SP_ELBOW_LEFT=5]="NUI_SP_ELBOW_LEFT",e[e.NUI_SP_WRIST_LEFT=6]="NUI_SP_WRIST_LEFT",e[e.NUI_SP_HAND_LEFT=7]="NUI_SP_HAND_LEFT",e[e.NUI_SP_SHOULDER_RIGHT=8]="NUI_SP_SHOULDER_RIGHT",e[e.NUI_SP_ELBOW_RIGHT=9]="NUI_SP_ELBOW_RIGHT",e[e.NUI_SP_WRIST_RIGHT=10]="NUI_SP_WRIST_RIGHT",e[e.NUI_SP_HAND_RIGHT=11]="NUI_SP_HAND_RIGHT",e[e.NUI_SP_HIP_LEFT=12]="NUI_SP_HIP_LEFT",e[e.NUI_SP_KNEE_LEFT=13]="NUI_SP_KNEE_LEFT",e[e.NUI_SP_ANKLE_LEFT=14]="NUI_SP_ANKLE_LEFT",e[e.NUI_SP_FOOT_LEFT=15]="NUI_SP_FOOT_LEFT",e[e.NUI_SP_HIP_RIGHT=16]="NUI_SP_HIP_RIGHT",e[e.NUI_SP_KNEE_RIGHT=17]="NUI_SP_KNEE_RIGHT",e[e.NUI_SP_ANKLE_RIGHT=18]="NUI_SP_ANKLE_RIGHT",e[e.NUI_SP_FOOT_RIGHT=19]="NUI_SP_FOOT_RIGHT",e[e.NUI_SP_COUNT=20]="NUI_SP_COUNT",e))(x||{});const ur=258;var G=(e=>(e[e.FLOAT=1]="FLOAT",e[e.STRING=2]="STRING",e[e.HANDLE=3]="HANDLE",e[e.COLORREF=4]="COLORREF",e))(G||{});const Co=1,Uo=0,Fo=1,Wo=2,Vo=3,$o=4,jo="CM_CLEARALL",Ho="CM_PREVPAGE",Ee=8;var Oe=(e=>(e[e.FLOAT_REF=G.FLOAT|Ee]="FLOAT_REF",e[e.STRING_REF=G.STRING|Ee]="STRING_REF",e[e.HANDLE_REF=G.HANDLE|Ee]="HANDLE_REF",e[e.COLORREF_REF=G.COLORREF|Ee]="COLORREF_REF",e))(Oe||{});class Xo{constructor(){this.blocks=[]}pushBlock(t){return this.blocks.push(t),t}popBlock(t){const r=this.blocks.pop();if(r?.expect!==t)throw Error(`Ожидалось ${t}`);return r}lastBlock(){return this.blocks.length>0?this.blocks[this.blocks.length-1]:null}haveABreakHaveAKitKat(){for(let t=this.blocks.length-1;t>=0;--t)if(this.blocks[t].canBreak)return"break;";return"return;"}}const Yo="map",zo="g",dr="schema",fr="string",ps="n",_s="o",Es={[G.FLOAT]:"f",[G.HANDLE]:"i",[G.COLORREF]:"i",[G.STRING]:"s"},qo=`
"use strict"
const { map, values } = memory;
const of = values.oldFloats;
const nf = values.newFloats;
const oi = values.oldInts;
const ni = values.newInts;
const os = values.oldStrings;
const ns = values.newStrings;
function string(value) {
    return (Math.round(value * 1e5) / 1e5).toString()
}
`,Ko="userFunction",Zo="solveEquationsFor",{FLOAT:C,STRING:re,HANDLE:At,COLORREF:Jo}=G,Qo=[["ABS",{argTypes:[C],retType:C,template:"Math.abs(#0) || 0"}],["ALLTRIM",{argTypes:[re],retType:re,template:"(#0).trim()"}],["AND",{argTypes:[C,C],retType:C,template:"(#0) && (#1) ? 1 : 0"}],["ARCTAN",{argTypes:[C],retType:C,template:"Math.atan(#0)||0"}],["AVERAGE",{argTypes:[C,C],retType:C,template:"(#0) / 2 + (#1) / 2"}],["COMPARE",{argTypes:[re,re],retType:C,template:"(#0) == (#1) ? 1 : 0"}],["COS",{argTypes:[C],retType:C,template:"Math.cos(#0) || 0"}],["DEG",{argTypes:[C],retType:C,template:"180 * (#0) / Math.PI || 0"}],["DELTA",{argTypes:[C],retType:C,template:"(#0) ? 0 : 1"}],["ED",{argTypes:[C],retType:C,template:"(#0) > 0 ? 1 : 0"}],["ED",{argTypes:[At],retType:C,template:"(#0) > 0 ? 1 : 0"}],["EXP",{argTypes:[C],retType:C,template:"Math.exp(#0) || 0"}],["FLOAT",{argTypes:[Jo],retType:C,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[C],retType:C,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[At],retType:C,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[re],retType:C,template:"parseFloat(#0) || 0"}],["HANDLE",{argTypes:[C],retType:At,template:"parseInt(#0) || 0"}],["LEFT",{argTypes:[re,C],retType:re,template:"(#0).substring(0, #1)"}],["LENGTH",{argTypes:[re],retType:C,template:"(#0).length"}],["LIMIT",{argTypes:[C,C,C],retType:C,template:"Math.max(#1, Math.min(#2, #0))||0"}],["LOWER",{argTypes:[re],retType:re,template:"(#0).toLowerCase()"}],["LTRIM",{argTypes:[re],retType:re,template:'(#0).replace(/^\\s+/, "")'}],["MAX",{argTypes:[C,C],retType:C,template:"Math.max(#0, #1) || 0"}],["MIN",{argTypes:[C,C],retType:C,template:"Math.min(#0, #1) || 0"}],["NOT",{argTypes:[C],retType:C,template:"(#0) ? 0 : 1"}],["NOT",{argTypes:[At],retType:C,template:"(#0) ? 0 : 1"}],["NOTBIN",{argTypes:[C],retType:C,template:"~(#0)"}],["OR",{argTypes:[C,C],retType:C,template:"(#0) || (#1) ? 1 : 0"}],["RAD",{argTypes:[C],retType:C,template:"Math.PI * (#0) / 180 || 0"}],["REPLICATE",{argTypes:[re,C],retType:re,template:"(#0).repeat(#1)"}],["RND",{argTypes:[C],retType:C,template:"(#0) * Math.random()"}],["RTRIM",{argTypes:[re],retType:re,template:'(#0).replace(/\\s+$/, "")'}],["SGN",{argTypes:[C],retType:C,template:"Math.sign(#0) || 0"}],["SIN",{argTypes:[C],retType:C,template:"Math.sin(#0) || 0"}],["SQR",{argTypes:[C],retType:C,template:"(#0) ** 2"}],["SQRT",{argTypes:[C],retType:C,template:"Math.sqrt(#0) || 0"}],["STRING",{argTypes:[C],retType:re,template:`${fr}(#0)`}],["TAN",{argTypes:[C],retType:C,template:"Math.tan(#0) || 0"}],["TRUNC",{argTypes:[C],retType:C,template:"Math.trunc(#0) || 0"}],["UPPER",{argTypes:[re],retType:re,template:"(#0).toUpperCase()"}],["XOR",{argTypes:[C,C],retType:C,template:"(#0) !== 0 ^ (#1) !== 0"}],["XORBIN",{argTypes:[C,C],retType:C,template:"(#0) ^ (#1)"}]],ec=(()=>{const e=new Map;return Qo.forEach(([t,r])=>{let s=e.get(t);s||e.set(t,s=[]),s.push(r)}),e})(),{FLOAT:V,STRING:se,HANDLE:we,COLORREF:Nt}=G,ws=[{name:"^",arg:[V,V],ret:V,text:"#0 ** #1",prior:13},{name:"*",arg:[V,V],ret:V,text:"#0 * #1",prior:12},{name:"/",arg:[V,V],ret:V,text:"#0 / (#1 || Infinity)",prior:12},{name:"%",arg:[V,V],ret:V,text:"#0 % #1",prior:12},{name:"+",arg:[V,V],ret:V,text:"#0 + #1",prior:11},{name:"+",arg:[se,se],ret:se,text:"#0 + #1",prior:11},{name:"+",arg:[se,V],ret:se,text:`#0 + ${fr}(#1)`,prior:11},{name:"+",arg:[V,se],ret:se,text:`${fr}(#0) + #1`,prior:11},{name:"-",arg:[V,V],ret:V,text:"#0 - #1",prior:11},{name:"<<",arg:[V,V],ret:V,text:"#0 << #1",prior:10},{name:">>",arg:[V,V],ret:V,text:"#0 >> #1",prior:10},{name:">",arg:[V,V],ret:V,text:"+(#0 > #1)",prior:9},{name:">=",arg:[V,V],ret:V,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[V,V],ret:V,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[V,V],ret:V,text:"+(#0 <= #1)",prior:9},{name:">",arg:[se,se],ret:V,text:"+(#0 > #1)",prior:9},{name:">=",arg:[se,se],ret:V,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[se,se],ret:V,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[se,se],ret:V,text:"+(#0 <= #1)",prior:9},{name:"==",arg:[V,V],ret:V,text:"+(#0 == #1)",prior:8},{name:"==",arg:[se,se],ret:V,text:"+(#0 == #1)",prior:8},{name:"==",arg:[we,we],ret:V,text:"+(#0 == #1)",prior:8},{name:"==",arg:[Nt,Nt],ret:V,text:"+(#0 == #1)",prior:8},{name:"!=",arg:[V,V],ret:V,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[se,se],ret:V,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[we,we],ret:V,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[Nt,Nt],ret:V,text:"+(#0 != #1)",prior:8},{name:"&",arg:[V,V],ret:V,text:"#0 & #1",prior:7},{name:"|",arg:[V,V],ret:V,text:"#0 | #1",prior:5},{name:"&&",arg:[V,V],ret:V,text:"+Boolean(#0 && #1)",prior:4},{name:"&&",arg:[we,we],ret:we,text:"+Boolean(#0 && #1)",prior:4},{name:"||",arg:[V,V],ret:V,text:"+Boolean(#0 || #1)",prior:3},{name:"||",arg:[we,we],ret:we,text:"+Boolean(#0 || #1)",prior:3}],tc=Array.from(new Re(ws.map(e=>[e.prior,e.name]))).sort((e,t)=>t[0]-e[0]).map(e=>Array.from(e[1]));class rc{constructor(){this.m=new Map}declareVar(t,r,s){const i=t.toLowerCase(),n=this.m.get(i);if(n&&n[0].type!==r)throw Error(`Переменная уже объявлена: ${t}`);const l={name:t,type:r,attrib:s||void 0};this.m.set(i,[l,this.m.size])}makeInEquation(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);if(s[0].type!==G.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);s[0].inEquation=!0}setAsReturn(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);s[0].attrib=(s[0].attrib??0)|x.VF_RETURN}getFloatVar(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);if(s[0].type!==G.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);return`$${r}`}_getOrCreateVar(t,r){const s=t.toLowerCase(),i=this.m.get(s);if(i)return[s,i[0]];const n={name:t,type:r};return this.m.set(s,[n,this.m.size]),[s,n]}getOrCreateVar(t,r,s=G.FLOAT){const[i,{type:n}]=this._getOrCreateVar(r,s),l=`${t?ps:_s}${Es[n]}`,a=`$${i}`;return{text:`${l}[${a}]`,type:n}}derefer(t,r=G.FLOAT){const s=t.first;if(s.type!=="var"||t.rest.length>0)throw Error("Должно быть имя переменной");const[i,{type:n}]=this._getOrCreateVar(s.name,r),l=`${s.isNew?ps:_s}${Es[n]}`,a=`$${i}`;return[l,a]}result(){return[...this.m.values()].sort((t,r)=>t[1]-r[1]).map(t=>t[0])}}function ms(e,t){const r=t.args.map(a=>me(e,a)),s=t.name.toUpperCase(),i=ec.get(s);if(i){const a=i.find(({argTypes:d})=>d.length===r.length&&d.every((p,_)=>p===r[_].type));if(!a)throw Error(`Некорректная сигнатура функции ${t.name}(${r.map(d=>G[d.type])}).
Возможные варианты:
`+i.map(d=>`${t.name}(${d.argTypes.map(p=>G[p])})`).join(`
`));const u=r.map(d=>d.text);return{text:a.template.replace(/#(\d)/g,(d,p)=>u[p]),type:a.retType}}if(s==="EXIT"){if(r.length>0)throw Error(`${t.name}: ожидалось 0 аргументов, получено ${r.length}`);return{text:"return",type:null}}const n=e.funcTable?.get(s);if(!n)throw Error(`Функция не существует: ${`${t.name}(${r.map(a=>G[a.type])})`}`);const l=n.find(a=>{if(!a.argTypes.every((_,T)=>{if(T>=r.length)return!1;const m=_&Ee-1;return r[T].type===m}))return!1;const d=r.length-a.argTypes.length;if(!d)return!0;if(a.type==="user")return!1;const{restArgsTypes:p}=a;return d%p.length!==0?!1:r.slice(-d).every((_,T)=>_.type===p[T%p.length])});if(!l){const a=`${t.name}(${r.map(d=>G[d.type])})`,u=n.map(d=>{const p=d.argTypes.map(_=>(_&Ee?"&":"")+G[_&Ee-1]);return d.type==="plugin"&&d.restArgsTypes.length&&p.push(`[${d.restArgsTypes.map(_=>G[_])}]`),` - ${t.name}(${p})`});throw Error(`Некорректная сигнатура функции ${a}.
Возможные варианты:
${u.join(`;
`)}`)}if(l.type==="plugin"){const a=r.map((u,d)=>l.argTypes[d]&Ee?e.vars.derefer(t.args[d]):u.text);return{text:`${zo}.${l.path}.call(${[dr,...a]})`,type:l.retType}}else{const a=r.map(u=>u.text);return{text:`${dr}.${Ko}(${[`"${l.name}"`,`[${a}]`]})`,type:l.retType}}}function sc(e){return`t${e.tmpVarCount++}`}function It(e,t){switch(t.isNew&&t.type!=="var"&&e.bugs.push(["Применение оператора '~' не к переменной",t]),t.type){case"float":return{text:t.value,type:G.FLOAT};case"handle":return{text:t.value,type:G.HANDLE};case"string":return{text:"`"+t.value.replace(/[`$\\]/g,"\\$&")+"`",type:G.STRING};case"var":{const r=x[t.name.toUpperCase()]?.toString();return r?{text:r,type:G.FLOAT}:e.vars.getOrCreateVar(t.isNew,t.name)}case"call":{let r=t;if(t.isNew&&t.args.length){const n={...t.args[0].first,isNew:!0},l=[{...t.args[0],first:n},...t.args.slice(1)];r={...t,args:l}}const s=sc(e),i=ms(e,r);if(!i.type)throw Error(`Функция ${t.name} не возвращает значения`);return e.lines.push(`const ${s}=${i.text};`),{text:s,type:i.type}}case"-":case"!":{let r=t.op;t.isNew&&(r={...r,isNew:!0});const s=It(e,r);if(s.type!==G.FLOAT)throw Error(`Оператор "${t.type}" не применим к ${G[s.type]}`);return{text:`(${t.type}${s.text})`,type:s.type}}case"subexpr":{const r=me(e,t.expr);return{text:`(${r.text})`,type:r.type}}}}function me(e,{first:t,rest:r}){if(!r.length)return It(e,t);const s=[{type:"decl",op:t},...ns(r.map(n=>[n.action,{type:"decl",op:n.operand}]))];tc.forEach(n=>{for(;;){const l=s.findIndex(R=>typeof R=="string"&&n.includes(R));if(l<0)break;const a=s[l],u=s[l-1],d=s[l+1],p=u.type==="decl"?It(e,u.op):u.res,_=d.type==="decl"?It(e,d.op):d.res,T=ws.find(({name:R,arg:N})=>R===a&&N[0]===p.type&&N[1]===_.type);if(!T)throw Error(`Оператор '${a}' неприменим к '${G[p.type]}', '${G[_.type]}'`);const m={text:T.text.replace(/#\d/g,R=>(R==="#0"?p:_).text),type:T.ret};s.splice(l-1,3,{type:"parsed",res:m})}});const i=s[0];if(typeof i!="object"||i.type!=="parsed")throw Error("Ошибка разбора выражения");return i.res}function Ts(e,t,r){if(t!==r)throw Error(`"${e}" имеет тип ${G[t]}, но правое выражение возвращает ${G[r]}`)}function ys(e,t){switch(t.type){case":=":{const s=me(e,t.expr),i=e.vars.getOrCreateVar(!0,t.to,s.type);Ts(t.to,i.type,s.type),e.lines.push(`${i.text} = ${s.text};`);break}case"callChain":{t.functions.forEach(s=>{const i=ms(e,s);e.lines.push(`${i.text};`)});break}case"if":{e.b.pushBlock({canBreak:!1,expect:"endif",hasElse:!1});const s=me(e,t.expr);e.lines.push(`if (${s.text}) {`);break}case"else":{const s=e.b.lastBlock();if(s?.expect!=="endif"||s.hasElse)throw Error("else должен находиться после if");s.hasElse=!0,e.lines.push("} else {");break}case"endif":{e.b.popBlock("endif"),e.lines.push("}");break}case"varsDec":{const{datatype:s,modifiers:i,names:n}=t;let l;switch(s){case"FLOAT":case"INTEGER":l=G.FLOAT;break;case"HANDLE":l=G.HANDLE;break;case"STRING":l=G.STRING;break;case"COLORREF":l=G.COLORREF;break}const a=(i.includes("LOCAL")?x.VF_LOCAL:0)|(i.includes("PARAMETER")?x.VF_ARGUMENT:0);n.forEach(u=>e.vars.declareVar(u,l,a));break}case"while":{e.b.pushBlock({expect:"endwhile",canBreak:!0});const s=`g${++e.whileGuardCount}`;e.lines.push(`var ${s} = 0;`),e.lines.push("while (true) {"),e.lines.push(`if (++${s} > 100000) throw Error("Бесконечный цикл (100000 итераций)");`);const i=me(e,t.expr);e.lines.push(`if (!(${i.text})) break;`);break}case"endwhile":{e.b.popBlock("endwhile"),e.lines.push("}");break}case"do":{e.b.pushBlock({expect:"until",canBreak:!0}),e.lines.push("do {");break}case"until":{e.b.popBlock("until");const s=me(e,t.expr);e.lines.push(`} while (${s.text});`);break}case"switch":{e.b.pushBlock({expect:"endswitch",canBreak:!0,caseCount:0}),e.lines.push("do { //switch");break}case"endswitch":{const s=e.b.popBlock("endswitch");if(!s.caseCount)throw Error("Ожидалось case");for(let i=0;i<s.caseCount;++i)e.lines.push("}");e.lines.push("} while (false); //endswitch");break}case"case":{const s=e.b.lastBlock();if(s?.expect!=="endswitch")throw Error("case должен находиться внутри блока switch");s.caseCount&&e.lines.push("} else {"),++s.caseCount;const i=me(e,t.expr);e.lines.push(`if (${i.text}) { //case`);break}case"default":{if(e.b.lastBlock()?.expect!=="endswitch")throw Error("default должен находиться внутри блока switch");e.lines.push("} else { //default");break}case"break":e.lines.push(e.b.haveABreakHaveAKitKat());break;case"=":{const s={...e,lines:[]},i=me(s,t.lhs);if(i.type!==G.FLOAT)throw Error("Левая часть выражения не возвращает FLOAT");const n=me(s,t.rhs);if(n.type!==G.FLOAT)throw Error("Правая часть выражения не возвращает FLOAT");s.lines.push(`return ${n.text} - (${i.text});`),e.equations.push(s.lines);break}case"::=":{const s={...e,lines:[]},i=me(s,t.expr),n=e.vars.getOrCreateVar(!0,t.to,i.type);Ts(t.to,n.type,i.type),s.lines.push(`${n.text} = ${i.text};`),e.defers.push(s.lines);break}case"eqResult":{if(t.deferred)t.vars.forEach(s=>e.vars.makeInEquation(s));else{const s=t.vars.map(i=>e.vars.getFloatVar(i));e.lines.push(`${dr}.${Zo}([${s}]);`)}break}case"function":{e.isFunction=!0;break}case"return":{e.vars.setAsReturn(t.to);break}default:throw Error(`Неизвестный оператор: "${t.type}"`)}}function ic(e,t,r){const s=e.vars.result(),{lines:i,bugs:n,equations:l,defers:a,isFunction:u}=e;if(i.length===0&&l.length===0&&a.length===0)return{bugs:n,vars:s,isFunction:u,mainText:"",equationsTexts:[],defersTexts:[]};const d=s.map((O,k)=>`const $${O.name.toLowerCase()} = ${Yo}[${k}];`).join(`
`),p=qo+`
`+d+`
`,_=t?`//# sourceURL=_transpiled/${t}`:"",T=r?.split(`
`).map(O=>"// "+O).join(`
`)??"",m=i.length?T+p+i.join(`
`)+_:"",R=l.map((O,k)=>p+O.join(`
`)+(_&&`${_}_eq_${k}`)),N=a.map((O,k)=>p+O.join(`
`)+(_&&`${_}_defer_${k}`));return{bugs:n,vars:s,isFunction:u,mainText:m,equationsTexts:R,defersTexts:N}}function nc(e,{funcTable:t,sourceURL:r,comment:s}={}){const i={funcTable:t,vars:new rc,b:new Xo,lines:[],defers:[],equations:[],isFunction:!1,bugs:[],tmpVarCount:0,whileGuardCount:0};e.forEach((l,a)=>{try{ys(i,l);let u=l.then;for(;u;)ys(i,u),u=u.then}catch(u){throw u instanceof Error?Error(`Строка ${a+1}: ${u.message}`):u}});const n=i.b.lastBlock();if(n)throw Error(`Строка ${e.length}: ожидалось ${n.expect}`);return ic(i,r,s)}const gr="'",pr='"';function oc(e){let t="",r=null;for(let s=0;s<e.length;++s){const i=e[s];if(i===gr&&r!==pr?r=r?null:gr:i===pr&&r!==gr&&(r=r?null:pr),r){t+=i;continue}if(i==="/"){const n=e[s+1];if(n==="*"){for(s+=2;s<e.length&&(e[s]!=="*"||e[s+1]!=="/");)++s;++s;continue}if(n==="/"){for(++s;s<e.length&&e[++s]!==`
`;);t[t.length-1]!==`
`&&(t+=`
`);continue}}if(i===";"||i===`
`){t[t.length-1]!==`
`&&(t+=`
`);continue}if(i==="\r"){e[s+1]===`
`&&++s,t[t.length-1]!==`
`&&(t+=`
`);continue}t+=i}return t[t.length-1]===`
`?t:t+`
`}function cc(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function ht(e,t,r,s){this.message=e,this.expected=t,this.found=r,this.location=s,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,ht)}cc(ht,Error),ht.buildMessage=function(e,t){var r={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var p="",_;for(_=0;_<d.parts.length;_++)p+=d.parts[_]instanceof Array?n(d.parts[_][0])+"-"+n(d.parts[_][1]):n(d.parts[_]);return"["+(d.inverted?"^":"")+p+"]"},any:function(d){return"any character"},end:function(d){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+s(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+s(p)})}function n(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+s(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+s(p)})}function l(d){return r[d.type](d)}function a(d){var p=new Array(d.length),_,T;for(_=0;_<d.length;_++)p[_]=l(d[_]);if(p.sort(),p.length>0){for(_=1,T=1;_<p.length;_++)p[_-1]!==p[_]&&(p[T]=p[_],T++);p.length=T}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function u(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+a(e)+" but "+u(t)+" found."};function lc(e,t){t=t!==void 0?t:{};var r={},s={Code:mn},i=mn,n=function(h){return h},l=function(h){return h.filter(g=>g)},a=ee("variable name"),u=function(h){return{type:"var",name:h}},d=",",p=Y(",",!1),_=function(h){return h},T=ee("function call"),m="(",R=Y("(",!1),N=")",O=Y(")",!1),k=function(h,g){return{type:"call",name:h,args:g}},L="-",U=Y("-",!1),F="!",j=Y("!",!1),B=ee("!<operand> or -<operand>"),D=function(h,g){return{type:h,op:g}},I=ee("(<expression>)"),X=function(h){return{type:"subexpr",expr:h}},K=ee("operand"),J="~",he=Y("~",!1),le=function(h,g){return{...g,isNew:!!h}},Z="^",Ge=Y("^",!1),Be="*",Ce=Y("*",!1),rt="/",st=Y("/",!1),bt="%",He=Y("%",!1),it="+",nt=Y("+",!1),Xe=">=",Vr=Y(">=",!1),$r=">",Jb=Y(">",!1),Vi="<=",Qb=Y("<=",!1),eR="<",tR=Y("<",!1),$i="==",rR=Y("==",!1),ji="!=",sR=Y("!=",!1),Hi="&&",iR=Y("&&",!1),nR="&",oR=Y("&",!1),Xi="||",cR=Y("||",!1),lR="|",aR=Y("|",!1),hR=ee("expression"),Yi=function(h,g,y){return{action:g,operand:y}},uR=function(h,g){return{first:h,rest:g}},zi=function(h,g){return g},dR=function(h,g){return[h].concat(g)},qi=function(h,g){return g},fR=function(h,g,y){return{type:"varsDec",datatype:h,modifiers:g,names:y}},gR=ee("assignment operator"),Ki=":=",pR=Y(":=",!1),Zi="::=",_R=Y("::=",!1),ER=function(h,g,y){return{type:g,to:h,expr:y}},wR=ee("equality operator"),Ji="=",Qi=Y("=",!1),mR=function(h,g,y){return{type:g,lhs:h,rhs:y}},TR=ee("immediately equation result"),ot=function(h,g){return g},en="?",tn=Y("?",!1),yR=function(h,g){return{type:"eqResult",deferred:!1,vars:[h].concat(g)}},bR=ee("deferred equation result"),RR=function(h,g){return{type:"eqResult",deferred:!0,vars:[h].concat(g)}},OR=ee("function call chain"),MR=function(h,g){return{type:"callChain",functions:[h].concat(g)}},rn=ee("( <expression> )"),sn=function(h){return h},vR=ee("if(<condition>)"),SR="if",AR=Y("if",!0),NR=function(h){return{type:"if",expr:h}},IR=ee("while(<condition>)"),xR="while",PR=Y("while",!0),DR=function(h){return{type:"while",expr:h}},kR=ee("until(<condition>)"),LR="until",GR=Y("until",!0),BR=function(h){return{type:"until",expr:h}},CR=ee("case(<condition>)"),UR="case",FR=Y("case",!0),WR=function(h,g){return{type:"case",expr:h,then:g}},VR="else",$R=Y("else",!0),jR=function(h){return{type:"else",then:h}},HR="endif",XR=Y("endif",!0),YR=function(h){return{type:"endif",then:h}},zR="break",qR=Y("break",!0),KR=function(){return{type:"break"}},ZR="endwhile",JR=Y("endwhile",!0),QR=function(){return{type:"endwhile"}},eO="do",tO=Y("do",!0),rO=function(){return{type:"do"}},sO="endswitch",iO=Y("endswitch",!0),nO=function(){return{type:"endswitch"}},oO="switch",cO=Y("switch",!0),lO=function(){return{type:"switch"}},aO="default",hO=Y("default",!0),uO=function(h){return{type:"default",then:h}},dO="function",fO=Y("function",!0),gO=function(){return{type:"function"}},pO=ee("return <var name>"),_O="return",EO=Y("return",!0),wO=function(h){return{type:"return",to:h}},mO="handle",TO=Y("HANDLE",!0),yO=function(){return"HANDLE"},bO="string",RO=Y("STRING",!0),OO=function(){return"STRING"},MO="float",vO=Y("FLOAT",!0),SO=function(){return"FLOAT"},AO="colorref",NO=Y("COLORREF",!0),IO=function(){return"COLORREF"},xO="integer",PO=Y("INTEGER",!0),DO=function(){return"INTEGER"},kO="local",LO=Y("LOCAL",!0),GO=function(){return"LOCAL"},BO="nosave",CO=Y("NOSAVE",!0),UO=function(){return"NOSAVE"},FO="parameter",WO=Y("PARAMETER",!0),VO=function(){return"PARAMETER"},nn=/^[_a-z\u0430-\u044F0-9]/i,on=Ue(["_",["a","z"],["а","я"],["0","9"]],!1,!0),$O=ee("function name"),Xt=/^[0-9]/,Yt=Ue([["0","9"]],!1,!1),jO=".",HO=Y(".",!1),XO=/^[eE]/,YO=Ue(["e","E"],!1,!1),zO=/^[+\-]/,qO=Ue(["+","-"],!1,!1),KO=ee("float"),ZO=function(h){return{type:"float",value:h}},JO=ee("handle"),QO="#",eM=Y("#",!1),tM=function(h){return{type:"handle",value:h.length>0?h:"0"}},cn="'",ln=Y("'",!1),an=/^[^']/,hn=Ue(["'"],!0,!1),un='"',dn=Y('"',!1),fn=/^[^"]/,gn=Ue(['"'],!0,!1),rM=function(h){return{type:"string",value:h[1]}},sM=ee("space or tab"),iM=/^[ \t]/,nM=Ue([" ","	"],!1,!1),oM=ee("new line"),cM=`
`,lM=Y(`
`,!1),aM=ee("whitespace"),pn=/^[ \t\n\r]/,_n=Ue([" ","	",`
`,"\r"],!1,!1),f=0,zt=[{line:1,column:1}],ye=0,jr=[],v=0,qt;if("startRule"in t){if(!(t.startRule in s))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=s[t.startRule]}function Y(h,g){return{type:"literal",text:h,ignoreCase:g}}function Ue(h,g,y){return{type:"class",parts:h,inverted:g,ignoreCase:y}}function hM(){return{type:"end"}}function ee(h){return{type:"other",description:h}}function En(h){var g=zt[h],y;if(g)return g;for(y=h-1;!zt[y];)y--;for(g=zt[y],g={line:g.line,column:g.column};y<h;)e.charCodeAt(y)===10?(g.line++,g.column=1):g.column++,y++;return zt[h]=g,g}function wn(h,g){var y=En(h),w=En(g);return{start:{offset:h,line:y.line,column:y.column},end:{offset:g,line:w.line,column:w.column}}}function P(h){f<ye||(f>ye&&(ye=f,jr=[]),jr.push(h))}function uM(h,g,y){return new ht(ht.buildMessage(h,g),h,g,y)}function mn(){var h,g,y,w,S,M,$;for(h=f,g=[],y=f,w=[],S=W();S!==r;)w.push(S),S=W();if(w!==r)if(S=Hr(),S===r&&(S=null),S!==r){for(M=[],$=W();$!==r;)M.push($),$=W();M!==r?($=Rn(),$!==r?(w=n(S),y=w):(f=y,y=r)):(f=y,y=r)}else f=y,y=r;else f=y,y=r;for(;y!==r;){for(g.push(y),y=f,w=[],S=W();S!==r;)w.push(S),S=W();if(w!==r)if(S=Hr(),S===r&&(S=null),S!==r){for(M=[],$=W();$!==r;)M.push($),$=W();M!==r?($=Rn(),$!==r?(w=n(S),y=w):(f=y,y=r)):(f=y,y=r)}else f=y,y=r;else f=y,y=r}return g!==r&&(g=l(g)),h=g,h}function dM(){var h,g;return v++,h=f,g=ge(),g!==r&&(g=u(g)),h=g,v--,h===r&&(g=r,v===0&&P(a)),h}function Tn(){var h,g,y,w,S;for(h=f,g=[],y=W();y!==r;)g.push(y),y=W();if(g!==r)if(y=Ye(),y!==r){for(w=[],S=W();S!==r;)w.push(S),S=W();w!==r?(e.charCodeAt(f)===44?(S=d,f++):(S=r,v===0&&P(p)),S===r&&(S=null),S!==r?(g=_(y),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r;return h}function Kt(){var h,g,y,w,S,M,$,H;if(v++,h=f,g=FM(),g!==r){for(y=[],w=W();w!==r;)y.push(w),w=W();if(y!==r)if(e.charCodeAt(f)===40?(w=m,f++):(w=r,v===0&&P(R)),w!==r){for(S=[],M=W();M!==r;)S.push(M),M=W();if(S!==r){for(M=[],$=Tn();$!==r;)M.push($),$=Tn();if(M!==r){for($=[],H=W();H!==r;)$.push(H),H=W();$!==r?(e.charCodeAt(f)===41?(H=N,f++):(H=r,v===0&&P(O)),H!==r?(g=k(g,M),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r}else f=h,h=r}else f=h,h=r;else f=h,h=r}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(T)),h}function fM(){var h;return e.charCodeAt(f)===45?(h=L,f++):(h=r,v===0&&P(U)),h===r&&(e.charCodeAt(f)===33?(h=F,f++):(h=r,v===0&&P(j))),h}function gM(){var h,g,y,w;if(v++,h=f,g=fM(),g!==r){for(y=[],w=W();w!==r;)y.push(w),w=W();y!==r?(w=Zt(),w!==r?(g=D(g,w),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(B)),h}function pM(){var h,g,y,w,S,M;if(v++,h=f,e.charCodeAt(f)===40?(g=m,f++):(g=r,v===0&&P(R)),g!==r){for(y=[],w=W();w!==r;)y.push(w),w=W();if(y!==r)if(w=Ye(),w!==r){for(S=[],M=W();M!==r;)S.push(M),M=W();S!==r?(e.charCodeAt(f)===41?(M=N,f++):(M=r,v===0&&P(O)),M!==r?(g=X(w),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(I)),h}function Zt(){var h,g,y,w;if(v++,h=f,e.charCodeAt(f)===126?(g=J,f++):(g=r,v===0&&P(he)),g===r&&(g=null),g!==r){for(y=[],w=W();w!==r;)y.push(w),w=W();y!==r?(w=gM(),w===r&&(w=$M(),w===r&&(w=jM(),w===r&&(w=HM(),w===r&&(w=Kt(),w===r&&(w=dM(),w===r&&(w=pM())))))),w!==r?(g=le(g,w),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(K)),h}function yn(){var h;return e.charCodeAt(f)===94?(h=Z,f++):(h=r,v===0&&P(Ge)),h===r&&(e.charCodeAt(f)===42?(h=Be,f++):(h=r,v===0&&P(Ce)),h===r&&(e.charCodeAt(f)===47?(h=rt,f++):(h=r,v===0&&P(st)),h===r&&(e.charCodeAt(f)===37?(h=bt,f++):(h=r,v===0&&P(He)),h===r&&(e.charCodeAt(f)===43?(h=it,f++):(h=r,v===0&&P(nt)),h===r&&(e.charCodeAt(f)===45?(h=L,f++):(h=r,v===0&&P(U)),h===r&&(e.substr(f,2)===Xe?(h=Xe,f+=2):(h=r,v===0&&P(Vr)),h===r&&(e.charCodeAt(f)===62?(h=$r,f++):(h=r,v===0&&P(Jb)),h===r&&(e.substr(f,2)===Vi?(h=Vi,f+=2):(h=r,v===0&&P(Qb)),h===r&&(e.charCodeAt(f)===60?(h=eR,f++):(h=r,v===0&&P(tR)),h===r&&(e.substr(f,2)===$i?(h=$i,f+=2):(h=r,v===0&&P(rR)),h===r&&(e.substr(f,2)===ji?(h=ji,f+=2):(h=r,v===0&&P(sR)),h===r&&(e.substr(f,2)===Hi?(h=Hi,f+=2):(h=r,v===0&&P(iR)),h===r&&(e.charCodeAt(f)===38?(h=nR,f++):(h=r,v===0&&P(oR)),h===r&&(e.substr(f,2)===Xi?(h=Xi,f+=2):(h=r,v===0&&P(cR)),h===r&&(e.charCodeAt(f)===124?(h=lR,f++):(h=r,v===0&&P(aR))))))))))))))))),h}function Ye(){var h,g,y,w,S,M,$,H;if(v++,h=f,g=Zt(),g!==r){for(y=[],w=f,S=[],M=W();M!==r;)S.push(M),M=W();if(S!==r)if(M=yn(),M!==r){for($=[],H=W();H!==r;)$.push(H),H=W();$!==r?(H=Zt(),H!==r?(S=Yi(g,M,H),w=S):(f=w,w=r)):(f=w,w=r)}else f=w,w=r;else f=w,w=r;for(;w!==r;){for(y.push(w),w=f,S=[],M=W();M!==r;)S.push(M),M=W();if(S!==r)if(M=yn(),M!==r){for($=[],H=W();H!==r;)$.push(H),H=W();$!==r?(H=Zt(),H!==r?(S=Yi(g,M,H),w=S):(f=w,w=r)):(f=w,w=r)}else f=w,w=r;else f=w,w=r}y!==r?(g=uR(g,y),h=g):(f=h,h=r)}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(hR)),h}function _M(){var h,g,y,w,S,M,$,H;if(h=f,g=ge(),g!==r){for(y=[],w=f,S=oe(),S!==r?(e.charCodeAt(f)===44?(M=d,f++):(M=r,v===0&&P(p)),M!==r?($=oe(),$!==r?(H=ge(),H!==r?(S=zi(g,H),w=S):(f=w,w=r)):(f=w,w=r)):(f=w,w=r)):(f=w,w=r);w!==r;)y.push(w),w=f,S=oe(),S!==r?(e.charCodeAt(f)===44?(M=d,f++):(M=r,v===0&&P(p)),M!==r?($=oe(),$!==r?(H=ge(),H!==r?(S=zi(g,H),w=S):(f=w,w=r)):(f=w,w=r)):(f=w,w=r)):(f=w,w=r);y!==r?(g=dR(g,y),h=g):(f=h,h=r)}else f=h,h=r;return h}function EM(){var h,g,y,w,S,M,$,H,ae;if(h=f,g=UM(),g!==r){if(y=[],w=W(),w!==r)for(;w!==r;)y.push(w),w=W();else y=r;if(y!==r)if(w=oe(),w!==r){if(S=[],M=f,$=bn(),$!==r){if(H=[],ae=W(),ae!==r)for(;ae!==r;)H.push(ae),ae=W();else H=r;H!==r?($=qi(g,$),M=$):(f=M,M=r)}else f=M,M=r;for(;M!==r;)if(S.push(M),M=f,$=bn(),$!==r){if(H=[],ae=W(),ae!==r)for(;ae!==r;)H.push(ae),ae=W();else H=r;H!==r?($=qi(g,$),M=$):(f=M,M=r)}else f=M,M=r;S!==r?(M=_M(),M!==r?(g=fR(g,S,M),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r}else f=h,h=r;return h}function wM(){var h,g,y,w,S,M;if(v++,h=f,g=ge(),g!==r)if(y=oe(),y!==r)if(e.substr(f,2)===Ki?(w=Ki,f+=2):(w=r,v===0&&P(pR)),w===r&&(e.substr(f,3)===Zi?(w=Zi,f+=3):(w=r,v===0&&P(_R))),w!==r){for(S=[],M=W();M!==r;)S.push(M),M=W();S!==r?(M=Ye(),M!==r?(g=ER(g,w,M),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r;else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(gR)),h}function mM(){var h,g,y,w,S,M;if(v++,h=f,g=Ye(),g!==r)if(y=oe(),y!==r)if(e.charCodeAt(f)===61?(w=Ji,f++):(w=r,v===0&&P(Qi)),w!==r){for(S=[],M=W();M!==r;)S.push(M),M=W();S!==r?(M=Ye(),M!==r?(g=mR(g,w,M),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r;else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(wR)),h}function TM(){var h,g,y,w,S,M,$,H;if(v++,h=f,g=ge(),g!==r){for(y=[],w=f,S=[],M=W();M!==r;)S.push(M),M=W();if(S!==r)if(e.charCodeAt(f)===44?(M=d,f++):(M=r,v===0&&P(p)),M!==r){for($=[],H=W();H!==r;)$.push(H),H=W();$!==r?(H=ge(),H!==r?(S=ot(g,H),w=S):(f=w,w=r)):(f=w,w=r)}else f=w,w=r;else f=w,w=r;for(;w!==r;){for(y.push(w),w=f,S=[],M=W();M!==r;)S.push(M),M=W();if(S!==r)if(e.charCodeAt(f)===44?(M=d,f++):(M=r,v===0&&P(p)),M!==r){for($=[],H=W();H!==r;)$.push(H),H=W();$!==r?(H=ge(),H!==r?(S=ot(g,H),w=S):(f=w,w=r)):(f=w,w=r)}else f=w,w=r;else f=w,w=r}if(y!==r){for(w=[],S=W();S!==r;)w.push(S),S=W();if(w!==r)if(e.charCodeAt(f)===61?(S=Ji,f++):(S=r,v===0&&P(Qi)),S!==r){for(M=[],$=W();$!==r;)M.push($),$=W();M!==r?(e.charCodeAt(f)===63?($=en,f++):($=r,v===0&&P(tn)),$!==r?(g=yR(g,y),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r}else f=h,h=r}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(TR)),h}function yM(){var h,g,y,w,S,M,$,H,ae,ct;if(v++,h=f,e.charCodeAt(f)===63?(g=en,f++):(g=r,v===0&&P(tn)),g!==r)if(y=oe(),y!==r)if(w=ge(),w!==r){for(S=[],M=f,$=oe(),$!==r?(e.charCodeAt(f)===44?(H=d,f++):(H=r,v===0&&P(p)),H!==r?(ae=oe(),ae!==r?(ct=ge(),ct!==r?($=ot(w,ct),M=$):(f=M,M=r)):(f=M,M=r)):(f=M,M=r)):(f=M,M=r);M!==r;)S.push(M),M=f,$=oe(),$!==r?(e.charCodeAt(f)===44?(H=d,f++):(H=r,v===0&&P(p)),H!==r?(ae=oe(),ae!==r?(ct=ge(),ct!==r?($=ot(w,ct),M=$):(f=M,M=r)):(f=M,M=r)):(f=M,M=r)):(f=M,M=r);S!==r?(g=RR(w,S),h=g):(f=h,h=r)}else f=h,h=r;else f=h,h=r;else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(bR)),h}function bM(){var h,g,y,w,S,M;if(v++,h=f,g=Kt(),g!==r){if(y=[],w=f,S=[],M=W(),M!==r)for(;M!==r;)S.push(M),M=W();else S=r;for(S!==r?(M=Kt(),M!==r?(S=ot(g,M),w=S):(f=w,w=r)):(f=w,w=r);w!==r;){if(y.push(w),w=f,S=[],M=W(),M!==r)for(;M!==r;)S.push(M),M=W();else S=r;S!==r?(M=Kt(),M!==r?(S=ot(g,M),w=S):(f=w,w=r)):(f=w,w=r)}y!==r?(g=MR(g,y),h=g):(f=h,h=r)}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(OR)),h}function RM(){var h,g,y,w,S,M;if(v++,h=f,e.charCodeAt(f)===40?(g=m,f++):(g=r,v===0&&P(R)),g!==r){for(y=[],w=W();w!==r;)y.push(w),w=W();if(y!==r)if(w=Ye(),w!==r){for(S=[],M=W();M!==r;)S.push(M),M=W();S!==r?(e.charCodeAt(f)===41?(M=N,f++):(M=r,v===0&&P(O)),M!==r?(g=sn(w),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(rn)),h}function OM(){var h,g,y,w,S;for(v++,h=f,g=[],y=W();y!==r;)g.push(y),y=W();if(g!==r)if(y=Ye(),y!==r){for(w=[],S=W();S!==r;)w.push(S),S=W();w!==r?(e.charCodeAt(f)===41?(S=N,f++):(S=r,v===0&&P(O)),S!==r?(g=sn(y),h=g):(f=h,h=r)):(f=h,h=r)}else f=h,h=r;else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(rn)),h}function Jt(){var h;return h=RM(),h===r&&(h=OM()),h}function Qt(){var h,g,y;if(h=f,g=[],y=W(),y!==r)for(;y!==r;)g.push(y),y=W();else g=r;return g!==r?(y=Hr(),y!==r?(g=_(y),h=g):(f=h,h=r)):(f=h,h=r),h}function MM(){var h,g,y,w;return v++,h=f,e.substr(f,2).toLowerCase()===SR?(g=e.substr(f,2),f+=2):(g=r,v===0&&P(AR)),g!==r?(y=oe(),y!==r?(w=Jt(),w!==r?(g=NR(w),h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),v--,h===r&&(g=r,v===0&&P(vR)),h}function vM(){var h,g,y,w;return v++,h=f,e.substr(f,5).toLowerCase()===xR?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(PR)),g!==r?(y=oe(),y!==r?(w=Jt(),w!==r?(g=DR(w),h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),v--,h===r&&(g=r,v===0&&P(IR)),h}function SM(){var h,g,y,w;return v++,h=f,e.substr(f,5).toLowerCase()===LR?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(GR)),g!==r?(y=oe(),y!==r?(w=Jt(),w!==r?(g=BR(w),h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),v--,h===r&&(g=r,v===0&&P(kR)),h}function AM(){var h,g,y,w,S;return v++,h=f,e.substr(f,4).toLowerCase()===UR?(g=e.substr(f,4),f+=4):(g=r,v===0&&P(FR)),g!==r?(y=oe(),y!==r?(w=Jt(),w!==r?(S=Qt(),S===r&&(S=null),S!==r?(g=WR(w,S),h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),v--,h===r&&(g=r,v===0&&P(CR)),h}function NM(){var h,g,y;return h=f,e.substr(f,4).toLowerCase()===VR?(g=e.substr(f,4),f+=4):(g=r,v===0&&P($R)),g!==r?(y=Qt(),y===r&&(y=null),y!==r?(g=jR(y),h=g):(f=h,h=r)):(f=h,h=r),h}function IM(){var h,g,y;return h=f,e.substr(f,5).toLowerCase()===HR?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(XR)),g!==r?(y=Qt(),y===r&&(y=null),y!==r?(g=YR(y),h=g):(f=h,h=r)):(f=h,h=r),h}function xM(){var h,g;return h=f,e.substr(f,5).toLowerCase()===zR?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(qR)),g!==r&&(g=KR()),h=g,h}function PM(){var h,g;return h=f,e.substr(f,8).toLowerCase()===ZR?(g=e.substr(f,8),f+=8):(g=r,v===0&&P(JR)),g!==r&&(g=QR()),h=g,h}function DM(){var h,g;return h=f,e.substr(f,2).toLowerCase()===eO?(g=e.substr(f,2),f+=2):(g=r,v===0&&P(tO)),g!==r&&(g=rO()),h=g,h}function kM(){var h,g;return h=f,e.substr(f,9).toLowerCase()===sO?(g=e.substr(f,9),f+=9):(g=r,v===0&&P(iO)),g!==r&&(g=nO()),h=g,h}function LM(){var h,g;return h=f,e.substr(f,6).toLowerCase()===oO?(g=e.substr(f,6),f+=6):(g=r,v===0&&P(cO)),g!==r&&(g=lO()),h=g,h}function GM(){var h,g,y;return h=f,e.substr(f,7).toLowerCase()===aO?(g=e.substr(f,7),f+=7):(g=r,v===0&&P(hO)),g!==r?(y=Qt(),y===r&&(y=null),y!==r?(g=uO(y),h=g):(f=h,h=r)):(f=h,h=r),h}function BM(){var h,g;return h=f,e.substr(f,8).toLowerCase()===dO?(g=e.substr(f,8),f+=8):(g=r,v===0&&P(fO)),g!==r&&(g=gO()),h=g,h}function CM(){var h,g,y,w;return v++,h=f,e.substr(f,6).toLowerCase()===_O?(g=e.substr(f,6),f+=6):(g=r,v===0&&P(EO)),g!==r?(y=oe(),y!==r?(w=ge(),w!==r?(g=wO(w),h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),v--,h===r&&(g=r,v===0&&P(pO)),h}function Hr(){var h;return h=EM(),h===r&&(h=wM(),h===r&&(h=mM(),h===r&&(h=TM(),h===r&&(h=yM(),h===r&&(h=MM(),h===r&&(h=NM(),h===r&&(h=IM(),h===r&&(h=xM(),h===r&&(h=vM(),h===r&&(h=PM(),h===r&&(h=DM(),h===r&&(h=SM(),h===r&&(h=kM(),h===r&&(h=LM(),h===r&&(h=AM(),h===r&&(h=GM(),h===r&&(h=bM(),h===r&&(h=BM(),h===r&&(h=CM()))))))))))))))))))),h}function UM(){var h,g;return h=f,e.substr(f,6).toLowerCase()===mO?(g=e.substr(f,6),f+=6):(g=r,v===0&&P(TO)),g!==r&&(g=yO()),h=g,h===r&&(h=f,e.substr(f,6).toLowerCase()===bO?(g=e.substr(f,6),f+=6):(g=r,v===0&&P(RO)),g!==r&&(g=OO()),h=g,h===r&&(h=f,e.substr(f,5).toLowerCase()===MO?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(vO)),g!==r&&(g=SO()),h=g,h===r&&(h=f,e.substr(f,8).toLowerCase()===AO?(g=e.substr(f,8),f+=8):(g=r,v===0&&P(NO)),g!==r&&(g=IO()),h=g,h===r&&(h=f,e.substr(f,7).toLowerCase()===xO?(g=e.substr(f,7),f+=7):(g=r,v===0&&P(PO)),g!==r&&(g=DO()),h=g)))),h}function bn(){var h,g;return h=f,e.substr(f,5).toLowerCase()===kO?(g=e.substr(f,5),f+=5):(g=r,v===0&&P(LO)),g!==r&&(g=GO()),h=g,h===r&&(h=f,e.substr(f,6).toLowerCase()===BO?(g=e.substr(f,6),f+=6):(g=r,v===0&&P(CO)),g!==r&&(g=UO()),h=g,h===r&&(h=f,e.substr(f,9).toLowerCase()===FO?(g=e.substr(f,9),f+=9):(g=r,v===0&&P(WO)),g!==r&&(g=VO()),h=g)),h}function ge(){var h,g,y;if(v++,h=f,g=[],nn.test(e.charAt(f))?(y=e.charAt(f),f++):(y=r,v===0&&P(on)),y!==r)for(;y!==r;)g.push(y),nn.test(e.charAt(f))?(y=e.charAt(f),f++):(y=r,v===0&&P(on));else g=r;return g!==r?h=e.substring(h,f):h=g,v--,h===r&&(g=r,v===0&&P(a)),h}function FM(){var h;return v++,h=ge(),v--,h===r&&v===0&&P($O),h}function Xr(){var h,g;if(h=[],Xt.test(e.charAt(f))?(g=e.charAt(f),f++):(g=r,v===0&&P(Yt)),g!==r)for(;g!==r;)h.push(g),Xt.test(e.charAt(f))?(g=e.charAt(f),f++):(g=r,v===0&&P(Yt));else h=r;return h}function WM(){var h,g,y;return h=f,e.charCodeAt(f)===46?(g=jO,f++):(g=r,v===0&&P(HO)),g!==r?(y=Xr(),y!==r?(g=[g,y],h=g):(f=h,h=r)):(f=h,h=r),h}function VM(){var h,g,y,w;return h=f,XO.test(e.charAt(f))?(g=e.charAt(f),f++):(g=r,v===0&&P(YO)),g!==r?(zO.test(e.charAt(f))?(y=e.charAt(f),f++):(y=r,v===0&&P(qO)),y===r&&(y=null),y!==r?(w=Xr(),w!==r?(g=[g,y,w],h=g):(f=h,h=r)):(f=h,h=r)):(f=h,h=r),h}function $M(){var h,g,y,w,S,M;return v++,h=f,g=f,y=f,w=Xr(),w!==r?(S=WM(),S===r&&(S=null),S!==r?(M=VM(),M===r&&(M=null),M!==r?(w=[w,S,M],y=w):(f=y,y=r)):(f=y,y=r)):(f=y,y=r),y!==r?g=e.substring(g,f):g=y,g!==r&&(g=ZO(g)),h=g,v--,h===r&&(g=r,v===0&&P(KO)),h}function jM(){var h,g,y,w,S;if(v++,h=f,e.charCodeAt(f)===35?(g=QO,f++):(g=r,v===0&&P(eM)),g!==r){for(y=f,w=[],Xt.test(e.charAt(f))?(S=e.charAt(f),f++):(S=r,v===0&&P(Yt));S!==r;)w.push(S),Xt.test(e.charAt(f))?(S=e.charAt(f),f++):(S=r,v===0&&P(Yt));w!==r?y=e.substring(y,f):y=w,y!==r?(g=tM(y),h=g):(f=h,h=r)}else f=h,h=r;return v--,h===r&&(g=r,v===0&&P(JO)),h}function HM(){var h,g,y,w,S,M;if(h=f,g=f,e.charCodeAt(f)===39?(y=cn,f++):(y=r,v===0&&P(ln)),y!==r){for(w=f,S=[],an.test(e.charAt(f))?(M=e.charAt(f),f++):(M=r,v===0&&P(hn));M!==r;)S.push(M),an.test(e.charAt(f))?(M=e.charAt(f),f++):(M=r,v===0&&P(hn));S!==r?w=e.substring(w,f):w=S,w!==r?(e.charCodeAt(f)===39?(S=cn,f++):(S=r,v===0&&P(ln)),S!==r?(y=[y,w,S],g=y):(f=g,g=r)):(f=g,g=r)}else f=g,g=r;if(g===r)if(g=f,e.charCodeAt(f)===34?(y=un,f++):(y=r,v===0&&P(dn)),y!==r){for(w=f,S=[],fn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=r,v===0&&P(gn));M!==r;)S.push(M),fn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=r,v===0&&P(gn));S!==r?w=e.substring(w,f):w=S,w!==r?(e.charCodeAt(f)===34?(S=un,f++):(S=r,v===0&&P(dn)),S!==r?(y=[y,w,S],g=y):(f=g,g=r)):(f=g,g=r)}else f=g,g=r;return g!==r&&(g=rM(g)),h=g,h}function W(){var h;return v++,iM.test(e.charAt(f))?(h=e.charAt(f),f++):(h=r,v===0&&P(nM)),v--,h===r&&v===0&&P(sM),h}function Rn(){var h;return v++,e.charCodeAt(f)===10?(h=cM,f++):(h=r,v===0&&P(lM)),v--,h===r&&v===0&&P(oM),h}function oe(){var h,g;for(v++,h=[],pn.test(e.charAt(f))?(g=e.charAt(f),f++):(g=r,v===0&&P(_n));g!==r;)h.push(g),pn.test(e.charAt(f))?(g=e.charAt(f),f++):(g=r,v===0&&P(_n));return v--,h===r&&(g=r,v===0&&P(aM)),h}if(qt=i(),qt!==r&&f===e.length)return qt;throw qt!==r&&f<e.length&&P(hM()),uM(jr,ye<e.length?e.charAt(ye):null,ye<e.length?wn(ye,ye+1):wn(ye,ye))}const ac=lc;class xt extends Error{constructor(t){super(t.join(`
`)),this.errors=t}format(t=`
`){return this.errors.join(t)}}function hc(e,t){let r;try{r=ac(e)}catch(s){if(!(s instanceof Error))throw s;const i=s.location.start,n=`Строка ${i.line} столбец ${i.column}: ${s.message}`;throw new xt([n])}try{return nc(r,t)}catch(s){throw s instanceof Error?new xt([s.message]):s}}function uc(e,t){let r;try{r=oc(e)}catch(s){throw s instanceof Error?new xt([s.message]):s}return hc(r,t)}function _r(e){return new Function("g","schema","memory",e)}const dc={[G.FLOAT]:"F",[G.STRING]:"S",[G.HANDLE]:"H",[G.COLORREF]:"C",[Oe.FLOAT_REF]:"G",[Oe.STRING_REF]:"T",[Oe.HANDLE_REF]:"I",[Oe.COLORREF_REF]:"D"};function fc(e){return e.map(t=>dc[t]).join("")}const Er=[];class gc{constructor(){this.m=new Map}addFunc(t,r){const s=r.a||Er,i=r.rest||Er,n=s.concat(i),l=t.toUpperCase();let a=this.m.get(l);if(!a)this.m.set(l,a=[]);else{const d=Ee-1;if(a.some(p=>{const _=p.argTypes.concat(p.type==="plugin"?p.restArgsTypes:Er);return _.length===n.length&&_.every((T,m)=>(T&d)===(n[m]&d))}))throw Error(`Функция '${t}' с аргументами '${s}' уже существует`)}const u="$"+t+(s.length?"$"+fc(n):"");return a.push({type:"plugin",path:u,argTypes:s,restArgsTypes:i,retType:r.r||null}),u}addUserFunc(t){const r=t.name.toUpperCase(),s=this.m.get(r);if(!s)return this.m.set(r,[t]),!0;const i=Ee-1;return s.some(n=>n.argTypes.length===t.argTypes.length&&n.argTypes.every((l,a)=>(l&i)===t.argTypes[a]))?!1:(s.push(t),!0)}compile(t,r,s){return uc(t,{funcTable:this.m,sourceURL:r,comment:s})}}class pc{constructor(t){if(this.pens=new Set,this.brushes=new Set,this.images=new Set,this.imagesOpaque=new Set,this.strings=new Set,this.fonts=new Set,this.texts=new Set,t)if(t.type==="group")for(const r of bs(t))r.type!=="group"&&this.add(r);else this.add(t)}add(t){switch(t.type){case"line":t.pen&&this.pens.add(t.pen),t.brush&&(this.add(t.brush),this.brushes.add(t.brush));break;case"imageView":(t.opaque?this.imagesOpaque:this.images).add(t.image);break;case"textView":this.add(t.text),this.texts.add(t.text);break;case"input":t.font&&this.fonts.add(t.font);break;case"brush":t.image&&this.imagesOpaque.add(t.image);break;case"text":t.parts.forEach(r=>{this.strings.add(r.string),this.fonts.add(r.font)});break;case"scene":t.background&&(this.add(t.background),this.brushes.add(t.background));break}return this}}function*bs(e,t){e.type==="group"&&(yield*e.descendants(t)),yield e}function*_c(e,t){for(const r of e)r.type==="group"&&(yield*r.descendants(t)),yield r}function Ec(e,t){const r=[],s=new pc,i=new WeakSet;let n=null;const l=Symbol.iterator in e?_c(e,!0):bs(e,!0);for(const a of l)n=a.scene,r.push(a.toJSON()),a.type!=="group"&&(s.add(a),i.add(a));return{pens:Array.from(s.pens,a=>a.toJSON()),brushes:Array.from(s.brushes,a=>a.toJSON()),images:Array.from(s.images,a=>a.toJSON()),imagesOpaque:Array.from(s.imagesOpaque,a=>a.toJSON()),strings:Array.from(s.strings,a=>a.toJSON()),fonts:Array.from(s.fonts,a=>a.toJSON()),texts:Array.from(s.texts,a=>a.toJSON()),objects:r,order:n?Wn(n.order,a=>i.has(a)&&a.key):[]}}function wc(e){return os(e.values(),t=>!t.parent)}function Rs(e,t,r){const{objects:s}=e.merge(t,r),i=wc(s);return i.length>1?e.group(i,{key:0}):i[0]}const mc={x:0,y:0,w:0,h:0};function ut(e){let t=1/0,r=1/0,s=-1/0,i=-1/0;for(const n of e)n.x<t&&(t=n.x),n.y<r&&(r=n.y),n.x+n.width>s&&(s=n.x+n.width),n.y+n.height>i&&(i=n.y+n.height);return t===1/0?mc:{x:t,y:r,w:s-t,h:i-r}}const te=cr,Pt={src:"library",mount:"library"};async function Tc({id:e,src:t,hash:r},s){let i;const n=e||t;try{i=await fetch(`${We(n)}/index.json${r?"?"+r:""}`,s)}catch(a){throw a instanceof Error?Error("Сервер библиотек не отвечает"):a}if(i.status===404)throw Error(`404: Библиотека '${n}' не существует`);const l=await i.json();if(!i.ok)throw Error(l.message||"Неизвестная ошибка");return l}function wr(e,t,r){t.forEach(({key:s,klass:i})=>{const n=r.get(i)?.image;if(!n||n.prior==="icon"||!n.scene?.data?.objects?.length)return;const l=e.objects.get(s);l?.type==="group"&&yc(l,n.scene.data,n.resizable)})}function yc(e,t,r,s){const{children:i}=e,n=i.length?i[0]:null,l=Rs(e.scene,t,s).set({x:e.x,y:e.y,attrib:e.attrib});if(n){const a=e.attrib|Ve;r?(n.set({attrib:a}),l.set({width:n.width,height:n.height})):n.set({attrib:a,width:1,height:1})}return e.set({children:i.concat(l)}),l}function bc(e){return(e.startsWith("#")?parseInt(e.slice(1)):parseInt(e))||0}function Os(e,t){switch(e){case G.FLOAT:{const r=parseFloat(t.replace(",","."));if(!isNaN(r))return r;const s=x[t.toUpperCase()];return typeof s=="number"?s:null}case G.HANDLE:return bc(t);case G.STRING:return t;case G.COLORREF:return vn(t)}}function Rc(e,t){switch(e){case G.FLOAT:return Vn(t).toString();case G.STRING:return t;case G.HANDLE:return"#"+t;case G.COLORREF:return In(t)}}class Oc{constructor(t,r){this.id=t,this.attrib=0,this.description="",this.defaultValue=null,this.inEquation=!1,this.parsed=null,this.name=r.name,this.type=r.type,this.set(r)}set({attrib:t=this.attrib,defaultValue:r=this.defaultValue,description:s=this.description,inEquation:i=this.inEquation}){return this.parsed=r!==null?Os(this.type,r):null,this.attrib=t,this.defaultValue=r,this.description=s,this.inEquation=i,this}}class Ms{constructor(t){this._disable=null,this._enable=null,this.orgx=null,this.orgy=null,this._hobject=null,this._objname=null,this._classname=null,this.msg=null,this.xpos=null,this.ypos=null,this.fwkeys=null,this.wvkey=null,this.repeat=null,this.scancode=null,this.nwidth=null,this.nheight=null,this._hspace=null,this._windowName=null,this.iditem=null,this.wnotifycode=null;const r=t?.map((s,i)=>[s.name.toUpperCase(),new Oc(i,s)]);if(this.list=r?.map(s=>s[1])??[],this.m=new Map(r),!!r)for(const[s,i]of r){const n=i.type,{FLOAT:l,STRING:a,HANDLE:u}=G;s==="_ENABLE"&&n===l?this._enable=i:s==="_DISABLE"&&n===l?this._disable=i:s==="MSG"&&n===l?this.msg=i:s==="_HOBJECT"&&n===u?this._hobject=i:s==="IDITEM"&&n===l?this.iditem=i:s==="WNOTIFYCODE"&&n===l?this.wnotifycode=i:s==="NWIDTH"&&n===l?this.nwidth=i:s==="NHEIGHT"&&n===l?this.nheight=i:s==="XPOS"&&n===l?this.xpos=i:s==="YPOS"&&n===l?this.ypos=i:s==="FWKEYS"&&n===l?this.fwkeys=i:s==="ORGX"&&n===l?this.orgx=i:s==="ORGY"&&n===l?this.orgy=i:s==="_OBJNAME"&&n===a?this._objname=i:s==="_CLASSNAME"&&n===a?this._classname=i:s==="WVKEY"&&n===l?this.wvkey=i:s==="REPEAT"&&n===l?this.repeat=i:s==="SCANCODE"&&n===l?this.scancode=i:s==="_HSPACE"&&n===u?this._hspace=i:s==="_WINDOWNAME"&&n===a&&(this._windowName=i)}}get(t){return this.m.get(t.toUpperCase())??null}}class Mc{constructor({compiler:t,data:r,file:s,id:i,modelGlobals:n}){this.onChildrenChanged=new Ne,this.main=null,this.defers=[],this.equations=[],this.transpiledCode=null,this.isCompiled=!1;const{name:l,transpiled:a,uniqid:u,uuid:d,vars:p}=r;this.id=i,this.compiler=t,this.modelGlobals=n,this.file=s,this.name=l,this.nameUC=l.toUpperCase(),this.vars=new Ms(p),this.transpiledCode=a??null,this.uniqid=u??0,this.uuid=d||"",this.children=r.children||[],this.connections=r.connections||[],this.scene=r.scene||null,this.image=r.image||null,this.modelText=r.modelText||"",this.isFunction=r.isFunction||!1}set({vars:t,children:r=this.children,connections:s=this.connections,scene:i=this.scene,image:n=this.image,modelText:l=this.modelText,isFunction:a=this.isFunction}){return t&&(this.vars=new Ms(t)),this.modelText!==l&&(this.isCompiled=!1),this.children!==r&&(this.children=r,this.onChildrenChanged.dispatch(r)),this.connections=s,this.scene=i,this.image=n,this.modelText=l,this.isFunction=a,this}compile(){if(this.isCompiled)return;this.isCompiled=!0;let t;if(this.transpiledCode)te.debugCompiler&&console.log(`Компиляция (кешировано) ${this.name} (${this.vars.list.length} переменных)`),t=this.transpiledCode,this.transpiledCode=null;else{const s=this.file.path.toString().slice(3);te.debugCompiler&&console.log(`Компиляция '${this.name}' ('${s}'): ${this.vars.list.length} переменных`);try{const i=this.compiler.compile(this.modelText,this.name,s);te.debugCompiler&&i.bugs.length&&console.warn(`${this.name}:
${i.bugs.map(([a])=>` -${a}`).join(`
`)}`);const n=this.vars,l=i.vars.map(a=>{const u=n.get(a.name);if(!u)return a;const{defaultValue:d,description:p}=u;return{...a,defaultValue:d,description:p}});this.set({vars:l,isFunction:i.isFunction}),t=i}catch(i){throw i instanceof xt?Error(`Ошибка компиляции '${this.name}' ('${s}'): '${i.message}'`):i}}const{modelGlobals:r}=this;this.main=t.mainText?_r(t.mainText).bind(null,r):null,this.defers=t.defersTexts?.map(s=>_r(s).bind(null,r))||[],this.equations=t.equationsTexts?.map(s=>_r(s).bind(null,r))||[]}getUserFunctionSignature(){const t=this.vars.list;return{type:"user",name:this.name,argTypes:t.filter(r=>r.attrib&x.VF_ARGUMENT).map(r=>r.type),retType:t.find(r=>r.attrib&x.VF_RETURN)?.type??null}}}class vc{constructor(){this.files=new WeakSet,this.m=new Map}add(t){const{nameUC:r}=t,s=this.m.get(r);if(s)throw Error(`Конфликт имен имиджей: '${t.name}' ('${t.file.path}') уже существует в файле '${s.file.path}'`);return this.m.set(r,t),this.files.add(t.file),this}get(t){return this.m.get(t.toUpperCase())??null}hasFile(t){return this.files.has(t)}unload(t){this.m.forEach(r=>r.id===t&&this.files.delete(r.file)),this.m=new Map(os(this.m,r=>r[1].id!==t))}}class Dt extends Error{constructor(t,r){super(t),this.original=r}}class Sc{constructor({newFloats:t,newInts:r,newStrings:s,oldFloats:i,oldInts:n,oldStrings:l}){this.newFloats=t,this.oldFloats=i,this.newInts=r,this.oldInts=n,this.newStrings=s,this.oldStrings=l}sync(){this.oldFloats.set(this.newFloats),this.oldInts.set(this.newInts);const{newStrings:t,oldStrings:r}=this;for(let s=0;s<t.length;++s)r[s]=t[s]}}class vs{constructor(){this.floatCnt=0,this.intCnt=0,this.strCnt=0}add(t){switch(t.type){case G.FLOAT:return this.floatCnt++;case G.HANDLE:case G.COLORREF:return this.intCnt++;case G.STRING:return this.strCnt++}}allocMemory(t){const r=new Float64Array(this.floatCnt),s=new Int32Array(this.intCnt),i=Array.from({length:this.strCnt},()=>"");return new Sc({newFloats:r,oldFloats:t?r:r.slice(),newInts:s,oldInts:t?s:s.slice(),newStrings:i,oldStrings:t?i:i.slice()})}}class Ss{constructor(t,r){this.v=t,this.a=r,this.index=-1,this.connected=new Set}propagateIndex(t){this.index>=0||(this.index=t,this.connected.forEach(r=>r.propagateIndex(t)))}connectWith(t){this.connected.add(t),t.connected.add(this)}getIndex(){return this.index<0&&this.propagateIndex(this.a.add(this.v)),this.index}}function Ac(e,t){const{children:r}=e;t.forEach(({nodes:[s,i],vars:n,attrib:l=0})=>{if(l&Co)return;let a=`Имидж ${e.klass.name}: связь #${s}-#${i}: `;const u=s>0?r.find(p=>p.ndata.key===s):e;if(!u){console.warn(a+`Дочерний имидж #${s} не существует`);return}const d=i>0?r.find(p=>p.ndata.key===i):e;if(!d){console.warn(a+`Дочерний имидж #${i} не существует`);return}a=`Имидж ${e.klass.name}: связь #${s} (${u.klass.name}) - #${i} (${d.klass.name}): `,n.forEach(([p,_])=>{const T=u.klass.vars.get(p);if(!T){console.warn(a+`Переменная ${u.klass.name}:${p} не существует`);return}const m=d.klass.vars.get(_);if(!m){console.warn(a+`Переменная ${d.klass.name}:${_} не существует`);return}if(T.type!==m.type){console.warn(a+`Типы переменных ${u.klass.name}:${p} и ${d.klass.name}:${_} не совпадают`);return}u.vars[T.id].connectWith(d.vars[m.id])})})}function As(e,t,r,s=null){e.compile();const i=e.vars.list.map(a=>new Ss(a,r)),n=e.children.map(a=>{const u=t.get(a.klass);if(!u)throw Error(`Подимидж ${a.klass} #${a.key} имиджа ${e.name} не существует`);return As(u,t,r,a)}),l={klass:e,ndata:s,vars:i,children:n};return e.connections.length&&Ac(l,e.connections),l}function Ns(e,t,r){const s=e.vars.map(n=>{const l=n.getIndex();return n.v.inEquation&&r.add(l),l}),i=e.children.map(n=>Ns(n,t,r));return t.createSchema({...e,varMap:s,children:i,prj:t})}function Nc(){return!1}function Ic(e,t){return e.values.newFloats[e.map[t]]>0}function xc(e,t){return e.values.newFloats[e.map[t]]<=0}class Pc{constructor({prj:t,klass:r,ndata:s,varMap:i,children:n}){this.isDisabled=Nc,this.updateChildNodeData=u=>{u.length===this.children.length&&u.forEach((d,p)=>{const _=this.children[p],T=_.ndata;T.key!==d.key||T.klass!==d.klass||(T.name&&this.resolveMap.delete(T.name),d.name&&this.resolveMap.set(d.name.toUpperCase(),_),_.ndata=d)})},this.prj=t,this.klass=r,this.ndata=s,this.map=i,this.children=n;const{_disable:l,_enable:a}=r.vars;l&&(!a||l.id<a.id)?this.isDisabled=Ic.bind(null,this,l.id):a&&(!l||a.id<l.id)&&(this.isDisabled=xc.bind(null,this,a.id)),this.resolveMap=new Map([["",this]]),n.forEach(u=>{u.resolveMap.set("..",this);const{key:d,name:p}=u.ndata;this.resolveMap.set("#"+d,u),p&&this.resolveMap.set(p.toUpperCase(),u)}),r.onChildrenChanged.add(this.updateChildNodeData)}get kernel(){return this.prj.kernel}get values(){return this.prj.memory}resolve(t){if(t.length===0)return this;const r=t.toUpperCase().split("\\");let s=t[0]==="\\"?this.prj.root:this;for(const i of r){const n=s.resolveMap.get(i);if(!n)return null;s=n}return s}resolveMany(t,r){if(t){const s=this.resolve(t);return!s||r&&s.klass!==r?[]:[s]}return r?this.prj.getKlassSchemas(r):[]}initValues(t){this.children.forEach(s=>s.initValues());const{vars:r}=this.klass;return r.list.forEach(s=>{let i;if(s.parsed!==null)i=s.parsed;else switch(s){case r.orgx:i=this.ndata?.x??0;break;case r.orgy:i=this.ndata?.y??0;break;case r._hobject:i=this.ndata?.key??0;break;case r._objname:i=this.ndata?.name??"";break;case r._classname:i=this.klass.name;break;default:if(!t)return;i=s.type===G.STRING?"":0;break}this.setVarValue(s,i)}),this}applyValues({values:t,klass:r,klassID:s,klassUUID:i,children:n}){const{uniqid:l,uuid:a}=this.klass;if(t?.length)if(a&&a===i||l&&l===s||r.toUpperCase()===this.klass.nameUC){const{vars:u}=this.klass;t.forEach(({name:d,value:p})=>{const _=u.get(d);if(!_)return;const T=Os(_.type,p);T!==null&&this.setVarValue(_,T)})}else console.warn(`Не удалось применить состояние к ${this.path()}: ожидалось ${r} (${s}), получен ${this.klass.name} (${l})`);return n?.forEach(u=>this.children.find(d=>d.ndata.key===u.key)?.applyValues(u)),this}getValues(){const{klass:t,ndata:r}=this,s=this.children.map(n=>n.getValues()),i=t.vars.list.map(n=>{const l=Rc(n.type,this.getVarValue(n));return{name:n.name,value:l}});return{key:r?.key??0,klass:t.name,klassID:t.uniqid,values:i,children:s}}computeAndPushVector(t,r,{a:s,b:i}){const{oldFloats:n,newFloats:l}=this.values;let a=!1;const u=t(this,this),d=r.map(p=>{l[p]=n[p]=1;const _=u-t(this,this);return l[p]=n[p]=0,_!==0&&(a=!0),_});a&&(s.push(d),i.push(u))}computeEquationVectors(t,r){this.children.forEach(s=>s.computeEquationVectors(t,r)),this.klass.equations.forEach(s=>this.computeAndPushVector(s,t,r))}computeSchemaDefers(){this.children.forEach(t=>!t.isDisabled()&&t.computeSchemaDefers()),this.klass.defers.forEach(t=>t(this,this))}computeSchema(){this.children.forEach(t=>!t.isDisabled()&&t.computeSchema()),te.debugExecution&&console.log(`Выполняется ${this.path()}`);try{this.klass.main?.(this,this)}catch(t){throw t instanceof Error?new Dt(`${this.path()}: ${t.message}`,t):t}return this}compute(t){if(!t&&this.isDisabled())return this;this.computeSchema();const{equationVars:r}=this.prj;return r.length&&this.prj.solveEquationsFor(r),this.computeSchemaDefers(),this.values.sync(),this}userFunction(t,r){const s=this.kernel.classes.get(t);if(!s)throw Error(`Функция не существует: ${t}`);if(!s.isFunction)throw Error(`Имидж ${t} существует, но не является функцией`);s.compile();const i=s.vars.list;if(r.length>i.length)throw Error(`${t}: ${r.length} аргументов, но функция имеет ${i.length} переменных`);const n=new vs,l={map:i.map(u=>new Ss(u,n).getIndex()),values:n.allocMemory(!0)};r.forEach((u,d)=>{const p=i[d];if(!this.setVarValue.call(l,p,u))throw Error(`Аргумент ${d} имеет тип ${typeof u}; ожидалось ${p.type}`)}),s.main?.(this,l);const a=i.find(u=>u.attrib&x.VF_RETURN);if(a)return this.getVarValue.call(l,a)}solveEquationsFor(t){this.prj.solveEquationsFor(t)}path(){if(this===this.prj.root)return this.klass.name;const t=[this];for(;;){const r=t[0].resolveMap.get("..");if(r===this.prj.root)break;t.unshift(r)}return t.map(r=>`${r.klass.name} (#${r.ndata.key})`).join(" - ")}getVarValue(t){const{newFloats:r,newInts:s,newStrings:i}=this.values,n=this.map[t.id];switch(t.type){case G.FLOAT:return r[n];case G.HANDLE:case G.COLORREF:return s[n];case G.STRING:return i[n]}}setVarValue(t,r){const{newFloats:s,oldFloats:i,newInts:n,oldInts:l,newStrings:a,oldStrings:u}=this.values,d=this.map[t.id];switch(t.type){case G.FLOAT:if(typeof r!="number")return!1;s[d]=i[d]=r;break;case G.HANDLE:case G.COLORREF:if(typeof r!="number")return!1;n[d]=l[d]=r;break;case G.STRING:if(typeof r!="string")return!1;a[d]=u[d]=r;break}return!0}setNewValue(t,r){const{newFloats:s,newInts:i,newStrings:n}=this.values,l=this.map[t.id];switch(t.type){case G.FLOAT:if(typeof r!="number")return!1;s[l]=r;break;case G.HANDLE:case G.COLORREF:if(typeof r!="number")return!1;i[l]=r;break;case G.STRING:if(typeof r!="string")return!1;n[l]=r;break}return!0}getVarValueFHC(t){const{newFloats:r,newInts:s}=this.values,i=this.map[t.id];switch(t.type){case G.FLOAT:return r[i];case G.HANDLE:case G.COLORREF:return s[i];default:return null}}getVarValueS(t){return t.type===G.STRING?this.values.newStrings[this.map[t.id]]:null}}class Dc{constructor({id:t,dir:r,rootKlass:s,state:i,kernel:n}){this.classTypes=new WeakMap,this.id=t,this.dir=r,this.kernel=n;const l=new Set,a=new vs,u=As(s,n.classes,a),d=this.root=Ns(u,this,l);this.memory=a.allocMemory(),d.initValues(),i&&d.applyValues(i),this.equationVars=Array.from(l)}createSchema(t){const r=new Pc(t),s=this.classTypes.get(r.klass);return s?s.push(r):this.classTypes.set(r.klass,[r]),r}getKlassSchemas(t){return this.classTypes.get(t)??[]}solveEquationsFor(t){const{oldFloats:r,newFloats:s}=this.memory,i=t.map(l=>{const a=r[l];return s[l]=r[l]=0,a}),n={a:[],b:[]};this.root.computeEquationVectors(t,n),t.forEach((l,a)=>r[l]=i[a]);try{const l=Gn(n);t.forEach((a,u)=>s[a]=l[u])}catch{t.forEach(a=>s[a]=0)}}}class kc{constructor(t){this.projectLoader=t,this.onProjectOpen=new Ne,this.onProjectClose=new Ne,this.afterCycle=new Ne,this.classes=new vc,this.pluginFunctions={},this.handlers={closed:new Set,error:new Set,shell:new Set,write:new Set,afterCycle:new Set},this.projects=[],this.compiler=new gc,this.pluginNames=[],this.optionalPlugins=[],this.prevProjects=[],this.paused=!1,this.showed=new Set}pause(){this.paused=!0}continue(){this.paused=!1}addProject({filepath:t,searchDirs:r,dir:s,stt:i,settings:n}){te.debugProject&&console.log(`Открывается ${t}`);const l=Symbol(t.toString());let a;try{n.plugins?.forEach(d=>{const p=this.optionalPlugins.find(({plugin:_})=>_.name===d);if(!p)throw Error(`Проект требует плагин '${d}'`);this.addPlugin(p.plugin,p.opts),te.debugProject&&console.log(`Загружен плагин '${d}'`)}),r.forEach(d=>{const p=!n.nonRecursive||d===this.projectLoader.stdlibDir;d.forEach(_=>{if(!_.cls||this.classes.hasFile(_))return;const T=new Mc({id:l,data:_.cls,file:_,compiler:this.compiler,modelGlobals:this.pluginFunctions});T.isFunction&&this.compiler.addUserFunc(T.getUserFunctionSignature()),this.classes.add(T)},p)});const u=this.classes.get(n.rootClass);if(!u)throw Error(`${t}: Корневой имидж ${n.rootClass} не существует.`);a=new Dc({kernel:this,id:l,filepath:t,dir:s,rootKlass:u,state:i})}catch(u){throw this.classes.unload(l),u}return this.setProjects(this.projects.concat(a)),this.onProjectOpen.dispatch(a),a}compute(){if(this.paused)return!0;if(this.prevProjects!==this.projects){const r=this.prevProjects.filter(s=>!this.projects.includes(s));this.prevProjects=this.projects,r.forEach(s=>{te.debugProject&&console.log(`Закрывается ${s.id.description}`),this.onProjectClose.dispatch(s),this.classes.unload(s.id)})}if(!this.projects.length)return!1;const t=this.projects[this.projects.length-1];try{t.root.compute(),this.afterCycle.dispatch()}catch(r){throw r instanceof Dt?new Dt(`Проект ${t.id.description}, ${r.message}`,r.original):r}return this.handlers.afterCycle.forEach(r=>r()),!0}setProjects(t){this.projects=t}log(t,r){te.logMessage&&console.info(r?`${r.path()}: ${t}`:t)}handleExe(t,r){const s=t.lastIndexOf(".exe"),i=s<0?t:t.substring(0,s);return this.handlers.shell.forEach(n=>n(i,"","",r??0)),!0}handleShell(t,r,s,i){return this.handlers.shell.forEach(n=>n(t,r,s,i)),!0}handleWrite(t,r,s){const i=t.path.toString();this.handlers.write.forEach(n=>n(i,r)),s&&Yr(new Blob([r],{type:"text/plain"}),t.path.basename())}addPlugin(t,r){this.pluginNames.includes(t.name)||(t.deps?.forEach(s=>{if(!this.pluginNames.includes(s))throw Error(`Плагин '${t.name}' зависит от '${s}'`)}),this.pluginNames.push(t.name),t.register((s,i,n)=>{const l=this.compiler.addFunc(s,i);this.pluginFunctions[l]=n}),t.setup?.(this,r))}addOptionalPlugin(t,r){this.optionalPlugins.push({plugin:t,opts:r})}_functionNotImplemented(t,r){if(this.showed.size===this.showed.add(t.toUpperCase()).size)return;const s=`${t} не реализована`;console.warn(r?`${r.path()}: ${s}`:s)}}class Lc{constructor(t,r,s){this.kernel=t,this.initial=r,this.diag={iterations:0,missingCommands:[]},this._status="closed",this.loop=null,this.speed="smooth",this.computer=new Fe(s)}loadPlugin(t,r){return this.kernel.addOptionalPlugin(t,r),this}set({speed:t=this.speed}){return this.speed=t,this}get status(){return this._status}play(){return this.loop?this:(this.kernel.addProject(this.initial),this.diag.iterations=0,this.loop=()=>{let t;try{t=this.kernel.compute()}catch(r){if(!(r instanceof Dt))throw r;console.error(r.original);const s=r.message;return this._status="error",this.kernel.handlers.error.forEach(i=>i(s)),!1}return t?++this.diag.iterations:(this.loop=null,this._status="closed",this.kernel.handlers.closed.forEach(r=>r())),t},this.computer.run(this.loop),this._status="playing",this)}close(){return this.computer.stop(),this._status==="error"?(this.kernel.setProjects([]),this.kernel.compute(),this.loop=null,this._status="closed"):(this.kernel.setProjects([]),this.loop?.()),this}pause(){return this.computer.running&&(this.computer.stop(),this._status="paused"),this}continue(){return!this.computer.running&&this.loop&&(this.computer.run(this.loop),this._status="playing"),this}step(){return!this.computer.running&&this.loop&&this.loop(),this}on(t,r){return this.kernel.handlers[t].add(r),this}off(t,r){const s=this.kernel.handlers[t];return r?s.delete(r):this.kernel.handlers[t].clear(),this}}const o=G.FLOAT,E=G.STRING,c=G.HANDLE,z=G.COLORREF,A=Oe.FLOAT_REF,ie=Oe.STRING_REF,Gc=Oe.HANDLE_REF;Oe.COLORREF_REF;const Bc=.752812499999996,Cc=1.3283520132835271,Uc=Date.now(),je=new Date(314159265358),Is=13.204656862745098;function mr(e,t){const r=e.toUpperCase(),s=r.includes("WS_CHILD"),i=r.includes("WS_BYSPACE"),n=r.includes("WS_POPUP"),l=r.includes("WS_NORESIZE"),a=r.includes("WS_AUTOORG"),u=r.includes("WS_SPACESIZE"),d=r.includes("WS_DIALOG"),p=r.includes("WS_NOCAPTION"),_=r.includes("WS_VSCROLL"),T=r.includes("WS_HSCROLL"),m=i?{...t}:{};return s&&(m.child=!0),T&&(m.hscroll=!0),_&&(m.vscroll=!0),u&&(m.size={type:"content"}),l&&(m.fixed=!0),n&&(m.popup=!0),a&&(m.autoorg=!0),d&&!p&&(m.showCloseButton=!0),m}function xs(e){const t=e.file()?.base64;return t?nr(Qr(t)):""}class Fc{constructor(t,r){this.key=t,this.fields=r??[]}insert(t){if(t==="FLOAT")return this.fields.push({type:t,value:0}),1;if(t==="HANDLE")return this.fields.push({type:t,value:0}),1;if(t==="STRING")return this.fields.push({type:t,value:""}),1;throw Error(`Неизвестный тип элемента: ${t}`)}insertClass(t,r){const s=r.map(i=>{const n=i[0].toUpperCase();switch(i[1]){case G.FLOAT:return[n,{type:"FLOAT",value:0}];case G.STRING:return[n,{type:"STRING",value:""}];default:return[n,{type:"HANDLE",value:0}]}});return this.fields.push({type:"STRUCT",realType:t,value:new Map(s)}),1}set(t,r,s){if(t<0||t>this.fields.length-1)return;let i=this.fields[t];if(i.type==="STRUCT"){const n=i.value.get(r.toUpperCase());if(!n)return;i=n}if(typeof s=="string"){if(i.type!=="STRING")return;i.value=s}else{if(i.type==="STRING")return;i.value=s}}remove(t){return this.fields.splice(t,1).length?1:0}count(){return this.fields.length}type(t){if(t<0||t>this.fields.length-1)return"";const r=this.fields[t];return r.type==="STRUCT"?r.realType:r.type}getFloat(t,r){if(t<0||t>this.fields.length-1)return 0;let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return 0;s=i}return s.type==="FLOAT"?s.value:0}getHandle(t,r){if(t<0||t>this.fields.length-1)return 0;let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return 0;s=i}return s.type==="HANDLE"?s.value:0}getString(t,r){if(t<0||t>this.fields.length-1)return"";let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return"";s=i}return s.type==="STRING"?s.value:""}sort(t){if(!t?.length)return this.fields.sort((r,s)=>r.value-s.value),1;if(t.length===1)return t[0].desc?this.fields.sort((r,s)=>s.value-r.value):this.fields.sort((r,s)=>r.value-s.value),1;throw console.log(t),Error("VSort: сортировка по нескольким полям не реализована")}}function Wc(e,t){const r=ue.freeKey(e),s=new Fc(r,t);return e.set(r,s),s}function Vc(){return this.kernel.createArray().key}function $c(e){this.kernel.arrays.delete(e)}function jc(e){return this.kernel.arrays.get(e)?.count()??0}function Hc(e,t){return this.kernel.arrays.get(e)?.type(t)??""}function Xc(e,t){const r=this.kernel.arrays.get(e);if(!r)return 0;const s=t.toUpperCase();if(s==="STRING"||s==="FLOAT"||s==="HANDLE")return r.insert(s);const i=this.kernel.classes.get(t);if(!i)return 0;const n=i.vars.list.map(l=>[l.name,l.type]);return r.insertClass(i.name,n)}function Yc(e,t){return this.kernel.arrays.get(e)?.remove(t)??0}function zc(){return this.kernel.arrays.clear(),1}function qc(e,t,r){return this.kernel.arrays.get(e)?.getString(Math.floor(t),r)??""}function Kc(e,t,r){return this.kernel.arrays.get(e)?.getHandle(Math.floor(t),r)??0}function Zc(e,t,r){return this.kernel.arrays.get(e)?.getFloat(Math.floor(t),r)??0}function Tr(e,t,r,s){this.kernel.arrays.get(e)?.set(t,r,s)}function Jc(e,...t){const r=this.kernel.arrays.get(e);return r?r.sort(t.map(s=>({desc:!1,field:s}))):0}function Qc(e,t,...r){const s=this.kernel.arrays.get(e);if(!s)return 0;const i=!!t;return s.sort(r.map(n=>({desc:i,field:n})))}function el(e,...t){const r=this.kernel.arrays.get(e);if(!r)return 0;const s=[];for(let i=0;i<t.length;i+=2){const n=t[i],l=!!t[i+1];s.push({desc:l,field:n})}return r.sort(s)}function tl(e){e("New",{r:c},Vc),e("Delete",{a:[c]},$c),e("VGetCount",{a:[c],r:o},jc),e("VGetType",{a:[c,o],r:E},Hc),e("VInsert",{a:[c,E],r:o},Xc),e("VDelete",{a:[c,o],r:o},Yc),e("VClearAll",{},zc),e("VGetS",{a:[c,o,E],r:E},qc),e("VGetH",{a:[c,o,E],r:c},Kc),e("VGetF",{a:[c,o,E],r:o},Zc),e("VSet",{a:[c,o,E,o]},Tr),e("VSet",{a:[c,o,E,E]},Tr),e("VSet",{a:[c,o,E,c]},Tr),e("VSort",{a:[c],rest:[E],r:o},Jc),e("VSort",{a:[c,o],rest:[E],r:o},Qc),e("VSort",{a:[c],rest:[E,o],r:o},el)}const rl={name:"arrays",register:tl,setup(e){const t=new Map;e.arrays=t,e.createArray=Wc.bind(null,t)}},Ps=new Set;function de(...e){Ps.size!==Ps.add(e[0]).size&&console.warn(...e)}function sl(e){throw de("AudioGetBalance",e),Error("Not implemented")}function il(e){throw de("AudioGetLength",e),Error("Not implemented")}function nl(e){throw de("AudioGetPosition",e),Error("Not implemented")}function ol(e){throw de("AudioGetRepeat",e),Error("Not implemented")}function cl(e){throw de("AudioGetTone",e),Error("Not implemented")}function ll(e){throw de("AudioGetVolume",e),Error("Not implemented")}function al(e){const t=this.kernel.audios.get(e);return t&&!t.paused?1:0}function hl(e){throw de("AudioIsSeekable",e),Error("Not implemented")}function ul(e){const t=this.prj.dir.resolve(e).file()?.audio;if(!t)return 0;const r=new Audio(We(t.src)),s=ue.freeKey(this.kernel.audios);return this.kernel.audios.set(s,r),s}function dl(e){this.kernel.audios.get(e)?.play()}function fl(e){de("AudioReset",e)}function gl(e,t){de("AudioSetBalance",e,t)}function pl(e,t){de("AudioSetPosition",e,t)}function _l(e,t){de("AudioSetRepeat",e,t)}function El(e,t){de("AudioSetTone",e,t)}function wl(e,t){de("AudioSetVolume",e,t)}function ml(e){this.kernel.audios.get(e)?.pause()}function Tl(e){e("AudioGetBalance",{a:[c],r:o},sl),e("AudioGetLength",{a:[c],r:o},il),e("AudioGetPosition",{a:[c],r:o},nl),e("AudioGetRepeat",{a:[c],r:o},ol),e("AudioGetTone",{a:[c],r:o},cl),e("AudioGetVolume",{a:[c],r:o},ll),e("AudioIsPlaying",{a:[c],r:o},al),e("AudioIsSeekable",{a:[c],r:o},hl),e("AudioOpenSound",{a:[E],r:c},ul),e("AudioPlay",{a:[c]},dl),e("AudioReset",{a:[c]},fl),e("AudioSetBalance",{a:[c,o]},gl),e("AudioSetPosition",{a:[c,o]},pl),e("AudioSetRepeat",{a:[c,o]},_l),e("AudioSetTone",{a:[c,o]},El),e("AudioSetVolume",{a:[c,o]},wl),e("AudioStop",{a:[c]},ml)}const yl={name:"audio",register:Tl,setup(e){e.audios=new Map}};function bl(e){return this.resolve(e)?.klass.name??""}function Ds(...e){throw console.warn("createLink",...e),Error("Not implemented")}function Rl(...e){throw console.warn("createObject",...e),Error("Not implemented")}function Ol(){throw Error("Not implemented")}function Ml(...e){throw console.warn("setLinkVars",...e),Error("Not implemented")}function vl(e){return this.kernel.classes.get(e)?.children.length??0}function Sl(){return this.ndata?.key??0}function Al(e){return this.resolve(e)?.ndata?.key??0}function Nl(e,t){if(t<0)return 0;const r=this.kernel.classes.get(e)?.children;return r&&t<r.length?r[t].key:0}function Il(e,t){return this.kernel.classes.get(e)?.children.find(r=>r.key===t)?.klass??""}function xl(e,t,r){return this.kernel.classes.get(e)?.connections.find(({nodes:[s,i]})=>s===t&&i===r||s===r&&i===t)?.key??0}function Pl(e,t){const r=this.kernel.classes.get(e)?.modelText;if(!r)return 0;const s=this.kernel.streams.get(t);if(!s)return 0;const i=es(r);return s.write(i),i.length}function ks(e,t){const r=this.kernel.classes.get(e);if(!r)return 0;const s=this.kernel.streams.get(t)?.buffer();if(!s)return 0;const i=nr(new Uint8Array(s)),n=r.modelText;r.set({modelText:i});try{r.compile()}catch(l){if(!(l instanceof Error))throw l;return console.warn(l.message),r.set({modelText:n}),0}return 1}function Dl(e,t){const r=this.resolve(e);if(!r)return"";const s=r.klass.vars.get(t);return s?r.getVarValueS(s)??"":""}function yr(e,t){const r=this.resolve(e);if(!r)return 0;const s=r.klass.vars.get(t);return s?r.getVarValueFHC(s)??0:0}function kt(e,t,r){const s=this.resolve(e);if(!s)return;const i=s.klass.vars.get(t);i&&s.setVarValue(i,r)}function Ls(e,t,r,s,i,n,l,a,u,d,p,_){const T=this.kernel.classes.get(e)?.vars.list;if(t<0||!T||t>=T.length)return r[s]="",i[n]="",l[a]="",u[d]="",p&&(p[_]=0),0;const m=T[t];return r[s]=m.name,i[n]=G[m.type],l[a]=m.defaultValue??"",u[d]=m.description??"",p&&(p[_]=m.attrib),1}function kl(e){return this.kernel.classes.get(e)?.vars.list.length??0}function Ll(e,t,r){const s=this.kernel.classes.get(e);if(!s)return 0;const i=s.children.findIndex(l=>l.key===t);if(i<0)return 0;const n=s.children.slice();return n[i]={...n[i],name:r},s.set({children:n}),1}function Gl(e,t){return this.kernel.classes.get(e)?.children.find(r=>r.key===t)?.name??""}function Bl(e,t){const r=this.resolve(e);if(!r)return 0;const s=this.prj.dir.resolve(t).file();if(!s)return 0;const i=r.getValues();return s.set({stt:i}),1}function Cl(e,t){const r=this.resolve(e);if(!r)return 0;const s=this.prj.dir.resolve(t).file()?.stt;return s?(r.applyValues(s),1):0}function Ul(e){return this.resolve(e)?.initValues(!0)?1:0}function Fl(){this.kernel._functionNotImplemented("Stop",this)}function Wl(e){e<=0||this.kernel.setProjects([])}function Vl(){this.kernel.setProjects(cs(this.kernel.projects,this.prj))}function $l(e){e("GetClassName",{a:[E],r:E},bl),e("CreateLink",{a:[E,c,c],r:c},Ds),e("CreateLink",{a:[E,E,E],r:c},Ds),e("CreateObject",{a:[E,E,E,o,o],r:c},Rl),e("DeleteObject",{a:[E,c,o],r:o},Ol),e("SetLinkVars",{a:[E,c,E],r:o},Ml),e("GetObjectCount",{a:[E],r:o},vl),e("GetHObject",{r:c},Sl),e("GetHObjectByName",{a:[E],r:c},Al),e("GetHObjectByNum",{a:[E,o],r:c},Nl),e("GetObjectClass",{a:[E,c],r:E},Il),e("GetLink",{a:[E,c,c],r:c},xl),e("GetModelText",{a:[E,c],r:o},Pl),e("SetModelText",{a:[E,c],r:o},ks),e("SetModelText",{a:[E,c,o],r:o},ks),e("GetVarS",{a:[E,E],r:E},Dl),e("GetVarF",{a:[E,E],r:o},yr),e("GetVarH",{a:[E,E],r:c},yr),e("GetVarC",{a:[E,E],r:z},yr),e("SetVar",{a:[E,E,o]},kt),e("SetVar",{a:[E,E,E]},kt),e("SetVar",{a:[E,E,c]},kt),e("SetVar",{a:[E,E,z]},kt),e("GetVarInfo",{a:[E,o,ie,ie,ie,ie],r:o},Ls),e("GetVarInfo",{a:[E,o,ie,ie,ie,ie,A],r:o},Ls),e("GetVarCount",{a:[E],r:o},kl),e("SetObjectName",{a:[E,c,E],r:o},Ll),e("GetNameByHandle",{a:[E,c],r:E},Gl),e("SaveObjectState",{a:[E,E],r:o},Bl),e("LoadObjectState",{a:[E,E],r:o},Cl),e("SetVarsToDefault",{a:[E],r:o},Ul),e("Stop",{a:[o]},Fl),e("Quit",{a:[o]},Wl),e("CloseAll",{},Vl)}const jl={name:"class",deps:["streams"],register:$l};function Hl(e,t,r,s,i,n,l,a){let u;switch(t.toUpperCase()){case"EDIT":u="Edit";break;case"BUTTON":u="Button";break;case"COMBOBOX":u="ComboBox";break;case"LISTBOX":u="ListBox";break;default:return 0}const d=this.kernel.scenes.get(e);if(!d)return 0;const p=d.scene;let _=i,T=n;const m=d.matrix;if(m){const N=i*m[2]+n*m[5]+m[8];_=(i*m[0]+n*m[3]+m[6])/N,T=(i*m[1]+n*m[4]+m[7])/N}const R=p.input(u,{x:_,y:T,width:l,height:a,value:r,style:s});return p.set({order:p.order.concat(R)}),R.key}function Gs(e,t,r,s){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(i?.type!=="input")return"";const{value:n}=i;return typeof r>"u"?n:n.slice(r,r+s)}function Xl(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="input"&&s.set({value:r})?1:0}function Yl(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="input"&&i.set({font:s.fonts.get(r)??null})?1:0}function zl(){return this.kernel._functionNotImplemented("EnableControl2d"),0}function ql(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return;const s=r.objects.get(t);s?.type==="input"&&s._html.focus()}function Kl(){return this.kernel._functionNotImplemented("IsDlgButtonChecked"),0}function Zl(){return this.kernel._functionNotImplemented("CheckDlgButton2d"),1}function Jl(e){e("CreateControlObject2d",{a:[c,E,E,o,o,o,o,o,o],r:c},Hl),e("GetControlText2d",{a:[c,c],r:E},Gs),e("GetControlText2d",{a:[c,c,o,o],r:E},Gs),e("SetControlText2d",{a:[c,c,E],r:o},Xl),e("SetControlFont2d",{a:[c,c,c],r:o},Yl),e("EnableControl2d",{a:[c,c,o],r:o},zl),e("SetControlFocus2d",{a:[c,c]},ql),e("IsDlgButtonChecked2d",{a:[c,c],r:o},Kl),e("CheckDlgButton2d",{a:[c,c,o],r:o},Zl)}const Ql={name:"controls",deps:["windows"],register:Jl},pe={"dialog-overlay":"Zvmz0cJJ",active:"_6pvXMwET",dialog:"_8OpWP1FD","file-row":"-RCrm1Nm","file-name":"GMXl88rY","btn-row":"_95llu-Ce",btn:"wpDiowrl",secondary:"uxkYldVD"};class ea{constructor(t){this.file=null,this.onConfirm=new Ne,this.onCancel=new Ne,this.overlay=document.createElement("div"),this.overlay.className=pe["dialog-overlay"];const r=document.createElement("div");r.className=pe.dialog,r.innerHTML=`
      <header>
        <h2>Выбор файла</h2>
      </header>
      <div class="${pe["file-row"]}">
        <div class="${pe["file-name"]}">Файл не выбран</div>
        <label class="${pe.btn}" style="position:relative; overflow:hidden;">
          <input type="file"readonly >
          Выбрать файл
        </label>
      </div>
      <div class="${pe["btn-row"]}">
        <button data-confirm class="${pe.btn}" disabled>Ок</button>
        <button data-cancel class="${pe.btn} ${pe.secondary}">Отмена</button>
      </div>
    `,this.overlay.appendChild(r),t.appendChild(this.overlay),this.fileInput=r.querySelector('input[type="file"]'),this.fileNameDiv=r.querySelector(`.${pe["file-name"]}`),this.confirmBtn=r.querySelector("[data-confirm]"),this.cancelBtn=r.querySelector("[data-cancel]"),this.fileInput.addEventListener("change",()=>{const s=this.fileInput.files?.[0]||null;this.file=s,s?(this.fileNameDiv.textContent=s.name,this.confirmBtn.disabled=!1):(this.fileNameDiv.textContent="Файл не выбран",this.confirmBtn.disabled=!0)}),this.cancelBtn.addEventListener("click",()=>{this.close(),this.onCancel.dispatch(),this.file=null}),this.confirmBtn.addEventListener("click",()=>{this.file&&(this.close(),this.onConfirm.dispatch(this.file),this.file=null)})}open(){this.overlay.parentElement?.appendChild(this.overlay),this.overlay.classList.add(pe.active)}close(){this.overlay.classList.remove(pe.active),this.fileInput.value="",this.fileNameDiv.textContent="Файл не выбран",this.confirmBtn.disabled=!0}get element(){return this.overlay}}class ta{constructor(){this.state={status:"idle"}}openDialog(){if(this.state.status==="shouldOpen"){if(te.throwIfFileLoadDialogCalledTwice)throw Error("fileLoadDialog уже был вызван в текущем цикле");return}this.state={status:"shouldOpen"}}setDialogResult(t){this.state={status:"picked",data:t}}reset(){this.state={status:"idle"}}}let ra=0;function sa(){const e=this.kernel.fileLoadDialogController;if(e.state.status!=="picked")return e.openDialog(),"?";const t=e.state.data;if(e.reset(),!t)return"";const r=this.prj.dir.resolve(`D://temp/file${++ra}`);return this.kernel.tempFileController.addFile(r,t),r.toString()}function ia(e,t,r){const s=this.prj.dir.resolve(r||"data.txt");return this.kernel.tempFileController.addFilepathForSave(s),s.toString()}function na(e){e("FileSaveDialog",{a:[E,E,E],r:E},ia),e("FileLoadDialog",{a:[E,E,E],r:E},sa)}const oa={name:"dialogs",deps:["streams","windows"],register:na,setup(e){e.fileLoadDialogController=new ta,e.selectFileDialog=new ea(e.windowSystem.windowFactory.root),e.afterCycle.add(()=>{if(e.fileLoadDialogController.state.status!=="shouldOpen")return;e.pause(),e.selectFileDialog.open();async function t(s){e.selectFileDialog.onConfirm.remove(t),e.selectFileDialog.onCancel.remove(r);try{if(s.type.startsWith("image/")){const i=URL.createObjectURL(s),n=await On(i),{naturalWidth:l,naturalHeight:a}=n;e.fileLoadDialogController.setDialogResult({file:s,content:{image:{width:l,height:a,src:i}}})}else{const i=await s.arrayBuffer(),n=Jr(new Uint8Array(i));e.fileLoadDialogController.setDialogResult({file:s,content:{base64:n}})}}finally{e.continue()}}function r(){e.selectFileDialog.onConfirm.remove(t),e.selectFileDialog.onCancel.remove(r),e.fileLoadDialogController.setDialogResult(null),e.continue()}e.selectFileDialog.onConfirm.addOnce(t),e.selectFileDialog.onCancel.addOnce(r)})}};function ca(e){return this.prj.dir.resolve(e).create("folder")?1:0}function la(e){const t=this.prj.dir.resolve(e);return t.file()||this.kernel.projectLoader.exists(t)?1:0}function aa(e){const t=this.kernel.classes.get(e);return t?t.file.path.resolve("..").toString()+"\\":""}function ha(){return this.prj.dir.toString()}function ua(){return"C:\\Windows"}function da(e){const t=this.prj.dir.resolve(e).resolveMany();if(!t.length)return 0;const r=t.map(s=>{const i=[["NAME",{type:"STRING",value:s.name}],["SIZE",{type:"FLOAT",value:s.size}],["ATTR",{type:"FLOAT",value:0}],["YEAR",{type:"FLOAT",value:je.getFullYear()}],["MONTH",{type:"FLOAT",value:je.getMonth()+1}],["DAY",{type:"FLOAT",value:je.getDate()}],["DAYOFWEEK",{type:"FLOAT",value:je.getDay()}],["HOUR",{type:"FLOAT",value:je.getHours()}],["MINUTE",{type:"FLOAT",value:je.getMinutes()}],["SECOND",{type:"FLOAT",value:je.getSeconds()}]];return{type:"STRUCT",realType:"FILE_ATTRIBUTE",value:new Map(i)}});return this.kernel.createArray(r).key}function fa(e){return e.length===0||e[e.length-1]==="\\"?e:e+"\\"}function ga(e){e("CreateDir",{a:[E],r:o},ca),e("FileExist",{a:[E],r:o},la),e("GetClassDirectory",{a:[E],r:E},aa),e("GetProjectDirectory",{r:E},ha),e("GetWindowsDirectory",{r:E},ua),e("GetFileList",{a:[E,o],r:c},da),e("AddSlash",{a:[E],r:E},fa)}const pa={name:"filesystem",deps:["arrays"],register:ga};function _a(e){const t=this.kernel.scenes.get(e);return t?t.scene.x:0}function Ea(e){const t=this.kernel.scenes.get(e);return t?t.scene.y:0}function wa(e,t,r){const s=this.kernel.scenes.get(e);return s?(s.setOrg(t,r),1):0}function ma(e){return this.kernel.scenes.get(e)?.window.scale??0}function Ta(e,t){return this.kernel.scenes.get(e)?.window.set({scale:t})?1:0}function ya(e,t,r,s,i,n,l){const a=this.kernel.scenes.get(e)?.scene.toBlob({x:s,y:i,w:n,h:l});if(!a)return 0;const u=t.match(/(?:.*[\\/])?(.+?)(\..*)?$/),d=u&&u.length>1?u[1]:"Screenshot";return a.then(p=>Yr(p,d)),1}function ba(e){return this.kernel.scenes.get(e)?.scene.background?.key??0}function Ra(e,t){const r=this.kernel.scenes.get(e)?.scene;return r?.set({background:r.brushes.get(t)??null})?1:0}function Oa(){return 0}function Ma(e){return this.kernel.scenes.get(e)?.scene.hiddenLayers??0}function va(e,t){return this.kernel.scenes.get(e)?.scene.set({hiddenLayers:t})?1:0}function Sa(){return 1}function Aa(e,t,r,s,i){return this.kernel.scenes.get(e)?.scene.pen({color:s,rop:i,style:t,width:r}).key??0}function Na(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.color??0}function Ia(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.rop??0}function xa(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.style??0}function Pa(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.width??0}function Da(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({color:r})?1:0}function ka(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({rop:r})?1:0}function La(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({style:r})?1:0}function Ga(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({width:r})?1:0}function Ba(e,t,r,s,i,n){const l=this.kernel.scenes.get(e)?.scene;return l?.brush({color:s,hatch:r,rop:n,style:t,image:l.imagesOpaque.get(i)}).key??0}function Ca(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.color??0}function Ua(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.rop??0}function Fa(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.style??0}function Wa(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.hatch??0}function Va(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.image?.key??0}function $a(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({color:r})?1:0}function ja(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({rop:r})?1:0}function Ha(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({style:r})?1:0}function Xa(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({hatch:r})?1:0}function Ya(e,t,r){const s=this.kernel.scenes.get(e)?.scene;return s?.brushes.get(t)?.set({image:s.imagesOpaque.get(r)??null})?1:0}function Bs({kernel:e},t,r,s,i){return e.scenes.get(t)?.scene.font({name:r,size:s,style:i}).key??0}function za(e,t,r,s){return Bs(this,e,t,r,s)}function qa(e,t,r,s){return Bs(this,e,t,r*Cc,s)}function Ka(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.name??""}function Za(e,t){return(this.kernel.scenes.get(e)?.scene.fonts.get(t)?.size??0)*Bc}function Ja(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.style??0}function Qa(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({name:r})?1:0}function eh(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({size:r})?1:0}function th(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({style:r})?1:0}function rh(e,t){return this.kernel.scenes.get(e)?.scene.string(t).key??0}function sh(e,t){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.text??""}function ih(e,t,r){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.set({text:r})?1:0}function nh(e,t,r,s,i){const n=this.kernel.scenes.get(e)?.scene;if(!n)return 0;const l=n.strings.get(r);if(!l)return 0;const a=n.fonts.get(t);return a?n.text([{string:l,font:a,fgcolor:s,bgcolor:i}]).key:0}function oh(e,t){return this.kernel.scenes.get(e)?.scene.texts.get(t)?.parts.length??0}function Ke({kernel:e},t,r,s){if(s<0)return null;const i=e.scenes.get(t)?.scene.texts.get(r)?.parts;return i&&s<i.length?i[s]:null}function Cs(e,t,r=0){return Ke(this,e,t,r)?.font.key??0}function Us(e,t,r=0){return Ke(this,e,t,r)?.string.key??0}function Fs(e,t,r=0){return Ke(this,e,t,r)?.fgcolor??0}function Ws(e,t,r=0){return Ke(this,e,t,r)?.bgcolor??0}function Vs(e,t,r,s,i,n,l){if(r<0)return 0;const a=this.kernel.scenes.get(e)?.scene;if(!a)return 0;const u=a.texts.get(t)?.parts;return!u||r>=u.length?0:(u[r].set({string:a.strings.get(i),font:a.fonts.get(s),fgcolor:n,bgcolor:l}),1)}function ch(e,t,r,s,i,n){return Vs.call(this,e,t,0,r,s,i,n)}function lh(e,t,r,s){if(r<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||r>=n.length)return 0;const l=i.fonts.get(s);return l?(n[r].set({font:l}),1):0}function ah(e,t,r,s){if(r<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||r>=n.length)return 0;const l=i.strings.get(s);return l?(n[r].set({string:l}),1):0}function hh(e,t,r,s){return Ke(this,e,t,r)?.set({fgcolor:s})?1:0}function uh(e,t,r,s){return Ke(this,e,t,r)?.set({bgcolor:s})?1:0}function $s(e,t,r,s,i,n,l){if(r<0)return 0;const a=this.kernel.scenes.get(e)?.scene;if(!a)return 0;const u=a.texts.get(t);if(!u)return 0;const d=a.fonts.get(s);if(!d)return 0;const p=a.strings.get(i);if(!p)return 0;const _=r<u.parts.length,T=u.part({font:d,string:p,fgcolor:n,bgcolor:l},_);if(_){const m=u.parts.slice();m.splice(r,0,T),u.set({parts:m})}return 1}function dh(e,t,r,s,i,n){return $s.call(this,e,t,1/0,r,s,i,n)}function fh(e,t,r){if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.texts.get(t);if(!i||r>=i.parts.length)return 0;const n=i.parts.slice();return n.splice(r,1),i.set({parts:n},!0),1}function js({kernel:e},{prj:t},r,s,i){const n=e.scenes.get(r)?.scene;if(!n)return 0;const l=t.dir.resolve(s),a=e.tempFileController.getTempFile(l)?.content;let u;if(a){if(!a.image)return te.debugFile&&console.warn(`create(Double)DIB2d: Загруженный файл ${l} существует, но формат не image.`),0;u=a.image}else{const d=l.file();if(!d)return 0;if(!d.image)return te.debugFile&&console.warn(`create(Double)DIB2d: Файл ${l} существует, но формат не image.`),0;u=d.image}return n.image(u,{opaque:i}).key}function gh(e,t){return js(this,this,e,t,!0)}function ph(e,t){return js(this,this,e,t)}function _h(e,t,r,s){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.pixel(r,s)??0}function Eh(e,t,r,s,i){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.setPixel(r,s,i)?1:0}function wh(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case x.PEN2D:i=s.pens;break;case x.BRUSH2D:i=s.brushes;break;case x.DOUBLEDIB2D:i=s.images;break;case x.DIB2D:i=s.imagesOpaque;break;case x.STRING2D:i=s.strings;break;case x.FONT2D:i=s.fonts;break;case x.TEXT2D:i=s.texts;break;case x.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(r)?.delete(!0)?1:0}function mh(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case x.PEN2D:i=s.pens;break;case x.BRUSH2D:i=s.brushes;break;case x.DOUBLEDIB2D:i=s.images;break;case x.DIB2D:i=s.imagesOpaque;break;case x.STRING2D:i=s.strings;break;case x.FONT2D:i=s.fonts;break;case x.TEXT2D:i=s.texts;break;case x.SPACE3D:throw Error("Не реализовано");default:return 0}let n=1/0;for(const l of i.keys())l>r&&l<n&&(n=l);return n===1/0?0:n}function Th(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case x.PEN2D:i=s.pens;break;case x.BRUSH2D:i=s.brushes;break;case x.DOUBLEDIB2D:i=s.images;break;case x.DIB2D:i=s.imagesOpaque;break;case x.STRING2D:i=s.strings;break;case x.FONT2D:i=s.fonts;break;case x.TEXT2D:i=s.texts;break;case x.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(r)?.subs.size??0}function yh(e,t,r){return Kr(e,t,r)}function bh(e,t,r,s){return Kr(e,t,r,s===1?"transparent":s===2?"syscolor":"rgb")}function Rh(e){return e&4294967295}function Oh(e){return Sn(e)}function Mh(e){return An(e)}function vh(e){return Nn(e)}function Sh(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const l=this.prj.dir.resolve(t).file()?.scene?.data;return l?n.paste(l,r,s,i)?.key??0:0}function Ah(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.delete(!0)?1:0}function Nh(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":return x.OTGROUP2D;case"line":return x.OTLINE_2D;case"imageView":return r.opaque?x.OTBITMAP_2D:x.OTDOUBLEBITMAP_2D;case"textView":return x.OTTEXT_2D;case"videoView":return 0;case"input":return 26}}function Ih(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.data?.name??""}function xh(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?(s.data.name=r,1):0}function Ph(e,t,r){if(!r)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;if(t){const n=s.objects.get(t);if(!n)return 0;if(n.data?.name===r)return n.key;if(n.type!=="group")return 0;i=n.descendants()}else i=s.objects.values();for(const n of i)if(n.data?.name===r)return n.key;return 0}function Dh(e,t){const r=this.kernel.scenes.get(e);if(!r)return 0;const s=r.scene.objects.get(t);if(!s)return 0;const i=r.invmatrix;if(!i)return s.x;const n=s.x,l=s.y,a=n*i[2]+l*i[5]+i[8];return(n*i[0]+l*i[3]+i[6])/a}function kh(e,t){const r=this.kernel.scenes.get(e);if(!r)return 0;const s=r.scene.objects.get(t);if(!s)return 0;const i=r.invmatrix;if(!i)return s.y;const n=s.x,l=s.y,a=n*i[2]+l*i[5]+i[8];return(n*i[1]+l*i[4]+i[7])/a}function Lh(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)return 0;const n=i.scene.objects.get(t);if(!n)return 0;let l=r,a=s;const u=i.matrix;if(u){const d=r*u[2]+s*u[5]+u[8];l=(r*u[0]+s*u[3]+u[6])/d,a=(r*u[1]+s*u[4]+u[7])/d}return n.set({x:l,y:a}),1}function Gh(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.width??0}function Bh(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.height??0}function Ch(e,t,r,s){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.set({width:r,height:s})?1:0}function Uh(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":case"line":case"input":return r.width;case"imageView":return r.image.width;case"textView":return r.text.width;case"videoView":return r.video.width}}function Fh(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":case"line":case"input":return r.height;case"imageView":return r.image.height;case"textView":return r.text.height;case"videoView":return r.video.height}}function Wh(e,t,r,s,i,n){const l=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!l)return r[s]=0,i[n]=0,0;switch(l.type){case"group":case"line":case"input":return r[s]=l.width,i[n]=l.height,1;case"imageView":return r[s]=l.image.width,i[n]=l.image.height,1;case"textView":return r[s]=l.text.width,i[n]=l.text.height,1;case"videoView":return r[s]=l.video.width,i[n]=l.video.height,1}}function Vh(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r&&(r.type==="textView"||r.type==="imageView")?r.angle:0}function $h(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const l=n.scene.objects.get(t);if(!l)return 0;let a=r,u=s;const d=n.matrix;if(d){const p=r*d[2]+s*d[5]+d[8];a=(r*d[0]+s*d[3]+d[6])/p,u=(r*d[1]+s*d[4]+d[7])/p}return l.rotate(i,{x:a,y:u}),1}function br({kernel:e},t,r,s){const i=e.scenes.get(t)?.scene.objects.get(r);if(!i)return 0;const n=s?i.attrib&-2:i.attrib|1;return i.set({attrib:n}),1}function jh(e,t,r){return br(this,e,t,!!r)}function Hh(e,t){br(this,e,t,!0)}function Xh(e,t){br(this,e,t,!1)}function Yh(e,t,r){return this.kernel.scenes.get(e)?.pick(t,r,!0)?.key??0}function zh(){return this.kernel.windowSystem.lastPickedPrimaryKey}function qh(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?(this.kernel.windowSystem.clipboard=Ec(r),1):0}function Kh(e,t,r,s){const i=this.kernel.windowSystem.clipboard;return i?this.kernel.scenes.get(e)?.paste(i,t,r,s)?.key??0:0}function Zh(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!s)return 0;let i=s.attrib;switch(r){case 0:i&=-13;break;case 1:i&=~sr,i|=ir;break;case 2:i&=~ir,i|=sr;break;default:return 0}return s.set({attrib:i}),1}function Jh(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.attrib??0}function Qh(e,t,r,s){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!i)return 0;let{attrib:n}=i;switch(s){case x.ATTRSET:n|=r;break;case x.ATTRRESET:n&=~r;break;case x.ATTRPUT:n=r;break;default:return 0}return i.set({attrib:n}),1}function eu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let s=1/0;for(const i of r.objects.keys())i>t&&i<s&&(s=i);return s===1/0?0:s}function tu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(!i)return 0;const n=s.objects.get(r);return n&&i.x+i.width>=n.x&&n.x+n.width>=i.x&&i.y+i.height>=n.y&&n.y+n.height>=i.y?1:0}function ru(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[0].key:0}function su(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[t.length-1].key:0}function iu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order,n=i.indexOf(s);return n<1?0:i[n-1].key}function nu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order,n=i.indexOf(s);return n>-1&&n<i.length-1?i[n+1].key:0}function ou(e,t){const r=t-1;if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene.order;return s&&r<s.length?s[r].key:0}function cu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const n=r.order.indexOf(s);return n<0?0:n+1}function lu(e,t,r){const s=r-1;if(s<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.objects.get(t);if(!n||n.type==="group")return 0;const l=i.order,a=[];for(let u=0;u<l.length;++u){const d=l[u];d!==n&&a.push(d),s===u&&a.push(n)}return s>=l.length&&a.push(n),i.set({order:a}),1}function au(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order.filter(n=>n!==s);return i.unshift(s),r.set({order:i}),1}function hu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order.filter(n=>n!==s);return i.push(s),r.set({order:i}),1}function uu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(!i||i.type==="group")return 0;const n=s.objects.get(r);if(!n||n.type==="group")return 0;const l=s.order.slice(),a=l.indexOf(i);if(a<0)return 0;const u=l.indexOf(n);if(u<0)return 0;const d=l[a];return l[a]=l[u],l[u]=d,s.set({order:l}),1}function Hs({kernel:e},t,r,s,i){const n=e.scenes.get(t);if(!n)return 0;const{matrix:l,scene:a}=n;if(l)for(let d=0;d<i.length;d+=2){const p=i[d+0],_=i[d+1],T=p*l[2]+_*l[5]+l[8];i[d+0]=(p*l[0]+_*l[3]+l[6])/T,i[d+1]=(p*l[1]+_*l[4]+l[7])/T}const u=a.line(i,{pen:a.pens.get(r),brush:a.brushes.get(s)});return a.set({order:a.order.concat(u)}),u.key}function du(e,t,r,...s){return Hs(this,e,t,r,s)}function fu(e,t,r,s,i){return Hs(this,e,t,r,[s,i])}function gu(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const l=n.scene.objects.get(t);if(l?.type!=="line")return 0;let a=s,u=i;const d=n.matrix;if(d){const p=s*d[2]+i*d[5]+d[8];a=(s*d[0]+i*d[3]+d[6])/p,u=(s*d[1]+i*d[4]+d[7])/p}return l.addPoint({x:a,y:u},r)?1:0}function pu(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const l=n.scene.objects.get(t);if(l?.type!=="line")return 0;let a=s,u=i;const d=n.matrix;if(d){const p=s*d[2]+i*d[5]+d[8];a=(s*d[0]+i*d[3]+d[6])/p,u=(s*d[1]+i*d[4]+d[7])/p}return l.setPoint(r,{x:a,y:u})?1:0}function _u(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="line"&&s.removePoint(r)?1:0}function Eu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"&&r.pen?.key||0}function wu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"&&r.brush?.key||0}function mu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"?r.length:0}function Tu(e,t,r){const s=this.kernel.scenes.get(e);if(!s)return 0;const i=s.scene.objects.get(t),n=i?.type==="line"&&i.point(r);if(!n)return 0;const{x:l,y:a}=n,u=s.invmatrix;if(!u)return l;const d=l*u[2]+a*u[5]+u[8];return(l*u[0]+a*u[3]+u[6])/d}function yu(e,t,r){const s=this.kernel.scenes.get(e);if(!s)return 0;const i=s.scene.objects.get(t),n=i?.type==="line"&&i.point(r);if(!n)return 0;const{x:l,y:a}=n,u=s.invmatrix;if(!u)return a;const d=l*u[2]+a*u[5]+u[8];return(l*u[1]+a*u[4]+u[7])/d}function bu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="line"&&i.set({brush:s.brushes.get(r)??null})?1:0}function Ru(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="line"&&i.set({pen:s.pens.get(r)??null})?1:0}function Ou(e,t,r,s,i,n,l,a){const u=this.kernel.scenes.get(e)?.scene.objects.get(t);if(u?.type!=="line")return 0;const d={angle:r,length:s,fill:!!i},p={angle:n,length:l,fill:!!a};return u.set({start:d,end:p}),1}function Mu(e,...t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let s=!0;const i=t.map(n=>{const l=r.objects.get(n);return(!l||l.parent)&&(s=!1),l});return s?r.group(i).key:0}function vu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type!=="group"?0:(r.set({children:[]}).delete(),1)}function Su(e,t,r){if(t===r)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;const n=s.objects.get(r);if(!n||n.parent)return 0;if(n.type==="group"){let l=i;for(;l=l.parent;)if(l===n)return 0}return i.set({children:i.children.concat(n)}),1}function Au(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;const n=s.objects.get(r);return n?.parent!==i?0:(i.set({children:i.children.filter(l=>l!==n)}),1)}function Nu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="group"?r.children.length:0}function Iu(e,t,r){if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(s?.type!=="group")return 0;const i=s.children;return r<i.length?i[r].key:0}function xu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.parent?.key??0}function Pu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;for(let n=0;n<i.children.length;++n){const l=i.children[n];if(l.key===r)return n+1;if(l.type==="group"){for(const a of l.descendants())if(a.key===r)return n+1}}return 0}function Xs({kernel:e},t,r,s,i,n){const l=e.scenes.get(t);if(!l)return 0;const a=l.scene,u=(n?a.imagesOpaque:a.images).get(r);if(!u)return 0;let d=s,p=i;const _=l.matrix;if(_){const m=s*_[2]+i*_[5]+_[8];d=(s*_[0]+i*_[3]+_[6])/m,p=(s*_[1]+i*_[4]+_[7])/m}const T=a.imageView(u,{x:d,y:p,opaque:n});return a.set({order:a.order.concat(T)}),T.key}function Du(e,t,r,s){return Xs(this,e,t,r,s,!0)}function ku(e,t,r,s){return Xs(this,e,t,r,s)}function Lu(e,t,r,s,i,n,l,a,u,d){const p=this.kernel.scenes.get(e)?.scene.objects.get(t);if(p?.type!=="imageView")return r[s]=0,i[n]=0,l[a]=0,u[d]=0,0;const _=p.area;return r[s]=_?.x??0,i[n]=_?.y??0,l[a]=_?.w??p.image.width,u[d]=_?.h??p.image.height,1}function Gu(e,t,r,s,i,n){const l=this.kernel.scenes.get(e)?.scene.objects.get(t);return l?.type==="imageView"&&l.set({area:{x:r,y:s,w:i,h:n}})?1:0}function Bu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="imageView"&&r.opaque&&r.image.key||0}function Cu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="imageView"&&!r.opaque&&r.image.key||0}function Uu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.imagesOpaque.get(r);if(!i)return 0;const n=s.objects.get(t);return n?.type==="imageView"&&n.opaque&&n.set({image:i})?1:0}function Fu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.images.get(r);if(!i)return 0;const n=s.objects.get(t);return n?.type==="imageView"&&!n.opaque&&n.set({image:i})?1:0}function Wu(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const l=n.scene,a=l.texts.get(t);if(!a)return 0;let u=r,d=s;const p=n.matrix;if(p){const T=r*p[2]+s*p[5]+p[8];u=(r*p[0]+s*p[3]+p[6])/T,d=(r*p[1]+s*p[4]+p[7])/T}const _=l.textView(a,{x:u,y:d,angle:i});return l.set({order:l.order.concat(_)}),_.key}function Vu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="textView"&&r.text.key||0}function $u(e){e("GetSpaceOrg2dx",{a:[c],r:o},_a),e("GetSpaceOrg2dy",{a:[c],r:o},Ea),e("SetSpaceOrg2d",{a:[c,o,o],r:o},wa),e("GetScaleSpace2d",{a:[c],r:o},ma),e("SetScaleSpace2d",{a:[c,o],r:o},Ta),e("SaveRectArea2d",{a:[c,E,o,o,o,o,o],r:o},ya),e("GetBkBrush2d",{a:[c],r:c},ba),e("SetBkBrush2d",{a:[c,c],r:o},Ra),e("LockSpace2d",{a:[c,o],r:o},Oa),e("GetSpaceLayers2d",{a:[c],r:o},Ma),e("SetSpaceLayers2d",{a:[c,o],r:o},va),e("SetSpaceRenderEngine2d",{a:[c,o],r:o},Sa),e("CreatePen2d",{a:[c,o,o,z,o],r:c},Aa),e("GetPenColor2d",{a:[c,c],r:z},Na),e("GetPenRop2d",{a:[c,c],r:o},Ia),e("GetPenStyle2d",{a:[c,c],r:o},xa),e("GetPenWidth2d",{a:[c,c],r:o},Pa),e("SetPenColor2d",{a:[c,c,z],r:o},Da),e("SetPenRop2d",{a:[c,c,o],r:o},ka),e("SetPenStyle2d",{a:[c,c,o],r:o},La),e("SetPenWidth2d",{a:[c,c,o],r:o},Ga),e("CreateBrush2d",{a:[c,o,o,z,c,o],r:c},Ba),e("GetBrushColor2d",{a:[c,c],r:z},Ca),e("GetBrushRop2d",{a:[c,c],r:o},Ua),e("GetBrushStyle2d",{a:[c,c],r:o},Fa),e("GetBrushHatch2d",{a:[c,c],r:o},Wa),e("GetBrushDib2d",{a:[c,c],r:c},Va),e("SetBrushColor2d",{a:[c,c,z],r:o},$a),e("SetBrushRop2d",{a:[c,c,o],r:o},ja),e("SetBrushStyle2d",{a:[c,c,o],r:o},Ha),e("SetBrushHatch2d",{a:[c,c,o],r:o},Xa),e("SetBrushDib2d",{a:[c,c,c],r:o},Ya),e("CreateFont2d",{a:[c,E,o,o],r:c},za),e("CreateFont2dpt",{a:[c,E,o,o],r:c},qa),e("GetFontName2d",{a:[c,c],r:E},Ka),e("GetFontSize2d",{a:[c,c],r:o},Za),e("GetFontStyle2d",{a:[c,c],r:o},Ja),e("SetFontName2d",{a:[c,c,E],r:o},Qa),e("SetFontSize2d",{a:[c,c,o],r:o},eh),e("SetFontStyle2d",{a:[c,c,o],r:o},th),e("CreateString2d",{a:[c,E],r:c},rh),e("GetString2d",{a:[c,c],r:E},sh),e("SetString2d",{a:[c,c,E],r:o},ih),e("CreateText2d",{a:[c,c,c,z,z],r:c},nh),e("GetTextCount2d",{a:[c,c],r:o},oh),e("GetTextFont2d",{a:[c,c],r:c},Cs),e("GetTextFont2d",{a:[c,c,o],r:c},Cs),e("GetTextString2d",{a:[c,c],r:c},Us),e("GetTextString2d",{a:[c,c,o],r:c},Us),e("GetTextFgColor2d",{a:[c,c],r:z},Fs),e("GetTextFgColor2d",{a:[c,c,o],r:z},Fs),e("GetTextBkColor2d",{a:[c,c],r:z},Ws),e("GetTextBkColor2d",{a:[c,c,o],r:z},Ws),e("SetText2d",{a:[c,c,c,c,z,z],r:o},ch),e("SetText2d",{a:[c,c,o,c,c,z,z],r:o},Vs),e("SetTextFont2d",{a:[c,c,o,c],r:o},lh),e("SetTextString2d",{a:[c,c,o,c],r:o},ah),e("SetTextFgColor2d",{a:[c,c,o,z],r:o},hh),e("SetTextBkColor2d",{a:[c,c,o,z],r:o},uh),e("AddText2d",{a:[c,c,c,c,z,z],r:o},dh),e("AddText2d",{a:[c,c,o,c,c,z,z],r:o},$s),e("RemoveText2d",{a:[c,c,o],r:o},fh),e("CreateDIB2d",{a:[c,E],r:c},gh),e("CreateDoubleDIB2d",{a:[c,E],r:c},ph),e("GetDibPixel2d",{a:[c,c,o,o],r:z},_h),e("SetDibPixel2d",{a:[c,c,o,o,z],r:o},Eh),e("DeleteTool2d",{a:[c,o,c],r:o},wh),e("GetNextTool2d",{a:[c,o,c],r:c},mh),e("GetToolRef2d",{a:[c,o,c],r:o},Th),e("Rgb",{a:[o,o,o],r:z},yh),e("RgbEx",{a:[o,o,o,o],r:z},bh),e("Rgbf",{a:[o],r:z},Rh),e("GetRValue",{a:[z],r:o},Oh),e("GetGValue",{a:[z],r:o},Mh),e("GetBValue",{a:[z],r:o},vh),e("CreateObjectFromFile2d",{a:[c,E,o,o,o],r:c},Sh),e("DeleteObject2d",{a:[c,c],r:o},Ah),e("GetObjectType2d",{a:[c,c],r:o},Nh),e("GetObjectName2d",{a:[c,c],r:E},Ih),e("SetObjectName2d",{a:[c,c,E],r:o},xh),e("GetObject2dByName",{a:[c,c,E],r:c},Ph),e("GetObjectOrg2dx",{a:[c,c],r:o},Dh),e("GetObjectOrg2dy",{a:[c,c],r:o},kh),e("SetObjectOrg2d",{a:[c,c,o,o],r:o},Lh),e("GetObjectWidth2d",{a:[c,c],r:o},Gh),e("GetObjectHeight2d",{a:[c,c],r:o},Bh),e("SetObjectSize2d",{a:[c,c,o,o],r:o},Ch),e("GetActualWidth2d",{a:[c,c],r:o},Uh),e("GetActualHeight2d",{a:[c,c],r:o},Fh),e("GetActualSize2d",{a:[c,c,A,A],r:o},Wh),e("GetObjectAngle2d",{a:[c,c],r:o},Vh),e("RotateObject2d",{a:[c,c,o,o,o],r:o},$h),e("SetShowObject2d",{a:[c,c,o],r:o},jh),e("ShowObject2d",{a:[c,c]},Hh),e("HideObject2d",{a:[c,c]},Xh),e("GetObjectFromPoint2d",{a:[c,o,o],r:c},Yh),e("GetLastPrimary2d",{r:c},zh),e("CopyToClipboard2d",{a:[c,c],r:o},qh),e("PasteFromClipboard2d",{a:[c,o,o,o],r:c},Kh),e("LockObject2d",{a:[c,c,o],r:o},Zh),e("GetObjectAttribute2d",{a:[c,c],r:o},Jh),e("SetObjectAttribute2d",{a:[c,c,o,o],r:o},Qh),e("GetNextObject2d",{a:[c,c],r:c},eu),e("IsObjectsIntersect2d",{a:[c,c,c,o],r:o},tu),e("GetBottomObject2d",{a:[c],r:c},ru),e("GetTopObject2d",{a:[c],r:c},su),e("GetLowerObject2d",{a:[c,c],r:c},iu),e("GetUpperObject2d",{a:[c,c],r:c},nu),e("GetObjectFromZOrder2d",{a:[c,o],r:c},ou),e("GetZOrder2d",{a:[c,c],r:o},cu),e("SetZOrder2d",{a:[c,c,o],r:o},lu),e("ObjectToBottom2d",{a:[c,c],r:o},au),e("ObjectToTop2d",{a:[c,c],r:o},hu),e("SwapObject2d",{a:[c,c,c],r:o},uu),e("CreatePolyLine2d",{a:[c,c,c],rest:[o,o],r:c},du),e("CreateLine2d",{a:[c,c,c,o,o],r:c},fu),e("AddPoint2d",{a:[c,c,o,o,o],r:o},gu),e("SetVectorPoint2d",{a:[c,c,o,o,o],r:o},pu),e("DelPoint2d",{a:[c,c,o],r:o},_u),e("GetPenObject2d",{a:[c,c],r:c},Eu),e("GetBrushObject2d",{a:[c,c],r:c},wu),e("GetVectorNumPoints2d",{a:[c,c],r:o},mu),e("GetVectorPoint2dx",{a:[c,c,o],r:o},Tu),e("GetVectorPoint2dy",{a:[c,c,o],r:o},yu),e("SetBrushObject2d",{a:[c,c,c],r:c},bu),e("SetPenObject2d",{a:[c,c,c],r:c},Ru),e("SetLineArrows2d",{a:[c,c,o,o,o,o,o,o],r:o},Ou),e("CreateGroup2d",{a:[c],rest:[c],r:c},Mu),e("DeleteGroup2d",{a:[c,c],r:o},vu),e("AddGroupItem2d",{a:[c,c,c],r:o},Su),e("DelGroupItem2d",{a:[c,c,c],r:o},Au),e("GetGroupItemsNum2d",{a:[c,c],r:o},Nu),e("GetGroupItem2d",{a:[c,c,o],r:c},Iu),e("GetObjectParent2d",{a:[c,c],r:c},xu),e("IsGroupContainObject2d",{a:[c,c,c],r:o},Pu),e("CreateBitmap2d",{a:[c,c,o,o],r:c},Du),e("CreateDoubleBitmap2d",{a:[c,c,o,o],r:c},ku),e("GetBitmapSrcRect2d",{a:[c,c,A,A,A,A],r:o},Lu),e("SetBitmapSrcRect2d",{a:[c,c,o,o,o,o],r:o},Gu),e("GetDibObject2d",{a:[c,c],r:c},Bu),e("GetDDibObject2d",{a:[c,c],r:c},Cu),e("SetDibObject2d",{a:[c,c,c],r:o},Uu),e("SetDDibObject2d",{a:[c,c,c],r:o},Fu),e("CreateRasterText2d",{a:[c,c,o,o,o],r:c},Wu),e("GetTextObject2d",{a:[c,c],r:c},Vu)}const ju={name:"graphics2d",deps:["windows","streams"],register:$u};var Ys=1e-6,fe=typeof Float32Array<"u"?Float32Array:Array;function Lt(){var e=new fe(9);return fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function zs(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function ne(){var e=new fe(16);return fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Hu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function qs(e,t){if(e===t){var r=t[1],s=t[2],i=t[3],n=t[6],l=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=n,e[11]=t[14],e[12]=i,e[13]=l,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function Ks(e,t){var r=t[0],s=t[1],i=t[2],n=t[3],l=t[4],a=t[5],u=t[6],d=t[7],p=t[8],_=t[9],T=t[10],m=t[11],R=t[12],N=t[13],O=t[14],k=t[15],L=r*a-s*l,U=r*u-i*l,F=r*d-n*l,j=s*u-i*a,B=s*d-n*a,D=i*d-n*u,I=p*N-_*R,X=p*O-T*R,K=p*k-m*R,J=_*O-T*N,he=_*k-m*N,le=T*k-m*O,Z=L*le-U*he+F*J+j*K-B*X+D*I;return Z?(Z=1/Z,e[0]=(a*le-u*he+d*J)*Z,e[1]=(i*he-s*le-n*J)*Z,e[2]=(N*D-O*B+k*j)*Z,e[3]=(T*B-_*D-m*j)*Z,e[4]=(u*K-l*le-d*X)*Z,e[5]=(r*le-i*K+n*X)*Z,e[6]=(O*F-R*D-k*U)*Z,e[7]=(p*D-T*F+m*U)*Z,e[8]=(l*he-a*K+d*I)*Z,e[9]=(s*K-r*he-n*I)*Z,e[10]=(R*B-N*F+k*L)*Z,e[11]=(_*F-p*B-m*L)*Z,e[12]=(a*X-l*J-u*I)*Z,e[13]=(r*J-s*X+i*I)*Z,e[14]=(N*U-R*j-O*L)*Z,e[15]=(p*j-_*U+T*L)*Z,e):null}function Xu(e,t,r){var s=t[0],i=t[1],n=t[2],l=t[3],a=t[4],u=t[5],d=t[6],p=t[7],_=t[8],T=t[9],m=t[10],R=t[11],N=t[12],O=t[13],k=t[14],L=t[15],U=r[0],F=r[1],j=r[2],B=r[3];return e[0]=U*s+F*a+j*_+B*N,e[1]=U*i+F*u+j*T+B*O,e[2]=U*n+F*d+j*m+B*k,e[3]=U*l+F*p+j*R+B*L,U=r[4],F=r[5],j=r[6],B=r[7],e[4]=U*s+F*a+j*_+B*N,e[5]=U*i+F*u+j*T+B*O,e[6]=U*n+F*d+j*m+B*k,e[7]=U*l+F*p+j*R+B*L,U=r[8],F=r[9],j=r[10],B=r[11],e[8]=U*s+F*a+j*_+B*N,e[9]=U*i+F*u+j*T+B*O,e[10]=U*n+F*d+j*m+B*k,e[11]=U*l+F*p+j*R+B*L,U=r[12],F=r[13],j=r[14],B=r[15],e[12]=U*s+F*a+j*_+B*N,e[13]=U*i+F*u+j*T+B*O,e[14]=U*n+F*d+j*m+B*k,e[15]=U*l+F*p+j*R+B*L,e}function Yu(e,t,r){var s=r[0],i=r[1],n=r[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function zu(e,t,r){var s=r[0],i=r[1],n=r[2],l=Math.sqrt(s*s+i*i+n*n),a,u,d;return l<Ys?null:(l=1/l,s*=l,i*=l,n*=l,a=Math.sin(t),u=Math.cos(t),d=1-u,e[0]=s*s*d+u,e[1]=i*s*d+n*a,e[2]=n*s*d-i*a,e[3]=0,e[4]=s*i*d-n*a,e[5]=i*i*d+u,e[6]=n*i*d+s*a,e[7]=0,e[8]=s*n*d+i*a,e[9]=i*n*d-s*a,e[10]=n*n*d+u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function Rr(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Zs(e,t){var r=t[0],s=t[1],i=t[2],n=t[4],l=t[5],a=t[6],u=t[8],d=t[9],p=t[10];return e[0]=Math.sqrt(r*r+s*s+i*i),e[1]=Math.sqrt(n*n+l*l+a*a),e[2]=Math.sqrt(u*u+d*d+p*p),e}function qu(e,t){var r=new fe(3);Zs(r,t);var s=1/r[0],i=1/r[1],n=1/r[2],l=t[0]*s,a=t[1]*i,u=t[2]*n,d=t[4]*s,p=t[5]*i,_=t[6]*n,T=t[8]*s,m=t[9]*i,R=t[10]*n,N=l+p+R,O=0;return N>0?(O=Math.sqrt(N+1)*2,e[3]=.25*O,e[0]=(_-m)/O,e[1]=(T-u)/O,e[2]=(a-d)/O):l>p&&l>R?(O=Math.sqrt(1+l-p-R)*2,e[3]=(_-m)/O,e[0]=.25*O,e[1]=(a+d)/O,e[2]=(T+u)/O):p>R?(O=Math.sqrt(1+p-l-R)*2,e[3]=(T-u)/O,e[0]=(a+d)/O,e[1]=.25*O,e[2]=(_+m)/O):(O=Math.sqrt(1+R-l-p)*2,e[3]=(a-d)/O,e[0]=(T+u)/O,e[1]=(_+m)/O,e[2]=.25*O),e}function Js(e,t,r,s){var i=t[0],n=t[1],l=t[2],a=t[3],u=i+i,d=n+n,p=l+l,_=i*u,T=i*d,m=i*p,R=n*d,N=n*p,O=l*p,k=a*u,L=a*d,U=a*p,F=s[0],j=s[1],B=s[2];return e[0]=(1-(R+O))*F,e[1]=(T+U)*F,e[2]=(m-L)*F,e[3]=0,e[4]=(T-U)*j,e[5]=(1-(_+O))*j,e[6]=(N+k)*j,e[7]=0,e[8]=(m+L)*B,e[9]=(N-k)*B,e[10]=(1-(_+R))*B,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function Ku(e,t,r,s,i){var n=1/Math.tan(t/2);if(e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0){var l=1/(s-i);e[10]=(i+s)*l,e[14]=2*i*s*l}else e[10]=-1,e[14]=-2*s;return e}var Zu=Ku;function Ju(e,t,r,s){var i=t[0],n=t[1],l=t[2],a=s[0],u=s[1],d=s[2],p=i-r[0],_=n-r[1],T=l-r[2],m=p*p+_*_+T*T;m>0&&(m=1/Math.sqrt(m),p*=m,_*=m,T*=m);var R=u*T-d*_,N=d*p-a*T,O=a*_-u*p;return m=R*R+N*N+O*O,m>0&&(m=1/Math.sqrt(m),R*=m,N*=m,O*=m),e[0]=R,e[1]=N,e[2]=O,e[3]=0,e[4]=_*O-T*N,e[5]=T*R-p*O,e[6]=p*N-_*R,e[7]=0,e[8]=p,e[9]=_,e[10]=T,e[11]=0,e[12]=i,e[13]=n,e[14]=l,e[15]=1,e}var Me=Xu;function Q(){var e=new fe(3);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Qu(e){var t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)}function ce(e,t,r){var s=new fe(3);return s[0]=e,s[1]=t,s[2]=r,s}function Qs(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Te(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e}function ed(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function td(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function rd(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function sd(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function id(e,t){var r=t[0]-e[0],s=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+s*s+i*i)}function nd(e,t){var r=t[0]-e[0],s=t[1]-e[1],i=t[2]-e[2];return r*r+s*s+i*i}function od(e){var t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s}function Gt(e,t){var r=t[0],s=t[1],i=t[2],n=r*r+s*s+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function xe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Ze(e,t,r){var s=t[0],i=t[1],n=t[2],l=r[0],a=r[1],u=r[2];return e[0]=i*u-n*a,e[1]=n*l-s*u,e[2]=s*a-i*l,e}function Pe(e,t,r){var s=t[0],i=t[1],n=t[2],l=r[3]*s+r[7]*i+r[11]*n+r[15];return l=l||1,e[0]=(r[0]*s+r[4]*i+r[8]*n+r[12])/l,e[1]=(r[1]*s+r[5]*i+r[9]*n+r[13])/l,e[2]=(r[2]*s+r[6]*i+r[10]*n+r[14])/l,e}function cd(e,t){var r=e[0],s=e[1],i=e[2],n=t[0],l=t[1],a=t[2],u=Math.sqrt((r*r+s*s+i*i)*(n*n+l*l+a*a)),d=u&&xe(e,t)/u;return Math.acos(Math.min(Math.max(d,-1),1))}var dt=td,ld=rd,ad=id,Or=nd,hd=Qu,ei=od;(function(){var e=Q();return function(t,r,s,i,n,l){var a,u;for(r||(r=3),s||(s=0),i?u=Math.min(i*r+s,t.length):u=t.length,a=s;a<u;a+=r)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],n(e,e,l),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}})();function ud(){var e=new fe(4);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function ft(e,t,r,s){var i=new fe(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=s,i}function Mr(e,t,r,s,i){return e[0]=t,e[1]=r,e[2]=s,e[3]=i,e}function dd(e,t){var r=t[0],s=t[1],i=t[2],n=t[3],l=r*r+s*s+i*i+n*n;return l>0&&(l=1/Math.sqrt(l)),e[0]=r*l,e[1]=s*l,e[2]=i*l,e[3]=n*l,e}(function(){var e=ud();return function(t,r,s,i,n,l){var a,u;for(r||(r=4),s||(s=0),i?u=Math.min(i*r+s,t.length):u=t.length,a=s;a<u;a+=r)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],e[3]=t[a+3],n(e,e,l),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2],t[a+3]=e[3];return t}})();function gt(){var e=new fe(4);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function fd(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function gd(e,t,r){r=r*.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e}function pd(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],l=t[3],a=Math.sin(r),u=Math.cos(r);return e[0]=s*u+l*a,e[1]=i*u+n*a,e[2]=n*u-i*a,e[3]=l*u-s*a,e}function _d(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],l=t[3],a=Math.sin(r),u=Math.cos(r);return e[0]=s*u-n*a,e[1]=i*u+l*a,e[2]=n*u+s*a,e[3]=l*u-i*a,e}function Ed(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],l=t[3],a=Math.sin(r),u=Math.cos(r);return e[0]=s*u+i*a,e[1]=i*u-s*a,e[2]=n*u+l*a,e[3]=l*u-n*a,e}function vr(e,t,r,s){var i=t[0],n=t[1],l=t[2],a=t[3],u=r[0],d=r[1],p=r[2],_=r[3],T,m,R,N,O;return m=i*u+n*d+l*p+a*_,m<0&&(m=-m,u=-u,d=-d,p=-p,_=-_),1-m>Ys?(T=Math.acos(m),R=Math.sin(T),N=Math.sin((1-s)*T)/R,O=Math.sin(s*T)/R):(N=1-s,O=s),e[0]=N*i+O*u,e[1]=N*n+O*d,e[2]=N*l+O*p,e[3]=N*a+O*_,e}function wd(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var n=(i+1)%3,l=(i+2)%3;s=Math.sqrt(t[i*3+i]-t[n*3+n]-t[l*3+l]+1),e[i]=.5*s,s=.5/s,e[3]=(t[n*3+l]-t[l*3+n])*s,e[n]=(t[n*3+i]+t[i*3+n])*s,e[l]=(t[l*3+i]+t[i*3+l])*s}return e}var md=Mr,Sr=dd;(function(){var e=Q(),t=ce(1,0,0),r=ce(0,1,0);return function(s,i,n){var l=xe(i,n);return l<-.999999?(Ze(e,t,i),hd(e)<1e-6&&Ze(e,r,i),Gt(e,e),gd(s,e,Math.PI),s):l>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(Ze(e,i,n),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+l,Sr(s,s))}})(),(function(){var e=gt(),t=gt();return function(r,s,i,n,l,a){return vr(e,s,l,a),vr(t,i,n,a),vr(r,e,t,2*a*(1-a)),r}})(),(function(){var e=Lt();return function(t,r,s,i){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],Sr(t,wd(t,e))}})();function Td(e,t,r){const s=[],i=Math.ceil(r/8);e.font=t;let n=0;const l=i,a=i,u=i,d=i;let p=0;for(let m=0;m<16;++m){let R=0;for(let N=0;N<16;++N){const O=m*16+N,k=_e[O],{width:L}=e.measureText(k),U=r;s.push({x:R+u,y:p+l,w:L,h:U,asc:l,desc:a,left:u,right:d}),R+=u+Math.ceil(L)+d}p+=l+r+a,n=Math.max(n,R)}return{font:t,fontSize:r,glyphRects:s,width:n,height:p}}function yd(e,{font:t,glyphRects:r,height:s,width:i}){e.canvas.width=i,e.canvas.height=s,e.font=t,e.fillStyle="white",e.textAlign="left",e.textBaseline="top",e.fontKerning="none",r.forEach(({x:n,y:l},a)=>{e.fillText(_e[a],n,l)})}const bd=2,Rd=0,Od=1,Md=2,vd=3,Sd=4,Ad=5,Nd=6,Id=7,xd=8,Pd=9,Dd=0,pt=1,kd=2,Ld=1,Gd=2,Bd=3,ti=4,Cd=5,Ud=6,Fd=0,Wd=1,Vd=0,ri=1,Bt=0,_t=1,Ct=2,$d=0,jd=1,Hd=2,Ut=0,Ft=1,Et=2;class Ar{constructor(t){this.objectsGenerator=t,this.list=new WeakMap,this.cur=null}get(t){const{cur:r}=this;if(r&&r.ctx===t)return r;const s=this.list.get(t);if(s)return this.cur=s;const i=this.objectsGenerator(t);return this.list.set(t,this.cur=i),i}}function wt(e,t,r){const s=e.createShader(t);if(e.shaderSource(s,r),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){console.log(r.split(`
`).map((l,a)=>`${a+1}: ${l}`).join(`
`));const n=e.getShaderInfoLog(s);throw Error(`Ошибка компиляции шейдера (${t===e.VERTEX_SHADER?"vertex":"fragment"}): ${n}`)}return s}function Nr(e,t,r){const s=e.getUniformLocation(t,r);if(!s)throw Error(`Программа не содержит Uniform '${r}'`);return s}class Xd{constructor(){this.entries=new Map}add(t,r,s){let i=this.entries.get(t);i||this.entries.set(t,i=new Map);let n=i.get(r);n?n.push(s):i.set(r,n=[s])}filterInline(t){this.entries.forEach((r,s)=>{r.forEach((i,n)=>{const l=i.filter(t);l.length?r.set(n,l):r.delete(n)}),r.size||this.entries.delete(s)})}}var Yd=`precision mediump float;
#ifdef UV
uniform sampler2D uTexture;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){
#ifndef GOURAUD
vec4 vLightColor4=vec4(1,1,1,1);
#endif
#ifdef UV
gl_FragColor=texture2D(uTexture,vTexCoord)*vLightColor4;
#else
gl_FragColor=vLightColor4;
#endif
}`,zd=`uniform mat4 uMVP4;
#ifdef GOURAUD
uniform vec3 uWorldLightPos;uniform mat4 uWorldMat4;uniform mat3 uWorldNormalMat;uniform vec3 uAmbientColor;uniform vec4 uTechDiffuseColor4;
#endif
attribute vec4 aPos4;
#ifdef GOURAUD
attribute vec3 aNormal;
#endif
#ifdef UV
attribute vec2 aUv;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){gl_Position=uMVP4*aPos4;
#ifdef GOURAUD
vec3 lightDir=normalize(uWorldLightPos-(uWorldMat4*aPos4).xyz);vec3 worldNormal=normalize(uWorldNormalMat*aNormal);vec3 uLightDiffuse=vec3(1,1,1);float uLightPower=1.;vec3 diffuse=uLightDiffuse*uLightPower*max(dot(worldNormal,lightDir),.0);vec3 GI=uAmbientColor+(uTechDiffuseColor4.rgb*diffuse);vLightColor4=vec4(GI,uTechDiffuseColor4.a);
#endif
#ifdef UV
vTexCoord=aUv;
#endif
}`;let Wt=-1;const Je=[{usesUV:!1,shadingMode:-1,index:++Wt},{usesUV:!1,shadingMode:pt,index:++Wt},{usesUV:!0,shadingMode:-1,index:++Wt},{usesUV:!0,shadingMode:pt,index:++Wt}],si={usesUV:!0,shadingMode:-1,index:-1};class ii{constructor(t,r,s,i){this.ctx=t,this.shaderProgram=r,this.hasNormalsSupport=s,this.hasUVSupport=i,this._activeTech=null,this._activeVAO=null}use(){const{ctx:t}=this;t._activeProgram!==this&&(t._setActiveProgram(this),t.gl.useProgram(this.shaderProgram),this._activeTech=null,this._activeVAO=null,++t.stats.switchesProgram,this.init())}_setActiveTech(t){this._activeTech=t}_setActiveVAO(t){this._activeVAO=t}}const ni=Je.map(({usesUV:e,shadingMode:t})=>{const r=[];return e&&r.push("UV"),r.push(t===pt?"GOURAUD":t===kd?"PHONG":t===Dd?"FLAT":"NO_SHADING"),r.map(s=>`#define ${s}
`).join("")}),qd=ni.map(e=>e+zd),Kd=ni.map(e=>e+Yd),Zd=Q();class oi extends ii{constructor(t,r,s,i){const{gl:n}=t,l=n.createProgram();if(n.attachShader(l,s),n.attachShader(l,i),n.bindAttribLocation(l,Ut,"aPos4"),n.bindAttribLocation(l,Ft,"aNormal"),n.bindAttribLocation(l,Et,"aUv"),n.linkProgram(l),!n.getProgramParameter(l,n.LINK_STATUS)){const d=n.getProgramInfoLog(l);throw Error(`Ошибка Link Program: ${d}`)}const a=r.shadingMode>-1;super(t,l,a,r.usesUV),this.caps=r,this.uTechDiffuseColor4=null,this.uAmbientColor=null,this.uWorldLightPos=null,this.uWorldMat4=null,this.uWorldNormalMat=null;const u=Nr.bind(null,n,l);this.uVMP4=u("uMVP4"),a&&(this.uTechDiffuseColor4=u("uTechDiffuseColor4"),this.uWorldLightPos=u("uWorldLightPos"),this.uWorldMat4=u("uWorldMat4"),this.uWorldNormalMat=u("uWorldNormalMat"),this.uAmbientColor=u("uAmbientColor")),this.gl=n}init(){this.hasNormalsSupport&&this.gl.uniform3fv(this.uWorldLightPos,this.ctx._lightPosition)}setMVPMatrix(t){this.gl.uniformMatrix4fv(this.uVMP4,!1,t)}setNormalMatrix(t,r){const{gl:s}=this;s.uniformMatrix4fv(this.uWorldMat4,!1,t),s.uniformMatrix3fv(this.uWorldNormalMat,!1,r)}setDiffuse(t){this.gl.uniform4fv(this.uTechDiffuseColor4,t)}setAmbient(t){this.gl.uniform3fv(this.uAmbientColor,ld(Zd,this.ctx._ambientColor,t))}useTexture(){}}var Jd="precision mediump float;varying vec2 tCoord;uniform vec4 color;uniform bool useTexture;uniform sampler2D tex;void main(){gl_FragColor=useTexture ? texture2D(tex,tCoord)*color : color;}",Qd="attribute vec2 v;attribute vec2 uv;uniform vec4 p;uniform vec4 uvRect;varying vec2 tCoord;void main(){gl_Position=vec4((p.x+p.z*v.x)*2.-1.,(-p.y+p.w*v.y)*2.+1.,0,1);tCoord=vec2(uvRect.x+uvRect.z*uv.x,uvRect.y+uvRect.w*uv.y);}";class ef extends ii{constructor(t){const{gl:r}=t,s=wt(r,r.VERTEX_SHADER,Qd),i=wt(r,r.FRAGMENT_SHADER,Jd),n=r.createProgram();if(r.attachShader(n,s),r.attachShader(n,i),r.bindAttribLocation(n,Ut,"v"),r.bindAttribLocation(n,Et,"uv"),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){const a=r.getProgramInfoLog(n);throw Error(`Ошибка Link Program: ${a}`)}super(t,n,!1,!0),this.textureInUse=!1;const l=Nr.bind(null,r,n);this.uPos=l("p"),this.uUVRect=l("uvRect"),this.uColor=l("color"),this.uUseTexture=l("useTexture"),this.gl=t.gl}setColor(t){this.gl.uniform4fv(this.uColor,t)}setPositionAndScale(t,r,s,i){this.gl.uniform4f(this.uPos,t,r,s,i)}setUVRect(t){this.gl.uniform4fv(this.uUVRect,t)}useTexture(t){this.textureInUse!==t&&(this.textureInUse=t,this.gl.uniform1f(this.uUseTexture,+t))}init(){}}var tf="precision mediump float;uniform sampler2D uTexture;uniform vec4 uTextColor;varying vec2 vTexCoord;void main(){float alpha=texture2D(uTexture,vTexCoord).a*uTextColor.a;gl_FragColor=vec4(uTextColor.rgb,alpha);}";class rf extends oi{constructor(t,r){const{gl:s}=t,i=wt(s,s.FRAGMENT_SHADER,tf);super(t,si,r,i),this.uTextColor=Nr(s,this.shaderProgram,"uTextColor")}setTextColor(t){this.gl.uniform4fv(this.uTextColor,t)}}class mt{use(t){const r=this.selectProgram(t);return r.use(),r._activeTech===this||(r._setActiveTech(this),this.apply(r),++t.stats.switchesTech),r}}class sf extends mt{constructor(t){super(),this.material=t,this.passVersion=-1,this.texture=null,this.programCaps=null,this.pass=t.techs[0].passes[0]}prepare(){const{pass:t}=this;if(this.passVersion===t._version)return;this.passVersion=t._version;const s=!!(this.texture=t._getDefaultTextureUnit()?.getTexture()||null),i=t.lightingEnabled?pt:0,n=Je.find(l=>l.usesUV===s&&l.shadingMode===i);if(!n)throw Error(`Материал "${this.material.name}": программа с заданными требованиями (usesUV: ${s}, shadingMode: ${i}) не существует`);this.programCaps=n}hasOpacity(){const{pass:t}=this;return t.diffuse[3]<1}getProgramCaps(){return this.prepare(),this.programCaps}selectProgram(t){return this.prepare(),t.meshPrograms[this.programCaps.index]}apply(t){const{ctx:r}=t,{pass:s}=this;r.setDepthWrite(s.depthWrite),r.setDepthCheck(s.depthCheck),this.texture?.use(r),t.setDiffuse(s.diffuse),t.setAmbient(s.ambient)}}class nf extends mt{constructor(t){super(),this.material=t,this.pass=t.techs[0].passes[0]}selectProgram(t){return t.overlayProgram}apply(t){const{pass:r}=this,s=r._getDefaultTextureUnit()?.getTexture();s?(s.use(t.ctx),t.useTexture(!0)):t.useTexture(!1),t.setColor(r.diffuse)}}class of extends mt{constructor(t,r){super(),this.fontTexture=t,this.colorSource=r}getProgramCaps(){return si}selectProgram(t){return t.textProgram}apply(t){this.fontTexture.use(t.ctx),t.setTextColor(this.colorSource.color)}}const cf=ft(0,0,1,1);class lf extends mt{constructor(t){super(),this.fontTexture=t}selectProgram(t){return t.overlayProgram}apply(t){this.fontTexture.use(t.ctx),t.useTexture(!0),t.setUVRect(cf)}}const Ir=document.createElement("canvas").getContext("2d",{alpha:!0});class af{constructor(t){this.fontName=t,this.cache=new Ar(this.genFontTexture.bind(this)),this.textOverlayRenderTech=null;const r=Math.round(150/72*20);this.glyphData=Td(Ir,`${r}px ${this.fontName}`,r)}genFontTexture(t){yd(Ir,this.glyphData);const{gl:r}=t,s=r.createTexture();return t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ir.canvas),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),{ctx:t,texture:s}}use(t){t.setTexture(this.cache.get(t).texture)}getTextOverlayRenderTech(){return this.textOverlayRenderTech||(this.textOverlayRenderTech=new lf(this)),this.textOverlayRenderTech}}class hf{constructor(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesVAO=0,this.switchesFace=0,this.dcOpaque=0,this.dcTransparent=0,this.dcOverlay=0,this.dcTotal=0;const t=this;Object.defineProperty(window,"s",{configurable:!0,get(){return t}})}reset(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesFace=0,this.switchesVAO=0,this.dcOpaque=0,this.dcTransparent=0,this.dcTotal=0,this.dcOverlay=0}}class uf{constructor(t){this.gl=t,this.currentTexture=null,this.uvEnabled=!1,this.normalsEnabled=!1,this.backFacesInUse=!1,this.depthWrite=!0,this.depthCheck=!0,this.blendSFactor=WebGLRenderingContext.ONE,this.blendDFactor=WebGLRenderingContext.ZERO,this._ambientColor=Q(),this._lightPosition=Q(),this.stats=new hf,this._activeProgram=null,t.enable(t.CULL_FACE),t.enableVertexAttribArray(Ut),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.hasIndices32Support=!!t.getExtension("OES_element_index_uint");const r=qd.map(n=>wt(t,t.VERTEX_SHADER,n)),s=Kd.map(n=>wt(t,t.FRAGMENT_SHADER,n));this.meshPrograms=Je.map((n,l)=>new oi(this,n,r[l],s[l]));const i=r[Je.findIndex(n=>n.usesUV&&n.shadingMode<0)];this.textProgram=new rf(this,i),this.overlayProgram=new ef(this)}_setActiveProgram(t){this._activeProgram=t}reset(){this.stats.reset()}setLighting(t,r){Qs(this._ambientColor,t),Qs(this._lightPosition,r),this._activeProgram?.init()}enableUV(){this.uvEnabled||(this.uvEnabled=!0,this.gl.enableVertexAttribArray(Et))}disableUV(){this.uvEnabled&&(this.uvEnabled=!1,this.gl.disableVertexAttribArray(Et))}enableNormals(){this.normalsEnabled||(this.normalsEnabled=!0,this.gl.enableVertexAttribArray(Ft))}disableNormals(){this.normalsEnabled&&(this.normalsEnabled=!1,this.gl.disableVertexAttribArray(Ft))}useBackFaces(t){if(this.backFacesInUse===t)return;this.backFacesInUse=t;const{gl:r}=this;r.frontFace(t?r.CW:r.CCW),++this.stats.switchesFace}setTexture(t){if(this.currentTexture===t)return;this.currentTexture=t;const{gl:r}=this;r.bindTexture(r.TEXTURE_2D,t),++this.stats.switchesTexture}setDepthWrite(t){this.depthWrite!==t&&(this.depthWrite=t,this.gl.depthMask(t))}setDepthCheck(t){if(this.depthCheck===t)return;this.depthCheck=t;const{gl:r}=this;r.depthFunc(t?r.LESS:r.ALWAYS)}setBlendFunc(t,r){this.blendSFactor===t&&this.blendDFactor===r||(this.blendSFactor=t,this.blendDFactor=r,this.gl.blendFunc(t,r))}}function ve(e){const t=e.split(" ").map(r=>parseFloat(r));return t.length===4&&!t.some(isNaN)?[t[0],t[1],t[2]-t[0],t[3]-t[1]]:null}function df(e){const t=e.split(" ").slice(0,3).map(r=>parseFloat(r));return t.some(isNaN)?null:[...t,1]}class xr{constructor(t,r,s){this.o=t,this.type=r,this.overlay=null,this.parent=null,this.children=[],this.visible=!0,this.x=0,this.y=0,this.width=0,this.height=0,this.metricsMode=Vd,this.horAlign=Bt,this.horTextAlign=Bt,this.vertAlign=$d,this.caption="",this.charHeight=12,this.spaceWidth=0,this.color=[1,1,1,1],this.material=null,this.uv=[0,0,1,1],this.uvTL=[0,0,1,1],this.uvTR=[0,0,1,1],this.uvBL=[0,0,1,1],this.uvBR=[0,0,1,1],this.uvL=[0,0,1,1],this.uvR=[0,0,1,1],this.uvT=[0,0,1,1],this.uvB=[0,0,1,1],this.borders=[0,0,0,0],this.textMesh=null,t.overlayElements.set(this.key=t.key(),this),this.name=s?.name??""}drawAt(t,r,s,i,n,l,a){const{visible:u,vertAlign:d,horAlign:p,metricsMode:_,x:T,y:m,width:R,height:N}=this;if(!u)return;const O=_===ri,k=(O?T/l:T)+(p===Ct?i:p===_t?i/2:0)+r,L=(O?m/a:m)+(d===Hd?n:d===jd?n/2:0)+s,U=O?R/l:R,F=O?N/a:N;this.draw(t,k,L,U,F,l,a),this.children.forEach(j=>j.drawAt(t,k,L,U,F,l,a))}setMetricsMode(t){return this.metricsMode=t,this}setChildren(t){return this.children.forEach(r=>r.parent=null),this.children=Array.from(new Set(t)),this.children.forEach(r=>r.parent=this),this}setVisible(t){return this.visible=t,this}setPosition(t,r){return this.x=t,this.y=r,this}setSize(t,r){return this.width=t,this.height=r,this}setAlignment(t,r){return this.horAlign=t,this.vertAlign=r,this}setCaption(t){return this.caption!==t&&(this.caption=t,this.textMesh=null),this}setColor(t,r,s,i){return this.color=[t,r,s,i],this}setMaterial(t){return this.material=t,this}setParam(t,r){switch(t){case"uv_coords":{const i=ve(r);i&&(this.uv=i);break}case"border_material":break;case"border_size":{const i=r.split(" ").map(n=>Math.max(parseInt(n),2));i.length===4&&!i.some(isNaN)&&(this.borders=i);break}case"border_topleft_uv":{const i=ve(r);i&&(this.uvTL=i);break}case"border_topright_uv":{const i=ve(r);i&&(this.uvTR=i);break}case"border_bottomleft_uv":{const i=ve(r);i&&(this.uvBL=i);break}case"border_bottomright_uv":{const i=ve(r);i&&(this.uvBR=i);break}case"border_left_uv":{const i=ve(r);i&&(this.uvL=i);break}case"border_right_uv":{const i=ve(r);i&&(this.uvR=i);break}case"border_top_uv":{const i=ve(r);i&&(this.uvT=i);break}case"border_bottom_uv":{const i=ve(r);i&&(this.uvB=i);break}case"font_name":break;case"alignment":this.horTextAlign=r==="center"?_t:r==="right"?Ct:Bt;break;case"colour":const s=df(r);s&&(this.color=s);break;case"char_height":{const i=parseInt(r)||12;this.charHeight!==i&&(this.charHeight=i,this.textMesh=null);break}case"space_width":{const i=parseInt(r)||12;this.spaceWidth!==i&&(this.spaceWidth=i,this.textMesh=null);break}default:console.warn(`Неизвестный параметр StringInterface: '${t}'`);break}}}class Qe{constructor(t){this.data=t,this.cache=new Ar(this.genBuffers.bind(this)),this.gl=null;const{indices:r,positions:s,positionSize:i}=t,n=this.useIndices32=r instanceof Uint32Array;this.positionSize=i,this.hasIndices=!!r,this.count=r?.length??s.length/i,this.drawMode=t.drawMode??WebGLRenderingContext.TRIANGLES,this.indicesType=n?WebGLRenderingContext.UNSIGNED_INT:WebGLRenderingContext.UNSIGNED_SHORT}genBuffers(t){const{gl:r}=t,{indices:s,positions:i,uvs:n,normals:l}=this.data,a=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,i,r.STATIC_DRAW);let u;n?(u=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,u),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW)):u=null;let d;l?(d=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,d),r.bufferData(r.ARRAY_BUFFER,l,r.STATIC_DRAW)):d=null;let p;return s?(p=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.bufferData(r.ELEMENT_ARRAY_BUFFER,s,r.STATIC_DRAW),this.useIndices32&&!t.hasIndices32Support&&(console.warn("WebGL: Не поддерживаются 32-битные индексы"),this.indicesType=r.UNSIGNED_SHORT,this.count=0)):p=null,{ctx:t,positionsBuffer:a,uvsBuffer:u,normalsBuffer:d,indexBuffer:p}}use(t){if(t._activeVAO===this)return;t._setActiveVAO(this);const{ctx:r}=t,{positionsBuffer:s,uvsBuffer:i,normalsBuffer:n,indexBuffer:l}=this.cache.get(r),{gl:a}=r;a.bindBuffer(a.ARRAY_BUFFER,s),a.vertexAttribPointer(Ut,this.positionSize,a.FLOAT,!1,0,0),i&&t.hasUVSupport?(a.bindBuffer(a.ARRAY_BUFFER,i),a.vertexAttribPointer(Et,2,a.FLOAT,!1,0,0),r.enableUV()):r.disableUV(),n&&t.hasNormalsSupport?(a.bindBuffer(a.ARRAY_BUFFER,n),a.vertexAttribPointer(Ft,3,a.FLOAT,!1,0,0),r.enableNormals()):r.disableNormals(),l&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,l),this.gl=a,++r.stats.switchesVAO}draw(){const{gl:t,drawMode:r,count:s,indicesType:i,hasIndices:n}=this;n?t.drawElements(r,s,i,0):t.drawArrays(r,0,s)}_drawRange(t,r){const{gl:s,drawMode:i,indicesType:n}=this;s.drawElements(i,r,n,t)}}class ff{constructor(t,r,s){this.sharedVAO=t,this.count=s,this.byteOffset=r*(t.useIndices32?4:2)}use(t){this.sharedVAO.use(t)}draw(){this.sharedVAO._drawRange(this.byteOffset,this.count)}}const Vt=new Qe({positionSize:2,positions:new Float32Array([0,0,0,-1,1,-1,1,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),drawMode:WebGLRenderingContext.TRIANGLE_FAN});class gf extends xr{constructor(t,r){super(t,"Panel",r)}draw(t,r,s,i,n){const{material:l,uv:a}=this;if(!l)return;const u=l._getPanelOverlayRenderTech().use(t);Vt.use(u),u.setUVRect(a),u.setPositionAndScale(r,s,i,n),Vt.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class pf extends xr{constructor(t,r){super(t,"BorderPanel",r)}draw(t,r,s,i,n,l,a){const{material:u,uv:d,borders:p,uvTL:_,uvT:T,uvTR:m,uvR:R,uvBR:N,uvB:O,uvBL:k,uvL:L,metricsMode:U}=this;if(!u)return;const F=u._getPanelOverlayRenderTech().use(t);Vt.use(F);const j=U===ri,B=j?p[0]/l:p[0],D=j?p[1]/l:p[1],I=j?p[2]/a:p[2],X=j?p[3]/a:p[3],K=i-B-D,J=n-I-X;[[[B,I,K,J],d],[[0,0,B,I],_],[[B,0,K,I],T],[[B+K,0,D,I],m],[[B+K,I,D,J],R],[[B+K,I+J,D,X],N],[[B,I+J,K,X],O],[[0,I+J,B,X],k],[[0,I,B,J],L]].forEach(([le,Z])=>{F.setUVRect(Z),F.setPositionAndScale(r+le[0],s+le[1],le[2],le[3]),Vt.draw(),++t.stats.dcOverlay,++t.stats.dcTotal})}}function ci(e,t,r=Bt,s=0){const{glyphRects:i,fontSize:n,height:l,width:a}=e,u=[...t],d=(s||i[vt].w)/n;let p=0;const _=[];let T=0,m=0;{let L={glyphs:[],width:0},U=0;u.forEach(F=>{const j=_e.indexOf(F),B=j>-1?j:vt;if(B===Ln){_.push(L),T=Math.max(T,L.width),m+=1,L={glyphs:[],width:0},U=0,L.width=0;return}const D=i[B];if(B===vt)(r!==_t||!_.length||L.glyphs.length)&&(L.width+=d,L.glyphs.push(null));else{const I=D.w/n,X=D.h/n;L.width+=I,U=Math.max(U,X),L.glyphs.push(D),++p}}),_.push(L),T=Math.max(T,L.width),m+=U}if(!p)return{caption:t,width:T,height:m,vao:null,align:r};const R=new Float32Array(p*8),N=new Float32Array(p*8),O=new Uint16Array(p*6);{let L=0,U=0;_.forEach(F=>{let j=r===_t?(T-F.width)/2:r===Ct?T-F.width:0;F.glyphs.forEach(B=>{if(!B){j+=d;return}const D=B.w/n,I=B.x-B.left,X=B.y-B.asc,K=B.left+B.w+B.right,J=B.asc+B.h+B.desc,he=K/n,le=J/n,Z=L*8,Ge=L*6,Be=L*4;++L;{const Ce=j-B.left/n,rt=U+B.asc/n;j+=D;const st=Ce,bt=Ce,He=Ce+he,it=He,nt=rt,Xe=rt-le,Vr=Xe,$r=nt;R[Z+0]=st,R[Z+1]=nt,R[Z+2]=bt,R[Z+3]=Xe,R[Z+4]=He,R[Z+5]=Vr,R[Z+6]=it,R[Z+7]=$r}{const Ce=I/a,rt=Ce,st=(I+K)/a,bt=st,He=X/l,it=(X+J)/l,nt=it,Xe=He;N[Z+0]=Ce,N[Z+1]=He,N[Z+2]=rt,N[Z+3]=it,N[Z+4]=st,N[Z+5]=nt,N[Z+6]=bt,N[Z+7]=Xe}O[Ge+0]=Be+0,O[Ge+1]=Be+1,O[Ge+2]=Be+2,O[Ge+3]=Be+0,O[Ge+4]=Be+2,O[Ge+5]=Be+3}),U-=1})}const k=new Qe({positionSize:2,positions:R,uvs:N,indices:O});return{caption:t,width:T,height:m,vao:k,align:r}}class _f extends xr{constructor(t,r){super(t,"TextArea",r),this.tech=t._getFontTexture().getTextOverlayRenderTech()}draw(t,r,s,i,n,l,a){const{caption:u,tech:d,horTextAlign:p,spaceWidth:_}=this;if(!u)return;const{vao:T,width:m}=this.textMesh||(this.textMesh=ci(d.fontTexture.glyphData,u,p,_));if(!T)return;const R=d.use(t);T.use(R);const N=this.charHeight*.75,O=N/l,k=N/a,L=r-(p===Ct?m*O:p===_t?m*O/2:0);R.setPositionAndScale(L,s,O,k),R.setColor(this.color),T.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class $t{constructor(){this.renderIteration=0,this.currentRenderList=null}_setCurrentRenderList(t){this.currentRenderList=t}_setRenderIteration(t){this.renderIteration=t}_techOrVAOChanged(){this.currentRenderList?._removeElement(this)}}class Ef{constructor(){this.renderIteration=0,this.gcFilter=t=>t.currentRenderList===this,this.capsGroups=Je.map(()=>new Xd)}clear(){++this.renderIteration}add(t){if(t._setRenderIteration(this.renderIteration),t.currentRenderList===this)return;t._setCurrentRenderList(this);const r=t.getRenderTech(),s=t.getVAO(),i=r.getProgramCaps();this.capsGroups[i.index].add(r,s,t)}_removeElement(t){t._setCurrentRenderList(null),this.gc()}render(t,r){let s=!1;const{renderIteration:i}=this,{stats:n}=t;for(const l of this.capsGroups)l.entries.forEach((a,u)=>{const d=u.use(t),{hasNormalsSupport:p}=d;a.forEach((_,T)=>{T.use(d),_.forEach(m=>{if(m.currentRenderList!==this){s=!0;return}if(m.renderIteration!==i){m._setCurrentRenderList(null),s=!0;return}t.useBackFaces(m.isMirrored()),p&&d.setNormalMatrix(m.getWorldMatrix(),m.getWorldNormalMatrix()),d.setMVPMatrix(m.getMVPMatrix(r)),T.draw(),++n.dcOpaque,++n.dcTotal})})});s&&this.gc()}gc(){for(const t of this.capsGroups)t.filterInline(this.gcFilter)}}class li{constructor(){this.elements=[],this.renderIteration=0}clear(){++this.renderIteration}add(t){t._setRenderIteration(this.renderIteration),t.currentRenderList!==this&&(t._setCurrentRenderList(this),this.elements.push(t))}_removeElement(){}render(t,r){let s=!1;const{renderIteration:i}=this,{stats:n}=t;if(r.node){const l=r.node.getWorldPosition();this.elements.sort((a,u)=>Or(l,u.getWorldCOM())-Or(l,a.getWorldCOM()))}else this.elements.sort((l,a)=>ei(a.getWorldCOM())-ei(l.getWorldCOM()));this.elements.forEach(l=>{if(l.currentRenderList!==this){s=!0;return}if(l.renderIteration!==i){l._setCurrentRenderList(null),s=!0;return}const a=l.getRenderTech(),u=l.getVAO(),d=a.use(t);u.use(d),t.useBackFaces(l.isMirrored()),d.hasNormalsSupport&&d.setNormalMatrix(l.getWorldMatrix(),l.getWorldNormalMatrix()),d.setMVPMatrix(l.getMVPMatrix(r)),u.draw(),++n.dcTotal,++n.dcTransparent}),s&&this.gc()}gc(){this.elements=this.elements.filter(t=>t.currentRenderList===this)}}class wf{constructor(t){this.image=t,this.cache=new Ar(this.genTexture.bind(this))}genTexture(t){const{gl:r}=t,s=r.createTexture();function i(l){t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,l),is(l.width)&&is(l.height)?r.generateMipmap(r.TEXTURE_2D):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE))}const{image:n}=this;return n.complete&&n.naturalHeight?i(n):(t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array([211,211,211,64])),n.complete||n.addEventListener("load",()=>i(n))),{ctx:t,texture:s}}use(t){t.setTexture(this.cache.get(t).texture)}}const mf=ne(),Tf=Lt(),ai=Q(),yf=ce(0,1,0),hi=ce(0,0,-1),bf=ce(1,1,1),Rf=ft(1,1,1,1),Pr=Q(),Dr=Q(),kr=Q(),Lr=Q(),Gr=Q();function ui({origin:e,dir:t},r,s,i){dt(Pr,s,r),dt(Dr,i,r),Ze(kr,t,Dr);const n=xe(Pr,kr);if(n>-Number.EPSILON&&n<Number.EPSILON)return 1/0;const l=1/n;dt(Lr,e,r);const a=xe(Lr,kr)*l;if(a<0||a>1)return 1/0;Ze(Gr,Lr,Pr);const u=xe(t,Gr)*l;if(u<0||a+u>1)return 1/0;const d=xe(Dr,Gr)*l;return d>Number.EPSILON?d:1/0}const De=Q(),ke=Q(),Le=Q();function Of(e,t){let r=1/0;for(let s=0;s+8<t.length;s+=9){De[0]=t[s+0],De[1]=t[s+1],De[2]=t[s+2],ke[0]=t[s+3],ke[1]=t[s+4],ke[2]=t[s+5],Le[0]=t[s+6],Le[1]=t[s+7],Le[2]=t[s+8];const i=ui(e,De,ke,Le);r>i&&(r=i)}return r}function Mf(e,t,r){let s=1/0;for(let i=0;i+2<r.length;i+=3){const n=r[i+0]*3,l=r[i+1]*3,a=r[i+2]*3;De[0]=t[n+0],De[1]=t[n+1],De[2]=t[n+2],ke[0]=t[l+0],ke[1]=t[l+1],ke[2]=t[l+2],Le[0]=t[a+0],Le[1]=t[a+1],Le[2]=t[a+2];const u=ui(e,De,ke,Le);s>u&&(s=u)}return s}function vf(e,t,r){const[s,i,n]=t;return e[0]=r[0]*s+r[4]*i+r[8]*n,e[1]=r[1]*s+r[5]*i+r[9]*n,e[2]=r[2]*s+r[6]*i+r[10]*n,Gt(e,e)}function Sf(e,t,r){return Pe(e.origin,t.origin,r),vf(e.dir,t.dir,r),e}function di(e){switch(e){case Rd:return WebGLRenderingContext.ONE;case Od:return WebGLRenderingContext.ZERO;case Md:return WebGLRenderingContext.DST_COLOR;case vd:return WebGLRenderingContext.SRC_COLOR;case Sd:return WebGLRenderingContext.ONE_MINUS_DST_COLOR;case Ad:return WebGLRenderingContext.ONE_MINUS_SRC_COLOR;case Nd:return WebGLRenderingContext.DST_ALPHA;case Id:return WebGLRenderingContext.SRC_ALPHA;case xd:return WebGLRenderingContext.ONE_MINUS_DST_ALPHA;case Pd:return WebGLRenderingContext.ONE_MINUS_SRC_ALPHA;default:return 0}}function Af(e){switch(e){case Ld:return WebGLRenderingContext.POINTS;case Gd:return WebGLRenderingContext.LINES;case Bd:return WebGLRenderingContext.LINE_STRIP;case Cd:return WebGLRenderingContext.TRIANGLE_STRIP;case Ud:return WebGLRenderingContext.TRIANGLE_FAN;default:return WebGLRenderingContext.TRIANGLES}}function Br(){return{origin:Q(),dir:ce(0,0,1)}}const Nf=new Qe({positionSize:2,positions:new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),indices:new Uint16Array([0,2,1,0,3,2,0,1,2,0,2,3])});class If extends $t{constructor(t,r,s){super(),this.set=t,this.position=r,this.parentScale=s,this.worldMatrix=ne(),this.localMatrix=ne(),this.worldCOM=Q(),this.rotation=gt(),this.mvpMatrix=ne(),this.worldMatrixVersion=0,this.comWorldMatrixVersion=0,this.shouldUpdateLocalMatrix=!0,this.key=t.o.key()}getMVPMatrix(t){return Me(this.mvpMatrix,t._getVPMatrix(),this.getWorldMatrix())}getWorldMatrix(){const{set:t}=this;this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,Js(this.localMatrix,this.rotation,this.position,this.parentScale),this.worldMatrixVersion=0);const r=t.node;return this.worldMatrixVersion!==r._worldMatrixVersion&&(this.worldMatrixVersion=r._worldMatrixVersion,Me(this.worldMatrix,r._getWorldMatrix(),this.localMatrix)),this.worldMatrix}getWorldCOM(){const t=this.set.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.position,t._getWorldMatrix()),Rr(this.worldCOM,this.getWorldMatrix())),this.worldCOM}getVAO(){return Nf}getRenderTech(){return this.set.material._getMeshRenderTech()}getWorldNormalMatrix(){return Tf}isMirrored(){return!1}_onAttached(){this.worldMatrixVersion=0,this.comWorldMatrixVersion=0}_updateLocalMatrix(){this.shouldUpdateLocalMatrix=!0}}class et{constructor(t,r){this.o=t,this.node=null,this.visible=!0,t.movables.set(this.key=t.key(),this),this.name=r?.name??""}destroy(){this.detach(),this.o.movables.delete(this.key)}setVisible(t){return this.visible=t,this}detach(){const t=this.node;return t?(t.movables=t.movables.filter(r=>r!==this),this.node=null,this):this}}class xf extends et{constructor(t,r){super(t,r),this.commonScale=ce(1,1,1),this.type=Fd,this.material=null,this.billboards=[],t.billboardSets.set(this.key,this)}destroy(){super.destroy(),this.o.billboardSets.delete(this.key)}createBillboard(t,r,s){const i=new If(this,ce(t,r,s),this.commonScale);return this.billboards.push(i),i}setCommonDirection(t,r,s){return this}setCommonUpVector(t,r,s){return this}setDimensions(t,r){Te(this.commonScale,t,r,1);for(const s of this.billboards)s._updateLocalMatrix();return this}setType(t){if(t!==Wd)throw Error(`billboardSet_SetBillboardType: тип ${t} не реализован`);return this.type=t,this}setMaterial(t){if(this.material!==t){this.material=t;for(const r of this.billboards)r._techOrVAOChanged()}return this}_onAttached(){for(const t of this.billboards)t._onAttached()}_setup(t){const{material:r}=this;if(!r)return;const s=r._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements;for(const i of this.billboards)s.add(i)}}const fi=new Map;class Pf{constructor(t){this.info=t,this.texture=null,this.image=null,this.loadImage()}loadImage(){if(this.image)return this.image;const t=We(this.info.src),r=fi.get(t);if(r)return this.image=r;const s=new Image;return s.crossOrigin="",s.src=t,fi.set(t,s),this.image=s}getTexture(){return this.texture||(this.image||(this.image=this.loadImage()),this.texture=new wf(this.image)),this.texture}}const jt=Q();class gi{constructor(t,r){this.center=t,this.sqrRadius=r*r}intersectsWith(t){const{center:r}=this;if(Or(r,t.origin)<=this.sqrRadius)return!0;dt(jt,r,t.origin);const s=xe(jt,t.dir),i=xe(jt,jt)-s*s;if(i>this.sqrRadius)return!1;const n=Math.sqrt(this.sqrRadius-i);return s+n>=0}}class Df{constructor(t,r,s){this.parent=t,this.data=r,this.indexOffset=s,this.material=null,this.vao=null,this.materialFound=!1,this.materialName=r.material||"",this.useSharedGeometry=r.useSharedGeometry||!1;const i=r.useSharedGeometry?t.data.sharedGeometry:r.geometry;if(!i)throw Error("Mesh не имеет геометрии");if(i.length>1)throw Error("Mesh с несколькими VertexBuffer не реализованы");const[n]=i;if(!n.positions)throw Error("Mesh без Positions не поддерживается");this.vBufferData=n;const{maxX:l,maxY:a,maxZ:u,minX:d,minY:p,minZ:_}=r.extrema||n.positions.extrema,T=(l+d)/2,m=(a+p)/2,R=(u+_)/2;this.center=ce(T,m,R);const N=Math.max(l-d,a-p,u-_)/2;this.boundingSphere=new gi(this.center,N)}getCOM(){return this.center}getVertexCount(){return this.vBufferData.vertexCount}getDefaultMaterial(){if(this.materialFound)return this.material;if(this.materialFound=!0,!this.materialName)return null;const t=this.parent.o.materialByName.get(this.materialName)??null;if(!t){const r=this.parent.submeshes.indexOf(this);console.warn(`Ogre: ${this.parent.meta}[${r}]: материал '${this.materialName}' не существует`)}return this.material=t}getVAO(){if(this.vao)return this.vao;if(this.useSharedGeometry){const a=this.indexOffset;let u=this.data.indices.length;return this.vao=new ff(this.parent._getSharedVAO(),a,u)}const{vBufferData:t,data:r}=this,s=new Float32Array(t.positions.coords),i=t.normals?.length?new Float32Array(t.normals):null,n=t.uvs?.length?new Float32Array(t.uvs[0]):null,l=new(r.useIndices32?Uint32Array:Uint16Array)(r.indices);return this.vao=new Qe({positionSize:3,positions:s,uvs:n,normals:i,indices:l})}getClosestIntersection(t){return this.boundingSphere.intersectsWith(t)?Mf(t,this.vBufferData.positions.coords,this.data.indices):1/0}}class kf{constructor(t,r){this.o=t,this.data=r,this.sharedVAO=null;let s=0;this.submeshes=r.submeshes.map(i=>{const n=new Df(this,i,s);return s+=i.indices.length,n})}_getSharedVAO(){if(this.sharedVAO)return this.sharedVAO;const[t]=this.data.sharedGeometry;let r=!1,s=0;this.data.submeshes.forEach(d=>{d.useIndices32&&(r=!0),s+=d.indices.length});const i=new(r?Uint32Array:Uint16Array)(s);let n=0;this.data.submeshes.forEach(d=>{i.set(d.indices,n),n+=d.indices.length});const l=new Float32Array(t.positions.coords),a=t.normals?.length?new Float32Array(t.normals):null,u=t.uvs?.length?new Float32Array(t.uvs[0]):null;return this.sharedVAO=new Qe({positionSize:3,positions:l,uvs:u,normals:a,indices:i})}}class Lf extends et{constructor(t,r){super(t,r),t.lights.set(this.key,this)}destroy(){super.destroy(),this.o.lights.delete(this.key)}_onAttached(){}_setup(t){t.globalLight=this}}class Gf{constructor(t,r=""){this.pass=t,this.name=r,this.texture=null,this.imageNameUC=null,this.imageFound=!1,t.tech.mat.o.texUnits.set(this.key=t.tech.mat.o.key(),this)}setTexture(t,r){if(r!==bd)throw Error("textureUnitState_SetTexture: Используемый тип текстуры не поддерживается");return this.texture=t?.getTexture()||null,this}setTextureName(t){return this.imageNameUC=t.toUpperCase(),this}getTexture(){return this.imageFound||this.texture?this.texture:(this.imageFound=!0,this.imageNameUC?this.texture=this.pass.tech.mat.o.imageResByNameUC.get(this.imageNameUC)?.getTexture()||null:null)}}class Bf{constructor(t){this.tech=t,this.textures=[],this.ambient=ce(1,1,1),this.diffuse=ft(1,1,1,1),this.specular=ft(0,0,0,1),this.emissive=ce(0,0,0),this.shininess=0,this.lightingEnabled=!0,this.shadingMode=pt,this.depthCheck=!0,this.depthWrite=!0,this._glBlendSFactor=WebGLRenderingContext.ONE,this._glBlendDFactor=WebGLRenderingContext.ZERO,this._version=0,t.mat.o.passes.set(this.key=t.mat.o.key(),this)}_getDefaultTextureUnit(){const{textures:t}=this;return t.length?t[0]:null}createTextureUnit(t){const r=new Gf(this,t);return this.textures.push(r),r}setLightingEnabled(t){return this.lightingEnabled=t,this}setAmbient(t,r,s){return Te(this.ambient,t,r,s),this}setDiffuse(t,r,s,i){return Mr(this.diffuse,t,r,s,i),this}setSpecular(t,r,s,i){return Mr(this.specular,t,r,s,i),this}setEmissive(t,r,s){return Te(this.emissive,t,r,s),this}setShininess(t){return this.shininess=t,this}setShadingMode(t){return this.shadingMode=t,this}setDepthCheckEnabled(t){return this.depthCheck=t,this}setDepthWriteEnabled(t){return this.depthWrite=t,this}setSceneBlending(t,r){return this._glBlendSFactor=di(t)||WebGLRenderingContext.ONE,this._glBlendDFactor=di(r)||WebGLRenderingContext.ZERO,this}}class Cf{constructor(t){this.mat=t,t.o.techniques.set(this.key=t.o.key(),this),this.passes=[new Bf(this)]}pass(t){return t>=0&&t<this.passes.length?this.passes[t]:null}}class Uf{constructor(t,r){this.o=t,this.name=r,this.meshRenderTech=null,this.panelOverlayRenderTech=null,t.materialByKey.set(this.key=t.key(),this),t.materialByName.has(r)||t.materialByName.set(r,this),this.techs=[new Cf(this)]}tech(t){return t>=0&&t<this.techs.length?this.techs[t]:null}_getMeshRenderTech(){return this.meshRenderTech||(this.meshRenderTech=new sf(this)),this.meshRenderTech}_getPanelOverlayRenderTech(){return this.panelOverlayRenderTech||(this.panelOverlayRenderTech=new nf(this)),this.panelOverlayRenderTech}}const tt=ne();class Ff extends $t{constructor(t,r,s,i,n){super(),this.text=t,this.renderTech=r,this.vao=s,this.width=i,this.height=n,this.mvpMatrix=ne(),this.worldCOM=Q(),this.comWorldMatrixVersion=1}getMVPMatrix(t){const{node:r,charHeight:s}=this.text,i=Me(this.mvpMatrix,t._getViewMatrix(),r._getWorldMatrix()),n=Math.hypot(i[0],i[1],i[2])*s,l=Math.hypot(i[4],i[5],i[6])*s,a=-this.width*n,u=this.height*l;return tt[0]=n,tt[5]=l,tt[12]=i[12]+a,tt[13]=i[13]+u,tt[14]=i[14],Me(this.mvpMatrix,t._getProjectionMatrix(),tt)}getWorldCOM(){const t=this.text.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Rr(this.worldCOM,t._getWorldMatrix())),this.worldCOM}getVAO(){return this.vao}getRenderTech(){return this.renderTech}getWorldMatrix(){throw new Error("Method not implemented.")}getWorldNormalMatrix(){throw new Error("Method not implemented.")}isMirrored(){return!1}_onAttached(){this.comWorldMatrixVersion=1}}class Wf extends et{constructor(t,r,s){super(t,s),this.textElement=null,this.textElementCreated=!1,this.color=ft(1,1,1,1),this.charHeight=1,t.movableTexts.set(this.key,this),this.caption=r,this.fontName=s?.fontName||""}destroy(){super.destroy(),this.o.movableTexts.delete(this.key)}setCharHeight(t){return this.charHeight=t,this}_onAttached(){this.textElement?._onAttached()}_setup(t){if(!this.textElementCreated&&(this.textElementCreated=!0,this.caption)){const s=this.o._getFontTexture(this.fontName),{vao:i,width:n,height:l}=ci(s.glyphData,this.caption);if(i){const a=new of(s,this);this.textElement=new Ff(this,a,i,n,l)}}const{textElement:r}=this;r&&t.textElements.add(r)}}class Vf{constructor(t,r=""){this.o=t,this.name=r,this.children=[],this.visible=!1,this.scaleX=1,this.scaleY=1,this.z=0,t.overlays.set(this.key=t.key(),this)}setChildren(t){return this.children.forEach(r=>r.overlay=null),this.children=Array.from(new Set(t)),this.children.forEach(r=>{r.overlay=this,r.parent&&(console.warn("OverlayElement has parent"),r.parent=null)}),this}setZ(t){return this.z=t,this.o.overlayQueue=null,this}setScale(t,r){return this.scaleX=t,this.scaleY=r,this}setVisible(t){return this.visible=t,this.o.overlayQueue=null,this}render(t){const{ctx:r}=t.window,{drawingBufferWidth:s,drawingBufferHeight:i}=r.gl;this.children.forEach(n=>n.drawAt(r,0,0,1,1,s,i))}}class $f{constructor(t,r){this.window=t,this.bg=ce(.2,.2,.2),this.overlaysEnabled=!0,t.o.viewports.set(this.key=t.o.key(),this),this.camera=r,r._setViewport(this)}setCamera(t){return this.camera!==t&&(this.camera._setViewport(null),this.camera=t._setViewport(this)),this}enableOverlays(t){return this.overlaysEnabled=t,this}setBackground(t,r,s){return Te(this.bg,t,r,s),this}}class jf{constructor(t,r,s,i){this.o=t,this.mouseSource=i,this.viewports=new Set,this.x=0,this.y=0,this.width=0,this.height=0,this.wheelPosition=0,this.buttonsPressed=[!1,!1,!1,!1],this.mainViewport=null,t.windows.set(this.key=t.key(),this);const n=this.view=document.createElement("canvas");this.width=n.width=r,this.height=n.height=s,n.style.pointerEvents="none";const l=n.getContext("webgl",{alpha:!1,depth:!0,antialias:!0,desynchronized:!1});this.ctx=new uf(l)}createViewport(t,r){const s=new $f(this,t);if(this.viewports.size)throw Error("Создание нескольких Viewport не реализовано");return this.mainViewport=s,this.viewports.add(s),s}keyPressed(t){if(t===0)return!1;throw console.log(`Нажата ли клавиша: ${t}`),Error()}buttonPressed(t){return this.mouseSource.keyPressed(t==="left"?1:t==="right"?2:4)}mouse(){const t=this.mouseSource.mouse,r=this.mouseSource.scene;return{x:t.x-r.x,y:t.y-r.y}}render(t){const{ctx:r}=this,{gl:s}=r;this.viewports.forEach(i=>{const{camera:n}=i;n._updateActualAspect();const{scene:l}=n,{globalLight:a,opaqueElements:u,textElements:d,transparentElements:p}=l._setup(t);if(r.reset(),s.clearColor(...i.bg,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.setLighting(l.ambient,a?.node.getWorldPosition()||ai),s.enable(s.DEPTH_TEST),u.render(r,n),s.enable(s.BLEND),p.render(r,n),s.disable(s.DEPTH_TEST),r.useBackFaces(!1),d.render(r,n),i.overlaysEnabled){let _;(_=this.o.overlayQueue)||(_=this.o.overlayQueue=[...this.o.overlays.values()].filter(T=>T.visible).sort((T,m)=>T.z-m.z)),_.forEach(T=>T.render(i))}s.disable(s.BLEND)})}}const pi=Q(),_i=Q(),Ei=Q();class Hf extends et{constructor(t,r){super(t.o,r),this.scene=t,this.projectionMatrix=ne(),this.vpMatrix=ne(),this.inverseVPMatrix=ne(),this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.vpWorldMatrixVersion=1,this.shouldUpdateInverseVPMatrix=!0,this.inverseVPWorldMatrixVersion=1,this.viewportAspect=10,this.viewport=null,this.nearDist=1,this.farDist=1e3,this.fov=Math.PI/4,this.aspect=1.3333333333333333,this.autoAspect=!0,t.o.cameras.set(this.key,this),r&&this.set(r)}destroy(){super.destroy(),this.o.cameras.delete(this.key)}useViewportAspect(){return!!this.viewport&&this.autoAspect}_setViewport(t){return this.viewport=t,this}set({farDist:t=this.farDist,fov:r=this.fov,nearDist:s=this.nearDist,aspect:i=this.aspect}){return(this.farDist!==t||this.fov!==r||this.nearDist!==s||this.aspect!==i&&!this.useViewportAspect())&&(this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.shouldUpdateInverseVPMatrix=!0),this.farDist=t,this.fov=r,this.nearDist=s,this.aspect=i,this}_updateActualAspect(){if(!this.autoAspect)return;const{view:t}=this.viewport.window,r=t.width/t.height;this.viewportAspect!==r&&(this.viewportAspect=r,this.shouldUpdateProjectionMatrix=!0)}_getViewMatrix(){return this.node?._getInverseWorldMatrix()||mf}_getProjectionMatrix(){return this.shouldUpdateProjectionMatrix&&(this.shouldUpdateProjectionMatrix=!1,Zu(this.projectionMatrix,this.fov,this.useViewportAspect()?this.viewportAspect:this.aspect,this.nearDist,this.farDist)),this.projectionMatrix}_getVPMatrix(){const{node:t}=this;return t?((this.shouldUpdateVPMatrix||this.vpWorldMatrixVersion!==t._worldMatrixVersion)&&(this.shouldUpdateVPMatrix=!1,this.vpWorldMatrixVersion=t._worldMatrixVersion,Me(this.vpMatrix,this._getProjectionMatrix(),this._getViewMatrix())),this.vpMatrix):this._getProjectionMatrix()}_getInverseVPMatrix(){const{node:t}=this,r=t?t._worldMatrixVersion:1;return(this.shouldUpdateInverseVPMatrix||this.inverseVPWorldMatrixVersion!==r)&&(this.shouldUpdateInverseVPMatrix=!1,this.inverseVPWorldMatrixVersion=r,Ks(this.inverseVPMatrix,this._getVPMatrix())),this.inverseVPMatrix}getRay(t,r,s){const i=this._getInverseVPMatrix(),n=2*t-1,l=1-2*r;return Te(pi,n,l,-1),Pe(s.origin,pi,i),Te(_i,n,l,0),Pe(Ei,_i,i),dt(s.dir,Ei,s.origin),Gt(s.dir,s.dir),s}_onAttached(){this.vpWorldMatrixVersion=1,this.inverseVPWorldMatrixVersion=1}_setup(){}}class Xf extends $t{constructor(t,r){super(),this.entity=t,this.submesh=r,this.worldCOM=Q(),this.comWorldMatrixVersion=0,this.material=null,this.vertexCount=r.getVertexCount(),this.material=r.getDefaultMaterial()}setMaterial(t){return this.material!==t&&(this.material=t,this._techOrVAOChanged()),this}_setup(t){const{material:r}=this;r&&(r._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}getWorldMatrix(){return this.entity.node._getWorldMatrix()}getWorldNormalMatrix(){return this.entity._getWorldNormalMatrix()}getWorldCOM(){const t=this.entity.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.submesh.getCOM(),t._getWorldMatrix())),this.worldCOM}getVAO(){return this.submesh.getVAO()}getRenderTech(){return this.material._getMeshRenderTech()}isMirrored(){return this.entity.node._isMirrored()}getMVPMatrix(t){return this.entity._getMVPMatrix(t)}_onAttached(){this.comWorldMatrixVersion=0}}const wi=ne();class mi extends et{constructor(t,{submeshes:r},s){super(t.o,s),this.scene=t,this.mvpMatrix=ne(),this.worldNormalMatrix=Lt(),this.normalWorldMatrixVersion=1,t.o.entities.set(this.key,this),this.subEntities=r.map(i=>new Xf(this,i))}destroy(){super.destroy(),this.o.entities.delete(this.key)}subEntity(t){return t>=0&&t<this.subEntities.length?this.subEntities[t]:null}_getMVPMatrix(t){return Me(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,qs(wi,t._getInverseWorldMatrix()),zs(this.worldNormalMatrix,wi)),this.worldNormalMatrix}_getClosestIntersection(t){let r=1/0;for(const{submesh:s}of this.subEntities){const i=s.getClosestIntersection(t);r>i&&(r=i)}return r}_onAttached(){this.normalWorldMatrixVersion=1;for(const t of this.subEntities)t._onAttached()}_setup(t){for(const r of this.subEntities)r._setup(t)}}class Yf extends mt{selectProgram(t){return t.meshPrograms[0]}apply(t){const{ctx:r}=t;r.setDepthWrite(!0),r.setDepthCheck(!0),t.setDiffuse(Rf),t.setAmbient(bf)}hasOpacity(){return!1}getProgramCaps(){return Je[0]}}const zf=new Yf;class qf extends $t{constructor(t,r,s){super(),this.object=t,this.drawType=r,this.worldCOM=Q(),this.comWorldMatrixVersion=0,this.coords=[],this.normals=[],this.isComplete=!1,this.vao=null,this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0,this.minZ=1/0,this.maxZ=-1/0,this.center=null,this.boundingSphere=null,this.vertexCount=0,this.renderTech=s?._getMeshRenderTech()||zf}addVertex(t,r,s){this.minX=Math.min(this.minX,t),this.maxX=Math.max(this.maxX,t),this.minY=Math.min(this.minY,r),this.maxY=Math.max(this.maxY,r),this.minZ=Math.min(this.minZ,s),this.maxZ=Math.max(this.maxZ,s),this.coords.push(t,r,s),++this.vertexCount}addNormal(t,r,s){this.normals.push(t,r,s)}end(){this.isComplete=!0;const{maxX:t,maxY:r,maxZ:s,minX:i,minY:n,minZ:l}=this,a=(t+i)/2,u=(r+n)/2,d=(s+l)/2;this.center=ce(a,u,d);const p=Math.max(t-i,r-n,s-l)/2;this.boundingSphere=new gi(this.center,p)}getWorldMatrix(){return this.object.node._getWorldMatrix()}getWorldNormalMatrix(){return this.object._getWorldNormalMatrix()}getWorldCOM(){const t=this.object.node;return t?(this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.center,t._getWorldMatrix())),this.worldCOM):ai}getVAO(){return this.vao?this.vao:this.vao=new Qe({positionSize:3,positions:new Float32Array(this.coords),normals:this.normals.length?new Float32Array(this.normals):null,drawMode:Af(this.drawType)})}getRenderTech(){return this.renderTech}isMirrored(){return this.object.node._isMirrored()}getMVPMatrix(t){return this.object._getMVPMatrix(t)}getClosestIntersection(t){return this.drawType!==ti||!this.isComplete||!this.boundingSphere.intersectsWith(t)?1/0:Of(t,this.coords)}_setup(t){this.isComplete&&(this.renderTech.hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}_onAttached(){this.comWorldMatrixVersion=0}}const Ti=ne();class yi extends et{constructor(t,r){super(t.o,r),this.scene=t,this.mvpMatrix=ne(),this.worldNormalMatrix=Lt(),this.normalWorldMatrixVersion=0,this.sections=[],t.o.manualObjects.set(this.key,this)}destroy(){super.destroy(),this.o.manualObjects.delete(this.key)}createSection(t,r){const s=new qf(this,t,r);return this.sections.push(s),s}clear(){this.sections=[]}_getMVPMatrix(t){return Me(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,qs(Ti,t._getInverseWorldMatrix()),zs(this.worldNormalMatrix,Ti)),this.worldNormalMatrix}_getClosestIntersection(t){let r=1/0;for(const s of this.sections){const i=s.getClosestIntersection(t);r>i&&(r=i)}return r}_onAttached(){this.normalWorldMatrixVersion=0;for(const t of this.sections)t._onAttached()}_setup(t){for(const r of this.sections)r._setup(t)}}class Kf{constructor(t){this.entries=t,this.length=t.length}getEntry(t){const{entries:r}=this;return t>=0&&t<r.length?r[t]:null}sort(){this.entries.sort((t,r)=>t.distance-r.distance)}}class Zf{constructor(t,r){this.scene=t,this.localMatrix=ne(),this.worldMatrix=ne(),this.inverseWorldMatrix=ne(),this.worldPosition=Q(),this.worldRotation=gt(),this.worldScale=ce(1,1,1),this.mirrored=!1,this.shouldUpdateLocalMatrix=!1,this.shouldUpdateWorldMatrix=!1,this.shouldUpdateInverseWorldMatrix=!1,this.shouldUpdateMirroredInfo=!1,this.shouldUpdateWorldPosition=!1,this.shouldUpdateWorldRotation=!1,this.shouldUpdateWorldScale=!1,this.position=Q(),this.scale=ce(1,1,1),this.rotation=gt(),this._worldMatrixVersion=1,this.children=[],this.parent=null,t.o.nodes.set(this.key=t.o.key(),this),this.name=r?.name??""}destroy(){this.children.forEach(t=>{t.parent=null,t.updateWorldMatrixRecursive()}),this.removeParent(),this.scene.o.nodes.delete(this.key)}getChild(t){const{children:r}=this;return t>=0&&t<r.length?r[t]:null}addChild(t){const r=t.parent;if(r){if(r===this)return this;let s=this.parent;for(;s;){if(s===t)throw Error("SceneNode.addChild: child является родительским узлом текущего узла");s=s.parent}}if(t===this)throw Error("SceneNode.addChild: child является текущим узлом");if(t.scene!==this.scene)throw Error("SceneNode.addChild: child принадлежит другой сцене");return t.removeParent(),this.children.push(t),t.parent=this,t.updateWorldMatrixRecursive(),this}updateWorldMatrixRecursive(){if(!this.shouldUpdateWorldMatrix){this.shouldUpdateWorldMatrix=!0,++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldPosition=!0,this.shouldUpdateWorldRotation=!0,this.shouldUpdateWorldScale=!0;for(const t of this.children)t.updateWorldMatrixRecursive()}}updateLocalMatrix(){this.shouldUpdateLocalMatrix||(this.shouldUpdateLocalMatrix=!0,this.updateWorldMatrixRecursive())}updateChildrenMirroredInfoRecursive(){if(!this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!0;for(const t of this.children)t.updateChildrenMirroredInfoRecursive()}}updateMirroredInfo(){if(this.shouldUpdateMirroredInfo)return;const{scale:t}=this;if(this.mirrored!==Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0){this.shouldUpdateMirroredInfo=!0;for(const r of this.children)r.updateChildrenMirroredInfoRecursive()}}removeParent(){const t=this.parent;return t?(t.children=t.children.filter(r=>r!==this),this.parent=null,this):this}setPosition(t,r,s){return Te(this.position,t,r,s),this.updateLocalMatrix(),this}setRotation(t,r,s,i){return Sr(this.rotation,md(this.rotation,t,r,s,i)),this.updateLocalMatrix(),this}resetRotation(){return fd(this.rotation),this.updateLocalMatrix(),this}rotateX(t){return pd(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateY(t){return _d(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateZ(t){return Ed(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}setScale(t,r,s){return Te(this.scale,t,r,s),this.updateLocalMatrix(),this.updateMirroredInfo(),this}_getWorldMatrixForRotation(){++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldRotation=!0;for(const t of this.children)t.updateWorldMatrixRecursive();return this.worldMatrix}_getWorldMatrix(){return this.shouldUpdateWorldMatrix&&(this.shouldUpdateWorldMatrix=!1,this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,Js(this.localMatrix,this.rotation,this.position,this.scale)),this.parent?Me(this.worldMatrix,this.parent._getWorldMatrix(),this.localMatrix):Hu(this.worldMatrix,this.localMatrix)),this.worldMatrix}_getInverseWorldMatrix(){return this.shouldUpdateInverseWorldMatrix&&(this.shouldUpdateInverseWorldMatrix=!1,Ks(this.inverseWorldMatrix,this._getWorldMatrix())),this.inverseWorldMatrix}_isMirrored(){if(this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!1;const{scale:t}=this;this.mirrored=Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0,this.parent?._isMirrored()&&(this.mirrored=!this.mirrored)}return this.mirrored}getWorldPosition(){return this.shouldUpdateWorldPosition&&(this.shouldUpdateWorldPosition=!1,Rr(this.worldPosition,this._getWorldMatrix())),this.worldPosition}getWorldRotation(){return this.shouldUpdateWorldRotation&&(this.shouldUpdateWorldRotation=!1,qu(this.worldRotation,this._getWorldMatrix())),this.worldRotation}getWorldScale(){return this.shouldUpdateWorldScale&&(this.shouldUpdateWorldScale=!1,Zs(this.worldScale,this._getWorldMatrix())),this.worldScale}}const Cr=Q(),bi=Q(),Jf=Q(),Ht=Br(),Tt=Q();class Ri extends Zf{constructor(t,r){super(t,r),this.trackingInfo=null,this.movables=[],t.o.sceneNodes.set(this.key,this)}destroy(){super.destroy(),this.movables.forEach(t=>t.node=null),this.scene.o.sceneNodes.delete(this.key)}getMovable(t){const{movables:r}=this;return t>=0&&t<r.length?r[t]:null}attach(t){const r=t.node;if(r){if(r===this)return this;t.detach()}return this.movables.push(t),t.node=this,t._onAttached(this),this}setAutoTracking(t,r,s,i){if(!t)return this.trackingInfo=null,this;let n,l;const{trackingInfo:a}=this;if(a){if(n=a.direction,l=a.orientationMat,a.target===t&&n[0]===r&&n[1]===s&&n[2]===i)return this;Te(n,r,s,i)}else n=ce(r,s,i),l=ne();Gt(Cr,n);const u=cd(Cr,hi);return Ze(bi,Cr,hi),zu(l,u,bi),this.trackingInfo={target:t,direction:n,orientationMat:l},this}updateTracking(){const{parent:t,trackingInfo:r}=this;if(!r||!t)return;const s=this.getWorldScale(),i=this._getWorldMatrixForRotation();Ju(i,this.getWorldPosition(),r.target.getWorldPosition(),Pe(Jf,yf,t._getWorldMatrix())),Me(i,i,r.orientationMat),Yu(i,i,s)}_setup(t){this.updateTracking();for(const r of this.movables)r.visible&&r._setup(t);for(const r of this.children)r._setup(t)}_findIntersections(t,r){let s=!1;for(const i of this.movables){if(!(i instanceof mi||i instanceof yi))continue;s||(s=!0,Sf(Ht,t,this._getInverseWorldMatrix()));const n=i._getClosestIntersection(Ht);if(n<1/0){ed(Tt,Ht.origin,sd(Tt,Ht.dir,n)),Pe(Tt,Tt,this._getWorldMatrix());const l=ad(t.origin,Tt);r.push({movable:i,distance:l})}}for(const i of this.children)i._findIntersections(t,r)}}class Qf{constructor(t){this.o=t,this.renderInfo={globalLight:null,opaqueElements:new Ef,transparentElements:new li,textElements:new li},this.frameNumber=0,this.ambient=Q(),t.scenes.set(this.key=t.key(),this),this.root=new Ri(this)}setAmbient(t,r,s){return Te(this.ambient,t,r,s),this}createSceneNode(t){return new Ri(this,t)}createCamera(t){return new Hf(this,t)}createEntity(t,r){return new mi(this,t,r)}createManualObject(t){return new yi(this,t)}_setup(t){if(this.frameNumber===t)return this.renderInfo;this.frameNumber=t;const{renderInfo:r}=this;return r.globalLight=null,r.opaqueElements.clear(),r.transparentElements.clear(),r.textElements.clear(),this.root._setup(r),r}rayCast(t){const r=[];return this.root._findIntersections(t,r),new Kf(r)}}class eg{constructor(){this.windows=new Map,this.scenes=new Map,this.viewports=new Map,this.overlays=new Map,this.overlayElements=new Map,this.entities=new Map,this.manualObjects=new Map,this.nodes=new Map,this.sceneNodes=new Map,this.movables=new Map,this.cameras=new Map,this.billboardSets=new Map,this.lights=new Map,this.movableTexts=new Map,this.materialByKey=new Map,this.materialByName=new Map,this.techniques=new Map,this.passes=new Map,this.texUnits=new Map,this.imageResByNameUC=new Map,this.meshResByNameUC=new Map,this.primaryWindow=null,this.overlayQueue=null,this.fontMap=new Map,this.globalKey=1e3,this.drawNumber=0}_getFontTexture(t){const r=t||"sans-serif",s=r.toUpperCase(),i=this.fontMap.get(s);if(i)return i;const n=new af(r);return this.fontMap.set(s,n),n}key(){return++this.globalKey}createRenderWindow(t,r,s){const i=new jf(this,t,r,s);return this.primaryWindow||=i,i}createScene(){return new Qf(this)}createMovableText(t,r){return new Wf(this,t,r)}createLight(t){return new Lf(this,t)}createBillboardSet(t){return new xf(this,t)}createMaterial(t){return new Uf(this,t)}createOverlayElement(t,r){switch(t){case"Panel":return new gf(this,r);case"BorderPanel":return new pf(this,r);case"TextArea":return new _f(this,r);default:throw Error(`createOverlayElement: тип '${t}' не реализован`)}}createOverlay(t){return new Vf(this,t)}createMesh(t,r){const s=new kf(this,t);return this.meshResByNameUC.set(r.toUpperCase(),s),s}createImage(t,r){const s=new Pf(t);return this.imageResByNameUC.set(r.toUpperCase(),s),s}renderAll(){const t=++this.drawNumber;this.windows.forEach(r=>r.render(t))}}const Oi=new Set;function q(...e){Oi.size!==Oi.add(e[0]).size&&console.warn(...e)}function tg(e,t,r,s,i){if(!this.kernel.egor.scenes.get(e))return 0;const l=this.kernel.egor.manualObjects.get(t);if(!l)return 0;const a=l.sections[0];return a.addVertex(r,s,i),a.vertexCount}function rg(e,t,r,s,...i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function sg(e,t,r,s,...i){throw q("ApplyTexture3d",e,t,r,s,i),Error("ApplyTexture3d: Функция не реализована")}function ig(e,t,r,s,i,n){if(!this.kernel.egor.scenes.get(e))return 0;const a=this.kernel.egor.cameras.get(t);return a?this.kernel.egor.createRenderWindow(1e3,1e3,{}).createViewport(a).key:0}function ng(e,t,r,s,i,n,l,a,u,d,p,_,T){const m=this.kernel.egor.scenes.get(e);return m?m.createCamera().key:0}function og(e,t){throw q("CreateDefCamera3d",e,t),Error("CreateDefCamera3d: Функция не реализована")}function cg(e,t,r,s,i,n,l,a,u,d){throw q("CreateMaterial3d",e,t,r,s,i,n,l,a,u,d),Error("CreateMaterial3d: Функция не реализована")}function lg(e){const t=this.kernel.egor.scenes.get(e);if(!t)return 0;const r=t.createManualObject();return r.createSection(ti,null),r.key}function ag(e,t){throw q("CreateObjectFromFile3d",e,t),Error("CreateObjectFromFile3d: Функция не реализована")}function hg(e){return this.kernel.egor.createScene().key}function ug(e,t,r,s,i,n){throw q("CreateSurface3d",e,t,r,s,i,n),Error("CreateSurface3d: Функция не реализована")}function dg(e,t,r){throw q("DelPoint3d",e,t,r),Error("DelPoint3d: Функция не реализована")}function fg(e,t,r){throw q("DelPrimitive3d",e,t,r),Error("DelPrimitive3d: Функция не реализована")}function gg(e){throw q("DeleteSpace3d",e),Error("DeleteSpace3d: Функция не реализована")}function pg(e,t){throw q("DuplicateObject3d",e,t),Error("DuplicateObject3d: Функция не реализована")}function _g(e,t,r,s){throw q("FitToCamera3d",e,t,r,s),Error("FitToCamera3d: Функция не реализована")}function Eg(e,t){throw q("GetActiveCamera3d",e,t),Error("getActiveCamera3d: Функция не реализована")}function wg(e,t,r,s,i){throw q("GetColors3d",e,t,r,s,i),Error("GetColors3d: Функция не реализована")}function mg(e,t){throw q("GetMaterialByName3d",e,t),Error("GetMaterialByName3d: Функция не реализована")}function Tg(e,t){throw q("GetNumPoints3d",e,t),Error("GetNumPoints3d: Функция не реализована")}function yg(e,t){throw q("GetNumPrimitives3d",e,t),Error("GetNumPrimitives3d: Функция не реализована")}function bg(e,t,r,s,i,n,l,a){throw q("GetObject3dFromPoint2d",e,t,r,s,n,a),Error("GetObject3dFromPoint2d: Функция не реализована")}function Rg(e,t,r,s,i,n,l,a){throw q("GetObjectBase3d",e,t,s,n,a),Error("GetObjectBase3d: Функция не реализована")}function Og(e,t,r){throw q("GetObjectBase3dM",e,t,r),Error("GetObjectBase3dM: Функция не реализована")}function Mg(e,t){throw q("GetObjectColor3d",e,t),Error("GetObjectColor3d: Функция не реализована")}function vg(e,t,r){throw q("GetObjectDimension3d",e,t,r),Error("GetObjectDimension3d: Функция не реализована")}function Sg(e,t,r){return r}function Ag(e,t,r){throw q("GetObjectPoints3d",e,t,r),Error("GetObjectPoints3d: Функция не реализована")}function Ng(e,t,r,s,i,n,l,a,u){throw q("GetPoint3d",e,t,r,i,l,u),Error("GetPoint3d: Функция не реализована")}function Ig(e,t){throw q("GetSpace3d",e,t),Error("getSpace3d: Функция не реализована")}function xg(e,t,r,s,i){const n=this.kernel.egor.scenes.get(e);return n?n.createManualObject().key:0}function Pg(e,t,r,s,i,n,l,a){throw q("MakeCylinder3d",e,t,r,s,i,n,l,a),Error("MakeCylinder3d: Функция не реализована")}function Dg(e,t,r,s,i,n){throw q("MakeGrid3d",e,t,r,s,i,n),Error("MakeGrid3d: Функция не реализована")}function kg(e,t,r,s,i,n){throw q("MakeSphere3d",e,t,r,s,i,n),Error("MakeSphere3d: Функция не реализована")}function Lg(){q("MakeTore3d")}function Gg(e,t,r,s,i,n,l,a){throw q("MakeTube3d",e,t,r,s,i,n,l,a),Error("MakeTube3d: Функция не реализована")}function Bg(e){throw q("PopCrdSystem3d",e),Error("PopCrdSystem3d: Функция не реализована")}function Cg(e){throw q("PushCrdSystem3d",e),Error("PushCrdSystem3d: Функция не реализована")}function Ug(e,t){throw q("RemoveTexture3d",e,t),Error("RemoveTexture3d: Функция не реализована")}function Fg(e,t,r,s){throw q("RotateObject3d",e,t,r,s),Error("RotateObject3d: Функция не реализована")}function Wg(e,t,r,s){throw q("RotateObjectPoints3d",e,t,r,s),Error("RotateObjectPoints3d: Функция не реализована")}function Vg(e,t){throw q("SelectLocalCrd3d",e,t),Error("SelectLocalCrd3d: Функция не реализована")}function $g(e,t){throw q("SelectViewCrd3d",e,t),Error("SelectViewCrd3d: Функция не реализована")}function jg(e){throw q("SelectWorldCrd3d",e),Error("SelectWorldCrd3d: Функция не реализована")}function Hg(e,t,r,s,i){throw q("SetColors3d",e,t,r,s,i),Error("SetColors3d: Функция не реализована")}function Xg(e,t,r,s,i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function Yg(e,t,r){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function zg(e,t,r){throw q("SetObjectMatrix3d",e,t,r),Error("SetObjectMatrix3d: Функция не реализована")}function qg(e,t,r){throw q("SetObjectPoints3d",e,t,r),Error("SetObjectPoints3d: Функция не реализована")}function Kg(e,t,r,s,i,n){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function Zg(e,t,r,s,i,...n){return 1}function Jg(e,t,r,s,i,n,l,a,u,d,p){throw q("SweepAndExtrude3d",e,t,r,s,i,n,l,a,u,d,p),Error("SweepAndExtrude3d: Функция не реализована")}function Qg(){q("SwitchToCamera3d")}function ep(e,t,r,s,i,n){throw q("TransformCamera3d",e,t,r,s,i,n),Error("TransformCamera3d: Функция не реализована")}function tp(e,t,r){throw q("TransformObject3d",e,t,r),Error("TransformObject3d: Функция не реализована")}function rp(e,t,r){throw q("TransformObjectPoints3d",e,t,r),Error("TransformObjectPoints3d: Функция не реализована")}function sp(e,t,r,s){return!this.kernel.egor.scenes.get(t)||!this.kernel.egor.cameras.get(r)?0:1}function ip(e){e("AddPoint3d",{a:[c,c,o,o,o],r:o},tg),e("AddPrimitive3d",{a:[c,c,o,z],rest:[o],r:o},rg),e("ApplyTexture3d",{a:[c,c,c,c],rest:[o],r:o},sg),e("Create3dView2d",{a:[c,c,o,o,o,o],r:c},ig),e("CreateCamera3dEx",{a:[c,E,o,o,z,o,o,o,o,o,o,o,o],r:c},ng),e("CreateDefCamera3d",{a:[c,o],r:c},og),e("CreateMaterial3d",{a:[c,E,E,z,z,z,z,o,o,o],r:c},cg),e("CreateObject3d",{a:[c],r:c},lg),e("CreateObjectFromFile3d",{a:[c,E],r:c},ag),e("CreateSpace3d",{a:[c],r:c},hg),e("CreateSurface3d",{a:[c,c,o,o,z,o],r:c},ug),e("DelPoint3d",{a:[c,c,o],r:o},dg),e("DelPrimitive3d",{a:[c,c,o],r:o},fg),e("DeleteSpace3d",{a:[c],r:o},gg),e("DuplicateObject3d",{a:[c,c],r:c},pg),e("FitToCamera3d",{a:[c,c,c,o],r:o},_g),e("GetActiveCamera3d",{a:[c,c],r:c},Eg),e("GetColors3d",{a:[c,c,o,o,o],r:o},wg),e("GetMaterialByName3d",{a:[c,E],r:c},mg),e("GetNumPoints3d",{a:[c,c],r:o},Tg),e("GetNumPrimitives3d",{a:[c,c],r:o},yg),e("GetObject3dFromPoint2d",{a:[c,c,o,o,Gc,A],r:c},bg),e("GetObjectBase3d",{a:[c,c,A,A,A],r:o},Rg),e("GetObjectBase3dM",{a:[c,c,o],r:o},Og),e("GetObjectColor3d",{a:[c,c],r:z},Mg),e("GetObjectDimension3d",{a:[c,c,o],r:o},vg),e("GetObjectMatrix3d",{a:[c,c,o],r:o},Sg),e("GetObjectPoints3d",{a:[c,c,o],r:o},Ag),e("GetPoint3d",{a:[c,c,o,A,A,A],r:o},Ng),e("GetSpace3d",{a:[c,c],r:c},Ig),e("MakeBar3d",{a:[c,z,o,o,o],r:c},xg),e("MakeCylinder3d",{a:[c,c,z,o,o,o,o,o],r:c},Pg),e("MakeGrid3d",{a:[c,o,o,o,o,z],r:c},Dg),e("MakeSphere3d",{a:[c,c,z,o,o,o],r:c},kg),e("MakeTore3d",{a:[]},Lg),e("MakeTube3d",{a:[c,c,z,o,o,o,o,o],r:c},Gg),e("PopCrdSystem3d",{a:[c],r:o},Bg),e("PushCrdSystem3d",{a:[c],r:o},Cg),e("RemoveTexture3d",{a:[c,c],r:o},Ug),e("RotateObject3d",{a:[c,c,o,o],r:o},Fg),e("RotateObjectPoints3d",{a:[c,c,o,o],r:o},Wg),e("SelectLocalCrd3d",{a:[c,c],r:o},Vg),e("SelectViewCrd3d",{a:[c,c],r:o},$g),e("SelectWorldCrd3d",{a:[c],r:o},jg),e("SetColors3d",{a:[c,c,o,o,o],r:o},Hg),e("SetObjectBase3d",{a:[c,c,o,o,o],r:o},Xg),e("SetObjectColor3d",{a:[c,c,z],r:o},Yg),e("SetObjectMatrix3d",{a:[c,c,o],r:o},zg),e("SetObjectPoints3d",{a:[c,c,o],r:o},qg),e("SetPoint3d",{a:[c,c,o,o,o,o],r:o},Kg),e("SetPrimitive3d",{a:[c,c,o,o,z],rest:[o],r:o},Zg),e("SweepAndExtrude3d",{a:[c,c,o,o,o,o,o,o,o,z,o],r:c},Jg),e("SwitchToCamera3d",{a:[]},Qg),e("TransformCamera3d",{a:[c,c,o,o,o,o],r:o},ep),e("TransformObject3d",{a:[c,c,o],r:o},tp),e("TransformObjectPoints3d",{a:[c,c,o],r:o},rp),e("_CameraProc3d",{a:[E,c,c,o],r:o},sp)}const np={name:"graphics3d",deps:["ogre"],register:ip};class Se{constructor(t){this.minV=Math.floor(t.minV),this.minH=Math.floor(t.minH),this.rows=t.rows,this.cols=t.cols,this.m=t.data?new Float64Array(t.data):new Float64Array(this.rows*this.cols)}isSquare(){return this.cols===this.rows}get(t,r){const s=Math.floor(t)-this.minV,i=Math.floor(r)-this.minH;return s<0||i<0||s>=this.rows||i>=this.cols?0:this.m[s*this.cols+i]}set(t,r,s){const i=Math.floor(t)-this.minV,n=Math.floor(r)-this.minH;return i<0||n<0||i>=this.rows||n>=this.cols?0:(this.m[i*this.cols+n]=s,s)}sum(){return this.m.reduce((t,r)=>t+r,0)}glue(t,r,s){const i=this,n=Math.min(i.minH,t.minH+s),l=Math.min(i.minV,t.minV+r),a=Math.max(i.cols+i.minH,t.cols+t.minH+s),u=Math.max(i.rows+i.minV,t.rows+t.minV+r),d=new Se({cols:a-n,rows:u-l,minH:n,minV:l});for(let p=t.minV;p<t.rows+t.minV;p++)for(let _=t.minH;_<t.cols+t.minH;_++)d.set(p+r,_+s,t.get(p,_));for(let p=i.minV;p<i.rows+i.minV;p++)for(let _=i.minH;_<i.cols+i.minH;_++)d.set(p,_,i.get(p,_));return d}add(t){const r=this,s=Math.min(r.minH,t.minH),i=Math.min(r.minV,t.minV),n=Math.max(r.cols+r.minH,t.cols+t.minH),a=Math.max(r.rows+r.minV,t.rows+t.minV)-i,u=n-s,d=new Se({cols:u,rows:a,minH:s,minV:i}),p=Math.min(r.rows,t.rows),_=Math.min(r.cols,t.cols);for(let T=0;T<p;T++)for(let m=0;m<_;m++)d.m[T+u+m]=r.m[T*r.cols+m]+t.m[T+t.cols+m];return d}mul(t){const r=this;if(r.cols!==t.rows)return null;const s=t.cols,i=r.rows,n=new Se({cols:s,rows:i,minH:r.minH,minV:r.minV});for(let l=0;l<i;l++)for(let a=0;a<s;a++){let u=0;for(let d=0;d<r.cols;d++)u+=r.m[l*r.cols+d]*t.m[d*t.cols+a];n.m[l*s+a]=u}return n}det(){if(!this.isSquare())throw Error("Not a square matrix");const t=this.rows;if(t===1)return this.m[0];if(t===2)return this.m[0]*this.m[3]-this.m[1]*this.m[2];const r=Array.from(this.m);let s=1;for(let i=0;i<t;i++){let n=i,l=Math.abs(r[i*t+i]);for(let a=i+1;a<t;a++){const u=Math.abs(r[a*t+i]);u>l&&(l=u,n=a)}if(l===0)return 0;if(n!==i){s=-s;for(let a=i;a<t;a++){const u=r[i*t+a];r[i*t+a]=r[n*t+a],r[n*t+a]=u}}for(let a=i+1;a<t;a++){const u=r[a*t+i]/r[i*t+i];for(let d=i;d<t;d++)r[a*t+d]-=u*r[i*t+d]}s*=r[i*t+i]}return s}obr(){if(!this.isSquare()||this.det()===0)return null;const t=this.rows,r=new Se({cols:this.cols,rows:this.rows,minH:0,minV:0,data:Array.from(this.m)}),s=new Se({cols:this.cols,rows:this.rows,minH:0,minV:0});for(let i=0;i<t;i++)for(let n=0;n<t;n++)s.set(i,n,0),i===n&&s.set(i,n,1);for(let i=0;i<t;i++){let n=r.get(i,i);for(let l=0;l<t;l++)r.set(i,l,r.get(i,l)/n),s.set(i,l,s.get(i,l)/n);for(let l=i+1;l<t;l++){n=r.get(l,i);for(let a=0;a<t;a++)r.set(l,a,r.get(l,a)-r.get(i,a)*n),s.set(l,a,s.get(l,a)-s.get(i,a)*n)}}for(let i=t-1;i>0;i--)for(let n=i-1;n>=0;n--){let l=r.get(n,i);for(let a=0;a<t;a++)r.set(n,a,r.get(n,a)-r.get(i,a)*l),s.set(n,a,s.get(n,a)-s.get(i,a)*l)}return s.minH=this.minH,s.minV=this.minV,s}diag(t){this.fill(0);const r=Math.min(this.rows,this.cols);for(let s=0;s<r;s++)this.set(s,s,t);return 1}fill(t){return this.m.fill(t),1}sortByRow(t,r){const s=t-this.minV;if(s<0||s>=this.rows)return 0;const i=Array.from({length:this.cols},(l,a)=>Array.from({length:this.rows},(u,d)=>this.m[d*this.cols+a])),n=r?(l,a)=>a[s]-l[s]:(l,a)=>l[s]-a[s];return i.sort(n),i.forEach((l,a)=>{l.forEach((u,d)=>{this.m[d*this.cols+a]=u})}),1}sortByColumn(t,r){const s=t-this.minH;if(s<0||s>=this.cols)return 0;const i=Array.from({length:this.rows},(l,a)=>{const u=a*this.cols,d=u+this.cols;return Array.from(this.m.subarray(u,d))}),n=r?(l,a)=>a[s]-l[s]:(l,a)=>l[s]-a[s];return i.sort(n),this.m=new Float64Array(ns(i)),1}data(){const{minH:t,minV:r,cols:s,rows:i,m:n}=this;return{minV:r,minH:t,cols:s,rows:i,data:[...n]}}}function op(e,t,r,s,i,n){if(n<=0)return 0;const l=Math.floor(r)-Math.floor(t)+1,a=Math.floor(i)-Math.floor(s)+1;if(l<=0||a<=0)return 0;const u=e||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(u,new Se({rows:l,cols:a,minV:t,minH:s})),u}function cp(e,t){return t<=0?0:this.kernel.matrices.delete(e)?1:0}function lp(e,t,r){return r<=0?0:this.kernel.matrices.get(e)?.fill(t)??0}function ap(e,t,r,s){return s<=0?0:this.kernel.matrices.get(e)?.get(t,r)??0}function hp(e,t,r,s,i){return i<=0?0:this.kernel.matrices.get(e)?.set(t,r,s)??0}function up(e,t){if(t<=0)return 0;throw Error("MEditor: редактор матриц не реализован")}function dp(e,t,r){return r<=0?0:this.kernel.matrices.get(e)?.diag(t)??0}function fp(e,t){if(t<=0)return 0;const r=this.kernel.matrices.get(e);return!r||!r.isSquare()?0:r.det()}function gp(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;const n=this.kernel.matrices.get(t);if(!n)return 0;const l=i.add(n);if(!l)return 0;const a=r||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(a,l),a}function pp(e,t){return t<=0?0:this.kernel.matrices.get(e)?.sum()??0}function _p(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e),n=this.kernel.matrices.get(t);if(!i||!n)return 0;const l=i.mul(n);if(!l)return 0;const a=r||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(a,l),a}function Ep(e,t,r,s,i,n){if(n<=0)return 0;const l=this.kernel.matrices.get(e),a=this.kernel.matrices.get(t);if(!l||!a)return 0;const u=r||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(u,l.glue(a,Math.floor(s),Math.floor(i))),u}function wp(e,t,r){if(r<=0)return 0;const s=this.kernel.matrices.get(e);if(!s)return 0;const i=s.obr();if(!i)return 0;const n=t||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(n,i),n}function mp(e,t,r){if(r<=0)return 0;const s=this.kernel.matrices.get(e);if(!s)return 0;const i=this.prj.dir.resolve(t).create("file");return i?(i.set({mat:s.data()}),1):0}function Tp(e,t,r){if(r<=0)return 0;const s=this.prj.dir.resolve(t).file()?.mat;if(!s)return 0;const i=e||ue.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(i,new Se(s)),i}function yp(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;switch(r){case 1:return i.sortByColumn(t,!1);case 2:return i.sortByColumn(t,!0);case 3:return i.sortByRow(t,!1);case 4:return i.sortByRow(t,!0);default:return 0}}function bp(e){e("MCreate",{a:[o,o,o,o,o,o],r:o},op),e("MDelete",{a:[o,o],r:o},cp),e("MFill",{a:[o,o,o],r:o},lp),e("MGet",{a:[o,o,o,o],r:o},ap),e("MPut",{a:[o,o,o,o,o],r:o},hp),e("MEditor",{a:[o,o]},up),e("MDiag",{a:[o,o,o],r:o},dp),e("MDet",{a:[o,o],r:o},fp),e("MSum",{a:[o,o],r:o},pp),e("MMul",{a:[o,o,o,o],r:o},_p),e("MGlue",{a:[o,o,o,o,o,o],r:o},Ep),e("MObr",{a:[o,o,o],r:o},wp),e("MSaveAs",{a:[o,E,o],r:o},mp),e("MLoad",{a:[o,E,o],r:o},Tp),e("MSort",{a:[o,o,o,o],r:o},yp),e("MAddC",{a:[o,o,o,o],r:o},gp)}const Rp={name:"matrix",register:bp,setup(e){e.matrices=new Map,e.onProjectOpen.add(t=>{t.dir.forEach(r=>{if(!r.mat)return;const s=r.path.basename(),i=parseInt(s.substring(0,s.length-5));isNaN(i)||!i||e.matrices.has(i)||e.matrices.set(i,new Se(r.mat))},!1)})}};function Mi(e,t,r,s,i){const n=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!n)return;const l=this.resolve(r);l?.klass.vars.msg&&n.subscribe(l,s,t,i)}function vi(e,t,r){const s=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!s)return;const i=this.resolve(t);i?.klass.vars.msg&&s.unsubscribe(i,r)}function Op(e,t){const r=this.kernel.scenes.get(e);if(!r)return;const s=this.resolve(t);s?.klass.vars.msg&&r.setCapture(s)}function Mp(){this.kernel.windowSystem.releaseCapture()}function vp(e,t,...r){if(this.kernel.recursionLvl>58)return;let s=null;if(t&&(s=this.kernel.classes.get(t),!s))return;/[\*\?]/.test(e)&&this.kernel._functionNotImplemented("SendMessage с path содержащим '*'/'?'",this);const i=this.resolveMany(e,s);if(!i.length)return;const n=new Array(r.length),l=this.klass.vars,a=i[0].klass.vars;for(let u=0;u<r.length;u+=2){const d=l.get(r[u+0]);if(!d)continue;const p=a.get(r[u+1]);p&&(n[u+0]=d,n[u+1]=p)}i.forEach(u=>{if(u===this)return;for(let O=0;O<n.length;O+=2){const k=n[O+0];if(!k)continue;const L=n[O+1];u.setVarValue(L,this.getVarValue(k))}++this.kernel.recursionLvl,u.computeSchema(),--this.kernel.recursionLvl;const{map:d,values:{newFloats:p,oldFloats:_,newInts:T,oldInts:m,newStrings:R,oldStrings:N}}=u;for(let O=0;O<d.length;++O){const k=d[O];_[k]=p[k],m[k]=T[k],N[k]=R[k]}for(let O=0;O<n.length;O+=2){const k=n[O+0];if(!k)continue;const L=n[O+1];this.setNewValue(k,u.getVarValue(L))}})}function Sp(e){e("RegisterObject",{s:!0,a:[c,c,E,o,o]},Mi),e("RegisterObject",{s:!0,a:[E,c,E,o,o]},Mi),e("UnregisterObject",{s:!0,a:[c,E,o]},vi),e("UnregisterObject",{s:!0,a:[E,E,o]},vi),e("SetCapture",{s:!0,a:[c,E,o]},Op),e("ReleaseCapture",{},Mp),e("SendMessage",{s:!0,a:[E,E],rest:[E,E]},vp)}const Ap={name:"messages",deps:["windows"],register:Sp,setup(e){e.recursionLvl=0}};function Np(e){if(!e)return 0;const t=_e.indexOf(e[0]);return t<0?0:t}function Ip(e){return e<0||e>255?"":_e[e]}function xp(e,t,r){switch(r){case r&x.MB_OK:return alert(e),1;case r&x.MB_OKCANCEL:return confirm(e)?1:2;case r&x.MB_YESNO:return confirm(e)?6:7;default:return 0}}function Si(e,t,r=1){e[t]+=r}function Ai(e,t,r=1){e[t]-=r}function Pp(){}function Dp(e,t){return this.kernel._functionNotImplemented("DialogBox"),1}function kp(e,t,r){throw Error("ChoseFolderDialog: Not implemented")}function Lp(e){return e>1?0:e<-1?Math.PI:Math.acos(e)||0}function Gp(e){return e>1?Math.PI/2:e<-1?-Math.PI/2:Math.asin(e)||0}function Bp(e,t,r){return e.split(t).join(r)}function Cp(e,t,r){return e.substring(0,r)===t.substring(0,r)?1:0}function Up(e,t){return t===0?e>=0?0:Math.PI:t>0?-Math.atan(e/t)+Math.PI/2:-Math.atan(e/t)+Math.PI*1.5}function Fp(e){return e>0?(Math.log(e)||0)/Math.LN10:-1e100}function Wp(e){return e>0?Math.log(e)||0:-1e100}function Vp(e,t){return e>0&&t>0?Math.log(t)/Math.log(e)||0:-1e100}function $p(e,t,r){if(t==="")return-1;for(var s=-1,i=0,n=0;n<r;++n){if(s=e.indexOf(t,i),s<0)return-1;i=s+t.length}return s}function jp(e,t){return e.substring(e.length-t)}function Hp(e,t){var r=Math.ceil(10**t);return Math.round(e*r-Number.EPSILON)/r||0}function Xp(e,t){return e.substring(t)}function Yp(e,t,r){return e.substring(t,Math.max(t,0)+r)}function zp(e){e("Ascii",{a:[E],r:o},Np),e("Chr",{a:[o],r:E},Ip),e("MessageBox",{a:[E,E,o],r:o},xp),e("DialogBox",{a:[E,c],r:1},Dp),e("ChoseFolderDialog",{a:[E,E,o],r:E},kp),e("Inc",{a:[A]},Si),e("Inc",{a:[A,o]},Si),e("Dec",{a:[A]},Ai),e("Dec",{a:[A,o]},Ai),e("Randomize",{a:[o]},Pp),e("Arccos",{a:[o],r:o},Lp),e("Arcsin",{a:[o],r:o},Gp),e("Change",{a:[E,E,E],r:E},Bp),e("Comparei",{a:[E,E,o],r:o},Cp),e("GetangleByXy",{a:[o,o],r:o},Up),e("Lg",{a:[o],r:o},Fp),e("Ln",{a:[o],r:o},Wp),e("Log",{a:[o,o],r:o},Vp),e("Pos",{a:[E,E,o],r:o},$p),e("Right",{a:[E,o],r:E},jp),e("Round",{a:[o,o],r:o},Hp),e("Substr",{a:[E,o],r:E},Xp),e("Substr",{a:[E,o,o],r:E},Yp)}const qp={name:"misc",register:zp};function Kp(e){const t=this.prj.dir.resolve(e).file()?.video;if(!t)return 0;const r=ue.freeKey(this.kernel.videos);return this.kernel.videos.set(r,t),r}function Zp(e,t,r,s,i,n){const l=this.kernel.videos.get(t);if(!l)return 0;const a=this.kernel.scenes.get(e);if(!a)return 0;const u=a.scene;let d=r,p=s;const _=a.matrix;if(_){const R=r*_[2]+s*_[5]+_[8];d=(r*_[0]+s*_[3]+_[6])/R,p=(r*_[1]+s*_[4]+_[7])/R}const T=i>=0||n>=0,m=u.video(We(l.src),{x:d,y:p,width:Math.max(0,i),height:Math.max(0,n),fixed:T});return u.set({order:u.order.concat(m)}),m.key}function Jp(e,t){throw Error("videoSetPos2d: Not implemented")}function Qp(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"?r.getPosition()*Is:0}function e_(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.setPosition(r/Is)?1:0}function t_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.play()?1:0}function r_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.pause()?1:0}function s_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.play()?1:0}function i_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.stop()?1:0}function n_(){return x.MCIERR_INVALID_DEVICE_NAME}function o_(){return""}function c_(){return 0}function l_(e){e("OpenVideo",{a:[E,o],r:c},Kp),e("CreateVideoFrame2d",{a:[c,c,o,o,o,o,o],r:c},Zp),e("VideoSetPos2d",{a:[c,o],r:o},Jp),e("FrameGetPos2d",{a:[c,c],r:o},Qp),e("FrameSetPos2d",{a:[c,c,o],r:o},e_),e("VideoPlay2d",{a:[c,c,o,o,o,o],r:o},t_),e("VideoPause2d",{a:[c,c],r:o},r_),e("VideoResume2d",{a:[c,c],r:o},s_),e("VideoStop2d",{a:[c,c],r:o},i_),e("MciSendString",{a:[E],r:o},n_),e("MciSendStringStr",{a:[E],r:E},o_),e("SndPlaySound",{a:[E,o],r:o},c_)}const a_={name:"multimedia",deps:["windows"],register:l_,setup(e){e.videos=new Map}};let h_=0,u_=0,d_=0,f_=0,g_=0,p_=0,__=0,E_=0;const Ni=new Set;function b(...e){Ni.size!==Ni.add(e[0]).size&&console.warn(...e)}const w_=Br(),Ur=Br();function m_(e,t){b("AnimationState_AddTime",e,t)}function T_(e){throw b("AnimationState_GetEnabled",e),Error("Not implemented")}function y_(e){throw b("AnimationState_GetLength",e),Error("Not implemented")}function b_(e){throw b("AnimationState_GetLoop",e),Error("Not implemented")}function R_(e){throw b("AnimationState_GetTimePosition",e),Error("Not implemented")}function O_(e){throw b("AnimationState_GetWeight",e),Error("Not implemented")}function M_(e,t){b("AnimationState_SetEnabled",e,t)}function v_(e,t){b("AnimationState_SetLength",e,t)}function S_(e,t){b("AnimationState_SetLoop",e,t)}function A_(e,t){b("AnimationState_SetTimePosition",e,t)}function N_(e,t){b("AnimationState_SetWeight",e,t)}function I_(e,t,r,s,i){throw b("Billboard_GetColour",e,t,r,s,i),Error("Not implemented")}function x_(e,t,r,s){throw b("Billboard_GetPosition",e),Error("Not implemented")}function P_(e){throw b("Billboard_GetRotation",e),Error("Not implemented")}function D_(e,t,r,s,i){b("Billboard_SetColour",e,t,r,s,i)}function k_(e,t,r,s){b("Billboard_SetPosition",e,t,r,s)}function L_(e,t){b("Billboard_SetRotation",e,t)}function G_(e,t,r){return this.kernel.egor.createBillboardSet({name:t||"__BillboardSet_"+h_++,poolSize:r}).key??0}function B_(e,t,r,s){return this.kernel.egor.billboardSets.get(e)?.createBillboard(t,r,s).key??0}function C_(e){b("BillboardSet_Destroy",e)}function U_(e,t){throw b("BillboardSet_GetBillboard",e,t),Error("Not implemented")}function F_(e){throw b("BillboardSet_GetBillboardType",e),Error("Not implemented")}function W_(e,t,r,s){throw b("BillboardSet_GetCommonDirection",e,t,r,s),Error("Not implemented")}function V_(e,t,r,s){throw b("BillboardSet_GetCommonUpVector",e,t,r,s),Error("Not implemented")}function $_(e,t,r){throw b("BillboardSet_GetDefaultDimensions",e,t,r),Error("Not implemented")}function j_(e,t){throw b("BillboardSet_GetMaterialName",e,t),Error("Not implemented")}function H_(e){throw b("BillboardSet_GetNumBillboards",e),Error("Not implemented")}function X_(e,t){b("BillboardSet_RemoveBillboard",e,t)}function Y_(e,t){this.kernel.egor.billboardSets.get(e)?.setType(t)}function z_(e,t,r,s){this.kernel.egor.billboardSets.get(e)?.setCommonDirection(t,r,s)}function q_(e,t,r,s){this.kernel.egor.billboardSets.get(e)?.setCommonUpVector(t,r,s)}function K_(e,t,r){this.kernel.egor.billboardSets.get(e)?.setDimensions(t,r)}function Z_(e,t){this.kernel.egor.billboardSets.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function J_(e){throw b("Bone_GetManuallyControlled",e),Error("Not implemented")}function Q_(e){b("Bone_Reset",e)}function eE(e,t){b("Bone_SetManuallyControlled",e,t)}function tE(e,t){return this.kernel.egor.scenes.get(e)?.createCamera({name:t||"__Camera_"+u_++}).key??0}function rE(e){b("Camera_Destroy",e)}function sE(e){throw b("Camera_GetAspectRatio",e),Error("Not implemented")}function iE(e){throw b("Camera_GetFarClipDistance",e),Error("Not implemented")}function nE(e){throw b("Camera_GetFOV",e),Error("Not implemented")}function oE(e){throw b("Camera_GetNearClipDistance",e),Error("Not implemented")}function cE(e){throw b("Camera_GetPolygonMode",e),Error("Not implemented")}function lE(e){throw b("Camera_GetProjectionType",e),Error("Not implemented")}function aE(e,t){b("Camera_SetAspectRatio",e,t)}function hE(e,t){this.kernel.egor.cameras.get(e)?.set({farDist:t})}function uE(e,t){b("Camera_SetFocalLength",e,t)}function dE(e,t){this.kernel.egor.cameras.get(e)?.set({fov:t})}function fE(e,t,r){b("Camera_SetFrustumOffset",e,t,r)}function gE(e,t){this.kernel.egor.cameras.get(e)?.set({nearDist:t})}function pE(e,t){b("Camera_SetPolygonMode",e,t)}function _E(e,t){b("Camera_SetProjectionType",e,t)}function EE(e){return this.kernel.egorRayCastResult?.getEntry(e)?.distance||0}function wE(e){return this.kernel.egorRayCastResult?.getEntry(e)?.movable.key||0}function mE(){return this.kernel.egorRayCastResult?.length||0}function TE(e,t,r,s,i,n,l){const a=this.kernel.egor.scenes.get(e);if(!a){this.kernel.egorRayCastResult=null;return}const{dir:u,origin:d}=Ur;d[0]=t,d[1]=r,d[2]=s,u[0]=i,u[1]=n,u[2]=l,this.kernel.egorRayCastResult=a?.rayCast(Ur)}function yE(){this.kernel.egorRayCastResult?.sort()}function bE(e){throw b("Compositor_GetEnabled",e),Error("Not implemented")}function RE(e,t){b("Compositor_SetEnabled",e,t)}function OE(e,t,r){if(!r)return 0;const s=this.kernel.egor.scenes.get(e);if(!s)return 0;const i=this.kernel.egor.meshResByNameUC.get(r.toUpperCase());if(!i)throw Error(`Mesh не существует: '${r}'`);return s.createEntity(i,{name:t||"__Entity_"+d_++}).key??0}function ME(e){this.kernel.egor.entities.get(e)?.destroy()}function vE(e,t){throw b("Entity_GetAnimationState",e,t),Error("Not implemented")}function SE(e,t){throw b("Entity_GetBone",e,t),Error("Not implemented")}function AE(e,t){throw b("Entity_GetIndexCount",e,t),Error("Not implemented")}function NE(e,t,r){throw b("Entity_GetMaterial",e,t,r),Error("Not implemented")}function IE(e){return this.kernel.egor.entities.get(e)?.subEntities.length??0}function Ii(e,t=0){const r=this.kernel.egor.entities.get(e);return r?t>=0?r.subEntity(t)?.vertexCount??0:r.subEntities.reduce((s,i)=>s+i.vertexCount,0):0}function xE(e,t,r){const s=this.kernel.egor.entities.get(e);if(!s)return;const i=this.kernel.egor.materialByName.get(r);i&&s.subEntity(t)?.setMaterial(i)}function PE(e,t){return this.kernel.egor.createLight({name:t||"__Light_"+f_++}).key??0}function DE(e){b("Light_Destroy",e)}function kE(e){throw b("Light_GetPowerScale",e),Error("Not implemented")}function LE(e,t,r,s,i){b("Light_SetAttenuation",e,t,r,s,i)}function GE(e,t,r,s){b("Light_SetDiffuseColour",e,t,r,s)}function BE(e,t){b("Light_SetPowerScale",e,t)}function CE(e,t,r,s){b("Light_SetSpecularColour",e,t,r,s)}function UE(e,t,r,s){b("Light_SetSpotlightRange",e,t,r,s)}function FE(e,t){b("Light_SetType",e,t)}function WE(e,t,r){const{egor:s}=this.kernel,i=s.manualObjects.get(e);if(!i)return;const n=s.materialByName.get(t)||null,l=i.createSection(r,n);this.kernel.egorManualObjectsSections.set(i,l)}function VE(e){this.kernel.egor.manualObjects.get(e)?.clear()}function $E(e,t,r,s,i){b("ManualObject_Colour",e,t,r,s,i)}function jE(e,t){b("ManualObject_ConvertToMesh",e,t)}function HE(e,t){return this.kernel.egor.scenes.get(e)?.createManualObject({name:t||"__ManualObject_"+g_++}).key||0}function XE(e){this.kernel.egor.manualObjects.get(e)?.destroy()}function YE(e){const t=this.kernel.egor.manualObjects.get(e);if(!t)return;const r=this.kernel.egorManualObjectsSections.get(t);r&&(r.end(),this.kernel.egorManualObjectsSections.delete(t))}function zE(e,t){b("ManualObject_EstimateIndexCount",e,t)}function qE(e,t){b("ManualObject_EstimateVertexCount",e,t)}function KE(e){throw b("ManualObject_GetDynamic",e),Error("Not implemented")}function ZE(e,t){b("ManualObject_Index",e,t)}function JE(e,t,r,s){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addNormal(t,r,s)}function QE(e,t,r,s){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addVertex(t,r,s)}function ew(e,t){b("ManualObject_SetDynamic",e,t)}function tw(e,t,r){b("ManualObject_TextureCoord",e,t,r)}function rw(e){return this.kernel.egor.createMaterial(e||"__Material_"+p_++).key}function sw(e){return e&&this.kernel.egor.materialByName.get(e)?.key||0}function iw(e){throw b("Material_GetBestTechnique",e),Error("Not implemented")}function nw(e,t){throw b("Material_GetName",e,t),Error("Not implemented")}function ow(e,t){return this.kernel.egor.materialByKey.get(e)?.tech(t)?.key??0}function cw(e,t){throw b("Material_GetTechniqueByName",e,t),Error("Not implemented")}function lw(e,t,r,s,i,n,l){throw b("Movable_GetBoundingBox",e,t,r,s,i,n,l),Error("Not implemented")}function aw(e){throw b("Movable_GetCastShadows",e),Error("Not implemented")}function hw(e,t,r){const s=this.kernel.egor.movables.get(e);s&&(t[r]=s.name)}function uw(e){return this.kernel.egor.movables.get(e)?.node?.key??0}function dw(e){const t=this.kernel.egor.movables.get(e);return t?t.visible?1:0:-1}function fw(e,t){b("Movable_SetCastShadows",e,t)}function gw(e,t){const r=this.kernel.egor.movables.get(e);r&&this.kernel.egor.sceneNodes.get(t)?.attach(r)}function pw(e,t){this.kernel.egor.movables.get(e)?.setVisible(!!t)}function _w(e,t,r){return this.kernel.egor.createMovableText(t,{name:e||"__MovableText_"+__++,fontName:r}).key}function Ew(e){b("MovableText_Destroy",e)}function ww(e,t){throw b("MovableText_GetCaption",e,t),Error("Not implemented")}function mw(e){throw b("MovableText_GetCharacterHeight",e),Error("Not implemented")}function Tw(e,t,r,s,i){throw b("MovableText_GetColor",e,t,r,s,i),Error("Not implemented")}function yw(e,t){throw b("MovableText_GetFontName",e,t),Error("Not implemented")}function bw(e,t,r,s){throw b("MovableText_GetGlobalTranslation",e,t,r,s),Error("Not implemented")}function Rw(e,t,r,s){throw b("MovableText_GetLocalTranslation",e,t,r,s),Error("Not implemented")}function Ow(e){throw b("MovableText_GetSpaceWidth",e),Error("Not implemented")}function Mw(e,t,r){throw b("MovableText_GetTextAlignment",e,t,r),Error("Not implemented")}function vw(e,t){b("MovableText_SetCaption",e,t)}function Sw(e,t){this.kernel.egor.movableTexts.get(e)?.setCharHeight(t)}function Aw(e,t,r,s,i){b("MovableText_SetColor",e,t,r,s,i)}function Nw(e,t){b("MovableText_SetFontName",e,t)}function Iw(e,t,r,s){b("MovableText_SetGlobalTranslation",e,t,r,s)}function xw(e,t,r,s){b("MovableText_SetLocalTranslation",e,t,r,s)}function Pw(e,t){b("MovableText_SetSpaceWidth",e,t)}function Dw(e,t,r){b("MovableText_SetTextAlignment",e,t,r)}function kw(e,t){b("Node_AddChild",e,t)}function Lw(e,t){return this.kernel.egor.nodes.get(e)?.getChild(t)?.key||0}function Gw(e,t,r,s,i,n,l){const a=this.kernel.egor.nodes.get(e);if(!a)return;const u=a.getWorldPosition();t[r]=u[0],s[i]=u[1],n[l]=u[2]}function Bw(e,t,r,s,i,n,l,a,u){const d=this.kernel.egor.nodes.get(e);if(!d)return;const p=d.getWorldRotation();s[i]=p[0],n[l]=p[1],a[u]=p[2],t[r]=p[3]}function Cw(e,t,r,s,i,n,l){const a=this.kernel.egor.nodes.get(e);if(!a)return;const u=a.getWorldScale();t[r]=u[0],s[i]=u[1],n[l]=u[2]}function Uw(e,t,r){t[r]=this.kernel.egor.nodes.get(e)?.name??""}function Fw(e){return this.kernel.egor.nodes.get(e)?.children.length??-1}function Ww(e){throw b("Node_GetParent",e),Error("Not implemented")}function Vw(e,t,r,s,i,n,l){const a=this.kernel.egor.nodes.get(e);a&&(t[r]=a.position[0],s[i]=a.position[1],n[l]=a.position[2])}function $w(e,t,r,s,i,n,l,a,u){const d=this.kernel.egor.nodes.get(e);d&&(s[i]=d.rotation[0],n[l]=d.rotation[1],a[u]=d.rotation[2],t[r]=d.rotation[3])}function jw(e,t,r,s,i,n,l){const a=this.kernel.egor.nodes.get(e);a&&(t[r]=a.scale[0],s[i]=a.scale[1],n[l]=a.scale[2])}function Hw(e,t){b("Node_RemoveChild",e,t)}function Xw(e,t){const r=this.kernel.egor.nodes.get(t);if(!r)return;const s=this.kernel.egor.nodes.get(e);s&&r.addChild(s)}function Yw(e,t,r,s){this.kernel.egor.nodes.get(e)?.setPosition(t,r,s)}function zw(e,t,r,s,i){throw b("Node_SetRotationAxis",e,t,r,s,i),Error("Node_SetRotationAxis")}function qw(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateX(t).rotateY(r).rotateZ(s)}function Kw(e,t,r,s){throw Error()}function Zw(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateY(t).rotateX(r).rotateZ(s)}function Jw(e,t,r,s){throw Error()}function Qw(e,t,r,s){throw Error()}function e0(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateZ(t).rotateY(r).rotateX(s)}function t0(e,t,r,s,i){this.kernel.egor.nodes.get(e)?.setRotation(r,s,i,t)}function r0(e,t,r,s){this.kernel.egor.nodes.get(e)?.setScale(t,r,s)}function s0(e,t){const r=this.kernel.egor.overlays.get(e);if(!r)return;const s=this.kernel.egor.overlayElements.get(t);s&&r.setChildren(r.children.concat(s))}function i0(e){return this.kernel.egor.createOverlay(e).key}function n0(e,t,r){throw b("Overlay_FindElementAt",e,t,r),Error("Not implemented")}function o0(e){if(!e)return 0;for(const t of this.kernel.egor.overlays.values())if(t.name===e)return t.key;return 0}function c0(e,t){throw b("Overlay_GetName",e,t),Error("Not implemented")}function l0(e){throw b("Overlay_GetRotate",e),Error("Not implemented")}function a0(e,t,r){throw b("Overlay_GetScale",e,t,r),Error("Not implemented")}function h0(e,t,r){throw b("Overlay_GetScroll",e,t,r),Error("Not implemented")}function u0(e){throw b("Overlay_GetVisible",e),Error("Not implemented")}function d0(e){throw b("Overlay_GetZOrder",e),Error("Not implemented")}function f0(e,t){b("Overlay_RemoveChild",e,t)}function g0(e,t){b("Overlay_SetRotate",e,t)}function p0(e,t,r){this.kernel.egor.overlays.get(e)?.setScale(t,r)}function _0(e,t,r){b("Overlay_SetScroll",e,t,r)}function E0(e,t){this.kernel.egor.overlays.get(e)?.setVisible(!!t)}function w0(e,t){this.kernel.egor.overlays.get(e)?.setZ(t)}function m0(e,t){const r=this.kernel.egor.overlayElements.get(e);if(!r)return;const s=this.kernel.egor.overlayElements.get(t);s&&r.setChildren(r.children.concat(s))}function T0(e,t){throw b("OverlayContainer_GetChild",e,t),Error("Not implemented")}function y0(e){throw b("OverlayContainer_GetChildCount",e),Error("Not implemented")}function b0(e,t){b("OverlayContainer_RemoveChild",e,t)}function R0(e,t){if(e!=="BorderPanel"&&e!=="Panel"&&e!=="TextArea")throw Error(`Неизвестный тип OverlayElement: '${e}'`);return this.kernel.egor.createOverlayElement(e,{name:t}).key}function O0(e){if(!e)return 0;for(const t of this.kernel.egor.overlayElements.values())if(t.name===e)return t.key;return 0}function M0(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.horAlign??0,s[i]=n?.vertAlign??0}function v0(e,t,r){t[r]=this.kernel.egor.overlayElements.get(e)?.caption??""}function S0(e,t,r,s,i){throw b("OverlayElement_GetColour",e,t,r,s,i),Error("Not implemented")}function A0(e,t,r){t[r]=this.kernel.egor.overlayElements.get(e)?.material?.name??""}function N0(e){return this.kernel.egor.overlayElements.get(e)?.metricsMode??0}function I0(e){return this.kernel.egor.overlayElements.get(e)?.parent?.key??0}function x0(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.x??0,s[i]=n?.y??0}function P0(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.width??0,s[i]=n?.height??0}function D0(e){const t=this.kernel.egor.overlayElements.get(e);return t?t.visible?1:0:-1}function k0(e){throw b("OverlayElement_IsContainer",e),Error("Not implemented")}function L0(e,t,r){this.kernel.egor.overlayElements.get(e)?.setAlignment(t,r)}function G0(e,t){this.kernel.egor.overlayElements.get(e)?.setCaption(t)}function B0(e,t,r,s,i){this.kernel.egor.overlayElements.get(e)?.setColor(t,r,s,i)}function C0(e,t){this.kernel.egor.overlayElements.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function U0(e,t){this.kernel.egor.overlayElements.get(e)?.setMetricsMode(t)}function F0(e,t,r){this.kernel.egor.overlayElements.get(e)?.setPosition(t,r)}function W0(e,t,r){this.kernel.egor.overlayElements.get(e)?.setSize(t,r)}function V0(e,t){this.kernel.egor.overlayElements.get(e)?.setVisible(!!t)}function $0(e,t,r){throw b("ParticleSystem_Create",e,t,r),Error("Not implemented")}function j0(e,t,r){throw b("ParticleSystem_CreateEx",e,t,r),Error("Not implemented")}function H0(e){b("ParticleSystem_Destroy",e)}function X0(e,t){b("ParticleSystem_GetName",e,t)}function Y0(e){throw b("ParticleSystem_GetParent",e),Error("Not implemented")}function z0(e){throw b("ParticleSystem_GetVisible",e),Error("Not implemented")}function q0(e,t){b("ParticleSystem_SetParent",e,t)}function K0(e,t){b("ParticleSystem_SetVisible",e,t)}function Z0(e,t){throw b("Pass_Create",e,t),Error("Not implemented")}function J0(e,t,r){throw b("Pass_GetAlphaRejectSettings",e,t,r),Error("Not implemented")}function Q0(e,t,r,s,i){throw b("Pass_GetAmbient",e,t,r,s,i),Error("Not implemented")}function em(e){throw b("Pass_GetColourWriteEnabled",e),Error("Not implemented")}function tm(e){throw b("Pass_GetCullingMode",e),Error("Not implemented")}function rm(e){throw b("Pass_GetDepthCheckEnabled",e),Error("Not implemented")}function sm(e){throw b("Pass_GetDepthFunction",e),Error("Not implemented")}function im(e){throw b("Pass_GetDepthWriteEnabled",e),Error("Not implemented")}function nm(e,t,r,s,i){throw b("Pass_GetDiffuse",e,t,r,s,i),Error("Not implemented")}function om(e){throw b("Pass_GetLightingEnabled",e),Error("Not implemented")}function cm(e){throw b("Pass_GetPolygonMode",e),Error("Not implemented")}function lm(e,t,r){throw b("Pass_GetSceneBlending",e,t,r),Error("Not implemented")}function am(e,t,r,s,i){throw b("Pass_GetSelfIllumination",e,t,r,s,i),Error("Not implemented")}function hm(e){throw b("Pass_GetShadingMode",e),Error("Not implemented")}function um(e){throw b("Pass_GetShininess",e),Error("Not implemented")}function dm(e,t,r,s,i){throw b("Pass_GetSpecular",e,t,r,s,i),Error("Not implemented")}function fm(e,t){throw b("Pass_GetTextureUnitStateByIndex",e,t),Error("Not implemented")}function gm(e,t){throw b("Pass_GetTextureUnitStateByName",e,t),Error("Not implemented")}function pm(e,t,r){b("Pass_SetAlphaRejectSettings",e,t,r)}function _m(e,t,r,s){this.kernel.egor.passes.get(e)?.setAmbient(t,r,s)}function Em(e,t){b("Pass_SetColourWriteEnabled",e,t)}function wm(e,t){b("Pass_SetCullingMode",e,t)}function mm(e,t){this.kernel.egor.passes.get(e)?.setDepthCheckEnabled(!!t)}function Tm(e,t){b("Pass_SetDepthFunction",e,t)}function ym(e,t){this.kernel.egor.passes.get(e)?.setDepthWriteEnabled(!!t)}function bm(e,t,r,s,i){this.kernel.egor.passes.get(e)?.setDiffuse(t,r,s,i)}function Rm(e,t){this.kernel.egor.passes.get(e)?.setLightingEnabled(!!t)}function Om(e,t){b("Pass_SetPolygonMode",e,t)}function Mm(e,t,r){this.kernel.egor.passes.get(e)?.setSceneBlending(t,r)}function vm(e,t,r,s){this.kernel.egor.passes.get(e)?.setEmissive(t,r,s)}function Sm(e,t){this.kernel.egor.passes.get(e)?.setShadingMode(t)}function Am(e,t){this.kernel.egor.passes.get(e)?.setShininess(t)}function Nm(e,t,r,s,i){this.kernel.egor.passes.get(e)?.setSpecular(t,r,s,i)}function Im(e,t,r){throw b("RenderTexture_Create",e,t,r),Error("Not implemented")}function xm(e){b("RenderTexture_Destroy",e)}function Pm(e){const t=this.kernel.scenes.get(e);if(!t)throw Error("Внешние 3D окна не поддерживаются");const r=t.window.width,s=t.window.height,i=this.kernel.egor.createRenderWindow(r,s,t);return t.insertFrame(i.view,{title:"",width:r,height:s}),i.key}function Dm(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)throw Error("Внешние 3D окна не поддерживаются");const n=this.kernel.egor.createRenderWindow(r,s,i);return i.insertFrame(n.view,{title:t,width:r,height:s}),n.key}function km(e,t,r,s){throw b("RenderWindow_CreateEx",e,t,r,s),Error("Not implemented")}function Lm(e){b("RenderWindow_Destroy",e)}function Gm(e){throw b("RenderWindow_Get",e),Error("Not implemented")}function Bm(){throw b("RenderWindow_GetCount"),Error("Not implemented")}function Cm(e){throw b("RenderWindow_GetCursorHovered",e),Error("Not implemented")}function Um(e,t,r,s,i){const n=this.kernel.egor.windows.get(e)?.mouse();t[r]=n?.x??0,s[i]=n?.y??0}function Fm(e,t){return this.kernel.egor.windows.get(e)?.keyPressed(t)?1:0}function Wm(e,t){const r=t===0?"left":t===1?"right":t===2?"middle":null;return r&&this.kernel.egor.windows.get(e)?.buttonPressed(r)?1:0}function Vm(e,t,r,s,i){const n=this.kernel.egor.windows.get(e);t[r]=n?.x??0,s[i]=n?.y??0}function $m(){return this.kernel.egor.primaryWindow?.key??0}function jm(e,t,r,s,i){const n=this.kernel.egor.windows.get(e);t[r]=n?.width??0,s[i]=n?.height??0}function Hm(e,t){throw b("RenderWindow_GetViewport",e,t),Error("Not implemented")}function Xm(e){return this.kernel.egor.windows.get(e)?.viewports.size??0}function Ym(e){return this.kernel.egor.windows.get(e)?.wheelPosition??0}function zm(e,t,r){b("RenderWindow_SetPosition",e,t,r)}function qm(e,t,r){b("RenderWindow_SetSize",e,t,r)}function Km(e){throw b("RenderWindow_ToggleFullscreen",e),Error("Not implemented")}function Zm(e,t,r,s){b("Root_AddResourceLocation",e,t,r,s)}function Jm(e){xs(this.prj.dir.resolve(e))?.split(`\r
`).forEach(r=>{const s=r.trim().toUpperCase();if(!s.startsWith("FILESYSTEM")&&!s.startsWith("ZIP"))return;const i=s.split("=")[1].trim();this.prj.dir.resolve(i).forEach(l=>{if(l.image){const a=l.path.basename(),u=this.kernel.egor.createImage(l.image,a);u.meta=l.path.toString();return}if(l.mesh){const a=l.path.basename(),u=this.kernel.egor.createMesh(l.mesh,a);u.meta=l.path.toString();return}if(l.base64){const a=l.path.basename().toUpperCase(),u=xs(l.path);if(a.endsWith(".MATERIAL")){const d=u.split(`
`).map(p=>p.trim());for(let p=0;p<d.length;p++){const _=d[p],T=_.startsWith("material ")&&_.replace("material ","").split('"').join("");if(!T)continue;const R=this.kernel.egor.createMaterial(T).techs[0].passes[0];for(let N=p+1;N<d.length;N++){const O=d[N];if(O==="}")break;const k=O.startsWith("shading ")&&O.replace("shading ","");if(k){const D=k.toLowerCase()==="phong"?x.SO_PHONG:x.SO_GOURAUD;R.setShadingMode(D);continue}const L=O.startsWith("ambient ")&&O.replace("ambient ","");if(L){const D=L.split(" ").map(parseFloat);if(D.length<3||D.some(isNaN))continue;R.setAmbient(...D);continue}const U=O.startsWith("diffuse ")&&O.replace("diffuse ","");if(U){const D=U.split(" ").map(parseFloat);if(D.length<4||D.some(isNaN))continue;R.setDiffuse(...D);continue}const F=O.startsWith("specular ")&&O.replace("specular ","");if(F){const D=F.split(" ").map(parseFloat);if(D.length<4||D.some(isNaN))continue;R.setSpecular(...D),D.length>4&&R.setShininess(D[4]);continue}const j=O.startsWith("emissive ")&&O.replace("emissive ","");if(j){const D=j.split(" ").map(parseFloat);if(D.length<3||D.some(isNaN))continue;R.setEmissive(...D),D.length>4&&R.setShininess(D[4]);continue}if(O.startsWith("texture_unit"))for(let D=N+1;D<d.length;D++){const I=d[D];if(I==="}")break;const X=I.startsWith("texture ")&&I.replace("texture ","");if(X){const K=X.toUpperCase();R.createTextureUnit().setTextureName(K);continue}}}}}}},!1)})}function Qm(){}function eT(){b("Root_Destroy")}function tT(){throw b("Root_GetTime"),Error("Not implemented")}function rT(){}function sT(){}function iT(){return 1}function nT(){return this.kernel.egorShouldRender=!0,1}function oT(){return 1}function cT(){b("Root_SaveConfig")}function lT(){return 1}function aT(e){b("Scene_Clear",e)}function hT(e){if(e!=="OctreeSceneManager"&&e!=="BSPSceneManager"&&e!=="TerrainSceneManager")throw Error(`Неподдерживаемый тип сцены: ${e}`);return this.kernel.egor.createScene().key}function uT(e){b("Scene_Destroy",e)}function dT(e,t){throw b("Scene_GetCamera",e,t),Error("Not implemented")}function fT(e,t){if(!t)return 0;const r=this.kernel.egor.scenes.get(e);if(!r)return 0;for(const s of this.kernel.egor.entities.values())if(s.scene===r&&s.name===t)return s.key;return 0}function gT(e,t){throw b("Scene_GetLight",e,t),Error("Not implemented")}function pT(e,t){throw b("Scene_GetParticleSystem",e,t),Error("Not implemented")}function _T(e){return this.kernel.egor.scenes.get(e)?.root.key??0}function ET(e,t){if(!t)return 0;const r=this.kernel.egor.scenes.get(e);if(!r)return 0;for(const s of this.kernel.egor.sceneNodes.values())if(s.scene===r&&s.name===t)return s.key;return 0}function wT(e){throw b("Scene_GetShadowTechnique",e),Error("Not implemented")}function mT(e,t){b("Scene_Load",e,t)}function TT(e,t,r,s){this.kernel.egor.scenes.get(e)?.setAmbient(t,r,s)}function yT(e,t,r,s,i,n,l,a){b("Scene_SetFog",e,t,r,s,i,n,l,a)}function bT(e,t){b("Scene_SetShadowTechnique",e,t)}function RT(e,t,r,s){e&&b("Scene_SetSkyBox",e,t,r,s)}function OT(e,t){b("Scene_SetWorldGeometry",e,t)}function MT(e,t){b("SceneNode_AttachObject",e,t)}function vT(e,t){return this.kernel.egor.scenes.get(e)?.createSceneNode({name:t||"__SceneNode_"+E_++}).key??0}function ST(e){this.kernel.egor.sceneNodes.get(e)?.destroy()}function AT(e,t){b("SceneNode_DetachObject",e,t)}function NT(e){return this.kernel.egor.sceneNodes.get(e)?.movables.length??-1}function IT(e,t){return this.kernel.egor.sceneNodes.get(e)?.getMovable(t)?.key||0}function xT(e){throw b("SceneNode_GetScene",e),Error("Not implemented")}function PT(e,t,r,s,i){this.kernel.egor.sceneNodes.get(e)?.setAutoTracking(this.kernel.egor.sceneNodes.get(t)??null,r,s,i)}function DT(e,t,r){const s=this.kernel.egor.sceneNodes.get(e);if(!s)return;const i=!!t;if(!r){s.movables.forEach(n=>n.setVisible(i));return}(function n(l){l.movables.forEach(a=>a.setVisible(i)),l.children.forEach(a=>n(a))})(s)}function kT(e,t,r){b("StringInterface_GetParameter",e,t,r)}function LT(e){throw b("StringInterface_GetParameterCount",e),Error("Not implemented")}function GT(e,t,r){b("StringInterface_GetParameterDescription",e,t,r)}function BT(e,t,r){b("StringInterface_GetParameterName",e,t,r)}function CT(e,t){throw b("StringInterface_GetParameterType",e,t),Error("Not implemented")}function UT(e,t,r){const s=this.kernel.egor.overlayElements.get(e);s&&s.setParam(t,r)}function FT(e,t){throw b("Technique_Create",e,t),Error("Not implemented")}function WT(e,t){return this.kernel.egor.techniques.get(e)?.pass(t)?.key??0}function VT(e,t){throw b("Technique_GetPassByName",e,t),Error("Not implemented")}function $T(e,t){return this.kernel.egor.passes.get(e)?.createTextureUnit(t).key??0}function jT(e,t,r){b("TextureUnitState_GetTexture",e,t,r)}function HT(e,t,r){this.kernel.egor.texUnits.get(e)?.setTexture(this.kernel.egor.imageResByNameUC.get(t.toUpperCase())??null,r)}function XT(e,t,r){throw b("Viewport_AddCompositor",e,t,r),Error("Not implemented")}function YT(e,t,r){const s=this.kernel.egor.cameras.get(t);return s?this.kernel.egor.windows.get(e)?.createViewport(s,r).key??0:0}function zT(e){b("Viewport_Destroy",e)}function qT(e,t,r,s){throw b("Viewport_GetBackgroundColour",e,t,r,s),Error("Not implemented")}function KT(e){throw b("Viewport_GetCamera",e),Error("Not implemented")}function ZT(e,t){throw b("Viewport_GetCompositor",e,t),Error("Not implemented")}function JT(e,t,r,s,i){throw b("Viewport_GetDimensions",e,t,r,s,i),Error("Not implemented")}function QT(e){throw b("Viewport_GetNumCompositors",e),Error("Not implemented")}function ey(e){throw b("Viewport_GetOverlaysEnabled",e),Error("Not implemented")}function ty(e,t,r,s,i,n,l,a,u,d,p,_,T,m,R){const{origin:N,dir:O}=this.kernel.egor.viewports.get(e)?.camera.getRay(t,r,Ur)||w_;s[i]=N[0],n[l]=N[1],a[u]=N[2],d[p]=O[0],_[T]=O[1],m[R]=O[2]}function ry(e,t){b("Viewport_RemoveCompositor",e,t)}function sy(e,t,r,s){this.kernel.egor.viewports.get(e)?.setBackground(t,r,s)}function iy(e,t){const r=this.kernel.egor.cameras.get(t);r&&this.kernel.egor.viewports.get(e)?.setCamera(r)}function ny(e,t,r,s,i){b("Viewport_SetDimensions",e,t,r,s,i)}function oy(e,t){this.kernel.egor.viewports.get(e)?.enableOverlays(!!t)}function cy(e){e("AnimationState_AddTime",{a:[c,o]},m_),e("AnimationState_GetEnabled",{a:[c],r:o},T_),e("AnimationState_GetLength",{a:[c],r:o},y_),e("AnimationState_GetLoop",{a:[c],r:o},b_),e("AnimationState_GetTimePosition",{a:[c],r:o},R_),e("AnimationState_GetWeight",{a:[c],r:o},O_),e("AnimationState_SetEnabled",{a:[c,o]},M_),e("AnimationState_SetLength",{a:[c,o]},v_),e("AnimationState_SetLoop",{a:[c,o]},S_),e("AnimationState_SetTimePosition",{a:[c,o]},A_),e("AnimationState_SetWeight",{a:[c,o]},N_),e("Billboard_GetColour",{a:[c,A,A,A,A]},I_),e("Billboard_GetPosition",{a:[c,A,A,A]},x_),e("Billboard_GetRotation",{a:[c],r:o},P_),e("Billboard_SetColour",{a:[c,o,o,o,o]},D_),e("Billboard_SetPosition",{a:[c,o,o,o]},k_),e("Billboard_SetRotation",{a:[c,o]},L_),e("BillboardSet_Create",{a:[c,E,o],r:c},G_),e("BillboardSet_CreateBillboard",{a:[c,o,o,o],r:c},B_),e("BillboardSet_Destroy",{a:[c]},C_),e("BillboardSet_GetBillboard",{a:[c,o],r:c},U_),e("BillboardSet_GetBillboardType",{a:[c],r:o},F_),e("BillboardSet_GetCommonDirection",{a:[c,A,A,A]},W_),e("BillboardSet_GetCommonUpVector",{a:[c,A,A,A]},V_),e("BillboardSet_GetDefaultDimensions",{a:[c,A,A]},$_),e("BillboardSet_GetMaterialName",{a:[c,ie]},j_),e("BillboardSet_GetNumBillboards",{a:[c],r:o},H_),e("BillboardSet_RemoveBillboard",{a:[c,c]},X_),e("BillboardSet_SetBillboardType",{a:[c,o]},Y_),e("BillboardSet_SetCommonDirection",{a:[c,o,o,o]},z_),e("BillboardSet_SetCommonUpVector",{a:[c,o,o,o]},q_),e("BillboardSet_SetDefaultDimensions",{a:[c,o,o]},K_),e("BillboardSet_SetMaterialName",{a:[c,E]},Z_),e("Bone_GetManuallyControlled",{a:[c],r:o},J_),e("Bone_Reset",{a:[c]},Q_),e("Bone_SetManuallyControlled",{a:[c,o]},eE),e("Camera_Create",{a:[c,E],r:c},tE),e("Camera_Destroy",{a:[c]},rE),e("Camera_GetAspectRatio",{a:[c],r:o},sE),e("Camera_GetFarClipDistance",{a:[c],r:o},iE),e("Camera_GetFOV",{a:[c],r:o},nE),e("Camera_GetNearClipDistance",{a:[c],r:o},oE),e("Camera_GetPolygonMode",{a:[c],r:o},cE),e("Camera_GetProjectionType",{a:[c],r:o},lE),e("Camera_SetAspectRatio",{a:[c,o]},aE),e("Camera_SetFarClipDistance",{a:[c,o]},hE),e("Camera_SetFocalLength",{a:[c,o]},uE),e("Camera_SetFOV",{a:[c,o]},dE),e("Camera_SetFrustumOffset",{a:[c,o,o]},fE),e("Camera_SetNearClipDistance",{a:[c,o]},gE),e("Camera_SetPolygonMode",{a:[c,o]},pE),e("Camera_SetProjectionType",{a:[c,o]},_E),e("Collision_GetDistance",{a:[o],r:o},EE),e("Collision_GetObject",{a:[o],r:c},wE),e("Collision_GetResultCount",{r:o},mE),e("Collision_RayCast",{a:[c,o,o,o,o,o,o]},TE),e("Collision_Sort",{},yE),e("Compositor_GetEnabled",{a:[c],r:o},bE),e("Compositor_SetEnabled",{a:[c,o]},RE),e("Entity_Create",{a:[c,E,E],r:c},OE),e("Entity_Destroy",{a:[c]},ME),e("Entity_GetAnimationState",{a:[c,E],r:c},vE),e("Entity_GetBone",{a:[c,E],r:c},SE),e("Entity_GetIndexCount",{a:[c,o],r:o},AE),e("Entity_GetMaterial",{a:[c,o,ie]},NE),e("Entity_GetSubEntityCount",{a:[c],r:o},IE),e("Entity_GetVertexCount",{a:[c],r:o},Ii),e("Entity_GetVertexCount",{a:[c,o],r:o},Ii),e("Entity_SetMaterial",{a:[c,o,E]},xE),e("Light_Create",{a:[c,E],r:c},PE),e("Light_Destroy",{a:[c]},DE),e("Light_GetPowerScale",{a:[c],r:o},kE),e("Light_SetAttenuation",{a:[c,o,o,o,o]},LE),e("Light_SetDiffuseColour",{a:[c,o,o,o]},GE),e("Light_SetPowerScale",{a:[c,o]},BE),e("Light_SetSpecularColour",{a:[c,o,o,o]},CE),e("Light_SetSpotlightRange",{a:[c,o,o,o]},UE),e("Light_SetType",{a:[c,o]},FE),e("ManualObject_Begin",{a:[c,E,o]},WE),e("ManualObject_Clear",{a:[c]},VE),e("ManualObject_Colour",{a:[c,o,o,o,o]},$E),e("ManualObject_ConvertToMesh",{a:[c,E]},jE),e("ManualObject_Create",{a:[c,E],r:c},HE),e("ManualObject_Destroy",{a:[c]},XE),e("ManualObject_End",{a:[c]},YE),e("ManualObject_EstimateIndexCount",{a:[c,o]},zE),e("ManualObject_EstimateVertexCount",{a:[c,o]},qE),e("ManualObject_GetDynamic",{a:[c],r:o},KE),e("ManualObject_Index",{a:[c,o]},ZE),e("ManualObject_Normal",{a:[c,o,o,o]},JE),e("ManualObject_Position",{a:[c,o,o,o]},QE),e("ManualObject_SetDynamic",{a:[c,o]},ew),e("ManualObject_TextureCoord",{a:[c,o,o]},tw),e("Material_Create",{a:[E],r:c},rw),e("Material_Get",{a:[E],r:c},sw),e("Material_GetBestTechnique",{a:[c],r:c},iw),e("Material_GetName",{a:[c,ie]},nw),e("Material_GetTechniqueByIndex",{a:[c,o],r:c},ow),e("Material_GetTechniqueByName",{a:[c,E],r:c},cw),e("Movable_GetBoundingBox",{a:[c,A,A,A,A,A,A]},lw),e("Movable_GetCastShadows",{a:[c],r:o},aw),e("Movable_GetName",{a:[c,ie]},hw),e("Movable_GetParent",{a:[c],r:c},uw),e("Movable_GetVisible",{a:[c],r:o},dw),e("Movable_SetCastShadows",{a:[c,o]},fw),e("Movable_SetParent",{a:[c,c]},gw),e("Movable_SetVisible",{a:[c,o]},pw),e("MovableText_Create",{a:[E,E,E],r:c},_w),e("MovableText_Destroy",{a:[c]},Ew),e("MovableText_GetCaption",{a:[c,ie]},ww),e("MovableText_GetCharacterHeight",{a:[c],r:o},mw),e("MovableText_GetColor",{a:[c,A,A,A,A]},Tw),e("MovableText_GetFontName",{a:[c,ie]},yw),e("MovableText_GetGlobalTranslation",{a:[c,A,A,A]},bw),e("MovableText_GetLocalTranslation",{a:[c,A,A,A]},Rw),e("MovableText_GetSpaceWidth",{a:[c],r:o},Ow),e("MovableText_GetTextAlignment",{a:[c,A,A]},Mw),e("MovableText_SetCaption",{a:[c,E]},vw),e("MovableText_SetCharacterHeight",{a:[c,o]},Sw),e("MovableText_SetColor",{a:[c,o,o,o,o]},Aw),e("MovableText_SetFontName",{a:[c,E]},Nw),e("MovableText_SetGlobalTranslation",{a:[c,o,o,o]},Iw),e("MovableText_SetLocalTranslation",{a:[c,o,o,o]},xw),e("MovableText_SetSpaceWidth",{a:[c,o]},Pw),e("MovableText_SetTextAlignment",{a:[c,o,o]},Dw),e("Node_AddChild",{a:[c,c]},kw),e("Node_GetChild",{a:[c,o],r:c},Lw),e("Node_GetDerivedPosition",{a:[c,A,A,A]},Gw),e("Node_GetDerivedRotationQuaternion",{a:[c,A,A,A,A]},Bw),e("Node_GetDerivedScale",{a:[c,A,A,A]},Cw),e("Node_GetName",{a:[c,ie]},Uw),e("Node_GetNumChildren",{a:[c],r:o},Fw),e("Node_GetParent",{a:[c],r:c},Ww),e("Node_GetPosition",{a:[c,A,A,A]},Vw),e("Node_GetRotationQuaternion",{a:[c,A,A,A,A]},$w),e("Node_GetScale",{a:[c,A,A,A]},jw),e("Node_RemoveChild",{a:[c,c]},Hw),e("Node_SetParent",{a:[c,c]},Xw),e("Node_SetPosition",{a:[c,o,o,o]},Yw),e("Node_SetRotationAxis",{a:[c,o,o,o,o]},zw),e("Node_SetRotationEulerXYZ",{a:[c,o,o,o]},qw),e("Node_SetRotationEulerXZY",{a:[c,o,o,o]},Kw),e("Node_SetRotationEulerYXZ",{a:[c,o,o,o]},Zw),e("Node_SetRotationEulerYZX",{a:[c,o,o,o]},Jw),e("Node_SetRotationEulerZXY",{a:[c,o,o,o]},Qw),e("Node_SetRotationEulerZYX",{a:[c,o,o,o]},e0),e("Node_SetRotationQuaternion",{a:[c,o,o,o,o]},t0),e("Node_SetScale",{a:[c,o,o,o]},r0),e("Overlay_AddChild",{a:[c,c]},s0),e("Overlay_Create",{a:[E],r:c},i0),e("Overlay_FindElementAt",{a:[c,o,o],r:c},n0),e("Overlay_Get",{a:[E],r:c},o0),e("Overlay_GetName",{a:[c,ie]},c0),e("Overlay_GetRotate",{a:[c],r:o},l0),e("Overlay_GetScale",{a:[c,A,A]},a0),e("Overlay_GetScroll",{a:[c,A,A]},h0),e("Overlay_GetVisible",{a:[c],r:o},u0),e("Overlay_GetZOrder",{a:[c],r:o},d0),e("Overlay_RemoveChild",{a:[c,c]},f0),e("Overlay_SetRotate",{a:[c,o]},g0),e("Overlay_SetScale",{a:[c,o,o]},p0),e("Overlay_SetScroll",{a:[c,o,o]},_0),e("Overlay_SetVisible",{a:[c,o]},E0),e("Overlay_SetZOrder",{a:[c,o]},w0),e("OverlayContainer_AddChild",{a:[c,c]},m0),e("OverlayContainer_GetChild",{a:[c,o],r:c},T0),e("OverlayContainer_GetChildCount",{a:[c],r:o},y0),e("OverlayContainer_RemoveChild",{a:[c,c]},b0),e("OverlayElement_Create",{a:[E,E],r:c},R0),e("OverlayElement_Get",{a:[E],r:c},O0),e("OverlayElement_GetAlignment",{a:[c,A,A]},M0),e("OverlayElement_GetCaption",{a:[c,ie]},v0),e("OverlayElement_GetColour",{a:[c,A,A,A,A]},S0),e("OverlayElement_GetMaterialName",{a:[c,ie]},A0),e("OverlayElement_GetMetricsMode",{a:[c],r:o},N0),e("OverlayElement_GetParent",{a:[c],r:c},I0),e("OverlayElement_GetPosition",{a:[c,A,A]},x0),e("OverlayElement_GetSize",{a:[c,A,A]},P0),e("OverlayElement_GetVisible",{a:[c],r:o},D0),e("OverlayElement_IsContainer",{a:[c],r:o},k0),e("OverlayElement_SetAlignment",{a:[c,o,o]},L0),e("OverlayElement_SetCaption",{a:[c,E]},G0),e("OverlayElement_SetColour",{a:[c,o,o,o,o]},B0),e("OverlayElement_SetMaterialName",{a:[c,E]},C0),e("OverlayElement_SetMetricsMode",{a:[c,o]},U0),e("OverlayElement_SetPosition",{a:[c,o,o]},F0),e("OverlayElement_SetSize",{a:[c,o,o]},W0),e("OverlayElement_SetVisible",{a:[c,o]},V0),e("ParticleSystem_Create",{a:[c,E,E],r:c},$0),e("ParticleSystem_CreateEx",{a:[c,E,E],r:c},j0),e("ParticleSystem_Destroy",{a:[c]},H0),e("ParticleSystem_GetName",{a:[c,E]},X0),e("ParticleSystem_GetParent",{a:[c],r:c},Y0),e("ParticleSystem_GetVisible",{a:[c],r:o},z0),e("ParticleSystem_SetParent",{a:[c,c]},q0),e("ParticleSystem_SetVisible",{a:[c,o]},K0),e("Pass_Create",{a:[c,E],r:c},Z0),e("Pass_GetAlphaRejectSettings",{a:[c,A,A]},J0),e("Pass_GetAmbient",{a:[c,A,A,A,A]},Q0),e("Pass_GetColourWriteEnabled",{a:[c],r:o},em),e("Pass_GetCullingMode",{a:[c],r:o},tm),e("Pass_GetDepthCheckEnabled",{a:[c],r:o},rm),e("Pass_GetDepthFunction",{a:[c],r:o},sm),e("Pass_GetDepthWriteEnabled",{a:[c],r:o},im),e("Pass_GetDiffuse",{a:[c,A,A,A,A]},nm),e("Pass_GetLightingEnabled",{a:[c],r:o},om),e("Pass_GetPolygonMode",{a:[c],r:o},cm),e("Pass_GetSceneBlending",{a:[c,A,A]},lm),e("Pass_GetSelfIllumination",{a:[c,A,A,A,A]},am),e("Pass_GetShadingMode",{a:[c],r:o},hm),e("Pass_GetShininess",{a:[c],r:o},um),e("Pass_GetSpecular",{a:[c,A,A,A,A]},dm),e("Pass_GetTextureUnitStateByIndex",{a:[c,o],r:c},fm),e("Pass_GetTextureUnitStateByName",{a:[c,E],r:c},gm),e("Pass_SetAlphaRejectSettings",{a:[c,o,o]},pm),e("Pass_SetAmbient",{a:[c,o,o,o,o]},_m),e("Pass_SetColourWriteEnabled",{a:[c,o]},Em),e("Pass_SetCullingMode",{a:[c,o]},wm),e("Pass_SetDepthCheckEnabled",{a:[c,o]},mm),e("Pass_SetDepthFunction",{a:[c,o]},Tm),e("Pass_SetDepthWriteEnabled",{a:[c,o]},ym),e("Pass_SetDiffuse",{a:[c,o,o,o,o]},bm),e("Pass_SetLightingEnabled",{a:[c,o]},Rm),e("Pass_SetPolygonMode",{a:[c,o]},Om),e("Pass_SetSceneBlending",{a:[c,o,o]},Mm),e("Pass_SetSelfIllumination",{a:[c,o,o,o,o]},vm),e("Pass_SetShadingMode",{a:[c,o]},Sm),e("Pass_SetShininess",{a:[c,o]},Am),e("Pass_SetSpecular",{a:[c,o,o,o,o]},Nm),e("RenderTexture_Create",{a:[E,o,o],r:c},Im),e("RenderTexture_Destroy",{a:[c]},xm),e("RenderWindow_Create",{a:[c,o,o],r:c},Pm),e("RenderWindow_Create2",{a:[c,E,o,o,o,o,o,o],r:c},Dm),e("RenderWindow_CreateEx",{a:[c,o,o,o],r:c},km),e("RenderWindow_Destroy",{a:[c]},Lm),e("RenderWindow_Get",{a:[o],r:c},Gm),e("RenderWindow_GetCount",{r:o},Bm),e("RenderWindow_GetCursorHovered",{a:[c],r:o},Cm),e("RenderWindow_GetCursorPosition",{a:[c,A,A]},Um),e("RenderWindow_GetKeyboardButtonPressed",{a:[c,o],r:o},Fm),e("RenderWindow_GetMouseButtonPressed",{a:[c,o],r:o},Wm),e("RenderWindow_GetPosition",{a:[c,A,A]},Vm),e("RenderWindow_GetPrimary",{r:c},$m),e("RenderWindow_GetSize",{a:[c,A,A]},jm),e("RenderWindow_GetViewport",{a:[c,o],r:c},Hm),e("RenderWindow_GetViewportCount",{a:[c],r:o},Xm),e("RenderWindow_GetWheelPosition",{a:[c],r:o},Ym),e("RenderWindow_SetPosition",{a:[c,o,o]},zm),e("RenderWindow_SetSize",{a:[c,o,o]},qm),e("RenderWindow_ToggleFullscreen",{a:[c],r:o},Km),e("Root_AddResourceLocation",{a:[E,E,E,o]},Zm),e("Root_AddResourceLocationFromConfigFile",{a:[E]},Jm),e("Root_Create",{a:[E,E,E]},Qm),e("Root_Destroy",{},eT),e("Root_GetTime",{r:o},tT),e("Root_Initialise",{},rT),e("Root_InitialiseAllResourceGroups",{},sT),e("Root_IsInitialised",{r:o},iT),e("Root_RenderOneFrame",{r:o},nT),e("Root_RestoreConfig",{r:o},oT),e("Root_SaveConfig",{},cT),e("Root_ShowConfigDialog",{r:o},lT),e("Scene_Clear",{a:[c]},aT),e("Scene_Create",{a:[E],r:c},hT),e("Scene_Destroy",{a:[c]},uT),e("Scene_GetCamera",{a:[c,E],r:c},dT),e("Scene_GetEntity",{a:[c,E],r:c},fT),e("Scene_GetLight",{a:[c,E],r:c},gT),e("Scene_GetParticleSystem",{a:[c,E],r:c},pT),e("Scene_GetRootSceneNode",{a:[c],r:c},_T),e("Scene_GetSceneNode",{a:[c,E],r:c},ET),e("Scene_GetShadowTechnique",{a:[c],r:o},wT),e("Scene_Load",{a:[c,E]},mT),e("Scene_SetAmbientLight",{a:[c,o,o,o]},TT),e("Scene_SetFog",{a:[c,o,o,o,o,o,o,o]},yT),e("Scene_SetShadowTechnique",{a:[c,o]},bT),e("Scene_SetSkyBox",{a:[c,o,E,o]},RT),e("Scene_SetWorldGeometry",{a:[c,E]},OT),e("SceneNode_AttachObject",{a:[c,c]},MT),e("SceneNode_Create",{a:[c,E],r:c},vT),e("SceneNode_Destroy",{a:[c]},ST),e("SceneNode_DetachObject",{a:[c,c]},AT),e("SceneNode_GetNumObjects",{a:[c],r:o},NT),e("SceneNode_GetObject",{a:[c,o],r:c},IT),e("SceneNode_GetScene",{a:[c],r:c},xT),e("SceneNode_SetAutoTracking",{a:[c,c,o,o,o]},PT),e("SceneNode_SetVisible",{a:[c,o,o]},DT),e("StringInterface_GetParameter",{a:[c,E,E]},kT),e("StringInterface_GetParameterCount",{a:[c],r:o},LT),e("StringInterface_GetParameterDescription",{a:[c,o,E]},GT),e("StringInterface_GetParameterName",{a:[c,o,E]},BT),e("StringInterface_GetParameterType",{a:[c,o],r:o},CT),e("StringInterface_SetParameter",{a:[c,E,E]},UT),e("Technique_Create",{a:[c,E],r:c},FT),e("Technique_GetPassByIndex",{a:[c,o],r:c},WT),e("Technique_GetPassByName",{a:[c,E],r:c},VT),e("TextureUnitState_Create",{a:[c,E],r:c},$T),e("TextureUnitState_GetTexture",{a:[c,E,c]},jT),e("TextureUnitState_SetTexture",{a:[c,E,o]},HT),e("Viewport_AddCompositor",{a:[c,E,o],r:c},XT),e("Viewport_Create",{a:[c,c,o],r:c},YT),e("Viewport_Destroy",{a:[c]},zT),e("Viewport_GetBackgroundColour",{a:[c,A,A,A]},qT),e("Viewport_GetCamera",{a:[c],r:c},KT),e("Viewport_GetCompositor",{a:[c,o],r:c},ZT),e("Viewport_GetDimensions",{a:[c,A,A,A,A]},JT),e("Viewport_GetNumCompositors",{a:[c],r:o},QT),e("Viewport_GetOverlaysEnabled",{a:[c],r:o},ey),e("Viewport_GetRay",{a:[c,o,o,A,A,A,A,A,A]},ty),e("Viewport_RemoveCompositor",{a:[c,c]},ry),e("Viewport_SetBackgroundColour",{a:[c,o,o,o]},sy),e("Viewport_SetCamera",{a:[c,c]},iy),e("Viewport_SetDimensions",{a:[c,o,o,o,o]},ny),e("Viewport_SetOverlaysEnabled",{a:[c,o]},oy)}const ly={name:"ogre",deps:["windows"],register:cy,setup(e){e.egor=new eg,e.egorShouldRender=!1,e.egorRayCastResult=null,e.egorManualObjectsSections=new WeakMap,e.afterCycle.add(()=>{e.egorShouldRender&&(e.egorShouldRender=!1,e.egor.renderAll())})}},ay=13,hy=10,uy=[1,1,2,2,4,4,4,5,8,10];function xi(e){return e<0||e>9?0:uy[e]}class Pi{constructor(t,r=null){if(this.file=r,t){const s=Qr(t);this.v=new DataView(s.buffer,s.byteOffset,s.byteLength)}else this.v=new DataView(new ArrayBuffer(0));this.p=0,this.width=8}copyTo(t,r,s){return r<0||r+s>this.v.byteLength?0:(t.v.byteLength<s?t.v=new DataView(this.v.buffer.slice(r,s)):new Uint8Array(t.v.buffer).set(new Uint8Array(this.v.buffer,r,s)),1)}seek(t){return this.p=t}eof(){return this.p>=this.size()?1:0}pos(){return this.p}size(){return this.v.byteLength}setWidth(t){return this.width=t,1}widthNumber(){const t=xi(this.width);if(t===0)return 0;const r=this.p,s=r+t;if(s>this.size())return 0;switch(this.p=s,this.width){case 0:return this.v.getUint8(r);case 1:return this.v.getInt8(r);case 2:return this.v.getUint16(r,!0);case 3:return this.v.getInt16(r,!0);case 4:return this.v.getUint32(r,!0);case 5:return this.v.getInt32(r,!0);case 6:return this.v.getFloat32(r,!0);case 7:throw Error("Чтение FLOAT40 не поддерживается");case 8:return this.v.getFloat64(r,!0);case 9:throw Error("Чтение FLOAT80 не поддерживается");default:return 0}}resize(t){const r=new Uint8Array(new ArrayBuffer(t));r.set(new Uint8Array(this.v.buffer)),this.v=new DataView(r.buffer)}writeWidthNumber(t){const r=xi(this.width);if(r===0)return 0;const s=this.p,i=s+r;switch(i>this.size()&&this.resize(i),this.p=i,this.width){case 0:return this.v.setUint8(s,t),1;case 1:return this.v.setInt8(s,t),1;case 2:return this.v.setUint16(s,t,!0),2;case 3:return this.v.setInt16(s,t,!0),2;case 4:return this.v.setUint32(s,t,!0),4;case 5:return this.v.setInt32(s,t,!0),4;case 6:return this.v.setFloat32(s,t,!0),4;case 7:throw Error("FLOAT40 не поддерживается");case 8:return this.v.setFloat64(s,t,!0),8;case 9:throw Error("FLOAT80 не поддерживается");default:return 0}}getLine(t,r){const s=this.p,i=Math.min(t,this.size()-s);if(i<=0)return"";let n=0,l="";for(;n<i;){const a=this.v.getUint8(s+n);n++;const u=_e[a];if(l+=u,u===r)break}return this.p+=n,l}line(){const t=this.p,r=this.size()-t;if(r<=0)return"";let s=0,i=0;for(;s<r;){const l=this.v.getUint8(t+s);if(l===0){i=1;break}if(l===ay&&s+1<r&&this.v.getUint8(t+s+1)===hy){i=2;break}s+=1}const n=nr(new Uint8Array(this.v.buffer,t,s));return this.p=t+s+i,n}writeLine(t){const r=t+`\r
`;let s=this.p;const i=s+r.length;return i>this.size()&&this.resize(i),this.p=i,es(r).forEach((l,a)=>this.v.setUint8(s+a,l)),r.length}write(t){let r=this.p;const s=r+t.length;s>this.size()&&this.resize(s),this.p=s,t.forEach((i,n)=>this.v.setUint8(r+n,i))}buffer(){return this.v.buffer}}class dy{constructor(){this.saveFilePaths=[],this.tempFiles=[]}addFile(t,r){this.tempFiles.push({path:t,data:r})}addFilepathForSave(t){this.saveFilePaths.push(t)}getTempFile(t){for(const r of this.tempFiles)if(r.path.equals(t))return r.data;return null}isTempSavePath(t){return this.saveFilePaths.some(r=>r.equals(t))}}function fy(e,t,r){const s=e.toUpperCase(),i=r.toUpperCase(),n=i.includes("CREATE"),l=i.includes("READONLY"),a=ue.freeKey(this.kernel.streams);if(t==="?")throw Error("Некорректное использование fileLoadDialog");if(s==="FILE"){const u=this.prj.dir.resolve(t);let d=null,p="";if(n){if(d=u.create("file",{base64:p}),!d)return 0}else{const _=this.kernel.tempFileController.getTempFile(u)?.content;if(_){if(!_.base64)return te.debugFile&&console.warn(`CreateStream: Загруженный файл ${u} существует, но формат не base64.`),0;p=_.base64}else{if(d=u.file(),!d)return 0;if(p=d.base64,!p)return te.debugFile&&console.warn(`CreateStream: Файл ${u} существует, но формат не base64.`),0}}return this.kernel.streams.set(a,new Pi(p,l?null:d)),a}return s==="MEMORY"?(this.kernel.streams.set(a,new Pi),a):(console.warn(`Поток типа ${s} не поддерживается`),0)}function gy(e){const t=this.kernel.streams.get(e);if(!t)return 0;if(this.kernel.streams.delete(e),!t.file)return 1;const r=new Uint8Array(t.buffer());t.file.set({base64:Jr(r)});const s=this.kernel.tempFileController.isTempSavePath(t.file.path);return this.kernel.handleWrite(t.file,r,s),1}function py(e,t){return this.kernel.streams.get(e)?.seek(t)??0}function _y(e){return this.kernel.streams.get(e)?.eof()??0}function Ey(e){return this.kernel.streams.get(e)?.pos()??0}function wy(e){return this.kernel.streams.get(e)?.size()??0}function my(e,t){return this.kernel.streams.get(e)?.setWidth(t)??0}function Ty(e){return this.kernel.streams.get(e)?.widthNumber()??0}function yy(e){return this.kernel.streams.get(e)?.line()??""}function by(e,t){return this.kernel.streams.get(e)?.writeWidthNumber(t)??0}function Ry(e,t){return this.kernel.streams.get(e)?.writeLine(t)??0}function Oy(e,t,r){return this.kernel.streams.get(e)?.getLine(t,r)??""}function My(e,t,r,s){const i=this.kernel.streams.get(e);if(!i)return 0;const n=this.kernel.streams.get(t);return n?i.copyTo(n,r,s):0}function vy(e){e("CreateStream",{a:[E,E,E],r:c},fy),e("CloseStream",{a:[c],r:o},gy),e("Seek",{a:[c,o],r:o},py),e("Eof",{a:[c],r:o},_y),e("GetPos",{a:[c],r:o},Ey),e("GetSize",{a:[c],r:o},wy),e("SetWidth",{a:[c,o],r:o},my),e("Read",{a:[c],r:o},Ty),e("ReadLn",{a:[c],r:E},yy),e("Write",{a:[c,o],r:o},by),e("WriteLn",{a:[c,E],r:o},Ry),e("GetLine",{a:[c,o,E],r:E},Oy),e("CopyBlock",{a:[c,c,o,o],r:o},My)}const Sy={name:"streams",register:vy,setup(e){e.streams=new Map,e.tempFileController=new dy}},yt=new Uint8Array(256);function Di(e){return e>=0&&e<256?!!yt[e]:!1}function Ay(){return this.kernel._functionNotImplemented("System"),0}function Ny(e){return Di(e)?1:0}function Iy(e,t,r,s,i){const n=this.kernel.windows.get(e);if(!n)return t[r]=0,s[i]=0,0;const{x:l,y:a}=n.mouse,u=n.invmatrix;if(!u)return t[r]=l,s[i]=a,1;const d=l*u[2]+a*u[5]+u[8];return t[r]=(l*u[0]+a*u[3]+u[6])/d,s[i]=(l*u[1]+a*u[4]+u[7])/d,1}function xy(e){this.kernel.windowSystem.showCursor(e>0)}function ki(e,t){const r=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!r)return;let s;switch(t){case x.CUR_ARROW:s="auto";break;case x.CUR_CROSS:s="crosshair";break;case x.CUR_TEXT:s="text";break;case x.CUR_NO:s="not-allowed";break;case x.CUR_SIZE:s="move";break;case x.CUR_SIZENESW:s="nesw-resize";break;case x.CUR_SIZENS:s="ns-resize	";break;case x.CUR_SIZENWSE:s="nwse-resize";break;case x.CUR_SIZEWE:s="ew-resize";break;case x.CUR_UPARROW:s="n-resize";break;case x.CUR_WAIT:s="wait";break;case x.CUR_LINK:s="pointer";break;case x.CUR_HELP:s="help";break;default:s="auto";break}r.setCursor(s)}function Li(e,t){const r=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!r)return;const s=this.prj.dir.resolve(t).file()?.cursor;r.setCursor(s?`url(${We(s.src)}), auto`:"default")}function Py(){return Date.now()-Uc}function Dy(e,t,r,s,i,n,l,a){const u=new Date;e[t]=u.getHours(),r[s]=u.getMinutes(),i[n]=u.getSeconds(),l[a]=u.getMilliseconds()*.1}function ky(e,t,r,s,i,n){const l=new Date;e[t]=l.getFullYear(),r[s]=l.getMonth()+1,i[n]=l.getDate()}function Ly(e,t,r,...[s,i,n,l,a]){if(r>4)return 0;const u=this.kernel.scenes.get(e)?.scene.objects.get(t);return u?(r<0?delete u.data.hyper:u.data.hyper={mode:r,target:s,object:i,effect:n,window:l,params:a},1):0}function Gy(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)return;const n=(i.scene.objects.get(s)??i.pick(t,r))?.data?.hyper;n&&i.hyperClick(n,{x:t,y:r})}function By(){return this.kernel.windowSystem.windowFactory.screenWidth}function Cy(){return this.kernel.windowSystem.windowFactory.screenHeight}function Uy(){return 0}function Fy(){return 0}function Wy(){return this.kernel.windowSystem.windowFactory.screenWidth}function Vy(){return this.kernel.windowSystem.windowFactory.screenHeight}function $y(){return 0}function jy(){return 0}function Hy(){return 0}function Xy(){return 0}function Yy(){return 0}function zy(){return 0}function qy(e,t){return this.kernel.handleExe(e,t)?1:0}function Ky(e,t,r,s){return this.kernel.handleShell(e,t,r,s)?1:0}function Zy(e){this.kernel.log(e,this)}function Jy(e){e("System",{a:[o],rest:[o],r:o},Ay),e("GetAsyncKeyState",{a:[o],r:o},Ny),e("GetMousePos",{a:[E,A,A],r:o},Iy),e("ShowCursor",{a:[o]},xy),e("LoadCursor",{a:[c,E]},Li),e("LoadCursor",{a:[E,E]},Li),e("SetStandartCursor",{a:[c,o]},ki),e("SetStandartCursor",{a:[E,o]},ki),e("GetTickCount",{r:o},Py),e("GetTime",{a:[A,A,A,A]},Dy),e("GetDate",{a:[A,A,A]},ky),e("SetHyperJump2d",{a:[c,c,o],rest:[E],r:o},Ly),e("StdHyperJump",{a:[c,o,o,c,o]},Gy),e("GetScreenWidth",{r:o},By),e("GetScreenHeight",{r:o},Cy),e("GetWorkAreaX",{r:o},Uy),e("GetWorkAreaY",{r:o},Fy),e("GetWorkAreaWidth",{r:o},Wy),e("GetWorkAreaHeight",{r:o},Vy),e("GetTitleHeight",{r:o},$y),e("GetSmallTitleHeight",{r:o},jy),e("GetFixedFrameWidth",{r:o},Hy),e("GetFixedFrameHeight",{r:o},Xy),e("GetSizeFrameWidth",{r:o},Yy),e("GetSizeFrameHeight",{r:o},zy),e("WinExecute",{a:[E,o],r:o},qy),e("Shell",{a:[E,E,E,o],r:o},Ky),e("LogMessage",{a:[E]},Zy)}const Qy={name:"system",deps:["windows"],register:Jy};function eb(e){return e.toString()}function tb(e,t){return e<0||e>255?"":_e[e]}function rb(e){e("FloatToString",{a:[o],r:E},eb),e("ConvertToAscii",{a:[o,o],r:E},tb)}const sb={name:"vrtkbd",register:rb};class ib{constructor(t,r){this.prevContainerWidth=0,this.prevContainerHeight=0,this.width=0,this.height=0,this.updateScene=()=>{const{scene:l,scrollContainerEl:a}=this,u=a.clientWidth,d=a.clientHeight;(this.prevContainerWidth!==u||this.prevContainerHeight!==d)&&(this.prevContainerWidth=u,this.prevContainerHeight=d,l.resizeView(u,d));const p=a.scrollLeft+this.offsetX,_=a.scrollTop+this.offsetY;return(l.x!==p||l.y!==_)&&l.set({x:p,y:_}),!0},this.scene=t,new Fe().run(this.updateScene);const i=document.createElement("div");i.className="wrapper-scroll-container",i.style="width: 100%; height: 100%;";const n=document.createElement("div");n.className="wrapper-scroll-dummy",n.style="width: 100%; height: 100%;",i.append(n),r.append(i),this.dummyEl=n,this.scrollContainerEl=i,this.offsetX=0,this.offsetY=0}scrollTo(t,r){const s=t-this.offsetX,i=r-this.offsetY;this.scrollContainerEl.scrollLeft=s,this.scrollContainerEl.scrollTop=i,this.updateScene()}set({x:t=this.offsetX,y:r=this.offsetY,width:s=this.width,height:i=this.height}){let n=!1;this.offsetX!==t&&(this.offsetX=t,n=!0,this.scrollContainerEl.style.overflowX="scroll"),this.offsetY!==r&&(this.offsetY=r,n=!0,this.scrollContainerEl.style.overflowY="scroll"),this.width!==s&&(this.width=s,this.dummyEl.style.width=s+"px",this.scrollContainerEl.style.overflowX="scroll"),this.height!==i&&(this.height=i,this.dummyEl.style.height=i+"px",this.scrollContainerEl.style.overflowY="scroll"),n&&this.updateScene()}}class Gi{constructor(t){this.scrollArea=null,this.sceneRect=null,this.autoScroll=!1,this.yScroll=!1,this.xScroll=!1;const r=t.view.style;r.position="absolute",r.top="0px",r.left="0px",r.pointerEvents="none";const s=document.createElement("div");s.className="stratum-scene-wrapper",s.style="position: relative; width: 100%; height: 100%; overflow:hidden;";const i=document.createElement("div");i.className="stratum-subwindow-root",i.style="position: absolute; top: 0px; left: 0px",s.append(t.view,i),this.scene=t,this.domElement=s,this.subwindowRoot=i}setOrg(t,r){this.scrollArea?this.scrollArea.scrollTo(t,r):this.scene.set({x:t,y:r})}getWidth(t){return(t||!this.sceneRect)&&(this.sceneRect=ut(this.scene.objects.values())),this.sceneRect.w}getHeight(t){return(t||!this.sceneRect)&&(this.sceneRect=ut(this.scene.objects.values())),this.sceneRect.h}reCalc(){if(!this.autoScroll||!this.xScroll&&!this.yScroll)return;const t=this.sceneRect=ut(this.scene.objects.values());this.set({width:ss(this.xScroll&&t.w),height:ss(this.yScroll&&t.h)})}getOrCreateScrollArea(){return this.scrollArea||(this.scrollArea=new ib(this.scene,this.domElement)),this.scrollArea}setAutoScroll(t){this.autoScroll=t}set(t){t.width&&(this.xScroll=!0),t.height&&(this.yScroll=!0),this.getOrCreateScrollArea().set(t)}}const nb=new Map([["Backspace",8],["Tab",9],["Enter",13],["ShiftLeft",16],["ControlLeft",17],["AltLeft",18],["Pause",19],["CapsLock",20],["Escape",27],["Space",32],["PageUp",33],["PageDown",34],["End",35],["Home",36],["ArrowLeft",37],["ArrowUp",38],["ArrowRight",39],["ArrowDown",40],["PrintScreen",44],["Insert",45],["Delete",46],["Digit0",48],["Digit1",49],["Digit2",50],["Digit3",51],["Digit4",52],["Digit5",53],["Digit6",54],["Digit7",55],["Digit8",56],["Digit9",57],["KeyA",65],["KeyB",66],["KeyC",67],["KeyD",68],["KeyE",69],["KeyF",70],["KeyG",71],["KeyH",72],["KeyI",73],["KeyJ",74],["KeyK",75],["KeyL",76],["KeyM",77],["KeyN",78],["KeyO",79],["KeyP",80],["KeyQ",81],["KeyR",82],["KeyS",83],["KeyT",84],["KeyU",85],["KeyV",86],["KeyW",87],["KeyX",88],["KeyY",89],["KeyZ",90],["Comma",188],["Period",190],["Slash",191]]),ob=[37,38,39,40,45,46];class Bi{constructor(t,r,s){this.parent=t,this.sceneView=r,this.realX=NaN,this.realY=NaN,this.x=0,this.y=0,this.width=0,this.height=0,this.title="",this.visible=!0,this.scale=1,this.onClose=new Ne,this.lastScrollTime=0,this.manuallyScrolled=!1;const i=this.view=document.createElement("div");i.setAttribute("class","stratum-subwindow"),i.style.setProperty("position","absolute"),i.style.setProperty("transform-origin","top left"),this.set(s),i.appendChild(r),t.sceneWrapper.subwindowRoot.appendChild(i),i.addEventListener("scroll",()=>{if(this.manuallyScrolled){this.manuallyScrolled=!1;return}this.lastScrollTime=Date.now()})}scrollTo(t,r){Date.now()-this.lastScrollTime<50||(this.view.scrollTo({left:t,top:r}),this.manuallyScrolled=!0)}set({x:t=this.x,y:r=this.y,width:s=this.width,height:i=this.height,title:n=this.title,visible:l=this.visible,scale:a=this.scale}){const{parent:u,view:d}=this,{style:p}=d,_=(t-u.scene.x)*u.window.scale,T=(r-u.scene.y)*u.window.scale,m=1/a;return this.scale!==a&&(a===1?p.removeProperty("transform"):p.setProperty("transform",`scale(${a})`)),this.realX!==_&&p.setProperty("left",_+"px"),this.realY!==T&&p.setProperty("top",T+"px"),(this.width!==s||this.scale!==a)&&p.setProperty("width",s*m+"px"),(this.height!==i||this.scale!==a)&&p.setProperty("height",i*m+"px"),this.visible!==l&&p.setProperty("display",l?"block":"none"),this.realX=_,this.realY=T,this.x=t,this.y=r,this.width=s,this.height=i,this.title=n,this.visible=l,this.scale=a,this}toTop(){this.view.parentElement?.append(this.view)}offsetLeft(){return this.view.offsetLeft}offsetTop(){return this.view.offsetTop}disablePointerEvents(){this.view.style.pointerEvents="none"}close(){this.view.remove()}}class Fr{constructor(t,r,{key:s,matrix:i,name:n,prj:l,scene:a,window:u,parent:d,source:p,sceneWrapper:_}){this.kernel=t,this.c=r,this.currentCursor="default",this.cursorOverHyp=!1,this.all=new Set([this]),this.mouseMoveSubs=new Re,this.leftButtonUpSubs=new Re,this.leftButtonDownSubs=new Re,this.rightButtonUpSubs=new Re,this.rightButtonDownSubs=new Re,this.middleButtonUpSubs=new Re,this.middleButtonDownSubs=new Re,this.keyDownSubs=new Set,this.keyUpSubs=new Set,this.keyCharSubs=new Set,this.controlNotifySubs=new Re,this.windowMoveSubs=new Set,this.spaceDoneSubs=new Set,this.sizeSubs=new Set,this.hiddenBy=null,this.mouse={x:0,y:0},this.scene=a,this.window=u,this.key=s,this.name=n,this.prj=l,this.matrix=i??null,this.invmatrix=i?Cn(i):null,this.parent=d??null,this.source=p??null,a.view.style.pointerEvents="auto",a.view.tabIndex=0,a.view.style.outline="none",a.view.style.touchAction="none";const T=this.handleKeyboard.bind(this);a.view.addEventListener("keydown",T),a.view.addEventListener("keyup",T);const m=this.handlePointer.bind(this);a.view.addEventListener("pointerdown",m),a.view.addEventListener("pointermove",m),a.view.addEventListener("pointerup",m),a.view.addEventListener("pointercancel",m),a.oninputchanged=this.handleInput.bind(this),this.sceneWrapper=_,u.onClose.add(()=>this.remove())}getWidth(t){return this.sceneWrapper.getWidth(t)}getHeight(t){return this.sceneWrapper.getHeight(t)}keyPressed(t){return Di(t)}setMouseCoordsRecursive(t,r){if(this.mouse.x=t,this.mouse.y=r,this.parent){const s=this.window.x-this.parent.scene.x+t,i=this.window.y-this.parent.scene.y+r;this.parent.setMouseCoordsRecursive(s,i)}}handlePointer(t){const r=!!(t.buttons&1),s=!!(t.buttons&2),i=!!(t.buttons&4);if(yt[1]=+r,yt[2]=+s,yt[4]=+i,!t.isPrimary||t.target!==t.currentTarget)return;this.c.captureTarget?.w.scene.view.setPointerCapture(t.pointerId);const{scene:n}=this,l=Math.round(t.offsetX+n.x),a=Math.round(t.offsetY+n.y);this.setMouseCoordsRecursive(l,a);let u=n.pick(l,a);for(;u;){const F=u.parent;if(!F)break;u=F}const d=u?.data?.hyper;let p,_;switch(t.type){case"pointerdown":{switch(this.c.closePopups(this),t.button){case 0:d&&!d.disabled&&this.hyperClick(d,{x:l,y:a}),p=this.leftButtonDownSubs,_=x.WM_LBUTTONDOWN;break;case 1:p=this.middleButtonDownSubs,_=x.WM_MBUTTONDOWN;break;case 2:p=this.rightButtonDownSubs,_=x.WM_RBUTTONDOWN;break;default:return}break}case"pointerup":case"pointercancel":{switch(t.button){case 0:p=this.leftButtonUpSubs,_=x.WM_LBUTTONUP;break;case 1:p=this.middleButtonUpSubs,_=x.WM_MBUTTONUP;break;case 2:p=this.rightButtonUpSubs,_=x.WM_RBUTTONUP;break;default:return}break}case"pointermove":this.cursorOverHyp=!!d&&!d.disabled,this.updateCursor(),p=this.mouseMoveSubs,_=x.WM_MOUSEMOVE;break}let T=l,m=a;const R=this.invmatrix;if(R){const F=l*R[2]+a*R[5]+R[8];T=(l*R[0]+a*R[3]+R[6])/F,m=(l*R[1]+a*R[4]+R[7])/F}const{captureTarget:N}=this.c,O=r?1:0,k=s?2:0,L=i?16:0,U=O|k|L;p.forEach((F,j)=>{if(!(N&&N.w===this&&N.s===j||F.has(u)||F.has(null)))return;const{msg:D,xpos:I,ypos:X,fwkeys:K}=j.klass.vars;j.setVarValue(D,_),I&&j.setVarValue(I,T),X&&j.setVarValue(X,m),K&&j.setVarValue(K,U),j.compute(!0)})}updateCursor(){this.scene.set({cursor:this.c.cursorVisible?this.cursorOverHyp?"pointer":this.currentCursor:"none"})}handleKeyboard(t){if(t.target!==t.currentTarget)return;const r=t.type,s=nb.get(t.code)??0;!s&&t.code&&console.warn(`Неизвестная клавиша: ${t.code}`),yt[s]=+(r==="keydown");const i=1,n=0;let l,a;switch(r){case"keydown":l=this.keyDownSubs,a=x.WM_KEYDOWN;break;case"keyup":l=this.keyUpSubs,a=x.WM_KEYUP;break}if(l.forEach(u=>{const{msg:d,wvkey:p,repeat:_,scancode:T}=u.klass.vars;u.setVarValue(d,a),p&&u.setVarValue(p,s),_&&u.setVarValue(_,i),T&&u.setVarValue(T,n),u.compute(!0)}),r==="keydown"&&!ob.includes(s)){const u=_e.indexOf(t.key),d=u<0?s:u;this.keyCharSubs.forEach(p=>{const{msg:_,wvkey:T,repeat:m,scancode:R}=p.klass.vars;p.setVarValue(_,ur),T&&p.setVarValue(T,d),m&&p.setVarValue(m,i),R&&p.setVarValue(R,n),p.compute(!0)})}}handleInput(t){const r=this.controlNotifySubs,s=x.WM_CONTROLNOTIFY;let i;switch(t.type){case"input":i=768;break;case"focus":this.c.closePopups(this),i=256;break;case"blur":i=512;break;case"click":i=0;break;default:return}r.forEach((n,l)=>{if(!(n.has(t.target)||n.has(null)))return;const{msg:u,_hobject:d,iditem:p,wnotifycode:_}=l.klass.vars;l.setVarValue(u,s),d&&l.setVarValue(d,t.target.key),p&&l.setVarValue(p,0),_&&l.setVarValue(_,i),l.compute(!0)})}setCapture(t){this.c.captureTarget={w:this,s:t}}releaseCapture(){}subscribe(t,r,s,i){const n=i&1,l=this.scene.objects.get(s)??null;switch(r){case x.WM_MOVE:this.windowMoveSubs.add(t);break;case x.WM_SPACEDONE:this.spaceDoneSubs.add(t);break;case x.WM_SIZE:this.sizeSubs.add(t);break;case x.WM_CONTROLNOTIFY:(l||s===0)&&this.controlNotifySubs.set(t,l);break;case x.WM_MOUSEMOVE:(l||!n)&&this.mouseMoveSubs.set(t,n?l:null);break;case x.WM_LBUTTONDOWN:(l||!n)&&this.leftButtonDownSubs.set(t,n?l:null);break;case x.WM_LBUTTONUP:(l||!n)&&this.leftButtonUpSubs.set(t,n?l:null);break;case x.WM_RBUTTONDOWN:(l||!n)&&this.rightButtonDownSubs.set(t,n?l:null);break;case x.WM_RBUTTONUP:(l||!n)&&this.rightButtonUpSubs.set(t,n?l:null);break;case x.WM_MBUTTONDOWN:(l||!n)&&this.middleButtonDownSubs.set(t,n?l:null);break;case x.WM_MBUTTONUP:(l||!n)&&this.middleButtonUpSubs.set(t,n?l:null);break;case x.WM_ALLMOUSEMESSAGE:if(!l&&n)break;const a=n?l:null;this.mouseMoveSubs.set(t,a),this.leftButtonDownSubs.set(t,a),this.leftButtonUpSubs.set(t,a),this.rightButtonDownSubs.set(t,a),this.rightButtonUpSubs.set(t,a),this.middleButtonDownSubs.set(t,a),this.middleButtonUpSubs.set(t,a);break;case x.WM_KEYDOWN:this.keyDownSubs.add(t);break;case x.WM_KEYUP:this.keyUpSubs.add(t);break;case ur:this.keyCharSubs.add(t);break;case x.WM_ALLKEYMESSAGE:this.keyDownSubs.add(t),this.keyUpSubs.add(t),this.keyCharSubs.add(t);break;default:t.kernel._functionNotImplemented(`Подписка на ${x[r]}`,t);break}}unsubscribe(t,r){switch(r){case x.WM_MOVE:this.windowMoveSubs.delete(t);break;case x.WM_SPACEDONE:this.spaceDoneSubs.delete(t);break;case x.WM_SIZE:this.sizeSubs.delete(t);break;case x.WM_CONTROLNOTIFY:this.controlNotifySubs.delete(t);break;case x.WM_MOUSEMOVE:this.mouseMoveSubs.delete(t);break;case x.WM_LBUTTONDOWN:this.leftButtonDownSubs.delete(t);break;case x.WM_LBUTTONUP:this.leftButtonUpSubs.delete(t);break;case x.WM_RBUTTONDOWN:this.rightButtonDownSubs.delete(t);break;case x.WM_RBUTTONUP:this.rightButtonUpSubs.delete(t);break;case x.WM_MBUTTONDOWN:this.middleButtonDownSubs.delete(t);break;case x.WM_MBUTTONUP:this.middleButtonUpSubs.delete(t);break;case x.WM_ALLMOUSEMESSAGE:this.mouseMoveSubs.delete(t),this.leftButtonDownSubs.delete(t),this.leftButtonUpSubs.delete(t),this.rightButtonDownSubs.delete(t),this.rightButtonUpSubs.delete(t),this.middleButtonDownSubs.delete(t),this.middleButtonUpSubs.delete(t);break;case x.WM_KEYDOWN:this.keyDownSubs.delete(t);break;case x.WM_KEYUP:this.keyUpSubs.delete(t);break;case ur:this.keyCharSubs.delete(t);break;case x.WM_ALLKEYMESSAGE:this.keyDownSubs.delete(t),this.keyUpSubs.delete(t),this.keyCharSubs.delete(t);break}}setOrg(t,r){this.sceneWrapper.setOrg(t,r)}setVerticalScroller(t){t.min>t.max||this.sceneWrapper.set({y:t.min,height:t.max-t.min})}setHorizontalScroller(t){t.min>t.max||this.sceneWrapper.set({x:t.min,width:t.max-t.min})}setCursor(t){this.currentCursor=t,this.updateCursor()}insertFrame(t,r){new Bi(this,t,{x:this.scene.x,y:this.scene.y}).disablePointerEvents()}subwindow({gSpaceDTO:{data:t,matrix:r,options:s},project:i,name:n,at:l,source:a}){const u=this.c.sceneFactory.create(t),d={...l,title:n},p=s?.size;if(p?.type==="fixed")d.width=p.width,d.height=p.height;else if(u.objects.size){const N=ut(u.objects.values());s?.autoorg&&u.set({x:N.x,y:N.y}),d.width=N.w,d.height=N.h}const _=new Gi(u),T=new Bi(this,_.domElement,d),m=ue.freeKey(this.c.scenes),R=new Fr(this.kernel,this.c,{key:m,name:n,prj:i,scene:u,window:T,matrix:r,source:a,parent:this,sceneWrapper:_});return this.c.scenes.set(m,R),this.c.windows.set(n,R),this.all.add(R),R}pick(t,r,s){let i=t,n=r;const l=this.matrix;if(l){const u=t*l[2]+r*l[5]+l[8];i=(t*l[0]+r*l[3]+l[6])/u,n=(t*l[1]+r*l[4]+l[7])/u}let a=this.scene.pick(i,n);if(s&&(this.c.lastPickedPrimaryKey=a?.key??0),!a)return null;for(;a.parent;)a=a.parent;return a}paste(t,r,s,i){if(!t.objects?.length)return null;let n=t;if(i&x.PFC_ALL){const p={...t};i&x.PFC_PENS&&delete p.pens,i&x.PFC_BRUHS&&delete p.brushes,i&x.PFC_DDIBS&&delete p.images,i&x.PFC_DIBS&&delete p.imagesOpaque,i&x.PFC_STRINGS&&delete p.strings,i&x.PFC_FONTS&&delete p.fonts,i&x.PFC_TEXTS&&delete p.texts,n=p}const l=Rs(this.scene,n);if(!(i&x.PFC_MOVEOBJECT))return l;let a=r,u=s;const d=this.matrix;if(d){const p=r*d[2]+s*d[5]+d[8];a=(r*d[0]+s*d[3]+d[6])/p,u=(r*d[1]+s*d[4]+d[7])/p}return l.set({x:a,y:u})}hyperClick(t,r){const{prj:s}=this;switch(t.object&&console.warn("Посылка WM_HYPERJUMP не реализована"),t.mode){case Uo:{const i=t.target;if(!i)break;const n=this.kernel.classes.get(i);if(!n)break;const{scene:l}=n,a=t.window||(l?.options?.popup?"PopupWindow":"MainWindow");if(this.c.windows.has(a))return;const u={x:r.x-this.scene.x,y:r.y-this.scene.y},d=this.c.window({name:a,gSpaceDTO:l??{},project:s,at:u,source:{type:"classname",data:n.name}});l&&wr(d.scene,n.children,this.kernel.classes);break}case Fo:{const i=t.target;if(!i)break;this.kernel.handleExe(i);break}case Wo:{const i=t.target;if(!i)break;const n=t.params?.toUpperCase().includes("/HIDEWINDOWS"),l=s.dir.resolve(i);this.kernel.projectLoader.open(l).then(a=>{if(!a){console.warn(`${l} не существует`);return}const u=this.kernel.addProject(a);n&&this.c.hideProjectWindows(s,u)}).catch(a=>{if(!(a instanceof Error))throw a;console.warn(`Не удалось открыть ${l}: ${a.message}`)});break}case Vo:break;case $o:{const i=t.target?.toUpperCase();if(!i)break;i===jo?this.kernel.setProjects([]):i===Ho?this.kernel.setProjects(cs(this.kernel.projects,s)):console.warn(`Действие '${i}' не реализовано.`);break}default:console.warn("Неизвестный тип гиперперехода"),console.log(t)}}remove(){this.c._closeWindows(this.all)}}class cb{constructor(t,{sceneFactory:r,windowFactory:s}){this.kernel=t,this.scenes=new Map,this.windows=new Map,this.cursorVisible=!0,this.captureTarget=null,this.lastPickedPrimaryKey=0,this.clipboard=null,this.openedPopups=new Set,this.sceneFactory=r,this.windowFactory=s}window({gSpaceDTO:{data:t,matrix:r,options:s},project:i,name:n,at:l,source:a}){const u=this.sceneFactory.create(t),d=s?.size,p={...l,title:n,popup:s?.popup,showCloseButton:s.showCloseButton,...d?.type==="fixed"&&{width:d.width,height:d.height}};if(d?.type==="fixed")p.width=d.width,p.height=d.height;else{const N=ut(u.objects.values());p.width=N.w,p.height=N.h,u.set({x:N.x,y:N.y})}const _=new Gi(u),T=this.windowFactory.window(_.domElement,p),m=ue.freeKey(this.scenes),R=new Fr(this.kernel,this,{key:m,name:n,prj:i,scene:u,window:T,matrix:r,source:a,sceneWrapper:_});return s?.hscroll&&_.set({width:R.getWidth()}),s?.vscroll&&_.set({height:R.getHeight()}),s?.autoscroll&&_.setAutoScroll(!0),s?.popup&&this.openedPopups.add(R),this.scenes.set(m,R),this.windows.set(n,R),R}releaseCapture(){this.captureTarget?.w.releaseCapture(),this.captureTarget=null}showCursor(t){this.cursorVisible=t,this.windows.forEach(r=>r.updateCursor())}_closeWindows(t){this.scenes.forEach(r=>{if(!t.has(r))return;r===this.captureTarget?.w&&(this.captureTarget=null);const{key:s,name:i}=r;setTimeout(()=>{const n=x.WM_SPACEDONE;r.spaceDoneSubs.forEach(l=>{const{msg:a,_hspace:u,_windowName:d}=l.klass.vars;l.setVarValue(a,n),u&&l.setVarValue(u,s),d&&l.setVarValue(d,i),l.compute(!0)})}),r.scene.dispose(),r.window.close(),this.scenes.delete(r.key),this.windows.delete(r.name),this.openedPopups.delete(r)})}closePopups(t){const r=new Set;this.openedPopups.forEach(s=>{s!==t&&s.all.forEach(i=>r.add(i))}),this._closeWindows(r)}clearAll(){this.scenes.clear(),this.windows.clear(),this.cursorVisible=!0,this.lastPickedPrimaryKey=0}hideProjectWindows(t,r){this.windows.forEach(s=>{s.prj===t&&(s.window.set({visible:!1}),s.hiddenBy=r)})}closeProjectWindows(t){const r=new Set([...this.windows.values()].filter(s=>s.prj===t));this._closeWindows(r),this.windows.forEach(s=>{s.hiddenBy===t&&(s.window.set({visible:!0}),s.hiddenBy=null)})}}function lb(e,t,r,s,i,n,l,a){const{prj:u}=this,d=this.kernel.windows.get(e);if(d)return d.key;let p=null,_=null,T=null;if(r){const k=this.kernel.classes.get(r),L=k?.scene;if(L)p=L,_={type:"classname",data:k.name},T=k.children;else{const U=u.dir.resolve(r),F=U.file()?.scene;F&&(p=F,_={type:"filename",data:U.toString()})}}const m=mr(a,p?.options);!m.size&&n>0&&l>0&&(m.size={type:"fixed",width:n,height:l});const R={name:e,gSpaceDTO:{...p,options:m},project:u,at:{x:s,y:i},source:_},N=m.child&&this.kernel.windows.get(t),O=N?N.subwindow(R):this.kernel.windowSystem.window(R);return T&&wr(O.scene,T,this.kernel.classes),O.key}function ab(e){return this.kernel.windows.get(e)?.window.width??0}function hb(e){return this.kernel.windows.get(e)?.window.height??0}function ub(e){return this.kernel.scenes.get(e)?.name??""}function db(e){return this.kernel.windows.get(e)?.window.x??0}function fb(e){return this.kernel.windows.get(e)?.window.y??0}function gb(e){return this.kernel.windows.get(e)?.key??0}function pb(e){return this.kernel.windows.get(e)?.window.width??0}function _b(e){return this.kernel.windows.get(e)?.window.height??0}function Eb(e){return this.kernel.windows.get(e)?.window.title??""}function wb(e,t,r){return this.kernel.windows.get(e)?.window.set({width:t,height:r})?1:0}function mb(e,t,r,s){const i=this.kernel.windows.get(e);return i?(t>0?i.setHorizontalScroller({min:r,max:s||i.getWidth(!0)}):i.setVerticalScroller({min:r,max:s||i.getHeight(!0)}),1):0}function Tb(e,t,r){return this.kernel.windows.get(e)?.window.set({x:t,y:r})?1:0}function yb(e,t,r,s,i){return this.kernel.windows.get(e)?.window.set({x:t,y:r,width:s,height:i})?1:0}function bb(e,t,r){return this.kernel.windows.get(e)?.window.set({width:t,height:r})?1:0}function Rb(e,t){return this.kernel.windows.get(e)?.window.set({title:t})?1:0}function Ci(){return this.kernel._functionNotImplemented("SetWindowTransparent"),1}function Ui(){return this.kernel._functionNotImplemented("SetWindowTransparentColor"),1}function Fi(e,t){return t?(this.kernel._functionNotImplemented("SetWindowRegion"),1):0}function Ob(){return this.kernel._functionNotImplemented("SetWindowOwner"),1}function Mb(e,t){const r=this.kernel.windows.get(e)?.window;if(!r)return 0;switch(t){case x.SW_HIDE:r.set({visible:!1});break;case x.SW_SHOW:case x.SW_NORMAL:r.set({visible:!0});break}return 1}function vb(e){const t=this.kernel.windows.get(e)?.window;return t?(t.toTop(),1):0}function Sb(e){return this.kernel.windows.get(e)?.remove()?1:0}function Ab(){return 0}function Nb(e){return this.kernel.windows.has(e)?1:0}function Ib(e){return this.kernel.windows.get(e)?.window.visible?1:0}function xb(e,t,r){const{prj:s}=this,i=this.kernel.windows.get(e);if(i)return i.key;const n=s.dir.resolve(t),l=n.file()?.scene??null,a=mr(r,l?.options);return this.kernel.windowSystem.window({name:e,gSpaceDTO:{...l,options:a},project:s,source:l?{type:"filename",data:n.toString()}:null}).key}function Pb(e,t,r){const{prj:s}=this,i=this.kernel.windows.get(e);if(i)return i.key;const n=this.kernel.classes.get(t),l=n?.scene,a=mr(r,l?.options),u=this.kernel.windowSystem.window({name:e,gSpaceDTO:{...l,options:a},project:s,source:n?{type:"classname",data:n.name}:null});return l&&wr(u.scene,n.children,this.kernel.classes),u.key}function Db(){return this.kernel._functionNotImplemented("OpenClassScheme"),1}function kb(){return this.kernel._functionNotImplemented("CloseClassScheme"),1}function Lb(){}function Gb(){}function Bb(){}function Cb(e,t){const r=this.kernel.windows.get(e)?.source;return r&&r.type===t.toLowerCase()&&r.data||""}function Ub(e){e("CreateWindowEx",{a:[E,E,E,o,o,o,o,E],r:c},lb),e("GetClientWidth",{a:[E],r:o},ab),e("GetClientHeight",{a:[E],r:o},hb),e("GetWindowName",{a:[c],r:E},ub),e("GetWindowOrgX",{a:[E],r:o},db),e("GetWindowOrgY",{a:[E],r:o},fb),e("GetWindowSpace",{a:[E],r:c},gb),e("GetWindowWidth",{a:[E],r:o},pb),e("GetWindowHeight",{a:[E],r:o},_b),e("GetWindowTitle",{a:[E],r:E},Eb),e("SetClientSize",{a:[E,o,o],r:o},wb),e("SetScrollRange",{a:[E,o,o,o],r:o},mb),e("SetWindowOrg",{a:[E,o,o],r:o},Tb),e("SetWindowPos",{a:[E,o,o,o,o],r:o},yb),e("SetWindowSize",{a:[E,o,o],r:o},bb),e("SetWindowTitle",{a:[E,E],r:o},Rb),e("SetWindowTransparent",{a:[E,o],r:o},Ci),e("SetWindowTransparent",{a:[c,o],r:o},Ci),e("SetWindowTransparentColor",{a:[E,z],r:o},Ui),e("SetWindowTransparentColor",{a:[c,z],r:o},Ui),e("SetWindowRegion",{a:[E,c],r:o},Fi),e("SetWindowRegion",{a:[c,c],r:o},Fi),e("SetWindowOwner",{a:[c,c],r:o},Ob),e("ShowWindow",{a:[E,o],r:o},Mb),e("BringWindowToTop",{a:[E],r:o},vb),e("CloseWindow",{a:[E],r:o},Sb),e("IsIconic",{a:[E],r:o},Ab),e("IsWindowExist",{a:[E],r:o},Nb),e("IsWindowVisible",{a:[E],r:o},Ib),e("LoadSpaceWindow",{a:[E,E,E],r:c},xb),e("OpenSchemeWindow",{a:[E,E,E],r:c},Pb),e("OpenClassScheme",{a:[E,o],r:c},Db),e("CloseClassScheme",{a:[E],r:o},kb),e("CascadeWindows",{},Lb),e("Tile",{a:[o]},Gb),e("ArrangeIcons",{},Bb),e("GetWindowProp",{a:[E,E],r:E},Cb)}const Fb=[{name:"windows",register:Ub,setup(e,t){if(!t)throw Error("Плагин 'windows': не указаны зависимости");const r=new cb(e,t);e.windowSystem=r,e.windows=r.windows,e.scenes=r.scenes,e.onProjectClose.add(s=>e.windowSystem.closeProjectWindows(s)),e.afterCycle.add(()=>e.windows.forEach(s=>s.sceneWrapper.reCalc()))}},Sy,rl,yl,jl,pa,ju,Ql,Rp,Ap,qp,a_,ly,np,Qy,oa],Wb=[sb];class Wr{constructor(t=""){this.name=t,this.type="folder",this.items=new Map}}class Wi{constructor(t,r={}){this.path=t,this.type="file",this.size=null,this.cls=null,this.image=null,this.scene=null,this.video=null,this.audio=null,this.ttf=null,this.cursor=null,this.stt=null,this.mat=null,this.base64=null,this.mesh=null,this.set(r)}set({size:t=this.size,cls:r=this.cls,image:s=this.image,scene:i=this.scene,video:n=this.video,audio:l=this.audio,ttf:a=this.ttf,cursor:u=this.cursor,stt:d=this.stt,mat:p=this.mat,mesh:_=this.mesh,base64:T=this.base64}){return this.size=t,this.cls=r,this.image=s,this.scene=i,this.video=n,this.audio=l,this.ttf=a,this.cursor=u,this.stt=d,this.mat=p,this.mesh=_,this.base64=T,this}}class Ae{constructor(t,r,s){if(this.fs=t,this.parts=r,this.str=null,r[0].length!==2&&r[0][1]!==":")throw Error("Неправильное имя тома диска");this.partsUC=s??r.map(i=>i.toUpperCase())}static splitPath(t){return t.split(/[/\\]/).map(r=>r.trim()).filter(r=>r.length>0)}resolve(t){const r=Ae.splitPath(t);if(!r.length)return this;const s=r[0].length===2&&r[0][1]===":",i=s?[r[0]]:this.parts.slice(),n=s?[r[0].toUpperCase()]:this.partsUC.slice();for(let l=s?1:0;l<r.length;++l){const a=r[l];a===".."?i.length>1&&(i.pop(),n.pop()):a!=="."&&(i.push(a),n.push(a.toUpperCase()))}return new Ae(this.fs,i,n)}toString(){return this.str?this.str:this.str=this.parts.join("\\")}basename(){return this.parts[this.parts.length-1]}equals(t){const r=this.partsUC,s=t.partsUC;if(r.length!==s.length)return!1;for(let i=0;i<r.length;++i)if(r[i]!==s[i])return!1;return!0}startsWith(t){const r=this.partsUC,s=t.partsUC;if(r.length<s.length)return!1;for(let i=0;i<s.length;++i)if(r[i]!==s[i])return!1;return!0}static getFolder(t,r,s){let i=t;for(let n=0;n<r.length-(s?0:1);++n){const l=i.items.get(r[n]);if(!l||l.type!=="folder")return null;i=l}return i}create(t,r){const{partsUC:s}=this,i=Ae.getFolder(this.fs,s);if(!i)return null;const n=s[s.length-1],l=i.items.get(n);if(t==="folder")return l||i.items.set(n,new Wr),this;if(l)return l.type!=="file"?null:(r&&l.set(r),l);const a=new Wi(this,r);return i.items.set(n,a),a}createWithDirs(t){const{parts:r,partsUC:s}=this;let i=this.fs;for(let u=0;u<r.length-1;++u){let d=i.items.get(s[u]);if(!d)d=new Wr(r[u]),i.items.set(s[u],d);else if(d.type==="file")throw Error(`Невозможно создать директорию ${this}: файл ${d.path} уже существует.`);i=d}const n=s[s.length-1];if(i.items.has(n))throw Error(`Невозможно создать директорию ${this}: файл уже существует.`);const a=new Wi(this,t);return i.items.set(n,a),a}file(){const{partsUC:t}=this,r=Ae.getFolder(this.fs,t);if(!r)return te.debugFile&&console.warn(`${this.toString()} не существует`),null;const s=t[t.length-1],i=r.items.get(s);return i?i.type!=="file"?(te.debugFile&&console.warn(`${this.toString()} является каталогом`),null):i:(te.debugFile&&console.warn(`${this.toString()} не существует`),null)}forEach(t,r){const{partsUC:s}=this,i=Ae.getFolder(this.fs,s,!0);i&&i.items.forEach(function n(l){l.type==="folder"?r&&l.items.forEach(n):t(l)})}resolveMany(){const{partsUC:t}=this,r=Ae.getFolder(this.fs,t);if(!r)return[];const s=t[t.length-1];if(s.includes("*")){const[l,a]=s.split("*");let u;return!l&&!a?u=[".","..",...r.items]:u=[...r.items].filter(([d])=>d.startsWith(l)&&d.endsWith(a)),u.map(d=>{if(typeof d=="string")return{name:d,size:0};const p=d[1];return p.type==="folder"?{name:p.name,size:0}:{name:p.path.basename(),size:p.size??0}})}const i=r.items.get(s);return i?[i.type==="folder"?{name:i.name,size:0}:{name:i.path.basename(),size:i.size??0}]:[]}}class Vb extends Error{constructor(t){super(`Проект ${t} загружается`)}}class $b{constructor(t){this.loadedLibs=new Set,this.fs=new Wr,this.stdlibDir=new Ae(this.fs,["D:",Pt.mount]),this.projects=t.map(r=>{const s=this.path(r.filepath||"project.spj");return{config:r,path:s,state:{type:"notLoaded"}}})}path(t,r="C:"){return new Ae(this.fs,[r].concat(t.split("/")))}exists(t){return this.projects.some(({path:r})=>r.equals(t))}async open(t){const r=this.projects.find(({path:n})=>n.equals(t));if(!r)return null;const s=r.state;if(s.type==="loading")throw new Vb(r.path);if(s.type==="loaded")return s.parsedProjectConfig;r.state={type:"loading"};let i;try{const{path:n,config:l}=r,a=l.libs.concat(Pt).map(async R=>{let N;if(R.id){if(this.loadedLibs.size===this.loadedLibs.add(R.id).size)return;N=R.id===Pt.src?"D:":"C:"}else{if(this.loadedLibs.size===this.loadedLibs.add(R.src).size)return;N=R.src===Pt.src?"D:":"C:"}const{files:O}=R.data||await Tc(R,{cache:te.cache});O.forEach(k=>this.path(R.mount?`${R.mount}/${k.path}`:k.path,N).createWithDirs(k))});await Promise.all(a);const{searchDirs:u,stt:d}=l.data,p=n.resolve(".."),_=[this.stdlibDir,p].concat(u?.map(R=>this.path(R))??[]),T=d?this.path(d):p.resolve("_preload.stt"),m=T.file()?.stt;m||console.warn(`Файл состояния ${T} не существует`),i={settings:l.data,filepath:n,dir:p,searchDirs:_,stt:m}}catch(n){throw r.state={type:"notLoaded"},n}return r.state={type:"loaded",parsedProjectConfig:i},i}}function jb(e){e.style.transformOrigin="top left",e.insertAdjacentHTML("afterend",`
<div id="mobzoom-icons-container">
    <img draggable="false" id="mobzoom-in-btn" src="images/zoom-in-icon.svg" />
    <img draggable="false" id="mobzoom-out-btn" src="images/zoom-out-icon.svg" />
</div>`);const r=document.getElementById("mobzoom-in-btn");r.oncontextmenu=D=>D.preventDefault();const s=document.getElementById("mobzoom-out-btn");s.oncontextmenu=D=>D.preventDefault();const i=new Fe(e.ownerDocument.defaultView);let n=1;const l=()=>{if(!isNaN(a))n*=1.05;else if(!isNaN(u))n*=.95;else return!1;return n=Math.min(Math.max(n,.1),1),e.style.transform=`scale(${n})`,e.style.width=`${100/n}%`,e.style.height=`${100/n}%`,!0};let a=NaN;r.onpointerdown=D=>{isNaN(a)&&(i.run(l),r.setPointerCapture(a=D.pointerId))},r.onpointerup=D=>{a===D.pointerId&&(a=NaN)},r.onpointercancel=D=>{a===D.pointerId&&(a=NaN)};let u=NaN;s.onpointerdown=D=>{isNaN(u)&&(i.run(l),s.setPointerCapture(u=D.pointerId))},s.onpointerup=D=>{u===D.pointerId&&(u=NaN)},s.onpointercancel=D=>{u===D.pointerId&&(u=NaN)};const d=new Fe(e.ownerDocument.defaultView);let p=null;const _=new Map;let T=0,m=0;function R(D){if(!(_.size>2)){if(_.size<2){p=null,(Math.abs(T)>1||Math.abs(m)>1)&&d.run(()=>(T-=Math.sign(T)*.4,m-=Math.sign(m)*.4,e.scrollLeft-=T,e.scrollTop-=m,Math.abs(T)>1||Math.abs(m)>1));return}D.stopPropagation();{p=[..._.values()];const[I,X]=p;I.x-X.x,I.y-X.y}}}let N=null;function O(D){_.set(D.pointerId,{id:D.pointerId,x:D.screenX,y:D.screenY}),d.stop(),D.isPrimary&&(N=[D.clientX,D.clientY]),R(D)}function k(D){_.delete(D.pointerId),D.isPrimary&&(N=null,L.stop()),R(D)}const L=new Fe(e.ownerDocument.defaultView),U=100;let F=[0,0];function j(){const[D,I]=F;if(N){const J=D-N[0],he=I-N[1];if(J**2+he**2<100)return!1}let X=0,K=0;if(D<U)X=D-U;else{const J=window.innerWidth-D;J<U&&(X=U-J)}if(X/=40,I<U)K=I-U;else{const J=window.innerHeight-I;J<U&&(K=U-J)}return K/=40,X&&(e.scrollLeft+=Math.E**Math.abs(X)*Math.sign(X)),K&&(e.scrollTop+=Math.E**Math.abs(K)*Math.sign(K)),!0}function B(D){if(!p&&D.isPrimary?(F[0]=D.clientX,F[1]=D.clientY,L.run(j)):L.stop(),!p)return;const I=_.get(D.pointerId);if(I){D.isPrimary||(D.stopPropagation(),T=D.screenX-I.x,m=D.screenY-I.y,e.scrollLeft-=T,e.scrollTop-=m);{const[X,K]=p;X.x-K.x,X.y-K.y}I.x=D.screenX,I.y=D.screenY}}e.addEventListener("pointerdown",O,{capture:!0}),e.addEventListener("pointerup",k),e.addEventListener("pointercancel",k),e.addEventListener("pointermove",B,{capture:!0})}const Hb=window.devicePixelRatio;function Xb(){const e=document.createElement("button");return e.style=`
        background: darkgray;
        border: none;
        font-size: 24px;
        cursor: pointer;
        position: absolute;
        right: 19px;
        top: 4px;
        border-radius: 12%;
        user-select: none;
    `,e.textContent="×",e}class Yb{constructor(t,r,{popup:s,title:i,...n}){this.system=t,this.view=r,this.onClose=new Ne,this.x=0,this.y=0,this.width=0,this.height=0,this.visible=!0,this.scale=1,this.scaleFactor=NaN,this.instantClose=!1,this.hideTimeout=0;const{root:l}=t;if(this.sizeWatcher=new Fe(l.ownerDocument.defaultView),this.origTitle=l.ownerDocument.title,!s&&i&&(l.ownerDocument.title=this.origTitle?`${this.origTitle} - ${i}`:i),this.title=i??"",this.popup=s||!1,this.set(n),l.appendChild(r),this.width=n.width||r.clientWidth,this.height=n.height||r.clientHeight,!s){if(n.showCloseButton&&t.firstWindow){const a=Xb();r.append(a),a.onclick=()=>this.onClose.dispatch(),this.instantClose=!0}te.adaptiveScaling?this.sizeWatcher.run(this.rescale.bind(this)):te.touchGestures&&(r.style.left="0px",r.style.top="0px")}}toTop(){}rescale(){const{system:t,view:r,width:s,height:i}=this,n=window.devicePixelRatio/Hb,l=t.root.clientWidth*n,a=t.root.clientHeight*n,u=l/(s||l),d=a/(i||a),p=Math.min(u,d,1);if(this.scaleFactor!==p){this.scaleFactor=p;const _=r.style;p<1?(_.left="0px",_.top="0px",_.transform=`scale(${p})`):(_.left="auto",_.top="auto",_.transform="none")}return!0}set({x:t=this.x,y:r=this.y,width:s=this.width,height:i=this.height,title:n=this.title,visible:l=this.visible,scale:a=this.scale}){const{view:u}=this,{style:d}=u,p=1/a;if(this.scale!==a&&(a===1?d.removeProperty("transform"):d.setProperty("transform",`scale(${a})`)),this.popup){if(this.x!==t){const _=this.system.firstWindow?.offsetLeft()||0;d.setProperty("left",t+_+"px")}if(this.y!==r){const _=this.system.firstWindow?.offsetTop()||0;d.setProperty("top",r+_+"px")}}return(this.width!==s||this.scale!==a)&&d.setProperty("width",s*p+"px"),(this.height!==i||this.scale!==a)&&d.setProperty("height",i*p+"px"),this.visible!==l&&(this.view.style.opacity=l?"1":"0",this.hideTimeout&&window.clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>this.view.style.setProperty("display",l?"block":"none"),l?0:250)),this.x=t,this.y=r,this.width=s,this.height=i,this.title=n,this.visible=l,this.scale=a,this}offsetLeft(){return this.view.offsetLeft}offsetTop(){return this.view.offsetTop}remove(){this.view.style.opacity="0",setTimeout(()=>this.view.remove(),250)}close(){this.system._removeWindow(this),this.sizeWatcher.stop(),this.popup?this.remove():(this.remove(),this.system.root.ownerDocument.title=this.origTitle)}}class zb{constructor(t){this.firstWindow=null,this.root=(typeof t=="string"?document.getElementById(t):t)||document.body,te.touchGestures&&jb(this.root)}get screenWidth(){return this.root.clientWidth}get screenHeight(){return this.root.clientHeight}_removeWindow(t){this.firstWindow===t&&(this.firstWindow=null)}window(t,r){let{x:s,y:i}=r;t.style.setProperty("position","absolute"),r.popup?(s=Math.max(r.x||0,0),i=Math.max(r.y||0,0),r.height&&(i=Math.min(i,this.screenHeight-r.height-11)),t.style.left=s+"px",t.style.top=i+"px",t.style.boxShadow="13px 11px 6px 0px rgb(0 0 0 / 50%)",t.style.border="1px black solid",t.setAttribute("class","stratum-popup")):(t.style.transformOrigin="top left",t.setAttribute("class","stratum-window"),t.style.margin="0 auto",t.style.left="0px",t.style.right="0px"),t.style.setProperty("opacity","0"),t.style.setProperty("transition","opacity 250ms linear"),setTimeout(()=>t.style.setProperty("opacity","1")),t.style.setProperty("width",r.width?r.width+"px":"100%"),t.style.setProperty("height",r.height?r.height+"px":"100%");const n=new Yb(this,t,{...r,x:s,y:i});return!r.popup&&!this.firstWindow&&(this.firstWindow=n),n}}class qb{constructor(t){this.realWindow=t}create(t){return new Bo(t,this.realWindow)}}async function Kb(e){const{projects:t}=e;if(!t.length)throw Error("Список проектов пуст");const r=new $b(t),s=r.path(e.initial||t[0].filepath||"project.spj"),i=await r.open(s);if(!i)throw Error(`Проект ${s} не существует`);const n=new kc(r),l=new zb(te.root),a=l.root.ownerDocument.defaultView,d={sceneFactory:new qb(a),windowFactory:l};return Fb.forEach(p=>n.addPlugin(p,d)),Wb.forEach(p=>n.addOptionalPlugin(p,d)),new Lc(n,i,a)}const Zb="4.0.1";return lt.create=Kb,lt.options=te,lt.version=Zb,Object.defineProperty(lt,Symbol.toStringTag,{value:"Module"}),lt})({});
;var $GH_COMMIT = '3389a23 build(player): Удалены globals.d.ts, исп. переменные Vite';
