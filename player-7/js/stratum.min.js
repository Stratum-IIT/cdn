(function(){"use strict";try{if(typeof document<"u"){var o=document.createElement("style");o.appendChild(document.createTextNode(".yNr0VPwT{position:relative;user-select:none;width:100%;height:100%;overflow:clip}.yNr0VPwT>canvas{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%}.yNr0VPwT .doAE-L2e{all:unset;position:absolute;pointer-events:auto;background-color:#fff;resize:none;white-space:pre;box-sizing:border-box}.yNr0VPwT ._8PHlccAK{position:absolute;pointer-events:auto;background-color:#000}.yNr0VPwT.k7TCS6Hm .doAE-L2e{pointer-events:none}.yNr0VPwT .doAE-L2e.-QksePcc{white-space:wrap}.yNr0VPwT .doAE-L2e:not(.-QksePcc){overflow:hidden}.yNr0VPwT textarea.doAE-L2e.GnGoYW5X{border:inset 2px}.yNr0VPwT input[type=button].doAE-L2e{user-select:none;border:outset 2px;background-color:#f0f0f0;text-align:center}.yNr0VPwT input[type=button].doAE-L2e:active{border-style:inset}.Lub8lEDq{position:relative;user-select:none;width:100%;height:100%;overflow:clip;background-color:#fff}.Lub8lEDq>svg,.Lub8lEDq>div{pointer-events:none;position:absolute;overflow:clip;top:0;left:0;width:100%;height:100%}.Lub8lEDq ._3Au4Qe-K{all:unset;position:absolute;pointer-events:auto;background-color:#fff;resize:none;white-space:pre;box-sizing:border-box}.Lub8lEDq .uvJsh9bM{position:absolute;pointer-events:auto;background-color:#000}.Lub8lEDq.pQtj-s3j ._3Au4Qe-K{pointer-events:none}.Lub8lEDq ._3Au4Qe-K._3YpK1pvi{white-space:wrap}.Lub8lEDq ._3Au4Qe-K:not(._3YpK1pvi){overflow:hidden}.Lub8lEDq textarea._3Au4Qe-K._3n6h0K3a{border:inset 2px}.Lub8lEDq input[type=button]._3Au4Qe-K{user-select:none;border:outset 2px;background-color:#f0f0f0;text-align:center}.Lub8lEDq input[type=button]._3Au4Qe-K:active{border-style:inset}._8OpWP1FD{border-radius:16px;width:30%}._8OpWP1FD form{display:flex;flex-direction:column}._8OpWP1FD form menu{display:flex;flex-direction:column;gap:4px}._8OpWP1FD form button{height:40px}._8OpWP1FD form button[value=ok]:enabled{background-color:#90ee90}._8OpWP1FD form p{display:flex;justify-content:center}._8OpWP1FD input::file-selector-button{font-weight:700;color:#1e90ff;padding:.5em;border:thin solid grey;border-radius:3px}.wfzRA-In{position:relative;overflow:hidden;outline:none;transform-origin:top left}.wfzRA-In.XuJ-kAtH{overflow-x:auto}.wfzRA-In.W6TE00tK{overflow-y:auto}.wfzRA-In._9uw8jyO-{display:none}.wfzRA-In .wfzRA-In{position:absolute}.wfzRA-In .cl0-v9U2{position:sticky!important;top:0;left:0}.wfzRA-In .stXveFcA{pointer-events:none;position:absolute!important;top:0;left:0}.wfzRA-In .V7VkKPPF{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%}.ca85FLNJ{position:relative}.xTNo9oHR{position:absolute!important;margin:0 auto;left:0;right:0}.xTNo9oHR.mzQLXysK{transition:opacity .25s linear,box-shadow .1s linear}.xTNo9oHR.mzQLXysK:focus-within{box-shadow:0 2px 6px #0000004d}.xTNo9oHR._7gglv7SA{transition:opacity .25s linear;box-shadow:13px 11px 6px #0000007f;border:1px black solid}.xTNo9oHR .c6XZRF-R{padding:0;background-color:transparent;border:none;position:absolute;top:0;right:8px;font-size:26px;cursor:pointer;color:#333}.xTNo9oHR .c6XZRF-R:hover{color:red}")),document.head.appendChild(o)}}catch(e){console.error("vite-plugin-css-injected-by-js",e)}})();
var stratumPlayer=(function(ft){"use strict";function Ue(e,t){Object.assign(e.style,t)}const cs=document.createElement("a");function Zs(e,t){const s=URL.createObjectURL(e);cs.href=s,cs.download=t,cs.click(),setTimeout(()=>URL.revokeObjectURL(s),1e3)}function Zn(e){e.target===e.currentTarget&&e.preventDefault()}class as{constructor(t=window){this.frameId=0,this.runner=t.requestAnimationFrame}get running(){return this.frameId!==0}run(t){if(this.running)return;const{runner:s}=this,r=()=>{this.frameId=t()?s(r):0};this.frameId=s(r)}stop(){this.running&&(cancelAnimationFrame(this.frameId),this.frameId=0)}}class Qn{constructor(t){this.root=t,this.frameId=0}get isRunning(){return this.frameId!==0}run(t){if(this.isRunning)return;const{root:s}=this,r=i=>{this.frameId=t(i)?s.requestAnimationFrame(r):0};this.frameId=s.requestAnimationFrame(r)}stop(){this.isRunning&&(this.root.cancelAnimationFrame(this.frameId),this.frameId=0)}}function Qs(e){return new Promise((t,s)=>{const r=new Image;r.onload=()=>t(r),r.onerror=()=>s(new Error(`Ошибка загрузки ${e}`)),r.src=e})}function qe(e,t){if(window.OffscreenCanvas)return new OffscreenCanvas(e,t);{const s=document.createElement("canvas");return s.width=e,s.height=t,s}}const Je={contentUrl:"./content"},eo="stdlib";function We(e){if(e.startsWith("res:")){const t=e.slice(4);return t.startsWith("stdlib/")?`${Je.contentUrl}/stdlib/res/${t.slice(7)}`:`${Je.contentUrl}/libs/${t.slice(0,2)}/${t.slice(2,22)}/res/${t.slice(23)}`}return e.startsWith("icon:")?`${Je.contentUrl}/icons/${e.slice(5)}.png`:e}function to(e){return e==="stdlib"?`${Je.contentUrl}/stdlib/index.json`:`${Je.contentUrl}/libs/${e.slice(0,2)}/${e.slice(2)}/index.json`}/**
Copyright (c) 2020 Egor Nepomnyaschih @license (MIT)
*/const Re=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],er=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function At(e){if(e>=er.length)throw new Error("Unable to parse base64 string.");const t=er[e];if(t===255)throw new Error("Unable to parse base64 string.");return t}function tr(e){let t="",s,r=e.length;for(s=2;s<r;s+=3)t+=Re[e[s-2]>>2],t+=Re[(e[s-2]&3)<<4|e[s-1]>>4],t+=Re[(e[s-1]&15)<<2|e[s]>>6],t+=Re[e[s]&63];return s===r+1&&(t+=Re[e[s-2]>>2],t+=Re[(e[s-2]&3)<<4],t+="=="),s===r&&(t+=Re[e[s-2]>>2],t+=Re[(e[s-2]&3)<<4|e[s-1]>>4],t+=Re[(e[s-1]&15)<<2],t+="="),t}function sr(e){if(e.length%4!==0)throw new Error("Unable to parse base64 string.");const t=e.indexOf("=");if(t!==-1&&t<e.length-2)throw new Error("Unable to parse base64 string.");let s=e.endsWith("==")?2:e.endsWith("=")?1:0,r=e.length,i=new Uint8Array(3*(r/4)),n;for(let o=0,l=0;o<r;o+=4,l+=3)n=At(e.charCodeAt(o))<<18|At(e.charCodeAt(o+1))<<12|At(e.charCodeAt(o+2))<<6|At(e.charCodeAt(o+3)),i[l]=n>>16,i[l+1]=n>>8&255,i[l+2]=n&255;return i.subarray(0,i.length-s)}const _e=[...Array.from({length:128},(e,t)=>String.fromCharCode(t)),"Ђ","Ѓ","‚","ѓ","„","…","†","‡","€","‰","Љ","‹","Њ","Ќ","Ћ","Џ","ђ","‘","’","“","”","•","–","—","","™","љ","›","њ","ќ","ћ","џ"," ","Ў","ў","Ћ","¤","Ґ","¦","§","Ё","©","Є","«","¬","","®","Ї","°","±","І","і","ґ","µ","¶","·","ё","№","є","»","ј","Ѕ","ѕ","ї","А","Б","В","Г","Д","Е","Ж","З","И","Й","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ъ","Ы","Ь","Э","Ю","Я","а","б","в","г","д","е","ж","з","и","й","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я"];function ls(e){return Array.from(e).map(t=>_e[t]).join("")}const Nt=32,so=10;function rr(e){return new Uint8Array([...e].map(t=>{const s=_e.indexOf(t);return s>-1?s:Nt}))}class Ee{constructor(){this.listeners=new Set,this.listenersOnce=new Set}add(t){this.listeners.add(t)}addOnce(t){this.listenersOnce.add(t)}remove(t){this.listeners.delete(t),this.listenersOnce.delete(t)}dispatch(...t){this.listeners.forEach(s=>s(...t)),this.listenersOnce.forEach(s=>s(...t)),this.listenersOnce.clear()}}new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare;/**
 * Gauss-Jordan elimination by lovasoa (https://github.com/lovasoa) @license (MIT)
 */class hs{constructor(t,s){this.data=new Array(t.length);for(let r=0,i=t[0].length;r<t.length;r++){this.data[r]=new Array(i);for(let n=0;n<i;n++)this.data[r][n]=t[r][n]}if(s){if(typeof s[0]!="object")for(let r=0;r<s.length;r++)s[r]=[s[r]];this.mirror=new hs(s)}}swap(t,s){this.mirror&&this.mirror.swap(t,s);const r=this.data[t];this.data[t]=this.data[s],this.data[s]=r}multline(t,s){this.mirror&&this.mirror.multline(t,s);const r=this.data[t];for(let i=r.length-1;i>=0;i--)r[i]*=s}addmul(t,s,r){this.mirror&&this.mirror.addmul(t,s,r);const i=this.data[t],n=this.data[s];for(let o=i.length-1;o>=0;o--)i[o]=i[o]+r*n[o]}hasNullLine(t){for(let s=0;s<this.data[t].length;s++)if(this.data[t][s]!==0)return!1;return!0}gauss(){let t=0;const s=this.data.length,r=this.data[0].length,i=[];for(let n=0;n<r;n++){let o=0,l=0;for(let u=t;u<s;u++){const d=this.data[u][n];Math.abs(d)>Math.abs(o)&&(l=u,o=d)}if(o===0)i.push(t);else{this.multline(l,1/o),this.swap(l,t);for(let u=0;u<s;u++)u!==t&&this.addmul(u,t,-this.data[u][n])}t++}for(let n=0;n<i.length;n++)if(!this.mirror.hasNullLine(i[n]))throw new Error("singular matrix");return this.mirror.data}}function ro(e){const{a:t,b:s}=e,r=new hs(t,s).gauss();if(r.length>0&&r[0].length===1)for(let i=0;i<r.length;i++)r[i]=r[i][0];return r}function ir(e,t,s,r){const i=s-e,n=r-t;return Math.sqrt(i*i+n*n)}function nr(e,t,s,r,i){for(let n=t?0:2,o=t?e.length-2:0;n<e.length;o=n,n+=2){const l=e[n],u=e[n+1],d=e[o],p=e[o+1],E=l-d,w=u-p,T=E*E+w*w;if(T===0&&ir(r,i,d,p)<=s)return o/2;let R=((r-d)*E+(i-p)*w)/T;if(R=Math.max(0,Math.min(1,R)),ir(r,i,d+R*E,p+R*w)<=s)return o/2}return-1}function io(e,t,s){let r=!1;for(let i=0,n=e.length-2;i<e.length;n=i,i+=2){const o=e[i],l=e[i+1],u=e[n],d=e[n+1];(l<=s&&s<d||d<=s&&s<l)&&d-l!==0&&t>(u-o)*(s-l)/(d-l)+o&&(r=!r)}return r}function no(e){const t=e[0]*(e[4]*e[8]-e[7]*e[5])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]);return[(e[4]*e[8]-e[7]*e[5])/t,(e[2]*e[7]-e[1]*e[8])/t,(e[1]*e[5]-e[2]*e[4])/t,(e[5]*e[6]-e[3]*e[8])/t,(e[0]*e[8]-e[2]*e[6])/t,(e[3]*e[2]-e[0]*e[5])/t,(e[3]*e[7]-e[6]*e[4])/t,(e[6]*e[1]-e[0]*e[7])/t,(e[0]*e[4]-e[3]*e[1])/t]}class Me{constructor(t){this.m=new Map,t?.forEach(([s,r])=>this.set(s,r))}set(t,s){const r=this.m.get(t);return r?r.add(s):this.m.set(t,new Set([s])),this}get(t){return this.m.get(t)??null}delete(t){return this.m.delete(t)}forEach(t){return this.m.forEach(t)}[Symbol.iterator](){return this.m.entries()}values(){return this.m.values()}}const oo=[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","!","∀","#","∃","%","&","∍","(",")","*","+",",","−",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","≅","Α","Β","Χ","Δ","Ε","Φ","Γ","Η","Ι","ϑ","Κ","Λ","Μ","Ν","Ο","Π","Θ","Ρ","Σ","Τ","Υ","ς","Ω","Ξ","Ψ","Ζ","[","∴","]","⊥","_","‾","α","β","χ","δ","ε","φ","γ","η","ι","ϕ","κ","λ","μ","ν","ο","π","θ","ρ","σ","τ","υ","ϖ","ω","ξ","ψ","ζ","{","|","}","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","€","ϒ","′","≤","⁄","∞","ƒ","♣","♦","♥","♠","↔","←","↑","→","↓","°","±","″","≥","×","∝","∂","•","÷","≠","≡","≈","…","⏐","⎯","↵","ℵ","ℑ","ℜ","℘","⊗","⊕","∅","∩","∪","⊃","⊇","⊄","⊂","⊆","∈","∉","∠","∇","®","©","™","∏","√","⋅","¬","∧","∨","⇔","⇐","⇑","⇒","⇓","◊","〈","®","©","™","∑","⎛","⎜","⎝","⎡","⎢","⎣","⎧","⎨","⎩","⎪"," ","〉","∫","⌠","⎮","⌡","⎞","⎟","⎠","⎤","⎥","⎦","⎫","⎬","⎭"," "];function or(e){let t="";for(let s=0;s<e.length;++s){let r=_e.indexOf(e[s]);r===142?r=163:r<0&&(r=0),t+=oo[r]}return t}class ge extends Map{static freeKey(t,s){let r=s||0;for(;t.has(++r););return r}static freeNegativeKey(t){let s=0;for(;t.has(--s););return s}}function cr(e){return(e&e-1)===0}function co(e,t,s){return Math.min(Math.max(e,t),s)}function ar(e){return new Array().concat(...e)}function lr(e,t){const s=[];for(const r of e)t(r)&&s.push(r);return s}function ao(e,t){const s=[];for(const r of e){const i=t(r);i&&s.push(i)}return s}function lo(e){return Math.round(e*1e5)/1e5}function It(e,t,s=!1){if(e)return;let r=t;if(!s){const n=t.split(" ");n.splice(n.length-1,0,"не"),r=n.join(" ")}const i=Error(r);if(i.stack){const n=i.stack.split(`
`);i.stack=[n[0],...n.slice(2)].join(`
`)}throw i}function ho(){}const uo=["gray","blue","navy","gray","#b5b5b5","white","black","black","black","white","gray","gray","gray","navy","white","#b5b5b5","gray","gray","black","gray","white"],gt=1<<24,xt=2<<24,hr=4<<24;function fo(e){const t=parseInt(e);if(!isNaN(t))return t;const s=e.toLowerCase().trim();if(s.startsWith("rgb")){const r=s.split("(")[1].split(")")[0].split(",").map(i=>parseInt(i));return r[0]|r[1]<<8|r[2]<<16}return s.startsWith("transparent")?gt:s.startsWith("syscolor")?xt|parseInt(s.split("(")[1].split(")")[0]):0}function Ve(e){if(e&gt)return null;const t=e&255;if(e&xt)return uo[t]||"black";const s=e>>8&255,r=e>>16&255;return e&hr?`rgba(${t},${s},${r}, 0.5)`:`rgb(${t},${s},${r})`}function us(e,t,s,r){const i=r==="transparent"?gt:r==="syscolor"?xt:r==="editor"?hr:0;return e&255|(t&255)<<8|(s&255)<<16|i}function ur(e){return e&255}function dr(e){return e>>8&255}function fr(e){return e>>16&255}function go(e){if(e&gt)return"Transparent";const t=e&255;if(e&xt)return`SysColor(${t})`;const s=e>>8&255,r=e>>16&255;return`rgb(${t},${s},${r})`}const Ze=1,Pt=2,ds=4,fs=8;function pt(e){return e>>8&31}const Lt=1,gr=2,pr=4,Dt=8;class $e{constructor(t,s,{key:r,data:i}){this.scene=t,this.m=s,this.subs=new Set,this.key=r||ge.freeKey(s),this.key>0&&this.m.set(this.key,this),this.data=i?{...i}:{}}delete(){return this.subs.size?!1:(this.key>0&&this.m.delete(this.key),this.key=0,!0)}toJSON(){const{key:t,data:s}=this;let r;for(const i in s)typeof s[i]<"u"&&((r||={})[i]=s[i]);return r?{key:t,data:r}:{key:t}}}class Qe extends $e{constructor(t,s){super(t,t.objects,s),this.parent=null,this._deletedByParent=!1;const{x:r,y:i,width:n,height:o,attrib:l}=s;this.x=r??0,this.y=i??0,this.width=n??0,this.height=o??0,this.attrib=l??0}delete(){if(super.delete(),this._deletedByParent)return!0;const{parent:t,scene:s}=this;return t?.set({children:t.children.filter(r=>r.key)}),s.set({order:s.order.filter(r=>r.key)}),!0}set(t){const{attrib:s,x:r,y:i,width:n,height:o}=t;this.attrib=s??this.attrib;let l=!1;{const u=(r??this.x)-this.x,d=(i??this.y)-this.y;(u!==0||d!==0)&&(this._onMoved(u,d),l=!0)}if(n||o){const u=this.width||1,d=this.height||1,p=n&&n>0?n:u,E=o&&o>0?o:d,w=p/u,T=E/d;(w!==1||T!==1)&&(this._onResized(this.x,this.y,w,T),l=!0)}return l&&this.parent?._childChanged(),this}rotate(t,{x:s,y:r}={x:this.x,y:this.y}){return t===0?this:(this._onRotated(s,r,t),this.parent?._childChanged(),this)}isVisible(){const t=this.attrib;return t&Pt?!0:!(t&Ze||1<<pt(t)&this.scene.hiddenLayers)}updateBBox(t,s,r,i){this.x=t,this.y=s,this.width=r,this.height=i}_onMoved(t,s){this.updateBBox(this.x+t,this.y+s,this.width,this.height)}_onResized(t,s,r,i){const n=t+(this.x-t)*r,o=s+(this.y-s)*i,l=(this.width||1)*r,u=(this.height||1)*i;this.updateBBox(n,o,l,u)}_onRotated(t,s,r){const i=Math.sin(r),n=Math.cos(r),o=this.x-t,l=this.y-s,u=o*n-l*i+t,d=o*i+l*n+s;this.updateBBox(u,d,this.width,this.height)}toJSON(){const{attrib:t,height:s,width:r,x:i,y:n}=this;return{...super.toJSON(),attrib:t,height:s,width:r,x:i,y:n}}toString(){return"Графический элемент"}}class po extends Qe{constructor(t,s,r){super(t,r),this.type="group",this.children=[],this.set({...r,children:s})}delete(t){return this.children.forEach(s=>{s._deletedByParent=!0,s.delete(t)}),super.delete()}set(t,s){typeof t.children<"u"&&(this.children.forEach(i=>i.parent=null),this.children=t.children,this.children.forEach(i=>i.parent=this),this.children.length>0?this._childChanged():(this.updateBBox(this.x,this.y,0,0),this.parent?._childChanged()));const{attrib:r}=t;return typeof r<"u"&&!s&&this.children.forEach(i=>i.set({attrib:r})),super.set(t)}_childChanged(){let t=1/0,s=-1/0,r=1/0,i=-1/0;this.children.forEach(n=>{t=Math.min(t,n.x),r=Math.min(r,n.y),s=Math.max(s,n.x+n.width),i=Math.max(i,n.y+n.height)}),this.updateBBox(t,r,s-t,i-r),this.parent?._childChanged()}_onMoved(t,s){if(this.children.length===0){super._onMoved(t,s);return}this.children.forEach(r=>r._onMoved(t,s)),this.updateBBox(this.x+t,this.y+s,this.width,this.height)}_onResized(t,s,r,i){if(this.children.length===0){super._onResized(t,s,r,i);return}let n=1/0,o=-1/0,l=1/0,u=-1/0;this.children.forEach(d=>{d._onResized(t,s,r,i),n=Math.min(n,d.x),l=Math.min(l,d.y),o=Math.max(o,d.x+d.width),u=Math.max(u,d.y+d.height)}),this.updateBBox(n,l,o-n,u-l)}_onRotated(t,s,r){if(this.children.length===0){super._onRotated(t,s,r);return}let i=1/0,n=-1/0,o=1/0,l=-1/0;this.children.forEach(u=>{u._onRotated(t,s,r),i=Math.min(i,u.x),o=Math.min(o,u.y),n=Math.max(n,u.x+u.width),l=Math.max(l,u.y+u.height)}),this.updateBBox(i,o,n-i,l-o)}*descendants(t){for(const s of this.children)t&&s.key<=0||(s.type==="group"&&(yield*s.descendants(t)),yield s)}toJSON(){const{type:t}=this,{x:s,y:r,width:i,height:n,...o}=super.toJSON(),l=this.children.filter(u=>u.key>0).map(u=>u.key);return{...o,type:t,children:l}}toString(){return"Группа"}}class _r{constructor(){this.type="scene",this.onInputChanged=new Ee,this.objects=new Map,this.pens=new Map,this.brushes=new Map,this.images=new Map,this.imagesOpaque=new Map,this.strings=new Map,this.fonts=new Map,this.texts=new Map,this.x=0,this.y=0,this.order=[],this.background=null,this.hiddenLayers=0,this.grid=null,this.selectUnselectable=!1,this.disableInputs=!1}set({x:t=this.x,y:s=this.y,order:r=this.order,hiddenLayers:i=this.hiddenLayers,selectUnselectable:n=this.selectUnselectable,disableInputs:o=this.disableInputs,grid:l=this.grid,background:u=this.background}){return this.background!==u&&(this.background?.subs.delete(this),this.background=u,this.background?.subs.add(this)),this.x=Math.round(t),this.y=Math.round(s),this.order=r,this.hiddenLayers=i,this.selectUnselectable=n,this.disableInputs=o,this.grid=l,this}pick(t,s){const{order:r,hiddenLayers:i,selectUnselectable:n}=this;for(let o=r.length-1;o>=0;--o){const l=r[o],u=l.attrib,d=u&Ze,p=u&Pt,E=u&ds,w=u&fs,T=pt(u);if(d||w&&!n||!p&&1<<T&i||E)continue;let R=t-l.x,A=s-l.y,b=0;if(l.type==="line"){if(l.pen)b=l.pen.width/2||.5;else if(!l.brush)continue;b=Math.max(b,4)}else if(l.type==="textView"||l.type==="imageView"){const x=Math.sin(-l.angle),L=Math.cos(-l.angle),k=R*L-A*x,U=R*x+A*L;R=k,A=U}if(!(R<-b||R>l.width+b||A<-b||A>l.height+b)&&!(l.type==="line"&&!l.inside(R,A,b)))return l}return null}fromJSON(t){this.set({...t,background:void 0,order:void 0}).merge(t,"exact");const s=t.background&&this.brushes.get(t.background);s&&this.set({background:s})}toJSON(){const{background:t,x:s,y:r,hiddenLayers:i,selectUnselectable:n,grid:o,pens:l,brushes:u,images:d,imagesOpaque:p,fonts:E,strings:w,texts:T,objects:R,order:A}=this;return{background:t?.key,x:s,y:r,hiddenLayers:i,selectUnselectable:n,grid:o,pens:[...l.values()].map(b=>b.toJSON()),brushes:[...u.values()].map(b=>b.toJSON()),images:[...d.values()].map(b=>b.toJSON()),imagesOpaque:[...p.values()].map(b=>b.toJSON()),fonts:[...E.values()].map(b=>b.toJSON()),strings:[...w.values()].map(b=>b.toJSON()),texts:[...T.values()].map(b=>b.toJSON()),objects:[...R.values()].map(b=>b.toJSON()),order:A.filter(b=>b.key>0).map(b=>b.key)}}merge(t,s="free",r){const i=s==="free"?0:-1;function n(I,X){return s==="exact"?X?{...I,...X}:I:{...I,...X,key:i}}const o=t.pens?.map(I=>[I.key,this.pen(n(I))]),l=t.images?.map(I=>[I.key,this.image(I,n(I))]),u=t.imagesOpaque?.map(I=>[I.key,this.image(I,n(I,{opaque:!0}))]),d=t.fonts?.map(I=>[I.key,this.font(n(I))]),p=t.strings?.map(I=>[I.key,this.string(I.text||"",n(I))]),E=o?new Map(o):this.pens,w=l?new Map(l):this.images,T=u?new Map(u):this.imagesOpaque,R=d?new Map(d):this.fonts,A=p?new Map(p):this.strings,b=t.brushes?.map(I=>{const X=I.image&&T.get(I.image)||null;return[I.key,this.brush(n(I,{image:X}))]}),x=b?new Map(b):this.brushes,L=t.texts?.map(I=>{const X=I.parts.map((q,Z)=>{const he=R.get(q.font)||Ie(`Текст #${I.key}[${Z}]: Шрифт #${q.font} не существует`),ae=A.get(q.string)||Ie(`Текст #${I.key}[${Z}]: Строка #${q.string} не существует`);return{...q,font:he,string:ae}});return[I.key,this.text(X,n(I))]}),k=L?new Map(L):this.texts,U=[],B=t.objects?.map(I=>{switch(I.type){case"line":{const X=I.pen&&E.get(I.pen)||null,q=I.brush&&x.get(I.brush)||null;return[I.key,this.line(I.coords,n(I,{pen:X,brush:q}))]}case"imageView":{const q=(I.opaque?T:w).get(I.image)||Ie(`ImageView (opaque: ${I.opaque}) #${I.key}: Изображение #${I.image} не существует`);return[I.key,this.imageView(q,n(I))]}case"textView":{const X=k.get(I.text)||Ie(`TextView #${I.key}: Текст #${I.text} не существует`);return[I.key,this.textView(X,n(I))]}case"input":{const X=I.font&&R.get(I.font)||null;return[I.key,this.input(I.inputType,n(I,{font:X}))]}case"videoView":return[I.key,this.video(I.src,n(I))];case"group":{const X=this.group([],n(I));return U.push({g:X,o:I}),[I.key,X]}case"3dView":throw Error(`Объект #${I.key} является 3D проекцией. Они еще не реализованы.`)}}),G=new Map(B);for(const{g:I,o:X}of U){const q=X.children.map(Z=>G.get(Z)||Ie(`Группа #${I.key}: Объект #${Z} не существует.`));I.set({children:q})}const C=t.order?.map(I=>{const X=G.get(I)||Ie(`Объект #${I} не существует и не может быть отображен.`);return X.type==="group"&&Ie(`Объект #${I} является группой и не может быть отображен.`),X});return!r&&C?.length&&this.set({order:this.order.concat(C)}),{objects:G,brushes:x,fonts:R,images:w,imagesOpaque:T,pens:E,strings:A,texts:k,order:C||[]}}_exist(t,s){return s&&s.key&&s.key>0&&t.get(s.key)}_not(t,s){return s&&s.key&&s.key>0&&t.get(s.key)&&Ie(`Объект #${s.key} уже существует`),!0}group(t,s={}){return this._not(this.objects,s)&&new po(this,t,s)}line(t,s){return this._not(this.objects,s)&&this._line(t,s)}imageView(t,s){return this._not(this.objects,s)&&this._imageView(t,s)}textView(t,s){return this._not(this.objects,s)&&this._textView(t,s)}input(t,s){return this._not(this.objects,s)&&this._input(t,s)}video(t,s){return this._not(this.objects,s)&&this._video(t,s)}pen(t){return this._exist(this.pens,t)||this._pen(t)}brush(t){return this._exist(this.brushes,t)||this._brush(t)}image(t,s){return this._exist(s?.opaque?this.imagesOpaque:this.images,s)||this._image(t,s)}string(t,s){return this._exist(this.strings,s)||this._string(t,s)}font(t){return this._exist(this.fonts,t)||this._font(t)}text(t,s){return this._exist(this.texts,s)||this._text(t,s)}}function Ie(e){throw Error(e)}class Er extends $e{constructor(t,s){super(t,t.brushes,s),this.type="brush",this.color=0,this.style=0,this.rop=0,this.hatch=0,this.image=null,this.set(s)}set({color:t=this.color,hatch:s=this.hatch,image:r=this.image,rop:i=this.rop,style:n=this.style}){let o=!1;return this.image!==r&&(this.image?.subs.delete(this),this.image=r,this.image?.subs.add(this),o=!0),(this.color!==t||this.style!==n||this.rop!==i||this.hatch!==s)&&(this.color=t,this.style=n,this.rop=i,this.hatch=s,o=!0),o&&this.subs.forEach(l=>l._onBrushPropsChanged()),this}toJSON(){const{color:t,hatch:s,image:r,rop:i,style:n}=this;return{...super.toJSON(),color:t,hatch:s,image:r?.key,rop:i,style:n}}delete(t){if(!super.delete())return!1;const{image:s}=this;return s&&(s.subs.delete(this),t||s.delete()),!0}}const _o=7,Eo=9,mo=10,wo=0,To=1,yo=3;class bo extends Er{constructor(){super(...arguments),this._color=NaN,this._cssColor=""}getCssColor(){const{color:t}=this;return this._color!==t&&(this._color=t,this._cssColor=Ve(t)||""),this._cssColor}getGlobalCompositeOperation(){switch(this.rop){case Eo:return"multiply";case mo:return"multiply";case _o:return"difference";default:return""}}getFillStyle(t){switch(this.style){case wo:return this.getCssColor();case To:return"";case yo:return this.image?.getCanvasPattern(t)??"black";default:return"white"}}_onImageChanged(){this.subs.forEach(t=>t._onBrushPropsChanged())}}const gs=["Arial","Verdana","Tahoma","Times New Roman","Georgia","Courier New","cursive"],Oo=gs.map(e=>e.toUpperCase());function Ro(e){if(!e)return gs[0];if(e==="Symbol")return"Times New Roman";const t=e.toUpperCase(),s=t.endsWith(" CYR")?t.slice(0,-4):t;return gs[Math.max(Oo.indexOf(s),0)]}class mr extends $e{constructor(t,s){super(t,t.fonts,s),this.name="",this.size=0,this.style=0,this._fontFamily="",this.set(s)}get fontFamily(){return this._fontFamily||=Ro(this.name)}set({name:t=this.name,size:s=this.size,style:r=this.style}){let i=!0;return this.name!==t&&(this.name=t,this._fontFamily="",i=!0),(this.size!==s||this.style!==r)&&(this.size=s,this.style=r,i=!0),i&&(this.onPropsChanged(),this.subs.forEach(n=>n._onFontPropsChanged())),this}toJSON(){const{name:t,size:s,style:r}=this;return{...super.toJSON(),name:t,size:s,style:r}}}class Mo extends mr{constructor(){super(...arguments),this.inputCssFont=""}getInputCssFont(){if(this.inputCssFont)return this.inputCssFont;const{fontFamily:t,size:s,style:r}=this;return this.inputCssFont=`${r&Dt?"bold":"normal"} ${r&Lt?"italic":"normal"} ${Math.round(s*.6)}px ${t}`}transformText(t){return this.name==="Symbol"?or(t):t}onPropsChanged(){this.inputCssFont=""}}class wr extends $e{constructor(t,{width:s,height:r,src:i},n){super(t,n.opaque?t.imagesOpaque:t.images,n),this.width=s,this.height=r,this.src=i}toJSON(){const{height:t,src:s,width:r}=this;return{...super.toJSON(),height:t,src:s,width:r}}}const Tr=new Map,yr=new Map;async function vo(e){const t=await Qs(e),s=await createImageBitmap(t);return yr.set(e,s),s}class So{constructor(t){this.shouldUpdateCanvas=!1;const s=qe(t.width,t.height),r=s.getContext("2d",{alpha:!1});r.drawImage(t,0,0),this.imageCtx=r,this.imageData=r.getImageData(0,0,s.width,s.height)}getCanvasImageSource(){const{imageCtx:t}=this;return this.shouldUpdateCanvas&&(this.shouldUpdateCanvas=!1,t.putImageData(this.imageData,0,0)),t.canvas}getPixel(t,s){const{imageData:r}=this;if(t<0||s<0||t>=r.width||s>=r.height)return 0;const{data:i}=r,n=(Math.floor(s)*r.width+Math.floor(t))*4;return us(i[n],i[n+1],i[n+2],"rgb")}setPixel(t,s,r){const i=this.imageData,{data:n}=i,o=(Math.floor(s)*i.width+Math.floor(t))*4;n[o+0]=ur(r),n[o+1]=dr(r),n[o+2]=fr(r),n[o+3]=255,this.shouldUpdateCanvas=!0}}class Ao extends wr{constructor(t,s,r){super(t,s,r),this.patternCache=new WeakMap,this.imageBitmap=null,this.pixelsWrapper=null;const i=We(this.src),n=yr.get(i);if(n){this.imageBitmap=n;return}let o=Tr.get(i);o||(o=vo(i),Tr.set(i,o)),o.then(l=>{this.imageBitmap=l,this.subs.forEach(u=>u._onImageChanged())})}getPixelsWrapper(){if(this.pixelsWrapper)return this.pixelsWrapper;const{imageBitmap:t}=this;return t?this.pixelsWrapper=new So(t):null}getPixel(t,s){return this.getPixelsWrapper()?.getPixel(t,s)||0}setPixel(t,s,r){if(t<0||s<0||t>this.width||s>this.height)return!1;const i=this.getPixelsWrapper();return i&&(i.setPixel(t,s,r),this.subs.forEach(n=>n._onImageChanged())),!0}getCanvasPattern(t){const s=this.getCanvasImageSource();if(!s)return null;const r=this.patternCache.get(t);if(r)return r;const i=t.createPattern(s,"repeat");return i?(this.patternCache.set(t,i),i):null}getCanvasImageSource(){return this.pixelsWrapper?.getCanvasImageSource()||this.imageBitmap}}class br extends Qe{constructor(t,s,r){const i={...r,width:r.width??s.width,height:r.height??s.height,image:s};super(t,i),this.image=s,this.type="imageView",this.area=null,this.opaque=r.opaque??!1,s.subs.add(this),this.angle=r.angle||0,this.set(i)}set({area:t=this.area,image:s=this.image,...r}){return this.image!==s&&(this.image.subs.delete(this),this.image=s,this.image.subs.add(this)),this.area=t,super.set(r)}_onRotated(t,s,r){super._onRotated(t,s,r),this.angle+=r}toJSON(){const{image:t,area:s,opaque:r,type:i,angle:n}=this;return{...super.toJSON(),type:i,image:t.key,area:s,opaque:r,angle:n}}delete(t){const{image:s}=this;return s.subs.delete(this),t||s.delete(),super.delete()}toString(){return"Картинка"}}class No extends br{constructor(t,s,r){super(t,s,r)}_render(t){const{scene:s,angle:r,area:i,width:n,height:o}=this,{width:l,height:u}=t.canvas;let d=Math.round(this.x-s.x),p=Math.round(this.y-s.y);if(r){const R=Math.cos(r),A=Math.sin(r),b=n*R,x=n*A,L=b-o*A,k=x+o*R,U=-o*A,B=o*R,G=d+Math.min(0,b,L,U),C=d+Math.max(0,b,L,U),I=p+Math.min(0,x,k,B),X=p+Math.max(0,x,k,B);if(G>l||I>u||C<0||X<0)return}else if(d>l||p>u||d+n<0||p+o<0)return;const E=this.isVisible()&&this.image.getCanvasImageSource();if(!E)return;r&&(t.save(),t.translate(d,p),t.rotate(r),d=0,p=0);const w=Math.round(this.width),T=Math.round(this.height);if(i){const R=Math.round(i.x),A=Math.round(i.y),b=Math.round(i.w),x=Math.round(i.h);t.drawImage(E,R,A,b,x,d,p,w,T)}else t.drawImage(E,d,p,w,T);r&&t.restore()}_onImageChanged(){}}const Io=4;class Or extends Qe{constructor(t,s,r){super(t,r),this.inputType=s,this.type="input",this.value="",this.style=0,this.font=null,this.set(r)}get isMultiline(){return!!(this.style&Io)}set({value:t=this.value,style:s=this.style,font:r=this.font,...i}){return this.value!==t&&(this.value=t,this.isMultiline?this.value=this.value:t=t.replace(/[\r\n]/g,"")),this.font!==r&&(this.font?.subs.delete(this),this.font=r,this.font?.subs.add(this)),this.style=s,super.set(i)}toJSON(){const{inputType:t,style:s,font:r,type:i,value:n}=this;return{...super.toJSON(),type:i,inputType:t,exStyle:0,font:r?.key,style:s,value:n}}delete(t){const{font:s}=this;return s&&(s.subs.delete(this),t||s.delete()),super.delete()}toString(){return`Элемент интерфейса '${this.inputType}'`}}const je={"jf-scene":"yNr0VPwT","jf-input":"doAE-L2e","jf-video":"_8PHlccAK","disable-inputs":"k7TCS6Hm",multiline:"-QksePcc",border:"GnGoYW5X"},xo=64,Po=128,Lo=8388608;class Do extends Or{constructor(t,s,r){super(t,s,r),this._visible=!0,this._cssFont="",this._value="",this._x=0,this._y=0,this._w=0,this._h=0;const{style:i=0}=r;let n;s==="Button"?(n=document.createElement("input"),n.type="button",n.addEventListener("click",this)):(n=document.createElement("textarea"),n.addEventListener("input",this)),n.className=je["jf-input"],n.spellcheck=!1,n.name=`jf-${this.key}`,i&Lo&&n.classList.add(je.border),this.isMultiline&&n.classList.add(je.multiline),n.addEventListener("focus",this),n.addEventListener("blur",this),this.domElement=n}focus(){this.domElement.focus()}handleEvent(t){const{scene:s,domElement:r,style:i}=this;if(t.type==="input"){if(!(i&Po)&&r.scrollWidth>r.clientWidth){r.value=this.value;return}if(this.isMultiline){if(!(i&xo)&&r.scrollHeight>r.clientHeight){r.value=this.value;return}}else r.value=r.value.replace(/[\r\n]/g,"");this.value=this._value=r.value}s.onInputChanged.dispatch({type:t.type,scene:s,target:this})}_render(){const t=this.isVisible(),{style:s}=this.domElement;if(this._visible!==t&&(this._visible=t,t?s.removeProperty("display"):s.display="none"),!t)return;const r=this.font?.getInputCssFont()||"";this._cssFont!==r&&(this._cssFont=r,r?s.font=r:s.removeProperty("font")),this._value!==this.value&&(this.domElement.value=this._value=this.value);const i=Math.round(this.x-this.scene.x),n=Math.round(this.y-this.scene.y),o=Math.round(this.width),l=Math.round(this.height);this._x!==i&&s.setProperty("left",(this._x=i).toString()+"px"),this._y!==n&&s.setProperty("top",(this._y=n).toString()+"px"),this._w!==o&&s.setProperty("width",(this._w=o).toString()+"px"),this._h!==l&&s.setProperty("height",(this._h=l).toString()+"px")}_onFontPropsChanged(){}}class Rr extends Qe{constructor(t,s,r){super(t,r),this.type="line",this.pen=null,this.brush=null,this.start=null,this.end=null,this.setCoords(s).set(r)}get length(){return this.coords.length/2}set({pen:t=this.pen,brush:s=this.brush,start:r=this.start,end:i=this.end,...n}){let o=!1;return this.pen!==t&&(this.pen?.subs.delete(this),this.pen=t,this.pen?.subs.add(this),o=!0),this.brush!==s&&(this.brush?.subs.delete(this),this.brush=s,this.brush?.subs.add(this),o=!0),(this.start!==r||this.end!==i)&&(this.start=r,this.end=i,o=!0),o&&this.onPropsChanged(),super.set(n)}addPoint({x:t,y:s},r=this.length){const i=r*2,n=this.coords,o=t-this.x,l=s-this.y;return i<0||i>=n.length?n.push(o,l):n.splice(i,0,o,l),this._pointCountChanged(),!0}point(t){const s=t*2,r=this.coords;return s>=0&&s<r.length?{x:r[s]+this.x,y:r[s+1]+this.y}:null}setPoint(t,{x:s,y:r}){const i=t*2,n=this.coords;return i<0||i>=n.length?!1:(n[i+0]=s-this.x,n[i+1]=r-this.y,this._pointCountChanged(),!0)}removePoint(t){const s=t*2,r=this.coords;return r.length<=2||s<0||s>=r.length?!1:(r.splice(s,2),this._pointCountChanged(),!0)}setCoords(t){if(!t.length||t.length%2)throw Error("Количество координат должно быть четным.");return this.x=0,this.y=0,this.coords=t.slice(),this._pointCountChanged(),this}getIntersectionIndex(t,s){const{coords:r,brush:i,pen:n}=this;let o=0;return n&&(o=n.width/2||.5),o=Math.max(o,4),nr(r,!!i,o,t,s)}inside(t,s,r){const{coords:i,brush:n}=this;return n&&io(i,t,s)||nr(i,!!n,r,t,s)!==-1}_pointCountChanged(){const t=this.coords;let s=t[0],r=t[1],i=s,n=r;for(let o=2;o<t.length;o+=2){const l=t[o+0],u=t[o+1];l<s&&(s=l),l>i&&(i=l),u<r&&(r=u),u>n&&(n=u)}if(s!==0||r!==0)for(let o=0;o<t.length;o+=2)t[o+0]-=s,t[o+1]-=r;this.updateBBox(this.x+s,this.y+r,i-s,n-r),this.parent?._childChanged(),this.onCoordsChanged()}_onResized(t,s,r,i){const n=this.coords;for(let u=0;u<n.length;u+=2)n[u+0]*=r,n[u+1]*=i;const o=t+(this.x-t)*r,l=s+(this.y-s)*i;this.updateBBox(o,l,this.width*r,this.height*i),this.onCoordsChanged()}_onRotated(t,s,r){const i=this.coords,n=t-this.x,o=s-this.y,l=Math.sin(r),u=Math.cos(r);let d=1/0,p=-1/0,E=1/0,w=-1/0;for(let T=0;T<i.length;T+=2){const R=i[T+0]-n,A=i[T+1]-o,b=R*u-A*l+n,x=R*l+A*u+o;i[T+0]=b,i[T+1]=x,b<d&&(d=b),b>p&&(p=b),x<E&&(E=x),x>w&&(w=x)}if(d!==0||E!==0)for(let T=0;T<i.length;T+=2)i[T+0]-=d,i[T+1]-=E;this.updateBBox(this.x+d,this.y+E,p-d,w-E),this.onCoordsChanged()}toJSON(){const{coords:t,brush:s,end:r,pen:i,start:n,type:o}=this;return{...super.toJSON(),type:o,coords:t.slice(),brush:s?.key,end:r,pen:i?.key,start:n}}delete(t){const{pen:s,brush:r}=this;return s&&(s.subs.delete(this),t||s.delete()),r&&(r.subs.delete(this),t||r.delete(t)),super.delete()}toString(){return"Полилиния"}}class ko extends Rr{constructor(t,s,r){super(t,s,r),this.shouldUpdateSource=!0,this.updateRegionSize();const i=qe(this.regionWidth,this.regionHeight);this.lineCtx=i.getContext("2d",{alpha:!0})}updateRegionSize(){const t=Math.max((this.pen?.getLineWidth()||0)/2,this.start?.length||0,this.end?.length||0);this.sourceOffset=t,this.regionWidth=Math.ceil(this.width+t*2),this.regionHeight=Math.ceil(this.height+t*2)}getCanvasImageSource(){this.updateRegionSize();const{regionWidth:t,regionHeight:s}=this;if(!t||!s)return null;if(!this.shouldUpdateSource){const d=this.lineCtx.canvas;return d.width&&d.height?d:null}this.shouldUpdateSource=!1;const{coords:r,pen:i,brush:n,lineCtx:o,sourceOffset:l}=this;o.canvas.width=t,o.canvas.height=s,l&&o.translate(l,l),o.moveTo(r[0],r[1]);for(let d=2;d<r.length;d+=2)o.lineTo(r[d],r[d+1]);if(n&&r.length>4){o.closePath();const d=n.getFillStyle(o);d&&(o.fillStyle=d,o.fill("evenodd"))}const u=i&&i.getStrokeStyle();if(u){if(!n&&r.length>2){const{start:p,end:E}=this;if(p){const w=r[3],T=r[2],R=r[1],A=r[0],b=p.length,x=Math.atan2(R-w,A-T),L=x+p.angle,k=x-p.angle;o.moveTo(A,R),o.lineTo(A-b*Math.cos(L),R-b*Math.sin(L)),o.moveTo(A,R),o.lineTo(A-b*Math.cos(k),R-b*Math.sin(k))}if(E){const w=r[r.length-4],T=r[r.length-3],R=r[r.length-2],A=r[r.length-1],b=E.length,x=Math.atan2(A-T,R-w),L=x+E.angle,k=x-E.angle;o.moveTo(R,A),o.lineTo(R-b*Math.cos(L),A-b*Math.sin(L)),o.moveTo(R,A),o.lineTo(R-b*Math.cos(k),A-b*Math.sin(k))}}o.lineCap="round",o.lineJoin="round",o.lineWidth=i.getLineWidth(),o.strokeStyle=u;const d=i.getLineDash();d&&o.setLineDash(d),o.stroke()}return o.canvas}_render(t){const{scene:s,sourceOffset:r,regionWidth:i,regionHeight:n}=this,{width:o,height:l}=t.canvas,u=Math.round(this.x-s.x-r),d=Math.round(this.y-s.y-r);if(u>o||d>l||u+i<0||d+n<0)return;const p=this.isVisible()&&this.getCanvasImageSource();if(!p)return;const E=(this.brush?this.brush.getGlobalCompositeOperation():this.pen?.getGlobalCompositeOperation())||"";E?(t.globalCompositeOperation=E,t.drawImage(p,u,d),t.globalCompositeOperation="source-over"):t.drawImage(p,u,d)}onCoordsChanged(){this.shouldUpdateSource=!0}onPropsChanged(){this.shouldUpdateSource=!0}_onPenPropsChanged(){this.shouldUpdateSource=!0}_onBrushPropsChanged(){this.shouldUpdateSource=!0}}class Mr extends $e{constructor(t,s){super(t,t.pens,s),this.color=0,this.style=0,this.rop=0,this.width=0,this.set(s)}set({color:t=this.color,rop:s=this.rop,style:r=this.style,width:i=this.width}){return(this.width!==i||this.color!==t||this.style!==r||this.rop!==s)&&(this.color=t,this.style=r,this.rop=s,this.width=i,this.subs.forEach(n=>n._onPenPropsChanged())),this}toJSON(){const{color:t,rop:s,style:r,width:i}=this;return{...super.toJSON(),color:t,rop:s,style:r,width:i}}}const Co=0,Go=1,Fo=2,Bo=3,Uo=4,Wo=5,Vo=9,$o=10,jo=7,Ho=[16,4],Xo=[2,4],Yo=[16,4,2,4],zo=[16,4,2,4,2,4];class Ko extends Mr{constructor(){super(...arguments),this._color=NaN,this._cssColor=""}getCssColor(){const{color:t}=this;return this._color!==t&&(this._color=t,this._cssColor=Ve(t)||""),this._cssColor}getLineWidth(){return Math.max(Math.round(this.width),1)}getGlobalCompositeOperation(){switch(this.rop){case Vo:return"multiply";case $o:return"multiply";case jo:return"difference";default:return""}}getStrokeStyle(){return this.style!==Wo?this.getCssColor():""}getLineDash(){switch(this.style){case Co:return null;case Go:return Ho;case Fo:return Xo;case Bo:return Yo;case Uo:return zo;default:return null}}}class vr extends $e{constructor(t,s,r){super(t,t.strings,r),this.text=s,this.set({...r,text:s})}set({text:t=this.text}){return this.text!==t&&(this.text=t,this.subs.forEach(s=>s._onStringTextChanged())),this}toJSON(){const{text:t}=this;return{...super.toJSON(),text:t}}}class qo extends vr{constructor(){super(...arguments),this._text="",this.fragments=[""]}getLines(){const{text:t}=this;return this._text!==t&&(this._text=t,this.fragments=t.split(/\r\n|\n/)),this.fragments}}class Sr{constructor(t,{font:s,string:r,fgcolor:i,bgcolor:n}){this.text=t,this.font=s,this.string=r,this.fgcolor=i||0,this.bgcolor=n??gt,s.subs.add(this),r.subs.add(this)}set({font:t=this.font,string:s=this.string,fgcolor:r=this.fgcolor,bgcolor:i=this.bgcolor}){let n=!1,o=!1;return this.font!==t&&(this.font.subs.delete(this),this.font=t,t.subs.add(this),n=!0),this.string!==s&&(this.string.subs.delete(this),this.string=s,s.subs.add(this),n=!0),(this.fgcolor!==r||this.bgcolor!==i)&&(this.fgcolor=r,this.bgcolor=i,o=!0),(n||o)&&(this.onChanged(n,o),this.text.subs.forEach(l=>l._onTextPartsChanged())),this}delete(t){this.font.subs.delete(this),this.string.subs.delete(this),t||(this.font.delete(),this.string.delete())}toJSON(){const{font:t,string:s,fgcolor:r,bgcolor:i}=this;return{font:t.key,string:s.key,fgcolor:r,bgcolor:i}}}class Ar extends $e{constructor(t,s,r){super(t,t.texts,r),this.type="text",this.parts=s.map(i=>this.createPart(i,!0))}set({parts:t=this.parts},s){return this.parts!==t&&(this.parts.forEach(r=>!t.includes(r)&&r.delete(s)),this.parts=t,this.subs.forEach(r=>r._onTextPartsChanged())),this}createPart(t,s){const r=this._createPart(t);return s||this.set({parts:this.parts.concat(r)}),r}toJSON(){const t=this.parts.map(s=>s.toJSON());return{...super.toJSON(),parts:t}}delete(t){return super.delete()?(this.parts.forEach(s=>s.delete(t)),!0):!1}}const Jo=1.15,Zo=.989,Nr=qe(0,0).getContext("2d",{alpha:!1});class Qo extends Sr{constructor(t,s){super(t,s),this.textFragments=null,this._fgColor=NaN,this._bgColor=NaN,this.fontCssColor="",this.bgCssColor=""}getTextFragments(){const{fontFamily:t,size:s,style:r}=this.font,i=this.string.getLines(),n=r&Lt?"italic":"normal",l=`${r&Dt?"bold":"normal"} ${n} ${s}px ${t}`,{textFragments:u}=this;if(u&&u.cssFont===l&&u.textLines===i)return u;Nr.font=l;const d=s*Jo,p=[];return i.forEach((E,w)=>{if(w>0&&p.push({text:`
`,width:0,height:d}),E){const T=this.font.transformText(E);p.push({width:Nr.measureText(T).width,height:d,text:T})}else p.push({width:0,height:d,text:""})}),this.textFragments={cssFont:l,fragments:p,textLines:i}}getFontCssColor(){const{fgcolor:t}=this;return this._fgColor!==t&&(this._fgColor=t,this.fontCssColor=Ve(t)||"black"),this.fontCssColor}getBgCssColor(){const{bgcolor:t}=this;return this._bgColor!==t&&(this._bgColor=t,this.bgCssColor=Ve(t)||""),this.bgCssColor}_onFontPropsChanged(){this.text._onGeometryChanged()}_onStringTextChanged(){this.text._onGeometryChanged()}onChanged(t,s){t&&this.text._onGeometryChanged(),s&&this.text._onColorsChanged()}}class ec extends Ar{constructor(t,s,r){super(t,s,r),this.shouldUpdateSource=!0,this.maxWidth=0,this.maxHeight=0,this._parts=null;const i=qe(0,0);this.textCtx=i.getContext("2d",{alpha:!0})}get width(){return this.updateMetrics(),this.maxWidth}get height(){return this.updateMetrics(),this.maxHeight}updateMetrics(){const{parts:t}=this;if(this._parts===t)return;this._parts=t,this.shouldUpdateSource=!0;let s=0,r=0,i=0,n=0;for(const o of t)for(const l of o.getTextFragments().fragments){if(n=Math.max(n,l.height),l.text===`
`){r+=n,s=Math.max(s,i),i=0,n=0;continue}i+=l.width}r+=n,s=Math.max(s,i),this.maxWidth=Math.floor(s),this.maxHeight=Math.floor(r)}getCanvasImageSource(){const{textCtx:t}=this;this.updateMetrics();const{maxWidth:s,maxHeight:r}=this;if(!s||!r)return null;if(!this.shouldUpdateSource){const l=t.canvas;return l.width&&l.height?l:null}this.shouldUpdateSource=!1,t.canvas.width=Math.round(s),t.canvas.height=Math.round(r+2),t.textAlign="left",t.textBaseline="alphabetic",t.scale(Zo,1);let i=0,n=0,o=0;for(const l of this.parts){const{fragments:u,cssFont:d}=l.getTextFragments(),{style:p}=l.font,E=l.getFontCssColor(),w=l.getBgCssColor(),T=p&gr,R=p&pr;t.font=d;for(const{text:A,width:b,height:x}of u){if(o=Math.max(o,x),A===`
`){n+=o,i=0,o=0;continue}if(A){const L=Math.round(i),k=Math.round(n+x*.85);if(w){t.fillStyle=w;const B=Math.round(n);t.fillRect(L,B,Math.round(b),Math.round(x))}t.fillStyle=E,t.fillText(A,L,k);const U=Math.max(1,x/10);if(T){const B=Math.round(n+x-U);t.fillRect(L,B,Math.round(b),Math.round(U))}if(R){const B=Math.round(n+x*.55);t.fillRect(L,B,Math.round(b),Math.round(U))}}i+=b}}return t.canvas}_createPart(t){return new Qo(this,t)}_onGeometryChanged(){this._parts=null}_onColorsChanged(){this.shouldUpdateSource=!0}}class Ir extends Qe{constructor(t,s,r){const i={...r,width:r.width??s.width,height:r.height??s.height,text:s};super(t,i),this.text=s,this.type="textView",s.subs.add(this),this.angle=r.angle??0,this.set({...r,text:s})}set({text:t=this.text,...s}){return this.text!==t&&(this.text.subs.delete(this),this.text=t,this.text.subs.add(this)),super.set(s)}_onRotated(t,s,r){super._onRotated(t,s,r),this.angle+=r}toJSON(){const{text:t,angle:s,type:r}=this;return{...super.toJSON(),type:r,text:t.key,angle:s}}delete(t){const{text:s}=this;return s.subs.delete(this),t||s.delete(t),super.delete()}toString(){return"Текст"}}class tc extends Ir{constructor(t,s,r){super(t,s,r)}_render(t){const{scene:s,angle:r,width:i,height:n}=this,{width:o,height:l}=t.canvas;let u=Math.round(this.x-s.x),d=Math.round(this.y-s.y);if(r){const T=Math.cos(r),R=Math.sin(r),A=i*T,b=i*R,x=A-n*R,L=b+n*T,k=-n*R,U=n*T,B=u+Math.min(0,A,x,k),G=u+Math.max(0,A,x,k),C=d+Math.min(0,b,L,U),I=d+Math.max(0,b,L,U);if(B>o||C>l||G<0||I<0)return}else if(u>o||d>l||u+i<0||d+n<0)return;const p=this.isVisible()&&this.text.getCanvasImageSource();if(!p)return;r&&(t.save(),t.translate(u,d),t.rotate(r),u=0,d=0);const E=Math.round(this.width*1.02),w=Math.round(this.height)+2;t.drawImage(p,0,0,E,w,u,d,E,w),r&&t.restore()}_onTextPartsChanged(){}}class xr extends Qe{constructor(t,s){super(t,s),this.type="videoView",this.fixed=!1,this.fixed=s.fixed??this.fixed}set(t){return this.fixed=t.fixed??this.fixed,super.set(t)}toJSON(){throw new Error("Method not implemented.")}toString(){return"Видео"}}const kt=Je;kt.hideVideoControls=!1;let sc=class{constructor(t){this.v=t}get width(){return this.v.videoWidth}get height(){return this.v.videoHeight}};class rc extends xr{constructor(t,s,r){super(t,r),this._visible=!0,this._x=0,this._y=0,this._w=0,this._h=0;const i=this.domElement=document.createElement("video");i.className=je["jf-video"],i.src=We(s),i.controls=!kt.hideVideoControls,this.video=new sc(i)}getState(){const t=this.domElement;return t.paused?t.currentTime?"pause":"stop":"play"}setPosition(t){const s=this.domElement;return t!==s.currentTime&&(s.currentTime=t),this}getPosition(){return this.domElement.currentTime}play(){const t=this.domElement;return t.paused&&t.play(),this}stop(){const t=this.domElement;return t.paused||t.pause(),this}pause(){const t=this.domElement;return t.paused||t.pause(),t.currentTime&&(t.currentTime=0),this}_render(){const t=this.isVisible(),{style:s}=this.domElement;if(this._visible!==t&&(this._visible=t,t?s.removeProperty("display"):s.display="none"),!t)return;const r=Math.round(this.x-this.scene.x),i=Math.round(this.y-this.scene.y);if(this._x!==r&&s.setProperty("left",(this._x=r).toString()+"px"),this._y!==i&&s.setProperty("top",(this._y=i).toString()+"px"),this.fixed){const n=Math.round(this.width),o=Math.round(this.height);this._w!==n&&s.setProperty("width",(this._w=n).toString()+"px"),this._h!==o&&s.setProperty("height",(this._h=o).toString()+"px")}}}const ic=class extends _r{constructor(t){super(),this._disableInputs=!1,this.dirty=!0;const s=document.createElement("canvas");this.ctx=s.getContext("2d",{alpha:!0,desynchronized:!0});const r=this.domElement=document.createElement("div");r.className=je["jf-scene"],r.append(s),t&&this.fromJSON(t)}dispose(){}_render(t=!1){if(!t&&!this.domElement.offsetParent)return;const{disableInputs:s}=this;this._disableInputs!==s&&(this._disableInputs=s,s?this.domElement.classList.add(je["disable-inputs"]):this.domElement.classList.remove(je["disable-inputs"]));const{background:r}=this,i=this.ctx,n=i.canvas,o=n.clientWidth,l=n.clientHeight;(o!==n.width||l!==n.height)&&(n.width=o,n.height=l,this.dirty=!0),!(!this.dirty||o<1||l<1)&&(i.fillStyle=r?.getFillStyle(i)||"white",i.fillRect(0,0,o,l),this.order.forEach(u=>u._render(this.ctx)))}toBlob(t){const s=this.ctx.canvas,r=Math.max(t.x,0),i=Math.max(t.y,0),n=Math.min(t.w,s.width),o=Math.min(t.h,s.height),l=qe(n,o);return l.getContext("2d",{alpha:!1}).drawImage(this.ctx.canvas,r,i,n,o,0,0,n,o),l instanceof OffscreenCanvas?l.convertToBlob():new Promise(p=>l.toBlob(E=>p(E)))}_line(t,s={}){return new ko(this,t,s)}_imageView(t,s={}){return new No(this,t,s)}_textView(t,s={}){return new tc(this,t,s)}_input(t,s={}){const r=new Do(this,t,s);return this.domElement.append(r.domElement),r}_video(t,s={}){const r=new rc(this,t,s);return this.domElement.append(r.domElement),r}_pen(t={}){return new Ko(this,t)}_brush(t={}){return new bo(this,t)}_image(t,s={}){return new Ao(this,t,s)}_string(t,s={}){return new qo(this,t,s)}_font(t={}){return new Mo(this,t)}_text(t,s={}){return new ec(this,t,s)}_onBrushPropsChanged(){}},nc=9,oc=10,cc=0,ac=1,lc=3;class hc extends Er{constructor(){super(...arguments),this._color=NaN,this._cssColor=null}cssColor(){return this._color!==this.color?this._cssColor=Ve(this._color=this.color):this._cssColor}blend(){switch(this.rop){case nc:return"multiply";case oc:return"multiply";default:return null}}fill(){switch(this.style){case cc:return this.cssColor();case ac:return null;case lc:return this.image?.pattern()??"black";default:return"white"}}}class uc extends mr{constructor(){super(...arguments),this._size=NaN,this._style=NaN,this._family="",this._textDecoration="",this._fontStyle="",this._fontWeight="",this._css=this.css(),this.inputCssFont=""}getInputCssFont(){if(this.inputCssFont)return this.inputCssFont;const{fontFamily:t,size:s,style:r}=this;return this.inputCssFont=`${r&Dt?"bold":"normal"} ${r&Lt?"italic":"normal"} ${Math.round(s*.6)}px ${t}`}transformText(t){return this.name==="Symbol"?or(t):t}css(){const{fontFamily:t,size:s,style:r}=this;let i=!1;if(this._style!==r){this._style=r,i=!0;const n=r&Lt,o=r&gr,l=r&pr,u=r&Dt;this._textDecoration=`${o?"underline":""} ${l?"line-through":""}`,this._fontStyle=n?"italic":"normal",this._fontWeight=u?"bold":"normal"}return this._family!==t&&(this._family=t,i=!0),this._size!==s&&(this._size=s,i=!0),i?this._css={isSymbolFont:this.name==="Symbol",fontFamily:this._family,textDecoration:this._textDecoration,fontSize:s||15.940224159402327,fontStyle:this._fontStyle,fontWeight:this._fontWeight}:this._css}onPropsChanged(){this.inputCssFont=""}}let dc=0;class fc extends wr{constructor(t,s,r){super(t,s,r),this._pattern=null,this.resolvedSrc=We(this.src)}getPixel(){return 0}setPixel(){return!0}pattern(){if(this._pattern)return this._pattern.url;const t=document.createElementNS("http://www.w3.org/2000/svg","pattern"),s=`pattern_${++dc}`;t.setAttribute("id",s),t.setAttribute("patternUnits","userSpaceOnUse"),t.setAttribute("width",this.width.toString()),t.setAttribute("height",this.height.toString());const r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttribute("href",this.resolvedSrc),t.appendChild(r),this.scene._defs.appendChild(t);const i=`url(#${s})`;return this._pattern={e:t,url:i},i}}class gc extends br{constructor(t,s,r){super(t,s,r),this._svg=document.createElementNS("http://www.w3.org/2000/svg","image"),this._visible=!0,this._src=null,this._area=null,this._x=0,this._y=0,this._w=0,this._h=0,this._angle=0,this.clipRect=null,this.hasArea=!0,this._svg.setAttribute("preserveAspectRatio","none")}_render(){const t=this.attrib,s=t&Ze,r=pt(t),i=!(s||1<<r&this.scene.hiddenLayers);if(this._visible!==i&&(this._visible=i,i?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!i)return;const n=this.image,o=this._src!==n.resolvedSrc;o&&this._svg.setAttribute("href",this._src=n.resolvedSrc);const l=this.area,u=!!l,d=this.hasArea!==u;this.hasArea=u;const p=this._area!==l||o;if(p){this._area=l;const b=n.width,x=n.height;if(l){const L=Math.min(Math.max(l.x,0),b),k=Math.min(Math.max(l.y,0),x),U=Math.min(Math.max(l.w,0),b-L),B=Math.min(Math.max(l.h,0),x-k);if(!this.clipRect){const{id:C,rect:I}=this.scene._createClipRect();this._svg.setAttribute("clip-path",`url(#${C})`),this.clipRect=I}const{clipRect:G}=this;G.setAttribute("x",L.toString()),G.setAttribute("y",k.toString()),G.setAttribute("width",U.toString()),G.setAttribute("height",B.toString())}else this._svg.removeAttribute("clip-path"),this.clipRect?.remove(),this.clipRect=null}const E=this.x-this.scene.x,w=this.y-this.scene.y,T=this.width,R=this.height,A=this.angle;if(E!==this._x||w!==this._y||this._w!==T||this._h!==R||this._angle!==A||p){const{area:b}=this;this._x=E,this._y=w,this._w=T,this._h=R,this._angle=A;let x=`translate(${E}, ${w}),rotate(${A*180/Math.PI})`;b?x+=`scale(${T/b.w}, ${R/b.h}), translate(${-b.x}, ${-b.y})`:(this._svg.setAttribute("width",T.toString()),this._svg.setAttribute("height",R.toString())),this._svg.setAttribute("transform",x),d&&(u?(this._svg.removeAttribute("width"),this._svg.removeAttribute("height")):(this._svg.setAttribute("width",T.toString()),this._svg.setAttribute("height",R.toString())))}}}const He={"jf-scene":"Lub8lEDq","jf-input":"_3Au4Qe-K","jf-video":"uvJsh9bM","disable-inputs":"pQtj-s3j",multiline:"_3YpK1pvi",border:"_3n6h0K3a"},pc=64,_c=128,Ec=8388608;class mc extends Or{constructor(t,s,r){super(t,s,r),this._visible=!0,this._cssFont="",this._value="",this._x=0,this._y=0,this._w=0,this._h=0;const{style:i=0}=r;let n;s==="Button"?(n=document.createElement("input"),n.type="button",n.addEventListener("click",this)):(n=document.createElement("textarea"),n.addEventListener("input",this)),n.className=He["jf-input"],n.spellcheck=!1,n.name=`jf-${this.key}`,i&Ec&&n.classList.add(He.border),this.isMultiline&&n.classList.add(He.multiline),n.addEventListener("focus",this),n.addEventListener("blur",this),this._html=n}focus(){this._html.focus()}handleEvent(t){const{scene:s,_html:r,style:i}=this;if(t.type==="input"){if(!(i&_c)&&r.scrollWidth>r.clientWidth){r.value=this.value;return}if(this.isMultiline){if(!(i&pc)&&r.scrollHeight>r.clientHeight){r.value=this.value;return}}else r.value=r.value.replace(/[\r\n]/g,"");this.value=this._value=r.value}s.onInputChanged.dispatch({type:t.type,scene:s,target:this})}_render(){const t=this.isVisible(),{style:s}=this._html;if(this._visible!==t&&(this._visible=t,t?s.removeProperty("display"):s.display="none"),!t)return;const r=this.font?.getInputCssFont()||"";this._cssFont!==r&&(this._cssFont=r,r?s.font=r:s.removeProperty("font")),this._value!==this.value&&(this._html.value=this._value=this.value);const i=Math.round(this.x-this.scene.x),n=Math.round(this.y-this.scene.y),o=Math.round(this.width),l=Math.round(this.height);this._x!==i&&s.setProperty("left",(this._x=i).toString()+"px"),this._y!==n&&s.setProperty("top",(this._y=n).toString()+"px"),this._w!==o&&s.setProperty("width",(this._w=o).toString()+"px"),this._h!==l&&s.setProperty("height",(this._h=l).toString()+"px")}_onFontPropsChanged(){}}let wc=0;function Tc(){const e=`mark_${++wc}`,t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id",e),t.setAttribute("orient","auto"),t.setAttribute("refX","0");const s=document.createElementNS("http://www.w3.org/2000/svg","polyline");return t.appendChild(s),{shape:s,marker:t,id:e}}function Pr(e,t,s,r){const i=s.width||1,n=s.stroke(),o=t.fill?n:null,l=t.fill?null:n;e.marker.setAttribute("markerWidth",(t.width+i).toString()),e.marker.setAttribute("markerHeight",(t.oy*2+i).toString()),r&&e.marker.setAttribute("refX",t.width.toString()),e.marker.setAttribute("refY",t.oy.toString()),e.marker.setAttribute("markerUnits","userSpaceOnUse"),e.shape.setAttribute("points",t.coords),e.shape.setAttribute("stroke-width",i.toString()),l?e.shape.setAttribute("stroke",l):e.shape.removeAttribute("stroke"),e.shape.setAttribute("fill",o||"none")}function Lr(e,t){if(e.angle===0||e.length===0)return null;const s=Math.abs(e.length*Math.sin(e.angle)),r=Math.abs(e.length*Math.cos(e.angle)),i=t?[0,0,r,s,0,s*2]:[r,0,0,s,r,s*2];return{coords:Dr(i),fill:e.fill??!1,width:r,oy:s}}function Dr(e){let t="";for(let s=0;s<e.length;s+=2)t+=e[s]+","+e[s+1]+" ";return t}function kr(e){const t=document.createElementNS("http://www.w3.org/2000/svg",e);return t.setAttribute("fill-rule","evenodd"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t}class yc extends Rr{constructor(t,s,r){super(t,s,r),this._visible=!0,this._width=0,this._stroke=null,this._dash=null,this._fill=null,this._blend=null,this._start=null,this._startMark=null,this._end=null,this._endMark=null,this._x=0,this._y=0,this.shouldUpdateCoords=!0,this._svg=kr(this._svgType=r.brush&&s.length>4?"polygon":"polyline")}createMarker(t){const s=Tc();return this.scene._defs.appendChild(s.marker),this._svg.setAttribute(t?"marker-start":"marker-end",`url(#${s.id})`),s}_render(){const t=this.attrib,s=t&Ze,r=t&Pt,i=pt(t),{pen:n,brush:o}=this,l=!s&&!!(n||o)&&(!!r||!(1<<i&this.scene.hiddenLayers));if(this._visible!==l&&(this._visible=l,l?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!l)return;const u=this.brush&&this.length>2?"polygon":"polyline";if(this._svgType!==u){this._svgType=u,this.shouldUpdateCoords=!0,this._width=0,this._stroke=null,this._dash=null,this._fill=null,this._blend=null,this._start=null,this._startMark=null,this._end=null,this._endMark=null,this._x=0,this._y=0;const L=kr(u);this._svg.parentElement&&this._svg.replaceWith(L),this._svg=L}this.shouldUpdateCoords&&(this.shouldUpdateCoords=!1,this._svg.setAttribute("points",Dr(this.coords)));const d=n?.width||1,p=n?.stroke()||null,E=n?.dash()||null;if(this._width!==d){this._width=d;const L=d.toString();this._svg.setAttribute("stroke-width",L),this._startMark?.shape.setAttribute("stroke-width",L),this._endMark?.shape.setAttribute("stroke-width",L)}this._stroke!==p&&(this._stroke=p,p?(this._svg.setAttribute("stroke",p),this._startMark?.shape.setAttribute("stroke",p),this._endMark?.shape.setAttribute("stroke",p)):this._svg.removeAttribute("stroke")),this._dash!==E&&(this._dash=E,E?this._svg.setAttribute("stroke-dasharray",E):this._svg.removeAttribute("stroke-dasharray"));const w=this.length>2&&o?.fill()||"none";this._fill!==w&&(this._fill=w,this._svg.setAttribute("fill",w));const T=o?.blend()||n?.blend()||null;this._blend!==T&&(this._blend=T,T?this._svg.style.setProperty("mix-blend-mode",T):this._svg.style.removeProperty("mix-blend-mode"));const R=n&&(o?null:this.start),A=n&&(o?null:this.end);if(this._start!==R){this._start=R;const L=R&&Lr(R,!1);L?Pr(this._startMark||=this.createMarker(!0),L,n,!0):(this._startMark?.marker.remove(),this._startMark=null)}if(this._end!==A){this._end=A;const L=A&&Lr(A,!0);L?Pr(this._endMark||=this.createMarker(!1),L,n,!1):(this._endMark?.marker.remove(),this._endMark=null)}const b=this.x-this.scene.x,x=this.y-this.scene.y;(b!==this._x||x!==this._y)&&(this._x=b,this._y=x,this._svg.setAttribute("transform",`translate(${b}, ${x})`))}onCoordsChanged(){this.shouldUpdateCoords=!0}onPropsChanged(){}_onPenPropsChanged(){}_onBrushPropsChanged(){}}const bc=0,Oc=1,Rc=2,Mc=3,vc=4,Sc=5,Ac=9,Nc=10;class Ic extends Mr{constructor(){super(...arguments),this._color=NaN,this._cssColor=null}cssColor(){return this._color!==this.color?this._cssColor=Ve(this._color=this.color):this._cssColor}blend(){switch(this.rop){case Ac:return"multiply";case Nc:return"multiply";default:return null}}stroke(){return this.style===Sc?null:this.cssColor()}dash(){switch(this.style){case bc:return null;case Oc:return"16 4";case Rc:return"2 4";case Mc:return"16 4 2 4";case vc:return"16 4 2 4 2 4";default:return null}}}class xc extends vr{constructor(){super(...arguments),this._text="",this._parts=[""]}split(){return this._text!==this.text?this._parts=(this._text=this.text).split(`\r
`).join(`
`).split(`
`):this._parts}}class Pc extends Sr{onChanged(){}_onStringTextChanged(){}_onFontPropsChanged(){}}class Lc extends Ar{constructor(){super(...arguments),this._textCalc=null}get width(){return this._textCalc?.().w??0}get height(){return this._textCalc?.().h??0}_createPart(t){return new Pc(this,t)}onTextPartsChanged(){}}function Cr(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return e&&(t.setAttribute("x","0px"),t.setAttribute("dy","1.15em")),t}class Dc{constructor(t,s){this.owner=t,this.part=s,this._fragments=[],this._css=null,this._fgcolor=NaN,this.spans=s.string.split().map((r,i)=>Cr(i>0))}update(){let t=!1;const{part:s,spans:r}=this,i=s.string.split(),n=s.font.css();if(this._fragments!==i){this._fragments=i,t=!0,r.length!==i.length&&(this._fgcolor=NaN);let o;for(let l=0;l<i.length;++l){if(l<r.length)o=r[l];else{const d=Cr(!0);r.push(d),o.after(d),o=d,this._css=null}let u=i[l];n.isSymbolFont&&(u=s.font.transformText(u)),o.textContent=u||"​"}for(;r.length>i.length;)r.pop()?.remove()}if(this._css!==n&&(this._css=n,t=!0,r.forEach(o=>{o.setAttribute("font-family",n.fontFamily),o.setAttribute("font-size",n.fontSize.toString()),o.setAttribute("font-style",n.fontStyle),o.setAttribute("text-decoration",n.textDecoration),o.setAttribute("font-weight",n.fontWeight)})),this._fgcolor!==s.fgcolor){this._fgcolor=s.fgcolor;const o=Ve(s.fgcolor)??"transparent";r.forEach(l=>l.setAttribute("fill",o))}return t}}class kc extends Ir{constructor(t,s,r){if(super(t,s,r),this._svg=document.createElementNS("http://www.w3.org/2000/svg","text"),this._visible=!0,this._parts=[],this._partsSVG=[],this._sizes={w:0,h:0},this._angle=0,this._x=0,this._y=0,this._svg.setAttribute("dominant-baseline","text-before-edge"),this._svg.setAttribute("alignment-baseline","text-before-edge"),this._svg.setAttribute("letter-spacing","-0.07"),this._svg.style.setProperty("white-space","pre"),this._svg.style.setProperty("user-select","none"),s._textCalc=this._calcSizes.bind(this),!r.width||!r.height){const i=r.width??s.width,n=r.height??s.height;this.updateBBox(this.x,this.y,i,n)}}_calcSizes(){const t=this.text.parts;if(!t||!this.updateParts(t))return this._sizes;const s=this._svg.parentElement;s||this.scene._root.appendChild(this._svg);const{y:r=0,width:i,height:n}=this._svg.getBBox();return s||this._svg.remove(),this._sizes={w:i,h:r+n}}updateParts(t){if(this._parts!==t){this._parts=t;const s=[];this._partsSVG=t.map(r=>{const i=new Dc(this,r);return s.push(...i.spans),i}),this._svg.replaceChildren(...s)}return this._partsSVG.reduce((s,r)=>r.update()||s,!1)}_render(){const t=this.attrib,s=t&Ze,r=t&Pt,i=pt(t),n=this.text.parts,o=(!!r||!(s||1<<i&this.scene.hiddenLayers))&&!!n;if(this._visible!==o&&(this._visible=o,o?this._svg.removeAttribute("display"):this._svg.setAttribute("display","none")),!o)return;this.updateParts(n);const l=this.x-this.scene.x,u=this.y-this.scene.y,d=this.angle;(l!==this._x||u!==this._y||this._angle!==d)&&(this._x=l,this._y=u,this._angle=d,this._svg.setAttribute("transform",`translate(${l}, ${u}), rotate(${d*180/Math.PI})`))}_onTextPartsChanged(){}}function Gr(e,t,s){const r=new Set(s);let i=0,n=null;t.forEach(o=>{if(r.delete(o),i<s.length&&o===s[i])++i;else{const l=n?n.nextElementSibling:e.firstElementChild;e.insertBefore("_svg"in o?o._svg:o._html,l)}n="_svg"in o?o._svg:o._html}),r.forEach(o=>("_svg"in o?o._svg:o._html).remove())}class Cc{constructor(t){this.v=t}get width(){return this.v.videoWidth}get height(){return this.v.videoHeight}}class Gc extends xr{constructor(t,s,r){super(t,r),this._visible=!0,this._x=0,this._y=0,this._w=0,this._h=0;const i=this._html=document.createElement("video");i.className=He["jf-video"],i.src=We(s),i.controls=!kt.hideVideoControls,this.video=new Cc(i)}getState(){const t=this._html;return t.paused?t.currentTime?"pause":"stop":"play"}setPosition(t){const s=this._html;return t!==s.currentTime&&(s.currentTime=t),this}getPosition(){return this._html.currentTime}play(){const t=this._html;return t.paused&&t.play(),this}stop(){const t=this._html;return t.paused||t.pause(),this}pause(){const t=this._html;return t.paused||t.pause(),t.currentTime&&(t.currentTime=0),this}_render(){const t=this.isVisible(),{style:s}=this._html;if(this._visible!==t&&(this._visible=t,t?s.removeProperty("display"):s.display="none"),!t)return;const r=Math.round(this.x-this.scene.x),i=Math.round(this.y-this.scene.y);if(this._x!==r&&s.setProperty("left",(this._x=r).toString()+"px"),this._y!==i&&s.setProperty("top",(this._y=i).toString()+"px"),this.fixed){const n=Math.round(this.width),o=Math.round(this.height);this._w!==n&&s.setProperty("width",(this._w=n).toString()+"px"),this._h!==o&&s.setProperty("height",(this._h=o).toString()+"px")}}}let Fc=0;class Bc extends _r{constructor(t){super(),this._disableInputs=!1,this.prevOrder=[],this.svgOrder=[],this.htmlOrder=[],this.bgRect=null,this._bg=null;const s=this._root=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=this._defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=this.htmlRoot=document.createElement("div"),n=this.domElement=document.createElement("div");n.className=He["jf-scene"],s.append(r),n.append(s,i),t&&this.fromJSON(t)}dispose(){}_render(t=!1){if(!t&&!this.domElement.parentElement)return;const{background:s,prevOrder:r,svgOrder:i,_root:n,htmlOrder:o,htmlRoot:l}=this,{disableInputs:u}=this;this._disableInputs!==u&&(this._disableInputs=u,u?this.domElement.classList.add(He["disable-inputs"]):this.domElement.classList.remove(He["disable-inputs"]));const d=s?.fill()??null;let p=!1;if(p=this._bg!==d)if(this._bg=d,d){if(!this.bgRect){const w=document.createElementNS("http://www.w3.org/2000/svg","rect");w.setAttribute("width","100%"),w.setAttribute("height","100%"),this.bgRect={_svg:w}}this.bgRect._svg.setAttribute("fill",d)}else this.bgRect?._svg.remove(),this.bgRect=null;const E=this.order;if(r!==E||p){const w=this.bgRect?[this.bgRect]:[],T=[];E.forEach(R=>{"_svg"in R?w.push(R):T.push(R)}),i.length>0?Gr(n,w,i):n.append(...w.map(R=>R._svg)),o.length>0?Gr(l,T,o):T.length>0&&l.append(...T.map(R=>R._html)),this.svgOrder=w,this.htmlOrder=T,this.prevOrder=E}E.forEach(w=>w._render())}toSVG(t,s){const{x:r,y:i,hiddenLayers:n}=this;this.set({x:t.x,y:t.y,hiddenLayers:0}),this._render(!0);let o;return s?(o=this._root,this.dispose()):(o=this._root.cloneNode(!0),this.set({x:r,y:i,hiddenLayers:n}),t&&this._render(!0)),o.removeAttribute("style"),o.removeAttribute("class"),o.setAttribute("viewBox",`0 0 ${t.w} ${t.h}`),o}toBlob(t){const s=this.toSVG(t);s.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttribute("width",t.w+"px"),s.setAttribute("height",t.h+"px"),s.setAttribute("preserveAspectRatio","xMidYMid slice");const i=`<?xml version="1.0"?>\r
`+new XMLSerializer().serializeToString(s);return Promise.resolve(new Blob([i],{type:"image/svg+xml"}))}_line(t,s={}){return new yc(this,t,s)}_imageView(t,s={}){return new gc(this,t,s)}_textView(t,s={}){return new kc(this,t,s)}_input(t,s={}){return new mc(this,t,s)}_video(t,s={}){return new Gc(this,t,s)}_pen(t={}){return new Ic(this,t)}_brush(t={}){return new hc(this,t)}_image(t,s={}){return new fc(this,t,s)}_string(t,s={}){return new xc(this,t,s)}_font(t={}){return new uc(this,t)}_text(t,s={}){return new Lc(this,t,s)}_createClipRect(){const t=`clipPath_${++Fc}`,s=document.createElementNS("http://www.w3.org/2000/svg","clipPath");s.setAttribute("id",t);const r=document.createElementNS("http://www.w3.org/2000/svg","rect");return s.appendChild(r),this._defs.appendChild(s),{id:t,rect:r}}_onBrushPropsChanged(){}}const Uc=Bc;var P=(e=>(e[e.PI=3.1415926536]="PI",e[e.WORD8=0]="WORD8",e[e.INT8=1]="INT8",e[e.WORD16=2]="WORD16",e[e.INT16=3]="INT16",e[e.WORD32=4]="WORD32",e[e.INT32=5]="INT32",e[e.FLOAT32=6]="FLOAT32",e[e.FLOAT40=7]="FLOAT40",e[e.FLOAT64=8]="FLOAT64",e[e.FLOAT80=9]="FLOAT80",e[e.PEN2D=1]="PEN2D",e[e.BRUSH2D=2]="BRUSH2D",e[e.DIB2D=3]="DIB2D",e[e.DOUBLEDIB2D=4]="DOUBLEDIB2D",e[e.FONT2D=5]="FONT2D",e[e.STRING2D=6]="STRING2D",e[e.TEXT2D=7]="TEXT2D",e[e.SPACE3D=8]="SPACE3D",e[e.TEXTURE3D=9]="TEXTURE3D",e[e.WM_DESTROY=2]="WM_DESTROY",e[e.WM_MOVE=3]="WM_MOVE",e[e.WM_SIZE=5]="WM_SIZE",e[e.WM_CLOSE=16]="WM_CLOSE",e[e.WM_GETMINMAXINFO=36]="WM_GETMINMAXINFO",e[e.WM_COMMAND=273]="WM_COMMAND",e[e.WM_MOUSEMOVE=512]="WM_MOUSEMOVE",e[e.WM_LBUTTONDOWN=513]="WM_LBUTTONDOWN",e[e.WM_LBUTTONUP=514]="WM_LBUTTONUP",e[e.WM_LBUTTONDBLCLK=515]="WM_LBUTTONDBLCLK",e[e.WM_RBUTTONDOWN=516]="WM_RBUTTONDOWN",e[e.WM_RBUTTONUP=517]="WM_RBUTTONUP",e[e.WM_RBUTTONDBLCLK=518]="WM_RBUTTONDBLCLK",e[e.WM_MBUTTONDOWN=519]="WM_MBUTTONDOWN",e[e.WM_MBUTTONUP=520]="WM_MBUTTONUP",e[e.WM_MBUTTONDBLCLK=521]="WM_MBUTTONDBLCLK",e[e.WM_ALLMOUSEMESSAGE=1536]="WM_ALLMOUSEMESSAGE",e[e.WM_ALLKEYMESSAGE=1537]="WM_ALLKEYMESSAGE",e[e.WM_KEYDOWN=256]="WM_KEYDOWN",e[e.WM_KEYUP=257]="WM_KEYUP",e[e.WM_CANCLOSE=1538]="WM_CANCLOSE",e[e.WM_SPACEDONE=1539]="WM_SPACEDONE",e[e.WM_SPACEINIT=1540]="WM_SPACEINIT",e[e.WM_CONTROLNOTIFY=1544]="WM_CONTROLNOTIFY",e[e.WM_HYPERJUMP=1546]="WM_HYPERJUMP",e[e.SIZE_RESTORED=0]="SIZE_RESTORED",e[e.SIZE_MINIMIZED=1]="SIZE_MINIMIZED",e[e.SIZE_MAXIMIZED=2]="SIZE_MAXIMIZED",e[e.SIZE_MAXSHOW=3]="SIZE_MAXSHOW",e[e.SIZE_MAXHIDE=4]="SIZE_MAXHIDE",e[e.OTGROUP2D=3]="OTGROUP2D",e[e.OTRGROUP2D=4]="OTRGROUP2D",e[e.OTGROUP3D=5]="OTGROUP3D",e[e.OTOBJECT3D=10]="OTOBJECT3D",e[e.OTLINE_2D=20]="OTLINE_2D",e[e.OTBITMAP_2D=21]="OTBITMAP_2D",e[e.OTDOUBLEBITMAP_2D=22]="OTDOUBLEBITMAP_2D",e[e.OTTEXT_2D=23]="OTTEXT_2D",e[e.OTVIEW3D_2D=24]="OTVIEW3D_2D",e[e.OTEDITFRAME=50]="OTEDITFRAME",e[e.OTROTATECENTER=51]="OTROTATECENTER",e[e.OTFRAME3D=52]="OTFRAME3D",e[e.OTAXIS3D=53]="OTAXIS3D",e[e.OTPEN2D=101]="OTPEN2D",e[e.OTBRUSH2D=102]="OTBRUSH2D",e[e.OTDIB2D=103]="OTDIB2D",e[e.OTDOUBLEDIB2D=104]="OTDOUBLEDIB2D",e[e.OTFONT2D=105]="OTFONT2D",e[e.OTSTRING2D=106]="OTSTRING2D",e[e.OTTEXT2D=107]="OTTEXT2D",e[e.OTREFTODIB2D=110]="OTREFTODIB2D",e[e.OTREFTODOUBLEDIB2D=111]="OTREFTODOUBLEDIB2D",e[e.ATTRSET=1]="ATTRSET",e[e.ATTRRESET=2]="ATTRRESET",e[e.ATTRPUT=3]="ATTRPUT",e[e.PFC_MOVEOBJECT=32768]="PFC_MOVEOBJECT",e[e.PFC_SETCURRENT=16384]="PFC_SETCURRENT",e[e.PFC_SETFRAME=8192]="PFC_SETFRAME",e[e.PFC_PENS=1]="PFC_PENS",e[e.PFC_BRUHS=2]="PFC_BRUHS",e[e.PFC_DIBS=4]="PFC_DIBS",e[e.PFC_DDIBS=8]="PFC_DDIBS",e[e.PFC_STRINGS=16]="PFC_STRINGS",e[e.PFC_FONTS=32]="PFC_FONTS",e[e.PFC_TEXTS=64]="PFC_TEXTS",e[e.PFC_3D=128]="PFC_3D",e[e.PFC_ALL=255]="PFC_ALL",e[e.OID_RESERVED=32e3]="OID_RESERVED",e[e.OID_RCENTER=32001]="OID_RCENTER",e[e.OID_FRAME2D1=32002]="OID_FRAME2D1",e[e.OID_FRAME2D2=32003]="OID_FRAME2D2",e[e.OID_FRAME2D3=32004]="OID_FRAME2D3",e[e.OID_FRAME2D4=32005]="OID_FRAME2D4",e[e.OID_FRAME2D5=32006]="OID_FRAME2D5",e[e.OID_FRAME2D6=32007]="OID_FRAME2D6",e[e.OID_FRAME2D7=32008]="OID_FRAME2D7",e[e.OID_FRAME2D8=32009]="OID_FRAME2D8",e[e.OID_FRAME2D=32010]="OID_FRAME2D",e[e.OID_AXIS3D=32100]="OID_AXIS3D",e[e.OID_FRAME3D1=32102]="OID_FRAME3D1",e[e.OID_FRAME3D2=32103]="OID_FRAME3D2",e[e.OID_FRAME3D3=32104]="OID_FRAME3D3",e[e.OID_FRAME3D4=32105]="OID_FRAME3D4",e[e.OID_FRAME3D5=32106]="OID_FRAME3D5",e[e.OID_FRAME3D6=32107]="OID_FRAME3D6",e[e.OID_FRAME3D7=32108]="OID_FRAME3D7",e[e.OID_FRAME3D8=32109]="OID_FRAME3D8",e[e.OID_FRAME3D=32110]="OID_FRAME3D",e[e.MB_OK=0]="MB_OK",e[e.MB_OKCANCEL=1]="MB_OKCANCEL",e[e.MB_ABORTRETRYIGNORE=2]="MB_ABORTRETRYIGNORE",e[e.MB_YESNOCANCEL=3]="MB_YESNOCANCEL",e[e.MB_YESNO=4]="MB_YESNO",e[e.MB_RETRYCANCEL=5]="MB_RETRYCANCEL",e[e.MB_TYPEMASK=15]="MB_TYPEMASK",e[e.MB_ICONHAND=16]="MB_ICONHAND",e[e.MB_ICONQUESTION=32]="MB_ICONQUESTION",e[e.MB_ICONEXCLAMATION=48]="MB_ICONEXCLAMATION",e[e.MB_ICONASTERISK=64]="MB_ICONASTERISK",e[e.MB_ICONMASK=240]="MB_ICONMASK",e[e.MB_ICONINFORMATION=64]="MB_ICONINFORMATION",e[e.MB_ICONSTOP=16]="MB_ICONSTOP",e[e.MB_DEFBUTTON1=0]="MB_DEFBUTTON1",e[e.MB_DEFBUTTON2=256]="MB_DEFBUTTON2",e[e.MB_DEFBUTTON3=512]="MB_DEFBUTTON3",e[e.MB_DEFMASK=3840]="MB_DEFMASK",e[e.MB_APPLMODAL=0]="MB_APPLMODAL",e[e.MB_SYSTEMMODAL=4096]="MB_SYSTEMMODAL",e[e.MB_TASKMODAL=8192]="MB_TASKMODAL",e[e.MB_NOFOCUS=32768]="MB_NOFOCUS",e[e.SW_HIDE=0]="SW_HIDE",e[e.SW_SHOWNORMAL=1]="SW_SHOWNORMAL",e[e.SW_NORMAL=1]="SW_NORMAL",e[e.SW_SHOWMINIMIZED=2]="SW_SHOWMINIMIZED",e[e.SW_SHOWMAXIMIZED=3]="SW_SHOWMAXIMIZED",e[e.SW_MAXIMIZE=3]="SW_MAXIMIZE",e[e.SW_SHOWNOACTIVATE=4]="SW_SHOWNOACTIVATE",e[e.SW_SHOW=5]="SW_SHOW",e[e.SW_MINIMIZE=6]="SW_MINIMIZE",e[e.SW_SHOWMINNOACTIVE=7]="SW_SHOWMINNOACTIVE",e[e.SW_SHOWNA=8]="SW_SHOWNA",e[e.SW_RESTORE=9]="SW_RESTORE",e[e.MCIERR_INVALID_DEVICE_ID=257]="MCIERR_INVALID_DEVICE_ID",e[e.MCIERR_UNRECOGNIZED_KEYWORD=259]="MCIERR_UNRECOGNIZED_KEYWORD",e[e.MCIERR_UNRECOGNIZED_COMMAND=261]="MCIERR_UNRECOGNIZED_COMMAND",e[e.MCIERR_HARDWARE=262]="MCIERR_HARDWARE",e[e.MCIERR_INVALID_DEVICE_NAME=263]="MCIERR_INVALID_DEVICE_NAME",e[e.MCIERR_OUT_OF_MEMORY=264]="MCIERR_OUT_OF_MEMORY",e[e.MCIERR_DEVICE_OPEN=265]="MCIERR_DEVICE_OPEN",e[e.MCIERR_CANNOT_LOAD_DRIVER=266]="MCIERR_CANNOT_LOAD_DRIVER",e[e.MCIERR_MISSING_COMMAND_STRING=267]="MCIERR_MISSING_COMMAND_STRING",e[e.MCIERR_PARAM_OVERFLOW=268]="MCIERR_PARAM_OVERFLOW",e[e.MCIERR_MISSING_STRING_ARGUMENT=269]="MCIERR_MISSING_STRING_ARGUMENT",e[e.MCIERR_BAD_INTEGER=270]="MCIERR_BAD_INTEGER",e[e.MCIERR_PARSER_INTERNAL=271]="MCIERR_PARSER_INTERNAL",e[e.MCIERR_DRIVER_INTERNAL=272]="MCIERR_DRIVER_INTERNAL",e[e.MCIERR_MISSING_PARAMETER=273]="MCIERR_MISSING_PARAMETER",e[e.MCIERR_UNSUPPORTED_FUNCTION=274]="MCIERR_UNSUPPORTED_FUNCTION",e[e.MCIERR_FILE_NOT_FOUND=275]="MCIERR_FILE_NOT_FOUND",e[e.MCIERR_DEVICE_NOT_READY=276]="MCIERR_DEVICE_NOT_READY",e[e.MCIERR_INTERNAL=277]="MCIERR_INTERNAL",e[e.MCIERR_DRIVER=278]="MCIERR_DRIVER",e[e.MCIERR_CANNOT_USE_ALL=279]="MCIERR_CANNOT_USE_ALL",e[e.MCIERR_MULTIPLE=280]="MCIERR_MULTIPLE",e[e.MCIERR_EXTENSION_NOT_FOUND=281]="MCIERR_EXTENSION_NOT_FOUND",e[e.MCIERR_OUTOFRANGE=282]="MCIERR_OUTOFRANGE",e[e.MCIERR_FLAGS_NOT_COMPATIBLE=284]="MCIERR_FLAGS_NOT_COMPATIBLE",e[e.MCIERR_FILE_NOT_SAVED=286]="MCIERR_FILE_NOT_SAVED",e[e.MCIERR_DEVICE_TYPE_REQUIRED=287]="MCIERR_DEVICE_TYPE_REQUIRED",e[e.MCIERR_DEVICE_LOCKED=288]="MCIERR_DEVICE_LOCKED",e[e.MCIERR_DUPLICATE_ALIAS=289]="MCIERR_DUPLICATE_ALIAS",e[e.MCIERR_BAD_CONSTANT=290]="MCIERR_BAD_CONSTANT",e[e.MCIERR_MUST_USE_SHAREABLE=291]="MCIERR_MUST_USE_SHAREABLE",e[e.MCIERR_MISSING_DEVICE_NAME=292]="MCIERR_MISSING_DEVICE_NAME",e[e.MCIERR_BAD_TIME_FORMAT=293]="MCIERR_BAD_TIME_FORMAT",e[e.MCIERR_NO_CLOSING_QUOTE=294]="MCIERR_NO_CLOSING_QUOTE",e[e.MCIERR_DUPLICATE_FLAGS=295]="MCIERR_DUPLICATE_FLAGS",e[e.MCIERR_INVALID_FILE=296]="MCIERR_INVALID_FILE",e[e.MCIERR_NULL_PARAMETER_BLOCK=297]="MCIERR_NULL_PARAMETER_BLOCK",e[e.MCIERR_UNNAMED_RESOURCE=298]="MCIERR_UNNAMED_RESOURCE",e[e.MCIERR_NEW_REQUIRES_ALIAS=299]="MCIERR_NEW_REQUIRES_ALIAS",e[e.MCIERR_NOTIFY_ON_AUTO_OPEN=300]="MCIERR_NOTIFY_ON_AUTO_OPEN",e[e.MCIERR_NO_ELEMENT_ALLOWED=301]="MCIERR_NO_ELEMENT_ALLOWED",e[e.MCIERR_NONAPPLICABLE_FUNCTION=302]="MCIERR_NONAPPLICABLE_FUNCTION",e[e.MCIERR_ILLEGAL_FOR_AUTO_OPEN=303]="MCIERR_ILLEGAL_FOR_AUTO_OPEN",e[e.MCIERR_FILENAME_REQUIRED=304]="MCIERR_FILENAME_REQUIRED",e[e.MCIERR_EXTRA_CHARACTERS=305]="MCIERR_EXTRA_CHARACTERS",e[e.MCIERR_DEVICE_NOT_INSTALLED=306]="MCIERR_DEVICE_NOT_INSTALLED",e[e.MCIERR_GET_CD=307]="MCIERR_GET_CD",e[e.MCIERR_SET_CD=308]="MCIERR_SET_CD",e[e.MCIERR_SET_DRIVE=309]="MCIERR_SET_DRIVE",e[e.MCIERR_DEVICE_LENGTH=310]="MCIERR_DEVICE_LENGTH",e[e.MCIERR_DEVICE_ORD_LENGTH=311]="MCIERR_DEVICE_ORD_LENGTH",e[e.MCIERR_NO_INTEGER=312]="MCIERR_NO_INTEGER",e[e.MCIERR_WAVE_OUTPUTSINUSE=320]="MCIERR_WAVE_OUTPUTSINUSE",e[e.MCIERR_WAVE_SETOUTPUTINUSE=321]="MCIERR_WAVE_SETOUTPUTINUSE",e[e.MCIERR_WAVE_INPUTSINUSE=322]="MCIERR_WAVE_INPUTSINUSE",e[e.MCIERR_WAVE_SETINPUTINUSE=323]="MCIERR_WAVE_SETINPUTINUSE",e[e.MCIERR_WAVE_OUTPUTUNSPECIFIED=324]="MCIERR_WAVE_OUTPUTUNSPECIFIED",e[e.MCIERR_WAVE_INPUTUNSPECIFIED=325]="MCIERR_WAVE_INPUTUNSPECIFIED",e[e.MCIERR_WAVE_OUTPUTSUNSUITABLE=326]="MCIERR_WAVE_OUTPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETOUTPUTUNSUITABLE=327]="MCIERR_WAVE_SETOUTPUTUNSUITABLE",e[e.MCIERR_WAVE_INPUTSUNSUITABLE=328]="MCIERR_WAVE_INPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETINPUTUNSUITABLE=329]="MCIERR_WAVE_SETINPUTUNSUITABLE",e[e.MCIERR_SEQ_DIV_INCOMPATIBLE=336]="MCIERR_SEQ_DIV_INCOMPATIBLE",e[e.MCIERR_SEQ_PORT_INUSE=337]="MCIERR_SEQ_PORT_INUSE",e[e.MCIERR_SEQ_PORT_NONEXISTENT=338]="MCIERR_SEQ_PORT_NONEXISTENT",e[e.MCIERR_SEQ_PORT_MAPNODEVICE=339]="MCIERR_SEQ_PORT_MAPNODEVICE",e[e.MCIERR_SEQ_PORT_MISCERROR=340]="MCIERR_SEQ_PORT_MISCERROR",e[e.MCIERR_SEQ_TIMER=341]="MCIERR_SEQ_TIMER",e[e.MCIERR_SEQ_PORTUNSPECIFIED=342]="MCIERR_SEQ_PORTUNSPECIFIED",e[e.MCIERR_SEQ_NOMIDIPRESENT=343]="MCIERR_SEQ_NOMIDIPRESENT",e[e.MCIERR_NO_WINDOW=346]="MCIERR_NO_WINDOW",e[e.MCIERR_CREATEWINDOW=347]="MCIERR_CREATEWINDOW",e[e.MCIERR_FILE_READ=348]="MCIERR_FILE_READ",e[e.MCIERR_FILE_WRITE=349]="MCIERR_FILE_WRITE",e[e.WS_VISIBLE=268435456]="WS_VISIBLE",e[e.WS_DISABLED=134217728]="WS_DISABLED",e[e.WS_CAPTION=12582912]="WS_CAPTION",e[e.WS_BORDER=8388608]="WS_BORDER",e[e.WS_DLGFRAME=4194304]="WS_DLGFRAME",e[e.WS_VSCROLL=2097152]="WS_VSCROLL",e[e.WS_HSCROLL=1048576]="WS_HSCROLL",e[e.WS_SYSMENU=524288]="WS_SYSMENU",e[e.WS_THICKFRAME=262144]="WS_THICKFRAME",e[e.WS_MINIMIZEBOX=131072]="WS_MINIMIZEBOX",e[e.WS_MAXIMIZEBOX=65536]="WS_MAXIMIZEBOX",e[e.WS_GROUP=131072]="WS_GROUP",e[e.WS_TABSTOP=65536]="WS_TABSTOP",e[e.WS_OVERLAPPED=0]="WS_OVERLAPPED",e[e.WS_POPUP=2147483648]="WS_POPUP",e[e.WS_CHILD=1073741824]="WS_CHILD",e[e.IDX_PRIMARY=1]="IDX_PRIMARY",e[e.IDX_UNIQUE=2]="IDX_UNIQUE",e[e.IDX_DESCENDING=4]="IDX_DESCENDING",e[e.IDX_MAINTAINED=8]="IDX_MAINTAINED",e[e.IDX_SUBSET=16]="IDX_SUBSET",e[e.IDX_EXPR=32]="IDX_EXPR",e[e.IDX_IDXOOD=64]="IDX_IDXOOD",e[e.IDX_CASEINSENS=128]="IDX_CASEINSENS",e[e.FLDDBCHAR=513]="FLDDBCHAR",e[e.FLDDBNUM=514]="FLDDBNUM",e[e.FLDDBMEMO=515]="FLDDBMEMO",e[e.FLDDBBOOL=516]="FLDDBBOOL",e[e.FLDDBDATE=517]="FLDDBDATE",e[e.FLDDBFLOAT=518]="FLDDBFLOAT",e[e.FLDDBLOCK=519]="FLDDBLOCK",e[e.FLDDBOLEBLOB=520]="FLDDBOLEBLOB",e[e.FLDDBBINARY=521]="FLDDBBINARY",e[e.FLDDBBYTES=522]="FLDDBBYTES",e[e.BS_PUSHBUTTON=0]="BS_PUSHBUTTON",e[e.BS_DEFPUSHBUTTON=1]="BS_DEFPUSHBUTTON",e[e.BS_CHECKBOX=2]="BS_CHECKBOX",e[e.BS_AUTOCHECKBOX=3]="BS_AUTOCHECKBOX",e[e.BS_RADIOBUTTON=4]="BS_RADIOBUTTON",e[e.BS_3STATE=5]="BS_3STATE",e[e.BS_AUTO3STATE=6]="BS_AUTO3STATE",e[e.BS_GROUPBOX=7]="BS_GROUPBOX",e[e.BS_USERBUTTON=8]="BS_USERBUTTON",e[e.BS_AUTORADIOBUTTON=9]="BS_AUTORADIOBUTTON",e[e.BS_OWNERDRAW=11]="BS_OWNERDRAW",e[e.BS_LEFTTEXT=32]="BS_LEFTTEXT",e[e.ES_LEFT=0]="ES_LEFT",e[e.ES_CENTER=1]="ES_CENTER",e[e.ES_RIGHT=2]="ES_RIGHT",e[e.ES_MULTILINE=4]="ES_MULTILINE",e[e.ES_UPPERCASE=8]="ES_UPPERCASE",e[e.ES_LOWERCASE=16]="ES_LOWERCASE",e[e.ES_PASSWORD=32]="ES_PASSWORD",e[e.ES_AUTOVSCROLL=64]="ES_AUTOVSCROLL",e[e.ES_AUTOHSCROLL=128]="ES_AUTOHSCROLL",e[e.ES_NOHIDESEL=256]="ES_NOHIDESEL",e[e.SBS_HORZ=0]="SBS_HORZ",e[e.SBS_VERT=1]="SBS_VERT",e[e.SBS_TOPALIGN=2]="SBS_TOPALIGN",e[e.SBS_LEFTALIGN=2]="SBS_LEFTALIGN",e[e.SBS_BOTTOMALIGN=4]="SBS_BOTTOMALIGN",e[e.SBS_RIGHTALIGN=4]="SBS_RIGHTALIGN",e[e.SBS_SIZEBOXTOPLEFTALIGN=2]="SBS_SIZEBOXTOPLEFTALIGN",e[e.SBS_SIZEBOXBOTTOMRIGHTALIGN=4]="SBS_SIZEBOXBOTTOMRIGHTALIGN",e[e.SBS_SIZEBOX=8]="SBS_SIZEBOX",e[e.LBS_NOTIFY=1]="LBS_NOTIFY",e[e.LBS_SORT=2]="LBS_SORT",e[e.LBS_NOREDRAW=4]="LBS_NOREDRAW",e[e.LBS_MULTIPLESEL=8]="LBS_MULTIPLESEL",e[e.LBS_OWNERDRAWFIXED=16]="LBS_OWNERDRAWFIXED",e[e.LBS_OWNERDRAWVARIABLE=32]="LBS_OWNERDRAWVARIABLE",e[e.LBS_HASSTRINGS=64]="LBS_HASSTRINGS",e[e.LBS_USETABSTOPS=128]="LBS_USETABSTOPS",e[e.LBS_NOINTEGRALHEIGHT=256]="LBS_NOINTEGRALHEIGHT",e[e.LBS_MULTICOLUMN=512]="LBS_MULTICOLUMN",e[e.LBS_WANTKEYBOARDINPUT=1024]="LBS_WANTKEYBOARDINPUT",e[e.LBS_EXTENDEDSEL=2048]="LBS_EXTENDEDSEL",e[e.CBS_SIMPLE=1]="CBS_SIMPLE",e[e.CBS_DROPDOWN=2]="CBS_DROPDOWN",e[e.CBS_DROPDOWNLIST=3]="CBS_DROPDOWNLIST",e[e.CBS_OWNERDRAWFIXED=16]="CBS_OWNERDRAWFIXED",e[e.CBS_OWNERDRAWVARIABLE=32]="CBS_OWNERDRAWVARIABLE",e[e.CBS_AUTOHSCROLL=64]="CBS_AUTOHSCROLL",e[e.CBS_OEMCONVERT=128]="CBS_OEMCONVERT",e[e.CBS_SORT=256]="CBS_SORT",e[e.CBS_HASSTRINGS=512]="CBS_HASSTRINGS",e[e.CBS_NOINTEGRALHEIGHT=1024]="CBS_NOINTEGRALHEIGHT",e[e.BS_SOLID=0]="BS_SOLID",e[e.BS_NULL=1]="BS_NULL",e[e.BS_HATCHED=2]="BS_HATCHED",e[e.BS_PATTERN=3]="BS_PATTERN",e[e.BS_GRADIENT_LINEAR=10]="BS_GRADIENT_LINEAR",e[e.HS_HORIZONTAL=0]="HS_HORIZONTAL",e[e.HS_VERTICAL=1]="HS_VERTICAL",e[e.HS_FDIAGONAL=2]="HS_FDIAGONAL",e[e.HS_BDIAGONAL=3]="HS_BDIAGONAL",e[e.HS_CROSS=4]="HS_CROSS",e[e.HS_DIAGCROSS=5]="HS_DIAGCROSS",e[e.PS_SOLID=0]="PS_SOLID",e[e.PS_DASH=1]="PS_DASH",e[e.PS_DOT=2]="PS_DOT",e[e.PS_DASHDOT=3]="PS_DASHDOT",e[e.PS_DASHDOTDOT=4]="PS_DASHDOTDOT",e[e.PS_NULL=5]="PS_NULL",e[e.PS_INSIDEFRAME=6]="PS_INSIDEFRAME",e[e.R2_BLACK=1]="R2_BLACK",e[e.R2_NOTMERGEPEN=2]="R2_NOTMERGEPEN",e[e.R2_MASKNOTPEN=3]="R2_MASKNOTPEN",e[e.R2_NOTCOPYPEN=4]="R2_NOTCOPYPEN",e[e.R2_MASKPENNOT=5]="R2_MASKPENNOT",e[e.R2_NOT=6]="R2_NOT",e[e.R2_XORPEN=7]="R2_XORPEN",e[e.R2_NOTMASKPEN=8]="R2_NOTMASKPEN",e[e.R2_MASKPEN=9]="R2_MASKPEN",e[e.R2_NOTXORPEN=10]="R2_NOTXORPEN",e[e.R2_NOP=11]="R2_NOP",e[e.R2_MERGENOTPEN=12]="R2_MERGENOTPEN",e[e.R2_COPYPEN=13]="R2_COPYPEN",e[e.R2_MERGEPENNOT=14]="R2_MERGEPENNOT",e[e.R2_MERGEPEN=15]="R2_MERGEPEN",e[e.R2_WHITE=16]="R2_WHITE",e[e.FILE_ATTRIBUTE_ARCHIVE=32]="FILE_ATTRIBUTE_ARCHIVE",e[e.FILE_ATTRIBUTE_COMPRESSED=2048]="FILE_ATTRIBUTE_COMPRESSED",e[e.FILE_ATTRIBUTE_DIRECTORY=16]="FILE_ATTRIBUTE_DIRECTORY",e[e.FILE_ATTRIBUTE_HIDDEN=2]="FILE_ATTRIBUTE_HIDDEN",e[e.FILE_ATTRIBUTE_NORMAL=128]="FILE_ATTRIBUTE_NORMAL",e[e.FILE_ATTRIBUTE_OFFLINE=4096]="FILE_ATTRIBUTE_OFFLINE",e[e.FILE_ATTRIBUTE_READONLY=1]="FILE_ATTRIBUTE_READONLY",e[e.FILE_ATTRIBUTE_SYSTEM=4]="FILE_ATTRIBUTE_SYSTEM",e[e.FILE_ATTRIBUTE_TEMPORARY=256]="FILE_ATTRIBUTE_TEMPORARY",e[e.VF_LOCAL=2]="VF_LOCAL",e[e.VF_EQVAR=256]="VF_EQVAR",e[e.VF_ARGUMENT=512]="VF_ARGUMENT",e[e.VF_RETURN=1024]="VF_RETURN",e[e.CUR_ARROW=0]="CUR_ARROW",e[e.CUR_CROSS=1]="CUR_CROSS",e[e.CUR_TEXT=2]="CUR_TEXT",e[e.CUR_NO=3]="CUR_NO",e[e.CUR_SIZE=4]="CUR_SIZE",e[e.CUR_SIZENESW=5]="CUR_SIZENESW",e[e.CUR_SIZENS=6]="CUR_SIZENS",e[e.CUR_SIZENWSE=7]="CUR_SIZENWSE",e[e.CUR_SIZEWE=8]="CUR_SIZEWE",e[e.CUR_UPARROW=9]="CUR_UPARROW",e[e.CUR_WAIT=10]="CUR_WAIT",e[e.CUR_LINK=11]="CUR_LINK",e[e.CUR_HELP=12]="CUR_HELP",e[e.SHADOWTYPE_STENCIL_MODULATIVE=18]="SHADOWTYPE_STENCIL_MODULATIVE",e[e.SHADOWTYPE_STENCIL_ADDITIVE=17]="SHADOWTYPE_STENCIL_ADDITIVE",e[e.SHADOWTYPE_TEXTURE_MODULATIVE=34]="SHADOWTYPE_TEXTURE_MODULATIVE",e[e.SHADOWTYPE_TEXTURE_ADDITIVE=33]="SHADOWTYPE_TEXTURE_ADDITIVE",e[e.FOG_NONE=0]="FOG_NONE",e[e.FOG_EXP=1]="FOG_EXP",e[e.FOG_EXP2=2]="FOG_EXP2",e[e.FOG_LINEAR=3]="FOG_LINEAR",e[e.TEX_TYPE_1D=1]="TEX_TYPE_1D",e[e.TEX_TYPE_2D=2]="TEX_TYPE_2D",e[e.TEX_TYPE_3D=3]="TEX_TYPE_3D",e[e.TEX_TYPE_CUBE_MAP=4]="TEX_TYPE_CUBE_MAP",e[e.SBF_ONE=0]="SBF_ONE",e[e.SBF_ZERO=1]="SBF_ZERO",e[e.SBF_DEST_COLOUR=2]="SBF_DEST_COLOUR",e[e.SBF_SOURCE_COLOUR=3]="SBF_SOURCE_COLOUR",e[e.SBF_ONE_MINUS_DEST_COLOUR=4]="SBF_ONE_MINUS_DEST_COLOUR",e[e.SBF_ONE_MINUS_SOURCE_COLOUR=5]="SBF_ONE_MINUS_SOURCE_COLOUR",e[e.SBF_DEST_ALPHA=6]="SBF_DEST_ALPHA",e[e.SBF_SOURCE_ALPHA=7]="SBF_SOURCE_ALPHA",e[e.SBF_ONE_MINUS_DEST_ALPHA=8]="SBF_ONE_MINUS_DEST_ALPHA",e[e.SBF_ONE_MINUS_SOURCE_ALPHA=9]="SBF_ONE_MINUS_SOURCE_ALPHA",e[e.CMPF_ALWAYS_FAIL=0]="CMPF_ALWAYS_FAIL",e[e.CMPF_ALWAYS_PASS=1]="CMPF_ALWAYS_PASS",e[e.CMPF_LESS=2]="CMPF_LESS",e[e.CMPF_LESS_EQUAL=3]="CMPF_LESS_EQUAL",e[e.CMPF_EQUAL=4]="CMPF_EQUAL",e[e.CMPF_NOT_EQUAL=5]="CMPF_NOT_EQUAL",e[e.CMPF_GREATER_EQUAL=6]="CMPF_GREATER_EQUAL",e[e.CMPF_GREATER=7]="CMPF_GREATER",e[e.CULL_NONE=1]="CULL_NONE",e[e.CULL_CLOCKWISE=2]="CULL_CLOCKWISE",e[e.CULL_ANTICLOCKWISE=3]="CULL_ANTICLOCKWISE",e[e.SO_FLAT=0]="SO_FLAT",e[e.SO_GOURAUD=1]="SO_GOURAUD",e[e.SO_PHONG=2]="SO_PHONG",e[e.PM_POINTS=1]="PM_POINTS",e[e.PM_WIREFRAME=2]="PM_WIREFRAME",e[e.PM_SOLID=3]="PM_SOLID",e[e.LT_POINT=0]="LT_POINT",e[e.LT_DIRECTIONAL=1]="LT_DIRECTIONAL",e[e.LT_SPOTLIGHT=2]="LT_SPOTLIGHT",e[e.PT_ORTHOGRAPHIC=0]="PT_ORTHOGRAPHIC",e[e.PT_PERSPECTIVE=1]="PT_PERSPECTIVE",e[e.OT_POINT_LIST=1]="OT_POINT_LIST",e[e.OT_LINE_LIST=2]="OT_LINE_LIST",e[e.OT_LINE_STRIP=3]="OT_LINE_STRIP",e[e.OT_TRIANGLE_LIST=4]="OT_TRIANGLE_LIST",e[e.OT_TRIANGLE_STRIP=5]="OT_TRIANGLE_STRIP",e[e.OT_TRIANGLE_FAN=6]="OT_TRIANGLE_FAN",e[e.BBT_POINT=0]="BBT_POINT",e[e.BBT_ORIENTED_COMMON=1]="BBT_ORIENTED_COMMON",e[e.BBT_ORIENTED_SELF=2]="BBT_ORIENTED_SELF",e[e.BBT_PERPENDICULAR_COMMON=3]="BBT_PERPENDICULAR_COMMON",e[e.BBT_PERPENDICULAR_SELF=4]="BBT_PERPENDICULAR_SELF",e[e.GMM_RELATIVE=0]="GMM_RELATIVE",e[e.GMM_PIXELS=1]="GMM_PIXELS",e[e.GMM_RELATIVE_ASPECT_ADJUSTED=2]="GMM_RELATIVE_ASPECT_ADJUSTED",e[e.GHA_LEFT=0]="GHA_LEFT",e[e.GHA_CENTER=1]="GHA_CENTER",e[e.GHA_RIGHT=2]="GHA_RIGHT",e[e.GVA_TOP=0]="GVA_TOP",e[e.GVA_CENTER=1]="GVA_CENTER",e[e.GVA_BOTTOM=2]="GVA_BOTTOM",e[e.MTHA_LEFT=0]="MTHA_LEFT",e[e.MTHA_CENTER=1]="MTHA_CENTER",e[e.MTVA_BELOW=0]="MTVA_BELOW",e[e.MTVA_ABOVE=1]="MTVA_ABOVE",e[e.MTVA_CENTER=2]="MTVA_CENTER",e[e.PT_BOOL=0]="PT_BOOL",e[e.PT_REAL=1]="PT_REAL",e[e.PT_INT=2]="PT_INT",e[e.PT_UNSIGNED_INT=3]="PT_UNSIGNED_INT",e[e.PT_SHORT=4]="PT_SHORT",e[e.PT_UNSIGNED_SHORT=5]="PT_UNSIGNED_SHORT",e[e.PT_LONG=6]="PT_LONG",e[e.PT_UNSIGNED_LONG=7]="PT_UNSIGNED_LONG",e[e.PT_STRING=8]="PT_STRING",e[e.PT_VECTOR3=9]="PT_VECTOR3",e[e.PT_MATRIX3=10]="PT_MATRIX3",e[e.PT_MATRIX4=11]="PT_MATRIX4",e[e.PT_QUATERNION=12]="PT_QUATERNION",e[e.PT_COLOURVALUE=13]="PT_COLOURVALUE",e[e.NUI_SP_HIP_CENTER=0]="NUI_SP_HIP_CENTER",e[e.NUI_SP_SPINE=1]="NUI_SP_SPINE",e[e.NUI_SP_SHOULDER_CENTER=2]="NUI_SP_SHOULDER_CENTER",e[e.NUI_SP_HEAD=3]="NUI_SP_HEAD",e[e.NUI_SP_SHOULDER_LEFT=4]="NUI_SP_SHOULDER_LEFT",e[e.NUI_SP_ELBOW_LEFT=5]="NUI_SP_ELBOW_LEFT",e[e.NUI_SP_WRIST_LEFT=6]="NUI_SP_WRIST_LEFT",e[e.NUI_SP_HAND_LEFT=7]="NUI_SP_HAND_LEFT",e[e.NUI_SP_SHOULDER_RIGHT=8]="NUI_SP_SHOULDER_RIGHT",e[e.NUI_SP_ELBOW_RIGHT=9]="NUI_SP_ELBOW_RIGHT",e[e.NUI_SP_WRIST_RIGHT=10]="NUI_SP_WRIST_RIGHT",e[e.NUI_SP_HAND_RIGHT=11]="NUI_SP_HAND_RIGHT",e[e.NUI_SP_HIP_LEFT=12]="NUI_SP_HIP_LEFT",e[e.NUI_SP_KNEE_LEFT=13]="NUI_SP_KNEE_LEFT",e[e.NUI_SP_ANKLE_LEFT=14]="NUI_SP_ANKLE_LEFT",e[e.NUI_SP_FOOT_LEFT=15]="NUI_SP_FOOT_LEFT",e[e.NUI_SP_HIP_RIGHT=16]="NUI_SP_HIP_RIGHT",e[e.NUI_SP_KNEE_RIGHT=17]="NUI_SP_KNEE_RIGHT",e[e.NUI_SP_ANKLE_RIGHT=18]="NUI_SP_ANKLE_RIGHT",e[e.NUI_SP_FOOT_RIGHT=19]="NUI_SP_FOOT_RIGHT",e[e.NUI_SP_COUNT=20]="NUI_SP_COUNT",e[e.WEB_DIALOG_OPEN=100]="WEB_DIALOG_OPEN",e))(P||{});const ps=258;var F=(e=>(e[e.FLOAT=1]="FLOAT",e[e.STRING=2]="STRING",e[e.HANDLE=3]="HANDLE",e[e.COLORREF=4]="COLORREF",e))(F||{});const Wc=1,Vc=0,$c=1,jc=2,Hc=3,Xc=4,Yc="CM_CLEARALL",zc="CM_PREVPAGE";function Kc(e,t){switch(e){case F.FLOAT:return lo(t).toString();case F.STRING:return t;case F.HANDLE:return"#"+t;case F.COLORREF:return go(t)}}function Fr(e,t){switch(e){case F.FLOAT:{const s=parseFloat(t.replace(",","."));if(!isNaN(s))return s;const r=P[t.toUpperCase()];return typeof r=="number"?r:null}case F.HANDLE:return qc(t);case F.STRING:return t;case F.COLORREF:return fo(t)}}function qc(e){return(e.startsWith("#")?parseInt(e.slice(1)):parseInt(e))||0}const me=8;var ve=(e=>(e[e.FLOAT_REF=F.FLOAT|me]="FLOAT_REF",e[e.STRING_REF=F.STRING|me]="STRING_REF",e[e.HANDLE_REF=F.HANDLE|me]="HANDLE_REF",e[e.COLORREF_REF=F.COLORREF|me]="COLORREF_REF",e))(ve||{});class Jc{constructor(){this.blocks=[]}pushBlock(t){return this.blocks.push(t),t}popBlock(t){const s=this.blocks.pop();if(s?.expect!==t)throw Error(`Ожидалось ${t}`);return s}lastBlock(){return this.blocks.length>0?this.blocks[this.blocks.length-1]:null}haveABreakHaveAKitKat(){for(let t=this.blocks.length-1;t>=0;--t)if(this.blocks[t].canBreak)return"break;";return"return;"}}const Zc="map",Qc="g",_s="schema",Es="string",Br="n",Ur="o",Wr={[F.FLOAT]:"f",[F.HANDLE]:"i",[F.COLORREF]:"i",[F.STRING]:"s"},ea=`
"use strict"
const { map, values } = memory;
const of = values.oldFloats;
const nf = values.newFloats;
const oi = values.oldInts;
const ni = values.newInts;
const os = values.oldStrings;
const ns = values.newStrings;
function string(value) {
    return (Math.round(value * 1e5) / 1e5).toString()
}
`,ta="userFunction",sa="solveEquationsFor",{FLOAT:W,STRING:te,HANDLE:Ct,COLORREF:ra}=F,ia=[["ABS",{argTypes:[W],retType:W,template:"Math.abs(#0) || 0"}],["ALLTRIM",{argTypes:[te],retType:te,template:"(#0).trim()"}],["AND",{argTypes:[W,W],retType:W,template:"(#0) && (#1) ? 1 : 0"}],["ARCTAN",{argTypes:[W],retType:W,template:"Math.atan(#0)||0"}],["AVERAGE",{argTypes:[W,W],retType:W,template:"(#0) / 2 + (#1) / 2"}],["COMPARE",{argTypes:[te,te],retType:W,template:"(#0) == (#1) ? 1 : 0"}],["COS",{argTypes:[W],retType:W,template:"Math.cos(#0) || 0"}],["DEG",{argTypes:[W],retType:W,template:"180 * (#0) / Math.PI || 0"}],["DELTA",{argTypes:[W],retType:W,template:"(#0) ? 0 : 1"}],["ED",{argTypes:[W],retType:W,template:"(#0) > 0 ? 1 : 0"}],["ED",{argTypes:[Ct],retType:W,template:"(#0) > 0 ? 1 : 0"}],["EXP",{argTypes:[W],retType:W,template:"Math.exp(#0) || 0"}],["FLOAT",{argTypes:[ra],retType:W,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[W],retType:W,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[Ct],retType:W,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[te],retType:W,template:"parseFloat(#0) || 0"}],["HANDLE",{argTypes:[W],retType:Ct,template:"parseInt(#0) || 0"}],["LEFT",{argTypes:[te,W],retType:te,template:"(#0).substring(0, #1)"}],["LENGTH",{argTypes:[te],retType:W,template:"(#0).length"}],["LIMIT",{argTypes:[W,W,W],retType:W,template:"Math.max(#1, Math.min(#2, #0))||0"}],["LOWER",{argTypes:[te],retType:te,template:"(#0).toLowerCase()"}],["LTRIM",{argTypes:[te],retType:te,template:'(#0).replace(/^\\s+/, "")'}],["MAX",{argTypes:[W,W],retType:W,template:"Math.max(#0, #1) || 0"}],["MIN",{argTypes:[W,W],retType:W,template:"Math.min(#0, #1) || 0"}],["NOT",{argTypes:[W],retType:W,template:"(#0) ? 0 : 1"}],["NOT",{argTypes:[Ct],retType:W,template:"(#0) ? 0 : 1"}],["NOTBIN",{argTypes:[W],retType:W,template:"~(#0)"}],["OR",{argTypes:[W,W],retType:W,template:"(#0) || (#1) ? 1 : 0"}],["RAD",{argTypes:[W],retType:W,template:"Math.PI * (#0) / 180 || 0"}],["REPLICATE",{argTypes:[te,W],retType:te,template:"(#0).repeat(#1)"}],["RND",{argTypes:[W],retType:W,template:"(#0) * Math.random()"}],["RTRIM",{argTypes:[te],retType:te,template:'(#0).replace(/\\s+$/, "")'}],["SGN",{argTypes:[W],retType:W,template:"Math.sign(#0) || 0"}],["SIN",{argTypes:[W],retType:W,template:"Math.sin(#0) || 0"}],["SQR",{argTypes:[W],retType:W,template:"(#0) ** 2"}],["SQRT",{argTypes:[W],retType:W,template:"Math.sqrt(#0) || 0"}],["STRING",{argTypes:[W],retType:te,template:`${Es}(#0)`}],["TAN",{argTypes:[W],retType:W,template:"Math.tan(#0) || 0"}],["TRUNC",{argTypes:[W],retType:W,template:"Math.trunc(#0) || 0"}],["UPPER",{argTypes:[te],retType:te,template:"(#0).toUpperCase()"}],["XOR",{argTypes:[W,W],retType:W,template:"(#0) !== 0 ^ (#1) !== 0"}],["XORBIN",{argTypes:[W,W],retType:W,template:"(#0) ^ (#1)"}]],na=(()=>{const e=new Map;return ia.forEach(([t,s])=>{let r=e.get(t);r||e.set(t,r=[]),r.push(s)}),e})(),{FLOAT:$,STRING:se,HANDLE:we,COLORREF:Gt}=F,Vr=[{name:"^",arg:[$,$],ret:$,text:"#0 ** #1",prior:13},{name:"*",arg:[$,$],ret:$,text:"#0 * #1",prior:12},{name:"/",arg:[$,$],ret:$,text:"#0 / (#1 || Infinity)",prior:12},{name:"%",arg:[$,$],ret:$,text:"#0 % #1",prior:12},{name:"+",arg:[$,$],ret:$,text:"#0 + #1",prior:11},{name:"+",arg:[se,se],ret:se,text:"#0 + #1",prior:11},{name:"+",arg:[se,$],ret:se,text:`#0 + ${Es}(#1)`,prior:11},{name:"+",arg:[$,se],ret:se,text:`${Es}(#0) + #1`,prior:11},{name:"-",arg:[$,$],ret:$,text:"#0 - #1",prior:11},{name:"<<",arg:[$,$],ret:$,text:"#0 << #1",prior:10},{name:">>",arg:[$,$],ret:$,text:"#0 >> #1",prior:10},{name:">",arg:[$,$],ret:$,text:"+(#0 > #1)",prior:9},{name:">=",arg:[$,$],ret:$,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[$,$],ret:$,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[$,$],ret:$,text:"+(#0 <= #1)",prior:9},{name:">",arg:[se,se],ret:$,text:"+(#0 > #1)",prior:9},{name:">=",arg:[se,se],ret:$,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[se,se],ret:$,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[se,se],ret:$,text:"+(#0 <= #1)",prior:9},{name:"==",arg:[$,$],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[se,se],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[we,we],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[Gt,Gt],ret:$,text:"+(#0 == #1)",prior:8},{name:"!=",arg:[$,$],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[se,se],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[we,we],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[Gt,Gt],ret:$,text:"+(#0 != #1)",prior:8},{name:"&",arg:[$,$],ret:$,text:"#0 & #1",prior:7},{name:"|",arg:[$,$],ret:$,text:"#0 | #1",prior:5},{name:"&&",arg:[$,$],ret:$,text:"+Boolean(#0 && #1)",prior:4},{name:"&&",arg:[we,we],ret:we,text:"+Boolean(#0 && #1)",prior:4},{name:"||",arg:[$,$],ret:$,text:"+Boolean(#0 || #1)",prior:3},{name:"||",arg:[we,we],ret:we,text:"+Boolean(#0 || #1)",prior:3}],oa=Array.from(new Me(Vr.map(e=>[e.prior,e.name]))).sort((e,t)=>t[0]-e[0]).map(e=>Array.from(e[1]));class ca{constructor(){this.m=new Map}declareVar(t,s,r){const i=t.toLowerCase(),n=this.m.get(i);if(n&&n[0].type!==s)throw Error(`Переменная уже объявлена: ${t}`);const o={name:t,type:s,attrib:r||void 0};this.m.set(i,[o,this.m.size])}makeInEquation(t){const s=t.toLowerCase(),r=this.m.get(s);if(!r)throw Error(`Неизвестная переменная: ${t}`);if(r[0].type!==F.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);r[0].inEquation=!0}setAsReturn(t){const s=t.toLowerCase(),r=this.m.get(s);if(!r)throw Error(`Неизвестная переменная: ${t}`);r[0].attrib=(r[0].attrib??0)|P.VF_RETURN}getFloatVar(t){const s=t.toLowerCase(),r=this.m.get(s);if(!r)throw Error(`Неизвестная переменная: ${t}`);if(r[0].type!==F.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);return`$${s}`}_getOrCreateVar(t,s){const r=t.toLowerCase(),i=this.m.get(r);if(i)return[r,i[0]];const n={name:t,type:s};return this.m.set(r,[n,this.m.size]),[r,n]}getOrCreateVar(t,s,r=F.FLOAT){const[i,{type:n}]=this._getOrCreateVar(s,r),o=`${t?Br:Ur}${Wr[n]}`,l=`$${i}`;return{text:`${o}[${l}]`,type:n}}derefer(t,s=F.FLOAT){const r=t.first;if(r.type!=="var"||t.rest.length>0)throw Error("Должно быть имя переменной");const[i,{type:n}]=this._getOrCreateVar(r.name,s),o=`${r.isNew?Br:Ur}${Wr[n]}`,l=`$${i}`;return[o,l]}result(){return[...this.m.values()].sort((t,s)=>t[1]-s[1]).map(t=>t[0])}}function $r(e,t){const s=t.args.map(l=>Te(e,l)),r=t.name.toUpperCase(),i=na.get(r);if(i){const l=i.find(({argTypes:d})=>d.length===s.length&&d.every((p,E)=>p===s[E].type));if(!l)throw Error(`Некорректная сигнатура функции ${t.name}(${s.map(d=>F[d.type])}).
Возможные варианты:
`+i.map(d=>`${t.name}(${d.argTypes.map(p=>F[p])})`).join(`
`));const u=s.map(d=>d.text);return{text:l.template.replace(/#(\d)/g,(d,p)=>u[p]),type:l.retType}}if(r==="EXIT"){if(s.length>0)throw Error(`${t.name}: ожидалось 0 аргументов, получено ${s.length}`);return{text:"return",type:null}}const n=e.funcTable?.get(r);if(!n)throw Error(`Функция не существует: ${`${t.name}(${s.map(l=>F[l.type])})`}`);const o=n.find(l=>{if(!l.argTypes.every((E,w)=>{if(w>=s.length)return!1;const T=E&me-1;return s[w].type===T}))return!1;const d=s.length-l.argTypes.length;if(!d)return!0;if(l.type==="user")return!1;const{restArgsTypes:p}=l;return d%p.length!==0?!1:s.slice(-d).every((E,w)=>E.type===p[w%p.length])});if(!o){const l=`${t.name}(${s.map(d=>F[d.type])})`,u=n.map(d=>{const p=d.argTypes.map(E=>(E&me?"&":"")+F[E&me-1]);return d.type==="plugin"&&d.restArgsTypes.length&&p.push(`[${d.restArgsTypes.map(E=>F[E])}]`),` - ${t.name}(${p})`});throw Error(`Некорректная сигнатура функции ${l}.
Возможные варианты:
${u.join(`;
`)}`)}if(o.type==="plugin"){const l=s.map((u,d)=>o.argTypes[d]&me?e.vars.derefer(t.args[d]):u.text);return{text:`${Qc}.${o.path}.call(${[_s,...l]})`,type:o.retType}}else{const l=s.map(u=>u.text);return{text:`${_s}.${ta}(${[`"${o.name}"`,`[${l}]`]})`,type:o.retType}}}function aa(e){return`t${e.tmpVarCount++}`}function Ft(e,t){switch(t.isNew&&t.type!=="var"&&e.bugs.push(["Применение оператора '~' не к переменной",t]),t.type){case"float":return{text:parseFloat(t.value).toString(),type:F.FLOAT};case"handle":return{text:parseInt(t.value,10).toString(),type:F.HANDLE};case"string":return{text:"`"+t.value.replace(/[`$\\]/g,"\\$&")+"`",type:F.STRING};case"var":{const s=P[t.name.toUpperCase()]?.toString();return s?{text:s,type:F.FLOAT}:e.vars.getOrCreateVar(t.isNew,t.name)}case"call":{let s=t;if(t.isNew&&t.args.length){const n={...t.args[0].first,isNew:!0},o=[{...t.args[0],first:n},...t.args.slice(1)];s={...t,args:o}}const r=aa(e),i=$r(e,s);if(!i.type)throw Error(`Функция ${t.name} не возвращает значения`);return e.lines.push(`const ${r}=${i.text};`),{text:r,type:i.type}}case"-":case"!":{let s=t.op;t.isNew&&(s={...s,isNew:!0});const r=Ft(e,s);if(r.type!==F.FLOAT)throw Error(`Оператор "${t.type}" не применим к ${F[r.type]}`);return{text:`(${t.type}${r.text})`,type:r.type}}case"subexpr":{const s=Te(e,t.expr);return{text:`(${s.text})`,type:s.type}}}}function Te(e,{first:t,rest:s}){if(!s.length)return Ft(e,t);const r=[{type:"decl",op:t},...ar(s.map(n=>[n.action,{type:"decl",op:n.operand}]))];oa.forEach(n=>{for(;;){const o=r.findIndex(R=>typeof R=="string"&&n.includes(R));if(o<0)break;const l=r[o],u=r[o-1],d=r[o+1],p=u.type==="decl"?Ft(e,u.op):u.res,E=d.type==="decl"?Ft(e,d.op):d.res,w=Vr.find(({name:R,arg:A})=>R===l&&A[0]===p.type&&A[1]===E.type);if(!w)throw Error(`Оператор '${l}' неприменим к '${F[p.type]}', '${F[E.type]}'`);const T={text:w.text.replace(/#\d/g,R=>(R==="#0"?p:E).text),type:w.ret};r.splice(o-1,3,{type:"parsed",res:T})}});const i=r[0];if(typeof i!="object"||i.type!=="parsed")throw Error("Ошибка разбора выражения");return i.res}function jr(e,t,s){if(t!==s)throw Error(`"${e}" имеет тип ${F[t]}, но правое выражение возвращает ${F[s]}`)}function Hr(e,t){switch(t.type){case":=":{const r=Te(e,t.expr),i=e.vars.getOrCreateVar(!0,t.to,r.type);jr(t.to,i.type,r.type),e.lines.push(`${i.text} = ${r.text};`);break}case"callChain":{t.functions.forEach(r=>{const i=$r(e,r);e.lines.push(`${i.text};`)});break}case"if":{e.b.pushBlock({canBreak:!1,expect:"endif",hasElse:!1});const r=Te(e,t.expr);e.lines.push(`if (${r.text}) {`);break}case"else":{const r=e.b.lastBlock();if(r?.expect!=="endif"||r.hasElse)throw Error("else должен находиться после if");r.hasElse=!0,e.lines.push("} else {");break}case"endif":{e.b.popBlock("endif"),e.lines.push("}");break}case"varsDec":{const{datatype:r,modifiers:i,names:n}=t;let o;switch(r){case"FLOAT":case"INTEGER":o=F.FLOAT;break;case"HANDLE":o=F.HANDLE;break;case"STRING":o=F.STRING;break;case"COLORREF":o=F.COLORREF;break}const l=(i.includes("LOCAL")?P.VF_LOCAL:0)|(i.includes("PARAMETER")?P.VF_ARGUMENT:0);n.forEach(u=>e.vars.declareVar(u,o,l));break}case"while":{e.b.pushBlock({expect:"endwhile",canBreak:!0});const r=`g${++e.whileGuardCount}`;e.lines.push(`var ${r} = 0;`),e.lines.push("while (true) {"),e.lines.push(`if (++${r} > 100000) throw Error("Бесконечный цикл (100000 итераций)");`);const i=Te(e,t.expr);e.lines.push(`if (!(${i.text})) break;`);break}case"endwhile":{e.b.popBlock("endwhile"),e.lines.push("}");break}case"do":{e.b.pushBlock({expect:"until",canBreak:!0}),e.lines.push("do {");break}case"until":{e.b.popBlock("until");const r=Te(e,t.expr);e.lines.push(`if (!(${r.text})) break;`),e.lines.push("} while (true);");break}case"switch":{e.b.pushBlock({expect:"endswitch",canBreak:!0,caseCount:0}),e.lines.push("do { //switch");break}case"endswitch":{const r=e.b.popBlock("endswitch");if(!r.caseCount)throw Error("Ожидалось case");for(let i=0;i<r.caseCount;++i)e.lines.push("}");e.lines.push("} while (false); //endswitch");break}case"case":{const r=e.b.lastBlock();if(r?.expect!=="endswitch")throw Error("case должен находиться внутри блока switch");r.caseCount&&e.lines.push("} else {"),++r.caseCount;const i=Te(e,t.expr);e.lines.push(`if (${i.text}) { //case`);break}case"default":{if(e.b.lastBlock()?.expect!=="endswitch")throw Error("default должен находиться внутри блока switch");e.lines.push("} else { //default");break}case"break":e.lines.push(e.b.haveABreakHaveAKitKat());break;case"=":{const r={...e,lines:[]},i=Te(r,t.lhs);if(i.type!==F.FLOAT)throw Error("Левая часть выражения не возвращает FLOAT");const n=Te(r,t.rhs);if(n.type!==F.FLOAT)throw Error("Правая часть выражения не возвращает FLOAT");r.lines.push(`return ${n.text} - (${i.text});`),e.equations.push(r.lines);break}case"::=":{const r={...e,lines:[]},i=Te(r,t.expr),n=e.vars.getOrCreateVar(!0,t.to,i.type);jr(t.to,n.type,i.type),r.lines.push(`${n.text} = ${i.text};`),e.defers.push(r.lines);break}case"eqResult":{if(t.deferred)t.vars.forEach(r=>e.vars.makeInEquation(r));else{const r=t.vars.map(i=>e.vars.getFloatVar(i));e.lines.push(`${_s}.${sa}([${r}]);`)}break}case"function":{e.isFunction=!0;break}case"return":{e.vars.setAsReturn(t.to);break}default:throw Error(`Неизвестный оператор: "${t.type}"`)}}function la(e,t,s){const r=e.vars.result(),{lines:i,bugs:n,equations:o,defers:l,isFunction:u}=e;if(i.length===0&&o.length===0&&l.length===0)return{bugs:n,vars:r,isFunction:u,mainText:"",equationsTexts:[],defersTexts:[]};const d=r.map((b,x)=>`const $${b.name.toLowerCase()} = ${Zc}[${x}];`).join(`
`),p=ea+`
`+d+`
`,E=t?`//# sourceURL=_transpiled/${t}`:"",w=s?.split(`
`).map(b=>"// "+b).join(`
`)??"",T=i.length?w+p+i.join(`
`)+E:"",R=o.map((b,x)=>p+b.join(`
`)+(E&&`${E}_eq_${x}`)),A=l.map((b,x)=>p+b.join(`
`)+(E&&`${E}_defer_${x}`));return{bugs:n,vars:r,isFunction:u,mainText:T,equationsTexts:R,defersTexts:A}}function ha(e,{funcTable:t,sourceURL:s,comment:r}={}){const i={funcTable:t,vars:new ca,b:new Jc,lines:[],defers:[],equations:[],isFunction:!1,bugs:[],tmpVarCount:0,whileGuardCount:0};e.forEach((o,l)=>{try{Hr(i,o);let u=o.then;for(;u;)Hr(i,u),u=u.then}catch(u){throw u instanceof Error?Error(`Строка ${l+1}: ${u.message}`):u}});const n=i.b.lastBlock();if(n)throw Error(`Строка ${e.length}: ожидалось ${n.expect}`);return la(i,s,r)}const ms="'",ws='"';function ua(e){let t="",s=null;for(let r=0;r<e.length;++r){const i=e[r];if(i===ms&&s!==ws?s=s?null:ms:i===ws&&s!==ms&&(s=s?null:ws),s){t+=i;continue}if(i==="/"){const n=e[r+1];if(n==="*"){for(r+=2;r<e.length&&(e[r]!=="*"||e[r+1]!=="/");)++r;++r;continue}if(n==="/"){for(++r;r<e.length&&e[++r]!==`
`;);t[t.length-1]!==`
`&&(t+=`
`);continue}}if(i===";"||i===`
`){t[t.length-1]!==`
`&&(t+=`
`);continue}if(i==="\r"){e[r+1]===`
`&&++r,t[t.length-1]!==`
`&&(t+=`
`);continue}t+=i}return t[t.length-1]===`
`?t:t+`
`}function da(e,t){function s(){this.constructor=e}s.prototype=t.prototype,e.prototype=new s}function _t(e,t,s,r){this.message=e,this.expected=t,this.found=s,this.location=r,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,_t)}da(_t,Error),_t.buildMessage=function(e,t){var s={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var p="",E;for(E=0;E<d.parts.length;E++)p+=d.parts[E]instanceof Array?n(d.parts[E][0])+"-"+n(d.parts[E][1]):n(d.parts[E]);return"["+(d.inverted?"^":"")+p+"]"},any:function(d){return"any character"},end:function(d){return"end of input"},other:function(d){return d.description}};function r(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function n(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function o(d){return s[d.type](d)}function l(d){var p=new Array(d.length),E,w;for(E=0;E<d.length;E++)p[E]=o(d[E]);if(p.sort(),p.length>0){for(E=1,w=1;E<p.length;E++)p[E-1]!==p[E]&&(p[w]=p[E],w++);p.length=w}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function u(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+l(e)+" but "+u(t)+" found."};function fa(e,t){t=t!==void 0?t:{};var s={},r={Code:Yn},i=Yn,n=function(h){return h},o=function(h){return h.filter(g=>g)},l=ee("variable name"),u=function(h){return{type:"var",name:h}},d=",",p=Y(",",!1),E=function(h){return h},w=ee("function call"),T="(",R=Y("(",!1),A=")",b=Y(")",!1),x=function(h,g){return{type:"call",name:h,args:g}},L="-",k=Y("-",!1),U="!",B=Y("!",!1),G=ee("!<operand> or -<operand>"),C=function(h,g){return{type:h,op:g}},I=ee("(<expression>)"),X=function(h){return{type:"subexpr",expr:h}},q=ee("operand"),Z="~",he=Y("~",!1),ae=function(h,g){return{...g,isNew:!!h}},J="^",Ce=Y("^",!1),Ge="*",Fe=Y("*",!1),ct="/",at=Y("/",!1),St="%",Ye=Y("%",!1),lt="+",ht=Y("+",!1),ze=">=",Ys=Y(">=",!1),zs=">",tR=Y(">",!1),En="<=",sR=Y("<=",!1),rR="<",iR=Y("<",!1),mn="==",nR=Y("==",!1),wn="!=",oR=Y("!=",!1),Tn="&&",cR=Y("&&",!1),aR="&",lR=Y("&",!1),yn="||",hR=Y("||",!1),uR="|",dR=Y("|",!1),fR=ee("expression"),bn=function(h,g,y){return{action:g,operand:y}},gR=function(h,g){return{first:h,rest:g}},On=function(h,g){return g},pR=function(h,g){return[h].concat(g)},Rn=function(h,g){return g},_R=function(h,g,y){return{type:"varsDec",datatype:h,modifiers:g,names:y}},ER=ee("assignment operator"),Mn=":=",mR=Y(":=",!1),vn="::=",wR=Y("::=",!1),TR=function(h,g,y){return{type:g,to:h,expr:y}},yR=ee("equality operator"),Sn="=",An=Y("=",!1),bR=function(h,g,y){return{type:g,lhs:h,rhs:y}},OR=ee("immediately equation result"),ut=function(h,g){return g},Nn="?",In=Y("?",!1),RR=function(h,g){return{type:"eqResult",deferred:!1,vars:[h].concat(g)}},MR=ee("deferred equation result"),vR=function(h,g){return{type:"eqResult",deferred:!0,vars:[h].concat(g)}},SR=ee("function call chain"),AR=function(h,g){return{type:"callChain",functions:[h].concat(g)}},xn=ee("( <expression> )"),Pn=function(h){return h},NR=ee("if(<condition>)"),IR="if",xR=Y("if",!0),PR=function(h){return{type:"if",expr:h}},LR=ee("while(<condition>)"),DR="while",kR=Y("while",!0),CR=function(h){return{type:"while",expr:h}},GR=ee("until(<condition>)"),FR="until",BR=Y("until",!0),UR=function(h){return{type:"until",expr:h}},WR=ee("case(<condition>)"),VR="case",$R=Y("case",!0),jR=function(h,g){return{type:"case",expr:h,then:g}},HR="else",XR=Y("else",!0),YR=function(h){return{type:"else",then:h}},zR="endif",KR=Y("endif",!0),qR=function(h){return{type:"endif",then:h}},JR="break",ZR=Y("break",!0),QR=function(){return{type:"break"}},eM="endwhile",tM=Y("endwhile",!0),sM=function(){return{type:"endwhile"}},rM="do",iM=Y("do",!0),nM=function(){return{type:"do"}},oM="endswitch",cM=Y("endswitch",!0),aM=function(){return{type:"endswitch"}},lM="switch",hM=Y("switch",!0),uM=function(){return{type:"switch"}},dM="default",fM=Y("default",!0),gM=function(h){return{type:"default",then:h}},pM="function",_M=Y("function",!0),EM=function(){return{type:"function"}},mM=ee("return <var name>"),wM="return",TM=Y("return",!0),yM=function(h){return{type:"return",to:h}},bM="handle",OM=Y("HANDLE",!0),RM=function(){return"HANDLE"},MM="string",vM=Y("STRING",!0),SM=function(){return"STRING"},AM="float",NM=Y("FLOAT",!0),IM=function(){return"FLOAT"},xM="colorref",PM=Y("COLORREF",!0),LM=function(){return"COLORREF"},DM="integer",kM=Y("INTEGER",!0),CM=function(){return"INTEGER"},GM="local",FM=Y("LOCAL",!0),BM=function(){return"LOCAL"},UM="nosave",WM=Y("NOSAVE",!0),VM=function(){return"NOSAVE"},$M="parameter",jM=Y("PARAMETER",!0),HM=function(){return"PARAMETER"},Ln=/^[_a-z\u0430-\u044F0-9]/i,Dn=Be(["_",["a","z"],["а","я"],["0","9"]],!1,!0),XM=ee("function name"),Qt=/^[0-9]/,es=Be([["0","9"]],!1,!1),YM=".",zM=Y(".",!1),KM=/^[eE]/,qM=Be(["e","E"],!1,!1),JM=/^[+\-]/,ZM=Be(["+","-"],!1,!1),QM=ee("float"),ev=function(h){return{type:"float",value:h}},tv=ee("handle"),sv="#",rv=Y("#",!1),iv=function(h){return{type:"handle",value:h.length>0?h:"0"}},kn="'",Cn=Y("'",!1),Gn=/^[^']/,Fn=Be(["'"],!0,!1),Bn='"',Un=Y('"',!1),Wn=/^[^"]/,Vn=Be(['"'],!0,!1),nv=function(h){return{type:"string",value:h[1]}},ov=ee("space or tab"),cv=/^[ \t]/,av=Be([" ","	"],!1,!1),lv=ee("new line"),hv=`
`,uv=Y(`
`,!1),dv=ee("whitespace"),$n=/^[ \t\n\r]/,jn=Be([" ","	",`
`,"\r"],!1,!1),f=0,ts=[{line:1,column:1}],Oe=0,Ks=[],v=0,ss;if("startRule"in t){if(!(t.startRule in r))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=r[t.startRule]}function Y(h,g){return{type:"literal",text:h,ignoreCase:g}}function Be(h,g,y){return{type:"class",parts:h,inverted:g,ignoreCase:y}}function fv(){return{type:"end"}}function ee(h){return{type:"other",description:h}}function Hn(h){var g=ts[h],y;if(g)return g;for(y=h-1;!ts[y];)y--;for(g=ts[y],g={line:g.line,column:g.column};y<h;)e.charCodeAt(y)===10?(g.line++,g.column=1):g.column++,y++;return ts[h]=g,g}function Xn(h,g){var y=Hn(h),m=Hn(g);return{start:{offset:h,line:y.line,column:y.column},end:{offset:g,line:m.line,column:m.column}}}function D(h){f<Oe||(f>Oe&&(Oe=f,Ks=[]),Ks.push(h))}function gv(h,g,y){return new _t(_t.buildMessage(h,g),h,g,y)}function Yn(){var h,g,y,m,S,M,j;for(h=f,g=[],y=f,m=[],S=V();S!==s;)m.push(S),S=V();if(m!==s)if(S=qs(),S===s&&(S=null),S!==s){for(M=[],j=V();j!==s;)M.push(j),j=V();M!==s?(j=Jn(),j!==s?(m=n(S),y=m):(f=y,y=s)):(f=y,y=s)}else f=y,y=s;else f=y,y=s;for(;y!==s;){for(g.push(y),y=f,m=[],S=V();S!==s;)m.push(S),S=V();if(m!==s)if(S=qs(),S===s&&(S=null),S!==s){for(M=[],j=V();j!==s;)M.push(j),j=V();M!==s?(j=Jn(),j!==s?(m=n(S),y=m):(f=y,y=s)):(f=y,y=s)}else f=y,y=s;else f=y,y=s}return g!==s&&(g=o(g)),h=g,h}function pv(){var h,g;return v++,h=f,g=fe(),g!==s&&(g=u(g)),h=g,v--,h===s&&(g=s,v===0&&D(l)),h}function zn(){var h,g,y,m,S;for(h=f,g=[],y=V();y!==s;)g.push(y),y=V();if(g!==s)if(y=Ke(),y!==s){for(m=[],S=V();S!==s;)m.push(S),S=V();m!==s?(e.charCodeAt(f)===44?(S=d,f++):(S=s,v===0&&D(p)),S===s&&(S=null),S!==s?(g=E(y),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s;return h}function rs(){var h,g,y,m,S,M,j,H;if(v++,h=f,g=$v(),g!==s){for(y=[],m=V();m!==s;)y.push(m),m=V();if(y!==s)if(e.charCodeAt(f)===40?(m=T,f++):(m=s,v===0&&D(R)),m!==s){for(S=[],M=V();M!==s;)S.push(M),M=V();if(S!==s){for(M=[],j=zn();j!==s;)M.push(j),j=zn();if(M!==s){for(j=[],H=V();H!==s;)j.push(H),H=V();j!==s?(e.charCodeAt(f)===41?(H=A,f++):(H=s,v===0&&D(b)),H!==s?(g=x(g,M),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s}else f=h,h=s}else f=h,h=s;else f=h,h=s}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(w)),h}function _v(){var h;return e.charCodeAt(f)===45?(h=L,f++):(h=s,v===0&&D(k)),h===s&&(e.charCodeAt(f)===33?(h=U,f++):(h=s,v===0&&D(B))),h}function Ev(){var h,g,y,m;if(v++,h=f,g=_v(),g!==s){for(y=[],m=V();m!==s;)y.push(m),m=V();y!==s?(m=is(),m!==s?(g=C(g,m),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(G)),h}function mv(){var h,g,y,m,S,M;if(v++,h=f,e.charCodeAt(f)===40?(g=T,f++):(g=s,v===0&&D(R)),g!==s){for(y=[],m=V();m!==s;)y.push(m),m=V();if(y!==s)if(m=Ke(),m!==s){for(S=[],M=V();M!==s;)S.push(M),M=V();S!==s?(e.charCodeAt(f)===41?(M=A,f++):(M=s,v===0&&D(b)),M!==s?(g=X(m),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(I)),h}function is(){var h,g,y,m;if(v++,h=f,e.charCodeAt(f)===126?(g=Z,f++):(g=s,v===0&&D(he)),g===s&&(g=null),g!==s){for(y=[],m=V();m!==s;)y.push(m),m=V();y!==s?(m=Ev(),m===s&&(m=Xv(),m===s&&(m=Yv(),m===s&&(m=zv(),m===s&&(m=rs(),m===s&&(m=pv(),m===s&&(m=mv())))))),m!==s?(g=ae(g,m),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(q)),h}function Kn(){var h;return e.charCodeAt(f)===94?(h=J,f++):(h=s,v===0&&D(Ce)),h===s&&(e.charCodeAt(f)===42?(h=Ge,f++):(h=s,v===0&&D(Fe)),h===s&&(e.charCodeAt(f)===47?(h=ct,f++):(h=s,v===0&&D(at)),h===s&&(e.charCodeAt(f)===37?(h=St,f++):(h=s,v===0&&D(Ye)),h===s&&(e.charCodeAt(f)===43?(h=lt,f++):(h=s,v===0&&D(ht)),h===s&&(e.charCodeAt(f)===45?(h=L,f++):(h=s,v===0&&D(k)),h===s&&(e.substr(f,2)===ze?(h=ze,f+=2):(h=s,v===0&&D(Ys)),h===s&&(e.charCodeAt(f)===62?(h=zs,f++):(h=s,v===0&&D(tR)),h===s&&(e.substr(f,2)===En?(h=En,f+=2):(h=s,v===0&&D(sR)),h===s&&(e.charCodeAt(f)===60?(h=rR,f++):(h=s,v===0&&D(iR)),h===s&&(e.substr(f,2)===mn?(h=mn,f+=2):(h=s,v===0&&D(nR)),h===s&&(e.substr(f,2)===wn?(h=wn,f+=2):(h=s,v===0&&D(oR)),h===s&&(e.substr(f,2)===Tn?(h=Tn,f+=2):(h=s,v===0&&D(cR)),h===s&&(e.charCodeAt(f)===38?(h=aR,f++):(h=s,v===0&&D(lR)),h===s&&(e.substr(f,2)===yn?(h=yn,f+=2):(h=s,v===0&&D(hR)),h===s&&(e.charCodeAt(f)===124?(h=uR,f++):(h=s,v===0&&D(dR))))))))))))))))),h}function Ke(){var h,g,y,m,S,M,j,H;if(v++,h=f,g=is(),g!==s){for(y=[],m=f,S=[],M=V();M!==s;)S.push(M),M=V();if(S!==s)if(M=Kn(),M!==s){for(j=[],H=V();H!==s;)j.push(H),H=V();j!==s?(H=is(),H!==s?(S=bn(g,M,H),m=S):(f=m,m=s)):(f=m,m=s)}else f=m,m=s;else f=m,m=s;for(;m!==s;){for(y.push(m),m=f,S=[],M=V();M!==s;)S.push(M),M=V();if(S!==s)if(M=Kn(),M!==s){for(j=[],H=V();H!==s;)j.push(H),H=V();j!==s?(H=is(),H!==s?(S=bn(g,M,H),m=S):(f=m,m=s)):(f=m,m=s)}else f=m,m=s;else f=m,m=s}y!==s?(g=gR(g,y),h=g):(f=h,h=s)}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(fR)),h}function wv(){var h,g,y,m,S,M,j,H;if(h=f,g=fe(),g!==s){for(y=[],m=f,S=oe(),S!==s?(e.charCodeAt(f)===44?(M=d,f++):(M=s,v===0&&D(p)),M!==s?(j=oe(),j!==s?(H=fe(),H!==s?(S=On(g,H),m=S):(f=m,m=s)):(f=m,m=s)):(f=m,m=s)):(f=m,m=s);m!==s;)y.push(m),m=f,S=oe(),S!==s?(e.charCodeAt(f)===44?(M=d,f++):(M=s,v===0&&D(p)),M!==s?(j=oe(),j!==s?(H=fe(),H!==s?(S=On(g,H),m=S):(f=m,m=s)):(f=m,m=s)):(f=m,m=s)):(f=m,m=s);y!==s?(g=pR(g,y),h=g):(f=h,h=s)}else f=h,h=s;return h}function Tv(){var h,g,y,m,S,M,j,H,le;if(h=f,g=Vv(),g!==s){if(y=[],m=V(),m!==s)for(;m!==s;)y.push(m),m=V();else y=s;if(y!==s)if(m=oe(),m!==s){if(S=[],M=f,j=qn(),j!==s){if(H=[],le=V(),le!==s)for(;le!==s;)H.push(le),le=V();else H=s;H!==s?(j=Rn(g,j),M=j):(f=M,M=s)}else f=M,M=s;for(;M!==s;)if(S.push(M),M=f,j=qn(),j!==s){if(H=[],le=V(),le!==s)for(;le!==s;)H.push(le),le=V();else H=s;H!==s?(j=Rn(g,j),M=j):(f=M,M=s)}else f=M,M=s;S!==s?(M=wv(),M!==s?(g=_R(g,S,M),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s}else f=h,h=s;return h}function yv(){var h,g,y,m,S,M;if(v++,h=f,g=fe(),g!==s)if(y=oe(),y!==s)if(e.substr(f,2)===Mn?(m=Mn,f+=2):(m=s,v===0&&D(mR)),m===s&&(e.substr(f,3)===vn?(m=vn,f+=3):(m=s,v===0&&D(wR))),m!==s){for(S=[],M=V();M!==s;)S.push(M),M=V();S!==s?(M=Ke(),M!==s?(g=TR(g,m,M),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s;else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(ER)),h}function bv(){var h,g,y,m,S,M;if(v++,h=f,g=Ke(),g!==s)if(y=oe(),y!==s)if(e.charCodeAt(f)===61?(m=Sn,f++):(m=s,v===0&&D(An)),m!==s){for(S=[],M=V();M!==s;)S.push(M),M=V();S!==s?(M=Ke(),M!==s?(g=bR(g,m,M),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s;else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(yR)),h}function Ov(){var h,g,y,m,S,M,j,H;if(v++,h=f,g=fe(),g!==s){for(y=[],m=f,S=[],M=V();M!==s;)S.push(M),M=V();if(S!==s)if(e.charCodeAt(f)===44?(M=d,f++):(M=s,v===0&&D(p)),M!==s){for(j=[],H=V();H!==s;)j.push(H),H=V();j!==s?(H=fe(),H!==s?(S=ut(g,H),m=S):(f=m,m=s)):(f=m,m=s)}else f=m,m=s;else f=m,m=s;for(;m!==s;){for(y.push(m),m=f,S=[],M=V();M!==s;)S.push(M),M=V();if(S!==s)if(e.charCodeAt(f)===44?(M=d,f++):(M=s,v===0&&D(p)),M!==s){for(j=[],H=V();H!==s;)j.push(H),H=V();j!==s?(H=fe(),H!==s?(S=ut(g,H),m=S):(f=m,m=s)):(f=m,m=s)}else f=m,m=s;else f=m,m=s}if(y!==s){for(m=[],S=V();S!==s;)m.push(S),S=V();if(m!==s)if(e.charCodeAt(f)===61?(S=Sn,f++):(S=s,v===0&&D(An)),S!==s){for(M=[],j=V();j!==s;)M.push(j),j=V();M!==s?(e.charCodeAt(f)===63?(j=Nn,f++):(j=s,v===0&&D(In)),j!==s?(g=RR(g,y),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s}else f=h,h=s}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(OR)),h}function Rv(){var h,g,y,m,S,M,j,H,le,dt;if(v++,h=f,e.charCodeAt(f)===63?(g=Nn,f++):(g=s,v===0&&D(In)),g!==s)if(y=oe(),y!==s)if(m=fe(),m!==s){for(S=[],M=f,j=oe(),j!==s?(e.charCodeAt(f)===44?(H=d,f++):(H=s,v===0&&D(p)),H!==s?(le=oe(),le!==s?(dt=fe(),dt!==s?(j=ut(m,dt),M=j):(f=M,M=s)):(f=M,M=s)):(f=M,M=s)):(f=M,M=s);M!==s;)S.push(M),M=f,j=oe(),j!==s?(e.charCodeAt(f)===44?(H=d,f++):(H=s,v===0&&D(p)),H!==s?(le=oe(),le!==s?(dt=fe(),dt!==s?(j=ut(m,dt),M=j):(f=M,M=s)):(f=M,M=s)):(f=M,M=s)):(f=M,M=s);S!==s?(g=vR(m,S),h=g):(f=h,h=s)}else f=h,h=s;else f=h,h=s;else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(MR)),h}function Mv(){var h,g,y,m,S,M;if(v++,h=f,g=rs(),g!==s){if(y=[],m=f,S=[],M=V(),M!==s)for(;M!==s;)S.push(M),M=V();else S=s;for(S!==s?(M=rs(),M!==s?(S=ut(g,M),m=S):(f=m,m=s)):(f=m,m=s);m!==s;){if(y.push(m),m=f,S=[],M=V(),M!==s)for(;M!==s;)S.push(M),M=V();else S=s;S!==s?(M=rs(),M!==s?(S=ut(g,M),m=S):(f=m,m=s)):(f=m,m=s)}y!==s?(g=AR(g,y),h=g):(f=h,h=s)}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(SR)),h}function vv(){var h,g,y,m,S,M;if(v++,h=f,e.charCodeAt(f)===40?(g=T,f++):(g=s,v===0&&D(R)),g!==s){for(y=[],m=V();m!==s;)y.push(m),m=V();if(y!==s)if(m=Ke(),m!==s){for(S=[],M=V();M!==s;)S.push(M),M=V();S!==s?(e.charCodeAt(f)===41?(M=A,f++):(M=s,v===0&&D(b)),M!==s?(g=Pn(m),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(xn)),h}function Sv(){var h,g,y,m,S;for(v++,h=f,g=[],y=V();y!==s;)g.push(y),y=V();if(g!==s)if(y=Ke(),y!==s){for(m=[],S=V();S!==s;)m.push(S),S=V();m!==s?(e.charCodeAt(f)===41?(S=A,f++):(S=s,v===0&&D(b)),S!==s?(g=Pn(y),h=g):(f=h,h=s)):(f=h,h=s)}else f=h,h=s;else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(xn)),h}function ns(){var h;return h=vv(),h===s&&(h=Sv()),h}function os(){var h,g,y;if(h=f,g=[],y=V(),y!==s)for(;y!==s;)g.push(y),y=V();else g=s;return g!==s?(y=qs(),y!==s?(g=E(y),h=g):(f=h,h=s)):(f=h,h=s),h}function Av(){var h,g,y,m;return v++,h=f,e.substr(f,2).toLowerCase()===IR?(g=e.substr(f,2),f+=2):(g=s,v===0&&D(xR)),g!==s?(y=oe(),y!==s?(m=ns(),m!==s?(g=PR(m),h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),v--,h===s&&(g=s,v===0&&D(NR)),h}function Nv(){var h,g,y,m;return v++,h=f,e.substr(f,5).toLowerCase()===DR?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(kR)),g!==s?(y=oe(),y!==s?(m=ns(),m!==s?(g=CR(m),h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),v--,h===s&&(g=s,v===0&&D(LR)),h}function Iv(){var h,g,y,m;return v++,h=f,e.substr(f,5).toLowerCase()===FR?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(BR)),g!==s?(y=oe(),y!==s?(m=ns(),m!==s?(g=UR(m),h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),v--,h===s&&(g=s,v===0&&D(GR)),h}function xv(){var h,g,y,m,S;return v++,h=f,e.substr(f,4).toLowerCase()===VR?(g=e.substr(f,4),f+=4):(g=s,v===0&&D($R)),g!==s?(y=oe(),y!==s?(m=ns(),m!==s?(S=os(),S===s&&(S=null),S!==s?(g=jR(m,S),h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),v--,h===s&&(g=s,v===0&&D(WR)),h}function Pv(){var h,g,y;return h=f,e.substr(f,4).toLowerCase()===HR?(g=e.substr(f,4),f+=4):(g=s,v===0&&D(XR)),g!==s?(y=os(),y===s&&(y=null),y!==s?(g=YR(y),h=g):(f=h,h=s)):(f=h,h=s),h}function Lv(){var h,g,y;return h=f,e.substr(f,5).toLowerCase()===zR?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(KR)),g!==s?(y=os(),y===s&&(y=null),y!==s?(g=qR(y),h=g):(f=h,h=s)):(f=h,h=s),h}function Dv(){var h,g;return h=f,e.substr(f,5).toLowerCase()===JR?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(ZR)),g!==s&&(g=QR()),h=g,h}function kv(){var h,g;return h=f,e.substr(f,8).toLowerCase()===eM?(g=e.substr(f,8),f+=8):(g=s,v===0&&D(tM)),g!==s&&(g=sM()),h=g,h}function Cv(){var h,g;return h=f,e.substr(f,2).toLowerCase()===rM?(g=e.substr(f,2),f+=2):(g=s,v===0&&D(iM)),g!==s&&(g=nM()),h=g,h}function Gv(){var h,g;return h=f,e.substr(f,9).toLowerCase()===oM?(g=e.substr(f,9),f+=9):(g=s,v===0&&D(cM)),g!==s&&(g=aM()),h=g,h}function Fv(){var h,g;return h=f,e.substr(f,6).toLowerCase()===lM?(g=e.substr(f,6),f+=6):(g=s,v===0&&D(hM)),g!==s&&(g=uM()),h=g,h}function Bv(){var h,g,y;return h=f,e.substr(f,7).toLowerCase()===dM?(g=e.substr(f,7),f+=7):(g=s,v===0&&D(fM)),g!==s?(y=os(),y===s&&(y=null),y!==s?(g=gM(y),h=g):(f=h,h=s)):(f=h,h=s),h}function Uv(){var h,g;return h=f,e.substr(f,8).toLowerCase()===pM?(g=e.substr(f,8),f+=8):(g=s,v===0&&D(_M)),g!==s&&(g=EM()),h=g,h}function Wv(){var h,g,y,m;return v++,h=f,e.substr(f,6).toLowerCase()===wM?(g=e.substr(f,6),f+=6):(g=s,v===0&&D(TM)),g!==s?(y=oe(),y!==s?(m=fe(),m!==s?(g=yM(m),h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),v--,h===s&&(g=s,v===0&&D(mM)),h}function qs(){var h;return h=Tv(),h===s&&(h=yv(),h===s&&(h=bv(),h===s&&(h=Ov(),h===s&&(h=Rv(),h===s&&(h=Av(),h===s&&(h=Pv(),h===s&&(h=Lv(),h===s&&(h=Dv(),h===s&&(h=Nv(),h===s&&(h=kv(),h===s&&(h=Cv(),h===s&&(h=Iv(),h===s&&(h=Gv(),h===s&&(h=Fv(),h===s&&(h=xv(),h===s&&(h=Bv(),h===s&&(h=Mv(),h===s&&(h=Uv(),h===s&&(h=Wv()))))))))))))))))))),h}function Vv(){var h,g;return h=f,e.substr(f,6).toLowerCase()===bM?(g=e.substr(f,6),f+=6):(g=s,v===0&&D(OM)),g!==s&&(g=RM()),h=g,h===s&&(h=f,e.substr(f,6).toLowerCase()===MM?(g=e.substr(f,6),f+=6):(g=s,v===0&&D(vM)),g!==s&&(g=SM()),h=g,h===s&&(h=f,e.substr(f,5).toLowerCase()===AM?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(NM)),g!==s&&(g=IM()),h=g,h===s&&(h=f,e.substr(f,8).toLowerCase()===xM?(g=e.substr(f,8),f+=8):(g=s,v===0&&D(PM)),g!==s&&(g=LM()),h=g,h===s&&(h=f,e.substr(f,7).toLowerCase()===DM?(g=e.substr(f,7),f+=7):(g=s,v===0&&D(kM)),g!==s&&(g=CM()),h=g)))),h}function qn(){var h,g;return h=f,e.substr(f,5).toLowerCase()===GM?(g=e.substr(f,5),f+=5):(g=s,v===0&&D(FM)),g!==s&&(g=BM()),h=g,h===s&&(h=f,e.substr(f,6).toLowerCase()===UM?(g=e.substr(f,6),f+=6):(g=s,v===0&&D(WM)),g!==s&&(g=VM()),h=g,h===s&&(h=f,e.substr(f,9).toLowerCase()===$M?(g=e.substr(f,9),f+=9):(g=s,v===0&&D(jM)),g!==s&&(g=HM()),h=g)),h}function fe(){var h,g,y;if(v++,h=f,g=[],Ln.test(e.charAt(f))?(y=e.charAt(f),f++):(y=s,v===0&&D(Dn)),y!==s)for(;y!==s;)g.push(y),Ln.test(e.charAt(f))?(y=e.charAt(f),f++):(y=s,v===0&&D(Dn));else g=s;return g!==s?h=e.substring(h,f):h=g,v--,h===s&&(g=s,v===0&&D(l)),h}function $v(){var h;return v++,h=fe(),v--,h===s&&v===0&&D(XM),h}function Js(){var h,g;if(h=[],Qt.test(e.charAt(f))?(g=e.charAt(f),f++):(g=s,v===0&&D(es)),g!==s)for(;g!==s;)h.push(g),Qt.test(e.charAt(f))?(g=e.charAt(f),f++):(g=s,v===0&&D(es));else h=s;return h}function jv(){var h,g,y;return h=f,e.charCodeAt(f)===46?(g=YM,f++):(g=s,v===0&&D(zM)),g!==s?(y=Js(),y!==s?(g=[g,y],h=g):(f=h,h=s)):(f=h,h=s),h}function Hv(){var h,g,y,m;return h=f,KM.test(e.charAt(f))?(g=e.charAt(f),f++):(g=s,v===0&&D(qM)),g!==s?(JM.test(e.charAt(f))?(y=e.charAt(f),f++):(y=s,v===0&&D(ZM)),y===s&&(y=null),y!==s?(m=Js(),m!==s?(g=[g,y,m],h=g):(f=h,h=s)):(f=h,h=s)):(f=h,h=s),h}function Xv(){var h,g,y,m,S,M;return v++,h=f,g=f,y=f,m=Js(),m!==s?(S=jv(),S===s&&(S=null),S!==s?(M=Hv(),M===s&&(M=null),M!==s?(m=[m,S,M],y=m):(f=y,y=s)):(f=y,y=s)):(f=y,y=s),y!==s?g=e.substring(g,f):g=y,g!==s&&(g=ev(g)),h=g,v--,h===s&&(g=s,v===0&&D(QM)),h}function Yv(){var h,g,y,m,S;if(v++,h=f,e.charCodeAt(f)===35?(g=sv,f++):(g=s,v===0&&D(rv)),g!==s){for(y=f,m=[],Qt.test(e.charAt(f))?(S=e.charAt(f),f++):(S=s,v===0&&D(es));S!==s;)m.push(S),Qt.test(e.charAt(f))?(S=e.charAt(f),f++):(S=s,v===0&&D(es));m!==s?y=e.substring(y,f):y=m,y!==s?(g=iv(y),h=g):(f=h,h=s)}else f=h,h=s;return v--,h===s&&(g=s,v===0&&D(tv)),h}function zv(){var h,g,y,m,S,M;if(h=f,g=f,e.charCodeAt(f)===39?(y=kn,f++):(y=s,v===0&&D(Cn)),y!==s){for(m=f,S=[],Gn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=s,v===0&&D(Fn));M!==s;)S.push(M),Gn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=s,v===0&&D(Fn));S!==s?m=e.substring(m,f):m=S,m!==s?(e.charCodeAt(f)===39?(S=kn,f++):(S=s,v===0&&D(Cn)),S!==s?(y=[y,m,S],g=y):(f=g,g=s)):(f=g,g=s)}else f=g,g=s;if(g===s)if(g=f,e.charCodeAt(f)===34?(y=Bn,f++):(y=s,v===0&&D(Un)),y!==s){for(m=f,S=[],Wn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=s,v===0&&D(Vn));M!==s;)S.push(M),Wn.test(e.charAt(f))?(M=e.charAt(f),f++):(M=s,v===0&&D(Vn));S!==s?m=e.substring(m,f):m=S,m!==s?(e.charCodeAt(f)===34?(S=Bn,f++):(S=s,v===0&&D(Un)),S!==s?(y=[y,m,S],g=y):(f=g,g=s)):(f=g,g=s)}else f=g,g=s;return g!==s&&(g=nv(g)),h=g,h}function V(){var h;return v++,cv.test(e.charAt(f))?(h=e.charAt(f),f++):(h=s,v===0&&D(av)),v--,h===s&&v===0&&D(ov),h}function Jn(){var h;return v++,e.charCodeAt(f)===10?(h=hv,f++):(h=s,v===0&&D(uv)),v--,h===s&&v===0&&D(lv),h}function oe(){var h,g;for(v++,h=[],$n.test(e.charAt(f))?(g=e.charAt(f),f++):(g=s,v===0&&D(jn));g!==s;)h.push(g),$n.test(e.charAt(f))?(g=e.charAt(f),f++):(g=s,v===0&&D(jn));return v--,h===s&&(g=s,v===0&&D(dv)),h}if(ss=i(),ss!==s&&f===e.length)return ss;throw ss!==s&&f<e.length&&D(fv()),gv(Ks,Oe<e.length?e.charAt(Oe):null,Oe<e.length?Xn(Oe,Oe+1):Xn(Oe,Oe))}const ga=fa;class Bt extends Error{constructor(t){super(t.join(`
`)),this.errors=t}format(t=`
`){return this.errors.join(t)}}function pa(e,t){let s;try{s=ga(e)}catch(r){if(!(r instanceof Error))throw r;const i=r.location.start,n=`Строка ${i.line} столбец ${i.column}: ${r.message}`;throw new Bt([n])}try{return ha(s,t)}catch(r){throw r instanceof Error?new Bt([r.message]):r}}function _a(e,t){let s;try{s=ua(e)}catch(r){throw r instanceof Error?new Bt([r.message]):r}return pa(s,t)}function Ts(e){return new Function("g","schema","memory",e)}const Ea={[F.FLOAT]:"F",[F.STRING]:"S",[F.HANDLE]:"H",[F.COLORREF]:"C",[ve.FLOAT_REF]:"G",[ve.STRING_REF]:"T",[ve.HANDLE_REF]:"I",[ve.COLORREF_REF]:"D"};function ma(e){return e.map(t=>Ea[t]).join("")}const ys=[];class wa{constructor(){this.m=new Map}addFunc(t,s){const r=s.a||ys,i=s.rest||ys,n=r.concat(i),o=t.toUpperCase();let l=this.m.get(o);if(!l)this.m.set(o,l=[]);else{const d=me-1;if(l.some(p=>{const E=p.argTypes.concat(p.type==="plugin"?p.restArgsTypes:ys);return E.length===n.length&&E.every((w,T)=>(w&d)===(n[T]&d))}))throw Error(`Функция '${t}' с аргументами '${r}' уже существует`)}const u="$"+t+(r.length?"$"+ma(n):"");return l.push({type:"plugin",path:u,argTypes:r,restArgsTypes:i,retType:s.r||null}),u}addUserFunc(t){const s=t.name.toUpperCase(),r=this.m.get(s);if(!r)return this.m.set(s,[t]),!0;const i=me-1;return r.some(n=>n.argTypes.length===t.argTypes.length&&n.argTypes.every((o,l)=>(o&i)===t.argTypes[l]))?!1:(r.push(t),!0)}compile(t,s,r){return _a(t,{funcTable:this.m,sourceURL:s,comment:r})}}class Ta{constructor(t){if(this.pens=new Set,this.brushes=new Set,this.images=new Set,this.imagesOpaque=new Set,this.strings=new Set,this.fonts=new Set,this.texts=new Set,t)if(t.type==="group")for(const s of Xr(t))s.type!=="group"&&this.add(s);else this.add(t)}add(t){switch(t.type){case"line":t.pen&&this.pens.add(t.pen),t.brush&&(this.add(t.brush),this.brushes.add(t.brush));break;case"imageView":(t.opaque?this.imagesOpaque:this.images).add(t.image);break;case"textView":this.add(t.text),this.texts.add(t.text);break;case"input":t.font&&this.fonts.add(t.font);break;case"brush":t.image&&this.imagesOpaque.add(t.image);break;case"text":t.parts.forEach(s=>{this.strings.add(s.string),this.fonts.add(s.font)});break;case"scene":t.background&&(this.add(t.background),this.brushes.add(t.background));break}return this}}function*Xr(e,t){e.type==="group"&&(yield*e.descendants(t)),yield e}function*ya(e,t){for(const s of e)s.type==="group"&&(yield*s.descendants(t)),yield s}function ba(e,t){const s=[],r=new Ta,i=new WeakSet;let n=null;const o=Symbol.iterator in e?ya(e,!0):Xr(e,!0);for(const l of o)n=l.scene,s.push(l.toJSON()),l.type!=="group"&&(r.add(l),i.add(l));return{pens:Array.from(r.pens,l=>l.toJSON()),brushes:Array.from(r.brushes,l=>l.toJSON()),images:Array.from(r.images,l=>l.toJSON()),imagesOpaque:Array.from(r.imagesOpaque,l=>l.toJSON()),strings:Array.from(r.strings,l=>l.toJSON()),fonts:Array.from(r.fonts,l=>l.toJSON()),texts:Array.from(r.texts,l=>l.toJSON()),objects:s,order:n?ao(n.order,l=>i.has(l)&&l.key):[]}}function Oa(e){return lr(e.values(),t=>!t.parent)}function Yr(e,t,s){const{objects:r}=e.merge(t,s),i=Oa(r);return i.length>1?e.group(i,{key:0}):i[0]}const Ra={x:0,y:0,w:0,h:0};function zr(e){let t=1/0,s=1/0,r=-1/0,i=-1/0;for(const n of e)n.x<t&&(t=n.x),n.y<s&&(s=n.y),n.x+n.width>r&&(r=n.x+n.width),n.y+n.height>i&&(i=n.y+n.height);return t===1/0?Ra:{x:t,y:s,w:r-t,h:i-s}}const re=kt;class Ma{constructor(t,s){this.id=t,this.attrib=0,this.description="",this.defaultValue=null,this.inEquation=!1,this.parsed=null,this.name=s.name,this.type=s.type,this.set(s)}set({attrib:t=this.attrib,defaultValue:s=this.defaultValue,description:r=this.description,inEquation:i=this.inEquation}){return this.parsed=s!==null?Fr(this.type,s):null,this.attrib=t,this.defaultValue=s,this.description=r,this.inEquation=i,this}}class Kr{constructor(t){this._disable=null,this._enable=null,this.orgx=null,this.orgy=null,this._hobject=null,this._objname=null,this._classname=null,this.msg=null,this.xpos=null,this.ypos=null,this.fwkeys=null,this.wvkey=null,this.repeat=null,this.scancode=null,this.nwidth=null,this.nheight=null,this._hspace=null,this._windowName=null,this.iditem=null,this.wnotifycode=null;const s=t?.map((r,i)=>[r.name.toUpperCase(),new Ma(i,r)]);if(this.list=s?.map(r=>r[1])??[],this.m=new Map(s),!!s)for(const[r,i]of s){const n=i.type,{FLOAT:o,STRING:l,HANDLE:u}=F;r==="_ENABLE"&&n===o?this._enable=i:r==="_DISABLE"&&n===o?this._disable=i:r==="MSG"&&n===o?this.msg=i:r==="_HOBJECT"&&n===u?this._hobject=i:r==="IDITEM"&&n===o?this.iditem=i:r==="WNOTIFYCODE"&&n===o?this.wnotifycode=i:r==="NWIDTH"&&n===o?this.nwidth=i:r==="NHEIGHT"&&n===o?this.nheight=i:r==="XPOS"&&n===o?this.xpos=i:r==="YPOS"&&n===o?this.ypos=i:r==="FWKEYS"&&n===o?this.fwkeys=i:r==="ORGX"&&n===o?this.orgx=i:r==="ORGY"&&n===o?this.orgy=i:r==="_OBJNAME"&&n===l?this._objname=i:r==="_CLASSNAME"&&n===l?this._classname=i:r==="WVKEY"&&n===o?this.wvkey=i:r==="REPEAT"&&n===o?this.repeat=i:r==="SCANCODE"&&n===o?this.scancode=i:r==="_HSPACE"&&n===u?this._hspace=i:r==="_WINDOWNAME"&&n===l&&(this._windowName=i)}}get(t){return this.m.get(t.toUpperCase())??null}}class va{constructor({compiler:t,data:s,file:r,projectId:i,modelGlobals:n}){this.onChildrenChanged=new Ee,this.main=null,this.defers=[],this.equations=[],this.transpiledCode=null,this.isCompiled=!1;const{name:o,transpiled:l,id:u,vars:d}=s;this.projectId=i,this.compiler=t,this.modelGlobals=n,this.file=r,this.name=o,this.nameUC=o.toUpperCase(),this.vars=new Kr(d),this.transpiledCode=l??null,this.id=u,this.children=s.children||[],this.connections=s.links||[],this.scene=s.scene||null,this.image=s.image||null,this.modelText=s.modelText||"",this.isFunction=s.isFunction||!1}set({vars:t,children:s=this.children,links:r=this.connections,scene:i=this.scene,image:n=this.image,modelText:o=this.modelText,isFunction:l=this.isFunction}){return t&&(this.vars=new Kr(t)),this.modelText!==o&&(this.isCompiled=!1),this.children!==s&&(this.children=s,this.onChildrenChanged.dispatch(s)),this.connections=r,this.scene=i,this.image=n,this.modelText=o,this.isFunction=l,this}compile(){if(this.isCompiled)return;this.isCompiled=!0;let t;if(this.transpiledCode)re.debugCompiler&&console.log(`Компиляция (кешировано) ${this.name} (${this.vars.list.length} переменных)`),t=this.transpiledCode,this.transpiledCode=null;else{const r=this.file.path.toString().slice(3);re.debugCompiler&&console.log(`Компиляция '${this.name}' ('${r}'): ${this.vars.list.length} переменных`);try{const i=this.compiler.compile(this.modelText,this.name,r);re.debugCompiler&&i.bugs.length&&console.warn(`${this.name}:
${i.bugs.map(([l])=>` -${l}`).join(`
`)}`);const n=this.vars,o=i.vars.map(l=>{const u=n.get(l.name);if(!u)return l;const{defaultValue:d,description:p}=u;return{...l,defaultValue:d,description:p}});this.set({vars:o,isFunction:i.isFunction}),t=i}catch(i){throw i instanceof Bt?Error(`Ошибка компиляции '${this.name}' ('${r}'): '${i.message}'`):i}}const{modelGlobals:s}=this;this.main=t.mainText?Ts(t.mainText).bind(null,s):null,this.defers=t.defersTexts?.map(r=>Ts(r).bind(null,s))||[],this.equations=t.equationsTexts?.map(r=>Ts(r).bind(null,s))||[]}getUserFunctionSignature(){const t=this.vars.list;return{type:"user",name:this.name,argTypes:t.filter(s=>s.attrib&P.VF_ARGUMENT).map(s=>s.type),retType:t.find(s=>s.attrib&P.VF_RETURN)?.type??null}}}class Sa{constructor(){this.files=new WeakSet,this.m=new Map}add(t){const{nameUC:s}=t,r=this.m.get(s);if(r)throw Error(`Конфликт имен имиджей: '${t.name}' ('${t.file.path}') уже существует в файле '${r.file.path}'`);return this.m.set(s,t),this.files.add(t.file),this}get(t){return this.m.get(t.toUpperCase())??null}hasFile(t){return this.files.has(t)}unload(t){this.m.forEach(s=>s.projectId===t&&this.files.delete(s.file)),this.m=new Map(lr(this.m,s=>s[1].projectId!==t))}}class bs extends Error{constructor(t,s){super(t),this.original=s}}class Aa{alloc(t){const s=new Float64Array(t.floats),r=new Int32Array(t.ints),i=Array.from({length:t.strings},()=>"");this.newFloats=s,this.oldFloats=s.slice(),this.newInts=r,this.oldInts=r.slice(),this.newStrings=i,this.oldStrings=i.slice()}sync(){this.oldFloats.set(this.newFloats),this.oldInts.set(this.newInts);const{newStrings:t,oldStrings:s}=this;for(let r=0;r<t.length;++r)s[r]=t[r]}}class Na{constructor(t){this.newFloats=this.oldFloats=new Float64Array(t.floats),this.newInts=this.oldInts=new Int32Array(t.ints),this.newStrings=this.oldStrings=Array.from({length:t.strings},()=>"")}}class qr{constructor(t,s){this.map=t,this.values=s}getNewValue(t){const{newFloats:s,newInts:r,newStrings:i}=this.values,n=this.map[t.id];switch(t.type){case F.FLOAT:return s[n];case F.HANDLE:case F.COLORREF:return r[n];case F.STRING:return i[n]}}setValue(t,s){const{newFloats:r,oldFloats:i,newInts:n,oldInts:o,newStrings:l,oldStrings:u}=this.values,d=this.map[t.id];switch(t.type){case F.FLOAT:if(typeof s!="number")return!1;r[d]=i[d]=s;break;case F.HANDLE:case F.COLORREF:if(typeof s!="number")return!1;n[d]=o[d]=s;break;case F.STRING:if(typeof s!="string")return!1;l[d]=u[d]=s;break}return!0}}class Jr{constructor(){this.floats=0,this.ints=0,this.strings=0}add(t){switch(t.type){case F.FLOAT:return this.floats++;case F.HANDLE:case F.COLORREF:return this.ints++;case F.STRING:return this.strings++}}}class Ia{constructor(t,s){this.v=t,this.a=s,this.index=-1,this.connected=new Set}propagateIndex(t){this.index>=0||(this.index=t,this.connected.forEach(s=>s.propagateIndex(t)))}connectWith(t){this.connected.add(t),t.connected.add(this)}getIndex(){return this.index<0&&this.propagateIndex(this.a.add(this.v)),this.index}}function xa(e,t){const{children:s}=e;t.forEach(({nodes:[r,i],vars:n,attrib:o=0})=>{if(o&Wc)return;let l=`Имидж ${e.klass.name}: связь #${r}-#${i}: `;const u=r>0?s.find(p=>p.ndata.key===r):e;if(!u){console.warn(l+`Дочерний имидж #${r} не существует`);return}const d=i>0?s.find(p=>p.ndata.key===i):e;if(!d){console.warn(l+`Дочерний имидж #${i} не существует`);return}l=`Имидж ${e.klass.name}: связь #${r} (${u.klass.name}) - #${i} (${d.klass.name}): `,n.forEach(([p,E])=>{const w=u.klass.vars.get(p);if(!w){console.warn(l+`Переменная ${u.klass.name}:${p} не существует`);return}const T=d.klass.vars.get(E);if(!T){console.warn(l+`Переменная ${d.klass.name}:${E} не существует`);return}if(w.type!==T.type){console.warn(l+`Типы переменных ${u.klass.name}:${p} и ${d.klass.name}:${E} не совпадают`);return}u.vars[w.id].connectWith(d.vars[T.id])})})}function Zr(e,t,s,r=null){e.compile();const i=e.vars.list.map(l=>new Ia(l,s)),n=e.children.map(l=>{const u=t.get(l.klass);if(!u)throw Error(`Подимидж ${l.klass} #${l.key} имиджа ${e.name} не существует`);return Zr(u,t,s,l)}),o={klass:e,ndata:r,vars:i,children:n};return e.connections.length&&xa(o,e.connections),o}function Qr(e,t,s){const r=e.vars.map(n=>{const o=n.getIndex();return n.v.inEquation&&s.add(o),o}),i=e.children.map(n=>Qr(n,t,s));return t.createSchema({...e,varMap:r,children:i,prj:t})}function Pa(){return!1}function La(e,t){return e.values.newFloats[e.map[t]]>0}function Da(e,t){return e.values.newFloats[e.map[t]]<=0}const ei=new WeakMap;class ka{constructor({prj:t,klass:s,ndata:r,vars:i,children:n}){this.isDisabled=Pa,this.updateChildNodeData=u=>{u.length===this.children.length&&u.forEach((d,p)=>{const E=this.children[p],w=E.ndata;w.key!==d.key||w.klass!==d.klass||(w.name&&this.resolveMap.delete(w.name),d.name&&this.resolveMap.set(d.name.toUpperCase(),E),E.ndata=d)})},this.prj=t,this.klass=s,this.ndata=r,this.vars=i,this.children=n;const{_disable:o,_enable:l}=s.vars;o&&(!l||o.id<l.id)?this.isDisabled=La.bind(null,this.vars,o.id):l&&(!o||l.id<o.id)&&(this.isDisabled=Da.bind(null,this.vars,l.id)),this.resolveMap=new Map([["",this]]),n.forEach(u=>{u.resolveMap.set("..",this);const{key:d,name:p}=u.ndata;this.resolveMap.set("#"+d,u),p&&this.resolveMap.set(p.toUpperCase(),u)}),s.onChildrenChanged.add(this.updateChildNodeData)}get kernel(){return this.prj.kernel}resolve(t){if(t.length===0)return this;const s=t.toUpperCase().split("\\");let r=t[0]==="\\"?this.prj.root:this;for(const i of s){const n=r.resolveMap.get(i);if(!n)return null;r=n}return r}resolveMany(t,s){if(t){const r=this.resolve(t);return!r||s&&r.klass!==s?[]:[r]}return s?this.prj.getKlassSchemas(s):[]}initValues(t){this.children.forEach(r=>r.initValues());const{vars:s}=this.klass;return s.list.forEach(r=>{let i;if(r.parsed!==null)i=r.parsed;else switch(r){case s.orgx:i=this.ndata?.x??0;break;case s.orgy:i=this.ndata?.y??0;break;case s._hobject:i=this.ndata?.key??0;break;case s._objname:i=this.ndata?.name??"";break;case s._classname:i=this.klass.name;break;default:if(!t)return;i=r.type===F.STRING?"":0;break}this.vars.setValue(r,i)}),this}applyValues(t){const{values:s,klassId:r}=t;if(s?.length)if(this.klass.id===r){const{vars:i}=this.klass;s.forEach(({name:n,value:o})=>{const l=i.get(n);if(!l)return;const u=Fr(l.type,o);u!==null&&this.vars.setValue(l,u)})}else console.warn(`Пропуск установки stt для ${this.path()} (id ${this.klass.id}): ожидалось id ${r} (${t.klass})`);return t.children?.forEach(i=>this.children.find(n=>n.ndata.key===i.key)?.applyValues(i)),this}getValues(){const{klass:t,ndata:s}=this,r=this.children.map(n=>n.getValues()),i=t.vars.list.map(n=>{const o=Kc(n.type,this.vars.getNewValue(n));return{name:n.name,value:o}});return{key:s?.key??0,klass:t.name,klassId:t.id,values:i,children:r}}computeAndPushVector(t,s,{a:r,b:i}){const{vars:n}=this,{oldFloats:o,newFloats:l}=n.values;let u=!1;const d=t(this,n),p=s.map(E=>{l[E]=o[E]=1;const w=d-t(this,n);return l[E]=o[E]=0,w!==0&&(u=!0),w});u&&(r.push(p),i.push(d))}computeEquationVectors(t,s){this.children.forEach(r=>r.computeEquationVectors(t,s)),this.klass.equations.forEach(r=>this.computeAndPushVector(r,t,s))}computeSchemaDefers(){this.children.forEach(t=>!t.isDisabled()&&t.computeSchemaDefers()),this.klass.defers.forEach(t=>t(this,this.vars))}computeSchema(){this.children.forEach(t=>!t.isDisabled()&&t.computeSchema()),re.debugExecution&&console.log(`Выполняется ${this.path()}`);try{this.klass.main?.(this,this.vars)}catch(t){throw t instanceof Error?new bs(`${this.path()}: ${t.message}`,t):t}}compute(t){!t&&this.isDisabled()||(this.prj.beforeCompute(),this.computeSchema(),this.prj.solveGlobalEquations(),this.computeSchemaDefers(),this.prj.afterCompute())}userFunction(t,s){const r=this.kernel.classes.get(t);if(!r)throw Error(`Функция не существует: ${t}`);if(r.compile(),!r.isFunction)throw Error(`Имидж ${t} существует, но не является функцией`);const i=r.vars.list;if(s.length>i.length)throw Error(`${t}: ${s.length} аргументов, но функция имеет ${i.length} переменных`);let n=ei.get(i);if(!n){const u=new Jr;n={map:i.map(d=>u.add(d)),varCount:u},ei.set(i,n)}const o=new qr(n.map,new Na(n.varCount));s.forEach((u,d)=>{const p=i[d];if(!o.setValue(p,u))throw Error(`Аргумент ${d} имеет тип ${typeof u}; ожидалось ${p.type}`)}),r.main?.(this,o);const l=i.find(u=>u.attrib&P.VF_RETURN);if(l)return o.getNewValue(l)}solveEquationsFor(t){this.prj.solveEquationsFor(t)}path(){if(this===this.prj.root)return this.klass.name;const t=[this];for(;;){const s=t[0].resolveMap.get("..");if(s===this.prj.root)break;t.unshift(s)}return t.map(s=>`${s.klass.name} (#${s.ndata.key})`).join(" - ")}setNewValue(t,s){const{newFloats:r,newInts:i,newStrings:n}=this.vars.values,o=this.vars.map[t.id];switch(t.type){case F.FLOAT:if(typeof s!="number")return!1;r[o]=s;break;case F.HANDLE:case F.COLORREF:if(typeof s!="number")return!1;i[o]=s;break;case F.STRING:if(typeof s!="string")return!1;n[o]=s;break}return!0}getVarValueFHC(t){const{newFloats:s,newInts:r}=this.vars.values,i=this.vars.map[t.id];switch(t.type){case F.FLOAT:return s[i];case F.HANDLE:case F.COLORREF:return r[i];default:return null}}getVarValueS(t){return t.type===F.STRING?this.vars.values.newStrings[this.vars.map[t.id]]:null}}class Ca{constructor({id:t,dir:s,rootKlass:r,state:i,kernel:n,settings:o}){this.memory=new Aa,this.classTypes=new WeakMap,this.id=t,this.dir=s,this.kernel=n,this.settings=o;const l=new Set,u=new Jr,d=Zr(r,n.classes,u),p=this.root=Qr(d,this,l);this.memory.alloc(u),p.initValues(),i&&p.applyValues(i),this.equationVars=Array.from(l)}createSchema({varMap:t,...s}){const r=new ka({...s,vars:new qr(t,this.memory)}),i=this.classTypes.get(r.klass);return i?i.push(r):this.classTypes.set(r.klass,[r]),r}getKlassSchemas(t){return this.classTypes.get(t)??[]}solveGlobalEquations(){const{equationVars:t}=this;t.length&&this.solveEquationsFor(t)}solveEquationsFor(t){const{oldFloats:s,newFloats:r}=this.memory,i=t.map(o=>{const l=s[o];return r[o]=s[o]=0,l}),n={a:[],b:[]};this.root.computeEquationVectors(t,n),t.forEach((o,l)=>s[o]=i[l]);try{const o=ro(n);t.forEach((l,u)=>r[l]=o[u])}catch{t.forEach(l=>r[l]=0)}}beforeCompute(){this.kernel.beforeCompute.dispatch()}afterCompute(){this.memory.sync(),this.kernel.afterCompute.dispatch()}close(){this.kernel.closeProject(this)}}class Ga extends Error{constructor(t){super(`Проект ${t} загружается`)}}class Fa{constructor(t,s){if(this.fs=t,!s.projects.length)throw Error("Список проектов пуст");const r=s.projects.map(i=>{const n=t.path(i.filepath||"project.spj");return{config:i,path:n,state:{type:"notLoaded"}}});this.projects=r,this.initialProjectPath=s.initial?t.path(s.initial):r[0].path}exists(t){return this.projects.some(({path:s})=>s.equals(t))}async open(t){const s=this.projects.find(({path:n})=>n.equals(t));if(!s)return null;const r=s.state;if(r.type==="loading")throw new Ga(s.path);if(r.type==="loaded")return r.parsedProjectConfig;s.state={type:"loading"};let i;try{const{fs:n}=this,{path:o,config:l}=s;await Promise.all(l.libs.map(R=>n.mountLibrary(R)));const{searchDirs:u,stt:d}=l.settings,p=o.resolve(".."),E=[n.stdlibDir,p].concat(u?.map(R=>n.path(R))??[]),w=d?n.path(d):p.resolve("_preload.stt"),T=w.file()?.stt;T||console.warn(`Файл состояния ${w} не существует`),i={settings:l.settings,filepath:o,dir:p,searchDirs:E,stt:T}}catch(n){throw s.state={type:"notLoaded"},n}return s.state={type:"loaded",parsedProjectConfig:i},i}}class Ba{constructor(t,s,r){this.handlers={closed:new Set,error:new Set,shell:new Set,write:new Set,afterCycle:new Set},this.onProjectOpen=new Ee,this.beforeProjectClosed=new Ee,this.beforeCompute=new Ee,this.afterCompute=new Ee,this.beforeRender=new Ee,this.classes=new Sa,this.iterations=0,this.isPaused=!1,this.pluginFunctions={},this.compiler=new wa,this.pluginNames=[],this.optionalPlugins=[],this.projects=[],this.closedProjects=new Set,this.uiEventsEnabled=!0,this.lag=0,this.timeStep=0,this.update=i=>{let n=!0;if(!this.isPaused){if(this.timeStep>0){const o=i-this.lag;for(o>this.timeStep*10&&(console.warn(`lag обнулен: dt:${o}`),this.lag=i-this.timeStep-1);this.lag+this.timeStep<i&&(this.lag+=this.timeStep,!!(n=this.compute())););}else n=this.compute();n||this.handlers.closed.forEach(o=>o())}return this.beforeRender.dispatch(),n},this.showed=new Set,this.runner=new Qn(r),this.projectLoader=new Fa(t,s),this.initialCfg=this.init()}async init(){const t=this.projectLoader,s=await t.open(t.initialProjectPath);It(s,`${t.initialProjectPath}: Проект существует`),this.initialCfg=s}async ready(){return await this.initialCfg,this}get fs(){return this.projectLoader.fs}get currentProject(){const{projects:t}=this;return t.length?t[t.length-1]:null}canHandleProjectUiEvents(t){return this.uiEventsEnabled&&this.projects.includes(t)}run(){this.projects.length||(this.enableUiEvents(!0),this.isPaused=!1,this.iterations=0,It(!(this.initialCfg instanceof Promise),`${this.projectLoader.initialProjectPath}: Начальный проект загружен`),this.addProject(this.initialCfg),this.runner.run(this.update))}stop(){this.isPaused=!1,this.closeAll(),this.update(this.lag)}step(){this.isPaused=!1,this.update(this.lag),this.isPaused=!0}pause(){this.isPaused=!0}enableUiEvents(t){this.uiEventsEnabled=t}continue(){this.isPaused=!1}closeProject(t){const s=this.projects.indexOf(t);s>=0&&this.projects.splice(s,1),this.closedProjects.add(t)}closeAll(){let t;for(;t=this.projects.pop();)this.closedProjects.add(t)}hasProject(t){return this.projectLoader.exists(t)}async openProject(t){const s=await this.projectLoader.open(t);return s?this.addProject(s):null}addProject({filepath:t,searchDirs:s,dir:r,stt:i,settings:n}){re.debugProject&&console.log(`Открывается ${t}`);const o=Symbol(t.toString());let l;try{n.plugins?.forEach(d=>{const p=this.optionalPlugins.find(({plugin:E})=>E.name===d);It(p,`${t}: Плагин ${d} загружен`),this.addPlugin(p.plugin,p.opts),re.debugProject&&console.log(`Загружен плагин '${d}'`)}),s.forEach(d=>{const p=!n.nonRecursive||d.equals(this.fs.stdlibDir);d.forEach(E=>{if(!E.cls||this.classes.hasFile(E))return;const w=new va({projectId:o,data:E.cls,file:E,compiler:this.compiler,modelGlobals:this.pluginFunctions});w.isFunction&&this.compiler.addUserFunc(w.getUserFunctionSignature()),this.classes.add(w)},p)});const u=this.classes.get(n.rootClass);It(u,`${t}: Корневой имидж ${n.rootClass} существует`),l=new Ca({kernel:this,id:o,filepath:t,dir:r,rootKlass:u,state:i,settings:n})}catch(u){throw this.classes.unload(o),u}return this.projects.push(l),this.onProjectOpen.dispatch(l),l}compute(){if(this.closedProjects.forEach(s=>{re.debugProject&&console.log(`Закрывается ${s.id.description}`),this.beforeProjectClosed.dispatch(s),this.classes.unload(s.id)}),this.closedProjects.clear(),!this.projects.length)return!1;const t=this.projects[this.projects.length-1];try{t.root.compute(!1)}catch(s){throw s instanceof bs?(this.handlers.error.forEach(r=>r(s.message)),new bs(`Проект ${t.id.description}, ${s.message}`,s.original)):s}return++this.iterations,this.handlers.afterCycle.forEach(s=>s()),!0}setIterationsPerSecond(t){this.timeStep=t>0?1e3/t:0,this.lag=0}log(t,s){re.logMessage&&console.info(s?`${s.path()}: ${t}`:t)}handleExe(t,s){const r=t.lastIndexOf(".exe"),i=r<0?t:t.substring(0,r);return this.handlers.shell.forEach(n=>n(i,"","",s??0)),!0}handleShell(t,s,r,i){return this.handlers.shell.forEach(n=>n(t,s,r,i)),!0}handleWrite(t,s){this.handlers.write.forEach(r=>r(t.toString(),s)),t.startsWith(this.fs.downloadsDir)&&Zs(new Blob([s],{type:"text/plain"}),t.basename())}addPlugin(t,s){this.pluginNames.includes(t.name)||(t.deps?.forEach(r=>{if(!this.pluginNames.includes(r))throw Error(`Плагин '${t.name}' зависит от '${r}'`)}),this.pluginNames.push(t.name),t.register((r,i,n)=>{const o=this.compiler.addFunc(r,i);this.pluginFunctions[o]=n}),t.setup?.(this,s))}addOptionalPlugin(t,s){this.optionalPlugins.push({plugin:t,opts:s})}_functionNotImplemented(t,s){if(this.showed.size===this.showed.add(t.toUpperCase()).size)return;const r=`${t} не реализована`;console.warn(s?`${s.path()}: ${r}`:r)}}class Ua{constructor(t){this.kernel=t}async ready(){return await this.kernel.ready(),this}get status(){const{kernel:t}=this;return t.currentProject?t.isPaused?"paused":"playing":"closed"}play(){return this.kernel.run(),this}close(){return this.kernel.stop(),this}pause(){return this.kernel.pause(),this}continue(){return this.kernel.continue(),this}step(){return this.kernel.step(),this}addPlugin(t,s){return this.kernel.addOptionalPlugin(t,s),this}on(t,s){return this.kernel.handlers[t].add(s),this}off(t,s){const r=this.kernel.handlers[t];return s?r.delete(s):this.kernel.handlers[t].clear(),this}}const c=F.FLOAT,_=F.STRING,a=F.HANDLE,z=F.COLORREF,N=ve.FLOAT_REF,ie=ve.STRING_REF,Wa=ve.HANDLE_REF;ve.COLORREF_REF;const Va=.752812499999996,$a=1.3283520132835271,ja=Date.now(),Xe=new Date(4815162342),ti=13.204656862745098;function si(e){const t=e.file()?.base64;return t?ls(sr(t)):""}class Ha{constructor(t,s){this.key=t,this.fields=s??[]}insert(t){if(t==="FLOAT")return this.fields.push({type:t,value:0}),1;if(t==="HANDLE")return this.fields.push({type:t,value:0}),1;if(t==="STRING")return this.fields.push({type:t,value:""}),1;throw Error(`Неизвестный тип элемента: ${t}`)}insertClass(t,s){const r=s.map(i=>{const n=i[0].toUpperCase();switch(i[1]){case F.FLOAT:return[n,{type:"FLOAT",value:0}];case F.STRING:return[n,{type:"STRING",value:""}];default:return[n,{type:"HANDLE",value:0}]}});return this.fields.push({type:"STRUCT",realType:t,value:new Map(r)}),1}set(t,s,r){if(t<0||t>this.fields.length-1)return;let i=this.fields[t];if(i.type==="STRUCT"){const n=i.value.get(s.toUpperCase());if(!n)return;i=n}if(typeof r=="string"){if(i.type!=="STRING")return;i.value=r}else{if(i.type==="STRING")return;i.value=r}}remove(t){return this.fields.splice(t,1).length?1:0}count(){return this.fields.length}type(t){if(t<0||t>this.fields.length-1)return"";const s=this.fields[t];return s.type==="STRUCT"?s.realType:s.type}getFloat(t,s){if(t<0||t>this.fields.length-1)return 0;let r=this.fields[t];if(r.type==="STRUCT"){const i=r.value.get(s.toUpperCase());if(!i)return 0;r=i}return r.type==="FLOAT"?r.value:0}getHandle(t,s){if(t<0||t>this.fields.length-1)return 0;let r=this.fields[t];if(r.type==="STRUCT"){const i=r.value.get(s.toUpperCase());if(!i)return 0;r=i}return r.type==="HANDLE"?r.value:0}getString(t,s){if(t<0||t>this.fields.length-1)return"";let r=this.fields[t];if(r.type==="STRUCT"){const i=r.value.get(s.toUpperCase());if(!i)return"";r=i}return r.type==="STRING"?r.value:""}sort(t){if(!t?.length)return this.fields.sort((s,r)=>s.value-r.value),1;if(t.length===1)return t[0].desc?this.fields.sort((s,r)=>r.value-s.value):this.fields.sort((s,r)=>s.value-r.value),1;throw console.log(t),Error("VSort: сортировка по нескольким полям не реализована")}}function Xa(e,t){const s=ge.freeKey(e),r=new Ha(s,t);return e.set(s,r),r}function Ya(){return this.kernel.createArray().key}function za(e){this.kernel.arrays.delete(e)}function Ka(e){return this.kernel.arrays.get(e)?.count()??0}function qa(e,t){return this.kernel.arrays.get(e)?.type(t)??""}function Ja(e,t){const s=this.kernel.arrays.get(e);if(!s)return 0;const r=t.toUpperCase();if(r==="STRING"||r==="FLOAT"||r==="HANDLE")return s.insert(r);const i=this.kernel.classes.get(t);if(!i)return 0;const n=i.vars.list.map(o=>[o.name,o.type]);return s.insertClass(i.name,n)}function Za(e,t){return this.kernel.arrays.get(e)?.remove(t)??0}function Qa(){return this.kernel.arrays.clear(),1}function el(e,t,s){return this.kernel.arrays.get(e)?.getString(Math.floor(t),s)??""}function tl(e,t,s){return this.kernel.arrays.get(e)?.getHandle(Math.floor(t),s)??0}function sl(e,t,s){return this.kernel.arrays.get(e)?.getFloat(Math.floor(t),s)??0}function Os(e,t,s,r){this.kernel.arrays.get(e)?.set(t,s,r)}function rl(e,...t){const s=this.kernel.arrays.get(e);return s?s.sort(t.map(r=>({desc:!1,field:r}))):0}function il(e,t,...s){const r=this.kernel.arrays.get(e);if(!r)return 0;const i=!!t;return r.sort(s.map(n=>({desc:i,field:n})))}function nl(e,...t){const s=this.kernel.arrays.get(e);if(!s)return 0;const r=[];for(let i=0;i<t.length;i+=2){const n=t[i],o=!!t[i+1];r.push({desc:o,field:n})}return s.sort(r)}function ol(e){e("New",{r:a},Ya),e("Delete",{a:[a]},za),e("VGetCount",{a:[a],r:c},Ka),e("VGetType",{a:[a,c],r:_},qa),e("VInsert",{a:[a,_],r:c},Ja),e("VDelete",{a:[a,c],r:c},Za),e("VClearAll",{},Qa),e("VGetS",{a:[a,c,_],r:_},el),e("VGetH",{a:[a,c,_],r:a},tl),e("VGetF",{a:[a,c,_],r:c},sl),e("VSet",{a:[a,c,_,c]},Os),e("VSet",{a:[a,c,_,_]},Os),e("VSet",{a:[a,c,_,a]},Os),e("VSort",{a:[a],rest:[_],r:c},rl),e("VSort",{a:[a,c],rest:[_],r:c},il),e("VSort",{a:[a],rest:[_,c],r:c},nl)}const cl={name:"arrays",register:ol,setup(e){const t=new Map;e.arrays=t,e.createArray=Xa.bind(null,t)}},ri=new Set;function ue(...e){ri.size!==ri.add(e[0]).size&&console.warn(...e)}function al(e){throw ue("AudioGetBalance",e),Error("Not implemented")}function ll(e){throw ue("AudioGetLength",e),Error("Not implemented")}function hl(e){throw ue("AudioGetPosition",e),Error("Not implemented")}function ul(e){throw ue("AudioGetRepeat",e),Error("Not implemented")}function dl(e){throw ue("AudioGetTone",e),Error("Not implemented")}function fl(e){throw ue("AudioGetVolume",e),Error("Not implemented")}function gl(e){const t=this.kernel.audios.get(e);return t&&!t.paused?1:0}function pl(e){throw ue("AudioIsSeekable",e),Error("Not implemented")}function _l(e){const t=this.prj.dir.resolve(e).file()?.audio;if(!t)return 0;const s=new Audio(We(t.src)),r=ge.freeKey(this.kernel.audios);return this.kernel.audios.set(r,s),r}function El(e){this.kernel.audios.get(e)?.play()}function ml(e){ue("AudioReset",e)}function wl(e,t){ue("AudioSetBalance",e,t)}function Tl(e,t){ue("AudioSetPosition",e,t)}function yl(e,t){ue("AudioSetRepeat",e,t)}function bl(e,t){ue("AudioSetTone",e,t)}function Ol(e,t){ue("AudioSetVolume",e,t)}function Rl(e){this.kernel.audios.get(e)?.pause()}function Ml(e){e("AudioGetBalance",{a:[a],r:c},al),e("AudioGetLength",{a:[a],r:c},ll),e("AudioGetPosition",{a:[a],r:c},hl),e("AudioGetRepeat",{a:[a],r:c},ul),e("AudioGetTone",{a:[a],r:c},dl),e("AudioGetVolume",{a:[a],r:c},fl),e("AudioIsPlaying",{a:[a],r:c},gl),e("AudioIsSeekable",{a:[a],r:c},pl),e("AudioOpenSound",{a:[_],r:a},_l),e("AudioPlay",{a:[a]},El),e("AudioReset",{a:[a]},ml),e("AudioSetBalance",{a:[a,c]},wl),e("AudioSetPosition",{a:[a,c]},Tl),e("AudioSetRepeat",{a:[a,c]},yl),e("AudioSetTone",{a:[a,c]},bl),e("AudioSetVolume",{a:[a,c]},Ol),e("AudioStop",{a:[a]},Rl)}const vl={name:"audio",register:Ml,setup(e){e.audios=new Map}};function Sl(e){return this.resolve(e)?.klass.name??""}function ii(...e){throw console.warn("createLink",...e),Error("Not implemented")}function Al(...e){throw console.warn("createObject",...e),Error("Not implemented")}function Nl(){throw Error("Not implemented")}function Il(...e){throw console.warn("setLinkVars",...e),Error("Not implemented")}function xl(e){return this.kernel.classes.get(e)?.children.length??0}function Pl(){return this.ndata?.key??0}function Ll(e){return this.resolve(e)?.ndata?.key??0}function Dl(e,t){if(t<0)return 0;const s=this.kernel.classes.get(e)?.children;return s&&t<s.length?s[t].key:0}function kl(e,t){return this.kernel.classes.get(e)?.children.find(s=>s.key===t)?.klass??""}function Cl(e,t,s){return this.kernel.classes.get(e)?.connections.find(({nodes:[r,i]})=>r===t&&i===s||r===s&&i===t)?.key??0}function Gl(e,t){const s=this.kernel.classes.get(e)?.modelText;if(!s)return 0;const r=this.kernel.streams.get(t);if(!r)return 0;const i=rr(s);return r.write(i),i.length}function ni(e,t){const s=this.kernel.classes.get(e);if(!s)return 0;const r=this.kernel.streams.get(t)?.bytes();if(!r)return 0;const i=ls(r),n=s.modelText;s.set({modelText:i});try{s.compile()}catch(o){if(!(o instanceof Error))throw o;return console.warn(o.message),s.set({modelText:n}),0}return 1}function Fl(e,t){const s=this.resolve(e);if(!s)return"";const r=s.klass.vars.get(t);return r?s.getVarValueS(r)??"":""}function Rs(e,t){const s=this.resolve(e);if(!s)return 0;const r=s.klass.vars.get(t);return r?s.getVarValueFHC(r)??0:0}function Ut(e,t,s){const r=this.resolve(e);if(!r)return;const i=r.klass.vars.get(t);i&&r.vars.setValue(i,s)}function oi(e,t,s,r,i,n,o,l,u,d,p,E){const w=this.kernel.classes.get(e)?.vars.list;if(t<0||!w||t>=w.length)return s[r]="",i[n]="",o[l]="",u[d]="",p&&(p[E]=0),0;const T=w[t];return s[r]=T.name,i[n]=F[T.type],o[l]=T.defaultValue??"",u[d]=T.description??"",p&&(p[E]=T.attrib),1}function Bl(e){return this.kernel.classes.get(e)?.vars.list.length??0}function Ul(e,t,s){const r=this.kernel.classes.get(e);if(!r)return 0;const i=r.children.findIndex(o=>o.key===t);if(i<0)return 0;const n=r.children.slice();return n[i]={...n[i],name:s},r.set({children:n}),1}function Wl(e,t){return this.kernel.classes.get(e)?.children.find(s=>s.key===t)?.name??""}function Vl(e,t){const s=this.resolve(e);if(!s)return 0;const r=this.prj.dir.resolve(t).file();if(!r)return 0;const i=s.getValues();return r.set({stt:i}),1}function $l(e,t){const s=this.resolve(e);if(!s)return 0;const r=this.prj.dir.resolve(t).file()?.stt;return r?(s.applyValues(r),1):0}function jl(e){return this.resolve(e)?.initValues(!0)?1:0}function Hl(){this.kernel._functionNotImplemented("Stop",this)}function Xl(e){e<=0||this.kernel.closeAll()}function Yl(){this.prj.close()}function zl(e){e("GetClassName",{a:[_],r:_},Sl),e("CreateLink",{a:[_,a,a],r:a},ii),e("CreateLink",{a:[_,_,_],r:a},ii),e("CreateObject",{a:[_,_,_,c,c],r:a},Al),e("DeleteObject",{a:[_,a,c],r:c},Nl),e("SetLinkVars",{a:[_,a,_],r:c},Il),e("GetObjectCount",{a:[_],r:c},xl),e("GetHObject",{r:a},Pl),e("GetHObjectByName",{a:[_],r:a},Ll),e("GetHObjectByNum",{a:[_,c],r:a},Dl),e("GetObjectClass",{a:[_,a],r:_},kl),e("GetLink",{a:[_,a,a],r:a},Cl),e("GetModelText",{a:[_,a],r:c},Gl),e("SetModelText",{a:[_,a],r:c},ni),e("SetModelText",{a:[_,a,c],r:c},ni),e("GetVarS",{a:[_,_],r:_},Fl),e("GetVarF",{a:[_,_],r:c},Rs),e("GetVarH",{a:[_,_],r:a},Rs),e("GetVarC",{a:[_,_],r:z},Rs),e("SetVar",{a:[_,_,c]},Ut),e("SetVar",{a:[_,_,_]},Ut),e("SetVar",{a:[_,_,a]},Ut),e("SetVar",{a:[_,_,z]},Ut),e("GetVarInfo",{a:[_,c,ie,ie,ie,ie],r:c},oi),e("GetVarInfo",{a:[_,c,ie,ie,ie,ie,N],r:c},oi),e("GetVarCount",{a:[_],r:c},Bl),e("SetObjectName",{a:[_,a,_],r:c},Ul),e("GetNameByHandle",{a:[_,a],r:_},Wl),e("SaveObjectState",{a:[_,_],r:c},Vl),e("LoadObjectState",{a:[_,_],r:c},$l),e("SetVarsToDefault",{a:[_],r:c},jl),e("Stop",{a:[c]},Hl),e("Quit",{a:[c]},Xl),e("CloseAll",{},Yl)}const Kl={name:"class",deps:["streams"],register:zl};function ql(e,t,s,r,i,n,o,l){let u;switch(t.toUpperCase()){case"EDIT":u="Edit";break;case"BUTTON":u="Button";break;case"COMBOBOX":u="ComboBox";break;case"LISTBOX":u="ListBox";break;default:return 0}const d=this.kernel.scenes.get(e);if(!d)return 0;const p=d.scene;let E=i,w=n;const T=d.matrix;if(T){const A=i*T[2]+n*T[5]+T[8];E=(i*T[0]+n*T[3]+T[6])/A,w=(i*T[1]+n*T[4]+T[7])/A}const R=p.input(u,{x:E,y:w,width:o,height:l,value:s,style:r});return p.set({order:p.order.concat(R)}),R.key}function ci(e,t,s,r){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(i?.type!=="input")return"";const{value:n}=i;return typeof s>"u"?n:n.slice(s,s+r)}function Jl(e,t,s){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="input"&&r.set({value:s})?1:0}function Zl(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);return i?.type==="input"&&i.set({font:r.fonts.get(s)??null})?1:0}function Ql(){return this.kernel._functionNotImplemented("EnableControl2d"),0}function eh(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return;const r=s.objects.get(t);r?.type==="input"&&r.focus()}function th(){return this.kernel._functionNotImplemented("IsDlgButtonChecked"),0}function sh(){return this.kernel._functionNotImplemented("CheckDlgButton2d"),1}function rh(e){e("CreateControlObject2d",{a:[a,_,_,c,c,c,c,c,c],r:a},ql),e("GetControlText2d",{a:[a,a],r:_},ci),e("GetControlText2d",{a:[a,a,c,c],r:_},ci),e("SetControlText2d",{a:[a,a,_],r:c},Jl),e("SetControlFont2d",{a:[a,a,a],r:c},Zl),e("EnableControl2d",{a:[a,a,c],r:c},Ql),e("SetControlFocus2d",{a:[a,a]},eh),e("IsDlgButtonChecked2d",{a:[a,a],r:c},th),e("CheckDlgButton2d",{a:[a,a,c],r:c},sh)}const ih={name:"controls",deps:["windows"],register:rh},nh={dialog:"_8OpWP1FD"};class oh{constructor(){this.onClose=new Ee;const t=this.domElement=document.createElement("dialog");t.className=nh.dialog,t.innerHTML=`
<form method="dialog">
  <p><input type="file"></p>

  <menu>
    <button value="ok" disabled>Подтвердить выбор</button>
    <button value="cancel">Отмена</button>
  </menu>
</form>
    `;const s=t.querySelector('input[type="file"]'),r=t.querySelector('button[value="ok"]');s.addEventListener("change",()=>{r.disabled=!s.files?.length}),t.addEventListener("close",()=>{const i=t.returnValue==="ok"&&s.files?.item(0);this.onClose.dispatch(i||null)})}open(){this.domElement.showModal()}}let ch=0;function ah(e,t,s){const{fileDialogState:r}=this.kernel;if(r.type==="closed")return this.kernel.fileDialogState={type:"willOpen"},"";if(r.type==="fileSelected"){const{result:i}=r;if(this.kernel.fileDialogState={type:"closed"},!i)return"";const n=this.kernel.fs.uploadsDir.resolve("file"+ ++ch);return n.create("file",i.content),n.toString()}if(re.throwIfFileLoadDialogCalledTwice)throw Error("FileLoadDialog был ранее вызван в текущем цикле");return console.warn("FileLoadDialog был ранее вызван в текущем цикле"),""}function lh(e,t,s){return this.kernel.fs.downloadsDir.resolve(s||"data.txt").toString()}function hh(e,t,s){switch(s){case s&P.MB_OK:return alert(e),1;case s&P.MB_OKCANCEL:return confirm(e)?1:2;case s&P.MB_YESNO:return confirm(e)?6:7;default:return 0}}function uh(e,t){return this.kernel._functionNotImplemented("DialogBox"),1}function dh(e,t,s){throw Error("ChoseFolderDialog: Not implemented")}function fh(e){e("ChoseFolderDialog",{a:[_,_,c],r:_},dh),e("DialogBox",{a:[_,a],r:1},uh),e("FileLoadDialog",{a:[_,_,_],r:_},ah),e("FileSaveDialog",{a:[_,_,_],r:_},lh),e("MessageBox",{a:[_,_,c],r:c},hh)}const gh={name:"dialogs",deps:["windows"],register:fh,setup(e){e.fileDialogState={type:"closed"},e.afterCompute.add(()=>{if(e.fileDialogState.type!=="willOpen")return;e.fileDialogState={type:"open"},e.pause(),e.enableUiEvents(!1);const t=new oh;t.onClose.add(async s=>{let r=null;try{if(s)if(s.type.startsWith("image/")){const i=URL.createObjectURL(s),n=await Qs(i),{naturalWidth:o,naturalHeight:l}=n;r={image:{width:o,height:l,src:i}}}else{const i=await s.arrayBuffer();r={base64:tr(new Uint8Array(i))}}}catch(i){console.warn(i.message)}e.fileDialogState={type:"fileSelected",result:s&&r&&{file:s,content:r}},t.domElement.remove(),e.enableUiEvents(!0),e.continue()}),e.windowSystem.windowFactory.root.ownerDocument.body.append(t.domElement),t.open()})}};function ph(e){return this.prj.dir.resolve(e).create("folder")?1:0}function _h(e){const t=this.prj.dir.resolve(e);return t.fileExist()||this.kernel.hasProject(t)?1:0}function Eh(e){const t=this.kernel.classes.get(e);return t?t.file.path.resolve("..").toString()+"\\":""}function mh(){return this.prj.dir.toString()}function wh(){return"C:\\Windows"}function Th(e){const t=this.prj.dir.resolve(e).resolveMany();if(!t.length)return 0;const s=t.map(r=>{const i=[["NAME",{type:"STRING",value:r.name}],["SIZE",{type:"FLOAT",value:r.size}],["ATTR",{type:"FLOAT",value:0}],["YEAR",{type:"FLOAT",value:Xe.getFullYear()}],["MONTH",{type:"FLOAT",value:Xe.getMonth()+1}],["DAY",{type:"FLOAT",value:Xe.getDate()}],["DAYOFWEEK",{type:"FLOAT",value:Xe.getDay()}],["HOUR",{type:"FLOAT",value:Xe.getHours()}],["MINUTE",{type:"FLOAT",value:Xe.getMinutes()}],["SECOND",{type:"FLOAT",value:Xe.getSeconds()}]];return{type:"STRUCT",realType:"FILE_ATTRIBUTE",value:new Map(i)}});return this.kernel.createArray(s).key}function yh(e){return e.length===0||e[e.length-1]==="\\"?e:e+"\\"}function bh(e){e("CreateDir",{a:[_],r:c},ph),e("FileExist",{a:[_],r:c},_h),e("GetClassDirectory",{a:[_],r:_},Eh),e("GetProjectDirectory",{r:_},mh),e("GetWindowsDirectory",{r:_},wh),e("GetFileList",{a:[_,c],r:a},Th),e("AddSlash",{a:[_],r:_},yh)}const Oh={name:"filesystem",deps:["arrays"],register:bh};function Rh(e){const t=this.kernel.scenes.get(e);return t?t.scene.x:0}function Mh(e){const t=this.kernel.scenes.get(e);return t?t.scene.y:0}function vh(e,t,s){const r=this.kernel.scenes.get(e);return r?(r.setSceneOrg(t,s),1):0}function Sh(e){return this.kernel.scenes.get(e)?.scale??0}function Ah(e,t){const s=this.kernel.scenes.get(e);return s?(s.setScale(t),1):0}function Nh(e,t,s,r,i,n,o){const l=this.kernel.scenes.get(e)?.scene.toBlob({x:r,y:i,w:n,h:o});if(!l)return 0;const u=t.match(/(?:.*[\\/])?(.+?)(\..*)?$/),d=u&&u.length>1?u[1]:"Screenshot";return l.then(p=>Zs(p,d)),1}function Ih(e){return this.kernel.scenes.get(e)?.scene.background?.key??0}function xh(e,t){const s=this.kernel.scenes.get(e)?.scene;return s?.set({background:s.brushes.get(t)??null})?1:0}function Ph(){return 0}function Lh(e){return this.kernel.scenes.get(e)?.scene.hiddenLayers??0}function Dh(e,t){return this.kernel.scenes.get(e)?.scene.set({hiddenLayers:t})?1:0}function kh(){return 1}function Ch(e,t,s,r,i){return this.kernel.scenes.get(e)?.scene.pen({color:r,rop:i,style:t,width:s}).key??0}function Gh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.color??0}function Fh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.rop??0}function Bh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.style??0}function Uh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.width??0}function Wh(e,t,s){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({color:s})?1:0}function Vh(e,t,s){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({rop:s})?1:0}function $h(e,t,s){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({style:s})?1:0}function jh(e,t,s){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({width:s})?1:0}function Hh(e,t,s,r,i,n){const o=this.kernel.scenes.get(e)?.scene;return o?.brush({color:r,hatch:s,rop:n,style:t,image:o.imagesOpaque.get(i)}).key??0}function Xh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.color??0}function Yh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.rop??0}function zh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.style??0}function Kh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.hatch??0}function qh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.image?.key??0}function Jh(e,t,s){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({color:s})?1:0}function Zh(e,t,s){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({rop:s})?1:0}function Qh(e,t,s){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({style:s})?1:0}function eu(e,t,s){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({hatch:s})?1:0}function tu(e,t,s){const r=this.kernel.scenes.get(e)?.scene;return r?.brushes.get(t)?.set({image:r.imagesOpaque.get(s)??null})?1:0}function ai({kernel:e},t,s,r,i){return e.scenes.get(t)?.scene.font({name:s,size:r,style:i}).key??0}function su(e,t,s,r){return ai(this,e,t,s,r)}function ru(e,t,s,r){return ai(this,e,t,s*$a,r)}function iu(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.name??""}function nu(e,t){return(this.kernel.scenes.get(e)?.scene.fonts.get(t)?.size??0)*Va}function ou(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.style??0}function cu(e,t,s){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({name:s})?1:0}function au(e,t,s){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({size:s})?1:0}function lu(e,t,s){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({style:s})?1:0}function hu(e,t){return this.kernel.scenes.get(e)?.scene.string(t).key??0}function uu(e,t){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.text??""}function du(e,t,s){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.set({text:s})?1:0}function fu(e,t,s,r,i){const n=this.kernel.scenes.get(e)?.scene;if(!n)return 0;const o=n.strings.get(s);if(!o)return 0;const l=n.fonts.get(t);return l?n.text([{string:o,font:l,fgcolor:r,bgcolor:i}]).key:0}function gu(e,t){return this.kernel.scenes.get(e)?.scene.texts.get(t)?.parts.length??0}function et({kernel:e},t,s,r){if(r<0)return null;const i=e.scenes.get(t)?.scene.texts.get(s)?.parts;return i&&r<i.length?i[r]:null}function li(e,t,s=0){return et(this,e,t,s)?.font.key??0}function hi(e,t,s=0){return et(this,e,t,s)?.string.key??0}function ui(e,t,s=0){return et(this,e,t,s)?.fgcolor??0}function di(e,t,s=0){return et(this,e,t,s)?.bgcolor??0}function fi(e,t,s,r,i,n,o){if(s<0)return 0;const l=this.kernel.scenes.get(e)?.scene;if(!l)return 0;const u=l.texts.get(t)?.parts;return!u||s>=u.length?0:(u[s].set({string:l.strings.get(i),font:l.fonts.get(r),fgcolor:n,bgcolor:o}),1)}function pu(e,t,s,r,i,n){return fi.call(this,e,t,0,s,r,i,n)}function _u(e,t,s,r){if(s<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||s>=n.length)return 0;const o=i.fonts.get(r);return o?(n[s].set({font:o}),1):0}function Eu(e,t,s,r){if(s<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||s>=n.length)return 0;const o=i.strings.get(r);return o?(n[s].set({string:o}),1):0}function mu(e,t,s,r){return et(this,e,t,s)?.set({fgcolor:r})?1:0}function wu(e,t,s,r){return et(this,e,t,s)?.set({bgcolor:r})?1:0}function gi(e,t,s,r,i,n,o){if(s<0)return 0;const l=this.kernel.scenes.get(e)?.scene;if(!l)return 0;const u=l.texts.get(t);if(!u)return 0;const d=l.fonts.get(r);if(!d)return 0;const p=l.strings.get(i);if(!p)return 0;const E=s<u.parts.length,w=u.createPart({font:d,string:p,fgcolor:n,bgcolor:o},E);if(E){const T=u.parts.slice();T.splice(s,0,w),u.set({parts:T})}return 1}function Tu(e,t,s,r,i,n){return gi.call(this,e,t,1/0,s,r,i,n)}function yu(e,t,s){if(s<0)return 0;const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.texts.get(t);if(!i||s>=i.parts.length)return 0;const n=i.parts.slice();return n.splice(s,1),i.set({parts:n},!0),1}function pi({kernel:e},{prj:t},s,r,i){const n=e.scenes.get(s)?.scene;if(!n)return 0;const o=t.dir.resolve(r),l=o.file();return l?l.image?n.image(l.image,{opaque:i}).key:(re.debugFile&&console.warn(`create(Double)DIB2d: Файл ${o} существует, но формат не image.`),0):0}function bu(e,t){return pi(this,this,e,t,!0)}function Ou(e,t){return pi(this,this,e,t)}function Ru(e,t,s,r){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.getPixel(s,r)??0}function Mu(e,t,s,r,i){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.setPixel(s,r,i)?1:0}function vu(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let i;switch(t){case P.PEN2D:i=r.pens;break;case P.BRUSH2D:i=r.brushes;break;case P.DOUBLEDIB2D:i=r.images;break;case P.DIB2D:i=r.imagesOpaque;break;case P.STRING2D:i=r.strings;break;case P.FONT2D:i=r.fonts;break;case P.TEXT2D:i=r.texts;break;case P.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(s)?.delete(!0)?1:0}function Su(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let i;switch(t){case P.PEN2D:i=r.pens;break;case P.BRUSH2D:i=r.brushes;break;case P.DOUBLEDIB2D:i=r.images;break;case P.DIB2D:i=r.imagesOpaque;break;case P.STRING2D:i=r.strings;break;case P.FONT2D:i=r.fonts;break;case P.TEXT2D:i=r.texts;break;case P.SPACE3D:throw Error("Не реализовано");default:return 0}let n=1/0;for(const o of i.keys())o>s&&o<n&&(n=o);return n===1/0?0:n}function Au(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let i;switch(t){case P.PEN2D:i=r.pens;break;case P.BRUSH2D:i=r.brushes;break;case P.DOUBLEDIB2D:i=r.images;break;case P.DIB2D:i=r.imagesOpaque;break;case P.STRING2D:i=r.strings;break;case P.FONT2D:i=r.fonts;break;case P.TEXT2D:i=r.texts;break;case P.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(s)?.subs.size??0}function Nu(e,t,s){return us(e,t,s)}function Iu(e,t,s,r){return us(e,t,s,r===1?"transparent":r===2?"syscolor":"rgb")}function xu(e){return e&4294967295}function Pu(e){return ur(e)}function Lu(e){return dr(e)}function Du(e){return fr(e)}function ku(e,t,s,r,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const o=this.prj.dir.resolve(t).file()?.scene?.data;return o?n.paste(o,s,r,i)?.key??0:0}function Cu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.delete(!0)?1:0}function Gu(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!s)return 0;switch(s.type){case"group":return P.OTGROUP2D;case"line":return P.OTLINE_2D;case"imageView":return s.opaque?P.OTBITMAP_2D:P.OTDOUBLEBITMAP_2D;case"textView":return P.OTTEXT_2D;case"videoView":return 0;case"input":return 26}}function Fu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.data?.name??""}function Bu(e,t,s){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?(r.data.name=s,1):0}function Uu(e,t,s){if(!s)return 0;const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let i;if(t){const n=r.objects.get(t);if(!n)return 0;if(n.data?.name===s)return n.key;if(n.type!=="group")return 0;i=n.descendants()}else i=r.objects.values();for(const n of i)if(n.data?.name===s)return n.key;return 0}function Wu(e,t){const s=this.kernel.scenes.get(e);if(!s)return 0;const r=s.scene.objects.get(t);if(!r)return 0;const i=s.invmatrix;if(!i)return r.x;const n=r.x,o=r.y,l=n*i[2]+o*i[5]+i[8];return(n*i[0]+o*i[3]+i[6])/l}function Vu(e,t){const s=this.kernel.scenes.get(e);if(!s)return 0;const r=s.scene.objects.get(t);if(!r)return 0;const i=s.invmatrix;if(!i)return r.y;const n=r.x,o=r.y,l=n*i[2]+o*i[5]+i[8];return(n*i[1]+o*i[4]+i[7])/l}function $u(e,t,s,r){const i=this.kernel.scenes.get(e);if(!i)return 0;const n=i.scene.objects.get(t);if(!n)return 0;let o=s,l=r;const u=i.matrix;if(u){const d=s*u[2]+r*u[5]+u[8];o=(s*u[0]+r*u[3]+u[6])/d,l=(s*u[1]+r*u[4]+u[7])/d}return n.set({x:o,y:l}),1}function ju(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.width??0}function Hu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.height??0}function Xu(e,t,s,r){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.set({width:s,height:r})?1:0}function Yu(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!s)return 0;switch(s.type){case"group":case"line":case"input":return s.width;case"imageView":return s.image.width;case"textView":return s.text.width;case"videoView":return s.video.width}}function zu(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!s)return 0;switch(s.type){case"group":case"line":case"input":return s.height;case"imageView":return s.image.height;case"textView":return s.text.height;case"videoView":return s.video.height}}function Ku(e,t,s,r,i,n){const o=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!o)return s[r]=0,i[n]=0,0;switch(o.type){case"group":case"line":case"input":return s[r]=o.width,i[n]=o.height,1;case"imageView":return s[r]=o.image.width,i[n]=o.image.height,1;case"textView":return s[r]=o.text.width,i[n]=o.text.height,1;case"videoView":return s[r]=o.video.width,i[n]=o.video.height,1}}function qu(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s&&(s.type==="textView"||s.type==="imageView")?s.angle:0}function Ju(e,t,s,r,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const o=n.scene.objects.get(t);if(!o)return 0;let l=s,u=r;const d=n.matrix;if(d){const p=s*d[2]+r*d[5]+d[8];l=(s*d[0]+r*d[3]+d[6])/p,u=(s*d[1]+r*d[4]+d[7])/p}return o.rotate(i,{x:l,y:u}),1}function Ms({kernel:e},t,s,r){const i=e.scenes.get(t)?.scene.objects.get(s);if(!i)return 0;const n=r?i.attrib&-2:i.attrib|1;return i.set({attrib:n}),1}function Zu(e,t,s){return Ms(this,e,t,!!s)}function Qu(e,t){Ms(this,e,t,!0)}function ed(e,t){Ms(this,e,t,!1)}function td(e,t,s){return this.kernel.scenes.get(e)?.pick(t,s,!0)?.key??0}function sd(){return this.kernel.windowSystem.lastPickedPrimaryKey}function rd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?(this.kernel.windowSystem.clipboard=ba(s),1):0}function id(e,t,s,r){const i=this.kernel.windowSystem.clipboard;return i?this.kernel.scenes.get(e)?.paste(i,t,s,r)?.key??0:0}function nd(e,t,s){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;let i=r.attrib;switch(s){case 0:i&=-13;break;case 1:i&=~ds,i|=fs;break;case 2:i&=~fs,i|=ds;break;default:return 0}return r.set({attrib:i}),1}function od(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.attrib??0}function cd(e,t,s,r){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!i)return 0;let{attrib:n}=i;switch(r){case P.ATTRSET:n|=s;break;case P.ATTRRESET:n&=~s;break;case P.ATTRPUT:n=s;break;default:return 0}return i.set({attrib:n}),1}function ad(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let r=1/0;for(const i of s.objects.keys())i>t&&i<r&&(r=i);return r===1/0?0:r}function ld(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);if(!i)return 0;const n=r.objects.get(s);return n&&i.x+i.width>=n.x&&n.x+n.width>=i.x&&i.y+i.height>=n.y&&n.y+n.height>=i.y?1:0}function hd(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[0].key:0}function ud(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[t.length-1].key:0}function dd(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const r=s.objects.get(t);if(!r||r.type==="group")return 0;const i=s.order,n=i.indexOf(r);return n<1?0:i[n-1].key}function fd(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const r=s.objects.get(t);if(!r||r.type==="group")return 0;const i=s.order,n=i.indexOf(r);return n>-1&&n<i.length-1?i[n+1].key:0}function gd(e,t){const s=t-1;if(s<0)return 0;const r=this.kernel.scenes.get(e)?.scene.order;return r&&s<r.length?r[s].key:0}function pd(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const r=s.objects.get(t);if(!r||r.type==="group")return 0;const n=s.order.indexOf(r);return n<0?0:n+1}function _d(e,t,s){const r=s-1;if(r<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.objects.get(t);if(!n||n.type==="group")return 0;const o=i.order,l=[];for(let u=0;u<o.length;++u){const d=o[u];d!==n&&l.push(d),r===u&&l.push(n)}return r>=o.length&&l.push(n),i.set({order:l}),1}function Ed(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const r=s.objects.get(t);if(!r||r.type==="group")return 0;const i=s.order.filter(n=>n!==r);return i.unshift(r),s.set({order:i}),1}function md(e,t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const r=s.objects.get(t);if(!r||r.type==="group")return 0;const i=s.order.filter(n=>n!==r);return i.push(r),s.set({order:i}),1}function wd(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);if(!i||i.type==="group")return 0;const n=r.objects.get(s);if(!n||n.type==="group")return 0;const o=r.order.slice(),l=o.indexOf(i);if(l<0)return 0;const u=o.indexOf(n);if(u<0)return 0;const d=o[l];return o[l]=o[u],o[u]=d,r.set({order:o}),1}function _i({kernel:e},t,s,r,i){const n=e.scenes.get(t);if(!n)return 0;const{matrix:o,scene:l}=n;if(o)for(let d=0;d<i.length;d+=2){const p=i[d+0],E=i[d+1],w=p*o[2]+E*o[5]+o[8];i[d+0]=(p*o[0]+E*o[3]+o[6])/w,i[d+1]=(p*o[1]+E*o[4]+o[7])/w}const u=l.line(i,{pen:l.pens.get(s),brush:l.brushes.get(r)});return l.set({order:l.order.concat(u)}),u.key}function Td(e,t,s,...r){return _i(this,e,t,s,r)}function yd(e,t,s,r,i){return _i(this,e,t,s,[r,i])}function bd(e,t,s,r,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const o=n.scene.objects.get(t);if(o?.type!=="line")return 0;let l=r,u=i;const d=n.matrix;if(d){const p=r*d[2]+i*d[5]+d[8];l=(r*d[0]+i*d[3]+d[6])/p,u=(r*d[1]+i*d[4]+d[7])/p}return o.addPoint({x:l,y:u},s)?1:0}function Od(e,t,s,r,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const o=n.scene.objects.get(t);if(o?.type!=="line")return 0;let l=r,u=i;const d=n.matrix;if(d){const p=r*d[2]+i*d[5]+d[8];l=(r*d[0]+i*d[3]+d[6])/p,u=(r*d[1]+i*d[4]+d[7])/p}return o.setPoint(s,{x:l,y:u})?1:0}function Rd(e,t,s){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"&&r.removePoint(s)?1:0}function Md(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="line"&&s.pen?.key||0}function vd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="line"&&s.brush?.key||0}function Sd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="line"?s.length:0}function Ad(e,t,s){const r=this.kernel.scenes.get(e);if(!r)return 0;const i=r.scene.objects.get(t),n=i?.type==="line"&&i.point(s);if(!n)return 0;const{x:o,y:l}=n,u=r.invmatrix;if(!u)return o;const d=o*u[2]+l*u[5]+u[8];return(o*u[0]+l*u[3]+u[6])/d}function Nd(e,t,s){const r=this.kernel.scenes.get(e);if(!r)return 0;const i=r.scene.objects.get(t),n=i?.type==="line"&&i.point(s);if(!n)return 0;const{x:o,y:l}=n,u=r.invmatrix;if(!u)return l;const d=o*u[2]+l*u[5]+u[8];return(o*u[1]+l*u[4]+u[7])/d}function Id(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);return i?.type==="line"&&i.set({brush:r.brushes.get(s)??null})?1:0}function xd(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);return i?.type==="line"&&i.set({pen:r.pens.get(s)??null})?1:0}function Pd(e,t,s,r,i,n,o,l){const u=this.kernel.scenes.get(e)?.scene.objects.get(t);if(u?.type!=="line")return 0;const d={angle:s,length:r,fill:!!i},p={angle:n,length:o,fill:!!l};return u.set({start:d,end:p}),1}function Ld(e,...t){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let r=!0;const i=t.map(n=>{const o=s.objects.get(n);return(!o||o.parent)&&(r=!1),o});return r?s.group(i).key:0}function Dd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type!=="group"?0:(s.set({children:[]}).delete(),1)}function kd(e,t,s){if(t===s)return 0;const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);if(i?.type!=="group")return 0;const n=r.objects.get(s);if(!n||n.parent)return 0;if(n.type==="group"){let o=i;for(;o=o.parent;)if(o===n)return 0}return i.set({children:i.children.concat(n)}),1}function Cd(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);if(i?.type!=="group")return 0;const n=r.objects.get(s);return n?.parent!==i?0:(i.set({children:i.children.filter(o=>o!==n)}),1)}function Gd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="group"?s.children.length:0}function Fd(e,t,s){if(s<0)return 0;const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(r?.type!=="group")return 0;const i=r.children;return s<i.length?i[s].key:0}function Bd(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.parent?.key??0}function Ud(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.objects.get(t);if(i?.type!=="group")return 0;for(let n=0;n<i.children.length;++n){const o=i.children[n];if(o.key===s)return n+1;if(o.type==="group"){for(const l of o.descendants())if(l.key===s)return n+1}}return 0}function Ei({kernel:e},t,s,r,i,n){const o=e.scenes.get(t);if(!o)return 0;const l=o.scene,u=(n?l.imagesOpaque:l.images).get(s);if(!u)return 0;let d=r,p=i;const E=o.matrix;if(E){const T=r*E[2]+i*E[5]+E[8];d=(r*E[0]+i*E[3]+E[6])/T,p=(r*E[1]+i*E[4]+E[7])/T}const w=l.imageView(u,{x:d,y:p,opaque:n});return l.set({order:l.order.concat(w)}),w.key}function Wd(e,t,s,r){return Ei(this,e,t,s,r,!0)}function Vd(e,t,s,r){return Ei(this,e,t,s,r)}function $d(e,t,s,r,i,n,o,l,u,d){const p=this.kernel.scenes.get(e)?.scene.objects.get(t);if(p?.type!=="imageView")return s[r]=0,i[n]=0,o[l]=0,u[d]=0,0;const E=p.area;return s[r]=E?.x??0,i[n]=E?.y??0,o[l]=E?.w??p.image.width,u[d]=E?.h??p.image.height,1}function jd(e,t,s,r,i,n){const o=this.kernel.scenes.get(e)?.scene.objects.get(t);return o?.type==="imageView"&&o.set({area:{x:s,y:r,w:i,h:n}})?1:0}function Hd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="imageView"&&s.opaque&&s.image.key||0}function Xd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="imageView"&&!s.opaque&&s.image.key||0}function Yd(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.imagesOpaque.get(s);if(!i)return 0;const n=r.objects.get(t);return n?.type==="imageView"&&n.opaque&&n.set({image:i})?1:0}function zd(e,t,s){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const i=r.images.get(s);if(!i)return 0;const n=r.objects.get(t);return n?.type==="imageView"&&!n.opaque&&n.set({image:i})?1:0}function Kd(e,t,s,r,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const o=n.scene,l=o.texts.get(t);if(!l)return 0;let u=s,d=r;const p=n.matrix;if(p){const w=s*p[2]+r*p[5]+p[8];u=(s*p[0]+r*p[3]+p[6])/w,d=(s*p[1]+r*p[4]+p[7])/w}const E=o.textView(l,{x:u,y:d,angle:i});return o.set({order:o.order.concat(E)}),E.key}function qd(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="textView"&&s.text.key||0}function Jd(e){e("GetSpaceOrg2dx",{a:[a],r:c},Rh),e("GetSpaceOrg2dy",{a:[a],r:c},Mh),e("SetSpaceOrg2d",{a:[a,c,c],r:c},vh),e("GetScaleSpace2d",{a:[a],r:c},Sh),e("SetScaleSpace2d",{a:[a,c],r:c},Ah),e("SaveRectArea2d",{a:[a,_,c,c,c,c,c],r:c},Nh),e("GetBkBrush2d",{a:[a],r:a},Ih),e("SetBkBrush2d",{a:[a,a],r:c},xh),e("LockSpace2d",{a:[a,c],r:c},Ph),e("GetSpaceLayers2d",{a:[a],r:c},Lh),e("SetSpaceLayers2d",{a:[a,c],r:c},Dh),e("SetSpaceRenderEngine2d",{a:[a,c],r:c},kh),e("CreatePen2d",{a:[a,c,c,z,c],r:a},Ch),e("GetPenColor2d",{a:[a,a],r:z},Gh),e("GetPenRop2d",{a:[a,a],r:c},Fh),e("GetPenStyle2d",{a:[a,a],r:c},Bh),e("GetPenWidth2d",{a:[a,a],r:c},Uh),e("SetPenColor2d",{a:[a,a,z],r:c},Wh),e("SetPenRop2d",{a:[a,a,c],r:c},Vh),e("SetPenStyle2d",{a:[a,a,c],r:c},$h),e("SetPenWidth2d",{a:[a,a,c],r:c},jh),e("CreateBrush2d",{a:[a,c,c,z,a,c],r:a},Hh),e("GetBrushColor2d",{a:[a,a],r:z},Xh),e("GetBrushRop2d",{a:[a,a],r:c},Yh),e("GetBrushStyle2d",{a:[a,a],r:c},zh),e("GetBrushHatch2d",{a:[a,a],r:c},Kh),e("GetBrushDib2d",{a:[a,a],r:a},qh),e("SetBrushColor2d",{a:[a,a,z],r:c},Jh),e("SetBrushRop2d",{a:[a,a,c],r:c},Zh),e("SetBrushStyle2d",{a:[a,a,c],r:c},Qh),e("SetBrushHatch2d",{a:[a,a,c],r:c},eu),e("SetBrushDib2d",{a:[a,a,a],r:c},tu),e("CreateFont2d",{a:[a,_,c,c],r:a},su),e("CreateFont2dpt",{a:[a,_,c,c],r:a},ru),e("GetFontName2d",{a:[a,a],r:_},iu),e("GetFontSize2d",{a:[a,a],r:c},nu),e("GetFontStyle2d",{a:[a,a],r:c},ou),e("SetFontName2d",{a:[a,a,_],r:c},cu),e("SetFontSize2d",{a:[a,a,c],r:c},au),e("SetFontStyle2d",{a:[a,a,c],r:c},lu),e("CreateString2d",{a:[a,_],r:a},hu),e("GetString2d",{a:[a,a],r:_},uu),e("SetString2d",{a:[a,a,_],r:c},du),e("CreateText2d",{a:[a,a,a,z,z],r:a},fu),e("GetTextCount2d",{a:[a,a],r:c},gu),e("GetTextFont2d",{a:[a,a],r:a},li),e("GetTextFont2d",{a:[a,a,c],r:a},li),e("GetTextString2d",{a:[a,a],r:a},hi),e("GetTextString2d",{a:[a,a,c],r:a},hi),e("GetTextFgColor2d",{a:[a,a],r:z},ui),e("GetTextFgColor2d",{a:[a,a,c],r:z},ui),e("GetTextBkColor2d",{a:[a,a],r:z},di),e("GetTextBkColor2d",{a:[a,a,c],r:z},di),e("SetText2d",{a:[a,a,a,a,z,z],r:c},pu),e("SetText2d",{a:[a,a,c,a,a,z,z],r:c},fi),e("SetTextFont2d",{a:[a,a,c,a],r:c},_u),e("SetTextString2d",{a:[a,a,c,a],r:c},Eu),e("SetTextFgColor2d",{a:[a,a,c,z],r:c},mu),e("SetTextBkColor2d",{a:[a,a,c,z],r:c},wu),e("AddText2d",{a:[a,a,a,a,z,z],r:c},Tu),e("AddText2d",{a:[a,a,c,a,a,z,z],r:c},gi),e("RemoveText2d",{a:[a,a,c],r:c},yu),e("CreateDIB2d",{a:[a,_],r:a},bu),e("CreateDoubleDIB2d",{a:[a,_],r:a},Ou),e("GetDibPixel2d",{a:[a,a,c,c],r:z},Ru),e("SetDibPixel2d",{a:[a,a,c,c,z],r:c},Mu),e("DeleteTool2d",{a:[a,c,a],r:c},vu),e("GetNextTool2d",{a:[a,c,a],r:a},Su),e("GetToolRef2d",{a:[a,c,a],r:c},Au),e("Rgb",{a:[c,c,c],r:z},Nu),e("RgbEx",{a:[c,c,c,c],r:z},Iu),e("Rgbf",{a:[c],r:z},xu),e("GetRValue",{a:[z],r:c},Pu),e("GetGValue",{a:[z],r:c},Lu),e("GetBValue",{a:[z],r:c},Du),e("CreateObjectFromFile2d",{a:[a,_,c,c,c],r:a},ku),e("DeleteObject2d",{a:[a,a],r:c},Cu),e("GetObjectType2d",{a:[a,a],r:c},Gu),e("GetObjectName2d",{a:[a,a],r:_},Fu),e("SetObjectName2d",{a:[a,a,_],r:c},Bu),e("GetObject2dByName",{a:[a,a,_],r:a},Uu),e("GetObjectOrg2dx",{a:[a,a],r:c},Wu),e("GetObjectOrg2dy",{a:[a,a],r:c},Vu),e("SetObjectOrg2d",{a:[a,a,c,c],r:c},$u),e("GetObjectWidth2d",{a:[a,a],r:c},ju),e("GetObjectHeight2d",{a:[a,a],r:c},Hu),e("SetObjectSize2d",{a:[a,a,c,c],r:c},Xu),e("GetActualWidth2d",{a:[a,a],r:c},Yu),e("GetActualHeight2d",{a:[a,a],r:c},zu),e("GetActualSize2d",{a:[a,a,N,N],r:c},Ku),e("GetObjectAngle2d",{a:[a,a],r:c},qu),e("RotateObject2d",{a:[a,a,c,c,c],r:c},Ju),e("SetShowObject2d",{a:[a,a,c],r:c},Zu),e("ShowObject2d",{a:[a,a]},Qu),e("HideObject2d",{a:[a,a]},ed),e("GetObjectFromPoint2d",{a:[a,c,c],r:a},td),e("GetLastPrimary2d",{r:a},sd),e("CopyToClipboard2d",{a:[a,a],r:c},rd),e("PasteFromClipboard2d",{a:[a,c,c,c],r:a},id),e("LockObject2d",{a:[a,a,c],r:c},nd),e("GetObjectAttribute2d",{a:[a,a],r:c},od),e("SetObjectAttribute2d",{a:[a,a,c,c],r:c},cd),e("GetNextObject2d",{a:[a,a],r:a},ad),e("IsObjectsIntersect2d",{a:[a,a,a,c],r:c},ld),e("GetBottomObject2d",{a:[a],r:a},hd),e("GetTopObject2d",{a:[a],r:a},ud),e("GetLowerObject2d",{a:[a,a],r:a},dd),e("GetUpperObject2d",{a:[a,a],r:a},fd),e("GetObjectFromZOrder2d",{a:[a,c],r:a},gd),e("GetZOrder2d",{a:[a,a],r:c},pd),e("SetZOrder2d",{a:[a,a,c],r:c},_d),e("ObjectToBottom2d",{a:[a,a],r:c},Ed),e("ObjectToTop2d",{a:[a,a],r:c},md),e("SwapObject2d",{a:[a,a,a],r:c},wd),e("CreatePolyLine2d",{a:[a,a,a],rest:[c,c],r:a},Td),e("CreateLine2d",{a:[a,a,a,c,c],r:a},yd),e("AddPoint2d",{a:[a,a,c,c,c],r:c},bd),e("SetVectorPoint2d",{a:[a,a,c,c,c],r:c},Od),e("DelPoint2d",{a:[a,a,c],r:c},Rd),e("GetPenObject2d",{a:[a,a],r:a},Md),e("GetBrushObject2d",{a:[a,a],r:a},vd),e("GetVectorNumPoints2d",{a:[a,a],r:c},Sd),e("GetVectorPoint2dx",{a:[a,a,c],r:c},Ad),e("GetVectorPoint2dy",{a:[a,a,c],r:c},Nd),e("SetBrushObject2d",{a:[a,a,a],r:a},Id),e("SetPenObject2d",{a:[a,a,a],r:a},xd),e("SetLineArrows2d",{a:[a,a,c,c,c,c,c,c],r:c},Pd),e("CreateGroup2d",{a:[a],rest:[a],r:a},Ld),e("DeleteGroup2d",{a:[a,a],r:c},Dd),e("AddGroupItem2d",{a:[a,a,a],r:c},kd),e("DelGroupItem2d",{a:[a,a,a],r:c},Cd),e("GetGroupItemsNum2d",{a:[a,a],r:c},Gd),e("GetGroupItem2d",{a:[a,a,c],r:a},Fd),e("GetObjectParent2d",{a:[a,a],r:a},Bd),e("IsGroupContainObject2d",{a:[a,a,a],r:c},Ud),e("CreateBitmap2d",{a:[a,a,c,c],r:a},Wd),e("CreateDoubleBitmap2d",{a:[a,a,c,c],r:a},Vd),e("GetBitmapSrcRect2d",{a:[a,a,N,N,N,N],r:c},$d),e("SetBitmapSrcRect2d",{a:[a,a,c,c,c,c],r:c},jd),e("GetDibObject2d",{a:[a,a],r:a},Hd),e("GetDDibObject2d",{a:[a,a],r:a},Xd),e("SetDibObject2d",{a:[a,a,a],r:c},Yd),e("SetDDibObject2d",{a:[a,a,a],r:c},zd),e("CreateRasterText2d",{a:[a,a,c,c,c],r:a},Kd),e("GetTextObject2d",{a:[a,a],r:a},qd)}const Zd={name:"graphics2d",deps:["windows","streams"],register:Jd};var mi=1e-6,de=typeof Float32Array<"u"?Float32Array:Array;function Wt(){var e=new de(9);return de!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function wi(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function ne(){var e=new de(16);return de!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Qd(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ti(e,t){if(e===t){var s=t[1],r=t[2],i=t[3],n=t[6],o=t[7],l=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=s,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=i,e[13]=o,e[14]=l}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function yi(e,t){var s=t[0],r=t[1],i=t[2],n=t[3],o=t[4],l=t[5],u=t[6],d=t[7],p=t[8],E=t[9],w=t[10],T=t[11],R=t[12],A=t[13],b=t[14],x=t[15],L=s*l-r*o,k=s*u-i*o,U=s*d-n*o,B=r*u-i*l,G=r*d-n*l,C=i*d-n*u,I=p*A-E*R,X=p*b-w*R,q=p*x-T*R,Z=E*b-w*A,he=E*x-T*A,ae=w*x-T*b,J=L*ae-k*he+U*Z+B*q-G*X+C*I;return J?(J=1/J,e[0]=(l*ae-u*he+d*Z)*J,e[1]=(i*he-r*ae-n*Z)*J,e[2]=(A*C-b*G+x*B)*J,e[3]=(w*G-E*C-T*B)*J,e[4]=(u*q-o*ae-d*X)*J,e[5]=(s*ae-i*q+n*X)*J,e[6]=(b*U-R*C-x*k)*J,e[7]=(p*C-w*U+T*k)*J,e[8]=(o*he-l*q+d*I)*J,e[9]=(r*q-s*he-n*I)*J,e[10]=(R*G-A*U+x*L)*J,e[11]=(E*U-p*G-T*L)*J,e[12]=(l*X-o*Z-u*I)*J,e[13]=(s*Z-r*X+i*I)*J,e[14]=(A*k-R*B-b*L)*J,e[15]=(p*B-E*k+w*L)*J,e):null}function ef(e,t,s){var r=t[0],i=t[1],n=t[2],o=t[3],l=t[4],u=t[5],d=t[6],p=t[7],E=t[8],w=t[9],T=t[10],R=t[11],A=t[12],b=t[13],x=t[14],L=t[15],k=s[0],U=s[1],B=s[2],G=s[3];return e[0]=k*r+U*l+B*E+G*A,e[1]=k*i+U*u+B*w+G*b,e[2]=k*n+U*d+B*T+G*x,e[3]=k*o+U*p+B*R+G*L,k=s[4],U=s[5],B=s[6],G=s[7],e[4]=k*r+U*l+B*E+G*A,e[5]=k*i+U*u+B*w+G*b,e[6]=k*n+U*d+B*T+G*x,e[7]=k*o+U*p+B*R+G*L,k=s[8],U=s[9],B=s[10],G=s[11],e[8]=k*r+U*l+B*E+G*A,e[9]=k*i+U*u+B*w+G*b,e[10]=k*n+U*d+B*T+G*x,e[11]=k*o+U*p+B*R+G*L,k=s[12],U=s[13],B=s[14],G=s[15],e[12]=k*r+U*l+B*E+G*A,e[13]=k*i+U*u+B*w+G*b,e[14]=k*n+U*d+B*T+G*x,e[15]=k*o+U*p+B*R+G*L,e}function tf(e,t,s){var r=s[0],i=s[1],n=s[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function sf(e,t,s){var r=s[0],i=s[1],n=s[2],o=Math.sqrt(r*r+i*i+n*n),l,u,d;return o<mi?null:(o=1/o,r*=o,i*=o,n*=o,l=Math.sin(t),u=Math.cos(t),d=1-u,e[0]=r*r*d+u,e[1]=i*r*d+n*l,e[2]=n*r*d-i*l,e[3]=0,e[4]=r*i*d-n*l,e[5]=i*i*d+u,e[6]=n*i*d+r*l,e[7]=0,e[8]=r*n*d+i*l,e[9]=i*n*d-r*l,e[10]=n*n*d+u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function vs(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function bi(e,t){var s=t[0],r=t[1],i=t[2],n=t[4],o=t[5],l=t[6],u=t[8],d=t[9],p=t[10];return e[0]=Math.sqrt(s*s+r*r+i*i),e[1]=Math.sqrt(n*n+o*o+l*l),e[2]=Math.sqrt(u*u+d*d+p*p),e}function rf(e,t){var s=new de(3);bi(s,t);var r=1/s[0],i=1/s[1],n=1/s[2],o=t[0]*r,l=t[1]*i,u=t[2]*n,d=t[4]*r,p=t[5]*i,E=t[6]*n,w=t[8]*r,T=t[9]*i,R=t[10]*n,A=o+p+R,b=0;return A>0?(b=Math.sqrt(A+1)*2,e[3]=.25*b,e[0]=(E-T)/b,e[1]=(w-u)/b,e[2]=(l-d)/b):o>p&&o>R?(b=Math.sqrt(1+o-p-R)*2,e[3]=(E-T)/b,e[0]=.25*b,e[1]=(l+d)/b,e[2]=(w+u)/b):p>R?(b=Math.sqrt(1+p-o-R)*2,e[3]=(w-u)/b,e[0]=(l+d)/b,e[1]=.25*b,e[2]=(E+T)/b):(b=Math.sqrt(1+R-o-p)*2,e[3]=(l-d)/b,e[0]=(w+u)/b,e[1]=(E+T)/b,e[2]=.25*b),e}function Oi(e,t,s,r){var i=t[0],n=t[1],o=t[2],l=t[3],u=i+i,d=n+n,p=o+o,E=i*u,w=i*d,T=i*p,R=n*d,A=n*p,b=o*p,x=l*u,L=l*d,k=l*p,U=r[0],B=r[1],G=r[2];return e[0]=(1-(R+b))*U,e[1]=(w+k)*U,e[2]=(T-L)*U,e[3]=0,e[4]=(w-k)*B,e[5]=(1-(E+b))*B,e[6]=(A+x)*B,e[7]=0,e[8]=(T+L)*G,e[9]=(A-x)*G,e[10]=(1-(E+R))*G,e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1,e}function nf(e,t,s,r,i){var n=1/Math.tan(t/2);if(e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0){var o=1/(r-i);e[10]=(i+r)*o,e[14]=2*i*r*o}else e[10]=-1,e[14]=-2*r;return e}var of=nf;function cf(e,t,s,r){var i=t[0],n=t[1],o=t[2],l=r[0],u=r[1],d=r[2],p=i-s[0],E=n-s[1],w=o-s[2],T=p*p+E*E+w*w;T>0&&(T=1/Math.sqrt(T),p*=T,E*=T,w*=T);var R=u*w-d*E,A=d*p-l*w,b=l*E-u*p;return T=R*R+A*A+b*b,T>0&&(T=1/Math.sqrt(T),R*=T,A*=T,b*=T),e[0]=R,e[1]=A,e[2]=b,e[3]=0,e[4]=E*b-w*A,e[5]=w*R-p*b,e[6]=p*A-E*R,e[7]=0,e[8]=p,e[9]=E,e[10]=w,e[11]=0,e[12]=i,e[13]=n,e[14]=o,e[15]=1,e}var Se=ef;function Q(){var e=new de(3);return de!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function af(e){var t=e[0],s=e[1],r=e[2];return Math.sqrt(t*t+s*s+r*r)}function ce(e,t,s){var r=new de(3);return r[0]=e,r[1]=t,r[2]=s,r}function Ri(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function ye(e,t,s,r){return e[0]=t,e[1]=s,e[2]=r,e}function lf(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function hf(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e}function uf(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e[2]=t[2]*s[2],e}function df(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function ff(e,t){var s=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(s*s+r*r+i*i)}function gf(e,t){var s=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return s*s+r*r+i*i}function pf(e){var t=e[0],s=e[1],r=e[2];return t*t+s*s+r*r}function Vt(e,t){var s=t[0],r=t[1],i=t[2],n=s*s+r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function xe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function tt(e,t,s){var r=t[0],i=t[1],n=t[2],o=s[0],l=s[1],u=s[2];return e[0]=i*u-n*l,e[1]=n*o-r*u,e[2]=r*l-i*o,e}function Pe(e,t,s){var r=t[0],i=t[1],n=t[2],o=s[3]*r+s[7]*i+s[11]*n+s[15];return o=o||1,e[0]=(s[0]*r+s[4]*i+s[8]*n+s[12])/o,e[1]=(s[1]*r+s[5]*i+s[9]*n+s[13])/o,e[2]=(s[2]*r+s[6]*i+s[10]*n+s[14])/o,e}function _f(e,t){var s=e[0],r=e[1],i=e[2],n=t[0],o=t[1],l=t[2],u=Math.sqrt((s*s+r*r+i*i)*(n*n+o*o+l*l)),d=u&&xe(e,t)/u;return Math.acos(Math.min(Math.max(d,-1),1))}var Et=hf,Ef=uf,mf=ff,Ss=gf,wf=af,Mi=pf;(function(){var e=Q();return function(t,s,r,i,n,o){var l,u;for(s||(s=3),r||(r=0),i?u=Math.min(i*s+r,t.length):u=t.length,l=r;l<u;l+=s)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],n(e,e,o),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2];return t}})();function Tf(){var e=new de(4);return de!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function mt(e,t,s,r){var i=new de(4);return i[0]=e,i[1]=t,i[2]=s,i[3]=r,i}function As(e,t,s,r,i){return e[0]=t,e[1]=s,e[2]=r,e[3]=i,e}function yf(e,t){var s=t[0],r=t[1],i=t[2],n=t[3],o=s*s+r*r+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),e[0]=s*o,e[1]=r*o,e[2]=i*o,e[3]=n*o,e}(function(){var e=Tf();return function(t,s,r,i,n,o){var l,u;for(s||(s=4),r||(r=0),i?u=Math.min(i*s+r,t.length):u=t.length,l=r;l<u;l+=s)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],e[3]=t[l+3],n(e,e,o),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2],t[l+3]=e[3];return t}})();function wt(){var e=new de(4);return de!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function bf(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function Of(e,t,s){s=s*.5;var r=Math.sin(s);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(s),e}function Rf(e,t,s){s*=.5;var r=t[0],i=t[1],n=t[2],o=t[3],l=Math.sin(s),u=Math.cos(s);return e[0]=r*u+o*l,e[1]=i*u+n*l,e[2]=n*u-i*l,e[3]=o*u-r*l,e}function Mf(e,t,s){s*=.5;var r=t[0],i=t[1],n=t[2],o=t[3],l=Math.sin(s),u=Math.cos(s);return e[0]=r*u-n*l,e[1]=i*u+o*l,e[2]=n*u+r*l,e[3]=o*u-i*l,e}function vf(e,t,s){s*=.5;var r=t[0],i=t[1],n=t[2],o=t[3],l=Math.sin(s),u=Math.cos(s);return e[0]=r*u+i*l,e[1]=i*u-r*l,e[2]=n*u+o*l,e[3]=o*u-n*l,e}function Ns(e,t,s,r){var i=t[0],n=t[1],o=t[2],l=t[3],u=s[0],d=s[1],p=s[2],E=s[3],w,T,R,A,b;return T=i*u+n*d+o*p+l*E,T<0&&(T=-T,u=-u,d=-d,p=-p,E=-E),1-T>mi?(w=Math.acos(T),R=Math.sin(w),A=Math.sin((1-r)*w)/R,b=Math.sin(r*w)/R):(A=1-r,b=r),e[0]=A*i+b*u,e[1]=A*n+b*d,e[2]=A*o+b*p,e[3]=A*l+b*E,e}function Sf(e,t){var s=t[0]+t[4]+t[8],r;if(s>0)r=Math.sqrt(s+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var n=(i+1)%3,o=(i+2)%3;r=Math.sqrt(t[i*3+i]-t[n*3+n]-t[o*3+o]+1),e[i]=.5*r,r=.5/r,e[3]=(t[n*3+o]-t[o*3+n])*r,e[n]=(t[n*3+i]+t[i*3+n])*r,e[o]=(t[o*3+i]+t[i*3+o])*r}return e}var Af=As,Is=yf;(function(){var e=Q(),t=ce(1,0,0),s=ce(0,1,0);return function(r,i,n){var o=xe(i,n);return o<-.999999?(tt(e,t,i),wf(e)<1e-6&&tt(e,s,i),Vt(e,e),Of(r,e,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(tt(e,i,n),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=1+o,Is(r,r))}})(),(function(){var e=wt(),t=wt();return function(s,r,i,n,o,l){return Ns(e,r,o,l),Ns(t,i,n,l),Ns(s,e,t,2*l*(1-l)),s}})(),(function(){var e=Wt();return function(t,s,r,i){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-s[0],e[5]=-s[1],e[8]=-s[2],Is(t,Sf(t,e))}})();function Nf(e,t,s){const r=[],i=Math.ceil(s/8);e.font=t;let n=0;const o=i,l=i,u=i,d=i;let p=0;for(let T=0;T<16;++T){let R=0;for(let A=0;A<16;++A){const b=T*16+A,x=_e[b],{width:L}=e.measureText(x),k=s;r.push({x:R+u,y:p+o,w:L,h:k,asc:o,desc:l,left:u,right:d}),R+=u+Math.ceil(L)+d}p+=o+s+l,n=Math.max(n,R)}return{font:t,fontSize:s,glyphRects:r,width:n,height:p}}function If(e,{font:t,glyphRects:s,height:r,width:i}){e.canvas.width=i,e.canvas.height=r,e.font=t,e.fillStyle="white",e.textAlign="left",e.textBaseline="top",e.fontKerning="none",s.forEach(({x:n,y:o},l)=>{e.fillText(_e[l],n,o)})}const xf=2,Pf=0,Lf=1,Df=2,kf=3,Cf=4,Gf=5,Ff=6,Bf=7,Uf=8,Wf=9,Vf=0,Tt=1,$f=2,jf=1,Hf=2,Xf=3,vi=4,Yf=5,zf=6,Kf=0,qf=1,Jf=0,Si=1,$t=0,yt=1,jt=2,Zf=0,Qf=1,eg=2,Ht=0,Xt=1,bt=2;class xs{constructor(t){this.objectsGenerator=t,this.list=new WeakMap,this.cur=null}get(t){const{cur:s}=this;if(s&&s.ctx===t)return s;const r=this.list.get(t);if(r)return this.cur=r;const i=this.objectsGenerator(t);return this.list.set(t,this.cur=i),i}}function Ot(e,t,s){const r=e.createShader(t);if(e.shaderSource(r,s),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){console.log(s.split(`
`).map((o,l)=>`${l+1}: ${o}`).join(`
`));const n=e.getShaderInfoLog(r);throw Error(`Ошибка компиляции шейдера (${t===e.VERTEX_SHADER?"vertex":"fragment"}): ${n}`)}return r}function Ps(e,t,s){const r=e.getUniformLocation(t,s);if(!r)throw Error(`Программа не содержит Uniform '${s}'`);return r}class tg{constructor(){this.entries=new Map}add(t,s,r){let i=this.entries.get(t);i||this.entries.set(t,i=new Map);let n=i.get(s);n?n.push(r):i.set(s,n=[r])}filterInline(t){this.entries.forEach((s,r)=>{s.forEach((i,n)=>{const o=i.filter(t);o.length?s.set(n,o):s.delete(n)}),s.size||this.entries.delete(r)})}}var sg=`precision mediump float;
#ifdef UV
uniform sampler2D uTexture;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){
#ifndef GOURAUD
vec4 vLightColor4=vec4(1,1,1,1);
#endif
#ifdef UV
gl_FragColor=texture2D(uTexture,vTexCoord)*vLightColor4;
#else
gl_FragColor=vLightColor4;
#endif
}`,rg=`uniform mat4 uMVP4;
#ifdef GOURAUD
uniform vec3 uWorldLightPos;uniform mat4 uWorldMat4;uniform mat3 uWorldNormalMat;uniform vec3 uAmbientColor;uniform vec4 uTechDiffuseColor4;
#endif
attribute vec4 aPos4;
#ifdef GOURAUD
attribute vec3 aNormal;
#endif
#ifdef UV
attribute vec2 aUv;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){gl_Position=uMVP4*aPos4;
#ifdef GOURAUD
vec3 lightDir=normalize(uWorldLightPos-(uWorldMat4*aPos4).xyz);vec3 worldNormal=normalize(uWorldNormalMat*aNormal);vec3 uLightDiffuse=vec3(1,1,1);float uLightPower=1.;vec3 diffuse=uLightDiffuse*uLightPower*max(dot(worldNormal,lightDir),.0);vec3 GI=uAmbientColor+(uTechDiffuseColor4.rgb*diffuse);vLightColor4=vec4(GI,uTechDiffuseColor4.a);
#endif
#ifdef UV
vTexCoord=aUv;
#endif
}`;let Yt=-1;const st=[{usesUV:!1,shadingMode:-1,index:++Yt},{usesUV:!1,shadingMode:Tt,index:++Yt},{usesUV:!0,shadingMode:-1,index:++Yt},{usesUV:!0,shadingMode:Tt,index:++Yt}],Ai={usesUV:!0,shadingMode:-1,index:-1};class Ni{constructor(t,s,r,i){this.ctx=t,this.shaderProgram=s,this.hasNormalsSupport=r,this.hasUVSupport=i,this._activeTech=null,this._activeVAO=null}use(){const{ctx:t}=this;t._activeProgram!==this&&(t._setActiveProgram(this),t.gl.useProgram(this.shaderProgram),this._activeTech=null,this._activeVAO=null,++t.stats.switchesProgram,this.init())}_setActiveTech(t){this._activeTech=t}_setActiveVAO(t){this._activeVAO=t}}const Ii=st.map(({usesUV:e,shadingMode:t})=>{const s=[];return e&&s.push("UV"),s.push(t===Tt?"GOURAUD":t===$f?"PHONG":t===Vf?"FLAT":"NO_SHADING"),s.map(r=>`#define ${r}
`).join("")}),ig=Ii.map(e=>e+rg),ng=Ii.map(e=>e+sg),og=Q();class xi extends Ni{constructor(t,s,r,i){const{gl:n}=t,o=n.createProgram();if(n.attachShader(o,r),n.attachShader(o,i),n.bindAttribLocation(o,Ht,"aPos4"),n.bindAttribLocation(o,Xt,"aNormal"),n.bindAttribLocation(o,bt,"aUv"),n.linkProgram(o),!n.getProgramParameter(o,n.LINK_STATUS)){const d=n.getProgramInfoLog(o);throw Error(`Ошибка Link Program: ${d}`)}const l=s.shadingMode>-1;super(t,o,l,s.usesUV),this.caps=s,this.uTechDiffuseColor4=null,this.uAmbientColor=null,this.uWorldLightPos=null,this.uWorldMat4=null,this.uWorldNormalMat=null;const u=Ps.bind(null,n,o);this.uVMP4=u("uMVP4"),l&&(this.uTechDiffuseColor4=u("uTechDiffuseColor4"),this.uWorldLightPos=u("uWorldLightPos"),this.uWorldMat4=u("uWorldMat4"),this.uWorldNormalMat=u("uWorldNormalMat"),this.uAmbientColor=u("uAmbientColor")),this.gl=n}init(){this.hasNormalsSupport&&this.gl.uniform3fv(this.uWorldLightPos,this.ctx._lightPosition)}setMVPMatrix(t){this.gl.uniformMatrix4fv(this.uVMP4,!1,t)}setNormalMatrix(t,s){const{gl:r}=this;r.uniformMatrix4fv(this.uWorldMat4,!1,t),r.uniformMatrix3fv(this.uWorldNormalMat,!1,s)}setDiffuse(t){this.gl.uniform4fv(this.uTechDiffuseColor4,t)}setAmbient(t){this.gl.uniform3fv(this.uAmbientColor,Ef(og,this.ctx._ambientColor,t))}useTexture(){}}var cg="precision mediump float;varying vec2 tCoord;uniform vec4 color;uniform bool useTexture;uniform sampler2D tex;void main(){gl_FragColor=useTexture ? texture2D(tex,tCoord)*color : color;}",ag="attribute vec2 v;attribute vec2 uv;uniform vec4 p;uniform vec4 uvRect;varying vec2 tCoord;void main(){gl_Position=vec4((p.x+p.z*v.x)*2.-1.,(-p.y+p.w*v.y)*2.+1.,0,1);tCoord=vec2(uvRect.x+uvRect.z*uv.x,uvRect.y+uvRect.w*uv.y);}";class lg extends Ni{constructor(t){const{gl:s}=t,r=Ot(s,s.VERTEX_SHADER,ag),i=Ot(s,s.FRAGMENT_SHADER,cg),n=s.createProgram();if(s.attachShader(n,r),s.attachShader(n,i),s.bindAttribLocation(n,Ht,"v"),s.bindAttribLocation(n,bt,"uv"),s.linkProgram(n),!s.getProgramParameter(n,s.LINK_STATUS)){const l=s.getProgramInfoLog(n);throw Error(`Ошибка Link Program: ${l}`)}super(t,n,!1,!0),this.textureInUse=!1;const o=Ps.bind(null,s,n);this.uPos=o("p"),this.uUVRect=o("uvRect"),this.uColor=o("color"),this.uUseTexture=o("useTexture"),this.gl=t.gl}setColor(t){this.gl.uniform4fv(this.uColor,t)}setPositionAndScale(t,s,r,i){this.gl.uniform4f(this.uPos,t,s,r,i)}setUVRect(t){this.gl.uniform4fv(this.uUVRect,t)}useTexture(t){this.textureInUse!==t&&(this.textureInUse=t,this.gl.uniform1f(this.uUseTexture,+t))}init(){}}var hg="precision mediump float;uniform sampler2D uTexture;uniform vec4 uTextColor;varying vec2 vTexCoord;void main(){float alpha=texture2D(uTexture,vTexCoord).a*uTextColor.a;gl_FragColor=vec4(uTextColor.rgb,alpha);}";class ug extends xi{constructor(t,s){const{gl:r}=t,i=Ot(r,r.FRAGMENT_SHADER,hg);super(t,Ai,s,i),this.uTextColor=Ps(r,this.shaderProgram,"uTextColor")}setTextColor(t){this.gl.uniform4fv(this.uTextColor,t)}}class Rt{use(t){const s=this.selectProgram(t);return s.use(),s._activeTech===this||(s._setActiveTech(this),this.apply(s),++t.stats.switchesTech),s}}class dg extends Rt{constructor(t){super(),this.material=t,this.passVersion=-1,this.texture=null,this.programCaps=null,this.pass=t.techs[0].passes[0]}prepare(){const{pass:t}=this;if(this.passVersion===t._version)return;this.passVersion=t._version;const r=!!(this.texture=t._getDefaultTextureUnit()?.getTexture()||null),i=t.lightingEnabled?Tt:0,n=st.find(o=>o.usesUV===r&&o.shadingMode===i);if(!n)throw Error(`Материал "${this.material.name}": программа с заданными требованиями (usesUV: ${r}, shadingMode: ${i}) не существует`);this.programCaps=n}hasOpacity(){const{pass:t}=this;return t.diffuse[3]<1}getProgramCaps(){return this.prepare(),this.programCaps}selectProgram(t){return this.prepare(),t.meshPrograms[this.programCaps.index]}apply(t){const{ctx:s}=t,{pass:r}=this;s.setDepthWrite(r.depthWrite),s.setDepthCheck(r.depthCheck),this.texture?.use(s),t.setDiffuse(r.diffuse),t.setAmbient(r.ambient)}}class fg extends Rt{constructor(t){super(),this.material=t,this.pass=t.techs[0].passes[0]}selectProgram(t){return t.overlayProgram}apply(t){const{pass:s}=this,r=s._getDefaultTextureUnit()?.getTexture();r?(r.use(t.ctx),t.useTexture(!0)):t.useTexture(!1),t.setColor(s.diffuse)}}class gg extends Rt{constructor(t,s){super(),this.fontTexture=t,this.colorSource=s}getProgramCaps(){return Ai}selectProgram(t){return t.textProgram}apply(t){this.fontTexture.use(t.ctx),t.setTextColor(this.colorSource.color)}}const pg=mt(0,0,1,1);class _g extends Rt{constructor(t){super(),this.fontTexture=t}selectProgram(t){return t.overlayProgram}apply(t){this.fontTexture.use(t.ctx),t.useTexture(!0),t.setUVRect(pg)}}const Ls=qe(0,0).getContext("2d",{alpha:!0});class Eg{constructor(t){this.fontName=t,this.cache=new xs(this.genFontTexture.bind(this)),this.textOverlayRenderTech=null;const s=Math.round(150/72*20);this.glyphData=Nf(Ls,`${s}px ${this.fontName}`,s)}genFontTexture(t){If(Ls,this.glyphData);const{gl:s}=t,r=s.createTexture();return t.setTexture(r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,Ls.canvas),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),{ctx:t,texture:r}}use(t){t.setTexture(this.cache.get(t).texture)}getTextOverlayRenderTech(){return this.textOverlayRenderTech||(this.textOverlayRenderTech=new _g(this)),this.textOverlayRenderTech}}class mg{constructor(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesVAO=0,this.switchesFace=0,this.dcOpaque=0,this.dcTransparent=0,this.dcOverlay=0,this.dcTotal=0;const t=this;Object.defineProperty(window,"s",{configurable:!0,get(){return t}})}reset(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesFace=0,this.switchesVAO=0,this.dcOpaque=0,this.dcTransparent=0,this.dcTotal=0,this.dcOverlay=0}}class wg{constructor(t){this.gl=t,this.currentTexture=null,this.uvEnabled=!1,this.normalsEnabled=!1,this.backFacesInUse=!1,this.depthWrite=!0,this.depthCheck=!0,this.blendSFactor=WebGLRenderingContext.ONE,this.blendDFactor=WebGLRenderingContext.ZERO,this._ambientColor=Q(),this._lightPosition=Q(),this.stats=new mg,this._activeProgram=null,t.enable(t.CULL_FACE),t.enableVertexAttribArray(Ht),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.hasIndices32Support=!!t.getExtension("OES_element_index_uint");const s=ig.map(n=>Ot(t,t.VERTEX_SHADER,n)),r=ng.map(n=>Ot(t,t.FRAGMENT_SHADER,n));this.meshPrograms=st.map((n,o)=>new xi(this,n,s[o],r[o]));const i=s[st.findIndex(n=>n.usesUV&&n.shadingMode<0)];this.textProgram=new ug(this,i),this.overlayProgram=new lg(this)}_setActiveProgram(t){this._activeProgram=t}reset(){this.stats.reset()}setLighting(t,s){Ri(this._ambientColor,t),Ri(this._lightPosition,s),this._activeProgram?.init()}enableUV(){this.uvEnabled||(this.uvEnabled=!0,this.gl.enableVertexAttribArray(bt))}disableUV(){this.uvEnabled&&(this.uvEnabled=!1,this.gl.disableVertexAttribArray(bt))}enableNormals(){this.normalsEnabled||(this.normalsEnabled=!0,this.gl.enableVertexAttribArray(Xt))}disableNormals(){this.normalsEnabled&&(this.normalsEnabled=!1,this.gl.disableVertexAttribArray(Xt))}useBackFaces(t){if(this.backFacesInUse===t)return;this.backFacesInUse=t;const{gl:s}=this;s.frontFace(t?s.CW:s.CCW),++this.stats.switchesFace}setTexture(t){if(this.currentTexture===t)return;this.currentTexture=t;const{gl:s}=this;s.bindTexture(s.TEXTURE_2D,t),++this.stats.switchesTexture}setDepthWrite(t){this.depthWrite!==t&&(this.depthWrite=t,this.gl.depthMask(t))}setDepthCheck(t){if(this.depthCheck===t)return;this.depthCheck=t;const{gl:s}=this;s.depthFunc(t?s.LESS:s.ALWAYS)}setBlendFunc(t,s){this.blendSFactor===t&&this.blendDFactor===s||(this.blendSFactor=t,this.blendDFactor=s,this.gl.blendFunc(t,s))}}function Ae(e){const t=e.split(" ").map(s=>parseFloat(s));return t.length===4&&!t.some(isNaN)?[t[0],t[1],t[2]-t[0],t[3]-t[1]]:null}function Tg(e){const t=e.split(" ").slice(0,3).map(s=>parseFloat(s));return t.some(isNaN)?null:[...t,1]}class Ds{constructor(t,s,r){this.o=t,this.type=s,this.overlay=null,this.parent=null,this.children=[],this.visible=!0,this.x=0,this.y=0,this.width=0,this.height=0,this.metricsMode=Jf,this.horAlign=$t,this.horTextAlign=$t,this.vertAlign=Zf,this.caption="",this.charHeight=12,this.spaceWidth=0,this.color=[1,1,1,1],this.material=null,this.uv=[0,0,1,1],this.uvTL=[0,0,1,1],this.uvTR=[0,0,1,1],this.uvBL=[0,0,1,1],this.uvBR=[0,0,1,1],this.uvL=[0,0,1,1],this.uvR=[0,0,1,1],this.uvT=[0,0,1,1],this.uvB=[0,0,1,1],this.borders=[0,0,0,0],this.textMesh=null,t.overlayElements.set(this.key=t.key(),this),this.name=r?.name??""}drawAt(t,s,r,i,n,o,l){const{visible:u,vertAlign:d,horAlign:p,metricsMode:E,x:w,y:T,width:R,height:A}=this;if(!u)return;const b=E===Si,x=(b?w/o:w)+(p===jt?i:p===yt?i/2:0)+s,L=(b?T/l:T)+(d===eg?n:d===Qf?n/2:0)+r,k=b?R/o:R,U=b?A/l:A;this.draw(t,x,L,k,U,o,l),this.children.forEach(B=>B.drawAt(t,x,L,k,U,o,l))}setMetricsMode(t){return this.metricsMode=t,this}setChildren(t){return this.children.forEach(s=>s.parent=null),this.children=Array.from(new Set(t)),this.children.forEach(s=>s.parent=this),this}setVisible(t){return this.visible=t,this}setPosition(t,s){return this.x=t,this.y=s,this}setSize(t,s){return this.width=t,this.height=s,this}setAlignment(t,s){return this.horAlign=t,this.vertAlign=s,this}setCaption(t){return this.caption!==t&&(this.caption=t,this.textMesh=null),this}setColor(t,s,r,i){return this.color=[t,s,r,i],this}setMaterial(t){return this.material=t,this}setParam(t,s){switch(t){case"uv_coords":{const i=Ae(s);i&&(this.uv=i);break}case"border_material":break;case"border_size":{const i=s.split(" ").map(n=>Math.max(parseInt(n),2));i.length===4&&!i.some(isNaN)&&(this.borders=i);break}case"border_topleft_uv":{const i=Ae(s);i&&(this.uvTL=i);break}case"border_topright_uv":{const i=Ae(s);i&&(this.uvTR=i);break}case"border_bottomleft_uv":{const i=Ae(s);i&&(this.uvBL=i);break}case"border_bottomright_uv":{const i=Ae(s);i&&(this.uvBR=i);break}case"border_left_uv":{const i=Ae(s);i&&(this.uvL=i);break}case"border_right_uv":{const i=Ae(s);i&&(this.uvR=i);break}case"border_top_uv":{const i=Ae(s);i&&(this.uvT=i);break}case"border_bottom_uv":{const i=Ae(s);i&&(this.uvB=i);break}case"font_name":break;case"alignment":this.horTextAlign=s==="center"?yt:s==="right"?jt:$t;break;case"colour":const r=Tg(s);r&&(this.color=r);break;case"char_height":{const i=parseInt(s)||12;this.charHeight!==i&&(this.charHeight=i,this.textMesh=null);break}case"space_width":{const i=parseInt(s)||12;this.spaceWidth!==i&&(this.spaceWidth=i,this.textMesh=null);break}default:console.warn(`Неизвестный параметр StringInterface: '${t}'`);break}}}class rt{constructor(t){this.data=t,this.cache=new xs(this.genBuffers.bind(this)),this.gl=null;const{indices:s,positions:r,positionSize:i}=t,n=this.useIndices32=s instanceof Uint32Array;this.positionSize=i,this.hasIndices=!!s,this.count=s?.length??r.length/i,this.drawMode=t.drawMode??WebGLRenderingContext.TRIANGLES,this.indicesType=n?WebGLRenderingContext.UNSIGNED_INT:WebGLRenderingContext.UNSIGNED_SHORT}genBuffers(t){const{gl:s}=t,{indices:r,positions:i,uvs:n,normals:o}=this.data,l=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,l),s.bufferData(s.ARRAY_BUFFER,i,s.STATIC_DRAW);let u;n?(u=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,u),s.bufferData(s.ARRAY_BUFFER,n,s.STATIC_DRAW)):u=null;let d;o?(d=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,d),s.bufferData(s.ARRAY_BUFFER,o,s.STATIC_DRAW)):d=null;let p;return r?(p=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,p),s.bufferData(s.ELEMENT_ARRAY_BUFFER,r,s.STATIC_DRAW),this.useIndices32&&!t.hasIndices32Support&&(console.warn("WebGL: Не поддерживаются 32-битные индексы"),this.indicesType=s.UNSIGNED_SHORT,this.count=0)):p=null,{ctx:t,positionsBuffer:l,uvsBuffer:u,normalsBuffer:d,indexBuffer:p}}use(t){if(t._activeVAO===this)return;t._setActiveVAO(this);const{ctx:s}=t,{positionsBuffer:r,uvsBuffer:i,normalsBuffer:n,indexBuffer:o}=this.cache.get(s),{gl:l}=s;l.bindBuffer(l.ARRAY_BUFFER,r),l.vertexAttribPointer(Ht,this.positionSize,l.FLOAT,!1,0,0),i&&t.hasUVSupport?(l.bindBuffer(l.ARRAY_BUFFER,i),l.vertexAttribPointer(bt,2,l.FLOAT,!1,0,0),s.enableUV()):s.disableUV(),n&&t.hasNormalsSupport?(l.bindBuffer(l.ARRAY_BUFFER,n),l.vertexAttribPointer(Xt,3,l.FLOAT,!1,0,0),s.enableNormals()):s.disableNormals(),o&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,o),this.gl=l,++s.stats.switchesVAO}draw(){const{gl:t,drawMode:s,count:r,indicesType:i,hasIndices:n}=this;n?t.drawElements(s,r,i,0):t.drawArrays(s,0,r)}_drawRange(t,s){const{gl:r,drawMode:i,indicesType:n}=this;r.drawElements(i,s,n,t)}}class yg{constructor(t,s,r){this.sharedVAO=t,this.count=r,this.byteOffset=s*(t.useIndices32?4:2)}use(t){this.sharedVAO.use(t)}draw(){this.sharedVAO._drawRange(this.byteOffset,this.count)}}const zt=new rt({positionSize:2,positions:new Float32Array([0,0,0,-1,1,-1,1,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),drawMode:WebGLRenderingContext.TRIANGLE_FAN});class bg extends Ds{constructor(t,s){super(t,"Panel",s)}draw(t,s,r,i,n){const{material:o,uv:l}=this;if(!o)return;const u=o._getPanelOverlayRenderTech().use(t);zt.use(u),u.setUVRect(l),u.setPositionAndScale(s,r,i,n),zt.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class Og extends Ds{constructor(t,s){super(t,"BorderPanel",s)}draw(t,s,r,i,n,o,l){const{material:u,uv:d,borders:p,uvTL:E,uvT:w,uvTR:T,uvR:R,uvBR:A,uvB:b,uvBL:x,uvL:L,metricsMode:k}=this;if(!u)return;const U=u._getPanelOverlayRenderTech().use(t);zt.use(U);const B=k===Si,G=B?p[0]/o:p[0],C=B?p[1]/o:p[1],I=B?p[2]/l:p[2],X=B?p[3]/l:p[3],q=i-G-C,Z=n-I-X;[[[G,I,q,Z],d],[[0,0,G,I],E],[[G,0,q,I],w],[[G+q,0,C,I],T],[[G+q,I,C,Z],R],[[G+q,I+Z,C,X],A],[[G,I+Z,q,X],b],[[0,I+Z,G,X],x],[[0,I,G,Z],L]].forEach(([ae,J])=>{U.setUVRect(J),U.setPositionAndScale(s+ae[0],r+ae[1],ae[2],ae[3]),zt.draw(),++t.stats.dcOverlay,++t.stats.dcTotal})}}function Pi(e,t,s=$t,r=0){const{glyphRects:i,fontSize:n,height:o,width:l}=e,u=[...t],d=(r||i[Nt].w)/n;let p=0;const E=[];let w=0,T=0;{let L={glyphs:[],width:0},k=0;u.forEach(U=>{const B=_e.indexOf(U),G=B>-1?B:Nt;if(G===so){E.push(L),w=Math.max(w,L.width),T+=1,L={glyphs:[],width:0},k=0,L.width=0;return}const C=i[G];if(G===Nt)(s!==yt||!E.length||L.glyphs.length)&&(L.width+=d,L.glyphs.push(null));else{const I=C.w/n,X=C.h/n;L.width+=I,k=Math.max(k,X),L.glyphs.push(C),++p}}),E.push(L),w=Math.max(w,L.width),T+=k}if(!p)return{caption:t,width:w,height:T,vao:null,align:s};const R=new Float32Array(p*8),A=new Float32Array(p*8),b=new Uint16Array(p*6);{let L=0,k=0;E.forEach(U=>{let B=s===yt?(w-U.width)/2:s===jt?w-U.width:0;U.glyphs.forEach(G=>{if(!G){B+=d;return}const C=G.w/n,I=G.x-G.left,X=G.y-G.asc,q=G.left+G.w+G.right,Z=G.asc+G.h+G.desc,he=q/n,ae=Z/n,J=L*8,Ce=L*6,Ge=L*4;++L;{const Fe=B-G.left/n,ct=k+G.asc/n;B+=C;const at=Fe,St=Fe,Ye=Fe+he,lt=Ye,ht=ct,ze=ct-ae,Ys=ze,zs=ht;R[J+0]=at,R[J+1]=ht,R[J+2]=St,R[J+3]=ze,R[J+4]=Ye,R[J+5]=Ys,R[J+6]=lt,R[J+7]=zs}{const Fe=I/l,ct=Fe,at=(I+q)/l,St=at,Ye=X/o,lt=(X+Z)/o,ht=lt,ze=Ye;A[J+0]=Fe,A[J+1]=Ye,A[J+2]=ct,A[J+3]=lt,A[J+4]=at,A[J+5]=ht,A[J+6]=St,A[J+7]=ze}b[Ce+0]=Ge+0,b[Ce+1]=Ge+1,b[Ce+2]=Ge+2,b[Ce+3]=Ge+0,b[Ce+4]=Ge+2,b[Ce+5]=Ge+3}),k-=1})}const x=new rt({positionSize:2,positions:R,uvs:A,indices:b});return{caption:t,width:w,height:T,vao:x,align:s}}class Rg extends Ds{constructor(t,s){super(t,"TextArea",s),this.tech=t._getFontTexture().getTextOverlayRenderTech()}draw(t,s,r,i,n,o,l){const{caption:u,tech:d,horTextAlign:p,spaceWidth:E}=this;if(!u)return;const{vao:w,width:T}=this.textMesh||(this.textMesh=Pi(d.fontTexture.glyphData,u,p,E));if(!w)return;const R=d.use(t);w.use(R);const A=this.charHeight*.75,b=A/o,x=A/l,L=s-(p===jt?T*b:p===yt?T*b/2:0);R.setPositionAndScale(L,r,b,x),R.setColor(this.color),w.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class Kt{constructor(){this.renderIteration=0,this.currentRenderList=null}_setCurrentRenderList(t){this.currentRenderList=t}_setRenderIteration(t){this.renderIteration=t}_techOrVAOChanged(){this.currentRenderList?._removeElement(this)}}class Mg{constructor(){this.renderIteration=0,this.gcFilter=t=>t.currentRenderList===this,this.capsGroups=st.map(()=>new tg)}clear(){++this.renderIteration}add(t){if(t._setRenderIteration(this.renderIteration),t.currentRenderList===this)return;t._setCurrentRenderList(this);const s=t.getRenderTech(),r=t.getVAO(),i=s.getProgramCaps();this.capsGroups[i.index].add(s,r,t)}_removeElement(t){t._setCurrentRenderList(null),this.gc()}render(t,s){let r=!1;const{renderIteration:i}=this,{stats:n}=t;for(const o of this.capsGroups)o.entries.forEach((l,u)=>{const d=u.use(t),{hasNormalsSupport:p}=d;l.forEach((E,w)=>{w.use(d),E.forEach(T=>{if(T.currentRenderList!==this){r=!0;return}if(T.renderIteration!==i){T._setCurrentRenderList(null),r=!0;return}t.useBackFaces(T.isMirrored()),p&&d.setNormalMatrix(T.getWorldMatrix(),T.getWorldNormalMatrix()),d.setMVPMatrix(T.getMVPMatrix(s)),w.draw(),++n.dcOpaque,++n.dcTotal})})});r&&this.gc()}gc(){for(const t of this.capsGroups)t.filterInline(this.gcFilter)}}class Li{constructor(){this.elements=[],this.renderIteration=0}clear(){++this.renderIteration}add(t){t._setRenderIteration(this.renderIteration),t.currentRenderList!==this&&(t._setCurrentRenderList(this),this.elements.push(t))}_removeElement(){}render(t,s){let r=!1;const{renderIteration:i}=this,{stats:n}=t;if(s.node){const o=s.node.getWorldPosition();this.elements.sort((l,u)=>Ss(o,u.getWorldCOM())-Ss(o,l.getWorldCOM()))}else this.elements.sort((o,l)=>Mi(l.getWorldCOM())-Mi(o.getWorldCOM()));this.elements.forEach(o=>{if(o.currentRenderList!==this){r=!0;return}if(o.renderIteration!==i){o._setCurrentRenderList(null),r=!0;return}const l=o.getRenderTech(),u=o.getVAO(),d=l.use(t);u.use(d),t.useBackFaces(o.isMirrored()),d.hasNormalsSupport&&d.setNormalMatrix(o.getWorldMatrix(),o.getWorldNormalMatrix()),d.setMVPMatrix(o.getMVPMatrix(s)),u.draw(),++n.dcTotal,++n.dcTransparent}),r&&this.gc()}gc(){this.elements=this.elements.filter(t=>t.currentRenderList===this)}}class vg{constructor(t){this.image=t,this.cache=new xs(this.genTexture.bind(this))}genTexture(t){const{gl:s}=t,r=s.createTexture();function i(o){t.setTexture(r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,o),cr(o.width)&&cr(o.height)?s.generateMipmap(s.TEXTURE_2D):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE))}const{image:n}=this;return n.complete&&n.naturalHeight?i(n):(t.setTexture(r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,1,1,0,s.RGBA,s.UNSIGNED_BYTE,new Uint8Array([211,211,211,64])),n.complete||n.addEventListener("load",()=>i(n))),{ctx:t,texture:r}}use(t){t.setTexture(this.cache.get(t).texture)}}const Sg=ne(),Ag=Wt(),Di=Q(),Ng=ce(0,1,0),ki=ce(0,0,-1),Ig=ce(1,1,1),xg=mt(1,1,1,1),ks=Q(),Cs=Q(),Gs=Q(),Fs=Q(),Bs=Q();function Ci({origin:e,dir:t},s,r,i){Et(ks,r,s),Et(Cs,i,s),tt(Gs,t,Cs);const n=xe(ks,Gs);if(n>-Number.EPSILON&&n<Number.EPSILON)return 1/0;const o=1/n;Et(Fs,e,s);const l=xe(Fs,Gs)*o;if(l<0||l>1)return 1/0;tt(Bs,Fs,ks);const u=xe(t,Bs)*o;if(u<0||l+u>1)return 1/0;const d=xe(Cs,Bs)*o;return d>Number.EPSILON?d:1/0}const Le=Q(),De=Q(),ke=Q();function Pg(e,t){let s=1/0;for(let r=0;r+8<t.length;r+=9){Le[0]=t[r+0],Le[1]=t[r+1],Le[2]=t[r+2],De[0]=t[r+3],De[1]=t[r+4],De[2]=t[r+5],ke[0]=t[r+6],ke[1]=t[r+7],ke[2]=t[r+8];const i=Ci(e,Le,De,ke);s>i&&(s=i)}return s}function Lg(e,t,s){let r=1/0;for(let i=0;i+2<s.length;i+=3){const n=s[i+0]*3,o=s[i+1]*3,l=s[i+2]*3;Le[0]=t[n+0],Le[1]=t[n+1],Le[2]=t[n+2],De[0]=t[o+0],De[1]=t[o+1],De[2]=t[o+2],ke[0]=t[l+0],ke[1]=t[l+1],ke[2]=t[l+2];const u=Ci(e,Le,De,ke);r>u&&(r=u)}return r}function Dg(e,t,s){const[r,i,n]=t;return e[0]=s[0]*r+s[4]*i+s[8]*n,e[1]=s[1]*r+s[5]*i+s[9]*n,e[2]=s[2]*r+s[6]*i+s[10]*n,Vt(e,e)}function kg(e,t,s){return Pe(e.origin,t.origin,s),Dg(e.dir,t.dir,s),e}function Gi(e){switch(e){case Pf:return WebGLRenderingContext.ONE;case Lf:return WebGLRenderingContext.ZERO;case Df:return WebGLRenderingContext.DST_COLOR;case kf:return WebGLRenderingContext.SRC_COLOR;case Cf:return WebGLRenderingContext.ONE_MINUS_DST_COLOR;case Gf:return WebGLRenderingContext.ONE_MINUS_SRC_COLOR;case Ff:return WebGLRenderingContext.DST_ALPHA;case Bf:return WebGLRenderingContext.SRC_ALPHA;case Uf:return WebGLRenderingContext.ONE_MINUS_DST_ALPHA;case Wf:return WebGLRenderingContext.ONE_MINUS_SRC_ALPHA;default:return 0}}function Cg(e){switch(e){case jf:return WebGLRenderingContext.POINTS;case Hf:return WebGLRenderingContext.LINES;case Xf:return WebGLRenderingContext.LINE_STRIP;case Yf:return WebGLRenderingContext.TRIANGLE_STRIP;case zf:return WebGLRenderingContext.TRIANGLE_FAN;default:return WebGLRenderingContext.TRIANGLES}}function Us(){return{origin:Q(),dir:ce(0,0,1)}}const Gg=new rt({positionSize:2,positions:new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),indices:new Uint16Array([0,2,1,0,3,2,0,1,2,0,2,3])});class Fg extends Kt{constructor(t,s,r){super(),this.set=t,this.position=s,this.parentScale=r,this.worldMatrix=ne(),this.localMatrix=ne(),this.worldCOM=Q(),this.rotation=wt(),this.mvpMatrix=ne(),this.worldMatrixVersion=0,this.comWorldMatrixVersion=0,this.shouldUpdateLocalMatrix=!0,this.key=t.o.key()}getMVPMatrix(t){return Se(this.mvpMatrix,t._getVPMatrix(),this.getWorldMatrix())}getWorldMatrix(){const{set:t}=this;this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,Oi(this.localMatrix,this.rotation,this.position,this.parentScale),this.worldMatrixVersion=0);const s=t.node;return this.worldMatrixVersion!==s._worldMatrixVersion&&(this.worldMatrixVersion=s._worldMatrixVersion,Se(this.worldMatrix,s._getWorldMatrix(),this.localMatrix)),this.worldMatrix}getWorldCOM(){const t=this.set.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.position,t._getWorldMatrix()),vs(this.worldCOM,this.getWorldMatrix())),this.worldCOM}getVAO(){return Gg}getRenderTech(){return this.set.material._getMeshRenderTech()}getWorldNormalMatrix(){return Ag}isMirrored(){return!1}_onAttached(){this.worldMatrixVersion=0,this.comWorldMatrixVersion=0}_updateLocalMatrix(){this.shouldUpdateLocalMatrix=!0}}class it{constructor(t,s){this.o=t,this.node=null,this.visible=!0,t.movables.set(this.key=t.key(),this),this.name=s?.name??""}destroy(){this.detach(),this.o.movables.delete(this.key)}setVisible(t){return this.visible=t,this}detach(){const t=this.node;return t?(t.movables=t.movables.filter(s=>s!==this),this.node=null,this):this}}class Bg extends it{constructor(t,s){super(t,s),this.commonScale=ce(1,1,1),this.type=Kf,this.material=null,this.billboards=[],t.billboardSets.set(this.key,this)}destroy(){super.destroy(),this.o.billboardSets.delete(this.key)}createBillboard(t,s,r){const i=new Fg(this,ce(t,s,r),this.commonScale);return this.billboards.push(i),i}setCommonDirection(t,s,r){return this}setCommonUpVector(t,s,r){return this}setDimensions(t,s){ye(this.commonScale,t,s,1);for(const r of this.billboards)r._updateLocalMatrix();return this}setType(t){if(t!==qf)throw Error(`billboardSet_SetBillboardType: тип ${t} не реализован`);return this.type=t,this}setMaterial(t){if(this.material!==t){this.material=t;for(const s of this.billboards)s._techOrVAOChanged()}return this}_onAttached(){for(const t of this.billboards)t._onAttached()}_setup(t){const{material:s}=this;if(!s)return;const r=s._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements;for(const i of this.billboards)r.add(i)}}const Fi=new Map;class Ug{constructor(t){this.info=t,this.texture=null,this.image=null,this.loadImage()}loadImage(){if(this.image)return this.image;const t=We(this.info.src),s=Fi.get(t);if(s)return this.image=s;const r=new Image;return r.crossOrigin="",r.src=t,Fi.set(t,r),this.image=r}getTexture(){return this.texture||(this.image||(this.image=this.loadImage()),this.texture=new vg(this.image)),this.texture}}const qt=Q();class Bi{constructor(t,s){this.center=t,this.sqrRadius=s*s}intersectsWith(t){const{center:s}=this;if(Ss(s,t.origin)<=this.sqrRadius)return!0;Et(qt,s,t.origin);const r=xe(qt,t.dir),i=xe(qt,qt)-r*r;if(i>this.sqrRadius)return!1;const n=Math.sqrt(this.sqrRadius-i);return r+n>=0}}class Wg{constructor(t,s,r){this.parent=t,this.data=s,this.indexOffset=r,this.material=null,this.vao=null,this.materialFound=!1,this.materialName=s.material||"",this.useSharedGeometry=s.useSharedGeometry||!1;const i=s.useSharedGeometry?t.data.sharedGeometry:s.geometry;if(!i)throw Error("Mesh не имеет геометрии");if(i.length>1)throw Error("Mesh с несколькими VertexBuffer не реализованы");const[n]=i;if(!n.positions)throw Error("Mesh без Positions не поддерживается");this.vBufferData=n;const{maxX:o,maxY:l,maxZ:u,minX:d,minY:p,minZ:E}=s.extrema||n.positions.extrema,w=(o+d)/2,T=(l+p)/2,R=(u+E)/2;this.center=ce(w,T,R);const A=Math.max(o-d,l-p,u-E)/2;this.boundingSphere=new Bi(this.center,A)}getCOM(){return this.center}getVertexCount(){return this.vBufferData.vertexCount}getDefaultMaterial(){if(this.materialFound)return this.material;if(this.materialFound=!0,!this.materialName)return null;const t=this.parent.o.materialByName.get(this.materialName)??null;if(!t){const s=this.parent.submeshes.indexOf(this);console.warn(`Ogre: ${this.parent.meta}[${s}]: материал '${this.materialName}' не существует`)}return this.material=t}getVAO(){if(this.vao)return this.vao;if(this.useSharedGeometry){const l=this.indexOffset;let u=this.data.indices.length;return this.vao=new yg(this.parent._getSharedVAO(),l,u)}const{vBufferData:t,data:s}=this,r=new Float32Array(t.positions.coords),i=t.normals?.length?new Float32Array(t.normals):null,n=t.uvs?.length?new Float32Array(t.uvs[0]):null,o=new(s.useIndices32?Uint32Array:Uint16Array)(s.indices);return this.vao=new rt({positionSize:3,positions:r,uvs:n,normals:i,indices:o})}getClosestIntersection(t){return this.boundingSphere.intersectsWith(t)?Lg(t,this.vBufferData.positions.coords,this.data.indices):1/0}}class Vg{constructor(t,s){this.o=t,this.data=s,this.sharedVAO=null;let r=0;this.submeshes=s.submeshes.map(i=>{const n=new Wg(this,i,r);return r+=i.indices.length,n})}_getSharedVAO(){if(this.sharedVAO)return this.sharedVAO;const[t]=this.data.sharedGeometry;let s=!1,r=0;this.data.submeshes.forEach(d=>{d.useIndices32&&(s=!0),r+=d.indices.length});const i=new(s?Uint32Array:Uint16Array)(r);let n=0;this.data.submeshes.forEach(d=>{i.set(d.indices,n),n+=d.indices.length});const o=new Float32Array(t.positions.coords),l=t.normals?.length?new Float32Array(t.normals):null,u=t.uvs?.length?new Float32Array(t.uvs[0]):null;return this.sharedVAO=new rt({positionSize:3,positions:o,uvs:u,normals:l,indices:i})}}class $g extends it{constructor(t,s){super(t,s),t.lights.set(this.key,this)}destroy(){super.destroy(),this.o.lights.delete(this.key)}_onAttached(){}_setup(t){t.globalLight=this}}class jg{constructor(t,s=""){this.pass=t,this.name=s,this.texture=null,this.imageNameUC=null,this.imageFound=!1,t.tech.mat.o.texUnits.set(this.key=t.tech.mat.o.key(),this)}setTexture(t,s){if(s!==xf)throw Error("textureUnitState_SetTexture: Используемый тип текстуры не поддерживается");return this.texture=t?.getTexture()||null,this}setTextureName(t){return this.imageNameUC=t.toUpperCase(),this}getTexture(){return this.imageFound||this.texture?this.texture:(this.imageFound=!0,this.imageNameUC?this.texture=this.pass.tech.mat.o.imageResByNameUC.get(this.imageNameUC)?.getTexture()||null:null)}}class Hg{constructor(t){this.tech=t,this.textures=[],this.ambient=ce(1,1,1),this.diffuse=mt(1,1,1,1),this.specular=mt(0,0,0,1),this.emissive=ce(0,0,0),this.shininess=0,this.lightingEnabled=!0,this.shadingMode=Tt,this.depthCheck=!0,this.depthWrite=!0,this._glBlendSFactor=WebGLRenderingContext.ONE,this._glBlendDFactor=WebGLRenderingContext.ZERO,this._version=0,t.mat.o.passes.set(this.key=t.mat.o.key(),this)}_getDefaultTextureUnit(){const{textures:t}=this;return t.length?t[0]:null}createTextureUnit(t){const s=new jg(this,t);return this.textures.push(s),s}setLightingEnabled(t){return this.lightingEnabled=t,this}setAmbient(t,s,r){return ye(this.ambient,t,s,r),this}setDiffuse(t,s,r,i){return As(this.diffuse,t,s,r,i),this}setSpecular(t,s,r,i){return As(this.specular,t,s,r,i),this}setEmissive(t,s,r){return ye(this.emissive,t,s,r),this}setShininess(t){return this.shininess=t,this}setShadingMode(t){return this.shadingMode=t,this}setDepthCheckEnabled(t){return this.depthCheck=t,this}setDepthWriteEnabled(t){return this.depthWrite=t,this}setSceneBlending(t,s){return this._glBlendSFactor=Gi(t)||WebGLRenderingContext.ONE,this._glBlendDFactor=Gi(s)||WebGLRenderingContext.ZERO,this}}class Xg{constructor(t){this.mat=t,t.o.techniques.set(this.key=t.o.key(),this),this.passes=[new Hg(this)]}pass(t){return t>=0&&t<this.passes.length?this.passes[t]:null}}class Yg{constructor(t,s){this.o=t,this.name=s,this.meshRenderTech=null,this.panelOverlayRenderTech=null,t.materialByKey.set(this.key=t.key(),this),t.materialByName.has(s)||t.materialByName.set(s,this),this.techs=[new Xg(this)]}tech(t){return t>=0&&t<this.techs.length?this.techs[t]:null}_getMeshRenderTech(){return this.meshRenderTech||(this.meshRenderTech=new dg(this)),this.meshRenderTech}_getPanelOverlayRenderTech(){return this.panelOverlayRenderTech||(this.panelOverlayRenderTech=new fg(this)),this.panelOverlayRenderTech}}const nt=ne();class zg extends Kt{constructor(t,s,r,i,n){super(),this.text=t,this.renderTech=s,this.vao=r,this.width=i,this.height=n,this.mvpMatrix=ne(),this.worldCOM=Q(),this.comWorldMatrixVersion=1}getMVPMatrix(t){const{node:s,charHeight:r}=this.text,i=Se(this.mvpMatrix,t._getViewMatrix(),s._getWorldMatrix()),n=Math.hypot(i[0],i[1],i[2])*r,o=Math.hypot(i[4],i[5],i[6])*r,l=-this.width*n,u=this.height*o;return nt[0]=n,nt[5]=o,nt[12]=i[12]+l,nt[13]=i[13]+u,nt[14]=i[14],Se(this.mvpMatrix,t._getProjectionMatrix(),nt)}getWorldCOM(){const t=this.text.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,vs(this.worldCOM,t._getWorldMatrix())),this.worldCOM}getVAO(){return this.vao}getRenderTech(){return this.renderTech}getWorldMatrix(){throw new Error("Method not implemented.")}getWorldNormalMatrix(){throw new Error("Method not implemented.")}isMirrored(){return!1}_onAttached(){this.comWorldMatrixVersion=1}}class Kg extends it{constructor(t,s,r){super(t,r),this.textElement=null,this.textElementCreated=!1,this.color=mt(1,1,1,1),this.charHeight=1,t.movableTexts.set(this.key,this),this.caption=s,this.fontName=r?.fontName||""}destroy(){super.destroy(),this.o.movableTexts.delete(this.key)}setCharHeight(t){return this.charHeight=t,this}_onAttached(){this.textElement?._onAttached()}_setup(t){if(!this.textElementCreated&&(this.textElementCreated=!0,this.caption)){const r=this.o._getFontTexture(this.fontName),{vao:i,width:n,height:o}=Pi(r.glyphData,this.caption);if(i){const l=new gg(r,this);this.textElement=new zg(this,l,i,n,o)}}const{textElement:s}=this;s&&t.textElements.add(s)}}class qg{constructor(t,s=""){this.o=t,this.name=s,this.children=[],this.visible=!1,this.scaleX=1,this.scaleY=1,this.z=0,t.overlays.set(this.key=t.key(),this)}setChildren(t){return this.children.forEach(s=>s.overlay=null),this.children=Array.from(new Set(t)),this.children.forEach(s=>{s.overlay=this,s.parent&&(console.warn("OverlayElement has parent"),s.parent=null)}),this}setZ(t){return this.z=t,this.o.overlayQueue=null,this}setScale(t,s){return this.scaleX=t,this.scaleY=s,this}setVisible(t){return this.visible=t,this.o.overlayQueue=null,this}render(t){const{ctx:s}=t.window,{drawingBufferWidth:r,drawingBufferHeight:i}=s.gl;this.children.forEach(n=>n.drawAt(s,0,0,1,1,r,i))}}class Jg{constructor(t,s){this.window=t,this.bg=ce(.2,.2,.2),this.overlaysEnabled=!0,t.o.viewports.set(this.key=t.o.key(),this),this.camera=s,s._setViewport(this)}setCamera(t){return this.camera!==t&&(this.camera._setViewport(null),this.camera=t._setViewport(this)),this}enableOverlays(t){return this.overlaysEnabled=t,this}setBackground(t,s,r){return ye(this.bg,t,s,r),this}}class Zg{constructor(t,s,r){this.o=t,this.viewports=new Set,this.x=0,this.y=0,this.width=0,this.height=0,this.wheelPosition=0,this.buttonsPressed=[!1,!1,!1,!1],this.mainViewport=null,t.windows.set(this.key=t.key(),this);const i=this.domElement=document.createElement("canvas");this.width=i.width=s,this.height=i.height=r,i.setAttribute("data-render-window-key",this.key.toString());const n=i.getContext("webgl",{alpha:!1,depth:!0,antialias:!0,desynchronized:!1});this.ctx=new wg(n)}close(){this.o.windows.delete(this.key)}createViewport(t,s){const r=new Jg(this,t);if(this.viewports.size)throw Error("Создание нескольких Viewport не реализовано");return this.mainViewport=r,this.viewports.add(r),r}render(t){const{ctx:s}=this,{gl:r}=s;this.viewports.forEach(i=>{const{camera:n}=i;n._updateActualAspect();const{scene:o}=n,{globalLight:l,opaqueElements:u,textElements:d,transparentElements:p}=o._setup(t);if(s.reset(),r.clearColor(...i.bg,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),s.setLighting(o.ambient,l?.node.getWorldPosition()||Di),r.enable(r.DEPTH_TEST),u.render(s,n),r.enable(r.BLEND),p.render(s,n),r.disable(r.DEPTH_TEST),s.useBackFaces(!1),d.render(s,n),i.overlaysEnabled){let E;(E=this.o.overlayQueue)||(E=this.o.overlayQueue=[...this.o.overlays.values()].filter(w=>w.visible).sort((w,T)=>w.z-T.z)),E.forEach(w=>w.render(i))}r.disable(r.BLEND)})}}const Ui=Q(),Wi=Q(),Vi=Q();class Qg extends it{constructor(t,s){super(t.o,s),this.scene=t,this.projectionMatrix=ne(),this.vpMatrix=ne(),this.inverseVPMatrix=ne(),this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.vpWorldMatrixVersion=1,this.shouldUpdateInverseVPMatrix=!0,this.inverseVPWorldMatrixVersion=1,this.viewportAspect=10,this.viewport=null,this.nearDist=1,this.farDist=1e3,this.fov=Math.PI/4,this.aspect=1.3333333333333333,this.autoAspect=!0,t.o.cameras.set(this.key,this),s&&this.set(s)}destroy(){super.destroy(),this.o.cameras.delete(this.key)}useViewportAspect(){return!!this.viewport&&this.autoAspect}_setViewport(t){return this.viewport=t,this}set({farDist:t=this.farDist,fov:s=this.fov,nearDist:r=this.nearDist,aspect:i=this.aspect}){return(this.farDist!==t||this.fov!==s||this.nearDist!==r||this.aspect!==i&&!this.useViewportAspect())&&(this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.shouldUpdateInverseVPMatrix=!0),this.farDist=t,this.fov=s,this.nearDist=r,this.aspect=i,this}_updateActualAspect(){if(!this.autoAspect)return;const{domElement:t}=this.viewport.window,s=t.width/t.height;this.viewportAspect!==s&&(this.viewportAspect=s,this.shouldUpdateProjectionMatrix=!0)}_getViewMatrix(){return this.node?._getInverseWorldMatrix()||Sg}_getProjectionMatrix(){return this.shouldUpdateProjectionMatrix&&(this.shouldUpdateProjectionMatrix=!1,of(this.projectionMatrix,this.fov,this.useViewportAspect()?this.viewportAspect:this.aspect,this.nearDist,this.farDist)),this.projectionMatrix}_getVPMatrix(){const{node:t}=this;return t?((this.shouldUpdateVPMatrix||this.vpWorldMatrixVersion!==t._worldMatrixVersion)&&(this.shouldUpdateVPMatrix=!1,this.vpWorldMatrixVersion=t._worldMatrixVersion,Se(this.vpMatrix,this._getProjectionMatrix(),this._getViewMatrix())),this.vpMatrix):this._getProjectionMatrix()}_getInverseVPMatrix(){const{node:t}=this,s=t?t._worldMatrixVersion:1;return(this.shouldUpdateInverseVPMatrix||this.inverseVPWorldMatrixVersion!==s)&&(this.shouldUpdateInverseVPMatrix=!1,this.inverseVPWorldMatrixVersion=s,yi(this.inverseVPMatrix,this._getVPMatrix())),this.inverseVPMatrix}getRay(t,s,r){const i=this._getInverseVPMatrix(),n=2*t-1,o=1-2*s;return ye(Ui,n,o,-1),Pe(r.origin,Ui,i),ye(Wi,n,o,0),Pe(Vi,Wi,i),Et(r.dir,Vi,r.origin),Vt(r.dir,r.dir),r}_onAttached(){this.vpWorldMatrixVersion=1,this.inverseVPWorldMatrixVersion=1}_setup(){}}class ep extends Kt{constructor(t,s){super(),this.entity=t,this.submesh=s,this.worldCOM=Q(),this.comWorldMatrixVersion=0,this.material=null,this.vertexCount=s.getVertexCount(),this.material=s.getDefaultMaterial()}setMaterial(t){return this.material!==t&&(this.material=t,this._techOrVAOChanged()),this}_setup(t){const{material:s}=this;s&&(s._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}getWorldMatrix(){return this.entity.node._getWorldMatrix()}getWorldNormalMatrix(){return this.entity._getWorldNormalMatrix()}getWorldCOM(){const t=this.entity.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.submesh.getCOM(),t._getWorldMatrix())),this.worldCOM}getVAO(){return this.submesh.getVAO()}getRenderTech(){return this.material._getMeshRenderTech()}isMirrored(){return this.entity.node._isMirrored()}getMVPMatrix(t){return this.entity._getMVPMatrix(t)}_onAttached(){this.comWorldMatrixVersion=0}}const $i=ne();class ji extends it{constructor(t,{submeshes:s},r){super(t.o,r),this.scene=t,this.mvpMatrix=ne(),this.worldNormalMatrix=Wt(),this.normalWorldMatrixVersion=1,t.o.entities.set(this.key,this),this.subEntities=s.map(i=>new ep(this,i))}destroy(){super.destroy(),this.o.entities.delete(this.key)}subEntity(t){return t>=0&&t<this.subEntities.length?this.subEntities[t]:null}_getMVPMatrix(t){return Se(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,Ti($i,t._getInverseWorldMatrix()),wi(this.worldNormalMatrix,$i)),this.worldNormalMatrix}_getClosestIntersection(t){let s=1/0;for(const{submesh:r}of this.subEntities){const i=r.getClosestIntersection(t);s>i&&(s=i)}return s}_onAttached(){this.normalWorldMatrixVersion=1;for(const t of this.subEntities)t._onAttached()}_setup(t){for(const s of this.subEntities)s._setup(t)}}class tp extends Rt{selectProgram(t){return t.meshPrograms[0]}apply(t){const{ctx:s}=t;s.setDepthWrite(!0),s.setDepthCheck(!0),t.setDiffuse(xg),t.setAmbient(Ig)}hasOpacity(){return!1}getProgramCaps(){return st[0]}}const sp=new tp;class rp extends Kt{constructor(t,s,r){super(),this.object=t,this.drawType=s,this.worldCOM=Q(),this.comWorldMatrixVersion=0,this.coords=[],this.normals=[],this.isComplete=!1,this.vao=null,this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0,this.minZ=1/0,this.maxZ=-1/0,this.center=null,this.boundingSphere=null,this.vertexCount=0,this.renderTech=r?._getMeshRenderTech()||sp}addVertex(t,s,r){this.minX=Math.min(this.minX,t),this.maxX=Math.max(this.maxX,t),this.minY=Math.min(this.minY,s),this.maxY=Math.max(this.maxY,s),this.minZ=Math.min(this.minZ,r),this.maxZ=Math.max(this.maxZ,r),this.coords.push(t,s,r),++this.vertexCount}addNormal(t,s,r){this.normals.push(t,s,r)}end(){this.isComplete=!0;const{maxX:t,maxY:s,maxZ:r,minX:i,minY:n,minZ:o}=this,l=(t+i)/2,u=(s+n)/2,d=(r+o)/2;this.center=ce(l,u,d);const p=Math.max(t-i,s-n,r-o)/2;this.boundingSphere=new Bi(this.center,p)}getWorldMatrix(){return this.object.node._getWorldMatrix()}getWorldNormalMatrix(){return this.object._getWorldNormalMatrix()}getWorldCOM(){const t=this.object.node;return t?(this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Pe(this.worldCOM,this.center,t._getWorldMatrix())),this.worldCOM):Di}getVAO(){return this.vao?this.vao:this.vao=new rt({positionSize:3,positions:new Float32Array(this.coords),normals:this.normals.length?new Float32Array(this.normals):null,drawMode:Cg(this.drawType)})}getRenderTech(){return this.renderTech}isMirrored(){return this.object.node._isMirrored()}getMVPMatrix(t){return this.object._getMVPMatrix(t)}getClosestIntersection(t){return this.drawType!==vi||!this.isComplete||!this.boundingSphere.intersectsWith(t)?1/0:Pg(t,this.coords)}_setup(t){this.isComplete&&(this.renderTech.hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}_onAttached(){this.comWorldMatrixVersion=0}}const Hi=ne();class Xi extends it{constructor(t,s){super(t.o,s),this.scene=t,this.mvpMatrix=ne(),this.worldNormalMatrix=Wt(),this.normalWorldMatrixVersion=0,this.sections=[],t.o.manualObjects.set(this.key,this)}destroy(){super.destroy(),this.o.manualObjects.delete(this.key)}createSection(t,s){const r=new rp(this,t,s);return this.sections.push(r),r}clear(){this.sections=[]}_getMVPMatrix(t){return Se(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,Ti(Hi,t._getInverseWorldMatrix()),wi(this.worldNormalMatrix,Hi)),this.worldNormalMatrix}_getClosestIntersection(t){let s=1/0;for(const r of this.sections){const i=r.getClosestIntersection(t);s>i&&(s=i)}return s}_onAttached(){this.normalWorldMatrixVersion=0;for(const t of this.sections)t._onAttached()}_setup(t){for(const s of this.sections)s._setup(t)}}class ip{constructor(t){this.entries=t,this.length=t.length}getEntry(t){const{entries:s}=this;return t>=0&&t<s.length?s[t]:null}sort(){this.entries.sort((t,s)=>t.distance-s.distance)}}class np{constructor(t,s){this.scene=t,this.localMatrix=ne(),this.worldMatrix=ne(),this.inverseWorldMatrix=ne(),this.worldPosition=Q(),this.worldRotation=wt(),this.worldScale=ce(1,1,1),this.mirrored=!1,this.shouldUpdateLocalMatrix=!1,this.shouldUpdateWorldMatrix=!1,this.shouldUpdateInverseWorldMatrix=!1,this.shouldUpdateMirroredInfo=!1,this.shouldUpdateWorldPosition=!1,this.shouldUpdateWorldRotation=!1,this.shouldUpdateWorldScale=!1,this.position=Q(),this.scale=ce(1,1,1),this.rotation=wt(),this._worldMatrixVersion=1,this.children=[],this.parent=null,t.o.nodes.set(this.key=t.o.key(),this),this.name=s?.name??""}destroy(){this.children.forEach(t=>{t.parent=null,t.updateWorldMatrixRecursive()}),this.removeParent(),this.scene.o.nodes.delete(this.key)}getChild(t){const{children:s}=this;return t>=0&&t<s.length?s[t]:null}addChild(t){const s=t.parent;if(s){if(s===this)return this;let r=this.parent;for(;r;){if(r===t)throw Error("SceneNode.addChild: child является родительским узлом текущего узла");r=r.parent}}if(t===this)throw Error("SceneNode.addChild: child является текущим узлом");if(t.scene!==this.scene)throw Error("SceneNode.addChild: child принадлежит другой сцене");return t.removeParent(),this.children.push(t),t.parent=this,t.updateWorldMatrixRecursive(),this}updateWorldMatrixRecursive(){if(!this.shouldUpdateWorldMatrix){this.shouldUpdateWorldMatrix=!0,++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldPosition=!0,this.shouldUpdateWorldRotation=!0,this.shouldUpdateWorldScale=!0;for(const t of this.children)t.updateWorldMatrixRecursive()}}updateLocalMatrix(){this.shouldUpdateLocalMatrix||(this.shouldUpdateLocalMatrix=!0,this.updateWorldMatrixRecursive())}updateChildrenMirroredInfoRecursive(){if(!this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!0;for(const t of this.children)t.updateChildrenMirroredInfoRecursive()}}updateMirroredInfo(){if(this.shouldUpdateMirroredInfo)return;const{scale:t}=this;if(this.mirrored!==Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0){this.shouldUpdateMirroredInfo=!0;for(const s of this.children)s.updateChildrenMirroredInfoRecursive()}}removeParent(){const t=this.parent;return t?(t.children=t.children.filter(s=>s!==this),this.parent=null,this):this}setPosition(t,s,r){return ye(this.position,t,s,r),this.updateLocalMatrix(),this}setRotation(t,s,r,i){return Is(this.rotation,Af(this.rotation,t,s,r,i)),this.updateLocalMatrix(),this}resetRotation(){return bf(this.rotation),this.updateLocalMatrix(),this}rotateX(t){return Rf(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateY(t){return Mf(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateZ(t){return vf(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}setScale(t,s,r){return ye(this.scale,t,s,r),this.updateLocalMatrix(),this.updateMirroredInfo(),this}_getWorldMatrixForRotation(){++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldRotation=!0;for(const t of this.children)t.updateWorldMatrixRecursive();return this.worldMatrix}_getWorldMatrix(){return this.shouldUpdateWorldMatrix&&(this.shouldUpdateWorldMatrix=!1,this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,Oi(this.localMatrix,this.rotation,this.position,this.scale)),this.parent?Se(this.worldMatrix,this.parent._getWorldMatrix(),this.localMatrix):Qd(this.worldMatrix,this.localMatrix)),this.worldMatrix}_getInverseWorldMatrix(){return this.shouldUpdateInverseWorldMatrix&&(this.shouldUpdateInverseWorldMatrix=!1,yi(this.inverseWorldMatrix,this._getWorldMatrix())),this.inverseWorldMatrix}_isMirrored(){if(this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!1;const{scale:t}=this;this.mirrored=Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0,this.parent?._isMirrored()&&(this.mirrored=!this.mirrored)}return this.mirrored}getWorldPosition(){return this.shouldUpdateWorldPosition&&(this.shouldUpdateWorldPosition=!1,vs(this.worldPosition,this._getWorldMatrix())),this.worldPosition}getWorldRotation(){return this.shouldUpdateWorldRotation&&(this.shouldUpdateWorldRotation=!1,rf(this.worldRotation,this._getWorldMatrix())),this.worldRotation}getWorldScale(){return this.shouldUpdateWorldScale&&(this.shouldUpdateWorldScale=!1,bi(this.worldScale,this._getWorldMatrix())),this.worldScale}}const Ws=Q(),Yi=Q(),op=Q(),Jt=Us(),Mt=Q();class zi extends np{constructor(t,s){super(t,s),this.trackingInfo=null,this.movables=[],t.o.sceneNodes.set(this.key,this)}destroy(){super.destroy(),this.movables.forEach(t=>t.node=null),this.scene.o.sceneNodes.delete(this.key)}getMovable(t){const{movables:s}=this;return t>=0&&t<s.length?s[t]:null}attach(t){const s=t.node;if(s){if(s===this)return this;t.detach()}return this.movables.push(t),t.node=this,t._onAttached(this),this}setAutoTracking(t,s,r,i){if(!t)return this.trackingInfo=null,this;let n,o;const{trackingInfo:l}=this;if(l){if(n=l.direction,o=l.orientationMat,l.target===t&&n[0]===s&&n[1]===r&&n[2]===i)return this;ye(n,s,r,i)}else n=ce(s,r,i),o=ne();Vt(Ws,n);const u=_f(Ws,ki);return tt(Yi,Ws,ki),sf(o,u,Yi),this.trackingInfo={target:t,direction:n,orientationMat:o},this}updateTracking(){const{parent:t,trackingInfo:s}=this;if(!s||!t)return;const r=this.getWorldScale(),i=this._getWorldMatrixForRotation();cf(i,this.getWorldPosition(),s.target.getWorldPosition(),Pe(op,Ng,t._getWorldMatrix())),Se(i,i,s.orientationMat),tf(i,i,r)}_setup(t){this.updateTracking();for(const s of this.movables)s.visible&&s._setup(t);for(const s of this.children)s._setup(t)}_findIntersections(t,s){let r=!1;for(const i of this.movables){if(!(i instanceof ji||i instanceof Xi))continue;r||(r=!0,kg(Jt,t,this._getInverseWorldMatrix()));const n=i._getClosestIntersection(Jt);if(n<1/0){lf(Mt,Jt.origin,df(Mt,Jt.dir,n)),Pe(Mt,Mt,this._getWorldMatrix());const o=mf(t.origin,Mt);s.push({movable:i,distance:o})}}for(const i of this.children)i._findIntersections(t,s)}}class cp{constructor(t){this.o=t,this.renderInfo={globalLight:null,opaqueElements:new Mg,transparentElements:new Li,textElements:new Li},this.frameNumber=0,this.ambient=Q(),t.scenes.set(this.key=t.key(),this),this.root=new zi(this)}setAmbient(t,s,r){return ye(this.ambient,t,s,r),this}createSceneNode(t){return new zi(this,t)}createCamera(t){return new Qg(this,t)}createEntity(t,s){return new ji(this,t,s)}createManualObject(t){return new Xi(this,t)}_setup(t){if(this.frameNumber===t)return this.renderInfo;this.frameNumber=t;const{renderInfo:s}=this;return s.globalLight=null,s.opaqueElements.clear(),s.transparentElements.clear(),s.textElements.clear(),this.root._setup(s),s}rayCast(t){const s=[];return this.root._findIntersections(t,s),new ip(s)}}class ap{constructor(){this.windows=new Map,this.scenes=new Map,this.viewports=new Map,this.overlays=new Map,this.overlayElements=new Map,this.entities=new Map,this.manualObjects=new Map,this.nodes=new Map,this.sceneNodes=new Map,this.movables=new Map,this.cameras=new Map,this.billboardSets=new Map,this.lights=new Map,this.movableTexts=new Map,this.materialByKey=new Map,this.materialByName=new Map,this.techniques=new Map,this.passes=new Map,this.texUnits=new Map,this.imageResByNameUC=new Map,this.meshResByNameUC=new Map,this.primaryWindow=null,this.overlayQueue=null,this.fontMap=new Map,this.globalKey=1e3,this.drawNumber=0}_getFontTexture(t){const s=t||"sans-serif",r=s.toUpperCase(),i=this.fontMap.get(r);if(i)return i;const n=new Eg(s);return this.fontMap.set(r,n),n}key(){return++this.globalKey}createRenderWindow(t,s){const r=new Zg(this,t,s);return this.primaryWindow||=r,r}createScene(){return new cp(this)}createMovableText(t,s){return new Kg(this,t,s)}createLight(t){return new $g(this,t)}createBillboardSet(t){return new Bg(this,t)}createMaterial(t){return new Yg(this,t)}createOverlayElement(t,s){switch(t){case"Panel":return new bg(this,s);case"BorderPanel":return new Og(this,s);case"TextArea":return new Rg(this,s);default:throw Error(`createOverlayElement: тип '${t}' не реализован`)}}createOverlay(t){return new qg(this,t)}createMesh(t,s){const r=new Vg(this,t);return this.meshResByNameUC.set(s.toUpperCase(),r),r}createImage(t,s){const r=new Ug(t);return this.imageResByNameUC.set(s.toUpperCase(),r),r}renderAll(){const t=++this.drawNumber;this.windows.forEach(s=>s.render(t))}}const Ki=new Set;function K(...e){Ki.size!==Ki.add(e[0]).size&&console.warn(...e)}function lp(e,t,s,r,i){if(!this.kernel.egor.scenes.get(e))return 0;const o=this.kernel.egor.manualObjects.get(t);if(!o)return 0;const l=o.sections[0];return l.addVertex(s,r,i),l.vertexCount}function hp(e,t,s,r,...i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function up(e,t,s,r,...i){throw K("ApplyTexture3d",e,t,s,r,i),Error("ApplyTexture3d: Функция не реализована")}function dp(e,t,s,r,i,n){if(!this.kernel.egor.scenes.get(e))return 0;const l=this.kernel.egor.cameras.get(t);return l?this.kernel.egor.createRenderWindow(1e3,1e3).createViewport(l).key:0}function fp(e,t,s,r,i,n,o,l,u,d,p,E,w){const T=this.kernel.egor.scenes.get(e);return T?T.createCamera().key:0}function gp(e,t){throw K("CreateDefCamera3d",e,t),Error("CreateDefCamera3d: Функция не реализована")}function pp(e,t,s,r,i,n,o,l,u,d){throw K("CreateMaterial3d",e,t,s,r,i,n,o,l,u,d),Error("CreateMaterial3d: Функция не реализована")}function _p(e){const t=this.kernel.egor.scenes.get(e);if(!t)return 0;const s=t.createManualObject();return s.createSection(vi,null),s.key}function Ep(e,t){throw K("CreateObjectFromFile3d",e,t),Error("CreateObjectFromFile3d: Функция не реализована")}function mp(e){return this.kernel.egor.createScene().key}function wp(e,t,s,r,i,n){throw K("CreateSurface3d",e,t,s,r,i,n),Error("CreateSurface3d: Функция не реализована")}function Tp(e,t,s){throw K("DelPoint3d",e,t,s),Error("DelPoint3d: Функция не реализована")}function yp(e,t,s){throw K("DelPrimitive3d",e,t,s),Error("DelPrimitive3d: Функция не реализована")}function bp(e){throw K("DeleteSpace3d",e),Error("DeleteSpace3d: Функция не реализована")}function Op(e,t){throw K("DuplicateObject3d",e,t),Error("DuplicateObject3d: Функция не реализована")}function Rp(e,t,s,r){throw K("FitToCamera3d",e,t,s,r),Error("FitToCamera3d: Функция не реализована")}function Mp(e,t){throw K("GetActiveCamera3d",e,t),Error("getActiveCamera3d: Функция не реализована")}function vp(e,t,s,r,i){throw K("GetColors3d",e,t,s,r,i),Error("GetColors3d: Функция не реализована")}function Sp(e,t){throw K("GetMaterialByName3d",e,t),Error("GetMaterialByName3d: Функция не реализована")}function Ap(e,t){throw K("GetNumPoints3d",e,t),Error("GetNumPoints3d: Функция не реализована")}function Np(e,t){throw K("GetNumPrimitives3d",e,t),Error("GetNumPrimitives3d: Функция не реализована")}function Ip(e,t,s,r,i,n,o,l){throw K("GetObject3dFromPoint2d",e,t,s,r,n,l),Error("GetObject3dFromPoint2d: Функция не реализована")}function xp(e,t,s,r,i,n,o,l){throw K("GetObjectBase3d",e,t,r,n,l),Error("GetObjectBase3d: Функция не реализована")}function Pp(e,t,s){throw K("GetObjectBase3dM",e,t,s),Error("GetObjectBase3dM: Функция не реализована")}function Lp(e,t){throw K("GetObjectColor3d",e,t),Error("GetObjectColor3d: Функция не реализована")}function Dp(e,t,s){throw K("GetObjectDimension3d",e,t,s),Error("GetObjectDimension3d: Функция не реализована")}function kp(e,t,s){return s}function Cp(e,t,s){throw K("GetObjectPoints3d",e,t,s),Error("GetObjectPoints3d: Функция не реализована")}function Gp(e,t,s,r,i,n,o,l,u){throw K("GetPoint3d",e,t,s,i,o,u),Error("GetPoint3d: Функция не реализована")}function Fp(e,t){throw K("GetSpace3d",e,t),Error("getSpace3d: Функция не реализована")}function Bp(e,t,s,r,i){const n=this.kernel.egor.scenes.get(e);return n?n.createManualObject().key:0}function Up(e,t,s,r,i,n,o,l){throw K("MakeCylinder3d",e,t,s,r,i,n,o,l),Error("MakeCylinder3d: Функция не реализована")}function Wp(e,t,s,r,i,n){throw K("MakeGrid3d",e,t,s,r,i,n),Error("MakeGrid3d: Функция не реализована")}function Vp(e,t,s,r,i,n){throw K("MakeSphere3d",e,t,s,r,i,n),Error("MakeSphere3d: Функция не реализована")}function $p(){K("MakeTore3d")}function jp(e,t,s,r,i,n,o,l){throw K("MakeTube3d",e,t,s,r,i,n,o,l),Error("MakeTube3d: Функция не реализована")}function Hp(e){throw K("PopCrdSystem3d",e),Error("PopCrdSystem3d: Функция не реализована")}function Xp(e){throw K("PushCrdSystem3d",e),Error("PushCrdSystem3d: Функция не реализована")}function Yp(e,t){throw K("RemoveTexture3d",e,t),Error("RemoveTexture3d: Функция не реализована")}function zp(e,t,s,r){throw K("RotateObject3d",e,t,s,r),Error("RotateObject3d: Функция не реализована")}function Kp(e,t,s,r){throw K("RotateObjectPoints3d",e,t,s,r),Error("RotateObjectPoints3d: Функция не реализована")}function qp(e,t){throw K("SelectLocalCrd3d",e,t),Error("SelectLocalCrd3d: Функция не реализована")}function Jp(e,t){throw K("SelectViewCrd3d",e,t),Error("SelectViewCrd3d: Функция не реализована")}function Zp(e){throw K("SelectWorldCrd3d",e),Error("SelectWorldCrd3d: Функция не реализована")}function Qp(e,t,s,r,i){throw K("SetColors3d",e,t,s,r,i),Error("SetColors3d: Функция не реализована")}function e_(e,t,s,r,i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function t_(e,t,s){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function s_(e,t,s){throw K("SetObjectMatrix3d",e,t,s),Error("SetObjectMatrix3d: Функция не реализована")}function r_(e,t,s){throw K("SetObjectPoints3d",e,t,s),Error("SetObjectPoints3d: Функция не реализована")}function i_(e,t,s,r,i,n){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function n_(e,t,s,r,i,...n){return 1}function o_(e,t,s,r,i,n,o,l,u,d,p){throw K("SweepAndExtrude3d",e,t,s,r,i,n,o,l,u,d,p),Error("SweepAndExtrude3d: Функция не реализована")}function c_(){K("SwitchToCamera3d")}function a_(e,t,s,r,i,n){throw K("TransformCamera3d",e,t,s,r,i,n),Error("TransformCamera3d: Функция не реализована")}function l_(e,t,s){throw K("TransformObject3d",e,t,s),Error("TransformObject3d: Функция не реализована")}function h_(e,t,s){throw K("TransformObjectPoints3d",e,t,s),Error("TransformObjectPoints3d: Функция не реализована")}function u_(e,t,s,r){return!this.kernel.egor.scenes.get(t)||!this.kernel.egor.cameras.get(s)?0:1}function d_(e){e("AddPoint3d",{a:[a,a,c,c,c],r:c},lp),e("AddPrimitive3d",{a:[a,a,c,z],rest:[c],r:c},hp),e("ApplyTexture3d",{a:[a,a,a,a],rest:[c],r:c},up),e("Create3dView2d",{a:[a,a,c,c,c,c],r:a},dp),e("CreateCamera3dEx",{a:[a,_,c,c,z,c,c,c,c,c,c,c,c],r:a},fp),e("CreateDefCamera3d",{a:[a,c],r:a},gp),e("CreateMaterial3d",{a:[a,_,_,z,z,z,z,c,c,c],r:a},pp),e("CreateObject3d",{a:[a],r:a},_p),e("CreateObjectFromFile3d",{a:[a,_],r:a},Ep),e("CreateSpace3d",{a:[a],r:a},mp),e("CreateSurface3d",{a:[a,a,c,c,z,c],r:a},wp),e("DelPoint3d",{a:[a,a,c],r:c},Tp),e("DelPrimitive3d",{a:[a,a,c],r:c},yp),e("DeleteSpace3d",{a:[a],r:c},bp),e("DuplicateObject3d",{a:[a,a],r:a},Op),e("FitToCamera3d",{a:[a,a,a,c],r:c},Rp),e("GetActiveCamera3d",{a:[a,a],r:a},Mp),e("GetColors3d",{a:[a,a,c,c,c],r:c},vp),e("GetMaterialByName3d",{a:[a,_],r:a},Sp),e("GetNumPoints3d",{a:[a,a],r:c},Ap),e("GetNumPrimitives3d",{a:[a,a],r:c},Np),e("GetObject3dFromPoint2d",{a:[a,a,c,c,Wa,N],r:a},Ip),e("GetObjectBase3d",{a:[a,a,N,N,N],r:c},xp),e("GetObjectBase3dM",{a:[a,a,c],r:c},Pp),e("GetObjectColor3d",{a:[a,a],r:z},Lp),e("GetObjectDimension3d",{a:[a,a,c],r:c},Dp),e("GetObjectMatrix3d",{a:[a,a,c],r:c},kp),e("GetObjectPoints3d",{a:[a,a,c],r:c},Cp),e("GetPoint3d",{a:[a,a,c,N,N,N],r:c},Gp),e("GetSpace3d",{a:[a,a],r:a},Fp),e("MakeBar3d",{a:[a,z,c,c,c],r:a},Bp),e("MakeCylinder3d",{a:[a,a,z,c,c,c,c,c],r:a},Up),e("MakeGrid3d",{a:[a,c,c,c,c,z],r:a},Wp),e("MakeSphere3d",{a:[a,a,z,c,c,c],r:a},Vp),e("MakeTore3d",{a:[]},$p),e("MakeTube3d",{a:[a,a,z,c,c,c,c,c],r:a},jp),e("PopCrdSystem3d",{a:[a],r:c},Hp),e("PushCrdSystem3d",{a:[a],r:c},Xp),e("RemoveTexture3d",{a:[a,a],r:c},Yp),e("RotateObject3d",{a:[a,a,c,c],r:c},zp),e("RotateObjectPoints3d",{a:[a,a,c,c],r:c},Kp),e("SelectLocalCrd3d",{a:[a,a],r:c},qp),e("SelectViewCrd3d",{a:[a,a],r:c},Jp),e("SelectWorldCrd3d",{a:[a],r:c},Zp),e("SetColors3d",{a:[a,a,c,c,c],r:c},Qp),e("SetObjectBase3d",{a:[a,a,c,c,c],r:c},e_),e("SetObjectColor3d",{a:[a,a,z],r:c},t_),e("SetObjectMatrix3d",{a:[a,a,c],r:c},s_),e("SetObjectPoints3d",{a:[a,a,c],r:c},r_),e("SetPoint3d",{a:[a,a,c,c,c,c],r:c},i_),e("SetPrimitive3d",{a:[a,a,c,c,z],rest:[c],r:c},n_),e("SweepAndExtrude3d",{a:[a,a,c,c,c,c,c,c,c,z,c],r:a},o_),e("SwitchToCamera3d",{a:[]},c_),e("TransformCamera3d",{a:[a,a,c,c,c,c],r:c},a_),e("TransformObject3d",{a:[a,a,c],r:c},l_),e("TransformObjectPoints3d",{a:[a,a,c],r:c},h_),e("_CameraProc3d",{a:[_,a,a,c],r:c},u_)}const f_={name:"graphics3d",deps:["ogre"],register:d_};class Ne{constructor(t){this.minV=Math.floor(t.minV),this.minH=Math.floor(t.minH),this.rows=t.rows,this.cols=t.cols,this.m=t.data?new Float64Array(t.data):new Float64Array(this.rows*this.cols)}isSquare(){return this.cols===this.rows}get(t,s){const r=Math.floor(t)-this.minV,i=Math.floor(s)-this.minH;return r<0||i<0||r>=this.rows||i>=this.cols?0:this.m[r*this.cols+i]}set(t,s,r){const i=Math.floor(t)-this.minV,n=Math.floor(s)-this.minH;return i<0||n<0||i>=this.rows||n>=this.cols?0:(this.m[i*this.cols+n]=r,r)}sum(){return this.m.reduce((t,s)=>t+s,0)}glue(t,s,r){const i=this,n=Math.min(i.minH,t.minH+r),o=Math.min(i.minV,t.minV+s),l=Math.max(i.cols+i.minH,t.cols+t.minH+r),u=Math.max(i.rows+i.minV,t.rows+t.minV+s),d=new Ne({cols:l-n,rows:u-o,minH:n,minV:o});for(let p=t.minV;p<t.rows+t.minV;p++)for(let E=t.minH;E<t.cols+t.minH;E++)d.set(p+s,E+r,t.get(p,E));for(let p=i.minV;p<i.rows+i.minV;p++)for(let E=i.minH;E<i.cols+i.minH;E++)d.set(p,E,i.get(p,E));return d}add(t){const s=this,r=Math.min(s.minH,t.minH),i=Math.min(s.minV,t.minV),n=Math.max(s.cols+s.minH,t.cols+t.minH),l=Math.max(s.rows+s.minV,t.rows+t.minV)-i,u=n-r,d=new Ne({cols:u,rows:l,minH:r,minV:i}),p=Math.min(s.rows,t.rows),E=Math.min(s.cols,t.cols);for(let w=0;w<p;w++)for(let T=0;T<E;T++)d.m[w+u+T]=s.m[w*s.cols+T]+t.m[w+t.cols+T];return d}mul(t){const s=this;if(s.cols!==t.rows)return null;const r=t.cols,i=s.rows,n=new Ne({cols:r,rows:i,minH:s.minH,minV:s.minV});for(let o=0;o<i;o++)for(let l=0;l<r;l++){let u=0;for(let d=0;d<s.cols;d++)u+=s.m[o*s.cols+d]*t.m[d*t.cols+l];n.m[o*r+l]=u}return n}det(){if(!this.isSquare())throw Error("Not a square matrix");const t=this.rows;if(t===1)return this.m[0];if(t===2)return this.m[0]*this.m[3]-this.m[1]*this.m[2];const s=Array.from(this.m);let r=1;for(let i=0;i<t;i++){let n=i,o=Math.abs(s[i*t+i]);for(let l=i+1;l<t;l++){const u=Math.abs(s[l*t+i]);u>o&&(o=u,n=l)}if(o===0)return 0;if(n!==i){r=-r;for(let l=i;l<t;l++){const u=s[i*t+l];s[i*t+l]=s[n*t+l],s[n*t+l]=u}}for(let l=i+1;l<t;l++){const u=s[l*t+i]/s[i*t+i];for(let d=i;d<t;d++)s[l*t+d]-=u*s[i*t+d]}r*=s[i*t+i]}return r}obr(){if(!this.isSquare()||this.det()===0)return null;const t=this.rows,s=new Ne({cols:this.cols,rows:this.rows,minH:0,minV:0,data:Array.from(this.m)}),r=new Ne({cols:this.cols,rows:this.rows,minH:0,minV:0});for(let i=0;i<t;i++)for(let n=0;n<t;n++)r.set(i,n,0),i===n&&r.set(i,n,1);for(let i=0;i<t;i++){let n=s.get(i,i);for(let o=0;o<t;o++)s.set(i,o,s.get(i,o)/n),r.set(i,o,r.get(i,o)/n);for(let o=i+1;o<t;o++){n=s.get(o,i);for(let l=0;l<t;l++)s.set(o,l,s.get(o,l)-s.get(i,l)*n),r.set(o,l,r.get(o,l)-r.get(i,l)*n)}}for(let i=t-1;i>0;i--)for(let n=i-1;n>=0;n--){let o=s.get(n,i);for(let l=0;l<t;l++)s.set(n,l,s.get(n,l)-s.get(i,l)*o),r.set(n,l,r.get(n,l)-r.get(i,l)*o)}return r.minH=this.minH,r.minV=this.minV,r}diag(t){this.fill(0);const s=Math.min(this.rows,this.cols);for(let r=0;r<s;r++)this.set(r,r,t);return 1}fill(t){return this.m.fill(t),1}sortByRow(t,s){const r=t-this.minV;if(r<0||r>=this.rows)return 0;const i=Array.from({length:this.cols},(o,l)=>Array.from({length:this.rows},(u,d)=>this.m[d*this.cols+l])),n=s?(o,l)=>l[r]-o[r]:(o,l)=>o[r]-l[r];return i.sort(n),i.forEach((o,l)=>{o.forEach((u,d)=>{this.m[d*this.cols+l]=u})}),1}sortByColumn(t,s){const r=t-this.minH;if(r<0||r>=this.cols)return 0;const i=Array.from({length:this.rows},(o,l)=>{const u=l*this.cols,d=u+this.cols;return Array.from(this.m.subarray(u,d))}),n=s?(o,l)=>l[r]-o[r]:(o,l)=>o[r]-l[r];return i.sort(n),this.m=new Float64Array(ar(i)),1}data(){const{minH:t,minV:s,cols:r,rows:i,m:n}=this;return{minV:s,minH:t,cols:r,rows:i,data:[...n]}}}function g_(e,t,s,r,i,n){if(n<=0)return 0;const o=Math.floor(s)-Math.floor(t)+1,l=Math.floor(i)-Math.floor(r)+1;if(o<=0||l<=0)return 0;const u=e||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(u,new Ne({rows:o,cols:l,minV:t,minH:r})),u}function p_(e,t){return t<=0?0:this.kernel.matrices.delete(e)?1:0}function __(e,t,s){return s<=0?0:this.kernel.matrices.get(e)?.fill(t)??0}function E_(e,t,s,r){return r<=0?0:this.kernel.matrices.get(e)?.get(t,s)??0}function m_(e,t,s,r,i){return i<=0?0:this.kernel.matrices.get(e)?.set(t,s,r)??0}function w_(e,t){if(t<=0)return 0;throw Error("MEditor: редактор матриц не реализован")}function T_(e,t,s){return s<=0?0:this.kernel.matrices.get(e)?.diag(t)??0}function y_(e,t){if(t<=0)return 0;const s=this.kernel.matrices.get(e);return!s||!s.isSquare()?0:s.det()}function b_(e,t,s,r){if(r<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;const n=this.kernel.matrices.get(t);if(!n)return 0;const o=i.add(n);if(!o)return 0;const l=s||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(l,o),l}function O_(e,t){return t<=0?0:this.kernel.matrices.get(e)?.sum()??0}function R_(e,t,s,r){if(r<=0)return 0;const i=this.kernel.matrices.get(e),n=this.kernel.matrices.get(t);if(!i||!n)return 0;const o=i.mul(n);if(!o)return 0;const l=s||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(l,o),l}function M_(e,t,s,r,i,n){if(n<=0)return 0;const o=this.kernel.matrices.get(e),l=this.kernel.matrices.get(t);if(!o||!l)return 0;const u=s||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(u,o.glue(l,Math.floor(r),Math.floor(i))),u}function v_(e,t,s){if(s<=0)return 0;const r=this.kernel.matrices.get(e);if(!r)return 0;const i=r.obr();if(!i)return 0;const n=t||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(n,i),n}function S_(e,t,s){if(s<=0)return 0;const r=this.kernel.matrices.get(e);if(!r)return 0;const i=this.prj.dir.resolve(t).create("file");return i?(i.set({mat:r.data()}),1):0}function A_(e,t,s){if(s<=0)return 0;const r=this.prj.dir.resolve(t).file()?.mat;if(!r)return 0;const i=e||ge.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(i,new Ne(r)),i}function N_(e,t,s,r){if(r<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;switch(s){case 1:return i.sortByColumn(t,!1);case 2:return i.sortByColumn(t,!0);case 3:return i.sortByRow(t,!1);case 4:return i.sortByRow(t,!0);default:return 0}}function I_(e){e("MCreate",{a:[c,c,c,c,c,c],r:c},g_),e("MDelete",{a:[c,c],r:c},p_),e("MFill",{a:[c,c,c],r:c},__),e("MGet",{a:[c,c,c,c],r:c},E_),e("MPut",{a:[c,c,c,c,c],r:c},m_),e("MEditor",{a:[c,c]},w_),e("MDiag",{a:[c,c,c],r:c},T_),e("MDet",{a:[c,c],r:c},y_),e("MSum",{a:[c,c],r:c},O_),e("MMul",{a:[c,c,c,c],r:c},R_),e("MGlue",{a:[c,c,c,c,c,c],r:c},M_),e("MObr",{a:[c,c,c],r:c},v_),e("MSaveAs",{a:[c,_,c],r:c},S_),e("MLoad",{a:[c,_,c],r:c},A_),e("MSort",{a:[c,c,c,c],r:c},N_),e("MAddC",{a:[c,c,c,c],r:c},b_)}const x_={name:"matrix",register:I_,setup(e){e.matrices=new Map,e.onProjectOpen.add(t=>{t.dir.forEach(s=>{if(!s.mat)return;const r=s.path.basename(),i=parseInt(r.substring(0,r.length-5));isNaN(i)||!i||e.matrices.has(i)||e.matrices.set(i,new Ne(s.mat))},!1)})}};function qi(e,t,s,r,i){const n=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!n)return;const o=this.resolve(s);o?.klass.vars.msg&&n.subscribe(o,r,t,i)}function Ji(e,t,s){const r=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!r)return;const i=this.resolve(t);i?.klass.vars.msg&&r.unsubscribe(i,s)}function P_(e,t){const s=this.kernel.scenes.get(e);if(!s)return;const r=this.resolve(t);r?.klass.vars.msg&&s.setCapture(r)}function L_(){this.kernel.windowSystem.releaseCapture()}function D_(e,t,...s){if(this.kernel.recursionLvl>58)return;let r=null;if(t&&(r=this.kernel.classes.get(t),!r))return;/[\*\?]/.test(e)&&this.kernel._functionNotImplemented("SendMessage с path содержащим '*'/'?'",this);const i=this.resolveMany(e,r);if(!i.length)return;const n=new Array(s.length),o=this.klass.vars,l=i[0].klass.vars;for(let u=0;u<s.length;u+=2){const d=o.get(s[u+0]);if(!d)continue;const p=l.get(s[u+1]);p&&(n[u+0]=d,n[u+1]=p)}i.forEach(u=>{if(u===this)return;for(let b=0;b<n.length;b+=2){const x=n[b+0];if(!x)continue;const L=n[b+1];u.vars.setValue(L,this.vars.getNewValue(x))}++this.kernel.recursionLvl,u.computeSchema(),--this.kernel.recursionLvl;const{map:d,values:{newFloats:p,oldFloats:E,newInts:w,oldInts:T,newStrings:R,oldStrings:A}}=u.vars;for(let b=0;b<d.length;++b){const x=d[b];E[x]=p[x],T[x]=w[x],A[x]=R[x]}for(let b=0;b<n.length;b+=2){const x=n[b+0];if(!x)continue;const L=n[b+1];this.setNewValue(x,u.vars.getNewValue(L))}})}function k_(e){e("RegisterObject",{s:!0,a:[a,a,_,c,c]},qi),e("RegisterObject",{s:!0,a:[_,a,_,c,c]},qi),e("UnregisterObject",{s:!0,a:[a,_,c]},Ji),e("UnregisterObject",{s:!0,a:[_,_,c]},Ji),e("SetCapture",{s:!0,a:[a,_,c]},P_),e("ReleaseCapture",{},L_),e("SendMessage",{s:!0,a:[_,_],rest:[_,_]},D_)}const C_={name:"messages",deps:["windows"],register:k_,setup(e){e.recursionLvl=0}};function G_(e){if(!e)return 0;const t=_e.indexOf(e[0]);return t<0?0:t}function F_(e){return e<0||e>255?"":_e[e]}function Zi(e,t,s=1){e[t]+=s}function Qi(e,t,s=1){e[t]-=s}function B_(e){return e>1?0:e<-1?Math.PI:Math.acos(e)||0}function U_(e){return e>1?Math.PI/2:e<-1?-Math.PI/2:Math.asin(e)||0}function W_(e,t,s){return e.split(t).join(s)}function V_(e,t,s){return e.substring(0,s)===t.substring(0,s)?1:0}function $_(e,t){return t===0?e>=0?0:Math.PI:t>0?-Math.atan(e/t)+Math.PI/2:-Math.atan(e/t)+Math.PI*1.5}function j_(e){return e>0?(Math.log(e)||0)/Math.LN10:-1e100}function H_(e){return e>0?Math.log(e)||0:-1e100}function X_(e,t){return e>0&&t>0?Math.log(t)/Math.log(e)||0:-1e100}function Y_(e,t,s){if(t==="")return-1;for(var r=-1,i=0,n=0;n<s;++n){if(r=e.indexOf(t,i),r<0)return-1;i=r+t.length}return r}function z_(e,t){return e.substring(e.length-t)}function K_(e,t){var s=Math.ceil(10**t);return Math.round(e*s-Number.EPSILON)/s||0}function q_(e,t){return e.substring(t)}function J_(e,t,s){return e.substring(t,Math.max(t,0)+s)}function Z_(e){e("Arccos",{a:[c],r:c},B_),e("Arcsin",{a:[c],r:c},U_),e("Ascii",{a:[_],r:c},G_),e("Change",{a:[_,_,_],r:_},W_),e("Chr",{a:[c],r:_},F_),e("Comparei",{a:[_,_,c],r:c},V_),e("Dec",{a:[N,c]},Qi),e("Dec",{a:[N]},Qi),e("GetangleByXY",{a:[c,c],r:c},$_),e("Inc",{a:[N,c]},Zi),e("Inc",{a:[N]},Zi),e("Lg",{a:[c],r:c},j_),e("Ln",{a:[c],r:c},H_),e("Log",{a:[c,c],r:c},X_),e("Pos",{a:[_,_,c],r:c},Y_),e("Randomize",{a:[c]},ho),e("Right",{a:[_,c],r:_},z_),e("Round",{a:[c,c],r:c},K_),e("Substr",{a:[_,c,c],r:_},J_),e("Substr",{a:[_,c],r:_},q_)}const Q_={name:"misc",register:Z_};function eE(e){const t=this.prj.dir.resolve(e).file()?.video;if(!t)return 0;const s=ge.freeKey(this.kernel.videos);return this.kernel.videos.set(s,t),s}function tE(e,t,s,r,i,n){const o=this.kernel.videos.get(t);if(!o)return 0;const l=this.kernel.scenes.get(e);if(!l)return 0;const u=l.scene;let d=s,p=r;const E=l.matrix;if(E){const R=s*E[2]+r*E[5]+E[8];d=(s*E[0]+r*E[3]+E[6])/R,p=(s*E[1]+r*E[4]+E[7])/R}const w=i>=0||n>=0,T=u.video(o.src,{x:d,y:p,width:Math.max(0,i),height:Math.max(0,n),fixed:w});return u.set({order:u.order.concat(T)}),T.key}function sE(e,t){throw Error("videoSetPos2d: Not implemented")}function rE(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"?s.getPosition()*ti:0}function iE(e,t,s){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.setPosition(s/ti)?1:0}function nE(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.play()?1:0}function oE(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.pause()?1:0}function cE(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.play()?1:0}function aE(e,t){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.stop()?1:0}function lE(){return P.MCIERR_INVALID_DEVICE_NAME}function hE(){return""}function uE(){return 0}function dE(e){e("OpenVideo",{a:[_,c],r:a},eE),e("CreateVideoFrame2d",{a:[a,a,c,c,c,c,c],r:a},tE),e("VideoSetPos2d",{a:[a,c],r:c},sE),e("FrameGetPos2d",{a:[a,a],r:c},rE),e("FrameSetPos2d",{a:[a,a,c],r:c},iE),e("VideoPlay2d",{a:[a,a,c,c,c,c],r:c},nE),e("VideoPause2d",{a:[a,a],r:c},oE),e("VideoResume2d",{a:[a,a],r:c},cE),e("VideoStop2d",{a:[a,a],r:c},aE),e("MciSendString",{a:[_],r:c},lE),e("MciSendStringStr",{a:[_],r:_},hE),e("SndPlaySound",{a:[_,c],r:c},uE)}const fE={name:"multimedia",deps:["windows"],register:dE,setup(e){e.videos=new Map}},gE=new Map([["ShiftLeft",16],["ShiftRight",16],["ControlLeft",17],["ControlRight",17],["AltLeft",18],["AltRight",18],["CapsLock",20],["Tab",9],["Enter",13],["Escape",27],["Space",32],["Backspace",8],["ArrowUp",38],["ArrowDown",40],["ArrowLeft",37],["ArrowRight",39],["MetaLeft",91],["MetaRight",92],["ContextMenu",93],["Delete",46],["Insert",45],["Home",36],["End",35],["PageUp",33],["PageDown",34],["F1",112],["F2",113],["F3",114],["F4",115],["F5",116],["F6",117],["F7",118],["F8",119],["F9",120],["F10",121],["F11",122],["F12",123],["Digit0",48],["Digit1",49],["Digit2",50],["Digit3",51],["Digit4",52],["Digit5",53],["Digit6",54],["Digit7",55],["Digit8",56],["Digit9",57],["KeyA",65],["KeyB",66],["KeyC",67],["KeyD",68],["KeyE",69],["KeyF",70],["KeyG",71],["KeyH",72],["KeyI",73],["KeyJ",74],["KeyK",75],["KeyL",76],["KeyM",77],["KeyN",78],["KeyO",79],["KeyP",80],["KeyQ",81],["KeyR",82],["KeyS",83],["KeyT",84],["KeyU",85],["KeyV",86],["KeyW",87],["KeyX",88],["KeyY",89],["KeyZ",90]]);function pE(e){if(e>=16&&e<=18||e>=112&&e<=135||e>=37&&e<=40)return!1;switch(e){case 27:case 9:case 20:case 144:case 145:case 42:case 19:case 45:case 46:case 36:case 35:case 33:case 34:case 93:case 91:case 92:return!1}return!0}const ot=new Uint8Array(256);function Vs(e){return e>=0&&e<256?!!ot[e]:!1}function Zt(e){ot[1]=e.buttons&1,ot[2]=e.buttons&2,ot[4]=e.buttons&4}const en=new Set;function tn(e){let t=gE.get(e.code);if(t?ot[t]=+(e.type==="keydown"):(en.has(e.code)||(en.add(e.code),console.warn(`Неизвестная клавиша: ${e.code}`)),t=0),e.winVKey=t,e.type==="keydown"&&pE(t)){const s=_e.indexOf(e.key);e.winChar=s<0?t:s}}function _E(){ot.fill(0)}window.addEventListener("keydown",tn,{capture:!0}),window.addEventListener("keyup",tn,{capture:!0}),window.addEventListener("pointerdown",Zt,{capture:!0}),window.addEventListener("pointerup",Zt,{capture:!0}),window.addEventListener("pointermove",Zt,{capture:!0}),window.addEventListener("pointercancel",Zt,{capture:!0}),window.addEventListener("blur",_E);const sn=Symbol("renderWindow.parent");let EE=0,mE=0,wE=0,TE=0,yE=0,bE=0,OE=0,RE=0;const rn=new Set;function O(...e){rn.size!==rn.add(e[0]).size&&console.warn(...e)}const ME=Us(),$s=Us();function vE(e,t){O("AnimationState_AddTime",e,t)}function SE(e){throw O("AnimationState_GetEnabled",e),Error("Not implemented")}function AE(e){throw O("AnimationState_GetLength",e),Error("Not implemented")}function NE(e){throw O("AnimationState_GetLoop",e),Error("Not implemented")}function IE(e){throw O("AnimationState_GetTimePosition",e),Error("Not implemented")}function xE(e){throw O("AnimationState_GetWeight",e),Error("Not implemented")}function PE(e,t){O("AnimationState_SetEnabled",e,t)}function LE(e,t){O("AnimationState_SetLength",e,t)}function DE(e,t){O("AnimationState_SetLoop",e,t)}function kE(e,t){O("AnimationState_SetTimePosition",e,t)}function CE(e,t){O("AnimationState_SetWeight",e,t)}function GE(e,t,s,r,i){throw O("Billboard_GetColour",e,t,s,r,i),Error("Not implemented")}function FE(e,t,s,r){throw O("Billboard_GetPosition",e),Error("Not implemented")}function BE(e){throw O("Billboard_GetRotation",e),Error("Not implemented")}function UE(e,t,s,r,i){O("Billboard_SetColour",e,t,s,r,i)}function WE(e,t,s,r){O("Billboard_SetPosition",e,t,s,r)}function VE(e,t){O("Billboard_SetRotation",e,t)}function $E(e,t,s){return this.kernel.egor.createBillboardSet({name:t||"__BillboardSet_"+EE++,poolSize:s}).key??0}function jE(e,t,s,r){return this.kernel.egor.billboardSets.get(e)?.createBillboard(t,s,r).key??0}function HE(e){O("BillboardSet_Destroy",e)}function XE(e,t){throw O("BillboardSet_GetBillboard",e,t),Error("Not implemented")}function YE(e){throw O("BillboardSet_GetBillboardType",e),Error("Not implemented")}function zE(e,t,s,r){throw O("BillboardSet_GetCommonDirection",e,t,s,r),Error("Not implemented")}function KE(e,t,s,r){throw O("BillboardSet_GetCommonUpVector",e,t,s,r),Error("Not implemented")}function qE(e,t,s){throw O("BillboardSet_GetDefaultDimensions",e,t,s),Error("Not implemented")}function JE(e,t){throw O("BillboardSet_GetMaterialName",e,t),Error("Not implemented")}function ZE(e){throw O("BillboardSet_GetNumBillboards",e),Error("Not implemented")}function QE(e,t){O("BillboardSet_RemoveBillboard",e,t)}function em(e,t){this.kernel.egor.billboardSets.get(e)?.setType(t)}function tm(e,t,s,r){this.kernel.egor.billboardSets.get(e)?.setCommonDirection(t,s,r)}function sm(e,t,s,r){this.kernel.egor.billboardSets.get(e)?.setCommonUpVector(t,s,r)}function rm(e,t,s){this.kernel.egor.billboardSets.get(e)?.setDimensions(t,s)}function im(e,t){this.kernel.egor.billboardSets.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function nm(e){throw O("Bone_GetManuallyControlled",e),Error("Not implemented")}function om(e){O("Bone_Reset",e)}function cm(e,t){O("Bone_SetManuallyControlled",e,t)}function am(e,t){return this.kernel.egor.scenes.get(e)?.createCamera({name:t||"__Camera_"+mE++}).key??0}function lm(e){O("Camera_Destroy",e)}function hm(e){throw O("Camera_GetAspectRatio",e),Error("Not implemented")}function um(e){throw O("Camera_GetFarClipDistance",e),Error("Not implemented")}function dm(e){throw O("Camera_GetFOV",e),Error("Not implemented")}function fm(e){throw O("Camera_GetNearClipDistance",e),Error("Not implemented")}function gm(e){throw O("Camera_GetPolygonMode",e),Error("Not implemented")}function pm(e){throw O("Camera_GetProjectionType",e),Error("Not implemented")}function _m(e,t){O("Camera_SetAspectRatio",e,t)}function Em(e,t){this.kernel.egor.cameras.get(e)?.set({farDist:t})}function mm(e,t){O("Camera_SetFocalLength",e,t)}function wm(e,t){this.kernel.egor.cameras.get(e)?.set({fov:t})}function Tm(e,t,s){O("Camera_SetFrustumOffset",e,t,s)}function ym(e,t){this.kernel.egor.cameras.get(e)?.set({nearDist:t})}function bm(e,t){O("Camera_SetPolygonMode",e,t)}function Om(e,t){O("Camera_SetProjectionType",e,t)}function Rm(e){return this.kernel.egorRayCastResult?.getEntry(e)?.distance||0}function Mm(e){return this.kernel.egorRayCastResult?.getEntry(e)?.movable.key||0}function vm(){return this.kernel.egorRayCastResult?.length||0}function Sm(e,t,s,r,i,n,o){const l=this.kernel.egor.scenes.get(e);if(!l){this.kernel.egorRayCastResult=null;return}const{dir:u,origin:d}=$s;d[0]=t,d[1]=s,d[2]=r,u[0]=i,u[1]=n,u[2]=o,this.kernel.egorRayCastResult=l?.rayCast($s)}function Am(){this.kernel.egorRayCastResult?.sort()}function Nm(e){throw O("Compositor_GetEnabled",e),Error("Not implemented")}function Im(e,t){O("Compositor_SetEnabled",e,t)}function xm(e,t,s){if(!s)return 0;const r=this.kernel.egor.scenes.get(e);if(!r)return 0;const i=this.kernel.egor.meshResByNameUC.get(s.toUpperCase());if(!i)throw Error(`Mesh не существует: '${s}'`);return r.createEntity(i,{name:t||"__Entity_"+wE++}).key??0}function Pm(e){this.kernel.egor.entities.get(e)?.destroy()}function Lm(e,t){throw O("Entity_GetAnimationState",e,t),Error("Not implemented")}function Dm(e,t){throw O("Entity_GetBone",e,t),Error("Not implemented")}function km(e,t){throw O("Entity_GetIndexCount",e,t),Error("Not implemented")}function Cm(e,t,s){throw O("Entity_GetMaterial",e,t,s),Error("Not implemented")}function Gm(e){return this.kernel.egor.entities.get(e)?.subEntities.length??0}function nn(e,t=0){const s=this.kernel.egor.entities.get(e);return s?t>=0?s.subEntity(t)?.vertexCount??0:s.subEntities.reduce((r,i)=>r+i.vertexCount,0):0}function Fm(e,t,s){const r=this.kernel.egor.entities.get(e);if(!r)return;const i=this.kernel.egor.materialByName.get(s);i&&r.subEntity(t)?.setMaterial(i)}function Bm(e,t){return this.kernel.egor.createLight({name:t||"__Light_"+TE++}).key??0}function Um(e){O("Light_Destroy",e)}function Wm(e){throw O("Light_GetPowerScale",e),Error("Not implemented")}function Vm(e,t,s,r,i){O("Light_SetAttenuation",e,t,s,r,i)}function $m(e,t,s,r){O("Light_SetDiffuseColour",e,t,s,r)}function jm(e,t){O("Light_SetPowerScale",e,t)}function Hm(e,t,s,r){O("Light_SetSpecularColour",e,t,s,r)}function Xm(e,t,s,r){O("Light_SetSpotlightRange",e,t,s,r)}function Ym(e,t){O("Light_SetType",e,t)}function zm(e,t,s){const{egor:r}=this.kernel,i=r.manualObjects.get(e);if(!i)return;const n=r.materialByName.get(t)||null,o=i.createSection(s,n);this.kernel.egorManualObjectsSections.set(i,o)}function Km(e){this.kernel.egor.manualObjects.get(e)?.clear()}function qm(e,t,s,r,i){O("ManualObject_Colour",e,t,s,r,i)}function Jm(e,t){O("ManualObject_ConvertToMesh",e,t)}function Zm(e,t){return this.kernel.egor.scenes.get(e)?.createManualObject({name:t||"__ManualObject_"+yE++}).key||0}function Qm(e){this.kernel.egor.manualObjects.get(e)?.destroy()}function e0(e){const t=this.kernel.egor.manualObjects.get(e);if(!t)return;const s=this.kernel.egorManualObjectsSections.get(t);s&&(s.end(),this.kernel.egorManualObjectsSections.delete(t))}function t0(e,t){O("ManualObject_EstimateIndexCount",e,t)}function s0(e,t){O("ManualObject_EstimateVertexCount",e,t)}function r0(e){throw O("ManualObject_GetDynamic",e),Error("Not implemented")}function i0(e,t){O("ManualObject_Index",e,t)}function n0(e,t,s,r){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addNormal(t,s,r)}function o0(e,t,s,r){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addVertex(t,s,r)}function c0(e,t){O("ManualObject_SetDynamic",e,t)}function a0(e,t,s){O("ManualObject_TextureCoord",e,t,s)}function l0(e){return this.kernel.egor.createMaterial(e||"__Material_"+bE++).key}function h0(e){return e&&this.kernel.egor.materialByName.get(e)?.key||0}function u0(e){throw O("Material_GetBestTechnique",e),Error("Not implemented")}function d0(e,t){throw O("Material_GetName",e,t),Error("Not implemented")}function f0(e,t){return this.kernel.egor.materialByKey.get(e)?.tech(t)?.key??0}function g0(e,t){throw O("Material_GetTechniqueByName",e,t),Error("Not implemented")}function p0(e,t,s,r,i,n,o){throw O("Movable_GetBoundingBox",e,t,s,r,i,n,o),Error("Not implemented")}function _0(e){throw O("Movable_GetCastShadows",e),Error("Not implemented")}function E0(e,t,s){const r=this.kernel.egor.movables.get(e);r&&(t[s]=r.name)}function m0(e){return this.kernel.egor.movables.get(e)?.node?.key??0}function w0(e){const t=this.kernel.egor.movables.get(e);return t?t.visible?1:0:-1}function T0(e,t){O("Movable_SetCastShadows",e,t)}function y0(e,t){const s=this.kernel.egor.movables.get(e);s&&this.kernel.egor.sceneNodes.get(t)?.attach(s)}function b0(e,t){this.kernel.egor.movables.get(e)?.setVisible(!!t)}function O0(e,t,s){return this.kernel.egor.createMovableText(t,{name:e||"__MovableText_"+OE++,fontName:s}).key}function R0(e){O("MovableText_Destroy",e)}function M0(e,t){throw O("MovableText_GetCaption",e,t),Error("Not implemented")}function v0(e){throw O("MovableText_GetCharacterHeight",e),Error("Not implemented")}function S0(e,t,s,r,i){throw O("MovableText_GetColor",e,t,s,r,i),Error("Not implemented")}function A0(e,t){throw O("MovableText_GetFontName",e,t),Error("Not implemented")}function N0(e,t,s,r){throw O("MovableText_GetGlobalTranslation",e,t,s,r),Error("Not implemented")}function I0(e,t,s,r){throw O("MovableText_GetLocalTranslation",e,t,s,r),Error("Not implemented")}function x0(e){throw O("MovableText_GetSpaceWidth",e),Error("Not implemented")}function P0(e,t,s){throw O("MovableText_GetTextAlignment",e,t,s),Error("Not implemented")}function L0(e,t){O("MovableText_SetCaption",e,t)}function D0(e,t){this.kernel.egor.movableTexts.get(e)?.setCharHeight(t)}function k0(e,t,s,r,i){O("MovableText_SetColor",e,t,s,r,i)}function C0(e,t){O("MovableText_SetFontName",e,t)}function G0(e,t,s,r){O("MovableText_SetGlobalTranslation",e,t,s,r)}function F0(e,t,s,r){O("MovableText_SetLocalTranslation",e,t,s,r)}function B0(e,t){O("MovableText_SetSpaceWidth",e,t)}function U0(e,t,s){O("MovableText_SetTextAlignment",e,t,s)}function W0(e,t){O("Node_AddChild",e,t)}function V0(e,t){return this.kernel.egor.nodes.get(e)?.getChild(t)?.key||0}function $0(e,t,s,r,i,n,o){const l=this.kernel.egor.nodes.get(e);if(!l)return;const u=l.getWorldPosition();t[s]=u[0],r[i]=u[1],n[o]=u[2]}function j0(e,t,s,r,i,n,o,l,u){const d=this.kernel.egor.nodes.get(e);if(!d)return;const p=d.getWorldRotation();r[i]=p[0],n[o]=p[1],l[u]=p[2],t[s]=p[3]}function H0(e,t,s,r,i,n,o){const l=this.kernel.egor.nodes.get(e);if(!l)return;const u=l.getWorldScale();t[s]=u[0],r[i]=u[1],n[o]=u[2]}function X0(e,t,s){t[s]=this.kernel.egor.nodes.get(e)?.name??""}function Y0(e){return this.kernel.egor.nodes.get(e)?.children.length??-1}function z0(e){throw O("Node_GetParent",e),Error("Not implemented")}function K0(e,t,s,r,i,n,o){const l=this.kernel.egor.nodes.get(e);l&&(t[s]=l.position[0],r[i]=l.position[1],n[o]=l.position[2])}function q0(e,t,s,r,i,n,o,l,u){const d=this.kernel.egor.nodes.get(e);d&&(r[i]=d.rotation[0],n[o]=d.rotation[1],l[u]=d.rotation[2],t[s]=d.rotation[3])}function J0(e,t,s,r,i,n,o){const l=this.kernel.egor.nodes.get(e);l&&(t[s]=l.scale[0],r[i]=l.scale[1],n[o]=l.scale[2])}function Z0(e,t){O("Node_RemoveChild",e,t)}function Q0(e,t){const s=this.kernel.egor.nodes.get(t);if(!s)return;const r=this.kernel.egor.nodes.get(e);r&&s.addChild(r)}function ew(e,t,s,r){this.kernel.egor.nodes.get(e)?.setPosition(t,s,r)}function tw(e,t,s,r,i){throw O("Node_SetRotationAxis",e,t,s,r,i),Error("Node_SetRotationAxis")}function sw(e,t,s,r){this.kernel.egor.nodes.get(e)?.resetRotation().rotateX(t).rotateY(s).rotateZ(r)}function rw(e,t,s,r){throw Error()}function iw(e,t,s,r){this.kernel.egor.nodes.get(e)?.resetRotation().rotateY(t).rotateX(s).rotateZ(r)}function nw(e,t,s,r){throw Error()}function ow(e,t,s,r){throw Error()}function cw(e,t,s,r){this.kernel.egor.nodes.get(e)?.resetRotation().rotateZ(t).rotateY(s).rotateX(r)}function aw(e,t,s,r,i){this.kernel.egor.nodes.get(e)?.setRotation(s,r,i,t)}function lw(e,t,s,r){this.kernel.egor.nodes.get(e)?.setScale(t,s,r)}function hw(e,t){const s=this.kernel.egor.overlays.get(e);if(!s)return;const r=this.kernel.egor.overlayElements.get(t);r&&s.setChildren(s.children.concat(r))}function uw(e){return this.kernel.egor.createOverlay(e).key}function dw(e,t,s){throw O("Overlay_FindElementAt",e,t,s),Error("Not implemented")}function fw(e){if(!e)return 0;for(const t of this.kernel.egor.overlays.values())if(t.name===e)return t.key;return 0}function gw(e,t){throw O("Overlay_GetName",e,t),Error("Not implemented")}function pw(e){throw O("Overlay_GetRotate",e),Error("Not implemented")}function _w(e,t,s){throw O("Overlay_GetScale",e,t,s),Error("Not implemented")}function Ew(e,t,s){throw O("Overlay_GetScroll",e,t,s),Error("Not implemented")}function mw(e){throw O("Overlay_GetVisible",e),Error("Not implemented")}function ww(e){throw O("Overlay_GetZOrder",e),Error("Not implemented")}function Tw(e,t){O("Overlay_RemoveChild",e,t)}function yw(e,t){O("Overlay_SetRotate",e,t)}function bw(e,t,s){this.kernel.egor.overlays.get(e)?.setScale(t,s)}function Ow(e,t,s){O("Overlay_SetScroll",e,t,s)}function Rw(e,t){this.kernel.egor.overlays.get(e)?.setVisible(!!t)}function Mw(e,t){this.kernel.egor.overlays.get(e)?.setZ(t)}function vw(e,t){const s=this.kernel.egor.overlayElements.get(e);if(!s)return;const r=this.kernel.egor.overlayElements.get(t);r&&s.setChildren(s.children.concat(r))}function Sw(e,t){throw O("OverlayContainer_GetChild",e,t),Error("Not implemented")}function Aw(e){throw O("OverlayContainer_GetChildCount",e),Error("Not implemented")}function Nw(e,t){O("OverlayContainer_RemoveChild",e,t)}function Iw(e,t){if(e!=="BorderPanel"&&e!=="Panel"&&e!=="TextArea")throw Error(`Неизвестный тип OverlayElement: '${e}'`);return this.kernel.egor.createOverlayElement(e,{name:t}).key}function xw(e){if(!e)return 0;for(const t of this.kernel.egor.overlayElements.values())if(t.name===e)return t.key;return 0}function Pw(e,t,s,r,i){const n=this.kernel.egor.overlayElements.get(e);t[s]=n?.horAlign??0,r[i]=n?.vertAlign??0}function Lw(e,t,s){t[s]=this.kernel.egor.overlayElements.get(e)?.caption??""}function Dw(e,t,s,r,i){throw O("OverlayElement_GetColour",e,t,s,r,i),Error("Not implemented")}function kw(e,t,s){t[s]=this.kernel.egor.overlayElements.get(e)?.material?.name??""}function Cw(e){return this.kernel.egor.overlayElements.get(e)?.metricsMode??0}function Gw(e){return this.kernel.egor.overlayElements.get(e)?.parent?.key??0}function Fw(e,t,s,r,i){const n=this.kernel.egor.overlayElements.get(e);t[s]=n?.x??0,r[i]=n?.y??0}function Bw(e,t,s,r,i){const n=this.kernel.egor.overlayElements.get(e);t[s]=n?.width??0,r[i]=n?.height??0}function Uw(e){const t=this.kernel.egor.overlayElements.get(e);return t?t.visible?1:0:-1}function Ww(e){throw O("OverlayElement_IsContainer",e),Error("Not implemented")}function Vw(e,t,s){this.kernel.egor.overlayElements.get(e)?.setAlignment(t,s)}function $w(e,t){this.kernel.egor.overlayElements.get(e)?.setCaption(t)}function jw(e,t,s,r,i){this.kernel.egor.overlayElements.get(e)?.setColor(t,s,r,i)}function Hw(e,t){this.kernel.egor.overlayElements.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function Xw(e,t){this.kernel.egor.overlayElements.get(e)?.setMetricsMode(t)}function Yw(e,t,s){this.kernel.egor.overlayElements.get(e)?.setPosition(t,s)}function zw(e,t,s){this.kernel.egor.overlayElements.get(e)?.setSize(t,s)}function Kw(e,t){this.kernel.egor.overlayElements.get(e)?.setVisible(!!t)}function qw(e,t,s){throw O("ParticleSystem_Create",e,t,s),Error("Not implemented")}function Jw(e,t,s){throw O("ParticleSystem_CreateEx",e,t,s),Error("Not implemented")}function Zw(e){O("ParticleSystem_Destroy",e)}function Qw(e,t){O("ParticleSystem_GetName",e,t)}function eT(e){throw O("ParticleSystem_GetParent",e),Error("Not implemented")}function tT(e){throw O("ParticleSystem_GetVisible",e),Error("Not implemented")}function sT(e,t){O("ParticleSystem_SetParent",e,t)}function rT(e,t){O("ParticleSystem_SetVisible",e,t)}function iT(e,t){throw O("Pass_Create",e,t),Error("Not implemented")}function nT(e,t,s){throw O("Pass_GetAlphaRejectSettings",e,t,s),Error("Not implemented")}function oT(e,t,s,r,i){throw O("Pass_GetAmbient",e,t,s,r,i),Error("Not implemented")}function cT(e){throw O("Pass_GetColourWriteEnabled",e),Error("Not implemented")}function aT(e){throw O("Pass_GetCullingMode",e),Error("Not implemented")}function lT(e){throw O("Pass_GetDepthCheckEnabled",e),Error("Not implemented")}function hT(e){throw O("Pass_GetDepthFunction",e),Error("Not implemented")}function uT(e){throw O("Pass_GetDepthWriteEnabled",e),Error("Not implemented")}function dT(e,t,s,r,i){throw O("Pass_GetDiffuse",e,t,s,r,i),Error("Not implemented")}function fT(e){throw O("Pass_GetLightingEnabled",e),Error("Not implemented")}function gT(e){throw O("Pass_GetPolygonMode",e),Error("Not implemented")}function pT(e,t,s){throw O("Pass_GetSceneBlending",e,t,s),Error("Not implemented")}function _T(e,t,s,r,i){throw O("Pass_GetSelfIllumination",e,t,s,r,i),Error("Not implemented")}function ET(e){throw O("Pass_GetShadingMode",e),Error("Not implemented")}function mT(e){throw O("Pass_GetShininess",e),Error("Not implemented")}function wT(e,t,s,r,i){throw O("Pass_GetSpecular",e,t,s,r,i),Error("Not implemented")}function TT(e,t){throw O("Pass_GetTextureUnitStateByIndex",e,t),Error("Not implemented")}function yT(e,t){throw O("Pass_GetTextureUnitStateByName",e,t),Error("Not implemented")}function bT(e,t,s){O("Pass_SetAlphaRejectSettings",e,t,s)}function OT(e,t,s,r){this.kernel.egor.passes.get(e)?.setAmbient(t,s,r)}function RT(e,t){O("Pass_SetColourWriteEnabled",e,t)}function MT(e,t){O("Pass_SetCullingMode",e,t)}function vT(e,t){this.kernel.egor.passes.get(e)?.setDepthCheckEnabled(!!t)}function ST(e,t){O("Pass_SetDepthFunction",e,t)}function AT(e,t){this.kernel.egor.passes.get(e)?.setDepthWriteEnabled(!!t)}function NT(e,t,s,r,i){this.kernel.egor.passes.get(e)?.setDiffuse(t,s,r,i)}function IT(e,t){this.kernel.egor.passes.get(e)?.setLightingEnabled(!!t)}function xT(e,t){O("Pass_SetPolygonMode",e,t)}function PT(e,t,s){this.kernel.egor.passes.get(e)?.setSceneBlending(t,s)}function LT(e,t,s,r){this.kernel.egor.passes.get(e)?.setEmissive(t,s,r)}function DT(e,t){this.kernel.egor.passes.get(e)?.setShadingMode(t)}function kT(e,t){this.kernel.egor.passes.get(e)?.setShininess(t)}function CT(e,t,s,r,i){this.kernel.egor.passes.get(e)?.setSpecular(t,s,r,i)}function GT(e,t,s){throw O("RenderTexture_Create",e,t,s),Error("Not implemented")}function FT(e){O("RenderTexture_Destroy",e)}function on(e,t,s,r){const i=e.createRenderWindow(s,r);return t.createFrame(i.domElement).onDisposed.add(i.close.bind(i)),i[sn]=t,i}function BT(e){const t=this.kernel.scenes.get(e);if(!t)throw Error("Внешние 3D окна не поддерживаются");return on(this.kernel.egor,t,t.clientWidth,t.clientHeight).key}function UT(e,t,s,r){const i=this.kernel.scenes.get(e);if(!i)throw Error("Внешние 3D окна не поддерживаются");return on(this.kernel.egor,i,s,r).key}function WT(e,t,s,r){throw O("RenderWindow_CreateEx",e,t,s,r),Error("Not implemented")}function VT(e){O("RenderWindow_Destroy",e)}function $T(e){throw O("RenderWindow_Get",e),Error("Not implemented")}function jT(){throw O("RenderWindow_GetCount"),Error("Not implemented")}function HT(e){throw O("RenderWindow_GetCursorHovered",e),Error("Not implemented")}function XT(e,t,s,r,i){const n=this.kernel.egor.windows.get(e)?.[sn];t[s]=n?.mouseX??0,r[i]=n?.mouseY??0}function YT(e,t){return Vs(t)?1:0}function zT(e,t){const s=t===0?"left":t===1?"right":t===2?"middle":null;return Vs(s==="left"?1:s==="right"?2:4)?1:0}function KT(e,t,s,r,i){const n=this.kernel.egor.windows.get(e);t[s]=n?.x??0,r[i]=n?.y??0}function qT(){return this.kernel.egor.primaryWindow?.key??0}function JT(e,t,s,r,i){const n=this.kernel.egor.windows.get(e);t[s]=n?.width??0,r[i]=n?.height??0}function ZT(e,t){throw O("RenderWindow_GetViewport",e,t),Error("Not implemented")}function QT(e){return this.kernel.egor.windows.get(e)?.viewports.size??0}function ey(e){return this.kernel.egor.windows.get(e)?.wheelPosition??0}function ty(e,t,s){O("RenderWindow_SetPosition",e,t,s)}function sy(e,t,s){O("RenderWindow_SetSize",e,t,s)}function ry(e){throw O("RenderWindow_ToggleFullscreen",e),Error("Not implemented")}function iy(e,t,s,r){O("Root_AddResourceLocation",e,t,s,r)}function ny(e){si(this.prj.dir.resolve(e))?.split(`\r
`).forEach(s=>{const r=s.trim().toUpperCase();if(!r.startsWith("FILESYSTEM")&&!r.startsWith("ZIP"))return;const i=r.split("=")[1].trim();this.prj.dir.resolve(i).forEach(o=>{if(o.image){const l=o.path.basename(),u=this.kernel.egor.createImage(o.image,l);u.meta=o.path.toString();return}if(o.mesh){const l=o.path.basename(),u=this.kernel.egor.createMesh(o.mesh,l);u.meta=o.path.toString();return}if(o.base64){const l=o.path.basename().toUpperCase(),u=si(o.path);if(l.endsWith(".MATERIAL")){const d=u.split(`
`).map(p=>p.trim());for(let p=0;p<d.length;p++){const E=d[p],w=E.startsWith("material ")&&E.replace("material ","").split('"').join("");if(!w)continue;const R=this.kernel.egor.createMaterial(w).techs[0].passes[0];for(let A=p+1;A<d.length;A++){const b=d[A];if(b==="}")break;const x=b.startsWith("shading ")&&b.replace("shading ","");if(x){const C=x.toLowerCase()==="phong"?P.SO_PHONG:P.SO_GOURAUD;R.setShadingMode(C);continue}const L=b.startsWith("ambient ")&&b.replace("ambient ","");if(L){const C=L.split(" ").map(parseFloat);if(C.length<3||C.some(isNaN))continue;R.setAmbient(...C);continue}const k=b.startsWith("diffuse ")&&b.replace("diffuse ","");if(k){const C=k.split(" ").map(parseFloat);if(C.length<4||C.some(isNaN))continue;R.setDiffuse(...C);continue}const U=b.startsWith("specular ")&&b.replace("specular ","");if(U){const C=U.split(" ").map(parseFloat);if(C.length<4||C.some(isNaN))continue;R.setSpecular(...C),C.length>4&&R.setShininess(C[4]);continue}const B=b.startsWith("emissive ")&&b.replace("emissive ","");if(B){const C=B.split(" ").map(parseFloat);if(C.length<3||C.some(isNaN))continue;R.setEmissive(...C),C.length>4&&R.setShininess(C[4]);continue}if(b.startsWith("texture_unit"))for(let C=A+1;C<d.length;C++){const I=d[C];if(I==="}")break;const X=I.startsWith("texture ")&&I.replace("texture ","");if(X){const q=X.toUpperCase();R.createTextureUnit().setTextureName(q);continue}}}}}}},!1)})}function oy(){}function cy(){O("Root_Destroy")}function ay(){throw O("Root_GetTime"),Error("Not implemented")}function ly(){}function hy(){}function uy(){return 1}function dy(){return this.kernel.egorShouldRender=!0,1}function fy(){return 1}function gy(){O("Root_SaveConfig")}function py(){return 1}function _y(e){O("Scene_Clear",e)}function Ey(e){if(e!=="OctreeSceneManager"&&e!=="BSPSceneManager"&&e!=="TerrainSceneManager")throw Error(`Неподдерживаемый тип сцены: ${e}`);return this.kernel.egor.createScene().key}function my(e){O("Scene_Destroy",e)}function wy(e,t){throw O("Scene_GetCamera",e,t),Error("Not implemented")}function Ty(e,t){if(!t)return 0;const s=this.kernel.egor.scenes.get(e);if(!s)return 0;for(const r of this.kernel.egor.entities.values())if(r.scene===s&&r.name===t)return r.key;return 0}function yy(e,t){throw O("Scene_GetLight",e,t),Error("Not implemented")}function by(e,t){throw O("Scene_GetParticleSystem",e,t),Error("Not implemented")}function Oy(e){return this.kernel.egor.scenes.get(e)?.root.key??0}function Ry(e,t){if(!t)return 0;const s=this.kernel.egor.scenes.get(e);if(!s)return 0;for(const r of this.kernel.egor.sceneNodes.values())if(r.scene===s&&r.name===t)return r.key;return 0}function My(e){throw O("Scene_GetShadowTechnique",e),Error("Not implemented")}function vy(e,t){O("Scene_Load",e,t)}function Sy(e,t,s,r){this.kernel.egor.scenes.get(e)?.setAmbient(t,s,r)}function Ay(e,t,s,r,i,n,o,l){O("Scene_SetFog",e,t,s,r,i,n,o,l)}function Ny(e,t){O("Scene_SetShadowTechnique",e,t)}function Iy(e,t,s,r){e&&O("Scene_SetSkyBox",e,t,s,r)}function xy(e,t){O("Scene_SetWorldGeometry",e,t)}function Py(e,t){O("SceneNode_AttachObject",e,t)}function Ly(e,t){return this.kernel.egor.scenes.get(e)?.createSceneNode({name:t||"__SceneNode_"+RE++}).key??0}function Dy(e){this.kernel.egor.sceneNodes.get(e)?.destroy()}function ky(e,t){O("SceneNode_DetachObject",e,t)}function Cy(e){return this.kernel.egor.sceneNodes.get(e)?.movables.length??-1}function Gy(e,t){return this.kernel.egor.sceneNodes.get(e)?.getMovable(t)?.key||0}function Fy(e){throw O("SceneNode_GetScene",e),Error("Not implemented")}function By(e,t,s,r,i){this.kernel.egor.sceneNodes.get(e)?.setAutoTracking(this.kernel.egor.sceneNodes.get(t)??null,s,r,i)}function Uy(e,t,s){const r=this.kernel.egor.sceneNodes.get(e);if(!r)return;const i=!!t;if(!s){r.movables.forEach(n=>n.setVisible(i));return}(function n(o){o.movables.forEach(l=>l.setVisible(i)),o.children.forEach(l=>n(l))})(r)}function Wy(e,t,s){O("StringInterface_GetParameter",e,t,s)}function Vy(e){throw O("StringInterface_GetParameterCount",e),Error("Not implemented")}function $y(e,t,s){O("StringInterface_GetParameterDescription",e,t,s)}function jy(e,t,s){O("StringInterface_GetParameterName",e,t,s)}function Hy(e,t){throw O("StringInterface_GetParameterType",e,t),Error("Not implemented")}function Xy(e,t,s){const r=this.kernel.egor.overlayElements.get(e);r&&r.setParam(t,s)}function Yy(e,t){throw O("Technique_Create",e,t),Error("Not implemented")}function zy(e,t){return this.kernel.egor.techniques.get(e)?.pass(t)?.key??0}function Ky(e,t){throw O("Technique_GetPassByName",e,t),Error("Not implemented")}function qy(e,t){return this.kernel.egor.passes.get(e)?.createTextureUnit(t).key??0}function Jy(e,t,s){O("TextureUnitState_GetTexture",e,t,s)}function Zy(e,t,s){this.kernel.egor.texUnits.get(e)?.setTexture(this.kernel.egor.imageResByNameUC.get(t.toUpperCase())??null,s)}function Qy(e,t,s){throw O("Viewport_AddCompositor",e,t,s),Error("Not implemented")}function eb(e,t,s){const r=this.kernel.egor.cameras.get(t);return r?this.kernel.egor.windows.get(e)?.createViewport(r,s).key??0:0}function tb(e){O("Viewport_Destroy",e)}function sb(e,t,s,r){throw O("Viewport_GetBackgroundColour",e,t,s,r),Error("Not implemented")}function rb(e){throw O("Viewport_GetCamera",e),Error("Not implemented")}function ib(e,t){throw O("Viewport_GetCompositor",e,t),Error("Not implemented")}function nb(e,t,s,r,i){throw O("Viewport_GetDimensions",e,t,s,r,i),Error("Not implemented")}function ob(e){throw O("Viewport_GetNumCompositors",e),Error("Not implemented")}function cb(e){throw O("Viewport_GetOverlaysEnabled",e),Error("Not implemented")}function ab(e,t,s,r,i,n,o,l,u,d,p,E,w,T,R){const{origin:A,dir:b}=this.kernel.egor.viewports.get(e)?.camera.getRay(t,s,$s)||ME;r[i]=A[0],n[o]=A[1],l[u]=A[2],d[p]=b[0],E[w]=b[1],T[R]=b[2]}function lb(e,t){O("Viewport_RemoveCompositor",e,t)}function hb(e,t,s,r){this.kernel.egor.viewports.get(e)?.setBackground(t,s,r)}function ub(e,t){const s=this.kernel.egor.cameras.get(t);s&&this.kernel.egor.viewports.get(e)?.setCamera(s)}function db(e,t,s,r,i){O("Viewport_SetDimensions",e,t,s,r,i)}function fb(e,t){this.kernel.egor.viewports.get(e)?.enableOverlays(!!t)}function gb(e){e("AnimationState_AddTime",{a:[a,c]},vE),e("AnimationState_GetEnabled",{a:[a],r:c},SE),e("AnimationState_GetLength",{a:[a],r:c},AE),e("AnimationState_GetLoop",{a:[a],r:c},NE),e("AnimationState_GetTimePosition",{a:[a],r:c},IE),e("AnimationState_GetWeight",{a:[a],r:c},xE),e("AnimationState_SetEnabled",{a:[a,c]},PE),e("AnimationState_SetLength",{a:[a,c]},LE),e("AnimationState_SetLoop",{a:[a,c]},DE),e("AnimationState_SetTimePosition",{a:[a,c]},kE),e("AnimationState_SetWeight",{a:[a,c]},CE),e("Billboard_GetColour",{a:[a,N,N,N,N]},GE),e("Billboard_GetPosition",{a:[a,N,N,N]},FE),e("Billboard_GetRotation",{a:[a],r:c},BE),e("Billboard_SetColour",{a:[a,c,c,c,c]},UE),e("Billboard_SetPosition",{a:[a,c,c,c]},WE),e("Billboard_SetRotation",{a:[a,c]},VE),e("BillboardSet_Create",{a:[a,_,c],r:a},$E),e("BillboardSet_CreateBillboard",{a:[a,c,c,c],r:a},jE),e("BillboardSet_Destroy",{a:[a]},HE),e("BillboardSet_GetBillboard",{a:[a,c],r:a},XE),e("BillboardSet_GetBillboardType",{a:[a],r:c},YE),e("BillboardSet_GetCommonDirection",{a:[a,N,N,N]},zE),e("BillboardSet_GetCommonUpVector",{a:[a,N,N,N]},KE),e("BillboardSet_GetDefaultDimensions",{a:[a,N,N]},qE),e("BillboardSet_GetMaterialName",{a:[a,ie]},JE),e("BillboardSet_GetNumBillboards",{a:[a],r:c},ZE),e("BillboardSet_RemoveBillboard",{a:[a,a]},QE),e("BillboardSet_SetBillboardType",{a:[a,c]},em),e("BillboardSet_SetCommonDirection",{a:[a,c,c,c]},tm),e("BillboardSet_SetCommonUpVector",{a:[a,c,c,c]},sm),e("BillboardSet_SetDefaultDimensions",{a:[a,c,c]},rm),e("BillboardSet_SetMaterialName",{a:[a,_]},im),e("Bone_GetManuallyControlled",{a:[a],r:c},nm),e("Bone_Reset",{a:[a]},om),e("Bone_SetManuallyControlled",{a:[a,c]},cm),e("Camera_Create",{a:[a,_],r:a},am),e("Camera_Destroy",{a:[a]},lm),e("Camera_GetAspectRatio",{a:[a],r:c},hm),e("Camera_GetFarClipDistance",{a:[a],r:c},um),e("Camera_GetFOV",{a:[a],r:c},dm),e("Camera_GetNearClipDistance",{a:[a],r:c},fm),e("Camera_GetPolygonMode",{a:[a],r:c},gm),e("Camera_GetProjectionType",{a:[a],r:c},pm),e("Camera_SetAspectRatio",{a:[a,c]},_m),e("Camera_SetFarClipDistance",{a:[a,c]},Em),e("Camera_SetFocalLength",{a:[a,c]},mm),e("Camera_SetFOV",{a:[a,c]},wm),e("Camera_SetFrustumOffset",{a:[a,c,c]},Tm),e("Camera_SetNearClipDistance",{a:[a,c]},ym),e("Camera_SetPolygonMode",{a:[a,c]},bm),e("Camera_SetProjectionType",{a:[a,c]},Om),e("Collision_GetDistance",{a:[c],r:c},Rm),e("Collision_GetObject",{a:[c],r:a},Mm),e("Collision_GetResultCount",{r:c},vm),e("Collision_RayCast",{a:[a,c,c,c,c,c,c]},Sm),e("Collision_Sort",{},Am),e("Compositor_GetEnabled",{a:[a],r:c},Nm),e("Compositor_SetEnabled",{a:[a,c]},Im),e("Entity_Create",{a:[a,_,_],r:a},xm),e("Entity_Destroy",{a:[a]},Pm),e("Entity_GetAnimationState",{a:[a,_],r:a},Lm),e("Entity_GetBone",{a:[a,_],r:a},Dm),e("Entity_GetIndexCount",{a:[a,c],r:c},km),e("Entity_GetMaterial",{a:[a,c,ie]},Cm),e("Entity_GetSubEntityCount",{a:[a],r:c},Gm),e("Entity_GetVertexCount",{a:[a],r:c},nn),e("Entity_GetVertexCount",{a:[a,c],r:c},nn),e("Entity_SetMaterial",{a:[a,c,_]},Fm),e("Light_Create",{a:[a,_],r:a},Bm),e("Light_Destroy",{a:[a]},Um),e("Light_GetPowerScale",{a:[a],r:c},Wm),e("Light_SetAttenuation",{a:[a,c,c,c,c]},Vm),e("Light_SetDiffuseColour",{a:[a,c,c,c]},$m),e("Light_SetPowerScale",{a:[a,c]},jm),e("Light_SetSpecularColour",{a:[a,c,c,c]},Hm),e("Light_SetSpotlightRange",{a:[a,c,c,c]},Xm),e("Light_SetType",{a:[a,c]},Ym),e("ManualObject_Begin",{a:[a,_,c]},zm),e("ManualObject_Clear",{a:[a]},Km),e("ManualObject_Colour",{a:[a,c,c,c,c]},qm),e("ManualObject_ConvertToMesh",{a:[a,_]},Jm),e("ManualObject_Create",{a:[a,_],r:a},Zm),e("ManualObject_Destroy",{a:[a]},Qm),e("ManualObject_End",{a:[a]},e0),e("ManualObject_EstimateIndexCount",{a:[a,c]},t0),e("ManualObject_EstimateVertexCount",{a:[a,c]},s0),e("ManualObject_GetDynamic",{a:[a],r:c},r0),e("ManualObject_Index",{a:[a,c]},i0),e("ManualObject_Normal",{a:[a,c,c,c]},n0),e("ManualObject_Position",{a:[a,c,c,c]},o0),e("ManualObject_SetDynamic",{a:[a,c]},c0),e("ManualObject_TextureCoord",{a:[a,c,c]},a0),e("Material_Create",{a:[_],r:a},l0),e("Material_Get",{a:[_],r:a},h0),e("Material_GetBestTechnique",{a:[a],r:a},u0),e("Material_GetName",{a:[a,ie]},d0),e("Material_GetTechniqueByIndex",{a:[a,c],r:a},f0),e("Material_GetTechniqueByName",{a:[a,_],r:a},g0),e("Movable_GetBoundingBox",{a:[a,N,N,N,N,N,N]},p0),e("Movable_GetCastShadows",{a:[a],r:c},_0),e("Movable_GetName",{a:[a,ie]},E0),e("Movable_GetParent",{a:[a],r:a},m0),e("Movable_GetVisible",{a:[a],r:c},w0),e("Movable_SetCastShadows",{a:[a,c]},T0),e("Movable_SetParent",{a:[a,a]},y0),e("Movable_SetVisible",{a:[a,c]},b0),e("MovableText_Create",{a:[_,_,_],r:a},O0),e("MovableText_Destroy",{a:[a]},R0),e("MovableText_GetCaption",{a:[a,ie]},M0),e("MovableText_GetCharacterHeight",{a:[a],r:c},v0),e("MovableText_GetColor",{a:[a,N,N,N,N]},S0),e("MovableText_GetFontName",{a:[a,ie]},A0),e("MovableText_GetGlobalTranslation",{a:[a,N,N,N]},N0),e("MovableText_GetLocalTranslation",{a:[a,N,N,N]},I0),e("MovableText_GetSpaceWidth",{a:[a],r:c},x0),e("MovableText_GetTextAlignment",{a:[a,N,N]},P0),e("MovableText_SetCaption",{a:[a,_]},L0),e("MovableText_SetCharacterHeight",{a:[a,c]},D0),e("MovableText_SetColor",{a:[a,c,c,c,c]},k0),e("MovableText_SetFontName",{a:[a,_]},C0),e("MovableText_SetGlobalTranslation",{a:[a,c,c,c]},G0),e("MovableText_SetLocalTranslation",{a:[a,c,c,c]},F0),e("MovableText_SetSpaceWidth",{a:[a,c]},B0),e("MovableText_SetTextAlignment",{a:[a,c,c]},U0),e("Node_AddChild",{a:[a,a]},W0),e("Node_GetChild",{a:[a,c],r:a},V0),e("Node_GetDerivedPosition",{a:[a,N,N,N]},$0),e("Node_GetDerivedRotationQuaternion",{a:[a,N,N,N,N]},j0),e("Node_GetDerivedScale",{a:[a,N,N,N]},H0),e("Node_GetName",{a:[a,ie]},X0),e("Node_GetNumChildren",{a:[a],r:c},Y0),e("Node_GetParent",{a:[a],r:a},z0),e("Node_GetPosition",{a:[a,N,N,N]},K0),e("Node_GetRotationQuaternion",{a:[a,N,N,N,N]},q0),e("Node_GetScale",{a:[a,N,N,N]},J0),e("Node_RemoveChild",{a:[a,a]},Z0),e("Node_SetParent",{a:[a,a]},Q0),e("Node_SetPosition",{a:[a,c,c,c]},ew),e("Node_SetRotationAxis",{a:[a,c,c,c,c]},tw),e("Node_SetRotationEulerXYZ",{a:[a,c,c,c]},sw),e("Node_SetRotationEulerXZY",{a:[a,c,c,c]},rw),e("Node_SetRotationEulerYXZ",{a:[a,c,c,c]},iw),e("Node_SetRotationEulerYZX",{a:[a,c,c,c]},nw),e("Node_SetRotationEulerZXY",{a:[a,c,c,c]},ow),e("Node_SetRotationEulerZYX",{a:[a,c,c,c]},cw),e("Node_SetRotationQuaternion",{a:[a,c,c,c,c]},aw),e("Node_SetScale",{a:[a,c,c,c]},lw),e("Overlay_AddChild",{a:[a,a]},hw),e("Overlay_Create",{a:[_],r:a},uw),e("Overlay_FindElementAt",{a:[a,c,c],r:a},dw),e("Overlay_Get",{a:[_],r:a},fw),e("Overlay_GetName",{a:[a,ie]},gw),e("Overlay_GetRotate",{a:[a],r:c},pw),e("Overlay_GetScale",{a:[a,N,N]},_w),e("Overlay_GetScroll",{a:[a,N,N]},Ew),e("Overlay_GetVisible",{a:[a],r:c},mw),e("Overlay_GetZOrder",{a:[a],r:c},ww),e("Overlay_RemoveChild",{a:[a,a]},Tw),e("Overlay_SetRotate",{a:[a,c]},yw),e("Overlay_SetScale",{a:[a,c,c]},bw),e("Overlay_SetScroll",{a:[a,c,c]},Ow),e("Overlay_SetVisible",{a:[a,c]},Rw),e("Overlay_SetZOrder",{a:[a,c]},Mw),e("OverlayContainer_AddChild",{a:[a,a]},vw),e("OverlayContainer_GetChild",{a:[a,c],r:a},Sw),e("OverlayContainer_GetChildCount",{a:[a],r:c},Aw),e("OverlayContainer_RemoveChild",{a:[a,a]},Nw),e("OverlayElement_Create",{a:[_,_],r:a},Iw),e("OverlayElement_Get",{a:[_],r:a},xw),e("OverlayElement_GetAlignment",{a:[a,N,N]},Pw),e("OverlayElement_GetCaption",{a:[a,ie]},Lw),e("OverlayElement_GetColour",{a:[a,N,N,N,N]},Dw),e("OverlayElement_GetMaterialName",{a:[a,ie]},kw),e("OverlayElement_GetMetricsMode",{a:[a],r:c},Cw),e("OverlayElement_GetParent",{a:[a],r:a},Gw),e("OverlayElement_GetPosition",{a:[a,N,N]},Fw),e("OverlayElement_GetSize",{a:[a,N,N]},Bw),e("OverlayElement_GetVisible",{a:[a],r:c},Uw),e("OverlayElement_IsContainer",{a:[a],r:c},Ww),e("OverlayElement_SetAlignment",{a:[a,c,c]},Vw),e("OverlayElement_SetCaption",{a:[a,_]},$w),e("OverlayElement_SetColour",{a:[a,c,c,c,c]},jw),e("OverlayElement_SetMaterialName",{a:[a,_]},Hw),e("OverlayElement_SetMetricsMode",{a:[a,c]},Xw),e("OverlayElement_SetPosition",{a:[a,c,c]},Yw),e("OverlayElement_SetSize",{a:[a,c,c]},zw),e("OverlayElement_SetVisible",{a:[a,c]},Kw),e("ParticleSystem_Create",{a:[a,_,_],r:a},qw),e("ParticleSystem_CreateEx",{a:[a,_,_],r:a},Jw),e("ParticleSystem_Destroy",{a:[a]},Zw),e("ParticleSystem_GetName",{a:[a,_]},Qw),e("ParticleSystem_GetParent",{a:[a],r:a},eT),e("ParticleSystem_GetVisible",{a:[a],r:c},tT),e("ParticleSystem_SetParent",{a:[a,a]},sT),e("ParticleSystem_SetVisible",{a:[a,c]},rT),e("Pass_Create",{a:[a,_],r:a},iT),e("Pass_GetAlphaRejectSettings",{a:[a,N,N]},nT),e("Pass_GetAmbient",{a:[a,N,N,N,N]},oT),e("Pass_GetColourWriteEnabled",{a:[a],r:c},cT),e("Pass_GetCullingMode",{a:[a],r:c},aT),e("Pass_GetDepthCheckEnabled",{a:[a],r:c},lT),e("Pass_GetDepthFunction",{a:[a],r:c},hT),e("Pass_GetDepthWriteEnabled",{a:[a],r:c},uT),e("Pass_GetDiffuse",{a:[a,N,N,N,N]},dT),e("Pass_GetLightingEnabled",{a:[a],r:c},fT),e("Pass_GetPolygonMode",{a:[a],r:c},gT),e("Pass_GetSceneBlending",{a:[a,N,N]},pT),e("Pass_GetSelfIllumination",{a:[a,N,N,N,N]},_T),e("Pass_GetShadingMode",{a:[a],r:c},ET),e("Pass_GetShininess",{a:[a],r:c},mT),e("Pass_GetSpecular",{a:[a,N,N,N,N]},wT),e("Pass_GetTextureUnitStateByIndex",{a:[a,c],r:a},TT),e("Pass_GetTextureUnitStateByName",{a:[a,_],r:a},yT),e("Pass_SetAlphaRejectSettings",{a:[a,c,c]},bT),e("Pass_SetAmbient",{a:[a,c,c,c,c]},OT),e("Pass_SetColourWriteEnabled",{a:[a,c]},RT),e("Pass_SetCullingMode",{a:[a,c]},MT),e("Pass_SetDepthCheckEnabled",{a:[a,c]},vT),e("Pass_SetDepthFunction",{a:[a,c]},ST),e("Pass_SetDepthWriteEnabled",{a:[a,c]},AT),e("Pass_SetDiffuse",{a:[a,c,c,c,c]},NT),e("Pass_SetLightingEnabled",{a:[a,c]},IT),e("Pass_SetPolygonMode",{a:[a,c]},xT),e("Pass_SetSceneBlending",{a:[a,c,c]},PT),e("Pass_SetSelfIllumination",{a:[a,c,c,c,c]},LT),e("Pass_SetShadingMode",{a:[a,c]},DT),e("Pass_SetShininess",{a:[a,c]},kT),e("Pass_SetSpecular",{a:[a,c,c,c,c]},CT),e("RenderTexture_Create",{a:[_,c,c],r:a},GT),e("RenderTexture_Destroy",{a:[a]},FT),e("RenderWindow_Create",{a:[a,c,c],r:a},BT),e("RenderWindow_Create2",{a:[a,_,c,c,c,c,c,c],r:a},UT),e("RenderWindow_CreateEx",{a:[a,c,c,c],r:a},WT),e("RenderWindow_Destroy",{a:[a]},VT),e("RenderWindow_Get",{a:[c],r:a},$T),e("RenderWindow_GetCount",{r:c},jT),e("RenderWindow_GetCursorHovered",{a:[a],r:c},HT),e("RenderWindow_GetCursorPosition",{a:[a,N,N]},XT),e("RenderWindow_GetKeyboardButtonPressed",{a:[a,c],r:c},YT),e("RenderWindow_GetMouseButtonPressed",{a:[a,c],r:c},zT),e("RenderWindow_GetPosition",{a:[a,N,N]},KT),e("RenderWindow_GetPrimary",{r:a},qT),e("RenderWindow_GetSize",{a:[a,N,N]},JT),e("RenderWindow_GetViewport",{a:[a,c],r:a},ZT),e("RenderWindow_GetViewportCount",{a:[a],r:c},QT),e("RenderWindow_GetWheelPosition",{a:[a],r:c},ey),e("RenderWindow_SetPosition",{a:[a,c,c]},ty),e("RenderWindow_SetSize",{a:[a,c,c]},sy),e("RenderWindow_ToggleFullscreen",{a:[a],r:c},ry),e("Root_AddResourceLocation",{a:[_,_,_,c]},iy),e("Root_AddResourceLocationFromConfigFile",{a:[_]},ny),e("Root_Create",{a:[_,_,_]},oy),e("Root_Destroy",{},cy),e("Root_GetTime",{r:c},ay),e("Root_Initialise",{},ly),e("Root_InitialiseAllResourceGroups",{},hy),e("Root_IsInitialised",{r:c},uy),e("Root_RenderOneFrame",{r:c},dy),e("Root_RestoreConfig",{r:c},fy),e("Root_SaveConfig",{},gy),e("Root_ShowConfigDialog",{r:c},py),e("Scene_Clear",{a:[a]},_y),e("Scene_Create",{a:[_],r:a},Ey),e("Scene_Destroy",{a:[a]},my),e("Scene_GetCamera",{a:[a,_],r:a},wy),e("Scene_GetEntity",{a:[a,_],r:a},Ty),e("Scene_GetLight",{a:[a,_],r:a},yy),e("Scene_GetParticleSystem",{a:[a,_],r:a},by),e("Scene_GetRootSceneNode",{a:[a],r:a},Oy),e("Scene_GetSceneNode",{a:[a,_],r:a},Ry),e("Scene_GetShadowTechnique",{a:[a],r:c},My),e("Scene_Load",{a:[a,_]},vy),e("Scene_SetAmbientLight",{a:[a,c,c,c]},Sy),e("Scene_SetFog",{a:[a,c,c,c,c,c,c,c]},Ay),e("Scene_SetShadowTechnique",{a:[a,c]},Ny),e("Scene_SetSkyBox",{a:[a,c,_,c]},Iy),e("Scene_SetWorldGeometry",{a:[a,_]},xy),e("SceneNode_AttachObject",{a:[a,a]},Py),e("SceneNode_Create",{a:[a,_],r:a},Ly),e("SceneNode_Destroy",{a:[a]},Dy),e("SceneNode_DetachObject",{a:[a,a]},ky),e("SceneNode_GetNumObjects",{a:[a],r:c},Cy),e("SceneNode_GetObject",{a:[a,c],r:a},Gy),e("SceneNode_GetScene",{a:[a],r:a},Fy),e("SceneNode_SetAutoTracking",{a:[a,a,c,c,c]},By),e("SceneNode_SetVisible",{a:[a,c,c]},Uy),e("StringInterface_GetParameter",{a:[a,_,_]},Wy),e("StringInterface_GetParameterCount",{a:[a],r:c},Vy),e("StringInterface_GetParameterDescription",{a:[a,c,_]},$y),e("StringInterface_GetParameterName",{a:[a,c,_]},jy),e("StringInterface_GetParameterType",{a:[a,c],r:c},Hy),e("StringInterface_SetParameter",{a:[a,_,_]},Xy),e("Technique_Create",{a:[a,_],r:a},Yy),e("Technique_GetPassByIndex",{a:[a,c],r:a},zy),e("Technique_GetPassByName",{a:[a,_],r:a},Ky),e("TextureUnitState_Create",{a:[a,_],r:a},qy),e("TextureUnitState_GetTexture",{a:[a,_,a]},Jy),e("TextureUnitState_SetTexture",{a:[a,_,c]},Zy),e("Viewport_AddCompositor",{a:[a,_,c],r:a},Qy),e("Viewport_Create",{a:[a,a,c],r:a},eb),e("Viewport_Destroy",{a:[a]},tb),e("Viewport_GetBackgroundColour",{a:[a,N,N,N]},sb),e("Viewport_GetCamera",{a:[a],r:a},rb),e("Viewport_GetCompositor",{a:[a,c],r:a},ib),e("Viewport_GetDimensions",{a:[a,N,N,N,N]},nb),e("Viewport_GetNumCompositors",{a:[a],r:c},ob),e("Viewport_GetOverlaysEnabled",{a:[a],r:c},cb),e("Viewport_GetRay",{a:[a,c,c,N,N,N,N,N,N]},ab),e("Viewport_RemoveCompositor",{a:[a,a]},lb),e("Viewport_SetBackgroundColour",{a:[a,c,c,c]},hb),e("Viewport_SetCamera",{a:[a,a]},ub),e("Viewport_SetDimensions",{a:[a,c,c,c,c]},db),e("Viewport_SetOverlaysEnabled",{a:[a,c]},fb)}const pb={name:"ogre",deps:["windows"],register:gb,setup(e){e.egor=new ap,e.egorShouldRender=!1,e.egorRayCastResult=null,e.egorManualObjectsSections=new WeakMap,e.beforeRender.add(()=>{e.egorShouldRender&&(e.egorShouldRender=!1,e.egor.renderAll())})}},_b=13,Eb=10,mb=[1,1,2,2,4,4,4,5,8,10];function cn(e){return e<0||e>9?0:mb[e]}class an{constructor(t=null,s=null){this.file=s,t?this.v=new DataView(t.buffer,t.byteOffset,t.byteLength):this.v=new DataView(new ArrayBuffer(0)),this.p=0,this.width=8}copyTo(t,s,r){return s<0||s+r>this.v.byteLength?0:(t.v.byteLength<r?t.v=new DataView(this.v.buffer.slice(s,r)):new Uint8Array(t.v.buffer).set(new Uint8Array(this.v.buffer,s,r)),1)}seek(t){return this.p=t}eof(){return this.p>=this.size()?1:0}pos(){return this.p}size(){return this.v.byteLength}setWidth(t){return this.width=t,1}widthNumber(){const t=cn(this.width);if(t===0)return 0;const s=this.p,r=s+t;if(r>this.size())return 0;switch(this.p=r,this.width){case 0:return this.v.getUint8(s);case 1:return this.v.getInt8(s);case 2:return this.v.getUint16(s,!0);case 3:return this.v.getInt16(s,!0);case 4:return this.v.getUint32(s,!0);case 5:return this.v.getInt32(s,!0);case 6:return this.v.getFloat32(s,!0);case 7:throw Error("Чтение FLOAT40 не поддерживается");case 8:return this.v.getFloat64(s,!0);case 9:throw Error("Чтение FLOAT80 не поддерживается");default:return 0}}resize(t){const s=new Uint8Array(new ArrayBuffer(t));s.set(new Uint8Array(this.v.buffer)),this.v=new DataView(s.buffer)}writeWidthNumber(t){const s=cn(this.width);if(s===0)return 0;const r=this.p,i=r+s;switch(i>this.size()&&this.resize(i),this.p=i,this.width){case 0:return this.v.setUint8(r,t),1;case 1:return this.v.setInt8(r,t),1;case 2:return this.v.setUint16(r,t,!0),2;case 3:return this.v.setInt16(r,t,!0),2;case 4:return this.v.setUint32(r,t,!0),4;case 5:return this.v.setInt32(r,t,!0),4;case 6:return this.v.setFloat32(r,t,!0),4;case 7:throw Error("FLOAT40 не поддерживается");case 8:return this.v.setFloat64(r,t,!0),8;case 9:throw Error("FLOAT80 не поддерживается");default:return 0}}getLine(t,s){const r=this.p,i=Math.min(t,this.size()-r);if(i<=0)return"";let n=0,o="";for(;n<i;){const l=this.v.getUint8(r+n);n++;const u=_e[l];if(o+=u,u===s)break}return this.p+=n,o}line(){const t=this.p,s=this.size()-t;if(s<=0)return"";let r=0,i=0;for(;r<s;){const o=this.v.getUint8(t+r);if(o===0){i=1;break}if(o===_b&&r+1<s&&this.v.getUint8(t+r+1)===Eb){i=2;break}r+=1}const n=ls(new Uint8Array(this.v.buffer,t,r));return this.p=t+r+i,n}writeLine(t){const s=t+`\r
`;let r=this.p;const i=r+s.length;return i>this.size()&&this.resize(i),this.p=i,rr(s).forEach((o,l)=>this.v.setUint8(r+l,o)),s.length}write(t){let s=this.p;const r=s+t.length;r>this.size()&&this.resize(r),this.p=r,t.forEach((i,n)=>this.v.setUint8(s+n,i))}bytes(){return new Uint8Array(this.v.buffer)}}function wb(e,t,s){const r=e.toUpperCase(),i=s.toUpperCase(),n=i.includes("CREATE"),o=i.includes("READONLY"),l=ge.freeKey(this.kernel.streams);if(t==="?")throw Error("Некорректное использование fileLoadDialog");if(r==="FILE"){const u=this.prj.dir.resolve(t);let d=null,p=null;if(n){if(d=u.create("file",{base64:""}),!d)return 0}else{if(d=u.file(),!d)return 0;d.base64?p=sr(d.base64):re.debugFile&&console.warn(`CreateStream: Файл ${u} (${d.size} байт) существует, но формат не base64.`)}return this.kernel.streams.set(l,new an(p,o?null:d)),l}return r==="MEMORY"?(this.kernel.streams.set(l,new an),l):(console.warn(`Поток типа ${r} не поддерживается`),0)}function Tb(e){const t=this.kernel.streams.get(e);if(!t)return 0;if(this.kernel.streams.delete(e),!t.file)return 1;const s=t.bytes();return t.file.set({base64:tr(s)}),this.kernel.handleWrite(t.file.path,s),1}function yb(e,t){return this.kernel.streams.get(e)?.seek(t)??0}function bb(e){return this.kernel.streams.get(e)?.eof()??0}function Ob(e){return this.kernel.streams.get(e)?.pos()??0}function Rb(e){return this.kernel.streams.get(e)?.size()??0}function Mb(e,t){return this.kernel.streams.get(e)?.setWidth(t)??0}function vb(e){return this.kernel.streams.get(e)?.widthNumber()??0}function Sb(e){return this.kernel.streams.get(e)?.line()??""}function Ab(e,t){return this.kernel.streams.get(e)?.writeWidthNumber(t)??0}function Nb(e,t){return this.kernel.streams.get(e)?.writeLine(t)??0}function Ib(e,t,s){return this.kernel.streams.get(e)?.getLine(t,s)??""}function xb(e,t,s,r){const i=this.kernel.streams.get(e);if(!i)return 0;const n=this.kernel.streams.get(t);return n?i.copyTo(n,s,r):0}function Pb(e){e("CreateStream",{a:[_,_,_],r:a},wb),e("CloseStream",{a:[a],r:c},Tb),e("Seek",{a:[a,c],r:c},yb),e("Eof",{a:[a],r:c},bb),e("GetPos",{a:[a],r:c},Ob),e("GetSize",{a:[a],r:c},Rb),e("SetWidth",{a:[a,c],r:c},Mb),e("Read",{a:[a],r:c},vb),e("ReadLn",{a:[a],r:_},Sb),e("Write",{a:[a,c],r:c},Ab),e("WriteLn",{a:[a,_],r:c},Nb),e("GetLine",{a:[a,c,_],r:_},Ib),e("CopyBlock",{a:[a,a,c,c],r:c},xb)}const Lb={name:"streams",register:Pb,setup(e){e.streams=new Map}};function Db(e){switch(e){case P.WEB_DIALOG_OPEN:switch(this.kernel.fileDialogState.type){case"closed":return 0;case"willOpen":return 1;case"open":return 2;case"fileSelected":return 3}default:return this.kernel._functionNotImplemented(`System(${e})`),0}}function kb(e){return Vs(e)?1:0}function Cb(e,t,s,r,i){const n=this.kernel.windows.get(e);if(!n)return t[s]=0,r[i]=0,0;const o=n.mouseX+n.scene.x,l=n.mouseY+n.scene.y,u=n.invmatrix;if(!u)return t[s]=o,r[i]=l,1;const d=o*u[2]+l*u[5]+u[8];return t[s]=(o*u[0]+l*u[3]+u[6])/d,r[i]=(o*u[1]+l*u[4]+u[7])/d,1}function Gb(e){this.kernel.windowSystem.showCursor(e>0)}function ln(e,t){const s=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!s)return;let r;switch(t){case P.CUR_ARROW:r="auto";break;case P.CUR_CROSS:r="crosshair";break;case P.CUR_TEXT:r="text";break;case P.CUR_NO:r="not-allowed";break;case P.CUR_SIZE:r="move";break;case P.CUR_SIZENESW:r="nesw-resize";break;case P.CUR_SIZENS:r="ns-resize	";break;case P.CUR_SIZENWSE:r="nwse-resize";break;case P.CUR_SIZEWE:r="ew-resize";break;case P.CUR_UPARROW:r="n-resize";break;case P.CUR_WAIT:r="wait";break;case P.CUR_LINK:r="pointer";break;case P.CUR_HELP:r="help";break;default:r="auto";break}s.setCursor(r)}function hn(e,t){const s=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!s)return;const r=this.prj.dir.resolve(t).file()?.cursor;s.setCursor(r?`url(${We(r.src)}), auto`:"default")}function Fb(){return Date.now()-ja}function Bb(e,t,s,r,i,n,o,l){const u=new Date;e[t]=u.getHours(),s[r]=u.getMinutes(),i[n]=u.getSeconds(),o[l]=u.getMilliseconds()*.1}function Ub(e,t,s,r,i,n){const o=new Date;e[t]=o.getFullYear(),s[r]=o.getMonth()+1,i[n]=o.getDate()}function Wb(e,t,s,...[r,i,n,o,l]){if(s>4)return 0;const u=this.kernel.scenes.get(e)?.scene.objects.get(t);return u?(s<0?delete u.data.hyper:u.data.hyper={mode:s,target:r,object:i,effect:n,window:o,params:l},1):0}function Vb(e,t,s,r){const i=this.kernel.scenes.get(e);if(!i)return;const n=(i.scene.objects.get(r)??i.pick(t,s))?.data?.hyper;n&&i.hyperClick(n,{x:t,y:s})}function $b(){return this.kernel.windowSystem.windowFactory.screenWidth}function jb(){return this.kernel.windowSystem.windowFactory.screenHeight}function Hb(){return 0}function Xb(){return 0}function Yb(){return this.kernel.windowSystem.windowFactory.screenWidth}function zb(){return this.kernel.windowSystem.windowFactory.screenHeight}function Kb(){return 0}function qb(){return 0}function Jb(){return 0}function Zb(){return 0}function Qb(){return 0}function eO(){return 0}function tO(e,t){return this.kernel.handleExe(e,t)?1:0}function sO(e,t,s,r){return this.kernel.handleShell(e,t,s,r)?1:0}function rO(e){this.kernel.log(e,this)}function iO(e){e("System",{a:[c],rest:[c],r:c},Db),e("GetAsyncKeyState",{a:[c],r:c},kb),e("GetMousePos",{a:[_,N,N],r:c},Cb),e("ShowCursor",{a:[c]},Gb),e("LoadCursor",{a:[a,_]},hn),e("LoadCursor",{a:[_,_]},hn),e("SetStandartCursor",{a:[a,c]},ln),e("SetStandartCursor",{a:[_,c]},ln),e("GetTickCount",{r:c},Fb),e("GetTime",{a:[N,N,N,N]},Bb),e("GetDate",{a:[N,N,N]},Ub),e("SetHyperJump2d",{a:[a,a,c],rest:[_],r:c},Wb),e("StdHyperJump",{a:[a,c,c,a,c]},Vb),e("GetScreenWidth",{r:c},$b),e("GetScreenHeight",{r:c},jb),e("GetWorkAreaX",{r:c},Hb),e("GetWorkAreaY",{r:c},Xb),e("GetWorkAreaWidth",{r:c},Yb),e("GetWorkAreaHeight",{r:c},zb),e("GetTitleHeight",{r:c},Kb),e("GetSmallTitleHeight",{r:c},qb),e("GetFixedFrameWidth",{r:c},Jb),e("GetFixedFrameHeight",{r:c},Zb),e("GetSizeFrameWidth",{r:c},Qb),e("GetSizeFrameHeight",{r:c},eO),e("WinExecute",{a:[_,c],r:c},tO),e("Shell",{a:[_,_,_,c],r:c},sO),e("LogMessage",{a:[_]},rO)}const nO={name:"system",deps:["windows"],register:iO};function oO(e){return e.toString()}function cO(e,t){return e<0||e>255?"":_e[e]}function aO(e){e("FloatToString",{a:[c],r:_},oO),e("ConvertToAscii",{a:[c,c],r:_},cO)}const lO={name:"vrtkbd",register:aO};async function un({src:e,etag:t},s){let r;try{r=await fetch(`${to(e)}${t?"?"+t:""}`,s)}catch(n){throw n instanceof Error?Error("Сервер библиотек не отвечает"):n}if(r.status===404)throw Error(`404: Библиотека '${e}' не существует`);const i=await r.json();if(!r.ok)throw Error(i.message||"Неизвестная ошибка");return i}function hO(e,t,s,r){const{children:i}=e,n=i.length?i[0]:null,o=Yr(e.scene,t,r).set({x:e.x,y:e.y,attrib:e.attrib});if(n){const l=e.attrib|Ze;s?(n.set({attrib:l}),o.set({width:n.width,height:n.height})):n.set({attrib:l,width:1,height:1})}return e.set({children:i.concat(o)}),o}const be={gspace:"wfzRA-In","scroll-x":"XuJ-kAtH","scroll-y":"W6TE00tK",hidden:"_9uw8jyO-",scene:"cl0-v9U2",frame:"stXveFcA",spacer:"V7VkKPPF"};class uO{constructor(t,s){this.space=t,this.view=s,this.onDisposed=new Ee}dispose(){this.view.remove(),this.space._removeFrame(this)}}class js{constructor({system:t,key:s,name:r,project:i,data:n,options:o,x:l=0,y:u=0,matrix:d=null,source:p=null,parent:E=null,sceneChildren:w}){this.clientWidth=0,this.clientHeight=0,this.isVisible=!0,this.scale=1,this.mouseX=0,this.mouseY=0,this.mouseMoveSubs=new Me,this.leftButtonUpSubs=new Me,this.leftButtonDownSubs=new Me,this.rightButtonUpSubs=new Me,this.rightButtonDownSubs=new Me,this.middleButtonUpSubs=new Me,this.middleButtonDownSubs=new Me,this.keyDownSubs=new Set,this.keyUpSubs=new Set,this.keyCharSubs=new Set,this.controlNotifySubs=new Me,this.windowMoveSubs=new Set,this.spaceDoneSubs=new Set,this.sizeSubs=new Set,this.frames=new Set,this.all=new Set([this]),this.hiddenBy=null,this.currentCursor="auto",this.cursorOverHyp=!1,this.connectedWindow=null,this.spacer=null,this.scrollX=null,this.scrollY=null,this.scrolledSceneX=NaN,this.scrolledSceneY=NaN,this.title=r,this.system=t,this.kernel=t.kernel,this.key=s,this.name=r,this.project=i,this.matrix=d,this.invmatrix=d&&no(d),this.parent=E,this.source=p,this.x=l,this.y=u;const T=this.scene=t.sceneFactory.create(n,i.settings.graphicsBackend);w?.forEach(({key:k,klass:U})=>{const B=t.kernel.classes.get(U)?.image;if(!B||B.prior==="icon"||!B.scene?.data?.objects?.length)return;const G=T.objects.get(k);G?.type==="group"&&hO(G,B.scene.data,B.resizable)}),T.domElement.classList.add(be.scene);const R=this.domElement=document.createElement("div");R.className=be.gspace,R.tabIndex=0,R.setAttribute("data-gspace-name",r),R.setAttribute("data-gspace-key",s.toString()),R.append(T.domElement);const A=o.size;if(A?.type==="fixed"&&(this.clientWidth=A.width,this.clientHeight=A.height),A?.type!=="fixed"||o.hscroll||o.vscroll){const k=zr(T.objects.values());T.set({x:k.x,y:k.y}),this.clientWidth<=0&&(this.clientWidth=k.w),this.clientHeight<=0&&(this.clientHeight=k.h),o.hscroll&&(this.scrollX={min:k.x,max:k.x+(o.autoscroll?0:k.w)}),o.vscroll&&(this.scrollY={min:k.y,max:k.y+(o.autoscroll?0:k.h)})}this.clientWidth<=0&&(this.clientWidth=this.system.windowFactory.screenWidth),this.clientHeight<=0&&(this.clientHeight=this.system.windowFactory.screenHeight),Ue(R,{width:this.clientWidth+"px",height:this.clientHeight+"px"});const{pointerTarget:b}=this;b.addEventListener("contextmenu",Zn);const x=this.handlePointer.bind(this);b.addEventListener("pointerdown",x),b.addEventListener("pointermove",x),b.addEventListener("pointerup",x),b.addEventListener("pointercancel",x);const L=this.handleKeyboard.bind(this);R.addEventListener("keydown",L),R.addEventListener("keyup",L),T.onInputChanged.add(this.handleInput.bind(this))}get pointerTarget(){return this.scene.domElement}setTitle(t){this.title=t,this.connectedWindow?.set({title:t})}setConnectedWindow(t){t.onClosed.add(this.onConnectedWindowClosed.bind(this)),this.connectedWindow=t}onConnectedWindowClosed(){this.connectedWindow=null,this.close()}setOpacity(t){const{domElement:s}=this;t>=1?s.style.removeProperty("opacity"):Ue(s,{transition:"none",opacity:t.toString()})}updateMouseCoords(t,s){this.mouseX=t,this.mouseY=s,this.parent?.updateMouseCoords(this.x+t,this.y+s)}syncScrollbars(){const{domElement:t,scene:s,scrollX:r,scrollY:i}=this;r&&(this.scrolledSceneX===s.x?s.set({x:r.min+t.scrollLeft}):t.scrollLeft=s.x-r.min,this.scrolledSceneX=s.x),i&&(this.scrolledSceneY===s.y?s.set({y:i.min+t.scrollTop}):t.scrollTop=s.y-i.min,this.scrolledSceneY=s.y)}beforeRender(){this.syncScrollbars(),this.scene._render()}beforeAll(){this.syncScrollbars()}afterAll(){const{domElement:t,scrollX:s,scrollY:r}=this;if(!s&&!r)return;if(!this.spacer){const d=this.spacer=document.createElement("div");d.className=be.spacer,t.append(d)}const{spacer:i}=this;let n=s?Math.max(s.max-s.min,0):0,o=r?Math.max(r.max-r.min,0):0;const l=s&&!n,u=r&&!o;if(l||u){const d=zr(this.scene.objects.values());l&&(n=d.w),u&&(o=d.h)}if(s){t.classList.contains(be["scroll-x"])||t.classList.add(be["scroll-x"]);const d=Math.round(n)+"px";i.style.width!==d&&(i.style.width=d)}if(r){t.classList.contains(be["scroll-y"])||t.classList.add(be["scroll-y"]);const d=Math.round(o)+"px";i.style.height!==d&&(i.style.height=d)}}updateCursor(){const t=this.system.cursorVisible?this.cursorOverHyp?"pointer":this.currentCursor:"none",{domElement:s}=this;s.style.cursor!==t&&(s.style.cursor=t)}setCapture(t){this.system.setCapture(this,t)}subscribe(t,s,r,i){const n=i&1,o=this.scene.objects.get(r)??null;switch(s){case P.WM_MOVE:this.windowMoveSubs.add(t);break;case P.WM_SPACEDONE:this.spaceDoneSubs.add(t);break;case P.WM_SIZE:this.sizeSubs.add(t);break;case P.WM_CONTROLNOTIFY:(o||r===0)&&this.controlNotifySubs.set(t,o);break;case P.WM_MOUSEMOVE:(o||!n)&&this.mouseMoveSubs.set(t,n?o:null);break;case P.WM_LBUTTONDOWN:(o||!n)&&this.leftButtonDownSubs.set(t,n?o:null);break;case P.WM_LBUTTONUP:(o||!n)&&this.leftButtonUpSubs.set(t,n?o:null);break;case P.WM_RBUTTONDOWN:(o||!n)&&this.rightButtonDownSubs.set(t,n?o:null);break;case P.WM_RBUTTONUP:(o||!n)&&this.rightButtonUpSubs.set(t,n?o:null);break;case P.WM_MBUTTONDOWN:(o||!n)&&this.middleButtonDownSubs.set(t,n?o:null);break;case P.WM_MBUTTONUP:(o||!n)&&this.middleButtonUpSubs.set(t,n?o:null);break;case P.WM_ALLMOUSEMESSAGE:if(!o&&n)break;const l=n?o:null;this.mouseMoveSubs.set(t,l),this.leftButtonDownSubs.set(t,l),this.leftButtonUpSubs.set(t,l),this.rightButtonDownSubs.set(t,l),this.rightButtonUpSubs.set(t,l),this.middleButtonDownSubs.set(t,l),this.middleButtonUpSubs.set(t,l);break;case P.WM_KEYDOWN:this.keyDownSubs.add(t);break;case P.WM_KEYUP:this.keyUpSubs.add(t);break;case ps:this.keyCharSubs.add(t);break;case P.WM_ALLKEYMESSAGE:this.keyDownSubs.add(t),this.keyUpSubs.add(t),this.keyCharSubs.add(t);break;default:t.kernel._functionNotImplemented(`Подписка на ${P[s]}`,t);break}}unsubscribe(t,s){switch(s){case P.WM_MOVE:this.windowMoveSubs.delete(t);break;case P.WM_SPACEDONE:this.spaceDoneSubs.delete(t);break;case P.WM_SIZE:this.sizeSubs.delete(t);break;case P.WM_CONTROLNOTIFY:this.controlNotifySubs.delete(t);break;case P.WM_MOUSEMOVE:this.mouseMoveSubs.delete(t);break;case P.WM_LBUTTONDOWN:this.leftButtonDownSubs.delete(t);break;case P.WM_LBUTTONUP:this.leftButtonUpSubs.delete(t);break;case P.WM_RBUTTONDOWN:this.rightButtonDownSubs.delete(t);break;case P.WM_RBUTTONUP:this.rightButtonUpSubs.delete(t);break;case P.WM_MBUTTONDOWN:this.middleButtonDownSubs.delete(t);break;case P.WM_MBUTTONUP:this.middleButtonUpSubs.delete(t);break;case P.WM_ALLMOUSEMESSAGE:this.mouseMoveSubs.delete(t),this.leftButtonDownSubs.delete(t),this.leftButtonUpSubs.delete(t),this.rightButtonDownSubs.delete(t),this.rightButtonUpSubs.delete(t),this.middleButtonDownSubs.delete(t),this.middleButtonUpSubs.delete(t);break;case P.WM_KEYDOWN:this.keyDownSubs.delete(t);break;case P.WM_KEYUP:this.keyUpSubs.delete(t);break;case ps:this.keyCharSubs.delete(t);break;case P.WM_ALLKEYMESSAGE:this.keyDownSubs.delete(t),this.keyUpSubs.delete(t),this.keyCharSubs.delete(t);break}}setWindowOrg(t,s){this.x=t,this.y=s,this.connectedWindow?this.connectedWindow.set({x:t,y:s}):this.parent&&Ue(this.domElement,{left:t-this.parent.scene.x+"px",top:s-this.parent.scene.y+"px"})}setWindowSize(t,s){this.clientWidth=t,this.clientHeight=s;const{inverseScale:r}=this;Ue(this.domElement,{width:t*r+"px",height:s*r+"px"})}setWindowPos(t,s,r,i){this.setWindowOrg(t,s),this.setWindowSize(r,i)}setSceneOrg(t,s){this.scene.set({x:t,y:s})}setScrollX(t,s){const{scrollX:r}=this;(!r||r.min!==t||r.max!==s)&&(this.scrollX={min:t,max:s},this.scrolledSceneX=this.scene.x-t)}setScrollY(t,s){const{scrollY:r}=this;(!r||r.min!==t||r.max!==s)&&(this.scrollY={min:t,max:s},this.scrolledSceneY=this.scene.y-t)}setCursor(t){this.currentCursor=t,this.updateCursor()}createFrame(t){t.classList.add(be.frame),this.domElement.append(t);const s=new uO(this,t);return this.frames.add(s),s}createChild(t){const s=new js({...t,parent:this});return this.domElement.append(s.domElement),this.all.add(s),s}pick(t,s,r){let i=t,n=s;const o=this.matrix;if(o){const u=t*o[2]+s*o[5]+o[8];i=(t*o[0]+s*o[3]+o[6])/u,n=(t*o[1]+s*o[4]+o[7])/u}let l=this.scene.pick(i,n);if(r&&(this.system.lastPickedPrimaryKey=l?.key??0),!l)return null;for(;l.parent;)l=l.parent;return l}paste(t,s,r,i){if(!t.objects?.length)return null;let n=t;if(i&P.PFC_ALL){const p={...t};i&P.PFC_PENS&&delete p.pens,i&P.PFC_BRUHS&&delete p.brushes,i&P.PFC_DDIBS&&delete p.images,i&P.PFC_DIBS&&delete p.imagesOpaque,i&P.PFC_STRINGS&&delete p.strings,i&P.PFC_FONTS&&delete p.fonts,i&P.PFC_TEXTS&&delete p.texts,n=p}const o=Yr(this.scene,n);if(!(i&P.PFC_MOVEOBJECT))return o;let l=s,u=r;const d=this.matrix;if(d){const p=s*d[2]+r*d[5]+d[8];l=(s*d[0]+r*d[3]+d[6])/p,u=(s*d[1]+r*d[4]+d[7])/p}return o.set({x:l,y:u})}async tryOpenProject(t,s){const r=this.project.dir.resolve(t);let i;try{i=await this.kernel.openProject(r)}catch(n){if(!(n instanceof Error))throw n;console.warn(`Не удалось открыть ${r}: ${n.message}`);return}if(!i){console.warn(`${r} не существует`);return}s&&this.system.hideProjectWindows(this.project,i)}hyperClick(t,s){const{project:r}=this;switch(t.object&&console.warn("Посылка WM_HYPERJUMP не реализована"),t.mode){case Vc:{if(t.target){const i=t.window||"",n=t.target,o="WS_BYSPACE",l=s.x-this.scene.x,u=s.y-this.scene.y;requestAnimationFrame(()=>{const d=this.system.createGSpace(r,i,n,o,l,u);this.connectedWindow&&d?.connectedWindow?.set({preserveX:!0})})}break}case $c:{const i=t.target;if(!i)break;this.kernel.handleExe(i);break}case jc:{const i=t.target;if(!i)break;const n=t.params?.toUpperCase().includes("/HIDEWINDOWS");this.tryOpenProject(i,n);break}case Hc:break;case Xc:{const i=t.target?.toUpperCase();if(!i)break;switch(i){case Yc:this.kernel.closeAll();break;case zc:r.close();break;default:console.warn(`Действие '${i}' не реализовано.`);break}break}default:console.warn("Неизвестный тип гиперперехода"),console.log(t)}}toTop(){this.connectedWindow?this.connectedWindow?.toTop():this.parent?.domElement.append(this.domElement)}hide(){this.isVisible=!1,this.connectedWindow?this.connectedWindow.set({visible:!1}):this.domElement.classList.add(be.hidden)}show(){this.isVisible=!0,this.connectedWindow?this.connectedWindow.set({visible:!0}):this.domElement.classList.remove(be.hidden)}get actualScale(){return Math.max(this.scale,.1)}get inverseScale(){return 1/this.actualScale}setScale(t){if(this.scale=t,t!==1){const{actualScale:s,inverseScale:r}=this;Ue(this.domElement,{transform:`scale(${s})`,width:this.clientWidth*r+"px",height:this.clientHeight*r+"px"})}else Ue(this.domElement,{transform:"none",width:this.clientWidth+"px",height:this.clientHeight+"px"})}_hide(t){this.hiddenBy=t,this.hide()}_restoreIfHiddenBy(t){this.hiddenBy===t&&(this.hiddenBy=null,this.show())}_dispose(){this.parent?.all.delete(this),this.scene.dispose(),this.frames.forEach(t=>t.onDisposed.dispatch()),this.frames.clear(),this.connectedWindow?.remove(),queueMicrotask(this.handleClose.bind(this))}_removeFrame(t){this.frames.delete(t)}close(){this.system._closeWindows(this.all)}handlePointer(t){if(!t.isPrimary||t.target!==t.currentTarget)return;this.updateMouseCoords(t.offsetX,t.offsetY);const{captureTarget:s}=this.system;if(s){const x=s.w;if(x.pointerTarget.setPointerCapture(t.pointerId),x!==this)return}const{scene:r}=this,i=Math.round(t.offsetX+r.x),n=Math.round(t.offsetY+r.y);let o=r.pick(i,n);for(;o;){const x=o.parent;if(!x)break;o=x}const l=o?.data?.hyper;let u,d;switch(t.type){case"pointerdown":{switch(t.button){case 0:l&&!l.disabled&&this.hyperClick(l,{x:i,y:n}),d=P.WM_LBUTTONDOWN,u=this.leftButtonDownSubs;break;case 1:d=P.WM_MBUTTONDOWN,u=this.middleButtonDownSubs;break;case 2:d=P.WM_RBUTTONDOWN,u=this.rightButtonDownSubs;break;default:return}break}case"pointerup":case"pointercancel":{switch(t.button){case 0:d=P.WM_LBUTTONUP,u=this.leftButtonUpSubs;break;case 1:d=P.WM_MBUTTONUP,u=this.middleButtonUpSubs;break;case 2:d=P.WM_RBUTTONUP,u=this.rightButtonUpSubs;break;default:return}break}case"pointermove":{this.cursorOverHyp=!!l&&!l.disabled,this.updateCursor(),d=P.WM_MOUSEMOVE,u=this.mouseMoveSubs;break}default:return}let p=i,E=n;const w=this.invmatrix;if(w){const x=i*w[2]+n*w[5]+w[8];p=(i*w[0]+n*w[3]+w[6])/x,E=(i*w[1]+n*w[4]+w[7])/x}const T=t.buttons&1?1:0,R=t.buttons&2?2:0,A=t.buttons&4?16:0,b=T|R|A;u.forEach((x,L)=>{if(!(s&&s.w===this&&s.s===L||x.has(o)||x.has(null))||!this.kernel.canHandleProjectUiEvents(L.prj))return;const{msg:U,xpos:B,ypos:G,fwkeys:C}=L.klass.vars;U&&(L.vars.setValue(U,d),B&&L.vars.setValue(B,p),G&&L.vars.setValue(G,E),C&&L.vars.setValue(C,b),L.compute(!0))})}handleKeyboard(t){if(t.target!==t.currentTarget)return;const{winVKey:s}=t;if(typeof s!="number")return;let r,i;switch(t.type){case"keydown":r=P.WM_KEYDOWN,i=this.keyDownSubs;break;case"keyup":r=P.WM_KEYUP,i=this.keyUpSubs;break;default:return}i.forEach(o=>{const{msg:l,wvkey:u,repeat:d,scancode:p}=o.klass.vars;!l||!this.kernel.canHandleProjectUiEvents(o.prj)||(o.vars.setValue(l,r),u&&o.vars.setValue(u,s),d&&o.vars.setValue(d,1),p&&o.vars.setValue(p,0),o.compute(!0))});const{winChar:n}=t;n&&this.keyCharSubs.forEach(o=>{const{msg:l,wvkey:u,repeat:d,scancode:p}=o.klass.vars;l&&(o.vars.setValue(l,ps),u&&o.vars.setValue(u,n),d&&o.vars.setValue(d,1),p&&o.vars.setValue(p,0),o.compute(!0))})}handleInput(t){let s;switch(t.type){case"input":s=768;break;case"focus":s=256;break;case"blur":s=512;break;case"click":s=0;break;default:return}this.controlNotifySubs.forEach((r,i)=>{if(!(r.has(t.target)||r.has(null)))return;const{msg:o,_hobject:l,iditem:u,wnotifycode:d}=i.klass.vars;o&&(i.vars.setValue(o,P.WM_CONTROLNOTIFY),l&&i.vars.setValue(l,t.target.key),u&&i.vars.setValue(u,0),d&&i.vars.setValue(d,s),i.compute(!0))})}handleClose(){const{key:t,name:s}=this;this.spaceDoneSubs.forEach(r=>{const{msg:i,_hspace:n,_windowName:o}=r.klass.vars;i&&(r.vars.setValue(i,P.WM_SPACEDONE),n&&r.vars.setValue(n,t),o&&r.vars.setValue(o,s),r.compute(!0))})}}function dO(e,t){const s=e.toUpperCase(),r=s.includes("WS_CHILD"),i=s.includes("WS_BYSPACE"),n=s.includes("WS_POPUP"),o=s.includes("WS_NORESIZE"),l=s.includes("WS_AUTOORG"),u=s.includes("WS_SPACESIZE"),d=s.includes("WS_NOCAPTION"),p=s.includes("WS_VSCROLL"),E=s.includes("WS_HSCROLL"),w=i?{...t}:{};return r&&(w.child=!0),E&&(w.hscroll=!0),p&&(w.vscroll=!0),u&&(w.size={type:"content"}),o&&(w.fixed=!0),n&&(w.popup=!0),l&&(w.autoorg=!0),d||(w.caption=!0),w}class fO{constructor(t,{sceneFactory:s,windowFactory:r}){this.kernel=t,this.scenes=new Map,this.windows=new Map,this.cursorVisible=!0,this.captureTarget=null,this.lastPickedPrimaryKey=0,this.clipboard=null,this.sceneFactory=s,this.windowFactory=r}createGSpace(t,s,r,i,n=0,o=0,l=0,u=0,d=""){let p=s;if(p){const k=this.windows.get(p);if(k)return k}let E=null,w=null,T=null;if(r){const k=this.kernel.classes.get(r),U=k?.scene;if(U)E=U,w={type:"classname",data:k.name},T=k.children;else{const B=t.dir.resolve(r),G=B.file()?.scene;G&&(E=G,w={type:"filename",data:B.toString()})}}if(!p){if(!E)return this.kernel._functionNotImplemented("Пустая сцена без имени"),null;p=E.options?.popup?"@PopupWindow":"MainWindow";const k=this.windows.get(p);if(k)return k}const R=dO(i,E?.options);!R.size&&l>0&&u>0&&(R.size={type:"fixed",width:l,height:u});const A=ge.freeKey(this.scenes),b={system:this,project:t,key:A,name:p,x:n,y:o,...E,options:R,source:w,sceneChildren:T},x=R.child&&this.windows.get(d);if(!x&&R.popup&&!this.kernel.iterations)return console.warn(`Невозможно открыть всплывающее окно '${p}' в координатах ${n}, ${o}`),null;const L=x?x.createChild(b):this.createWindow(b);return this.scenes.set(A,L),this.windows.set(p,L),L}createWindow(t){const s=new js(t),{x:r,y:i,name:n}=t,{popup:o=!1,caption:l=!1}=t.options,u=this.windowFactory.createWindow({content:s.domElement,x:r,y:i,title:n,popup:o,caption:l});return s.setConnectedWindow(u),s}setCapture(t,s){this.captureTarget={w:t,s}}releaseCapture(){this.captureTarget=null}showCursor(t){this.cursorVisible=t,this.windows.forEach(s=>s.updateCursor())}_closeWindows(t){this.scenes.forEach(s=>{t.has(s)&&(s===this.captureTarget?.w&&(this.captureTarget=null),s._dispose(),this.scenes.delete(s.key),this.windows.delete(s.name))})}clearAll(){this.scenes.clear(),this.windows.clear(),this.cursorVisible=!0,this.lastPickedPrimaryKey=0}hideProjectWindows(t,s){this.windows.forEach(r=>{r.project===t&&r._hide(s)})}closeProjectWindows(t){const s=new Set([...this.windows.values()].filter(r=>r.project===t));this._closeWindows(s),this.windows.forEach(r=>r._restoreIfHiddenBy(t))}}function gO(e,t,s,r,i,n,o,l){return this.kernel.windowSystem.createGSpace(this.prj,e,s,l,r,i,n,o,t)?.key||0}function pO(e){return this.kernel.windows.get(e)?.clientWidth??0}function _O(e){return this.kernel.windows.get(e)?.clientHeight??0}function EO(e){return this.kernel.scenes.get(e)?.name??""}function mO(e){return this.kernel.windows.get(e)?.x??0}function wO(e){return this.kernel.windows.get(e)?.y??0}function TO(e){return this.kernel.windows.get(e)?.key??0}function yO(e){return this.kernel.windows.get(e)?.clientWidth??0}function bO(e){return this.kernel.windows.get(e)?.clientHeight??0}function OO(e){return this.kernel.windows.get(e)?.title??""}function RO(e,t,s){const r=this.kernel.windows.get(e);return r?(r.setWindowSize(t,s),1):0}function MO(e,t,s,r){const i=this.kernel.windows.get(e);return i?(t>0?i.setScrollX(s,r):i.setScrollY(s,r),1):0}function vO(e,t,s){const r=this.kernel.windows.get(e);return r?(r.setWindowOrg(t,s),1):0}function SO(e,t,s,r,i){const n=this.kernel.windows.get(e);return n?(n.setWindowPos(t,s,r,i),1):0}function AO(e,t,s){const r=this.kernel.windows.get(e);return r?(r.setWindowSize(t,s),1):0}function NO(e,t){const s=this.kernel.windows.get(e);return s?(s.setTitle(t),1):0}function dn(e,t){const s=typeof e=="string"?this.kernel.windows.get(e):this.kernel.scenes.get(e);return s?(s.setOpacity(co(t,0,100)*.01),1):0}function fn(){return this.kernel._functionNotImplemented("SetWindowTransparentColor"),1}function gn(e,t){return t?(this.kernel._functionNotImplemented("SetWindowRegion"),1):0}function IO(){return this.kernel._functionNotImplemented("SetWindowOwner"),1}function xO(e,t){const s=this.kernel.windows.get(e);if(!s)return 0;switch(t){case P.SW_HIDE:s.hide();break;case P.SW_SHOW:case P.SW_NORMAL:s.show();break}return 1}function PO(e){const t=this.kernel.windows.get(e);return t?(t.toTop(),1):0}function LO(e){const t=this.kernel.windows.get(e);return t?(t.close(),1):0}function DO(){return 0}function kO(e){return this.kernel.windows.has(e)?1:0}function CO(e){return this.kernel.windows.get(e)?.isVisible?1:0}function GO(e,t,s){return this.kernel.windowSystem.createGSpace(this.prj,e,t,s)?.key||0}function FO(e,t,s){return this.kernel.windowSystem.createGSpace(this.prj,e,t,s)?.key||0}function BO(){return this.kernel._functionNotImplemented("OpenClassScheme"),1}function UO(){return this.kernel._functionNotImplemented("CloseClassScheme"),1}function WO(){}function VO(){}function $O(){}function jO(e,t){const s=this.kernel.windows.get(e)?.source;return s&&s.type===t.toLowerCase()&&s.data||""}function HO(e){e("CreateWindowEx",{a:[_,_,_,c,c,c,c,_],r:a},gO),e("GetClientWidth",{a:[_],r:c},pO),e("GetClientHeight",{a:[_],r:c},_O),e("GetWindowName",{a:[a],r:_},EO),e("GetWindowOrgX",{a:[_],r:c},mO),e("GetWindowOrgY",{a:[_],r:c},wO),e("GetWindowSpace",{a:[_],r:a},TO),e("GetWindowWidth",{a:[_],r:c},yO),e("GetWindowHeight",{a:[_],r:c},bO),e("GetWindowTitle",{a:[_],r:_},OO),e("SetClientSize",{a:[_,c,c],r:c},RO),e("SetScrollRange",{a:[_,c,c,c],r:c},MO),e("SetWindowOrg",{a:[_,c,c],r:c},vO),e("SetWindowPos",{a:[_,c,c,c,c],r:c},SO),e("SetWindowSize",{a:[_,c,c],r:c},AO),e("SetWindowTitle",{a:[_,_],r:c},NO),e("SetWindowTransparent",{a:[_,c],r:c},dn),e("SetWindowTransparent",{a:[a,c],r:c},dn),e("SetWindowTransparentColor",{a:[_,z],r:c},fn),e("SetWindowTransparentColor",{a:[a,z],r:c},fn),e("SetWindowRegion",{a:[_,a],r:c},gn),e("SetWindowRegion",{a:[a,a],r:c},gn),e("SetWindowOwner",{a:[a,a],r:c},IO),e("ShowWindow",{a:[_,c],r:c},xO),e("BringWindowToTop",{a:[_],r:c},PO),e("CloseWindow",{a:[_],r:c},LO),e("IsIconic",{a:[_],r:c},DO),e("IsWindowExist",{a:[_],r:c},kO),e("IsWindowVisible",{a:[_],r:c},CO),e("LoadSpaceWindow",{a:[_,_,_],r:a},GO),e("OpenSchemeWindow",{a:[_,_,_],r:a},FO),e("OpenClassScheme",{a:[_,c],r:a},BO),e("CloseClassScheme",{a:[_],r:c},UO),e("CascadeWindows",{},WO),e("Tile",{a:[c]},VO),e("ArrangeIcons",{},$O),e("GetWindowProp",{a:[_,_],r:_},jO)}const XO=[{name:"windows",register:HO,setup(e,t){if(!t)throw Error("Плагин 'windows': не указаны зависимости");const s=new fO(e,t);e.windowSystem=s,e.windows=s.windows,e.scenes=s.scenes,e.beforeProjectClosed.add(r=>s.closeProjectWindows(r)),e.beforeCompute.add(()=>s.windows.forEach(r=>r.beforeAll())),e.afterCompute.add(()=>s.windows.forEach(r=>r.afterAll())),e.beforeRender.add(()=>s.windows.forEach(r=>r.beforeRender()))}},Lb,cl,vl,Kl,Oh,Zd,ih,x_,C_,Q_,fE,pb,f_,nO,gh],YO=[lO];function zO(e){e.style.transformOrigin="top left",e.insertAdjacentHTML("afterend",`
<div id="mobzoom-icons-container">
    <img draggable="false" id="mobzoom-in-btn" src="images/zoom-in-icon.svg" />
    <img draggable="false" id="mobzoom-out-btn" src="images/zoom-out-icon.svg" />
</div>`);const s=document.getElementById("mobzoom-in-btn");s.oncontextmenu=C=>C.preventDefault();const r=document.getElementById("mobzoom-out-btn");r.oncontextmenu=C=>C.preventDefault();const i=new as(e.ownerDocument.defaultView);let n=1;const o=()=>{if(!isNaN(l))n*=1.05;else if(!isNaN(u))n*=.95;else return!1;return n=Math.min(Math.max(n,.1),1),e.style.transform=`scale(${n})`,e.style.width=`${100/n}%`,e.style.height=`${100/n}%`,!0};let l=NaN;s.onpointerdown=C=>{isNaN(l)&&(i.run(o),s.setPointerCapture(l=C.pointerId))},s.onpointerup=C=>{l===C.pointerId&&(l=NaN)},s.onpointercancel=C=>{l===C.pointerId&&(l=NaN)};let u=NaN;r.onpointerdown=C=>{isNaN(u)&&(i.run(o),r.setPointerCapture(u=C.pointerId))},r.onpointerup=C=>{u===C.pointerId&&(u=NaN)},r.onpointercancel=C=>{u===C.pointerId&&(u=NaN)};const d=new as(e.ownerDocument.defaultView);let p=null;const E=new Map;let w=0,T=0;function R(C){if(!(E.size>2)){if(E.size<2){p=null,(Math.abs(w)>1||Math.abs(T)>1)&&d.run(()=>(w-=Math.sign(w)*.4,T-=Math.sign(T)*.4,e.scrollLeft-=w,e.scrollTop-=T,Math.abs(w)>1||Math.abs(T)>1));return}C.stopPropagation();{p=[...E.values()];const[I,X]=p;I.x-X.x,I.y-X.y}}}let A=null;function b(C){E.set(C.pointerId,{id:C.pointerId,x:C.screenX,y:C.screenY}),d.stop(),C.isPrimary&&(A=[C.clientX,C.clientY]),R(C)}function x(C){E.delete(C.pointerId),C.isPrimary&&(A=null,L.stop()),R(C)}const L=new as(e.ownerDocument.defaultView),k=100;let U=[0,0];function B(){const[C,I]=U;if(A){const Z=C-A[0],he=I-A[1];if(Z**2+he**2<100)return!1}let X=0,q=0;if(C<k)X=C-k;else{const Z=window.innerWidth-C;Z<k&&(X=k-Z)}if(X/=40,I<k)q=I-k;else{const Z=window.innerHeight-I;Z<k&&(q=k-Z)}return q/=40,X&&(e.scrollLeft+=Math.E**Math.abs(X)*Math.sign(X)),q&&(e.scrollTop+=Math.E**Math.abs(q)*Math.sign(q)),!0}function G(C){if(!p&&C.isPrimary?(U[0]=C.clientX,U[1]=C.clientY,L.run(B)):L.stop(),!p)return;const I=E.get(C.pointerId);if(I){C.isPrimary||(C.stopPropagation(),w=C.screenX-I.x,T=C.screenY-I.y,e.scrollLeft-=w,e.scrollTop-=T);{const[X,q]=p;X.x-q.x,X.y-q.y}I.x=C.screenX,I.y=C.screenY}}e.addEventListener("pointerdown",b,{capture:!0}),e.addEventListener("pointerup",x),e.addEventListener("pointercancel",x),e.addEventListener("pointermove",G,{capture:!0})}const vt={root:"ca85FLNJ",mywindow:"xTNo9oHR",top:"mzQLXysK",popup:"_7gglv7SA","close-button":"c6XZRF-R"};function KO(){const e=document.createElement("button");return e.textContent="×",e.className=vt["close-button"],e}class qO{constructor(t,{popup:s,content:r,...i},n=null){this.system=t,this.relativeTo=n,this.onClosed=new Ee,this.x=0,this.y=0,this.width=0,this.height=0,this.title="",this.visible=!0,this.scale=1,this.instantClose=!1,this.isClosed=!1,this.hideTimeout=0;const o=this.view=r;if(this.popup=s||!1,this.set(i),this.width=o.clientWidth,this.height=o.clientHeight,s)o.addEventListener("focusout",this.onFocusOut.bind(this));else if(i.caption){const l=KO();o.children.item(0)?.append(l),l.addEventListener("click",this.close.bind(this)),this.instantClose=!0}}onFocusOut(t){this.view.contains(t.relatedTarget)||this.close()}close(){this.isClosed||(this.isClosed=!0,this.remove(),this.onClosed.dispatch())}toTop(){}set({x:t=this.x,y:s=this.y,title:r=this.title,visible:i=this.visible,preserveX:n}){const{view:o}=this,{style:l}=o;if(this.title!==r&&(this.view.ariaLabel=`Окно '${r}'`),this.popup){if(n){const u=this.relativeTo?.offsetLeft||0;l.setProperty("left",t+u+"px"),l.setProperty("right","unset")}else l.removeProperty("left"),l.removeProperty("right");if(this.y!==s){const u=this.relativeTo?.offsetTop||0;l.setProperty("top",s+u+"px")}}return this.visible!==i&&(this.view.style.opacity=i?"1":"0",this.hideTimeout&&window.clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>this.view.style.setProperty("display",i?"block":"none"),i?0:250)),this.x=t,this.y=s,this.title=r,this.visible=i,this}makeRelativeTo(t){if(this.popup){const{style:s}=this.view,r=t.offsetLeft();console.log(this.x,r),s.setProperty("left",this.x+r+"px"),s.setProperty("right","unset");const i=t.offsetTop();s.setProperty("top",this.y+i+"px")}}offsetLeft(){return this.view.offsetLeft}offsetTop(){return this.view.offsetTop}remove1(){this.view.style.opacity="0",setTimeout(()=>this.view.remove(),250)}remove(){this.system._removeWindow(this),this.popup?this.remove1():this.remove1()}}class JO{constructor(t){this.firstWindow=null;const s=(typeof t=="string"?document.getElementById(t):t)||document.body,r=this.root=document.createElement("div");r.classList.add(vt.root,"stratum-player-root"),s.append(r),re.touchGestures&&zO(s)}get screenWidth(){return this.root.clientWidth}get screenHeight(){return this.root.clientHeight}_removeWindow(t){this.firstWindow===t&&(this.firstWindow=null)}createWindow(t){const s=t.content;s.classList.add(vt.mywindow,t.popup?vt.popup:vt.top);let{x:r=0,y:i=0}=t;s.style.opacity="0",queueMicrotask(()=>s.style.opacity="1"),this.root.appendChild(s),t.popup&&(r=Math.max(r,0),i=Math.max(i,0),s.offsetHeight&&(i=Math.min(i,this.screenHeight-s.offsetHeight-11)),Ue(s,{left:r+"px",top:i+"px"}));const n=document.activeElement?.hasAttribute("data-gspace-key")?document.activeElement:null,o=new qO(this,{...t,x:r,y:i},n);return!t.popup&&!this.firstWindow&&(this.firstWindow=o),requestAnimationFrame(()=>s.focus()),o}}const pn={src:eo,mount:"library"};class Hs{constructor(t=""){this.name=t,this.type="folder",this.items=new Map}}class Xs{constructor(t,s){this.root=t,this.stdlibDir=s,this.uploadsDir=new pe(this.root,["D:","Uploads"]),this.downloadsDir=new pe(this.root,["D:","Downloads"]),this.loadedLibs=new Set,this.uploadsDir.create("folder"),this.downloadsDir.create("folder")}static async create(){const t=new Hs,s=new pe(t,["D:",pn.mount]),{files:r}=await un(pn,{cache:re.cache});return r.forEach(i=>s.resolve(i.path).createWithDirs(i)),new Xs(t,s)}async mountLibrary(t){if(this.loadedLibs.size===this.loadedLibs.add(t.src).size)return;const{files:s}=t.data||await un(t,{cache:re.cache});s.forEach(r=>this.path(t.mount?`${t.mount}/${r.path}`:r.path).createWithDirs(r))}path(t){return new pe(this.root,["C:"].concat(t.split("/")))}}class _n{constructor(t,s={}){this.path=t,this.type="file",this.size=null,this.cls=null,this.image=null,this.scene=null,this.video=null,this.audio=null,this.ttf=null,this.cursor=null,this.stt=null,this.mat=null,this.base64=null,this.mesh=null,this.set(s)}set({size:t=this.size,cls:s=this.cls,image:r=this.image,scene:i=this.scene,video:n=this.video,audio:o=this.audio,ttf:l=this.ttf,cursor:u=this.cursor,stt:d=this.stt,mat:p=this.mat,mesh:E=this.mesh,base64:w=this.base64}){return this.size=t,this.cls=s,this.image=r,this.scene=i,this.video=n,this.audio=o,this.ttf=l,this.cursor=u,this.stt=d,this.mat=p,this.mesh=E,this.base64=w,this}}class pe{constructor(t,s,r){if(this.fs=t,this.parts=s,this.str=null,s[0].length!==2&&s[0][1]!==":")throw Error("Неправильное имя тома диска");this.partsUC=r??s.map(i=>i.toUpperCase())}static splitPath(t){return t.split(/[/\\]/).map(s=>s.trim()).filter(s=>s.length>0)}resolve(t){const s=pe.splitPath(t);if(!s.length)return this;const r=s[0].length===2&&s[0][1]===":",i=r?[s[0]]:this.parts.slice(),n=r?[s[0].toUpperCase()]:this.partsUC.slice();for(let o=r?1:0;o<s.length;++o){const l=s[o];l===".."?i.length>1&&(i.pop(),n.pop()):l!=="."&&(i.push(l),n.push(l.toUpperCase()))}return new pe(this.fs,i,n)}toString(){return this.str?this.str:this.str=this.parts.join("\\")}basename(){return this.parts[this.parts.length-1]}equals(t){if(this===t)return!0;const s=this.partsUC,r=t.partsUC;if(s.length!==r.length)return!1;for(let i=0;i<s.length;++i)if(s[i]!==r[i])return!1;return!0}startsWith(t){const s=this.partsUC,r=t.partsUC;if(s.length<r.length)return!1;for(let i=0;i<r.length;++i)if(s[i]!==r[i])return!1;return!0}static getFolder(t,s,r){let i=t;for(let n=0;n<s.length-(r?0:1);++n){const o=i.items.get(s[n]);if(!o||o.type!=="folder")return null;i=o}return i}create(t,s){const{partsUC:r}=this,i=pe.getFolder(this.fs,r);if(!i)return null;const n=r[r.length-1],o=i.items.get(n);if(t==="folder")return o||i.items.set(n,new Hs),this;if(o)return o.type!=="file"?null:(s&&o.set(s),o);const l=new _n(this,s);return i.items.set(n,l),l}createWithDirs(t){const{parts:s,partsUC:r}=this;let i=this.fs;for(let u=0;u<s.length-1;++u){let d=i.items.get(r[u]);if(!d)d=new Hs(s[u]),i.items.set(r[u],d);else if(d.type==="file")throw Error(`Невозможно создать директорию ${this}: файл ${d.path} уже существует.`);i=d}const n=r[r.length-1];if(i.items.has(n))throw Error(`Невозможно создать директорию ${this}: файл уже существует.`);const l=new _n(this,t);return i.items.set(n,l),l}fileExist(){const{partsUC:t}=this,s=pe.getFolder(this.fs,t);if(!s)return!1;const r=t[t.length-1];return s.items.get(r)?.type==="file"}file(){const{partsUC:t}=this,s=pe.getFolder(this.fs,t);if(!s)return re.debugFile&&console.warn(`${this.toString()} не существует`),null;const r=t[t.length-1],i=s.items.get(r);return i?i.type!=="file"?(re.debugFile&&console.warn(`${this.toString()} является каталогом`),null):i:(re.debugFile&&console.warn(`${this.toString()} не существует`),null)}forEach(t,s){const{partsUC:r}=this,i=pe.getFolder(this.fs,r,!0);i&&i.items.forEach(function n(o){o.type==="folder"?s&&o.items.forEach(n):t(o)})}resolveMany(){const{partsUC:t}=this,s=pe.getFolder(this.fs,t);if(!s)return[];const r=t[t.length-1];if(r.includes("*")){const[o,l]=r.split("*");let u;return!o&&!l?u=[".","..",...s.items]:u=[...s.items].filter(([d])=>d.startsWith(o)&&d.endsWith(l)),u.map(d=>{if(typeof d=="string")return{name:d,size:0};const p=d[1];return p.type==="folder"?{name:p.name,size:0}:{name:p.path.basename(),size:p.size??0}})}const i=s.items.get(r);return i?[i.type==="folder"?{name:i.name,size:0}:{name:i.path.basename(),size:i.size??0}]:[]}}class ZO{constructor(){}create(t,s){switch(s){case"canvas":return new ic(t);default:return new Uc(t)}}}async function QO(e){const t=await Xs.create(),s=new JO(re.root),r=s.root.ownerDocument.defaultView||window,i=new Ba(t,e,r),o={sceneFactory:new ZO,windowFactory:s};return XO.forEach(l=>i.addPlugin(l,o)),YO.forEach(l=>i.addOptionalPlugin(l,o)),new Ua(i).ready()}const eR="7.0.0";return ft.create=QO,ft.options=re,ft.version=eR,Object.defineProperty(ft,Symbol.toStringTag,{value:"Module"}),ft})({});
;var $GH_COMMIT = '8690447 chore(player): 7.0.0';
