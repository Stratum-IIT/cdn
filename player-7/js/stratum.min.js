(function(){"use strict";try{if(typeof document<"u"){var o=document.createElement("style");o.appendChild(document.createTextNode(".yNr0VPwT{position:relative;user-select:none;width:100%;height:100%;overflow:clip}.yNr0VPwT>canvas{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%}.yNr0VPwT .doAE-L2e{all:unset;position:absolute;pointer-events:auto;background-color:#fff;resize:none;white-space:pre;box-sizing:border-box}.yNr0VPwT ._8PHlccAK{position:absolute;pointer-events:auto;background-color:#000}.yNr0VPwT.k7TCS6Hm .doAE-L2e{pointer-events:none}.yNr0VPwT .doAE-L2e.-QksePcc{white-space:wrap}.yNr0VPwT .doAE-L2e:not(.-QksePcc){overflow:hidden}.yNr0VPwT textarea.doAE-L2e.ZFAGmpo5{text-align:center}.yNr0VPwT textarea.doAE-L2e.GnGoYW5X{border:inset 2px}.yNr0VPwT input[type=button].doAE-L2e{user-select:none;border:outset 2px;background-color:#f0f0f0;text-align:center}.yNr0VPwT input[type=button].doAE-L2e:active{border-style:inset}._8OpWP1FD{border-radius:16px;width:30%}._8OpWP1FD form{display:flex;flex-direction:column}._8OpWP1FD form menu{display:flex;flex-direction:column;gap:4px}._8OpWP1FD form button{height:40px}._8OpWP1FD form button[value=ok]:enabled{background-color:#90ee90}._8OpWP1FD form p{display:flex;justify-content:center}._8OpWP1FD input::file-selector-button{font-weight:700;color:#1e90ff;padding:.5em;border:thin solid grey;border-radius:3px}.wfzRA-In{position:relative;overflow:hidden;outline:none;transform-origin:top left}.wfzRA-In.XuJ-kAtH{overflow-x:auto}.wfzRA-In.W6TE00tK{overflow-y:auto}.wfzRA-In._9uw8jyO-{display:none}.wfzRA-In .wfzRA-In{position:absolute}.wfzRA-In .cl0-v9U2{position:sticky!important;top:0;left:0}.wfzRA-In .stXveFcA{pointer-events:none;position:absolute!important;top:0;left:0}.wfzRA-In .V7VkKPPF{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%}.ca85FLNJ{position:relative;overflow:auto;min-width:300px;min-height:300px}.xTNo9oHR{position:absolute!important;margin:0 auto;left:0;right:0}.xTNo9oHR.mzQLXysK{transition:opacity .25s linear,box-shadow .1s linear}.xTNo9oHR.mzQLXysK:focus-within{box-shadow:0 2px 6px #0000004d}.xTNo9oHR._7gglv7SA{transition:opacity .25s linear;box-shadow:13px 11px 6px #0000007f;border:1px black solid}.xTNo9oHR .c6XZRF-R{padding:0;background-color:transparent;border:none;position:absolute;top:0;right:8px;font-size:26px;cursor:pointer;color:#333}.xTNo9oHR .c6XZRF-R:hover{color:red}")),document.head.appendChild(o)}}catch(e){console.error("vite-plugin-css-injected-by-js",e)}})();
var stratumPlayer=(function(ut){"use strict";const xn=["gray","blue","navy","gray","#b5b5b5","white","black","black","black","white","gray","gray","gray","navy","white","#b5b5b5","gray","gray","black","gray","white"];function Pn(e){const t=parseInt(e);if(!isNaN(t))return t;const r=e.toLowerCase().trim();if(r.startsWith("rgb")){const s=r.split("(")[1].split(")")[0].split(",").map(i=>parseInt(i));return s[0]|s[1]<<8|s[2]<<16}return r.startsWith("transparent")?16777216:r.startsWith("syscolor")?33554432|parseInt(r.split("(")[1].split(")")[0]):0}function Mt(e){if(e&16777216)return null;const t=e&255;if(e&33554432)return xn[t]||"black";const r=e>>8&255,s=e>>16&255;return e&67108864?`rgba(${t},${r},${s}, 0.5)`:`rgb(${t},${r},${s})`}function ir(e,t,r,s){const i=s==="transparent"?16777216:s==="syscolor"?33554432:s==="editor"?67108864:0;return e&255|(t&255)<<8|(r&255)<<16|i}function qr(e){return e&255}function Zr(e){return e>>8&255}function Jr(e){return e>>16&255}function Dn(e){if(e&16777216)return"Transparent";const t=e&255;if(e&33554432)return`SysColor(${t})`;const r=e>>8&255,s=e>>16&255;return`rgb(${t},${r},${s})`}const nr=1,or=4,cr=8,Qr=8192;function es(e){return e>>8&31}const ts=1,kn=2,Ln=4,rs=8,Ne=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],ss=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function St(e){if(e>=ss.length)throw new Error("Unable to parse base64 string.");const t=ss[e];if(t===255)throw new Error("Unable to parse base64 string.");return t}function is(e){let t="",r,s=e.length;for(r=2;r<s;r+=3)t+=Ne[e[r-2]>>2],t+=Ne[(e[r-2]&3)<<4|e[r-1]>>4],t+=Ne[(e[r-1]&15)<<2|e[r]>>6],t+=Ne[e[r]&63];return r===s+1&&(t+=Ne[e[r-2]>>2],t+=Ne[(e[r-2]&3)<<4],t+="=="),r===s&&(t+=Ne[e[r-2]>>2],t+=Ne[(e[r-2]&3)<<4|e[r-1]>>4],t+=Ne[(e[r-1]&15)<<2],t+="="),t}function ns(e){if(e.length%4!==0)throw new Error("Unable to parse base64 string.");const t=e.indexOf("=");if(t!==-1&&t<e.length-2)throw new Error("Unable to parse base64 string.");let r=e.endsWith("==")?2:e.endsWith("=")?1:0,s=e.length,i=new Uint8Array(3*(s/4)),n;for(let a=0,l=0;a<s;a+=4,l+=3)n=St(e.charCodeAt(a))<<18|St(e.charCodeAt(a+1))<<12|St(e.charCodeAt(a+2))<<6|St(e.charCodeAt(a+3)),i[l]=n>>16,i[l+1]=n>>8&255,i[l+2]=n&255;return i.subarray(0,i.length-r)}const _e=[...Array.from({length:128},(e,t)=>String.fromCharCode(t)),"Ђ","Ѓ","‚","ѓ","„","…","†","‡","€","‰","Љ","‹","Њ","Ќ","Ћ","Џ","ђ","‘","’","“","”","•","–","—","","™","љ","›","њ","ќ","ћ","џ"," ","Ў","ў","Ћ","¤","Ґ","¦","§","Ё","©","Є","«","¬","","®","Ї","°","±","І","і","ґ","µ","¶","·","ё","№","є","»","ј","Ѕ","ѕ","ї","А","Б","В","Г","Д","Е","Ж","З","И","Й","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ъ","Ы","Ь","Э","Ю","Я","а","б","в","г","д","е","ж","з","и","й","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я"];function Nt(e){return Array.from(e).map(t=>_e[t]).join("")}const It=32,Cn=10;function At(e){return new Uint8Array([...e].map(t=>{const r=_e.indexOf(t);return r>-1?r:It}))}class Ee{constructor(){this.listeners=new Set,this.listenersOnce=new Set}add(t){this.listeners.add(t)}addOnce(t){this.listenersOnce.add(t)}remove(t){this.listeners.delete(t),this.listenersOnce.delete(t)}dispatch(...t){this.listeners.forEach(r=>r(...t)),this.listenersOnce.forEach(r=>r(...t)),this.listenersOnce.clear()}}new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare;class ar{constructor(t,r){this.data=new Array(t.length);for(let s=0,i=t[0].length;s<t.length;s++){this.data[s]=new Array(i);for(let n=0;n<i;n++)this.data[s][n]=t[s][n]}if(r){if(typeof r[0]!="object")for(let s=0;s<r.length;s++)r[s]=[r[s]];this.mirror=new ar(r)}}swap(t,r){this.mirror&&this.mirror.swap(t,r);const s=this.data[t];this.data[t]=this.data[r],this.data[r]=s}multline(t,r){this.mirror&&this.mirror.multline(t,r);const s=this.data[t];for(let i=s.length-1;i>=0;i--)s[i]*=r}addmul(t,r,s){this.mirror&&this.mirror.addmul(t,r,s);const i=this.data[t],n=this.data[r];for(let a=i.length-1;a>=0;a--)i[a]=i[a]+s*n[a]}hasNullLine(t){for(let r=0;r<this.data[t].length;r++)if(this.data[t][r]!==0)return!1;return!0}gauss(){let t=0;const r=this.data.length,s=this.data[0].length,i=[];for(let n=0;n<s;n++){let a=0,l=0;for(let h=t;h<r;h++){const d=this.data[h][n];Math.abs(d)>Math.abs(a)&&(l=h,a=d)}if(a===0)i.push(t);else{this.multline(l,1/a),this.swap(l,t);for(let h=0;h<r;h++)h!==t&&this.addmul(h,t,-this.data[h][n])}t++}for(let n=0;n<i.length;n++)if(!this.mirror.hasNullLine(i[n]))throw new Error("singular matrix");return this.mirror.data}}function Gn(e){const{a:t,b:r}=e,s=new ar(t,r).gauss();if(s.length>0&&s[0].length===1)for(let i=0;i<s.length;i++)s[i]=s[i][0];return s}function os(e,t,r,s){const i=r-e,n=s-t;return Math.sqrt(i*i+n*n)}function cs(e,t,r,s,i){for(let n=t?0:2,a=t?e.length-2:0;n<e.length;a=n,n+=2){const l=e[n],h=e[n+1],d=e[a],g=e[a+1],E=l-d,T=h-g,m=E*E+T*T;if(m===0&&os(s,i,d,g)<=r)return a/2;let O=((s-d)*E+(i-g)*T)/m;if(O=Math.max(0,Math.min(1,O)),os(s,i,d+O*E,g+O*T)<=r)return a/2}return-1}function Bn(e,t,r){let s=!1;for(let i=0,n=e.length-2;i<e.length;n=i,i+=2){const a=e[i],l=e[i+1],h=e[n],d=e[n+1];(l<=r&&r<d||d<=r&&r<l)&&d-l!==0&&t>(h-a)*(r-l)/(d-l)+a&&(s=!s)}return s}const Fn="stdlib",Ke={contentUrl:"./content"};function dt(e){if(e.startsWith("res:")){const t=e.slice(4);return t.startsWith("stdlib/")?`${Ke.contentUrl}/stdlib/res/${t.slice(7)}`:`${Ke.contentUrl}/libs/${t.slice(0,2)}/${t.slice(2,22)}/res/${t.slice(23)}`}return e.startsWith("icon:")?`${Ke.contentUrl}/icons/${e.slice(5)}.png`:e}function Wn(e){return e==="stdlib"?`${Ke.contentUrl}/stdlib/index.json`:`${Ke.contentUrl}/libs/${e.slice(0,2)}/${e.slice(2)}/index.json`}function Un(e){const t=e[0]*(e[4]*e[8]-e[7]*e[5])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]);return[(e[4]*e[8]-e[7]*e[5])/t,(e[2]*e[7]-e[1]*e[8])/t,(e[1]*e[5]-e[2]*e[4])/t,(e[5]*e[6]-e[3]*e[8])/t,(e[0]*e[8]-e[2]*e[6])/t,(e[3]*e[2]-e[0]*e[5])/t,(e[3]*e[7]-e[6]*e[4])/t,(e[6]*e[1]-e[0]*e[7])/t,(e[0]*e[4]-e[3]*e[1])/t]}class me{constructor(t){this.m=new Map,t?.forEach(([r,s])=>this.set(r,s))}set(t,r){const s=this.m.get(t);return s?s.add(r):this.m.set(t,new Set([r])),this}get(t){return this.m.get(t)??null}delete(t){return this.m.delete(t)}forEach(t){return this.m.forEach(t)}[Symbol.iterator](){return this.m.entries()}values(){return this.m.values()}}const Vn=[" "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","!","∀","#","∃","%","&","∍","(",")","*","+",",","−",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","≅","Α","Β","Χ","Δ","Ε","Φ","Γ","Η","Ι","ϑ","Κ","Λ","Μ","Ν","Ο","Π","Θ","Ρ","Σ","Τ","Υ","ς","Ω","Ξ","Ψ","Ζ","[","∴","]","⊥","_","‾","α","β","χ","δ","ε","φ","γ","η","ι","ϕ","κ","λ","μ","ν","ο","π","θ","ρ","σ","τ","υ","ϖ","ω","ξ","ψ","ζ","{","|","}","~"," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","€","ϒ","′","≤","⁄","∞","ƒ","♣","♦","♥","♠","↔","←","↑","→","↓","°","±","″","≥","×","∝","∂","•","÷","≠","≡","≈","…","⏐","⎯","↵","ℵ","ℑ","ℜ","℘","⊗","⊕","∅","∩","∪","⊃","⊇","⊄","⊂","⊆","∈","∉","∠","∇","®","©","™","∏","√","⋅","¬","∧","∨","⇔","⇐","⇑","⇒","⇓","◊","〈","®","©","™","∑","⎛","⎜","⎝","⎡","⎢","⎣","⎧","⎨","⎩","⎪"," ","〉","∫","⌠","⎮","⌡","⎞","⎟","⎠","⎤","⎥","⎦","⎫","⎬","⎭"," "];function $n(e){let t="";for(let r=0;r<e.length;++r){let s=_e.indexOf(e[r]);s===142?s=163:s<0&&(s=0),t+=Vn[s]}return t}class he extends Map{static freeKey(t,r){let s=r||0;for(;t.has(++s););return s}static freeNegativeKey(t){let r=0;for(;t.has(--r););return r}}function as(e){return(e&e-1)===0}function jn(e,t,r){return Math.min(Math.max(e,t),r)}function ls(e){return new Array().concat(...e)}function hs(e,t){const r=[];for(const s of e)t(s)&&r.push(s);return r}function Hn(e,t){const r=[];for(const s of e){const i=t(s);i&&r.push(i)}return r}function Xn(e){return Math.round(e*1e5)/1e5}function vt(e,t="no additional info provided"){if(!e)throw new Error("Assertion Error: "+t)}class $e{constructor(t,r,{key:s,data:i}){this.scene=t,this.m=r,this.subs=new Set,this.key=s||he.freeKey(r),this.key>0&&this.m.set(this.key,this),this.data=i?{...i}:{}}delete(){return this.subs.size?!1:(this.key>0&&this.m.delete(this.key),this.key=0,!0)}toJSON(){const{key:t,data:r}=this;let s;for(const i in r){const n=r[i];typeof n<"u"&&((s||={})[i]=n)}return s?{key:t,data:s}:{key:t}}}class qe extends $e{constructor(t,r){super(t,t.objects,r),this.parent=null,this._deletedByParent=!1;const{x:s,y:i,width:n,height:a,attrib:l}=r;this.x=s||0,this.y=i||0,this.width=n||0,this.height=a||0,this.attrib=l||0}delete(){if(super.delete(),this._deletedByParent)return!0;const{parent:t,scene:r}=this;return t?.set({children:t.children.filter(s=>s.key)}),r.set({order:r.order.filter(s=>s.key)}),!0}set({x:t=this.x,y:r=this.y,attrib:s=this.attrib,width:i=this.width,height:n=this.height}){let a=!1;const l=t-this.x,h=r-this.y;if((l!==0||h!==0)&&(this._onMoved(l,h),a=!0),this.width!==i||this.height!==n){const d=this.width||1,g=this.height||1,E=i&&i>0?i:d,T=n&&n>0?n:g,m=E/d,O=T/g;(m!==1||O!==1)&&(this._onResized(this.x,this.y,m,O),a=!0)}return this.attrib!==s&&(this.attrib=s,this.onAttribChanged()),a&&this.parent?._childChanged(),this}rotate(t,r){if(t===0)return this;const s=r?.x??this.x,i=r?.y??this.y;return this._onRotated(s,i,t),this.parent?._childChanged(),this}isVisible(){const t=this.attrib,r=t&nr,s=1<<es(t)&this.scene.hiddenLayers,i=t&Qr;return!(r||s&&!i)}updateBBox(t,r,s,i){this.x=t,this.y=r,this.width=s,this.height=i}_onMoved(t,r){this.updateBBox(this.x+t,this.y+r,this.width,this.height)}_onResized(t,r,s,i){const n=t+(this.x-t)*s,a=r+(this.y-r)*i,l=(this.width||1)*s,h=(this.height||1)*i;this.updateBBox(n,a,l,h)}_onRotated(t,r,s){const i=Math.sin(s),n=Math.cos(s),a=this.x-t,l=this.y-r,h=a*n-l*i+t,d=a*i+l*n+r;this.updateBBox(h,d,this.width,this.height)}toJSON(){const{attrib:t,height:r,width:s,x:i,y:n}=this;return{...super.toJSON(),attrib:t,height:r,width:s,x:i,y:n}}toString(){return"Графический элемент"}}class Yn extends qe{constructor(t,r,s){super(t,s),this.type="group",this.children=[],this.set({...s,children:r})}delete(t){return this.children.forEach(r=>{r._deletedByParent=!0,r.delete(t)}),super.delete()}set(t,r){typeof t.children<"u"&&(this.children.forEach(i=>i.parent=null),this.children=t.children,this.children.forEach(i=>i.parent=this),this.children.length>0?this._childChanged():(this.updateBBox(this.x,this.y,0,0),this.parent?._childChanged()));const{attrib:s}=t;return typeof s<"u"&&!r&&this.children.forEach(i=>i.set({attrib:s})),super.set(t)}_childChanged(){let t=1/0,r=-1/0,s=1/0,i=-1/0;this.children.forEach(n=>{t=Math.min(t,n.x),s=Math.min(s,n.y),r=Math.max(r,n.x+n.width),i=Math.max(i,n.y+n.height)}),this.updateBBox(t,s,r-t,i-s),this.parent?._childChanged()}_onMoved(t,r){if(this.children.length===0){super._onMoved(t,r);return}this.children.forEach(s=>s._onMoved(t,r)),this.updateBBox(this.x+t,this.y+r,this.width,this.height)}_onResized(t,r,s,i){if(this.children.length===0){super._onResized(t,r,s,i);return}let n=1/0,a=-1/0,l=1/0,h=-1/0;this.children.forEach(d=>{d._onResized(t,r,s,i),n=Math.min(n,d.x),l=Math.min(l,d.y),a=Math.max(a,d.x+d.width),h=Math.max(h,d.y+d.height)}),this.updateBBox(n,l,a-n,h-l)}_onRotated(t,r,s){if(this.children.length===0){super._onRotated(t,r,s);return}let i=1/0,n=-1/0,a=1/0,l=-1/0;this.children.forEach(h=>{h._onRotated(t,r,s),i=Math.min(i,h.x),a=Math.min(a,h.y),n=Math.max(n,h.x+h.width),l=Math.max(l,h.y+h.height)}),this.updateBBox(i,a,n-i,l-a)}*descendants(t){for(const r of this.children)t&&r.key<=0||(r.type==="group"&&(yield*r.descendants(t)),yield r)}onAttribChanged(){}toJSON(){const{type:t}=this,{x:r,y:s,width:i,height:n,...a}=super.toJSON(),l=this.children.filter(h=>h.key>0).map(h=>h.key);return{...a,type:t,children:l}}toString(){return"Группа"}}class zn{constructor(){this.type="scene",this.onInputChanged=new Ee,this.objects=new Map,this.pens=new Map,this.brushes=new Map,this.images=new Map,this.imagesOpaque=new Map,this.strings=new Map,this.fonts=new Map,this.texts=new Map,this.x=0,this.y=0,this.order=[],this.background=null,this.hiddenLayers=0,this.grid=null,this.selectUnselectable=!1,this.disableInputs=!1}init(t){if(!t)return;this.set({...t,background:void 0,order:void 0}).merge(t,"exact");const r=t.background&&this.brushes.get(t.background);r&&this.set({background:r})}set({x:t=this.x,y:r=this.y,order:s=this.order,hiddenLayers:i=this.hiddenLayers,selectUnselectable:n=this.selectUnselectable,disableInputs:a=this.disableInputs,grid:l=this.grid,background:h=this.background}){return this.background!==h&&(this.background?.subs.delete(this),this.background=h,this.background?.subs.add(this),this.onBackgroundChanged()),this.disableInputs!==a&&(this.disableInputs=a,this.onDisableInputsChanged()),(this.x!==t||this.y!==r)&&(this.x=Math.round(t),this.y=Math.round(r),this.onOriginChanged()),this.hiddenLayers!==i&&(this.hiddenLayers=i,this.onLayersChanged()),this.order=s,this.selectUnselectable=n,this.grid=l,this}pick(t,r){const{order:s,hiddenLayers:i,selectUnselectable:n}=this;for(let a=s.length-1;a>=0;--a){const l=s[a],h=l.attrib,d=h&nr,g=h&Qr,E=h&or,T=h&cr,m=es(h);if(d||T&&!n||!g&&1<<m&i||E)continue;let O=t-l.x,N=r-l.y,y=0;if(l.type==="line"){if(l.pen)y=l.pen.width/2||.5;else if(!l.brush)continue;y=Math.max(y,4)}else if(l.type==="textView"||l.type==="imageView"){const P=Math.sin(-l.angle),C=Math.cos(-l.angle),L=O*C-N*P,W=O*P+N*C;O=L,N=W}if(!(O<-y||O>l.width+y||N<-y||N>l.height+y)&&!(l.type==="line"&&!l.inside(O,N,y)))return l}return null}toJSON(){const{background:t,x:r,y:s,hiddenLayers:i,selectUnselectable:n,grid:a,pens:l,brushes:h,images:d,imagesOpaque:g,fonts:E,strings:T,texts:m,objects:O,order:N}=this;return{background:t?.key,x:r,y:s,hiddenLayers:i,selectUnselectable:n,grid:a,pens:[...l.values()].map(y=>y.toJSON()),brushes:[...h.values()].map(y=>y.toJSON()),images:[...d.values()].map(y=>y.toJSON()),imagesOpaque:[...g.values()].map(y=>y.toJSON()),fonts:[...E.values()].map(y=>y.toJSON()),strings:[...T.values()].map(y=>y.toJSON()),texts:[...m.values()].map(y=>y.toJSON()),objects:[...O.values()].map(y=>y.toJSON()),order:N.filter(y=>y.key>0).map(y=>y.key)}}merge(t,r="free",s){const i=r==="free"?0:-1;function n(x,j){return r==="exact"?j?{...x,...j}:x:{...x,...j,key:i}}const a=t.pens?.map(x=>[x.key,this.pen(n(x))]),l=t.images?.map(x=>[x.key,this.image(x,n(x))]),h=t.imagesOpaque?.map(x=>[x.key,this.image(x,n(x,{opaque:!0}))]),d=t.fonts?.map(x=>[x.key,this.font(n(x))]),g=t.strings?.map(x=>[x.key,this.string(x.text||"",n(x))]),E=a?new Map(a):this.pens,T=l?new Map(l):this.images,m=h?new Map(h):this.imagesOpaque,O=d?new Map(d):this.fonts,N=g?new Map(g):this.strings,y=t.brushes?.map(x=>{const j=x.image&&m.get(x.image)||null;return[x.key,this.brush(n(x,{image:j}))]}),P=y?new Map(y):this.brushes,C=t.texts?.map(x=>{const j=x.parts.map((Z,Q)=>{const ue=O.get(Z.font)||Pe(`Текст #${x.key}[${Q}]: Шрифт #${Z.font} не существует`),le=N.get(Z.string)||Pe(`Текст #${x.key}[${Q}]: Строка #${Z.string} не существует`);return{...Z,font:ue,string:le}});return[x.key,this.text(j,n(x))]}),L=C?new Map(C):this.texts,W=[],F=t.objects?.map(x=>{switch(x.type){case"line":{const j=x.pen&&E.get(x.pen)||null,Z=x.brush&&P.get(x.brush)||null;return[x.key,this.line(x.coords,n(x,{pen:j,brush:Z}))]}case"imageView":{const Z=(x.opaque?m:T).get(x.image)||Pe(`ImageView (opaque: ${x.opaque}) #${x.key}: Изображение #${x.image} не существует`);return[x.key,this.imageView(Z,n(x))]}case"textView":{const j=L.get(x.text)||Pe(`TextView #${x.key}: Текст #${x.text} не существует`);return[x.key,this.textView(j,n(x))]}case"input":{const j=x.font&&O.get(x.font)||null;return[x.key,this.input(x.inputType,n(x,{font:j}))]}case"videoView":return[x.key,this.video(x.src,n(x))];case"group":{const j=this.group([],n(x));return W.push({g:j,o:x}),[x.key,j]}case"3dView":throw Error(`Объект #${x.key} является 3D проекцией. Они еще не реализованы.`)}}),G=new Map(F);for(const{g:x,o:j}of W){const Z=j.children.map(Q=>G.get(Q)||Pe(`Группа #${x.key}: Объект #${Q} не существует.`));x.set({children:Z})}const D=t.order?.map(x=>{const j=G.get(x)||Pe(`Объект #${x} не существует и не может быть отображен.`);return j.type==="group"&&Pe(`Объект #${x} является группой и не может быть отображен.`),j});return!s&&D?.length&&this.set({order:this.order.concat(D)}),{objects:G,brushes:P,fonts:O,images:T,imagesOpaque:m,pens:E,strings:N,texts:L,order:D||[]}}_exist(t,r){return r&&r.key&&r.key>0&&t.get(r.key)}_not(t,r){return r&&r.key&&r.key>0&&t.get(r.key)&&Pe(`Объект #${r.key} уже существует`),!0}group(t,r={}){return this._not(this.objects,r)&&new Yn(this,t,r)}line(t,r){return this._not(this.objects,r)&&this.createLine(t,r)}imageView(t,r){return this._not(this.objects,r)&&this.createImageView(t,r)}textView(t,r){return this._not(this.objects,r)&&this.createTextView(t,r)}input(t,r){return this._not(this.objects,r)&&this.createInput(t,r)}video(t,r){return this._not(this.objects,r)&&this.createVideo(t,r)}pen(t){return this._exist(this.pens,t)||this.createPen(t)}brush(t){return this._exist(this.brushes,t)||this.createBrush(t)}image(t,r){return this._exist(r?.opaque?this.imagesOpaque:this.images,r)||this.createImage(t,r)}string(t,r){return this._exist(this.strings,r)||this.createString(t,r)}font(t){return this._exist(this.fonts,t)||this.createFont(t)}text(t,r){return this._exist(this.texts,r)||this.createText(t,r)}}function Pe(e){throw Error(e)}function je(e,t){Object.assign(e.style,t)}const lr=document.createElement("a");function us(e,t){const r=URL.createObjectURL(e);lr.href=r,lr.download=t,lr.click(),setTimeout(()=>URL.revokeObjectURL(r),1e3)}function Kn(e){e.target===e.currentTarget&&e.preventDefault()}function ds(e){return new Promise((t,r)=>{const s=new Image;s.onload=()=>t(s),s.onerror=()=>r(new Error(`Ошибка загрузки ${e}`)),s.crossOrigin="",s.src=e})}function Ze(e,t){if(window.OffscreenCanvas)return new OffscreenCanvas(e,t);{const r=document.createElement("canvas");return r.width=e,r.height=t,r}}class xt{constructor(t){this.root=t,this.frameId=0,this.isStopped=!0}get isRunning(){return this.frameId!==0}run(t){if(this.isRunning)return;const{root:r}=this,s=i=>{this.isStopped||(this.frameId=t(i)?r.requestAnimationFrame(s):0)};this.isStopped=!1,this.frameId=r.requestAnimationFrame(s)}stop(){this.isRunning&&(this.isStopped=!0,this.root.cancelAnimationFrame(this.frameId),this.frameId=0)}}class qn extends $e{constructor(t,r){super(t,t.brushes,r),this.type="brush",this.color=0,this.style=0,this.rop=0,this.hatch=0,this.image=null,this.set(r)}set({color:t=this.color,hatch:r=this.hatch,image:s=this.image,rop:i=this.rop,style:n=this.style}){let a=!1;return this.image!==s&&(this.image?.subs.delete(this),this.image=s,this.image?.subs.add(this),a=!0),(this.color!==t||this.style!==n||this.rop!==i||this.hatch!==r)&&(this.color=t,this.style=n,this.rop=i,this.hatch=r,a=!0),a&&this.subs.forEach(l=>l._onBrushPropsChanged()),this}toJSON(){const{color:t,hatch:r,image:s,rop:i,style:n}=this;return{...super.toJSON(),color:t,hatch:r,image:s?.key,rop:i,style:n}}delete(t){if(!super.delete())return!1;const{image:r}=this;return r&&(r.subs.delete(this),t||r.delete()),!0}}const Zn=7,Jn=9,Qn=10,eo=0,to=1,ro=3;class so extends qn{constructor(){super(...arguments),this._color=NaN,this._cssColor=""}getCssColor(){const{color:t}=this;return this._color!==t&&(this._color=t,this._cssColor=Mt(t)||""),this._cssColor}getGlobalCompositeOperation(){switch(this.rop){case Jn:return"multiply";case Qn:return"multiply";case Zn:return"difference";default:return""}}getFillStyle(t){switch(this.style){case eo:return this.getCssColor();case to:return null;case ro:return this.image?.getCanvasPattern(t)??"black";default:return"white"}}_onImageChanged(){this.subs.forEach(t=>t._onBrushPropsChanged())}}const hr=["Arial","Verdana","Tahoma","Times New Roman","Georgia","Courier New","cursive"],io=hr.map(e=>e.toUpperCase());function no(e){if(!e)return hr[0];if(e==="Symbol")return"Times New Roman";const t=e.toUpperCase(),r=t.endsWith(" CYR")?t.slice(0,-4):t;return hr[Math.max(io.indexOf(r),0)]}class oo extends $e{constructor(t,r){super(t,t.fonts,r),this.name="",this.size=0,this.style=0,this._fontFamily="",this.set(r)}get fontFamily(){return this._fontFamily||=no(this.name)}get actualSize(){return this.size||16.521739130434785}set({name:t=this.name,size:r=this.size,style:s=this.style}){let i=!0;return this.name!==t&&(this.name=t,this._fontFamily="",i=!0),(this.size!==r||this.style!==s)&&(this.size=r,this.style=s,i=!0),i&&(this.onPropsChanged(),this.subs.forEach(n=>n._onFontPropsChanged())),this}toJSON(){const{name:t,size:r,style:s}=this;return{...super.toJSON(),name:t,size:r,style:s}}}class co extends oo{constructor(){super(...arguments),this.inputCssFont=""}getInputCssFont(){if(this.inputCssFont)return this.inputCssFont;const{fontFamily:t,actualSize:r,style:s}=this;return this.inputCssFont=`${s&rs?"bold":"normal"} ${s&ts?"italic":"normal"} ${Math.round(r*.6)}px ${t}`}transformText(t){return this.name==="Symbol"?$n(t):t}onPropsChanged(){this.inputCssFont=""}}class ao extends $e{constructor(t,{width:r,height:s,src:i},n){super(t,n.opaque?t.imagesOpaque:t.images,n),this.width=r,this.height=s,this.src=i}toJSON(){const{height:t,src:r,width:s}=this;return{...super.toJSON(),height:t,src:r,width:s}}}const fs=new Map,gs=new Map;async function lo(e){const t=await ds(e),r=await createImageBitmap(t);return gs.set(e,r),r}class ho{constructor(t){this.shouldUpdateCanvas=!1;const r=Ze(t.width,t.height),s=r.getContext("2d",{alpha:!1});s.drawImage(t,0,0),this.imageCtx=s,this.imageData=s.getImageData(0,0,r.width,r.height)}getCanvasImageSource(){const{imageCtx:t}=this;return this.shouldUpdateCanvas&&(this.shouldUpdateCanvas=!1,t.putImageData(this.imageData,0,0)),t.canvas}getPixel(t,r){const{imageData:s}=this;if(t<0||r<0||t>=s.width||r>=s.height)return 0;const{data:i}=s,n=(Math.floor(r)*s.width+Math.floor(t))*4;return ir(i[n],i[n+1],i[n+2],"rgb")}setPixel(t,r,s){const i=this.imageData,{data:n}=i,a=(Math.floor(r)*i.width+Math.floor(t))*4;n[a+0]=qr(s),n[a+1]=Zr(s),n[a+2]=Jr(s),n[a+3]=255,this.shouldUpdateCanvas=!0}}class uo extends ao{constructor(t,r,s){super(t,r,s),this.patternCache=new WeakMap,this.imageBitmap=null,this.pixelsWrapper=null;const i=dt(this.src),n=gs.get(i);if(n){this.imageBitmap=n;return}let a=fs.get(i);a||(a=lo(i),fs.set(i,a)),a.then(l=>{this.imageBitmap=l,this.subs.forEach(h=>h._onImageChanged())})}getPixelsWrapper(){if(this.pixelsWrapper)return this.pixelsWrapper;const{imageBitmap:t}=this;return t?this.pixelsWrapper=new ho(t):null}getPixel(t,r){return this.getPixelsWrapper()?.getPixel(t,r)||0}setPixel(t,r,s){if(t<0||r<0||t>this.width||r>this.height)return!1;const i=this.getPixelsWrapper();return i&&(i.setPixel(t,r,s),this.subs.forEach(n=>n._onImageChanged())),!0}getCanvasPattern(t){const r=this.getCanvasImageSource();if(!r)return null;const s=this.patternCache.get(t);if(s)return s;const i=t.createPattern(r,"repeat");return i?(this.patternCache.set(t,i),i):null}getCanvasImageSource(){return this.pixelsWrapper?.getCanvasImageSource()||this.imageBitmap}}class fo extends qe{constructor(t,r,s){const i={...s,width:s.width??r.width,height:s.height??r.height,image:r};super(t,i),this.type="imageView",this.area=null,this.image=r,r.subs.add(this),this.opaque=s.opaque||!1,this.angle=s.angle||0,this.set(i)}set({area:t=this.area,image:r=this.image,...s}){let i=!1;return this.image!==r&&(this.image.subs.delete(this),this.image=r,this.image.subs.add(this),i=!0),this.area!==t&&(this.area=t,i=!0),super.set(s),i&&this.onPropsChanged(),this}_onRotated(t,r,s){this.angle+=s,super._onRotated(t,r,s)}toJSON(){const{image:t,area:r,opaque:s,type:i,angle:n}=this;return{...super.toJSON(),type:i,image:t.key,area:r,opaque:s,angle:n}}delete(t){const{image:r}=this;return r.subs.delete(this),t||r.delete(),super.delete()}toString(){return"Картинка"}}class go extends fo{constructor(t,r,s){super(t,r,s)}_render(t){const{scene:r,angle:s,area:i,width:n,height:a}=this,{width:l,height:h}=t.canvas;let d=Math.round(this.x-r.x),g=Math.round(this.y-r.y);if(s){const O=Math.cos(s),N=Math.sin(s),y=n*O,P=n*N,C=y-a*N,L=P+a*O,W=-a*N,F=a*O,G=d+Math.min(0,y,C,W),D=d+Math.max(0,y,C,W),x=g+Math.min(0,P,L,F),j=g+Math.max(0,P,L,F);if(G>l||x>h||D<0||j<0)return}else if(d>l||g>h||d+n<0||g+a<0)return;const E=this.isVisible()&&this.image.getCanvasImageSource();if(!E)return;s&&(t.save(),t.translate(d,g),t.rotate(s),d=0,g=0);const T=Math.round(this.width),m=Math.round(this.height);if(i){const{image:O}=this,N=Math.round(i.x),y=Math.round(i.y),P=Math.round(Math.min(i.w,O.width-i.x)),C=Math.round(Math.min(i.h,O.height-i.y));t.drawImage(E,N,y,P,C,d,g,T,m)}else t.drawImage(E,d,g,T,m);s&&t.restore()}onAttribChanged(){this.scene._setDirty()}_onImageChanged(){this.scene._setDirty()}onPropsChanged(){this.scene._setDirty()}updateBBox(t,r,s,i){super.updateBBox(t,r,s,i),this.scene._setDirty()}}const po=4;class _o extends qe{constructor(t,r,s){super(t,s),this.type="input",this.value="",this.style=0,this.font=null,this.inputType=r,this.set(s)}get isMultiline(){return!!(this.style&po)}set({value:t=this.value,style:r=this.style,font:s=this.font,...i}){let n=!1;return this.font!==s&&(this.font?.subs.delete(this),this.font=s,this.font?.subs.add(this),n=!0),this.value!==t&&(this.value=t,this.isMultiline?this.value=this.value:t=t.replace(/[\r\n]/g,""),n=!0),this.style!==r&&(this.style=r,n=!0),super.set(i),n&&this.onPropsChanged(),this}toJSON(){const{inputType:t,style:r,font:s,type:i,value:n}=this;return{...super.toJSON(),type:i,inputType:t,exStyle:0,font:s?.key,style:r,value:n}}delete(t){const{font:r}=this;return r&&(r.subs.delete(this),t||r.delete()),super.delete()}toString(){return`Элемент интерфейса '${this.inputType}'`}}const De={"jf-scene":"yNr0VPwT","jf-input":"doAE-L2e","jf-video":"_8PHlccAK","disable-inputs":"k7TCS6Hm",multiline:"-QksePcc",centered:"ZFAGmpo5",border:"GnGoYW5X"},Eo=1,mo=64,To=128,wo=8388608;class yo extends _o{constructor(t,r,s){super(t,r,s),this._visible=!0,this._cssFont="",this._value="",this._x=0,this._y=0,this._w=0,this._h=0;const{style:i=0}=s;let n;switch(r){case"Button":n=document.createElement("input"),n.type="button",n.addEventListener("click",this);break;case"ComboBox":case"ListBox":n=document.createElement("select"),n.addEventListener("input",this);break;default:n=document.createElement("textarea"),n.addEventListener("input",this);break}n.className=De["jf-input"],n.spellcheck=!1,n.name=`jf-${this.key}`,i&wo&&n.classList.add(De.border),i&Eo&&n.classList.add(De.centered),this.isMultiline&&n.classList.add(De.multiline),n.addEventListener("focus",this),n.addEventListener("blur",this),this.domElement=n,this.scene._appendDomElement(n)}focus(){this.domElement.focus()}handleEvent(t){const{scene:r,domElement:s,style:i}=this;if(t.type==="input"){if(!(i&To)&&s.scrollWidth>s.clientWidth){s.value=this.value;return}if(this.isMultiline){if(!(i&mo)&&s.scrollHeight>s.clientHeight){s.value=this.value;return}}else s.value=s.value.replace(/[\r\n]/g,"");this.value=this._value=s.value}r.onInputChanged.dispatch({type:t.type,scene:r,target:this})}_render(){const t=this.isVisible(),{style:r}=this.domElement;if(this._visible!==t&&(this._visible=t,t?r.removeProperty("display"):r.display="none"),!t)return;const s=this.font?.getInputCssFont()||"";this._cssFont!==s&&(this._cssFont=s,s?r.font=s:r.removeProperty("font")),this._value!==this.value&&(this.domElement.value=this._value=this.value);const i=Math.round(this.x-this.scene.x),n=Math.round(this.y-this.scene.y),a=Math.round(this.width),l=Math.round(this.height);this._x!==i&&r.setProperty("left",(this._x=i).toString()+"px"),this._y!==n&&r.setProperty("top",(this._y=n).toString()+"px"),this._w!==a&&r.setProperty("width",(this._w=a).toString()+"px"),this._h!==l&&r.setProperty("height",(this._h=l).toString()+"px")}delete(t){return this.domElement.remove(),super.delete(t)}onAttribChanged(){this.scene._setDirty()}_onFontPropsChanged(){this.scene._setDirty()}onPropsChanged(){this.scene._setDirty()}updateBBox(t,r,s,i){super.updateBBox(t,r,s,i),this.scene._setDirty()}}class bo extends qe{constructor(t,r,s){super(t,s),this.type="line",this.pen=null,this.brush=null,this.start=null,this.end=null,this.setCoords(r).set(s)}get length(){return this.coords.length/2}set({pen:t=this.pen,brush:r=this.brush,start:s=this.start,end:i=this.end,...n}){let a=!1;return this.pen!==t&&(this.pen?.subs.delete(this),this.pen=t,this.pen?.subs.add(this),a=!0),this.brush!==r&&(this.brush?.subs.delete(this),this.brush=r,this.brush?.subs.add(this),a=!0),(this.start!==s||this.end!==i)&&(this.start=s,this.end=i,a=!0),super.set(n),a&&this.onPropsChanged(),this}addPoint({x:t,y:r},s=this.length){const i=s*2,n=this.coords,a=t-this.x,l=r-this.y;return i<0||i>=n.length?n.push(a,l):n.splice(i,0,a,l),this._pointCountChanged(),!0}point(t){const r=t*2,s=this.coords;return r>=0&&r<s.length?{x:s[r]+this.x,y:s[r+1]+this.y}:null}setPoint(t,{x:r,y:s}){const i=t*2,n=this.coords;return i<0||i>=n.length?!1:(n[i+0]=r-this.x,n[i+1]=s-this.y,this._pointCountChanged(),!0)}removePoint(t){const r=t*2,s=this.coords;return s.length<=2||r<0||r>=s.length?!1:(s.splice(r,2),this._pointCountChanged(),!0)}setCoords(t){if(!t.length||t.length%2)throw Error("Количество координат должно быть четным.");return this.coords=t.slice(),this.x=0,this.y=0,this._pointCountChanged(),this}getIntersectionIndex(t,r){const{coords:s,brush:i,pen:n}=this;let a=0;return n&&(a=n.width/2||.5),a=Math.max(a,4),cs(s,!!i,a,t,r)}inside(t,r,s){const{coords:i,brush:n}=this;return n&&Bn(i,t,r)||cs(i,!!n,s,t,r)!==-1}_pointCountChanged(){const t=this.coords;let r=t[0],s=t[1],i=r,n=s;for(let a=2;a<t.length;a+=2){const l=t[a+0],h=t[a+1];l<r&&(r=l),l>i&&(i=l),h<s&&(s=h),h>n&&(n=h)}if(r!==0||s!==0)for(let a=0;a<t.length;a+=2)t[a+0]-=r,t[a+1]-=s;this.updateBBox(this.x+r,this.y+s,i-r,n-s),this.parent?._childChanged(),this.onCoordsChanged()}_onResized(t,r,s,i){const n=this.coords;for(let h=0;h<n.length;h+=2)n[h+0]*=s,n[h+1]*=i;const a=t+(this.x-t)*s,l=r+(this.y-r)*i;this.updateBBox(a,l,this.width*s,this.height*i),this.onCoordsChanged()}_onRotated(t,r,s){const i=this.coords,n=t-this.x,a=r-this.y,l=Math.sin(s),h=Math.cos(s);let d=1/0,g=-1/0,E=1/0,T=-1/0;for(let m=0;m<i.length;m+=2){const O=i[m+0]-n,N=i[m+1]-a,y=O*h-N*l+n,P=O*l+N*h+a;i[m+0]=y,i[m+1]=P,y<d&&(d=y),y>g&&(g=y),P<E&&(E=P),P>T&&(T=P)}if(d!==0||E!==0)for(let m=0;m<i.length;m+=2)i[m+0]-=d,i[m+1]-=E;this.updateBBox(this.x+d,this.y+E,g-d,T-E),this.onCoordsChanged()}toJSON(){const{coords:t,brush:r,end:s,pen:i,start:n,type:a}=this;return{...super.toJSON(),type:a,coords:t.slice(),brush:r?.key,end:s,pen:i?.key,start:n}}delete(t){const{pen:r,brush:s}=this;return r&&(r.subs.delete(this),t||r.delete()),s&&(s.subs.delete(this),t||s.delete(t)),super.delete()}toString(){return"Полилиния"}}class Ro extends bo{constructor(t,r,s){super(t,r,s),this.shouldUpdateSource=!0,this.sourceOffset=0,this.regionWidth=0,this.regionHeight=0;const i=Ze(0,0);this.lineCtx=i.getContext("2d",{alpha:!0})}updateRegionSize(){const t=Math.max((this.pen?.getLineWidth()||0)/2,this.start?.length||0,this.end?.length||0);this.sourceOffset=t,this.regionWidth=Math.ceil(this.width+t*2),this.regionHeight=Math.ceil(this.height+t*2)}getCanvasImageSource(){const{regionWidth:t,regionHeight:r}=this;if(!t||!r)return null;if(!this.shouldUpdateSource){const d=this.lineCtx.canvas;return d.width&&d.height?d:null}this.shouldUpdateSource=!1;const{coords:s,pen:i,brush:n,lineCtx:a,sourceOffset:l}=this;a.canvas.width=t,a.canvas.height=r,l&&a.translate(l,l),a.moveTo(s[0],s[1]);for(let d=2;d<s.length;d+=2)a.lineTo(s[d],s[d+1]);if(n&&s.length>4){a.closePath();const d=n.getFillStyle(a);d&&(a.fillStyle=d,a.fill("evenodd"))}const h=i&&i.getStrokeStyle();if(h){if(!n&&s.length>2){const{start:g,end:E}=this;if(g){const T=s[3],m=s[2],O=s[1],N=s[0],y=g.length,P=Math.atan2(O-T,N-m),C=P+g.angle,L=P-g.angle;a.moveTo(N,O),a.lineTo(N-y*Math.cos(C),O-y*Math.sin(C)),a.moveTo(N,O),a.lineTo(N-y*Math.cos(L),O-y*Math.sin(L))}if(E){const T=s[s.length-4],m=s[s.length-3],O=s[s.length-2],N=s[s.length-1],y=E.length,P=Math.atan2(N-m,O-T),C=P+E.angle,L=P-E.angle;a.moveTo(O,N),a.lineTo(O-y*Math.cos(C),N-y*Math.sin(C)),a.moveTo(O,N),a.lineTo(O-y*Math.cos(L),N-y*Math.sin(L))}}a.lineCap="round",a.lineJoin="round",a.lineWidth=i.getLineWidth(),a.strokeStyle=h;const d=i.getLineDash();d&&a.setLineDash(d),a.stroke()}return a.canvas}_render(t){this.updateRegionSize();const{scene:r,sourceOffset:s,regionWidth:i,regionHeight:n}=this,{width:a,height:l}=t.canvas,h=Math.round(this.x-r.x-s),d=Math.round(this.y-r.y-s);if(h>a||d>l||h+i<0||d+n<0)return;const g=this.isVisible()&&this.getCanvasImageSource();if(!g)return;const E=(this.brush?this.brush.getGlobalCompositeOperation():this.pen?.getGlobalCompositeOperation())||"";E?(t.globalCompositeOperation=E,t.drawImage(g,h,d),t.globalCompositeOperation="source-over"):t.drawImage(g,h,d)}onCoordsChanged(){this.shouldUpdateSource=!0,this.scene._setDirty()}onPropsChanged(){this.shouldUpdateSource=!0,this.scene._setDirty()}_onPenPropsChanged(){this.shouldUpdateSource=!0,this.scene._setDirty()}_onBrushPropsChanged(){this.shouldUpdateSource=!0,this.scene._setDirty()}onAttribChanged(){this.scene._setDirty()}updateBBox(t,r,s,i){super.updateBBox(t,r,s,i),this.scene._setDirty()}}class Oo extends $e{constructor(t,r){super(t,t.pens,r),this.color=0,this.style=0,this.rop=0,this.width=0,this.set(r)}set({color:t=this.color,rop:r=this.rop,style:s=this.style,width:i=this.width}){return(this.width!==i||this.color!==t||this.style!==s||this.rop!==r)&&(this.color=t,this.style=s,this.rop=r,this.width=i,this.subs.forEach(n=>n._onPenPropsChanged())),this}toJSON(){const{color:t,rop:r,style:s,width:i}=this;return{...super.toJSON(),color:t,rop:r,style:s,width:i}}}const Mo=0,So=1,No=2,Io=3,Ao=4,vo=5,xo=9,Po=10,Do=7,ko=[16,4],Lo=[2,4],Co=[16,4,2,4],Go=[16,4,2,4,2,4];class Bo extends Oo{constructor(){super(...arguments),this._color=NaN,this._cssColor=""}getCssColor(){const{color:t}=this;return this._color!==t&&(this._color=t,this._cssColor=Mt(t)||""),this._cssColor}getLineWidth(){return Math.max(Math.round(this.width),1)}getGlobalCompositeOperation(){switch(this.rop){case xo:return"multiply";case Po:return"multiply";case Do:return"difference";default:return""}}getStrokeStyle(){return this.style!==vo?this.getCssColor():""}getLineDash(){switch(this.style){case Mo:return null;case So:return ko;case No:return Lo;case Io:return Co;case Ao:return Go;default:return null}}}class Fo extends $e{constructor(t,r,s){super(t,t.strings,s),this.text=r,this.set({...s,text:r})}set({text:t=this.text}){return this.text!==t&&(this.text=t,this.subs.forEach(r=>r._onStringTextChanged())),this}toJSON(){const{text:t}=this;return{...super.toJSON(),text:t}}}class Wo extends Fo{constructor(){super(...arguments),this._text="",this.fragments=[""]}getLines(){const{text:t}=this;return this._text!==t&&(this._text=t,this.fragments=t.split(/\r\n|\n/)),this.fragments}}class Uo{constructor(t,{font:r,string:s,fgcolor:i,bgcolor:n}){this.text=t,this.font=r,this.string=s,this.fgcolor=i||0,this.bgcolor=n??16777216,r.subs.add(this),s.subs.add(this)}set({font:t=this.font,string:r=this.string,fgcolor:s=this.fgcolor,bgcolor:i=this.bgcolor}){let n=!1,a=!1;return this.font!==t&&(this.font.subs.delete(this),this.font=t,t.subs.add(this),n=!0),this.string!==r&&(this.string.subs.delete(this),this.string=r,r.subs.add(this),n=!0),(this.fgcolor!==s||this.bgcolor!==i)&&(this.fgcolor=s,this.bgcolor=i,a=!0),(n||a)&&(this.onPropsChanged(n,a),this.text.subs.forEach(l=>l._onTextPartsChanged())),this}delete(t){this.font.subs.delete(this),this.string.subs.delete(this),t||(this.font.delete(),this.string.delete())}toJSON(){const{font:t,string:r,fgcolor:s,bgcolor:i}=this;return{font:t.key,string:r.key,fgcolor:s,bgcolor:i}}}class Vo extends $e{constructor(t,r,s){super(t,t.texts,s),this.type="text",this.parts=r.map(i=>this.createPart(i,!0))}set({parts:t=this.parts},r){return this.parts!==t&&(this.parts.forEach(s=>!t.includes(s)&&s.delete(r)),this.parts=t,this.subs.forEach(s=>s._onTextPartsChanged())),this}createPart(t,r){const s=this._createPart(t);return r||this.set({parts:this.parts.concat(s)}),s}toJSON(){const t=this.parts.map(r=>r.toJSON());return{...super.toJSON(),parts:t}}delete(t){return super.delete()?(this.parts.forEach(r=>r.delete(t)),!0):!1}}const $o=1.15,jo=.989,ps=Ze(0,0).getContext("2d",{alpha:!1});class Ho extends Uo{constructor(t,r){super(t,r),this.textFragments=null,this._fgColor=NaN,this._bgColor=NaN,this.fontCssColor="",this.bgCssColor=""}getTextFragments(){const{fontFamily:t,actualSize:r,style:s}=this.font,i=this.string.getLines(),n=s&ts?"italic":"normal",l=`${s&rs?"bold":"normal"} ${n} ${r}px ${t}`,{textFragments:h}=this;if(h&&h.cssFont===l&&h.textLines===i)return h;ps.font=l;const d=r*$o,g=[];return i.forEach((E,T)=>{if(T>0&&g.push({text:`
`,width:0,height:d}),E){const m=this.font.transformText(E);g.push({width:ps.measureText(m).width,height:d,text:m})}else g.push({width:0,height:d,text:""})}),this.textFragments={cssFont:l,fragments:g,textLines:i}}getFontCssColor(){const{fgcolor:t}=this;return this._fgColor!==t&&(this._fgColor=t,this.fontCssColor=Mt(t)||"black"),this.fontCssColor}getBgCssColor(){const{bgcolor:t}=this;return this._bgColor!==t&&(this._bgColor=t,this.bgCssColor=Mt(t)||""),this.bgCssColor}_onFontPropsChanged(){this.text._onGeometryChanged()}_onStringTextChanged(){this.text._onGeometryChanged()}onPropsChanged(t,r){t&&this.text._onGeometryChanged(),r&&this.text._onColorsChanged()}}class Xo extends Vo{constructor(t,r,s){super(t,r,s),this.shouldUpdateSource=!0,this.maxWidth=0,this.maxHeight=0,this._parts=null;const i=Ze(0,0);this.textCtx=i.getContext("2d",{alpha:!0})}get width(){return this.updateMetrics(),this.maxWidth}get height(){return this.updateMetrics(),this.maxHeight}updateMetrics(){const{parts:t}=this;if(this._parts===t)return;this._parts=t,this.shouldUpdateSource=!0;let r=0,s=0,i=0,n=0;for(const a of t)for(const l of a.getTextFragments().fragments){if(n=Math.max(n,l.height),l.text===`
`){s+=n,r=Math.max(r,i),i=0,n=0;continue}i+=l.width}s+=n,r=Math.max(r,i),this.maxWidth=Math.floor(r),this.maxHeight=Math.floor(s)}getCanvasImageSource(){const{textCtx:t}=this;this.updateMetrics();const{maxWidth:r,maxHeight:s}=this;if(!r||!s)return null;if(!this.shouldUpdateSource){const l=t.canvas;return l.width&&l.height?l:null}this.shouldUpdateSource=!1,t.canvas.width=Math.round(r),t.canvas.height=Math.round(s+2),t.textAlign="left",t.textBaseline="alphabetic",t.scale(jo,1);let i=0,n=0,a=0;for(const l of this.parts){const{fragments:h,cssFont:d}=l.getTextFragments(),{style:g}=l.font,E=l.getFontCssColor(),T=l.getBgCssColor(),m=g&kn,O=g&Ln;t.font=d;for(const{text:N,width:y,height:P}of h){if(a=Math.max(a,P),N===`
`){n+=a,i=0,a=0;continue}if(N){const C=Math.round(i),L=Math.round(n+P*.85);if(T){t.fillStyle=T;const F=Math.round(n);t.fillRect(C,F,Math.round(y),Math.round(P))}t.fillStyle=E,t.fillText(N,C,L);const W=Math.max(1,P/10);if(m){const F=Math.round(n+P-W);t.fillRect(C,F,Math.round(y),Math.round(W))}if(O){const F=Math.round(n+P*.55);t.fillRect(C,F,Math.round(y),Math.round(W))}}i+=y}}return t.canvas}_createPart(t){return new Ho(this,t)}_onGeometryChanged(){this._parts=null}_onColorsChanged(){this.shouldUpdateSource=!0}}class Yo extends qe{constructor(t,r,s){const i={...s,width:s.width??r.width,height:s.height??r.height,text:r};super(t,i),this.text=r,this.type="textView",r.subs.add(this),this.angle=s.angle??0,this.set({...s,text:r})}set({text:t=this.text,...r}){return this.text!==t&&(this.text.subs.delete(this),this.text=t,this.text.subs.add(this),this.onPropsChanged()),super.set(r)}_onRotated(t,r,s){super._onRotated(t,r,s),this.angle+=s}toJSON(){const{text:t,angle:r,type:s}=this;return{...super.toJSON(),type:s,text:t.key,angle:r}}delete(t){const{text:r}=this;return r.subs.delete(this),t||r.delete(t),super.delete()}toString(){return"Текст"}}class zo extends Yo{constructor(t,r,s){super(t,r,s)}_render(t){const{scene:r,angle:s,width:i,height:n}=this,{width:a,height:l}=t.canvas;let h=Math.round(this.x-r.x),d=Math.round(this.y-r.y);if(s){const m=Math.cos(s),O=Math.sin(s),N=i*m,y=i*O,P=N-n*O,C=y+n*m,L=-n*O,W=n*m,F=h+Math.min(0,N,P,L),G=h+Math.max(0,N,P,L),D=d+Math.min(0,y,C,W),x=d+Math.max(0,y,C,W);if(F>a||D>l||G<0||x<0)return}else if(h>a||d>l||h+i<0||d+n<0)return;const g=this.isVisible()&&this.text.getCanvasImageSource();if(!g)return;s&&(t.save(),t.translate(h,d),t.rotate(s),h=0,d=0);const E=Math.round(this.width*1.02),T=Math.round(this.height)+2;t.drawImage(g,0,0,E,T,h,d,E,T),s&&t.restore()}onAttribChanged(){this.scene._setDirty()}onPropsChanged(){this.scene._setDirty()}_onTextPartsChanged(){this.scene._setDirty()}updateBBox(t,r,s,i){super.updateBBox(t,r,s,i),this.scene._setDirty()}}class Ko extends qe{constructor(t,r){super(t,r),this.type="videoView",this.fixed=r.fixed||!1}set({fixed:t=this.fixed,...r}){return this.fixed=t,super.set(r)}toJSON(){throw new Error("Method not implemented.")}toString(){return"Видео"}}const ur=Ke;ur.hideVideoControls=!1;class qo{constructor(t){this.v=t}get width(){return this.v.videoWidth}get height(){return this.v.videoHeight}}class Zo extends Ko{constructor(t,r,s){super(t,s),this._visible=!0,this._x=0,this._y=0,this._w=0,this._h=0;const i=this.domElement=document.createElement("video");i.className=De["jf-video"],i.src=dt(r),i.controls=!ur.hideVideoControls,this.video=new qo(i),this.scene._appendDomElement(i)}currentState(){const t=this.domElement;return t.paused?t.currentTime?"pause":"stop":"play"}setCurrentTime(t){const r=this.domElement;return t!==r.currentTime&&(r.currentTime=t),this}currentTime(){return this.domElement.currentTime}play(){const t=this.domElement;return t.paused&&t.play(),this}pause(){const t=this.domElement;return t.paused||t.pause(),this}stop(){return this.pause(),this.setCurrentTime(0),this}_render(){const t=this.isVisible(),{style:r}=this.domElement;if(this._visible!==t&&(this._visible=t,t?r.removeProperty("display"):r.display="none"),!t)return;const s=Math.round(this.x-this.scene.x),i=Math.round(this.y-this.scene.y);if(this._x!==s&&r.setProperty("left",(this._x=s).toString()+"px"),this._y!==i&&r.setProperty("top",(this._y=i).toString()+"px"),this.fixed){const n=Math.round(this.width),a=Math.round(this.height);this._w!==n&&r.setProperty("width",(this._w=n).toString()+"px"),this._h!==a&&r.setProperty("height",(this._h=a).toString()+"px")}}delete(){return this.domElement.remove(),super.delete()}onAttribChanged(){this.scene._setDirty()}updateBBox(t,r,s,i){super.updateBBox(t,r,s,i),this.scene._setDirty()}}const Jo=class extends zn{constructor(t){super(),this.prevOrder=[],this.dirty=!0;const r=document.createElement("canvas");this.ctx=r.getContext("2d",{alpha:!0,desynchronized:!1});const s=this.domElement=document.createElement("div");s.className=De["jf-scene"],s.append(r),this.init(t)}dispose(){}render(t=!1){if(!t&&!this.domElement.offsetParent)return;const{ctx:r}=this,s=r.canvas,{clientWidth:i,clientHeight:n}=s;if((s.width!==i||s.height!==n)&&(s.width=i,s.height=n,this.dirty=!0),this.prevOrder!==this.order){const{prevOrder:a}=this;this.prevOrder=this.order,(this.order.length!==a.length||this.order.some((l,h)=>l!==a[h]))&&(this.dirty=!0)}!this.dirty||i<1||n<1||(r.fillStyle=this.background?.getFillStyle(r)||"white",r.fillRect(0,0,i,n),this.order.forEach(a=>a._render(r)),this.dirty=!1)}toBlob(t){const r=this.ctx.canvas,s=Math.max(t.x,0),i=Math.max(t.y,0),n=Math.min(t.w,r.width),a=Math.min(t.h,r.height),l=Ze(n,a);return l.getContext("2d",{alpha:!1}).drawImage(this.ctx.canvas,s,i,n,a,0,0,n,a),l instanceof OffscreenCanvas?l.convertToBlob():new Promise(g=>l.toBlob(E=>g(E)))}createLine(t,r={}){return new Ro(this,t,r)}createImageView(t,r={}){return new go(this,t,r)}createTextView(t,r={}){return new zo(this,t,r)}createInput(t,r={}){return new yo(this,t,r)}createVideo(t,r={}){return new Zo(this,t,r)}createPen(t={}){return new Bo(this,t)}createBrush(t={}){return new so(this,t)}createImage(t,r={}){return new uo(this,t,r)}createString(t,r={}){return new Wo(this,t,r)}createFont(t={}){return new co(this,t)}createText(t,r={}){return new Xo(this,t,r)}onDisableInputsChanged(){this.disableInputs?this.domElement.classList.add(De["disable-inputs"]):this.domElement.classList.remove(De["disable-inputs"])}onBackgroundChanged(){this._setDirty()}onLayersChanged(){this._setDirty()}onOriginChanged(){this._setDirty()}_onBrushPropsChanged(){this._setDirty()}_setDirty(){this.dirty=!0}_appendDomElement(t){this.domElement.append(t)}};class Qo{constructor(t){if(this.pens=new Set,this.brushes=new Set,this.images=new Set,this.imagesOpaque=new Set,this.strings=new Set,this.fonts=new Set,this.texts=new Set,t)if(t.type==="group")for(const r of _s(t))r.type!=="group"&&this.add(r);else this.add(t)}add(t){switch(t.type){case"line":t.pen&&this.pens.add(t.pen),t.brush&&(this.add(t.brush),this.brushes.add(t.brush));break;case"imageView":(t.opaque?this.imagesOpaque:this.images).add(t.image);break;case"textView":this.add(t.text),this.texts.add(t.text);break;case"input":t.font&&this.fonts.add(t.font);break;case"brush":t.image&&this.imagesOpaque.add(t.image);break;case"text":t.parts.forEach(r=>{this.strings.add(r.string),this.fonts.add(r.font)});break;case"scene":t.background&&(this.add(t.background),this.brushes.add(t.background));break}return this}}function*_s(e,t){e.type==="group"&&(yield*e.descendants(t)),yield e}function*ec(e,t){for(const r of e)r.type==="group"&&(yield*r.descendants(t)),yield r}function tc(e,t){const r=[],s=new Qo,i=new WeakSet;let n=null;const a=Symbol.iterator in e?ec(e,!0):_s(e,!0);for(const l of a)n=l.scene,r.push(l.toJSON()),l.type!=="group"&&(s.add(l),i.add(l));return{pens:Array.from(s.pens,l=>l.toJSON()),brushes:Array.from(s.brushes,l=>l.toJSON()),images:Array.from(s.images,l=>l.toJSON()),imagesOpaque:Array.from(s.imagesOpaque,l=>l.toJSON()),strings:Array.from(s.strings,l=>l.toJSON()),fonts:Array.from(s.fonts,l=>l.toJSON()),texts:Array.from(s.texts,l=>l.toJSON()),objects:r,order:n?Hn(n.order,l=>i.has(l)&&l.key):[]}}function rc(e){return hs(e.values(),t=>!t.parent)}function Es(e,t,r){const{objects:s}=e.merge(t,r),i=rc(s);return i.length>1?e.group(i,{key:0}):i[0]}const sc={x:0,y:0,w:0,h:0};function ms(e){let t=1/0,r=1/0,s=-1/0,i=-1/0;for(const n of e)n.x<t&&(t=n.x),n.y<r&&(r=n.y),n.x+n.width>s&&(s=n.x+n.width),n.y+n.height>i&&(i=n.y+n.height);return t===1/0?sc:{x:t,y:r,w:s-t,h:i-r}}const re=ur;re.root=document.body,re.isMobile=!1,re.logMessage=!1;var v=(e=>(e[e.PI=3.1415926536]="PI",e[e.WORD8=0]="WORD8",e[e.INT8=1]="INT8",e[e.WORD16=2]="WORD16",e[e.INT16=3]="INT16",e[e.WORD32=4]="WORD32",e[e.INT32=5]="INT32",e[e.FLOAT32=6]="FLOAT32",e[e.FLOAT40=7]="FLOAT40",e[e.FLOAT64=8]="FLOAT64",e[e.FLOAT80=9]="FLOAT80",e[e.PEN2D=1]="PEN2D",e[e.BRUSH2D=2]="BRUSH2D",e[e.DIB2D=3]="DIB2D",e[e.DOUBLEDIB2D=4]="DOUBLEDIB2D",e[e.FONT2D=5]="FONT2D",e[e.STRING2D=6]="STRING2D",e[e.TEXT2D=7]="TEXT2D",e[e.SPACE3D=8]="SPACE3D",e[e.TEXTURE3D=9]="TEXTURE3D",e[e.WM_DESTROY=2]="WM_DESTROY",e[e.WM_MOVE=3]="WM_MOVE",e[e.WM_SIZE=5]="WM_SIZE",e[e.WM_CLOSE=16]="WM_CLOSE",e[e.WM_GETMINMAXINFO=36]="WM_GETMINMAXINFO",e[e.WM_COMMAND=273]="WM_COMMAND",e[e.WM_MOUSEMOVE=512]="WM_MOUSEMOVE",e[e.WM_LBUTTONDOWN=513]="WM_LBUTTONDOWN",e[e.WM_LBUTTONUP=514]="WM_LBUTTONUP",e[e.WM_LBUTTONDBLCLK=515]="WM_LBUTTONDBLCLK",e[e.WM_RBUTTONDOWN=516]="WM_RBUTTONDOWN",e[e.WM_RBUTTONUP=517]="WM_RBUTTONUP",e[e.WM_RBUTTONDBLCLK=518]="WM_RBUTTONDBLCLK",e[e.WM_MBUTTONDOWN=519]="WM_MBUTTONDOWN",e[e.WM_MBUTTONUP=520]="WM_MBUTTONUP",e[e.WM_MBUTTONDBLCLK=521]="WM_MBUTTONDBLCLK",e[e.WM_ALLMOUSEMESSAGE=1536]="WM_ALLMOUSEMESSAGE",e[e.WM_ALLKEYMESSAGE=1537]="WM_ALLKEYMESSAGE",e[e.WM_KEYDOWN=256]="WM_KEYDOWN",e[e.WM_KEYUP=257]="WM_KEYUP",e[e.WM_CANCLOSE=1538]="WM_CANCLOSE",e[e.WM_SPACEDONE=1539]="WM_SPACEDONE",e[e.WM_SPACEINIT=1540]="WM_SPACEINIT",e[e.WM_CONTROLNOTIFY=1544]="WM_CONTROLNOTIFY",e[e.WM_HYPERJUMP=1546]="WM_HYPERJUMP",e[e.SIZE_RESTORED=0]="SIZE_RESTORED",e[e.SIZE_MINIMIZED=1]="SIZE_MINIMIZED",e[e.SIZE_MAXIMIZED=2]="SIZE_MAXIMIZED",e[e.SIZE_MAXSHOW=3]="SIZE_MAXSHOW",e[e.SIZE_MAXHIDE=4]="SIZE_MAXHIDE",e[e.OTGROUP2D=3]="OTGROUP2D",e[e.OTRGROUP2D=4]="OTRGROUP2D",e[e.OTGROUP3D=5]="OTGROUP3D",e[e.OTOBJECT3D=10]="OTOBJECT3D",e[e.OTLINE_2D=20]="OTLINE_2D",e[e.OTBITMAP_2D=21]="OTBITMAP_2D",e[e.OTDOUBLEBITMAP_2D=22]="OTDOUBLEBITMAP_2D",e[e.OTTEXT_2D=23]="OTTEXT_2D",e[e.OTVIEW3D_2D=24]="OTVIEW3D_2D",e[e.OTEDITFRAME=50]="OTEDITFRAME",e[e.OTROTATECENTER=51]="OTROTATECENTER",e[e.OTFRAME3D=52]="OTFRAME3D",e[e.OTAXIS3D=53]="OTAXIS3D",e[e.OTPEN2D=101]="OTPEN2D",e[e.OTBRUSH2D=102]="OTBRUSH2D",e[e.OTDIB2D=103]="OTDIB2D",e[e.OTDOUBLEDIB2D=104]="OTDOUBLEDIB2D",e[e.OTFONT2D=105]="OTFONT2D",e[e.OTSTRING2D=106]="OTSTRING2D",e[e.OTTEXT2D=107]="OTTEXT2D",e[e.OTREFTODIB2D=110]="OTREFTODIB2D",e[e.OTREFTODOUBLEDIB2D=111]="OTREFTODOUBLEDIB2D",e[e.ATTRSET=1]="ATTRSET",e[e.ATTRRESET=2]="ATTRRESET",e[e.ATTRPUT=3]="ATTRPUT",e[e.PFC_MOVEOBJECT=32768]="PFC_MOVEOBJECT",e[e.PFC_SETCURRENT=16384]="PFC_SETCURRENT",e[e.PFC_SETFRAME=8192]="PFC_SETFRAME",e[e.PFC_PENS=1]="PFC_PENS",e[e.PFC_BRUHS=2]="PFC_BRUHS",e[e.PFC_DIBS=4]="PFC_DIBS",e[e.PFC_DDIBS=8]="PFC_DDIBS",e[e.PFC_STRINGS=16]="PFC_STRINGS",e[e.PFC_FONTS=32]="PFC_FONTS",e[e.PFC_TEXTS=64]="PFC_TEXTS",e[e.PFC_3D=128]="PFC_3D",e[e.PFC_ALL=255]="PFC_ALL",e[e.OID_RESERVED=32e3]="OID_RESERVED",e[e.OID_RCENTER=32001]="OID_RCENTER",e[e.OID_FRAME2D1=32002]="OID_FRAME2D1",e[e.OID_FRAME2D2=32003]="OID_FRAME2D2",e[e.OID_FRAME2D3=32004]="OID_FRAME2D3",e[e.OID_FRAME2D4=32005]="OID_FRAME2D4",e[e.OID_FRAME2D5=32006]="OID_FRAME2D5",e[e.OID_FRAME2D6=32007]="OID_FRAME2D6",e[e.OID_FRAME2D7=32008]="OID_FRAME2D7",e[e.OID_FRAME2D8=32009]="OID_FRAME2D8",e[e.OID_FRAME2D=32010]="OID_FRAME2D",e[e.OID_AXIS3D=32100]="OID_AXIS3D",e[e.OID_FRAME3D1=32102]="OID_FRAME3D1",e[e.OID_FRAME3D2=32103]="OID_FRAME3D2",e[e.OID_FRAME3D3=32104]="OID_FRAME3D3",e[e.OID_FRAME3D4=32105]="OID_FRAME3D4",e[e.OID_FRAME3D5=32106]="OID_FRAME3D5",e[e.OID_FRAME3D6=32107]="OID_FRAME3D6",e[e.OID_FRAME3D7=32108]="OID_FRAME3D7",e[e.OID_FRAME3D8=32109]="OID_FRAME3D8",e[e.OID_FRAME3D=32110]="OID_FRAME3D",e[e.MB_OK=0]="MB_OK",e[e.MB_OKCANCEL=1]="MB_OKCANCEL",e[e.MB_ABORTRETRYIGNORE=2]="MB_ABORTRETRYIGNORE",e[e.MB_YESNOCANCEL=3]="MB_YESNOCANCEL",e[e.MB_YESNO=4]="MB_YESNO",e[e.MB_RETRYCANCEL=5]="MB_RETRYCANCEL",e[e.MB_TYPEMASK=15]="MB_TYPEMASK",e[e.MB_ICONHAND=16]="MB_ICONHAND",e[e.MB_ICONQUESTION=32]="MB_ICONQUESTION",e[e.MB_ICONEXCLAMATION=48]="MB_ICONEXCLAMATION",e[e.MB_ICONASTERISK=64]="MB_ICONASTERISK",e[e.MB_ICONMASK=240]="MB_ICONMASK",e[e.MB_ICONINFORMATION=64]="MB_ICONINFORMATION",e[e.MB_ICONSTOP=16]="MB_ICONSTOP",e[e.MB_DEFBUTTON1=0]="MB_DEFBUTTON1",e[e.MB_DEFBUTTON2=256]="MB_DEFBUTTON2",e[e.MB_DEFBUTTON3=512]="MB_DEFBUTTON3",e[e.MB_DEFMASK=3840]="MB_DEFMASK",e[e.MB_APPLMODAL=0]="MB_APPLMODAL",e[e.MB_SYSTEMMODAL=4096]="MB_SYSTEMMODAL",e[e.MB_TASKMODAL=8192]="MB_TASKMODAL",e[e.MB_NOFOCUS=32768]="MB_NOFOCUS",e[e.SW_HIDE=0]="SW_HIDE",e[e.SW_SHOWNORMAL=1]="SW_SHOWNORMAL",e[e.SW_NORMAL=1]="SW_NORMAL",e[e.SW_SHOWMINIMIZED=2]="SW_SHOWMINIMIZED",e[e.SW_SHOWMAXIMIZED=3]="SW_SHOWMAXIMIZED",e[e.SW_MAXIMIZE=3]="SW_MAXIMIZE",e[e.SW_SHOWNOACTIVATE=4]="SW_SHOWNOACTIVATE",e[e.SW_SHOW=5]="SW_SHOW",e[e.SW_MINIMIZE=6]="SW_MINIMIZE",e[e.SW_SHOWMINNOACTIVE=7]="SW_SHOWMINNOACTIVE",e[e.SW_SHOWNA=8]="SW_SHOWNA",e[e.SW_RESTORE=9]="SW_RESTORE",e[e.MCIERR_INVALID_DEVICE_ID=257]="MCIERR_INVALID_DEVICE_ID",e[e.MCIERR_UNRECOGNIZED_KEYWORD=259]="MCIERR_UNRECOGNIZED_KEYWORD",e[e.MCIERR_UNRECOGNIZED_COMMAND=261]="MCIERR_UNRECOGNIZED_COMMAND",e[e.MCIERR_HARDWARE=262]="MCIERR_HARDWARE",e[e.MCIERR_INVALID_DEVICE_NAME=263]="MCIERR_INVALID_DEVICE_NAME",e[e.MCIERR_OUT_OF_MEMORY=264]="MCIERR_OUT_OF_MEMORY",e[e.MCIERR_DEVICE_OPEN=265]="MCIERR_DEVICE_OPEN",e[e.MCIERR_CANNOT_LOAD_DRIVER=266]="MCIERR_CANNOT_LOAD_DRIVER",e[e.MCIERR_MISSING_COMMAND_STRING=267]="MCIERR_MISSING_COMMAND_STRING",e[e.MCIERR_PARAM_OVERFLOW=268]="MCIERR_PARAM_OVERFLOW",e[e.MCIERR_MISSING_STRING_ARGUMENT=269]="MCIERR_MISSING_STRING_ARGUMENT",e[e.MCIERR_BAD_INTEGER=270]="MCIERR_BAD_INTEGER",e[e.MCIERR_PARSER_INTERNAL=271]="MCIERR_PARSER_INTERNAL",e[e.MCIERR_DRIVER_INTERNAL=272]="MCIERR_DRIVER_INTERNAL",e[e.MCIERR_MISSING_PARAMETER=273]="MCIERR_MISSING_PARAMETER",e[e.MCIERR_UNSUPPORTED_FUNCTION=274]="MCIERR_UNSUPPORTED_FUNCTION",e[e.MCIERR_FILE_NOT_FOUND=275]="MCIERR_FILE_NOT_FOUND",e[e.MCIERR_DEVICE_NOT_READY=276]="MCIERR_DEVICE_NOT_READY",e[e.MCIERR_INTERNAL=277]="MCIERR_INTERNAL",e[e.MCIERR_DRIVER=278]="MCIERR_DRIVER",e[e.MCIERR_CANNOT_USE_ALL=279]="MCIERR_CANNOT_USE_ALL",e[e.MCIERR_MULTIPLE=280]="MCIERR_MULTIPLE",e[e.MCIERR_EXTENSION_NOT_FOUND=281]="MCIERR_EXTENSION_NOT_FOUND",e[e.MCIERR_OUTOFRANGE=282]="MCIERR_OUTOFRANGE",e[e.MCIERR_FLAGS_NOT_COMPATIBLE=284]="MCIERR_FLAGS_NOT_COMPATIBLE",e[e.MCIERR_FILE_NOT_SAVED=286]="MCIERR_FILE_NOT_SAVED",e[e.MCIERR_DEVICE_TYPE_REQUIRED=287]="MCIERR_DEVICE_TYPE_REQUIRED",e[e.MCIERR_DEVICE_LOCKED=288]="MCIERR_DEVICE_LOCKED",e[e.MCIERR_DUPLICATE_ALIAS=289]="MCIERR_DUPLICATE_ALIAS",e[e.MCIERR_BAD_CONSTANT=290]="MCIERR_BAD_CONSTANT",e[e.MCIERR_MUST_USE_SHAREABLE=291]="MCIERR_MUST_USE_SHAREABLE",e[e.MCIERR_MISSING_DEVICE_NAME=292]="MCIERR_MISSING_DEVICE_NAME",e[e.MCIERR_BAD_TIME_FORMAT=293]="MCIERR_BAD_TIME_FORMAT",e[e.MCIERR_NO_CLOSING_QUOTE=294]="MCIERR_NO_CLOSING_QUOTE",e[e.MCIERR_DUPLICATE_FLAGS=295]="MCIERR_DUPLICATE_FLAGS",e[e.MCIERR_INVALID_FILE=296]="MCIERR_INVALID_FILE",e[e.MCIERR_NULL_PARAMETER_BLOCK=297]="MCIERR_NULL_PARAMETER_BLOCK",e[e.MCIERR_UNNAMED_RESOURCE=298]="MCIERR_UNNAMED_RESOURCE",e[e.MCIERR_NEW_REQUIRES_ALIAS=299]="MCIERR_NEW_REQUIRES_ALIAS",e[e.MCIERR_NOTIFY_ON_AUTO_OPEN=300]="MCIERR_NOTIFY_ON_AUTO_OPEN",e[e.MCIERR_NO_ELEMENT_ALLOWED=301]="MCIERR_NO_ELEMENT_ALLOWED",e[e.MCIERR_NONAPPLICABLE_FUNCTION=302]="MCIERR_NONAPPLICABLE_FUNCTION",e[e.MCIERR_ILLEGAL_FOR_AUTO_OPEN=303]="MCIERR_ILLEGAL_FOR_AUTO_OPEN",e[e.MCIERR_FILENAME_REQUIRED=304]="MCIERR_FILENAME_REQUIRED",e[e.MCIERR_EXTRA_CHARACTERS=305]="MCIERR_EXTRA_CHARACTERS",e[e.MCIERR_DEVICE_NOT_INSTALLED=306]="MCIERR_DEVICE_NOT_INSTALLED",e[e.MCIERR_GET_CD=307]="MCIERR_GET_CD",e[e.MCIERR_SET_CD=308]="MCIERR_SET_CD",e[e.MCIERR_SET_DRIVE=309]="MCIERR_SET_DRIVE",e[e.MCIERR_DEVICE_LENGTH=310]="MCIERR_DEVICE_LENGTH",e[e.MCIERR_DEVICE_ORD_LENGTH=311]="MCIERR_DEVICE_ORD_LENGTH",e[e.MCIERR_NO_INTEGER=312]="MCIERR_NO_INTEGER",e[e.MCIERR_WAVE_OUTPUTSINUSE=320]="MCIERR_WAVE_OUTPUTSINUSE",e[e.MCIERR_WAVE_SETOUTPUTINUSE=321]="MCIERR_WAVE_SETOUTPUTINUSE",e[e.MCIERR_WAVE_INPUTSINUSE=322]="MCIERR_WAVE_INPUTSINUSE",e[e.MCIERR_WAVE_SETINPUTINUSE=323]="MCIERR_WAVE_SETINPUTINUSE",e[e.MCIERR_WAVE_OUTPUTUNSPECIFIED=324]="MCIERR_WAVE_OUTPUTUNSPECIFIED",e[e.MCIERR_WAVE_INPUTUNSPECIFIED=325]="MCIERR_WAVE_INPUTUNSPECIFIED",e[e.MCIERR_WAVE_OUTPUTSUNSUITABLE=326]="MCIERR_WAVE_OUTPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETOUTPUTUNSUITABLE=327]="MCIERR_WAVE_SETOUTPUTUNSUITABLE",e[e.MCIERR_WAVE_INPUTSUNSUITABLE=328]="MCIERR_WAVE_INPUTSUNSUITABLE",e[e.MCIERR_WAVE_SETINPUTUNSUITABLE=329]="MCIERR_WAVE_SETINPUTUNSUITABLE",e[e.MCIERR_SEQ_DIV_INCOMPATIBLE=336]="MCIERR_SEQ_DIV_INCOMPATIBLE",e[e.MCIERR_SEQ_PORT_INUSE=337]="MCIERR_SEQ_PORT_INUSE",e[e.MCIERR_SEQ_PORT_NONEXISTENT=338]="MCIERR_SEQ_PORT_NONEXISTENT",e[e.MCIERR_SEQ_PORT_MAPNODEVICE=339]="MCIERR_SEQ_PORT_MAPNODEVICE",e[e.MCIERR_SEQ_PORT_MISCERROR=340]="MCIERR_SEQ_PORT_MISCERROR",e[e.MCIERR_SEQ_TIMER=341]="MCIERR_SEQ_TIMER",e[e.MCIERR_SEQ_PORTUNSPECIFIED=342]="MCIERR_SEQ_PORTUNSPECIFIED",e[e.MCIERR_SEQ_NOMIDIPRESENT=343]="MCIERR_SEQ_NOMIDIPRESENT",e[e.MCIERR_NO_WINDOW=346]="MCIERR_NO_WINDOW",e[e.MCIERR_CREATEWINDOW=347]="MCIERR_CREATEWINDOW",e[e.MCIERR_FILE_READ=348]="MCIERR_FILE_READ",e[e.MCIERR_FILE_WRITE=349]="MCIERR_FILE_WRITE",e[e.WS_VISIBLE=268435456]="WS_VISIBLE",e[e.WS_DISABLED=134217728]="WS_DISABLED",e[e.WS_CAPTION=12582912]="WS_CAPTION",e[e.WS_BORDER=8388608]="WS_BORDER",e[e.WS_DLGFRAME=4194304]="WS_DLGFRAME",e[e.WS_VSCROLL=2097152]="WS_VSCROLL",e[e.WS_HSCROLL=1048576]="WS_HSCROLL",e[e.WS_SYSMENU=524288]="WS_SYSMENU",e[e.WS_THICKFRAME=262144]="WS_THICKFRAME",e[e.WS_MINIMIZEBOX=131072]="WS_MINIMIZEBOX",e[e.WS_MAXIMIZEBOX=65536]="WS_MAXIMIZEBOX",e[e.WS_GROUP=131072]="WS_GROUP",e[e.WS_TABSTOP=65536]="WS_TABSTOP",e[e.WS_OVERLAPPED=0]="WS_OVERLAPPED",e[e.WS_POPUP=2147483648]="WS_POPUP",e[e.WS_CHILD=1073741824]="WS_CHILD",e[e.IDX_PRIMARY=1]="IDX_PRIMARY",e[e.IDX_UNIQUE=2]="IDX_UNIQUE",e[e.IDX_DESCENDING=4]="IDX_DESCENDING",e[e.IDX_MAINTAINED=8]="IDX_MAINTAINED",e[e.IDX_SUBSET=16]="IDX_SUBSET",e[e.IDX_EXPR=32]="IDX_EXPR",e[e.IDX_IDXOOD=64]="IDX_IDXOOD",e[e.IDX_CASEINSENS=128]="IDX_CASEINSENS",e[e.FLDDBCHAR=513]="FLDDBCHAR",e[e.FLDDBNUM=514]="FLDDBNUM",e[e.FLDDBMEMO=515]="FLDDBMEMO",e[e.FLDDBBOOL=516]="FLDDBBOOL",e[e.FLDDBDATE=517]="FLDDBDATE",e[e.FLDDBFLOAT=518]="FLDDBFLOAT",e[e.FLDDBLOCK=519]="FLDDBLOCK",e[e.FLDDBOLEBLOB=520]="FLDDBOLEBLOB",e[e.FLDDBBINARY=521]="FLDDBBINARY",e[e.FLDDBBYTES=522]="FLDDBBYTES",e[e.BS_PUSHBUTTON=0]="BS_PUSHBUTTON",e[e.BS_DEFPUSHBUTTON=1]="BS_DEFPUSHBUTTON",e[e.BS_CHECKBOX=2]="BS_CHECKBOX",e[e.BS_AUTOCHECKBOX=3]="BS_AUTOCHECKBOX",e[e.BS_RADIOBUTTON=4]="BS_RADIOBUTTON",e[e.BS_3STATE=5]="BS_3STATE",e[e.BS_AUTO3STATE=6]="BS_AUTO3STATE",e[e.BS_GROUPBOX=7]="BS_GROUPBOX",e[e.BS_USERBUTTON=8]="BS_USERBUTTON",e[e.BS_AUTORADIOBUTTON=9]="BS_AUTORADIOBUTTON",e[e.BS_OWNERDRAW=11]="BS_OWNERDRAW",e[e.BS_LEFTTEXT=32]="BS_LEFTTEXT",e[e.ES_LEFT=0]="ES_LEFT",e[e.ES_CENTER=1]="ES_CENTER",e[e.ES_RIGHT=2]="ES_RIGHT",e[e.ES_MULTILINE=4]="ES_MULTILINE",e[e.ES_UPPERCASE=8]="ES_UPPERCASE",e[e.ES_LOWERCASE=16]="ES_LOWERCASE",e[e.ES_PASSWORD=32]="ES_PASSWORD",e[e.ES_AUTOVSCROLL=64]="ES_AUTOVSCROLL",e[e.ES_AUTOHSCROLL=128]="ES_AUTOHSCROLL",e[e.ES_NOHIDESEL=256]="ES_NOHIDESEL",e[e.SBS_HORZ=0]="SBS_HORZ",e[e.SBS_VERT=1]="SBS_VERT",e[e.SBS_TOPALIGN=2]="SBS_TOPALIGN",e[e.SBS_LEFTALIGN=2]="SBS_LEFTALIGN",e[e.SBS_BOTTOMALIGN=4]="SBS_BOTTOMALIGN",e[e.SBS_RIGHTALIGN=4]="SBS_RIGHTALIGN",e[e.SBS_SIZEBOXTOPLEFTALIGN=2]="SBS_SIZEBOXTOPLEFTALIGN",e[e.SBS_SIZEBOXBOTTOMRIGHTALIGN=4]="SBS_SIZEBOXBOTTOMRIGHTALIGN",e[e.SBS_SIZEBOX=8]="SBS_SIZEBOX",e[e.LBS_NOTIFY=1]="LBS_NOTIFY",e[e.LBS_SORT=2]="LBS_SORT",e[e.LBS_NOREDRAW=4]="LBS_NOREDRAW",e[e.LBS_MULTIPLESEL=8]="LBS_MULTIPLESEL",e[e.LBS_OWNERDRAWFIXED=16]="LBS_OWNERDRAWFIXED",e[e.LBS_OWNERDRAWVARIABLE=32]="LBS_OWNERDRAWVARIABLE",e[e.LBS_HASSTRINGS=64]="LBS_HASSTRINGS",e[e.LBS_USETABSTOPS=128]="LBS_USETABSTOPS",e[e.LBS_NOINTEGRALHEIGHT=256]="LBS_NOINTEGRALHEIGHT",e[e.LBS_MULTICOLUMN=512]="LBS_MULTICOLUMN",e[e.LBS_WANTKEYBOARDINPUT=1024]="LBS_WANTKEYBOARDINPUT",e[e.LBS_EXTENDEDSEL=2048]="LBS_EXTENDEDSEL",e[e.CBS_SIMPLE=1]="CBS_SIMPLE",e[e.CBS_DROPDOWN=2]="CBS_DROPDOWN",e[e.CBS_DROPDOWNLIST=3]="CBS_DROPDOWNLIST",e[e.CBS_OWNERDRAWFIXED=16]="CBS_OWNERDRAWFIXED",e[e.CBS_OWNERDRAWVARIABLE=32]="CBS_OWNERDRAWVARIABLE",e[e.CBS_AUTOHSCROLL=64]="CBS_AUTOHSCROLL",e[e.CBS_OEMCONVERT=128]="CBS_OEMCONVERT",e[e.CBS_SORT=256]="CBS_SORT",e[e.CBS_HASSTRINGS=512]="CBS_HASSTRINGS",e[e.CBS_NOINTEGRALHEIGHT=1024]="CBS_NOINTEGRALHEIGHT",e[e.BS_SOLID=0]="BS_SOLID",e[e.BS_NULL=1]="BS_NULL",e[e.BS_HATCHED=2]="BS_HATCHED",e[e.BS_PATTERN=3]="BS_PATTERN",e[e.BS_GRADIENT_LINEAR=10]="BS_GRADIENT_LINEAR",e[e.HS_HORIZONTAL=0]="HS_HORIZONTAL",e[e.HS_VERTICAL=1]="HS_VERTICAL",e[e.HS_FDIAGONAL=2]="HS_FDIAGONAL",e[e.HS_BDIAGONAL=3]="HS_BDIAGONAL",e[e.HS_CROSS=4]="HS_CROSS",e[e.HS_DIAGCROSS=5]="HS_DIAGCROSS",e[e.PS_SOLID=0]="PS_SOLID",e[e.PS_DASH=1]="PS_DASH",e[e.PS_DOT=2]="PS_DOT",e[e.PS_DASHDOT=3]="PS_DASHDOT",e[e.PS_DASHDOTDOT=4]="PS_DASHDOTDOT",e[e.PS_NULL=5]="PS_NULL",e[e.PS_INSIDEFRAME=6]="PS_INSIDEFRAME",e[e.R2_BLACK=1]="R2_BLACK",e[e.R2_NOTMERGEPEN=2]="R2_NOTMERGEPEN",e[e.R2_MASKNOTPEN=3]="R2_MASKNOTPEN",e[e.R2_NOTCOPYPEN=4]="R2_NOTCOPYPEN",e[e.R2_MASKPENNOT=5]="R2_MASKPENNOT",e[e.R2_NOT=6]="R2_NOT",e[e.R2_XORPEN=7]="R2_XORPEN",e[e.R2_NOTMASKPEN=8]="R2_NOTMASKPEN",e[e.R2_MASKPEN=9]="R2_MASKPEN",e[e.R2_NOTXORPEN=10]="R2_NOTXORPEN",e[e.R2_NOP=11]="R2_NOP",e[e.R2_MERGENOTPEN=12]="R2_MERGENOTPEN",e[e.R2_COPYPEN=13]="R2_COPYPEN",e[e.R2_MERGEPENNOT=14]="R2_MERGEPENNOT",e[e.R2_MERGEPEN=15]="R2_MERGEPEN",e[e.R2_WHITE=16]="R2_WHITE",e[e.FILE_ATTRIBUTE_ARCHIVE=32]="FILE_ATTRIBUTE_ARCHIVE",e[e.FILE_ATTRIBUTE_COMPRESSED=2048]="FILE_ATTRIBUTE_COMPRESSED",e[e.FILE_ATTRIBUTE_DIRECTORY=16]="FILE_ATTRIBUTE_DIRECTORY",e[e.FILE_ATTRIBUTE_HIDDEN=2]="FILE_ATTRIBUTE_HIDDEN",e[e.FILE_ATTRIBUTE_NORMAL=128]="FILE_ATTRIBUTE_NORMAL",e[e.FILE_ATTRIBUTE_OFFLINE=4096]="FILE_ATTRIBUTE_OFFLINE",e[e.FILE_ATTRIBUTE_READONLY=1]="FILE_ATTRIBUTE_READONLY",e[e.FILE_ATTRIBUTE_SYSTEM=4]="FILE_ATTRIBUTE_SYSTEM",e[e.FILE_ATTRIBUTE_TEMPORARY=256]="FILE_ATTRIBUTE_TEMPORARY",e[e.VF_LOCAL=2]="VF_LOCAL",e[e.VF_EQVAR=256]="VF_EQVAR",e[e.VF_ARGUMENT=512]="VF_ARGUMENT",e[e.VF_RETURN=1024]="VF_RETURN",e[e.CUR_ARROW=0]="CUR_ARROW",e[e.CUR_CROSS=1]="CUR_CROSS",e[e.CUR_TEXT=2]="CUR_TEXT",e[e.CUR_NO=3]="CUR_NO",e[e.CUR_SIZE=4]="CUR_SIZE",e[e.CUR_SIZENESW=5]="CUR_SIZENESW",e[e.CUR_SIZENS=6]="CUR_SIZENS",e[e.CUR_SIZENWSE=7]="CUR_SIZENWSE",e[e.CUR_SIZEWE=8]="CUR_SIZEWE",e[e.CUR_UPARROW=9]="CUR_UPARROW",e[e.CUR_WAIT=10]="CUR_WAIT",e[e.CUR_LINK=11]="CUR_LINK",e[e.CUR_HELP=12]="CUR_HELP",e[e.SHADOWTYPE_STENCIL_MODULATIVE=18]="SHADOWTYPE_STENCIL_MODULATIVE",e[e.SHADOWTYPE_STENCIL_ADDITIVE=17]="SHADOWTYPE_STENCIL_ADDITIVE",e[e.SHADOWTYPE_TEXTURE_MODULATIVE=34]="SHADOWTYPE_TEXTURE_MODULATIVE",e[e.SHADOWTYPE_TEXTURE_ADDITIVE=33]="SHADOWTYPE_TEXTURE_ADDITIVE",e[e.FOG_NONE=0]="FOG_NONE",e[e.FOG_EXP=1]="FOG_EXP",e[e.FOG_EXP2=2]="FOG_EXP2",e[e.FOG_LINEAR=3]="FOG_LINEAR",e[e.TEX_TYPE_1D=1]="TEX_TYPE_1D",e[e.TEX_TYPE_2D=2]="TEX_TYPE_2D",e[e.TEX_TYPE_3D=3]="TEX_TYPE_3D",e[e.TEX_TYPE_CUBE_MAP=4]="TEX_TYPE_CUBE_MAP",e[e.SBF_ONE=0]="SBF_ONE",e[e.SBF_ZERO=1]="SBF_ZERO",e[e.SBF_DEST_COLOUR=2]="SBF_DEST_COLOUR",e[e.SBF_SOURCE_COLOUR=3]="SBF_SOURCE_COLOUR",e[e.SBF_ONE_MINUS_DEST_COLOUR=4]="SBF_ONE_MINUS_DEST_COLOUR",e[e.SBF_ONE_MINUS_SOURCE_COLOUR=5]="SBF_ONE_MINUS_SOURCE_COLOUR",e[e.SBF_DEST_ALPHA=6]="SBF_DEST_ALPHA",e[e.SBF_SOURCE_ALPHA=7]="SBF_SOURCE_ALPHA",e[e.SBF_ONE_MINUS_DEST_ALPHA=8]="SBF_ONE_MINUS_DEST_ALPHA",e[e.SBF_ONE_MINUS_SOURCE_ALPHA=9]="SBF_ONE_MINUS_SOURCE_ALPHA",e[e.CMPF_ALWAYS_FAIL=0]="CMPF_ALWAYS_FAIL",e[e.CMPF_ALWAYS_PASS=1]="CMPF_ALWAYS_PASS",e[e.CMPF_LESS=2]="CMPF_LESS",e[e.CMPF_LESS_EQUAL=3]="CMPF_LESS_EQUAL",e[e.CMPF_EQUAL=4]="CMPF_EQUAL",e[e.CMPF_NOT_EQUAL=5]="CMPF_NOT_EQUAL",e[e.CMPF_GREATER_EQUAL=6]="CMPF_GREATER_EQUAL",e[e.CMPF_GREATER=7]="CMPF_GREATER",e[e.CULL_NONE=1]="CULL_NONE",e[e.CULL_CLOCKWISE=2]="CULL_CLOCKWISE",e[e.CULL_ANTICLOCKWISE=3]="CULL_ANTICLOCKWISE",e[e.SO_FLAT=0]="SO_FLAT",e[e.SO_GOURAUD=1]="SO_GOURAUD",e[e.SO_PHONG=2]="SO_PHONG",e[e.PM_POINTS=1]="PM_POINTS",e[e.PM_WIREFRAME=2]="PM_WIREFRAME",e[e.PM_SOLID=3]="PM_SOLID",e[e.LT_POINT=0]="LT_POINT",e[e.LT_DIRECTIONAL=1]="LT_DIRECTIONAL",e[e.LT_SPOTLIGHT=2]="LT_SPOTLIGHT",e[e.PT_ORTHOGRAPHIC=0]="PT_ORTHOGRAPHIC",e[e.PT_PERSPECTIVE=1]="PT_PERSPECTIVE",e[e.OT_POINT_LIST=1]="OT_POINT_LIST",e[e.OT_LINE_LIST=2]="OT_LINE_LIST",e[e.OT_LINE_STRIP=3]="OT_LINE_STRIP",e[e.OT_TRIANGLE_LIST=4]="OT_TRIANGLE_LIST",e[e.OT_TRIANGLE_STRIP=5]="OT_TRIANGLE_STRIP",e[e.OT_TRIANGLE_FAN=6]="OT_TRIANGLE_FAN",e[e.BBT_POINT=0]="BBT_POINT",e[e.BBT_ORIENTED_COMMON=1]="BBT_ORIENTED_COMMON",e[e.BBT_ORIENTED_SELF=2]="BBT_ORIENTED_SELF",e[e.BBT_PERPENDICULAR_COMMON=3]="BBT_PERPENDICULAR_COMMON",e[e.BBT_PERPENDICULAR_SELF=4]="BBT_PERPENDICULAR_SELF",e[e.GMM_RELATIVE=0]="GMM_RELATIVE",e[e.GMM_PIXELS=1]="GMM_PIXELS",e[e.GMM_RELATIVE_ASPECT_ADJUSTED=2]="GMM_RELATIVE_ASPECT_ADJUSTED",e[e.GHA_LEFT=0]="GHA_LEFT",e[e.GHA_CENTER=1]="GHA_CENTER",e[e.GHA_RIGHT=2]="GHA_RIGHT",e[e.GVA_TOP=0]="GVA_TOP",e[e.GVA_CENTER=1]="GVA_CENTER",e[e.GVA_BOTTOM=2]="GVA_BOTTOM",e[e.MTHA_LEFT=0]="MTHA_LEFT",e[e.MTHA_CENTER=1]="MTHA_CENTER",e[e.MTVA_BELOW=0]="MTVA_BELOW",e[e.MTVA_ABOVE=1]="MTVA_ABOVE",e[e.MTVA_CENTER=2]="MTVA_CENTER",e[e.PT_BOOL=0]="PT_BOOL",e[e.PT_REAL=1]="PT_REAL",e[e.PT_INT=2]="PT_INT",e[e.PT_UNSIGNED_INT=3]="PT_UNSIGNED_INT",e[e.PT_SHORT=4]="PT_SHORT",e[e.PT_UNSIGNED_SHORT=5]="PT_UNSIGNED_SHORT",e[e.PT_LONG=6]="PT_LONG",e[e.PT_UNSIGNED_LONG=7]="PT_UNSIGNED_LONG",e[e.PT_STRING=8]="PT_STRING",e[e.PT_VECTOR3=9]="PT_VECTOR3",e[e.PT_MATRIX3=10]="PT_MATRIX3",e[e.PT_MATRIX4=11]="PT_MATRIX4",e[e.PT_QUATERNION=12]="PT_QUATERNION",e[e.PT_COLOURVALUE=13]="PT_COLOURVALUE",e[e.NUI_SP_HIP_CENTER=0]="NUI_SP_HIP_CENTER",e[e.NUI_SP_SPINE=1]="NUI_SP_SPINE",e[e.NUI_SP_SHOULDER_CENTER=2]="NUI_SP_SHOULDER_CENTER",e[e.NUI_SP_HEAD=3]="NUI_SP_HEAD",e[e.NUI_SP_SHOULDER_LEFT=4]="NUI_SP_SHOULDER_LEFT",e[e.NUI_SP_ELBOW_LEFT=5]="NUI_SP_ELBOW_LEFT",e[e.NUI_SP_WRIST_LEFT=6]="NUI_SP_WRIST_LEFT",e[e.NUI_SP_HAND_LEFT=7]="NUI_SP_HAND_LEFT",e[e.NUI_SP_SHOULDER_RIGHT=8]="NUI_SP_SHOULDER_RIGHT",e[e.NUI_SP_ELBOW_RIGHT=9]="NUI_SP_ELBOW_RIGHT",e[e.NUI_SP_WRIST_RIGHT=10]="NUI_SP_WRIST_RIGHT",e[e.NUI_SP_HAND_RIGHT=11]="NUI_SP_HAND_RIGHT",e[e.NUI_SP_HIP_LEFT=12]="NUI_SP_HIP_LEFT",e[e.NUI_SP_KNEE_LEFT=13]="NUI_SP_KNEE_LEFT",e[e.NUI_SP_ANKLE_LEFT=14]="NUI_SP_ANKLE_LEFT",e[e.NUI_SP_FOOT_LEFT=15]="NUI_SP_FOOT_LEFT",e[e.NUI_SP_HIP_RIGHT=16]="NUI_SP_HIP_RIGHT",e[e.NUI_SP_KNEE_RIGHT=17]="NUI_SP_KNEE_RIGHT",e[e.NUI_SP_ANKLE_RIGHT=18]="NUI_SP_ANKLE_RIGHT",e[e.NUI_SP_FOOT_RIGHT=19]="NUI_SP_FOOT_RIGHT",e[e.NUI_SP_COUNT=20]="NUI_SP_COUNT",e[e.WEB_DIALOG_OPEN=100]="WEB_DIALOG_OPEN",e))(v||{});const dr=258;var B=(e=>(e[e.FLOAT=1]="FLOAT",e[e.STRING=2]="STRING",e[e.HANDLE=3]="HANDLE",e[e.COLORREF=4]="COLORREF",e))(B||{});const ic=1,nc=0,oc=1,cc=2,ac=3,lc=4,hc="CM_CLEARALL",uc="CM_PREVPAGE",ye=8;var Ie=(e=>(e[e.FLOAT_REF=B.FLOAT|ye]="FLOAT_REF",e[e.STRING_REF=B.STRING|ye]="STRING_REF",e[e.HANDLE_REF=B.HANDLE|ye]="HANDLE_REF",e[e.COLORREF_REF=B.COLORREF|ye]="COLORREF_REF",e))(Ie||{});class dc{constructor(){this.blocks=[]}pushBlock(t){return this.blocks.push(t),t}popBlock(t){const r=this.blocks.pop();if(r?.expect!==t)throw Error(`Ожидалось ${t}`);return r}lastBlock(){return this.blocks.length>0?this.blocks[this.blocks.length-1]:null}haveABreakHaveAKitKat(){for(let t=this.blocks.length-1;t>=0;--t)if(this.blocks[t].canBreak)return"break;";return"return;"}}const fc="map",gc="g",fr="schema",gr="string",Ts="n",ws="o",ys={[B.FLOAT]:"f",[B.HANDLE]:"i",[B.COLORREF]:"i",[B.STRING]:"s"},pc=`
"use strict"
const { map, values } = memory;
const of = values.oldFloats;
const nf = values.newFloats;
const oi = values.oldInts;
const ni = values.newInts;
const os = values.oldStrings;
const ns = values.newStrings;
function string(value) {
    return (Math.round(value * 1e5) / 1e5).toString()
}
`,_c="userFunction",Ec="solveEquationsFor",{FLOAT:U,STRING:se,HANDLE:Pt,COLORREF:mc}=B,Tc=[["ABS",{argTypes:[U],retType:U,template:"Math.abs(#0) || 0"}],["ALLTRIM",{argTypes:[se],retType:se,template:"(#0).trim()"}],["AND",{argTypes:[U,U],retType:U,template:"(#0) && (#1) ? 1 : 0"}],["ARCTAN",{argTypes:[U],retType:U,template:"Math.atan(#0)||0"}],["AVERAGE",{argTypes:[U,U],retType:U,template:"(#0) / 2 + (#1) / 2"}],["COMPARE",{argTypes:[se,se],retType:U,template:"(#0) == (#1) ? 1 : 0"}],["COS",{argTypes:[U],retType:U,template:"Math.cos(#0) || 0"}],["DEG",{argTypes:[U],retType:U,template:"180 * (#0) / Math.PI || 0"}],["DELTA",{argTypes:[U],retType:U,template:"(#0) ? 0 : 1"}],["ED",{argTypes:[U],retType:U,template:"(#0) > 0 ? 1 : 0"}],["ED",{argTypes:[Pt],retType:U,template:"(#0) > 0 ? 1 : 0"}],["EXP",{argTypes:[U],retType:U,template:"Math.exp(#0) || 0"}],["FLOAT",{argTypes:[mc],retType:U,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[U],retType:U,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[Pt],retType:U,template:"parseFloat(#0) || 0"}],["FLOAT",{argTypes:[se],retType:U,template:"parseFloat(#0) || 0"}],["HANDLE",{argTypes:[U],retType:Pt,template:"parseInt(#0) || 0"}],["LEFT",{argTypes:[se,U],retType:se,template:"(#0).substring(0, #1)"}],["LENGTH",{argTypes:[se],retType:U,template:"(#0).length"}],["LIMIT",{argTypes:[U,U,U],retType:U,template:"Math.max(#1, Math.min(#2, #0))||0"}],["LOWER",{argTypes:[se],retType:se,template:"(#0).toLowerCase()"}],["LTRIM",{argTypes:[se],retType:se,template:'(#0).replace(/^\\s+/, "")'}],["MAX",{argTypes:[U,U],retType:U,template:"Math.max(#0, #1) || 0"}],["MIN",{argTypes:[U,U],retType:U,template:"Math.min(#0, #1) || 0"}],["NOT",{argTypes:[U],retType:U,template:"(#0) ? 0 : 1"}],["NOT",{argTypes:[Pt],retType:U,template:"(#0) ? 0 : 1"}],["NOTBIN",{argTypes:[U],retType:U,template:"~(#0)"}],["OR",{argTypes:[U,U],retType:U,template:"(#0) || (#1) ? 1 : 0"}],["RAD",{argTypes:[U],retType:U,template:"Math.PI * (#0) / 180 || 0"}],["REPLICATE",{argTypes:[se,U],retType:se,template:"(#0).repeat(#1)"}],["RND",{argTypes:[U],retType:U,template:"(#0) * Math.random()"}],["RTRIM",{argTypes:[se],retType:se,template:'(#0).replace(/\\s+$/, "")'}],["SGN",{argTypes:[U],retType:U,template:"Math.sign(#0) || 0"}],["SIN",{argTypes:[U],retType:U,template:"Math.sin(#0) || 0"}],["SQR",{argTypes:[U],retType:U,template:"(#0) ** 2"}],["SQRT",{argTypes:[U],retType:U,template:"Math.sqrt(#0) || 0"}],["STRING",{argTypes:[U],retType:se,template:`${gr}(#0)`}],["TAN",{argTypes:[U],retType:U,template:"Math.tan(#0) || 0"}],["TRUNC",{argTypes:[U],retType:U,template:"Math.trunc(#0) || 0"}],["UPPER",{argTypes:[se],retType:se,template:"(#0).toUpperCase()"}],["XOR",{argTypes:[U,U],retType:U,template:"(#0) !== 0 ^ (#1) !== 0"}],["XORBIN",{argTypes:[U,U],retType:U,template:"(#0) ^ (#1)"}]],wc=(()=>{const e=new Map;return Tc.forEach(([t,r])=>{let s=e.get(t);s||e.set(t,s=[]),s.push(r)}),e})(),{FLOAT:$,STRING:ie,HANDLE:be,COLORREF:Dt}=B,bs=[{name:"^",arg:[$,$],ret:$,text:"#0 ** #1",prior:13},{name:"*",arg:[$,$],ret:$,text:"#0 * #1",prior:12},{name:"/",arg:[$,$],ret:$,text:"#0 / (#1 || Infinity)",prior:12},{name:"%",arg:[$,$],ret:$,text:"#0 % #1",prior:12},{name:"+",arg:[$,$],ret:$,text:"#0 + #1",prior:11},{name:"+",arg:[ie,ie],ret:ie,text:"#0 + #1",prior:11},{name:"+",arg:[ie,$],ret:ie,text:`#0 + ${gr}(#1)`,prior:11},{name:"+",arg:[$,ie],ret:ie,text:`${gr}(#0) + #1`,prior:11},{name:"-",arg:[$,$],ret:$,text:"#0 - #1",prior:11},{name:"<<",arg:[$,$],ret:$,text:"#0 << #1",prior:10},{name:">>",arg:[$,$],ret:$,text:"#0 >> #1",prior:10},{name:">",arg:[$,$],ret:$,text:"+(#0 > #1)",prior:9},{name:">=",arg:[$,$],ret:$,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[$,$],ret:$,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[$,$],ret:$,text:"+(#0 <= #1)",prior:9},{name:">",arg:[ie,ie],ret:$,text:"+(#0 > #1)",prior:9},{name:">=",arg:[ie,ie],ret:$,text:"+(#0 >= #1)",prior:9},{name:"<",arg:[ie,ie],ret:$,text:"+(#0 < #1)",prior:9},{name:"<=",arg:[ie,ie],ret:$,text:"+(#0 <= #1)",prior:9},{name:"==",arg:[$,$],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[ie,ie],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[be,be],ret:$,text:"+(#0 == #1)",prior:8},{name:"==",arg:[Dt,Dt],ret:$,text:"+(#0 == #1)",prior:8},{name:"!=",arg:[$,$],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[ie,ie],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[be,be],ret:$,text:"+(#0 != #1)",prior:8},{name:"!=",arg:[Dt,Dt],ret:$,text:"+(#0 != #1)",prior:8},{name:"&",arg:[$,$],ret:$,text:"#0 & #1",prior:7},{name:"|",arg:[$,$],ret:$,text:"#0 | #1",prior:5},{name:"&&",arg:[$,$],ret:$,text:"+Boolean(#0 && #1)",prior:4},{name:"&&",arg:[be,be],ret:be,text:"+Boolean(#0 && #1)",prior:4},{name:"||",arg:[$,$],ret:$,text:"+Boolean(#0 || #1)",prior:3},{name:"||",arg:[be,be],ret:be,text:"+Boolean(#0 || #1)",prior:3}],yc=Array.from(new me(bs.map(e=>[e.prior,e.name]))).sort((e,t)=>t[0]-e[0]).map(e=>Array.from(e[1]));class bc{constructor(){this.m=new Map}declareVar(t,r,s){const i=t.toLowerCase(),n=this.m.get(i);if(n){if(n[0].type!==r)throw Error(`Переменная уже объявлена: ${t}`);return!1}const a={name:t,type:r,attrib:s||void 0};return this.m.set(i,[a,this.m.size]),!0}makeInEquation(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);if(s[0].type!==B.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);s[0].inEquation=!0}setAsReturn(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);s[0].attrib=(s[0].attrib??0)|v.VF_RETURN}getFloatVar(t){const r=t.toLowerCase(),s=this.m.get(r);if(!s)throw Error(`Неизвестная переменная: ${t}`);if(s[0].type!==B.FLOAT)throw Error(`Переменная уравнения ${t} не имеет тип FLOAT`);return`$${r}`}_getOrCreateVar(t,r){const s=t.toLowerCase(),i=this.m.get(s);if(i)return[s,i[0]];const n={name:t,type:r};return this.m.set(s,[n,this.m.size]),[s,n]}getOrCreateVar(t,r,s=B.FLOAT){const[i,{type:n}]=this._getOrCreateVar(r,s),a=`${t?Ts:ws}${ys[n]}`,l=`$${i}`;return{text:`${a}[${l}]`,type:n}}derefer(t,r=B.FLOAT){const s=t.first;if(s.type!=="var"||t.rest.length>0)throw Error("Должно быть имя переменной");const[i,{type:n}]=this._getOrCreateVar(s.name,r),a=`${s.isNew?Ts:ws}${ys[n]}`,l=`$${i}`;return[a,l]}result(){return[...this.m.values()].sort((t,r)=>t[1]-r[1]).map(t=>t[0])}}function Rs(e,t){const r=t.args.map(l=>Re(e,l)),s=t.name.toUpperCase(),i=wc.get(s);if(i){const l=i.find(({argTypes:d})=>d.length===r.length&&d.every((g,E)=>g===r[E].type));if(!l)throw Error(`Некорректная сигнатура функции ${t.name}(${r.map(d=>B[d.type])}).
Возможные варианты:
`+i.map(d=>`${t.name}(${d.argTypes.map(g=>B[g])})`).join(`
`));const h=r.map(d=>d.text);return{text:l.template.replace(/#(\d)/g,(d,g)=>h[g]),type:l.retType}}if(s==="EXIT"){if(r.length>0)throw Error(`${t.name}: ожидалось 0 аргументов, получено ${r.length}`);return{text:"return",type:null}}const n=e.funcTable?.get(s);if(!n)throw Error(`Функция не существует: ${`${t.name}(${r.map(l=>B[l.type])})`}`);const a=n.find(l=>{if(!l.argTypes.every((E,T)=>{if(T>=r.length)return!1;const m=E&ye-1;return r[T].type===m}))return!1;const d=r.length-l.argTypes.length;if(!d)return!0;if(l.type==="user")return!1;const{restArgsTypes:g}=l;return d%g.length!==0?!1:r.slice(-d).every((E,T)=>E.type===g[T%g.length])});if(!a){const l=`${t.name}(${r.map(d=>B[d.type])})`,h=n.map(d=>{const g=d.argTypes.map(E=>(E&ye?"&":"")+B[E&ye-1]);return d.type==="plugin"&&d.restArgsTypes.length&&g.push(`[${d.restArgsTypes.map(E=>B[E])}]`),` - ${t.name}(${g})`});throw Error(`Некорректная сигнатура функции ${l}.
Возможные варианты:
${h.join(`;
`)}`)}if(a.type==="plugin"){const l=r.map((d,g)=>a.argTypes[g]&ye?e.vars.derefer(t.args[g]):d.text);let h=`${gc}.${a.path}.call(${[fr,...l]})`;return a.kind==="generator"?h="yield* "+h:a.kind==="async"&&(h="yield "+h),{text:h,type:a.retType}}else{const l=r.map(h=>h.text);return{text:`yield* ${fr}.${_c}(${[`"${a.name}"`,`[${l}]`]})`,type:a.retType}}}function Rc(e){return`t${e.tmpVarCount++}`}function kt(e,t){switch(t.isNew&&t.type!=="var"&&e.bugs.push(["Применение оператора '~' не к переменной",t]),t.type){case"float":return{text:parseFloat(t.value).toString(),type:B.FLOAT};case"handle":return{text:parseInt(t.value,10).toString(),type:B.HANDLE};case"string":return{text:"`"+t.value.replace(/[`$\\]/g,"\\$&")+"`",type:B.STRING};case"var":{const r=v[t.name.toUpperCase()]?.toString();return r?{text:r,type:B.FLOAT}:e.vars.getOrCreateVar(t.isNew,t.name)}case"call":{let r=t;if(t.isNew&&t.args.length){const n={...t.args[0].first,isNew:!0},a=[{...t.args[0],first:n},...t.args.slice(1)];r={...t,args:a}}const s=Rc(e),i=Rs(e,r);if(!i.type)throw Error(`Функция ${t.name} не возвращает значения`);return e.lines.push(`const ${s}=${i.text};`),{text:s,type:i.type}}case"-":case"!":{let r=t.op;t.isNew&&(r={...r,isNew:!0});const s=kt(e,r);if(s.type!==B.FLOAT)throw Error(`Оператор "${t.type}" не применим к ${B[s.type]}`);return{text:`(${t.type}${s.text})`,type:s.type}}case"subexpr":{const r=Re(e,t.expr);return{text:`(${r.text})`,type:r.type}}}}function Re(e,{first:t,rest:r}){if(!r.length)return kt(e,t);const s=[{type:"decl",op:t},...ls(r.map(n=>[n.action,{type:"decl",op:n.operand}]))];yc.forEach(n=>{for(;;){const a=s.findIndex(O=>typeof O=="string"&&n.includes(O));if(a<0)break;const l=s[a],h=s[a-1],d=s[a+1],g=h.type==="decl"?kt(e,h.op):h.res,E=d.type==="decl"?kt(e,d.op):d.res,T=bs.find(({name:O,arg:N})=>O===l&&N[0]===g.type&&N[1]===E.type);if(!T)throw Error(`Оператор '${l}' неприменим к '${B[g.type]}', '${B[E.type]}'`);const m={text:T.text.replace(/#\d/g,O=>(O==="#0"?g:E).text),type:T.ret};s.splice(a-1,3,{type:"parsed",res:m})}});const i=s[0];if(typeof i!="object"||i.type!=="parsed")throw Error("Ошибка разбора выражения");return i.res}function Os(e,t,r){if(t!==r)throw Error(`"${e}" имеет тип ${B[t]}, но правое выражение возвращает ${B[r]}`)}function Ms(e,t){switch(t.type){case":=":{const s=Re(e,t.expr),i=e.vars.getOrCreateVar(!0,t.to,s.type);Os(t.to,i.type,s.type),e.lines.push(`${i.text} = ${s.text};`);break}case"callChain":{t.functions.forEach(s=>{const i=Rs(e,s);e.lines.push(`${i.text};`)});break}case"if":{e.b.pushBlock({canBreak:!1,expect:"endif",hasElse:!1});const s=Re(e,t.expr);e.lines.push(`if (${s.text}) {`);break}case"else":{const s=e.b.lastBlock();if(s?.expect!=="endif"||s.hasElse)throw Error("else должен находиться после if");s.hasElse=!0,e.lines.push("} else {");break}case"endif":{e.b.popBlock("endif"),e.lines.push("}");break}case"varsDec":{const{datatype:s,modifiers:i,names:n}=t;let a;switch(s){case"FLOAT":case"INTEGER":a=B.FLOAT;break;case"HANDLE":a=B.HANDLE;break;case"STRING":a=B.STRING;break;case"COLORREF":a=B.COLORREF;break}const l=(i.includes("LOCAL")?v.VF_LOCAL:0)|(i.includes("PARAMETER")?v.VF_ARGUMENT:0);n.forEach(h=>{e.vars.declareVar(h,a,l)||e.bugs.push([`Повторное объявление переменной: ${h}`,t])});break}case"while":{e.b.pushBlock({expect:"endwhile",canBreak:!0});const s=`g${++e.whileGuardCount}`;e.lines.push(`var ${s} = 0;`),e.lines.push("while (true) {"),e.lines.push(`if (++${s} > 10000000) throw Error("Бесконечный цикл (10_000_000 итераций)");`);const i=Re(e,t.expr);e.lines.push(`if (!(${i.text})) break;`);break}case"endwhile":{e.b.popBlock("endwhile"),e.lines.push("}");break}case"do":{e.b.pushBlock({expect:"until",canBreak:!0}),e.lines.push("do {");break}case"until":{e.b.popBlock("until");const s=Re(e,t.expr);e.lines.push(`if (!(${s.text})) break;`),e.lines.push("} while (true);");break}case"switch":{e.b.pushBlock({expect:"endswitch",canBreak:!0,caseCount:0}),e.lines.push("do { //switch");break}case"endswitch":{const s=e.b.popBlock("endswitch");if(!s.caseCount)throw Error("Ожидалось case");for(let i=0;i<s.caseCount;++i)e.lines.push("}");e.lines.push("} while (false); //endswitch");break}case"case":{const s=e.b.lastBlock();if(s?.expect!=="endswitch")throw Error("case должен находиться внутри блока switch");s.caseCount&&e.lines.push("} else {"),++s.caseCount;const i=Re(e,t.expr);e.lines.push(`if (${i.text}) { //case`);break}case"default":{if(e.b.lastBlock()?.expect!=="endswitch")throw Error("default должен находиться внутри блока switch");e.lines.push("} else { //default");break}case"break":e.lines.push(e.b.haveABreakHaveAKitKat());break;case"=":{const s={...e,lines:[]},i=Re(s,t.lhs);if(i.type!==B.FLOAT)throw Error("Левая часть выражения не возвращает FLOAT");const n=Re(s,t.rhs);if(n.type!==B.FLOAT)throw Error("Правая часть выражения не возвращает FLOAT");s.lines.push(`return ${n.text} - (${i.text});`),e.equations.push(s.lines);break}case"::=":{const s={...e,lines:[]},i=Re(s,t.expr),n=e.vars.getOrCreateVar(!0,t.to,i.type);Os(t.to,n.type,i.type),s.lines.push(`${n.text} = ${i.text};`),e.defers.push(s.lines);break}case"eqResult":{if(t.deferred)t.vars.forEach(s=>e.vars.makeInEquation(s));else{const s=t.vars.map(i=>e.vars.getFloatVar(i));e.lines.push(`${fr}.${Ec}([${s}]);`)}break}case"function":{e.isFunction=!0;break}case"return":{e.vars.setAsReturn(t.to);break}default:throw Error(`Неизвестный оператор: "${t.type}"`)}}function Oc(e,t,r){const s=e.vars.result(),{lines:i,bugs:n,equations:a,defers:l,isFunction:h}=e;if(i.length===0&&a.length===0&&l.length===0)return{bugs:n,vars:s,isFunction:h,mainText:"",equationsTexts:[],defersTexts:[]};const d=s.map((y,P)=>`const $${y.name.toLowerCase()} = ${fc}[${P}];`).join(`
`),g=pc+`
`+d+`
`,E=t?`//# sourceURL=_transpiled/${t}`:"",T=r?.split(`
`).map(y=>"// "+y).join(`
`)??"",m=i.length?T+g+i.join(`
`)+E:"",O=a.map((y,P)=>g+y.join(`
`)+(E&&`${E}_eq_${P}`)),N=l.map((y,P)=>g+y.join(`
`)+(E&&`${E}_defer_${P}`));return{bugs:n,vars:s,isFunction:h,mainText:m,equationsTexts:O,defersTexts:N}}function Mc(e,{funcTable:t,sourceURL:r,comment:s}={}){const i={funcTable:t,vars:new bc,b:new dc,lines:[],defers:[],equations:[],isFunction:!1,bugs:[],tmpVarCount:0,whileGuardCount:0};e.forEach(a=>{try{Ms(i,a.code);let l=a.code.then;for(;l;)Ms(i,l),l=l.then}catch(l){throw l instanceof Error?Error(`Строка ${a.line}: ${l.message}`):l}});const n=i.b.lastBlock();if(n)throw Error(`Строка ${e.length}: ожидалось ${n.expect}`);return Oc(i,r,s)}class Ss extends SyntaxError{constructor(t,r,s,i){super(t),this.expected=r,this.found=s,this.location=i,this.name="SyntaxError"}format(t){let r="Error: "+this.message;if(this.location){let s=null;const i=t.find(h=>h.source===this.location.source);i&&(s=i.text.split(/\r\n|\n|\r/g));const n=this.location.start,a=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(n):n,l=this.location.source+":"+a.line+":"+a.column;if(s){const h=this.location.end,d="".padEnd(a.line.toString().length," "),g=s[n.line-1],T=(n.line===h.line?h.column:g.length+1)-n.column||1;r+=`
 --> `+l+`
`+d+` |
`+a.line+" | "+g+`
`+d+" | "+"".padEnd(n.column-1," ")+"".padEnd(T,"^")}else r+=`
 at `+l}return r}static buildMessage(t,r){function s(T){return T.codePointAt(0).toString(16).toUpperCase()}const i=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function n(T){return i?T.replace(i,m=>"\\u{"+s(m)+"}"):T}function a(T){return n(T.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,m=>"\\x0"+s(m)).replace(/[\x10-\x1F\x7F-\x9F]/g,m=>"\\x"+s(m)))}function l(T){return n(T.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,m=>"\\x0"+s(m)).replace(/[\x10-\x1F\x7F-\x9F]/g,m=>"\\x"+s(m)))}const h={literal(T){return'"'+a(T.text)+'"'},class(T){const m=T.parts.map(O=>Array.isArray(O)?l(O[0])+"-"+l(O[1]):l(O));return"["+(T.inverted?"^":"")+m.join("")+"]"+(T.unicode?"u":"")},any(){return"any character"},end(){return"end of input"},other(T){return T.description}};function d(T){return h[T.type](T)}function g(T){const m=T.map(d);if(m.sort(),m.length>0){let O=1;for(let N=1;N<m.length;N++)m[N-1]!==m[N]&&(m[O]=m[N],O++);m.length=O}switch(m.length){case 1:return m[0];case 2:return m[0]+" or "+m[1];default:return m.slice(0,-1).join(", ")+", or "+m[m.length-1]}}function E(T){return T?'"'+a(T)+'"':"end of input"}return"Expected "+g(t)+" but "+E(r)+" found."}}function Sc(e,t){t=t!==void 0?t:{};const r={},s=t.grammarSource,i={Code:Mn};let n=Mn;const a=",",l="(",h=")",d="~",g=">=",E=">",T="<=",m="<",O="==",N="!=",y="&&",P="&",C="||",L="|",W=":=",F="::=",G="=",D="?",x="if",j="while",Z="until",Q="case",ue="else",le="endif",J="break",We="endwhile",Ue="do",Ve="endswitch",nt="switch",ot="default",Rt="function",Xe="return",ct="handle",at="string",lt="float",$r="colorref",jr="integer",rO="local",sO="nosave",iO="parameter",nO=".",oO="#",en="'",tn='"',cO=/^[!\-]/,aO=/^[%*-+\-\/\^]/,rn=/^[_a-z\u0430-\u044F0-9]/i,qt=/^[0-9]/,lO=/^[eE]/,hO=/^[+\-]/,sn=/^[^']/,nn=/^[^"]/,uO=/^[ \t]/,dO=/^[\n;]/,on=/^[ \t\n\r]/,cn=te("variable name"),Ye=q(",",!1),fO=te("function call"),Hr=q("(",!1),Zt=q(")",!1),gO=we(["!","-"],!1,!1,!1),pO=te("!<operand> or -<operand>"),_O=te("(<expression>)"),EO=te("operand"),mO=q("~",!1),TO=we(["%",["*","+"],"-","/","^"],!1,!1,!1),wO=q(">=",!1),yO=q(">",!1),bO=q("<=",!1),RO=q("<",!1),OO=q("==",!1),MO=q("!=",!1),SO=q("&&",!1),NO=q("&",!1),IO=q("||",!1),AO=q("|",!1),vO=te("expression"),xO=te("assignment operator"),PO=q(":=",!1),DO=q("::=",!1),kO=te("equality operator"),an=q("=",!1),LO=te("immediately equation result"),ln=q("?",!1),CO=te("deferred equation result"),GO=te("function call chain"),hn=te("( <expression> )"),BO=te("if(<condition>)"),FO=q("if",!0),WO=te("while(<condition>)"),UO=q("while",!0),VO=te("until(<condition>)"),$O=q("until",!0),jO=te("case(<condition>)"),HO=q("case",!0),XO=q("else",!0),YO=q("endif",!0),zO=q("break",!0),KO=q("endwhile",!0),qO=q("do",!0),ZO=q("endswitch",!0),JO=q("switch",!0),QO=q("default",!0),eM=q("function",!0),tM=te("return <var name>"),rM=q("return",!0),sM=q("HANDLE",!0),iM=q("STRING",!0),nM=q("FLOAT",!0),oM=q("COLORREF",!0),cM=q("INTEGER",!0),aM=q("LOCAL",!0),lM=q("NOSAVE",!0),hM=q("PARAMETER",!0),un=we(["_",["a","z"],["а","я"],["0","9"]],!1,!0,!1),uM=te("function name"),Jt=we([["0","9"]],!1,!1,!1),dM=q(".",!1),fM=we(["e","E"],!1,!1,!1),gM=we(["+","-"],!1,!1,!1),pM=te("float"),_M=te("handle"),EM=q("#",!1),dn=q("'",!1),fn=we(["'"],!0,!1,!1),gn=q('"',!1),pn=we(['"'],!0,!1,!1),mM=te("space or tab"),TM=we([" ","	"],!1,!1,!1),wM=te("new line"),yM=we([`
`,";"],!1,!1,!1),_n=we([" ","	",`
`,"\r"],!1,!1,!1);function En(u){return{code:u,line:cS().start.line}}function bM(u){return u.filter(f=>f.code)}function RM(u){return{type:"var",name:u}}function lN(u){return u}function OM(u,f){return{type:"call",name:u,args:f}}function MM(u,f){return{type:u,op:f}}function SM(u){return{type:"subexpr",expr:u}}function NM(u,f){return{...f,isNew:!!u}}function mn(u,f,w){return{action:f,operand:w}}function IM(u,f){return{first:u,rest:f}}function Tn(u,f){return f}function AM(u,f){return[u].concat(f)}function wn(u,f){return f}function vM(u,f,w){return{type:"varsDec",datatype:u,modifiers:f,names:w}}function xM(u,f,w){return{type:f,to:u,expr:w}}function PM(u,f,w){return{type:f,lhs:u,rhs:w}}function yn(u,f){return f}function DM(u,f){return{type:"eqResult",deferred:!1,vars:[u].concat(f)}}function bn(u,f){return f}function kM(u,f){return{type:"eqResult",deferred:!0,vars:[u].concat(f)}}function Rn(u,f){return f}function LM(u,f){return{type:"callChain",functions:[u].concat(f)}}function hN(u){return u}function uN(u){return u}function dN(u){return u}function CM(u){return{type:"if",expr:u}}function GM(u){return{type:"while",expr:u}}function BM(u){return{type:"until",expr:u}}function FM(u,f){return{type:"case",expr:u,then:f}}function WM(u){return{type:"else",then:u}}function UM(u){return{type:"endif",then:u}}function VM(){return{type:"break"}}function $M(){return{type:"endwhile"}}function jM(){return{type:"do"}}function HM(){return{type:"endswitch"}}function XM(){return{type:"switch"}}function YM(u){return{type:"default",then:u}}function zM(){return{type:"function"}}function KM(u){return{type:"return",to:u}}function qM(){return"HANDLE"}function ZM(){return"STRING"}function JM(){return"FLOAT"}function QM(){return"COLORREF"}function eS(){return"INTEGER"}function tS(){return"LOCAL"}function rS(){return"NOSAVE"}function sS(){return"PARAMETER"}function iS(u){return{type:"float",value:u}}function nS(u){return{type:"handle",value:u.length>0?u:"0"}}function oS(u){return{type:"string",value:u[1]}}let p=t.peg$currPos|0,H=p;const ht=[{line:1,column:1}];let Te=p,Qt=t.peg$maxFailExpected||[],M=t.peg$silentFails|0,Ot;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=i[t.startRule]}function cS(){return Xr(H,p)}function aS(u=p){const f=e.codePointAt(u);return f===void 0?"":String.fromCodePoint(f)}function q(u,f){return{type:"literal",text:u,ignoreCase:f}}function we(u,f,w,R){return{type:"class",parts:u,inverted:f,ignoreCase:w,unicode:R}}function lS(){return{type:"end"}}function te(u){return{type:"other",description:u}}function On(u){let f=ht[u],w;if(f)return f;if(u>=ht.length)w=ht.length-1;else for(w=u;!ht[--w];);for(f=ht[w],f={line:f.line,column:f.column};w<u;)e.charCodeAt(w)===10?(f.line++,f.column=1):f.column++,w++;return ht[u]=f,f}function Xr(u,f,w){const R=On(u),S=On(f);return{source:s,start:{offset:u,line:R.line,column:R.column},end:{offset:f,line:S.line,column:S.column}}}function k(u){p<Te||(p>Te&&(Te=p,Qt=[]),Qt.push(u))}function hS(u,f,w){return new Ss(Ss.buildMessage(u,f),u,f,w)}function Mn(){let u,f,w,R,S,A,Y;for(u=p,f=[],w=p,R=[],S=V();S!==r;)R.push(S),S=V();for(S=Yr(),S===r&&(S=null),A=[],Y=V();Y!==r;)A.push(Y),Y=V();for(Y=An(),Y!==r?(H=w,w=En(S)):(p=w,w=r);w!==r;){for(f.push(w),w=p,R=[],S=V();S!==r;)R.push(S),S=V();for(S=Yr(),S===r&&(S=null),A=[],Y=V();Y!==r;)A.push(Y),Y=V();Y=An(),Y!==r?(H=w,w=En(S)):(p=w,w=r)}return H=u,f=bM(f),u=f,u}function uS(){let u,f;return M++,u=p,f=pe(),f!==r&&(H=u,f=RM(f)),u=f,M--,u===r&&(f=r,M===0&&k(cn)),u}function Sn(){let u,f,w,R,S;for(u=p,f=[],w=V();w!==r;)f.push(w),w=V();if(w=ze(),w!==r){for(R=[],S=V();S!==r;)R.push(S),S=V();e.charCodeAt(p)===44?(S=a,p++):(S=r,M===0&&k(Ye)),S===r&&(S=null),H=u,u=w}else p=u,u=r;return u}function er(){let u,f,w,R,S,A,Y,z;if(M++,u=p,f=FS(),f!==r){for(w=[],R=V();R!==r;)w.push(R),R=V();if(e.charCodeAt(p)===40?(R=l,p++):(R=r,M===0&&k(Hr)),R!==r){for(S=[],A=V();A!==r;)S.push(A),A=V();for(A=[],Y=Sn();Y!==r;)A.push(Y),Y=Sn();for(Y=[],z=V();z!==r;)Y.push(z),z=V();e.charCodeAt(p)===41?(z=h,p++):(z=r,M===0&&k(Zt)),z!==r?(H=u,u=OM(f,A)):(p=u,u=r)}else p=u,u=r}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(fO)),u}function dS(){let u;return u=e.charAt(p),cO.test(u)?p++:(u=r,M===0&&k(gO)),u}function fS(){let u,f,w,R;if(M++,u=p,f=dS(),f!==r){for(w=[],R=V();R!==r;)w.push(R),R=V();R=tr(),R!==r?(H=u,u=MM(f,R)):(p=u,u=r)}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(pO)),u}function gS(){let u,f,w,R,S,A;if(M++,u=p,e.charCodeAt(p)===40?(f=l,p++):(f=r,M===0&&k(Hr)),f!==r){for(w=[],R=V();R!==r;)w.push(R),R=V();if(R=ze(),R!==r){for(S=[],A=V();A!==r;)S.push(A),A=V();e.charCodeAt(p)===41?(A=h,p++):(A=r,M===0&&k(Zt)),A!==r?(H=u,u=SM(R)):(p=u,u=r)}else p=u,u=r}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(_O)),u}function tr(){let u,f,w,R;for(M++,u=p,e.charCodeAt(p)===126?(f=d,p++):(f=r,M===0&&k(mO)),f===r&&(f=null),w=[],R=V();R!==r;)w.push(R),R=V();return R=fS(),R===r&&(R=VS(),R===r&&(R=$S(),R===r&&(R=jS(),R===r&&(R=er(),R===r&&(R=uS(),R===r&&(R=gS())))))),R!==r?(H=u,u=NM(f,R)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(EO)),u}function Nn(){let u;return u=e.charAt(p),aO.test(u)?p++:(u=r,M===0&&k(TO)),u===r&&(e.substr(p,2)===g?(u=g,p+=2):(u=r,M===0&&k(wO)),u===r&&(e.charCodeAt(p)===62?(u=E,p++):(u=r,M===0&&k(yO)),u===r&&(e.substr(p,2)===T?(u=T,p+=2):(u=r,M===0&&k(bO)),u===r&&(e.charCodeAt(p)===60?(u=m,p++):(u=r,M===0&&k(RO)),u===r&&(e.substr(p,2)===O?(u=O,p+=2):(u=r,M===0&&k(OO)),u===r&&(e.substr(p,2)===N?(u=N,p+=2):(u=r,M===0&&k(MO)),u===r&&(e.substr(p,2)===y?(u=y,p+=2):(u=r,M===0&&k(SO)),u===r&&(e.charCodeAt(p)===38?(u=P,p++):(u=r,M===0&&k(NO)),u===r&&(e.substr(p,2)===C?(u=C,p+=2):(u=r,M===0&&k(IO)),u===r&&(e.charCodeAt(p)===124?(u=L,p++):(u=r,M===0&&k(AO)))))))))))),u}function ze(){let u,f,w,R,S,A,Y,z;if(M++,u=p,f=tr(),f!==r){for(w=[],R=p,S=[],A=V();A!==r;)S.push(A),A=V();if(A=Nn(),A!==r){for(Y=[],z=V();z!==r;)Y.push(z),z=V();z=tr(),z!==r?(H=R,R=mn(f,A,z)):(p=R,R=r)}else p=R,R=r;for(;R!==r;){for(w.push(R),R=p,S=[],A=V();A!==r;)S.push(A),A=V();if(A=Nn(),A!==r){for(Y=[],z=V();z!==r;)Y.push(z),z=V();z=tr(),z!==r?(H=R,R=mn(f,A,z)):(p=R,R=r)}else p=R,R=r}H=u,u=IM(f,w)}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(vO)),u}function pS(){let u,f,w,R,S,A;if(u=p,f=pe(),f!==r){for(w=[],R=p,ce(),e.charCodeAt(p)===44?(S=a,p++):(S=r,M===0&&k(Ye)),S!==r?(ce(),A=pe(),A!==r?(H=R,R=Tn(f,A)):(p=R,R=r)):(p=R,R=r);R!==r;)w.push(R),R=p,ce(),e.charCodeAt(p)===44?(S=a,p++):(S=r,M===0&&k(Ye)),S!==r?(ce(),A=pe(),A!==r?(H=R,R=Tn(f,A)):(p=R,R=r)):(p=R,R=r);H=u,u=AM(f,w)}else p=u,u=r;return u}function _S(){let u,f,w,R,S,A,Y,z,Se;if(u=p,f=BS(),f!==r){if(w=[],R=V(),R!==r)for(;R!==r;)w.push(R),R=V();else w=r;if(w!==r){if(R=ce(),S=[],A=p,Y=In(),Y!==r){if(z=[],Se=V(),Se!==r)for(;Se!==r;)z.push(Se),Se=V();else z=r;z!==r?(H=A,A=wn(f,Y)):(p=A,A=r)}else p=A,A=r;for(;A!==r;)if(S.push(A),A=p,Y=In(),Y!==r){if(z=[],Se=V(),Se!==r)for(;Se!==r;)z.push(Se),Se=V();else z=r;z!==r?(H=A,A=wn(f,Y)):(p=A,A=r)}else p=A,A=r;A=pS(),A!==r?(H=u,u=vM(f,S,A)):(p=u,u=r)}else p=u,u=r}else p=u,u=r;return u}function ES(){let u,f,w,R,S;if(M++,u=p,f=pe(),f!==r)if(ce(),e.substr(p,2)===W?(w=W,p+=2):(w=r,M===0&&k(PO)),w===r&&(e.substr(p,3)===F?(w=F,p+=3):(w=r,M===0&&k(DO))),w!==r){for(R=[],S=V();S!==r;)R.push(S),S=V();S=ze(),S!==r?(H=u,u=xM(f,w,S)):(p=u,u=r)}else p=u,u=r;else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(xO)),u}function mS(){let u,f,w,R,S;if(M++,u=p,f=ze(),f!==r)if(ce(),e.charCodeAt(p)===61?(w=G,p++):(w=r,M===0&&k(an)),w!==r){for(R=[],S=V();S!==r;)R.push(S),S=V();S=ze(),S!==r?(H=u,u=PM(f,w,S)):(p=u,u=r)}else p=u,u=r;else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(kO)),u}function TS(){let u,f,w,R,S,A,Y,z;if(M++,u=p,f=pe(),f!==r){for(w=[],R=p,S=[],A=V();A!==r;)S.push(A),A=V();if(e.charCodeAt(p)===44?(A=a,p++):(A=r,M===0&&k(Ye)),A!==r){for(Y=[],z=V();z!==r;)Y.push(z),z=V();z=pe(),z!==r?(H=R,R=yn(f,z)):(p=R,R=r)}else p=R,R=r;for(;R!==r;){for(w.push(R),R=p,S=[],A=V();A!==r;)S.push(A),A=V();if(e.charCodeAt(p)===44?(A=a,p++):(A=r,M===0&&k(Ye)),A!==r){for(Y=[],z=V();z!==r;)Y.push(z),z=V();z=pe(),z!==r?(H=R,R=yn(f,z)):(p=R,R=r)}else p=R,R=r}for(R=[],S=V();S!==r;)R.push(S),S=V();if(e.charCodeAt(p)===61?(S=G,p++):(S=r,M===0&&k(an)),S!==r){for(A=[],Y=V();Y!==r;)A.push(Y),Y=V();e.charCodeAt(p)===63?(Y=D,p++):(Y=r,M===0&&k(ln)),Y!==r?(H=u,u=DM(f,w)):(p=u,u=r)}else p=u,u=r}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(LO)),u}function wS(){let u,f,w,R,S,A,Y;if(M++,u=p,e.charCodeAt(p)===63?(f=D,p++):(f=r,M===0&&k(ln)),f!==r)if(ce(),w=pe(),w!==r){for(R=[],S=p,ce(),e.charCodeAt(p)===44?(A=a,p++):(A=r,M===0&&k(Ye)),A!==r?(ce(),Y=pe(),Y!==r?(H=S,S=bn(w,Y)):(p=S,S=r)):(p=S,S=r);S!==r;)R.push(S),S=p,ce(),e.charCodeAt(p)===44?(A=a,p++):(A=r,M===0&&k(Ye)),A!==r?(ce(),Y=pe(),Y!==r?(H=S,S=bn(w,Y)):(p=S,S=r)):(p=S,S=r);H=u,u=kM(w,R)}else p=u,u=r;else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(CO)),u}function yS(){let u,f,w,R,S,A;if(M++,u=p,f=er(),f!==r){if(w=[],R=p,S=[],A=V(),A!==r)for(;A!==r;)S.push(A),A=V();else S=r;for(S!==r?(A=er(),A!==r?(H=R,R=Rn(f,A)):(p=R,R=r)):(p=R,R=r);R!==r;){if(w.push(R),R=p,S=[],A=V(),A!==r)for(;A!==r;)S.push(A),A=V();else S=r;S!==r?(A=er(),A!==r?(H=R,R=Rn(f,A)):(p=R,R=r)):(p=R,R=r)}H=u,u=LM(f,w)}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(GO)),u}function bS(){let u,f,w,R,S,A;if(M++,u=p,e.charCodeAt(p)===40?(f=l,p++):(f=r,M===0&&k(Hr)),f!==r){for(w=[],R=V();R!==r;)w.push(R),R=V();if(R=ze(),R!==r){for(S=[],A=V();A!==r;)S.push(A),A=V();e.charCodeAt(p)===41?(A=h,p++):(A=r,M===0&&k(Zt)),A!==r?(H=u,u=R):(p=u,u=r)}else p=u,u=r}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(hn)),u}function RS(){let u,f,w,R,S;for(M++,u=p,f=[],w=V();w!==r;)f.push(w),w=V();if(w=ze(),w!==r){for(R=[],S=V();S!==r;)R.push(S),S=V();e.charCodeAt(p)===41?(S=h,p++):(S=r,M===0&&k(Zt)),S!==r?(H=u,u=w):(p=u,u=r)}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(hn)),u}function rr(){let u;return u=bS(),u===r&&(u=RS()),u}function sr(){let u,f,w;if(u=p,f=[],w=V(),w!==r)for(;w!==r;)f.push(w),w=V();else f=r;return f!==r?(w=Yr(),w!==r?(H=u,u=w):(p=u,u=r)):(p=u,u=r),u}function OS(){let u,f,w;return M++,u=p,f=e.substr(p,2),f.toLowerCase()===x?p+=2:(f=r,M===0&&k(FO)),f!==r?(ce(),w=rr(),w!==r?(H=u,u=CM(w)):(p=u,u=r)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(BO)),u}function MS(){let u,f,w;return M++,u=p,f=e.substr(p,5),f.toLowerCase()===j?p+=5:(f=r,M===0&&k(UO)),f!==r?(ce(),w=rr(),w!==r?(H=u,u=GM(w)):(p=u,u=r)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(WO)),u}function SS(){let u,f,w;return M++,u=p,f=e.substr(p,5),f.toLowerCase()===Z?p+=5:(f=r,M===0&&k($O)),f!==r?(ce(),w=rr(),w!==r?(H=u,u=BM(w)):(p=u,u=r)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(VO)),u}function NS(){let u,f,w,R;return M++,u=p,f=e.substr(p,4),f.toLowerCase()===Q?p+=4:(f=r,M===0&&k(HO)),f!==r?(ce(),w=rr(),w!==r?(R=sr(),R===r&&(R=null),H=u,u=FM(w,R)):(p=u,u=r)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(jO)),u}function IS(){let u,f,w;return u=p,f=e.substr(p,4),f.toLowerCase()===ue?p+=4:(f=r,M===0&&k(XO)),f!==r?(w=sr(),w===r&&(w=null),H=u,u=WM(w)):(p=u,u=r),u}function AS(){let u,f,w;return u=p,f=e.substr(p,5),f.toLowerCase()===le?p+=5:(f=r,M===0&&k(YO)),f!==r?(w=sr(),w===r&&(w=null),H=u,u=UM(w)):(p=u,u=r),u}function vS(){let u,f;return u=p,f=e.substr(p,5),f.toLowerCase()===J?p+=5:(f=r,M===0&&k(zO)),f!==r&&(H=u,f=VM()),u=f,u}function xS(){let u,f;return u=p,f=e.substr(p,8),f.toLowerCase()===We?p+=8:(f=r,M===0&&k(KO)),f!==r&&(H=u,f=$M()),u=f,u}function PS(){let u,f;return u=p,f=e.substr(p,2),f.toLowerCase()===Ue?p+=2:(f=r,M===0&&k(qO)),f!==r&&(H=u,f=jM()),u=f,u}function DS(){let u,f;return u=p,f=e.substr(p,9),f.toLowerCase()===Ve?p+=9:(f=r,M===0&&k(ZO)),f!==r&&(H=u,f=HM()),u=f,u}function kS(){let u,f;return u=p,f=e.substr(p,6),f.toLowerCase()===nt?p+=6:(f=r,M===0&&k(JO)),f!==r&&(H=u,f=XM()),u=f,u}function LS(){let u,f,w;return u=p,f=e.substr(p,7),f.toLowerCase()===ot?p+=7:(f=r,M===0&&k(QO)),f!==r?(w=sr(),w===r&&(w=null),H=u,u=YM(w)):(p=u,u=r),u}function CS(){let u,f;return u=p,f=e.substr(p,8),f.toLowerCase()===Rt?p+=8:(f=r,M===0&&k(eM)),f!==r&&(H=u,f=zM()),u=f,u}function GS(){let u,f,w;return M++,u=p,f=e.substr(p,6),f.toLowerCase()===Xe?p+=6:(f=r,M===0&&k(rM)),f!==r?(ce(),w=pe(),w!==r?(H=u,u=KM(w)):(p=u,u=r)):(p=u,u=r),M--,u===r&&(f=r,M===0&&k(tM)),u}function Yr(){let u;return u=_S(),u===r&&(u=ES(),u===r&&(u=mS(),u===r&&(u=TS(),u===r&&(u=wS(),u===r&&(u=OS(),u===r&&(u=IS(),u===r&&(u=AS(),u===r&&(u=vS(),u===r&&(u=MS(),u===r&&(u=xS(),u===r&&(u=PS(),u===r&&(u=SS(),u===r&&(u=DS(),u===r&&(u=kS(),u===r&&(u=NS(),u===r&&(u=LS(),u===r&&(u=yS(),u===r&&(u=CS(),u===r&&(u=GS()))))))))))))))))))),u}function BS(){let u,f;return u=p,f=e.substr(p,6),f.toLowerCase()===ct?p+=6:(f=r,M===0&&k(sM)),f!==r&&(H=u,f=qM()),u=f,u===r&&(u=p,f=e.substr(p,6),f.toLowerCase()===at?p+=6:(f=r,M===0&&k(iM)),f!==r&&(H=u,f=ZM()),u=f,u===r&&(u=p,f=e.substr(p,5),f.toLowerCase()===lt?p+=5:(f=r,M===0&&k(nM)),f!==r&&(H=u,f=JM()),u=f,u===r&&(u=p,f=e.substr(p,8),f.toLowerCase()===$r?p+=8:(f=r,M===0&&k(oM)),f!==r&&(H=u,f=QM()),u=f,u===r&&(u=p,f=e.substr(p,7),f.toLowerCase()===jr?p+=7:(f=r,M===0&&k(cM)),f!==r&&(H=u,f=eS()),u=f)))),u}function In(){let u,f;return u=p,f=e.substr(p,5),f.toLowerCase()===rO?p+=5:(f=r,M===0&&k(aM)),f!==r&&(H=u,f=tS()),u=f,u===r&&(u=p,f=e.substr(p,6),f.toLowerCase()===sO?p+=6:(f=r,M===0&&k(lM)),f!==r&&(H=u,f=rS()),u=f,u===r&&(u=p,f=e.substr(p,9),f.toLowerCase()===iO?p+=9:(f=r,M===0&&k(hM)),f!==r&&(H=u,f=sS()),u=f)),u}function pe(){let u,f,w;if(M++,u=p,f=[],w=e.charAt(p),rn.test(w)?p++:(w=r,M===0&&k(un)),w!==r)for(;w!==r;)f.push(w),w=e.charAt(p),rn.test(w)?p++:(w=r,M===0&&k(un));else f=r;return f!==r?u=e.substring(u,p):u=f,M--,u===r&&(f=r,M===0&&k(cn)),u}function FS(){let u;return M++,u=pe(),M--,u===r&&M===0&&k(uM),u}function zr(){let u,f;if(u=[],f=e.charAt(p),qt.test(f)?p++:(f=r,M===0&&k(Jt)),f!==r)for(;f!==r;)u.push(f),f=e.charAt(p),qt.test(f)?p++:(f=r,M===0&&k(Jt));else u=r;return u}function WS(){let u,f,w;return u=p,e.charCodeAt(p)===46?(f=nO,p++):(f=r,M===0&&k(dM)),f!==r?(w=zr(),w!==r?(f=[f,w],u=f):(p=u,u=r)):(p=u,u=r),u}function US(){let u,f,w,R;return u=p,f=e.charAt(p),lO.test(f)?p++:(f=r,M===0&&k(fM)),f!==r?(w=e.charAt(p),hO.test(w)?p++:(w=r,M===0&&k(gM)),w===r&&(w=null),R=zr(),R!==r?(f=[f,w,R],u=f):(p=u,u=r)):(p=u,u=r),u}function VS(){let u,f,w,R,S,A;return M++,u=p,f=p,w=p,R=zr(),R!==r?(S=WS(),S===r&&(S=null),A=US(),A===r&&(A=null),R=[R,S,A],w=R):(p=w,w=r),w!==r?f=e.substring(f,p):f=w,f!==r&&(H=u,f=iS(f)),u=f,M--,u===r&&(f=r,M===0&&k(pM)),u}function $S(){let u,f,w,R,S;if(M++,u=p,e.charCodeAt(p)===35?(f=oO,p++):(f=r,M===0&&k(EM)),f!==r){for(w=p,R=[],S=e.charAt(p),qt.test(S)?p++:(S=r,M===0&&k(Jt));S!==r;)R.push(S),S=e.charAt(p),qt.test(S)?p++:(S=r,M===0&&k(Jt));w=e.substring(w,p),H=u,u=nS(w)}else p=u,u=r;return M--,u===r&&(f=r,M===0&&k(_M)),u}function jS(){let u,f,w,R,S,A;if(u=p,f=p,e.charCodeAt(p)===39?(w=en,p++):(w=r,M===0&&k(dn)),w!==r){for(R=p,S=[],A=e.charAt(p),sn.test(A)?p++:(A=r,M===0&&k(fn));A!==r;)S.push(A),A=e.charAt(p),sn.test(A)?p++:(A=r,M===0&&k(fn));R=e.substring(R,p),e.charCodeAt(p)===39?(S=en,p++):(S=r,M===0&&k(dn)),S!==r?(w=[w,R,S],f=w):(p=f,f=r)}else p=f,f=r;if(f===r)if(f=p,e.charCodeAt(p)===34?(w=tn,p++):(w=r,M===0&&k(gn)),w!==r){for(R=p,S=[],A=e.charAt(p),nn.test(A)?p++:(A=r,M===0&&k(pn));A!==r;)S.push(A),A=e.charAt(p),nn.test(A)?p++:(A=r,M===0&&k(pn));R=e.substring(R,p),e.charCodeAt(p)===34?(S=tn,p++):(S=r,M===0&&k(gn)),S!==r?(w=[w,R,S],f=w):(p=f,f=r)}else p=f,f=r;return f!==r&&(H=u,f=oS(f)),u=f,u}function V(){let u;return M++,u=e.charAt(p),uO.test(u)?p++:(u=r,M===0&&k(TM)),M--,u===r&&M===0&&k(mM),u}function An(){let u;return M++,u=e.charAt(p),dO.test(u)?p++:(u=r,M===0&&k(yM)),M--,u===r&&M===0&&k(wM),u}function ce(){let u,f;for(M++,u=[],f=e.charAt(p),on.test(f)?p++:(f=r,M===0&&k(_n));f!==r;)u.push(f),f=e.charAt(p),on.test(f)?p++:(f=r,M===0&&k(_n));return M--,u}Ot=n();const Kr=Ot!==r&&p===e.length;function vn(){throw Ot!==r&&p<e.length&&k(lS()),hS(Qt,Te<e.length?aS(Te):null,Te<e.length?Xr(Te,Te+1):Xr(Te,Te))}if(t.peg$library)return{peg$result:Ot,peg$currPos:p,peg$FAILED:r,peg$maxFailExpected:Qt,peg$maxFailPos:Te,peg$success:Kr,peg$throw:Kr?void 0:vn};if(Kr)return Ot;vn()}const pr="'",_r='"';function Nc(e){let t="",r=null;for(let s=0;s<e.length;++s){const i=e[s];if(i===pr&&r!==_r?r=r?null:pr:i===_r&&r!==pr&&(r=r?null:_r),r){t+=i;continue}if(i==="/"){const n=e[s+1];if(n==="*"){for(s+=2,t+="  ";s<e.length&&(e[s]!=="*"||e[s+1]!=="/");)++s,t+=e[s]===`
`?`
`:" ";t+=" ",++s;continue}if(n==="/"){for(++s,t+=" ";s<e.length&&e[++s]!==`
`;)t+=" ";t[t.length-1]!==`
`&&(t+=`
`);continue}}if(i==="\r"){e[s+1]===`
`&&(++s,t+=" "),t[t.length-1]!==`
`&&(t+=`
`);continue}t+=i}return t[t.length-1]===`
`?t:t+`
`}class Lt extends Error{constructor(t){super(t.join(`
`)),this.errors=t}format(t=`
`){return this.errors.join(t)}}function Ic(e,t){let r;try{r=Sc(e)}catch(s){if(!(s instanceof Error))throw s;const i=s.location.start,n=`Строка ${i.line} столбец ${i.column}: ${s.message}`;throw new Lt([n])}try{return Mc(r,t)}catch(s){throw s instanceof Error?new Lt([s.message]):s}}function Ac(e,t){let r;try{r=Nc(e)}catch(s){throw s instanceof Error?new Lt([s.message]):s}return Ic(r,t)}const vc={[B.FLOAT]:"F",[B.STRING]:"S",[B.HANDLE]:"H",[B.COLORREF]:"C",[Ie.FLOAT_REF]:"G",[Ie.STRING_REF]:"T",[Ie.HANDLE_REF]:"I",[Ie.COLORREF_REF]:"D"};function xc(e){return e.map(t=>vc[t]).join("")}const Er=[],Pc=function*(){}.constructor;class Dc{constructor(){this.m=new Map}addFunc(t,r){const s=r.a||Er,i=r.rest||Er,n=s.concat(i),a=t.toUpperCase();let l=this.m.get(a);if(!l)this.m.set(a,l=[]);else{const d=ye-1;if(l.some(g=>{const E=g.argTypes.concat(g.type==="plugin"?g.restArgsTypes:Er);return E.length===n.length&&E.every((T,m)=>(T&d)===(n[m]&d))}))throw Error(`Функция '${t}' с аргументами '${s}' уже существует`)}const h="$"+t+(s.length?"$"+xc(n):"");return l.push({type:"plugin",kind:r.kind||"sync",path:h,argTypes:s,restArgsTypes:i,retType:r.r||null}),h}addUserFunc(t){const r=t.name.toUpperCase(),s=this.m.get(r);if(!s)return this.m.set(r,[t]),!0;const i=ye-1;return s.some(n=>n.argTypes.length===t.argTypes.length&&n.argTypes.every((a,l)=>(a&i)===t.argTypes[l]))?!1:(s.push(t),!0)}transpile(t,r,s){return Ac(t,{funcTable:this.m,sourceURL:r,comment:s})}compile(t){return new Function("g","schema","memory",t)}compileGenerator(t){return new Pc("g","schema","memory",t)}}function kc(e,t){switch(e){case B.FLOAT:return Xn(t).toString();case B.STRING:return t;case B.HANDLE:return"#"+t;case B.COLORREF:return Dn(t)}}function Ns(e,t){switch(e){case B.FLOAT:{const r=parseFloat(t.replace(",","."));if(!isNaN(r))return r;const s=v[t.toUpperCase()];return typeof s=="number"?s:null}case B.HANDLE:return Lc(t);case B.STRING:return t;case B.COLORREF:return Pn(t)}}function Lc(e){return(e.startsWith("#")?parseInt(e.slice(1)):parseInt(e))||0}class Cc{constructor(t,r){this.id=t,this.attrib=0,this.description="",this.defaultValue=null,this.inEquation=!1,this.parsed=null,this.name=r.name,this.type=r.type,this.set(r)}set({attrib:t=this.attrib,defaultValue:r=this.defaultValue,description:s=this.description,inEquation:i=this.inEquation}){return this.parsed=r!==null?Ns(this.type,r):null,this.attrib=t,this.defaultValue=r,this.description=s,this.inEquation=i,this}}class Is{constructor(t){this._disable=null,this._enable=null,this.orgx=null,this.orgy=null,this._hobject=null,this._objname=null,this._classname=null,this.msg=null,this.xpos=null,this.ypos=null,this.fwkeys=null,this.wvkey=null,this.repeat=null,this.scancode=null,this.nwidth=null,this.nheight=null,this._hspace=null,this._windowName=null,this.iditem=null,this.wnotifycode=null;const r=t?.map((s,i)=>[s.name.toUpperCase(),new Cc(i,s)]);if(this.list=r?.map(s=>s[1])??[],this.m=new Map(r),!!r)for(const[s,i]of r){const n=i.type,{FLOAT:a,STRING:l,HANDLE:h}=B;s==="_ENABLE"&&n===a?this._enable=i:s==="_DISABLE"&&n===a?this._disable=i:s==="MSG"&&n===a?this.msg=i:s==="_HOBJECT"&&n===h?this._hobject=i:s==="IDITEM"&&n===a?this.iditem=i:s==="WNOTIFYCODE"&&n===a?this.wnotifycode=i:s==="NWIDTH"&&n===a?this.nwidth=i:s==="NHEIGHT"&&n===a?this.nheight=i:s==="XPOS"&&n===a?this.xpos=i:s==="YPOS"&&n===a?this.ypos=i:s==="FWKEYS"&&n===a?this.fwkeys=i:s==="ORGX"&&n===a?this.orgx=i:s==="ORGY"&&n===a?this.orgy=i:s==="_OBJNAME"&&n===l?this._objname=i:s==="_CLASSNAME"&&n===l?this._classname=i:s==="WVKEY"&&n===a?this.wvkey=i:s==="REPEAT"&&n===a?this.repeat=i:s==="SCANCODE"&&n===a?this.scancode=i:s==="_HSPACE"&&n===h?this._hspace=i:s==="_WINDOWNAME"&&n===l&&(this._windowName=i)}}get(t){return this.m.get(t.toUpperCase())??null}}class Gc{constructor({compiler:t,data:r,file:s,projectId:i,modelGlobals:n}){this.onChildrenChanged=new Ee,this.main=null,this.defers=[],this.equations=[],this.transpiledCode=null,this.isCompiled=!1;const{name:a,transpiled:l,id:h,vars:d}=r;this.projectId=i,this.compiler=t,this.modelGlobals=n,this.file=s,this.name=a,this.nameUC=a.toUpperCase(),this.vars=new Is(d),this.transpiledCode=l??null,this.id=h,this.children=r.children||[],this.connections=r.links||[],this.scene=r.scene||null,this.image=r.image||null,this.modelText=r.modelText||"",this.isFunction=r.isFunction||!1}set({vars:t,children:r=this.children,links:s=this.connections,scene:i=this.scene,image:n=this.image,modelText:a=this.modelText,isFunction:l=this.isFunction}){return t&&(this.vars=new Is(t)),this.modelText!==a&&(this.isCompiled=!1),this.children!==r&&(this.children=r,this.onChildrenChanged.dispatch(r)),this.connections=s,this.scene=i,this.image=n,this.modelText=a,this.isFunction=l,this}compile(){if(this.isCompiled)return;this.isCompiled=!0;let t;const{compiler:r}=this;if(this.transpiledCode)re.debugCompiler&&console.log(`Компиляция (кешировано) ${this.name} (${this.vars.list.length} переменных)`),t=this.transpiledCode,this.transpiledCode=null;else{const i=this.file.path.toString().slice(3);re.debugCompiler&&console.log(`Компиляция '${this.name}' ('${i}'): ${this.vars.list.length} переменных`);try{const n=r.transpile(this.modelText,this.name,i);re.debugCompiler&&n.bugs.length&&console.warn(`${this.name}:
${n.bugs.map(([h])=>` -${h}`).join(`
`)}`);const a=this.vars,l=n.vars.map(h=>{const d=a.get(h.name);if(!d)return h;const{defaultValue:g,description:E}=d;return{...h,defaultValue:g,description:E}});this.set({vars:l,isFunction:n.isFunction}),t=n}catch(n){throw n instanceof Lt?Error(`Ошибка компиляции '${this.name}' ('${i}'): '${n.message}'`):n}}const{modelGlobals:s}=this;this.main=t.mainText?r.compileGenerator(t.mainText).bind(null,s):null,this.defers=t.defersTexts?.map(i=>r.compile(i).bind(null,s))||[],this.equations=t.equationsTexts?.map(i=>r.compile(i).bind(null,s))||[]}getUserFunctionSignature(){const t=this.vars.list;return{type:"user",name:this.name,argTypes:t.filter(r=>r.attrib&v.VF_ARGUMENT).map(r=>r.type),retType:t.find(r=>r.attrib&v.VF_RETURN)?.type??null}}}class Bc{constructor(){this.files=new WeakSet,this.m=new Map}add(t){const{nameUC:r}=t,s=this.m.get(r);if(s)throw Error(`Конфликт имен имиджей: '${t.name}' ('${t.file.path}') уже существует в файле '${s.file.path}'`);return this.m.set(r,t),this.files.add(t.file),this}get(t){return this.m.get(t.toUpperCase())??null}hasFile(t){return this.files.has(t)}unload(t){this.m.forEach(r=>r.projectId===t&&this.files.delete(r.file)),this.m=new Map(hs(this.m,r=>r[1].projectId!==t))}}class Fc{alloc(t){const r=new Float64Array(t.floats),s=new Int32Array(t.ints),i=Array.from({length:t.strings},()=>"");this.newFloats=r,this.oldFloats=r.slice(),this.newInts=s,this.oldInts=s.slice(),this.newStrings=i,this.oldStrings=i.slice()}sync(){this.oldFloats.set(this.newFloats),this.oldInts.set(this.newInts);const{newStrings:t,oldStrings:r}=this;for(let s=0;s<t.length;++s)r[s]=t[s]}}class Wc{constructor(t){this.newFloats=this.oldFloats=new Float64Array(t.floats),this.newInts=this.oldInts=new Int32Array(t.ints),this.newStrings=this.oldStrings=Array.from({length:t.strings},()=>"")}}class As{constructor(t,r){this.map=t,this.values=r}getNewValue(t){const{newFloats:r,newInts:s,newStrings:i}=this.values,n=this.map[t.id];switch(t.type){case B.FLOAT:return r[n];case B.HANDLE:case B.COLORREF:return s[n];case B.STRING:return i[n]}}setValue(t,r){const{newFloats:s,oldFloats:i,newInts:n,oldInts:a,newStrings:l,oldStrings:h}=this.values,d=this.map[t.id];switch(t.type){case B.FLOAT:if(typeof r!="number")return!1;s[d]=i[d]=r;break;case B.HANDLE:case B.COLORREF:if(typeof r!="number")return!1;n[d]=a[d]=r;break;case B.STRING:if(typeof r!="string")return!1;l[d]=h[d]=r;break}return!0}}class vs{constructor(){this.floats=0,this.ints=0,this.strings=0}add(t){switch(t.type){case B.FLOAT:return this.floats++;case B.HANDLE:case B.COLORREF:return this.ints++;case B.STRING:return this.strings++}}}class Uc{constructor(t,r){this.v=t,this.a=r,this.index=-1,this.connected=new Set}propagateIndex(t){this.index>=0||(this.index=t,this.connected.forEach(r=>r.propagateIndex(t)))}connectWith(t){this.connected.add(t),t.connected.add(this)}getIndex(){return this.index<0&&this.propagateIndex(this.a.add(this.v)),this.index}}function Vc(e,t){const{children:r}=e;t.forEach(({nodes:[s,i],vars:n,attrib:a=0})=>{if(a&ic)return;let l=`Имидж ${e.klass.name}: связь #${s}-#${i}: `;const h=s>0?r.find(g=>g.ndata.key===s):e;if(!h){console.warn(l+`Дочерний имидж #${s} не существует`);return}const d=i>0?r.find(g=>g.ndata.key===i):e;if(!d){console.warn(l+`Дочерний имидж #${i} не существует`);return}l=`Имидж ${e.klass.name}: связь #${s} (${h.klass.name}) - #${i} (${d.klass.name}): `,n.forEach(([g,E])=>{const T=h.klass.vars.get(g);if(!T){console.warn(l+`Переменная ${h.klass.name}:${g} не существует`);return}const m=d.klass.vars.get(E);if(!m){console.warn(l+`Переменная ${d.klass.name}:${E} не существует`);return}if(T.type!==m.type){console.warn(l+`Типы переменных ${h.klass.name}:${g} и ${d.klass.name}:${E} не совпадают`);return}h.vars[T.id].connectWith(d.vars[m.id])})})}function xs(e,t,r,s=null){e.compile();const i=e.vars.list.map(l=>new Uc(l,r)),n=e.children.map(l=>{const h=t.get(l.klass);if(!h)throw Error(`Подимидж ${l.klass} #${l.key} имиджа ${e.name} не существует`);return xs(h,t,r,l)}),a={klass:e,ndata:s,vars:i,children:n};return e.connections.length&&Vc(a,e.connections),a}function Ps(e,t,r){const s=e.vars.map(n=>{const a=n.getIndex();return n.v.inEquation&&r.add(a),a}),i=e.children.map(n=>Ps(n,t,r));return t.createSchema({...e,varMap:s,children:i,prj:t})}function $c(){return!1}function jc(e,t){return e.values.newFloats[e.map[t]]>0}function Hc(e,t){return e.values.newFloats[e.map[t]]<=0}const Ds={done:!0,value:void 0};class Xc{constructor(t){this.root=t,this.current=null}nextActiveNode(){let t=this.current;if(!t)return this.current=this.root.getFirstDeepLeftSchema();if(t===this.root)return this.current=null;for(;;){const r=t.nextSibling;if(!r)return this.current=t.parent;if(t=r,!t.isDisabled())return this.current=t.getFirstDeepLeftSchema()}}getCurrentNode(){return this.current}}class Yc{constructor(t){this.curMainIterator=null,this.treeIterator=new Xc(t)}[Symbol.iterator](){return this}throw(t){throw t}return(){throw Error("Генератор был неожиданно остановлен")}next(t){if(this.curMainIterator){const r=this.curMainIterator.next(t);if(!r.done)return r;this.curMainIterator=null}for(;;){const r=this.treeIterator.nextActiveNode();if(!r)return Ds;const s=r.main();if(!s)continue;const i=s.next();if(!i.done)return this.curMainIterator=s,i}}getCurrentNode(){return this.treeIterator.getCurrentNode()}}class zc{constructor(t,r){this.branchIterator=null,this.root=t,this.ignoreDisable=r}[Symbol.iterator](){return this}throw(t){throw t}return(){throw Error("Генератор был неожиданно остановлен")}next(t){if(!this.branchIterator){if(this.setup(),!this.ignoreDisable&&this.root.isDisabled())return this.finalize(),Ds;this.branchIterator=this.root.computeBranch()}const r=this.branchIterator.next(t);return r.done&&this.finalize(),r}setup(){this.root.prj.beforeCompute()}finalize(){const{root:t}=this;t.prj.solveGlobalEquations(),t.computeSchemaDefers(),t.prj.afterCompute()}getCurrentNode(){return this.branchIterator?.getCurrentNode()||null}}const ks=new WeakMap;class Kc{constructor({prj:t,klass:r,ndata:s,vars:i,children:n}){this.nextSibling=null,this.parent=null,this.isDisabled=$c,this.updateChildNodeData=d=>{d.length===this.children.length&&d.forEach((g,E)=>{const T=this.children[E],m=T.ndata;m.key!==g.key||m.klass!==g.klass||(m.name&&this.resolveMap.delete(m.name),g.name&&this.resolveMap.set(g.name.toUpperCase(),T),T.ndata=g)})},this.prj=t,this.klass=r,this.ndata=s,this.vars=i,this.children=n;const{_disable:a,_enable:l}=r.vars;a&&(!l||a.id<l.id)?this.isDisabled=jc.bind(null,this.vars,a.id):l&&(!a||l.id<a.id)&&(this.isDisabled=Hc.bind(null,this.vars,l.id)),this.resolveMap=new Map([["",this]]);let h;for(const d of n){h&&(h.nextSibling=d),h=d,d.parent=this,d.resolveMap.set("..",this);const{key:g,name:E}=d.ndata;this.resolveMap.set("#"+g,d),E&&this.resolveMap.set(E.toUpperCase(),d)}r.onChildrenChanged.add(this.updateChildNodeData)}get kernel(){return this.prj.kernel}resolve(t){if(t.length===0)return this;const r=t.toUpperCase().split("\\");let s=t[0]==="\\"?this.prj.root:this;for(const i of r){const n=s.resolveMap.get(i);if(!n)return null;s=n}return s}resolveMany(t,r){if(t){const s=this.resolve(t);return!s||r&&s.klass!==r?[]:[s]}return r?this.prj.getKlassSchemas(r):[]}initValues(t){this.children.forEach(s=>s.initValues());const{vars:r}=this.klass;return r.list.forEach(s=>{let i;if(s.parsed!==null)i=s.parsed;else switch(s){case r.orgx:i=this.ndata?.x??0;break;case r.orgy:i=this.ndata?.y??0;break;case r._hobject:i=this.ndata?.key??0;break;case r._objname:i=this.ndata?.name??"";break;case r._classname:i=this.klass.name;break;default:if(!t)return;i=s.type===B.STRING?"":0;break}this.vars.setValue(s,i)}),this}applyValues(t){const{values:r,klassId:s}=t;if(r?.length)if(this.klass.id===s){const{vars:i}=this.klass;r.forEach(({name:n,value:a})=>{const l=i.get(n);if(!l)return;const h=Ns(l.type,a);h!==null&&this.vars.setValue(l,h)})}else console.warn(`Пропуск установки stt для ${this.path()} (id ${this.klass.id}): ожидалось id ${s} (${t.klass})`);return t.children?.forEach(i=>this.children.find(n=>n.ndata.key===i.key)?.applyValues(i)),this}getValues(){const{klass:t,ndata:r}=this,s=this.children.map(n=>n.getValues()),i=t.vars.list.map(n=>{const a=kc(n.type,this.vars.getNewValue(n));return{name:n.name,value:a}});return{key:r?.key??0,klass:t.name,klassId:t.id,values:i,children:s}}computeAndPushVector(t,r,{a:s,b:i}){const{vars:n}=this,{oldFloats:a,newFloats:l}=n.values;let h=!1;const d=t(this,n),g=r.map(E=>{l[E]=a[E]=1;const T=d-t(this,n);return l[E]=a[E]=0,T!==0&&(h=!0),T});h&&(s.push(g),i.push(d))}computeEquationVectors(t,r){this.children.forEach(s=>s.computeEquationVectors(t,r)),this.klass.equations.forEach(s=>this.computeAndPushVector(s,t,r))}computeSchemaDefers(){this.children.forEach(t=>!t.isDisabled()&&t.computeSchemaDefers()),this.klass.defers.forEach(t=>t(this,this.vars))}getFirstDeepLeftSchema(){let t=this;for(;;){let r=null;for(const s of t.children)if(!s.isDisabled()){r=s;break}if(!r)break;t=r}return t}main(){return this.klass.main?.(this,this.vars)||null}computeBranch(){return new Yc(this)}compute(t){return new zc(this,t)}*userFunction(t,r){const s=this.kernel.classes.get(t);if(!s)throw Error(`Функция не существует: ${t}`);if(s.compile(),!s.isFunction)throw Error(`Имидж ${t} существует, но не является функцией`);const i=s.vars.list;if(r.length>i.length)throw Error(`${t}: ${r.length} аргументов, но функция имеет ${i.length} переменных`);let n=ks.get(i);if(!n){const h=new vs;n={map:i.map(d=>h.add(d)),varCount:h},ks.set(i,n)}const a=new As(n.map,new Wc(n.varCount));r.forEach((h,d)=>{const g=i[d];if(!a.setValue(g,h))throw Error(`Аргумент ${d} имеет тип ${typeof h}; ожидалось ${g.type}`)}),s.main&&(yield*s.main(this,a));const l=i.find(h=>h.attrib&v.VF_RETURN);if(l)return a.getNewValue(l)}solveEquationsFor(t){this.prj.solveEquationsFor(t)}path(){if(this===this.prj.root)return this.klass.name;const t=[this];for(;;){const r=t[0].resolveMap.get("..");if(r===this.prj.root)break;t.unshift(r)}return t.map(r=>`${r.klass.name} (#${r.ndata.key})`).join(" - ")}setNewValue(t,r){const{newFloats:s,newInts:i,newStrings:n}=this.vars.values,a=this.vars.map[t.id];switch(t.type){case B.FLOAT:if(typeof r!="number")return!1;s[a]=r;break;case B.HANDLE:case B.COLORREF:if(typeof r!="number")return!1;i[a]=r;break;case B.STRING:if(typeof r!="string")return!1;n[a]=r;break}return!0}getVarValueFHC(t){const{newFloats:r,newInts:s}=this.vars.values,i=this.vars.map[t.id];switch(t.type){case B.FLOAT:return r[i];case B.HANDLE:case B.COLORREF:return s[i];default:return null}}getVarValueS(t){return t.type===B.STRING?this.vars.values.newStrings[this.vars.map[t.id]]:null}_warn(t){console.warn(`${this.path()}: ${t}`)}}class qc{constructor({id:t,dir:r,rootKlass:s,state:i,kernel:n,settings:a}){this.memory=new Fc,this.classTypes=new WeakMap,this.id=t,this.dir=r,this.kernel=n,this.settings=a;const l=new Set,h=new vs,d=xs(s,n.classes,h),g=this.root=Ps(d,this,l);this.memory.alloc(h),g.initValues(),i&&g.applyValues(i),this.equationVars=Array.from(l)}createSchema({varMap:t,...r}){const s=new Kc({...r,vars:new As(t,this.memory)}),i=this.classTypes.get(s.klass);return i?i.push(s):this.classTypes.set(s.klass,[s]),s}getKlassSchemas(t){return this.classTypes.get(t)??[]}solveGlobalEquations(){const{equationVars:t}=this;t.length&&this.solveEquationsFor(t)}solveEquationsFor(t){const{oldFloats:r,newFloats:s}=this.memory,i=t.map(a=>{const l=r[a];return s[a]=r[a]=0,l}),n={a:[],b:[]};this.root.computeEquationVectors(t,n),t.forEach((a,l)=>r[a]=i[l]);try{const a=Gn(n);t.forEach((l,h)=>s[l]=a[h])}catch{t.forEach(l=>s[l]=0)}}beforeCompute(){this.kernel.beforeCompute.dispatch()}afterCompute(){this.memory.sync(),this.kernel.afterCompute.dispatch()}close(){this.kernel.closeProject(this)}}class Zc extends Error{constructor(t){super(`Проект ${t} загружается`)}}class Jc{constructor(t,r){if(this.fs=t,!r.projects.length)throw Error("Список проектов пуст");const s=r.projects.map(i=>{const n=t.path(i.filepath||"project.spj");return{config:i,path:n,state:{type:"notLoaded"}}});this.projects=s,this.initialProjectPath=r.initial?t.path(r.initial):s[0].path}exists(t){return this.projects.some(({path:r})=>r.equals(t))}async open(t){const r=this.projects.find(({path:n})=>n.equals(t));if(!r)return null;const s=r.state;if(s.type==="loading")throw new Zc(r.path);if(s.type==="loaded")return s.parsedProjectConfig;r.state={type:"loading"};let i;try{const{fs:n}=this,{path:a,config:l}=r;await Promise.all(l.libs.map(O=>n.mountLibrary(O)));const{searchDirs:h,stt:d}=l.settings,g=a.resolve(".."),E=[n.stdlibDir,g].concat(h?.map(O=>n.path(O))??[]),T=d?n.path(d):g.resolve("_preload.stt"),m=T.file()?.stt;m||console.warn(`Файл состояния ${T} не существует`),i={settings:l.settings,filepath:a,dir:g,searchDirs:E,stt:m}}catch(n){throw r.state={type:"notLoaded"},n}return r.state={type:"loaded",parsedProjectConfig:i},i}}class Ls{constructor(){this.currentTask=null,this.onError=new Ee,this.nextTaskStep=t=>{let r;try{r=this.currentTask.next(t)}catch(s){throw this.onError.dispatch(s),s}this.handleTaskResult(r)},this.rejectTask=t=>{let r;try{r=this.currentTask.throw(t)}catch(s){throw this.onError.dispatch(s),s}this.handleTaskResult(r)}}handleTaskResult(t){if(t.done){this.currentTask=null;return}Promise.resolve(t.value).then(this.nextTaskStep,this.rejectTask)}canRunTask(){return!this.currentTask}runTask(t){vt(!this.currentTask,"Предыдущий генератор должен завершить свое выполнение"),this.currentTask=t,this.nextTaskStep()}}class Qc{constructor(t,r,s){this.handlers={closed:new Set,error:new Set,shell:new Set,write:new Set,afterCycle:new Set},this.onProjectOpen=new Ee,this.beforeProjectClosed=new Ee,this.beforeCompute=new Ee,this.afterCompute=new Ee,this.beforeRender=new Ee,this.classes=new Bc,this.iterations=0,this.isPaused=!1,this.pluginFunctions={},this.compiler=new Dc,this.pluginNames=[],this.optionalPlugins=[],this.projects=[],this.closedProjects=new Set,this.mainTaskRunner=new Ls,this.uiEventsEnabled=!0,this.lag=0,this.timeStep=0,this.curIterator=null,this.update=i=>{let n=!0;if(!this.isPaused)if(this.timeStep>0){const a=i-this.lag;for(a>this.timeStep*10&&(console.warn(`lag обнулен: dt:${a}`),this.lag=i-this.timeStep-1);this.lag+this.timeStep<i&&(this.lag+=this.timeStep,!!(n=this.compute())););}else n=this.compute();return this.beforeRender.dispatch(),n},this.showed=new Set,this.runner=new xt(s),this.projectLoader=new Jc(t,r),this.initialCfg=this.init(),this.mainTaskRunner.onError.add(this.handleError.bind(this))}async init(){const t=this.projectLoader,r=await t.open(t.initialProjectPath);vt(r,`Корневой проект ${t.initialProjectPath} должен существовать`),this.initialCfg=r}async ready(){return await this.initialCfg,this}get fs(){return this.projectLoader.fs}get currentProject(){const{projects:t}=this;return t.length?t[t.length-1]:null}canHandleProjectUiEvents(t){return this.uiEventsEnabled&&this.projects.includes(t)}run(){if(this.initialCfg instanceof Promise)throw Error(`${this.projectLoader.initialProjectPath}: Начальный проект не загружен`);this.projects.length||(this.uiEventsEnabled=!0,this.isPaused=!1,this.iterations=0,this.addProject(this.initialCfg),this.runner.run(this.update))}stop(){this.closeAll(),this.compute()}step(){this.isPaused=!0,this.compute()}pause(){this.isPaused=!0}block(){this.uiEventsEnabled=!1,this.isPaused=!0}unblock(){this.uiEventsEnabled=!0,this.isPaused=!1}continue(){this.isPaused=!1}closeProject(t){const r=this.projects.indexOf(t);r>=0&&this.projects.splice(r,1),this.closedProjects.add(t)}closeAll(){let t;for(;t=this.projects.pop();)this.closedProjects.add(t)}hasProject(t){return this.projectLoader.exists(t)}async openProject(t){const r=await this.projectLoader.open(t);return r?this.addProject(r):null}async addProject({filepath:t,searchDirs:r,dir:s,stt:i,settings:n}){re.debugProject&&console.log(`Открывается ${t}`);const a=Symbol(t.toString());let l;try{if(n.plugins)for(const d of n.plugins){const g=this.optionalPlugins.find(({plugin:E})=>E.name===d);vt(g,`${t}: Плагин '${d}' требуется для работы проекта`),await this.setupPlugin(g.plugin,g.opts),re.debugProject&&console.log(`Загружен плагин '${d}'`)}r.forEach(d=>{const g=!n.nonRecursive||d.equals(this.fs.stdlibDir);d.forEach(E=>{if(!E.cls||this.classes.hasFile(E))return;const T=new Gc({projectId:a,data:E.cls,file:E,compiler:this.compiler,modelGlobals:this.pluginFunctions});T.isFunction&&this.compiler.addUserFunc(T.getUserFunctionSignature()),this.classes.add(T)},g)});const h=this.classes.get(n.rootClass);vt(h,`${t}: Корневой имидж ${n.rootClass} должен существовать`),l=new qc({kernel:this,id:a,filepath:t,dir:s,rootKlass:h,state:i,settings:n})}catch(h){throw this.classes.unload(a),h}return this.projects.push(l),this.onProjectOpen.dispatch(l),l}canRunMainTask(){return this.mainTaskRunner.canRunTask()}runMainTask(t){this.mainTaskRunner.runTask(t)}runParallelTask(t){new Ls().runTask(t)}handleError(t){this.runner.stop();let r=`Ошибка: ${t.message}`;this.projects.length>0&&(r+=`
В проекте ${this.projects[this.projects.length-1].id.description}`);const s=this.curIterator?.getCurrentNode();s&&(r+=`
В имидже ${s.path()}`),this.handlers.error.forEach(i=>i(r)),console.error(r)}*rootTask(){const t=this.projects[this.projects.length-1];yield*this.curIterator=t.root.compute(!1),++this.iterations,this.handlers.afterCycle.forEach(r=>r())}compute(){return this.canRunMainTask()?(this.closedProjects.forEach(t=>{re.debugProject&&console.log(`Закрывается ${t.id.description}`),this.beforeProjectClosed.dispatch(t),this.classes.unload(t.id)}),this.closedProjects.clear(),this.projects.length?(this.runMainTask(this.rootTask()),!0):(this.handlers.closed.forEach(t=>t()),!1)):!0}setIterationsPerSecond(t){this.timeStep=t>0?1e3/t:0,this.lag=0}log(t,r){re.logMessage&&console.info(r?`${r.path()}: ${t}`:t)}handleExe(t,r){const s=t.lastIndexOf(".exe"),i=s<0?t:t.substring(0,s);return this.handlers.shell.forEach(n=>n(i,"","",r??0)),!0}handleShell(t,r,s,i){return this.handlers.shell.forEach(n=>n(t,r,s,i)),!0}handleWrite(t,r){this.handlers.write.forEach(s=>s(t.toString(),r)),t.startsWith(this.fs.downloadsDir)&&us(new Blob([r],{type:"text/plain"}),t.basename())}async setupPlugin(t,r){this.pluginNames.includes(t.name)||(t.deps?.forEach(s=>{if(!this.pluginNames.includes(s))throw Error(`Плагин '${t.name}' зависит от '${s}'`)}),this.pluginNames.push(t.name),t.register((s,i,n)=>{const a=this.compiler.addFunc(s,i);this.pluginFunctions[a]=n}),await t.setup?.(this,r))}registerPlugin(t,r){this.optionalPlugins.push({plugin:t,opts:r})}_functionNotImplemented(t,r){if(this.showed.size===this.showed.add(t.toUpperCase()).size)return;const s=`${t} не реализована`;console.warn(r?`${r.path()}: ${s}`:s)}dispose(){this.windowSystem?.windowFactory.dispose()}}class ea{constructor(t){this.kernel=t}async ready(){return await this.kernel.ready(),this}get status(){const{kernel:t}=this;return t.currentProject?t.isPaused?"paused":"playing":"closed"}play(){return this.kernel.run(),this}close(){return this.kernel.stop(),this}pause(){return this.kernel.pause(),this}continue(){return this.kernel.continue(),this}step(){return this.kernel.step(),this}addPlugin(t,r){return this.kernel.registerPlugin(t,r),this}on(t,r){return this.kernel.handlers[t].add(r),this}off(t,r){const s=this.kernel.handlers[t];return r?s.delete(r):this.kernel.handlers[t].clear(),this}dispose(){this.kernel.dispose()}}const o=B.FLOAT,_=B.STRING,c=B.HANDLE,X=B.COLORREF,I=Ie.FLOAT_REF,ne=Ie.STRING_REF,ta=Ie.HANDLE_REF;Ie.COLORREF_REF;const ra=.752812499999996,sa=1.3283520132835271,ia=Date.now()-48151623,Cs=13.204656862745098;function Gs(e){const t=e.file()?.base64;return t?Nt(ns(t)):""}function na(){}class oa{constructor(t,r){this.key=t,this.fields=r??[]}insert(t){if(t==="FLOAT")return this.fields.push({type:t,value:0}),1;if(t==="HANDLE")return this.fields.push({type:t,value:0}),1;if(t==="STRING")return this.fields.push({type:t,value:""}),1;throw Error(`Неизвестный тип элемента: ${t}`)}insertClass(t,r){const s=r.map(i=>{const n=i[0].toUpperCase();switch(i[1]){case B.FLOAT:return[n,{type:"FLOAT",value:0}];case B.STRING:return[n,{type:"STRING",value:""}];default:return[n,{type:"HANDLE",value:0}]}});return this.fields.push({type:"STRUCT",realType:t,value:new Map(s)}),1}set(t,r,s){if(t<0||t>this.fields.length-1)return;let i=this.fields[t];if(i.type==="STRUCT"){const n=i.value.get(r.toUpperCase());if(!n)return;i=n}if(typeof s=="string"){if(i.type!=="STRING")return;i.value=s}else{if(i.type==="STRING")return;i.value=s}}remove(t){return this.fields.splice(t,1).length?1:0}count(){return this.fields.length}type(t){if(t<0||t>this.fields.length-1)return"";const r=this.fields[t];return r.type==="STRUCT"?r.realType:r.type}getFloat(t,r){if(t<0||t>this.fields.length-1)return 0;let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return 0;s=i}return s.type==="FLOAT"?s.value:0}getHandle(t,r){if(t<0||t>this.fields.length-1)return 0;let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return 0;s=i}return s.type==="HANDLE"?s.value:0}getString(t,r){if(t<0||t>this.fields.length-1)return"";let s=this.fields[t];if(s.type==="STRUCT"){const i=s.value.get(r.toUpperCase());if(!i)return"";s=i}return s.type==="STRING"?s.value:""}sort(t){if(!t?.length)return this.fields.sort((r,s)=>r.value-s.value),1;if(t.length===1)return t[0].desc?this.fields.sort((r,s)=>s.value-r.value):this.fields.sort((r,s)=>r.value-s.value),1;throw console.log(t),Error("VSort: сортировка по нескольким полям не реализована")}}function ca(e,t){const r=he.freeKey(e),s=new oa(r,t);return e.set(r,s),s}function aa(){return this.kernel.createArray().key}function la(e){this.kernel.arrays.delete(e)}function ha(e){return this.kernel.arrays.get(e)?.count()??0}function ua(e,t){return this.kernel.arrays.get(e)?.type(t)??""}function da(e,t){const r=this.kernel.arrays.get(e);if(!r)return 0;const s=t.toUpperCase();if(s==="STRING"||s==="FLOAT"||s==="HANDLE")return r.insert(s);const i=this.kernel.classes.get(t);if(!i)return 0;const n=i.vars.list.map(a=>[a.name,a.type]);return r.insertClass(i.name,n)}function fa(e,t){return this.kernel.arrays.get(e)?.remove(t)??0}function ga(){return this.kernel.arrays.clear(),1}function pa(e,t,r){return this.kernel.arrays.get(e)?.getString(Math.floor(t),r)??""}function _a(e,t,r){return this.kernel.arrays.get(e)?.getHandle(Math.floor(t),r)??0}function Ea(e,t,r){return this.kernel.arrays.get(e)?.getFloat(Math.floor(t),r)??0}function mr(e,t,r,s){this.kernel.arrays.get(e)?.set(t,r,s)}function ma(e,...t){const r=this.kernel.arrays.get(e);return r?r.sort(t.map(s=>({desc:!1,field:s}))):0}function Ta(e,t,...r){const s=this.kernel.arrays.get(e);if(!s)return 0;const i=!!t;return s.sort(r.map(n=>({desc:i,field:n})))}function wa(e,...t){const r=this.kernel.arrays.get(e);if(!r)return 0;const s=[];for(let i=0;i<t.length;i+=2){const n=t[i],a=!!t[i+1];s.push({desc:a,field:n})}return r.sort(s)}function ya(e){e("New",{r:c},aa),e("Delete",{a:[c]},la),e("VGetCount",{a:[c],r:o},ha),e("VGetType",{a:[c,o],r:_},ua),e("VInsert",{a:[c,_],r:o},da),e("VDelete",{a:[c,o],r:o},fa),e("VClearAll",{},ga),e("VGetS",{a:[c,o,_],r:_},pa),e("VGetH",{a:[c,o,_],r:c},_a),e("VGetF",{a:[c,o,_],r:o},Ea),e("VSet",{a:[c,o,_,o]},mr),e("VSet",{a:[c,o,_,_]},mr),e("VSet",{a:[c,o,_,c]},mr),e("VSort",{a:[c],rest:[_],r:o},ma),e("VSort",{a:[c,o],rest:[_],r:o},Ta),e("VSort",{a:[c],rest:[_,o],r:o},wa)}const ba={name:"arrays",register:ya,setup(e){const t=new Map;e.arrays=t,e.createArray=ca.bind(null,t)}},Bs=new Set;function de(...e){Bs.size!==Bs.add(e[0]).size&&console.warn(...e)}function Ra(e){throw de("AudioGetBalance",e),Error("Not implemented")}function Oa(e){throw de("AudioGetLength",e),Error("Not implemented")}function Ma(e){throw de("AudioGetPosition",e),Error("Not implemented")}function Sa(e){throw de("AudioGetRepeat",e),Error("Not implemented")}function Na(e){throw de("AudioGetTone",e),Error("Not implemented")}function Ia(e){throw de("AudioGetVolume",e),Error("Not implemented")}function Aa(e){const t=this.kernel.audios.get(e);return t&&!t.paused?1:0}function va(e){throw de("AudioIsSeekable",e),Error("Not implemented")}function xa(e){const t=this.prj.dir.resolve(e).file()?.audio;if(!t)return 0;const r=new Audio(dt(t.src)),s=he.freeKey(this.kernel.audios);return this.kernel.audios.set(s,r),s}function Pa(e){this.kernel.audios.get(e)?.play()}function Da(e){de("AudioReset",e)}function ka(e,t){de("AudioSetBalance",e,t)}function La(e,t){de("AudioSetPosition",e,t)}function Ca(e,t){de("AudioSetRepeat",e,t)}function Ga(e,t){de("AudioSetTone",e,t)}function Ba(e,t){de("AudioSetVolume",e,t)}function Fa(e){this.kernel.audios.get(e)?.pause()}function Wa(e){e("AudioGetBalance",{a:[c],r:o},Ra),e("AudioGetLength",{a:[c],r:o},Oa),e("AudioGetPosition",{a:[c],r:o},Ma),e("AudioGetRepeat",{a:[c],r:o},Sa),e("AudioGetTone",{a:[c],r:o},Na),e("AudioGetVolume",{a:[c],r:o},Ia),e("AudioIsPlaying",{a:[c],r:o},Aa),e("AudioIsSeekable",{a:[c],r:o},va),e("AudioOpenSound",{a:[_],r:c},xa),e("AudioPlay",{a:[c]},Pa),e("AudioReset",{a:[c]},Da),e("AudioSetBalance",{a:[c,o]},ka),e("AudioSetPosition",{a:[c,o]},La),e("AudioSetRepeat",{a:[c,o]},Ca),e("AudioSetTone",{a:[c,o]},Ga),e("AudioSetVolume",{a:[c,o]},Ba),e("AudioStop",{a:[c]},Fa)}const Ua={name:"audio",register:Wa,setup(e){e.audios=new Map}};function Va(e){return this.resolve(e)?.klass.name??""}function Fs(...e){throw console.warn("createLink",...e),Error("Not implemented")}function $a(...e){throw console.warn("createObject",...e),Error("Not implemented")}function ja(){throw Error("Not implemented")}function Ha(...e){throw console.warn("setLinkVars",...e),Error("Not implemented")}function Xa(e){return this.kernel.classes.get(e)?.children.length??0}function Ya(){return this.ndata?.key??0}function za(e){return this.resolve(e)?.ndata?.key??0}function Ka(e,t){if(t<0)return 0;const r=this.kernel.classes.get(e)?.children;return r&&t<r.length?r[t].key:0}function qa(e,t){return this.kernel.classes.get(e)?.children.find(r=>r.key===t)?.klass??""}function Za(e,t,r){return this.kernel.classes.get(e)?.connections.find(({nodes:[s,i]})=>s===t&&i===r||s===r&&i===t)?.key??0}function Ja(e,t){const r=this.kernel.classes.get(e)?.modelText;if(!r)return 0;const s=this.kernel.streams.get(t);if(!s)return 0;const i=At(r);return s.write(i),i.length}function Ws(e,t){const r=this.kernel.classes.get(e);if(!r)return 0;const s=this.kernel.streams.get(t)?.bytes();if(!s)return 0;const i=Nt(s),n=r.modelText;r.set({modelText:i});try{r.compile()}catch(a){if(!(a instanceof Error))throw a;return console.warn(a.message),r.set({modelText:n}),0}return 1}function Qa(e,t){const r=this.resolve(e);if(!r)return"";const s=r.klass.vars.get(t);return s?r.getVarValueS(s)??"":""}function Tr(e,t){const r=this.resolve(e);if(!r)return 0;const s=r.klass.vars.get(t);return s?r.getVarValueFHC(s)??0:0}function Ct(e,t,r){const s=this.resolve(e);if(!s)return;const i=s.klass.vars.get(t);i&&s.vars.setValue(i,r)}function Us(e,t,r,s,i,n,a,l,h,d,g,E){const T=this.kernel.classes.get(e)?.vars.list;if(t<0||!T||t>=T.length)return r[s]="",i[n]="",a[l]="",h[d]="",g&&(g[E]=0),0;const m=T[t];return r[s]=m.name,i[n]=B[m.type],a[l]=m.defaultValue??"",h[d]=m.description??"",g&&(g[E]=m.attrib),1}function el(e){return this.kernel.classes.get(e)?.vars.list.length??0}function tl(e,t,r){const s=this.kernel.classes.get(e);if(!s)return 0;const i=s.children.findIndex(a=>a.key===t);if(i<0)return 0;const n=s.children.slice();return n[i]={...n[i],name:r},s.set({children:n}),1}function rl(e,t){return this.kernel.classes.get(e)?.children.find(r=>r.key===t)?.name??""}function sl(e,t){const r=this.resolve(e);if(!r)return 0;const s=this.prj.dir.resolve(t).file();if(!s)return 0;const i=r.getValues();return s.set({stt:i}),1}function il(e,t){const r=this.resolve(e);if(!r)return 0;const s=this.prj.dir.resolve(t).file()?.stt;return s?(r.applyValues(s),1):0}function nl(e){return this.resolve(e)?.initValues(!0)?1:0}function ol(){this.kernel._functionNotImplemented("Stop",this)}function cl(e){e<=0||this.kernel.closeAll()}function al(){this.prj.close()}function ll(e){e("GetClassName",{a:[_],r:_},Va),e("CreateLink",{a:[_,c,c],r:c},Fs),e("CreateLink",{a:[_,_,_],r:c},Fs),e("CreateObject",{a:[_,_,_,o,o],r:c},$a),e("DeleteObject",{a:[_,c,o],r:o},ja),e("SetLinkVars",{a:[_,c,_],r:o},Ha),e("GetObjectCount",{a:[_],r:o},Xa),e("GetHObject",{r:c},Ya),e("GetHObjectByName",{a:[_],r:c},za),e("GetHObjectByNum",{a:[_,o],r:c},Ka),e("GetObjectClass",{a:[_,c],r:_},qa),e("GetLink",{a:[_,c,c],r:c},Za),e("GetModelText",{a:[_,c],r:o},Ja),e("SetModelText",{a:[_,c],r:o},Ws),e("SetModelText",{a:[_,c,o],r:o},Ws),e("GetVarS",{a:[_,_],r:_},Qa),e("GetVarF",{a:[_,_],r:o},Tr),e("GetVarH",{a:[_,_],r:c},Tr),e("GetVarC",{a:[_,_],r:X},Tr),e("SetVar",{a:[_,_,o]},Ct),e("SetVar",{a:[_,_,_]},Ct),e("SetVar",{a:[_,_,c]},Ct),e("SetVar",{a:[_,_,X]},Ct),e("GetVarInfo",{a:[_,o,ne,ne,ne,ne],r:o},Us),e("GetVarInfo",{a:[_,o,ne,ne,ne,ne,I],r:o},Us),e("GetVarCount",{a:[_],r:o},el),e("SetObjectName",{a:[_,c,_],r:o},tl),e("GetNameByHandle",{a:[_,c],r:_},rl),e("SaveObjectState",{a:[_,_],r:o},sl),e("LoadObjectState",{a:[_,_],r:o},il),e("SetVarsToDefault",{a:[_],r:o},nl),e("Stop",{a:[o]},ol),e("Quit",{a:[o]},cl),e("CloseAll",{},al)}const hl={name:"class",deps:["streams"],register:ll};function ul(e,t,r,s,i,n,a,l){let h;switch(t.toUpperCase()){case"EDIT":h="Edit";break;case"BUTTON":h="Button";break;case"COMBOBOX":h="ComboBox";break;case"LISTBOX":h="ListBox";break;default:return 0}const d=this.kernel.scenes.get(e);if(!d)return 0;const g=d.scene;let E=i,T=n;const m=d.matrix;if(m){const N=i*m[2]+n*m[5]+m[8];E=(i*m[0]+n*m[3]+m[6])/N,T=(i*m[1]+n*m[4]+m[7])/N}const O=g.input(h,{x:E,y:T,width:a,height:l,value:r,style:s});return g.set({order:g.order.concat(O)}),O.key}function Vs(e,t,r,s){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(i?.type!=="input")return"";const{value:n}=i;return typeof r>"u"?n:n.slice(r,r+s)}function dl(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="input"&&s.set({value:r})?1:0}function fl(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="input"&&i.set({font:s.fonts.get(r)??null})?1:0}function gl(){return this.kernel._functionNotImplemented("EnableControl2d"),0}function pl(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return;const s=r.objects.get(t);s?.type==="input"&&s.focus()}function _l(){return this.kernel._functionNotImplemented("IsDlgButtonChecked"),0}function El(){return this.kernel._functionNotImplemented("CheckDlgButton2d"),1}function ml(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="input"&&s.set({style:r})?1:0}function Tl(e,t,r){return this.kernel._functionNotImplemented("LBAddString"),0}function wl(e,t,r){return this.kernel._functionNotImplemented("LBGetString"),""}function yl(e,t){return this.kernel._functionNotImplemented("LBClearList"),0}function bl(e,t){return this.kernel._functionNotImplemented("LBGetSelIndex"),0}function Rl(e,t,r){return this.kernel._functionNotImplemented("lBSetSelIndex"),0}function Ol(e){e("CreateControlObject2d",{a:[c,_,_,o,o,o,o,o,o],r:c},ul),e("GetControlText2d",{a:[c,c],r:_},Vs),e("GetControlText2d",{a:[c,c,o,o],r:_},Vs),e("SetControlText2d",{a:[c,c,_],r:o},dl),e("SetControlFont2d",{a:[c,c,c],r:o},fl),e("EnableControl2d",{a:[c,c,o],r:o},gl),e("SetControlFocus2d",{a:[c,c]},pl),e("IsDlgButtonChecked2d",{a:[c,c],r:o},_l),e("CheckDlgButton2d",{a:[c,c,o],r:o},El),e("SetControlStyle2d",{a:[c,c,o],r:o},ml),e("LBAddString",{a:[c,c,_],r:o},Tl),e("LBGetString",{a:[c,c,o],r:_},wl),e("LBClearList",{a:[c,c],r:o},yl),e("LBGetSelIndex",{a:[c,c],r:o},bl),e("LBSetSelIndex",{a:[c,c,o],r:o},Rl)}const Ml={name:"controls",deps:["windows"],register:Ol};class Sl{constructor(t){this.curRow={},this.fieldNames=t}setCurrentRow(t){this.curRow=t}getValue(t){if(t<0||t>=this.fieldNames.length)return"";const r=this.fieldNames[t];return(this.curRow[r]||"").toString()}}class Nl{constructor(t){this.rowEngine=t}getString(t){return this.rowEngine.getValue(t)}getFloat(t){return parseFloat(this.rowEngine.getValue(t))}}class Il{constructor(t,r){this.rows=[],this.rowPointer=0,this.cols=t.map(s=>({name:s})),this.rows=r,this.rowEngine=new Sl(t),this.currentRow=new Nl(this.rowEngine)}goTop(){this.rowPointer=0}skip(t){const r=this.rowPointer+t;return r<0||r>=this.rows.length?!1:(this.rowPointer=r,!0)}getColumn(t){return t<0||t>=this.cols.length?null:this.cols[t]}getRow(){if(this.rowPointer>=this.rows.length)return null;const t=this.rows[this.rowPointer];return this.rowEngine.setCurrentRow(t),this.currentRow}getColumnCount(){return this.cols.length}getRowCount(){return this.rows.length}}class Al{async query(t){const i=await(await fetch("https://stratum.ac.ru/enteronline/api/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sql:t})})).json();return new Il(i.fields,i.rows)}close(){}}class wr{static async create(){return new wr}constructor(){}mysql(){return new Al}}function Gt(...e){console.warn(...e)}function vl(e,t,r,s){let i;i=this.kernel.dbDriverFactory.mysql(),console.warn(`Неизвестный тип БД: ${t}; fallback к Mysql (remote)`);const n=he.freeKey(this.kernel.dbs,100);return this.kernel.dbs.set(n,i),n}function xl(e){const t=this.kernel.dbs.get(e);return t?(t.close(),this.kernel.dbs.delete(e),1):0}function Pl(e){return this.kernel.dbTables.delete(e)?1:0}function Dl(){return Gt("DbGetError"),0}function kl(e){return Gt("DbGetErrorStr",e),""}function Ll(e,t){throw Gt("DbSetDir",e,t),Error("'DbSetDir' not implemented")}function Cl(){Gt("DbCloseAll")}function Gl(e){const t=this.kernel.dbTables.get(e);return t?(t.goTop(),t.getRowCount()?1:0):0}function Bl(e,t){const r=this.kernel.dbTables.get(e);return r&&r.skip(t)?1:0}function Fl(e,t){const r=this.kernel.dbTables.get(e);return r&&r.getColumn(t-1)?.name||""}function Wl(e,t){const r=this.kernel.dbTables.get(e);return r&&r.getRow()?.getString(t-1)||""}function Ul(e,t){const r=this.kernel.dbTables.get(e);return r&&r.getRow()?.getFloat(t-1)||0}async function $s(e,t,r){const s=e.kernel.dbs.get(t);if(!s)return 0;const i=await s.query(r),n=he.freeKey(e.kernel.dbTables,1e3);return e.kernel.dbTables.set(n,i),n}function Vl(e,t,r){const s=this.kernel.streams.get(t);if(!s)return Promise.resolve(0);const i=Nt(s.bytes());return $s(this,e,i)}function $l(e,t,r){return $s(this,e,t)}function jl(e){const t=this.kernel.dbTables.get(e);return t?t.getRowCount():-1}function Hl(e,t,r){const s=this.kernel.streams.get(r);if(!s)return 0;const i=this.kernel.dbTables.get(e);if(!i)return 0;const n=t-1;if(n<0||n>i.getColumnCount())return 0;const a=i.getRow();if(!a)return 0;const l=a.getString(n);return s.write(At(l)),1}function Xl(e){e("DbOpenBase",{a:[_,_,_,_],r:c},vl),e("DbCloseBase",{a:[c],r:o},xl),e("DbCloseTable",{a:[c],r:o},Pl),e("DbGetError",{r:o},Dl),e("DbGetErrorStr",{a:[o],r:_},kl),e("DbSetDir",{a:[c,_],r:o},Ll),e("DbCloseAll",{},Cl),e("DbGoTop",{a:[c],r:o},Gl),e("DbSkip",{a:[c,o],r:o},Bl),e("DbGetField",{a:[c,o],r:_},Wl),e("DbSQL",{a:[c,_,o],r:c,kind:"async"},$l),e("DbSQL",{a:[c,c,o],r:c,kind:"async"},Vl),e("DbGetCount",{a:[c],r:o},jl),e("DbGetFieldN",{a:[c,o],r:o},Ul),e("DbGetFieldName",{a:[c,o],r:_},Fl),e("DbGetBlob",{a:[c,o,c],r:o},Hl)}const Yl={name:"db",deps:["streams"],register:Xl,setup:async e=>{e.dbDriverFactory=await wr.create(),e.dbs=new Map,e.dbTables=new Map}},zl={dialog:"_8OpWP1FD"};class Kl{constructor(){this.onClose=new Ee;const t=this.domElement=document.createElement("dialog");t.className=zl.dialog,t.innerHTML=`
<form method="dialog">
  <p><input type="file"></p>

  <menu>
    <button value="ok" disabled>Подтвердить выбор</button>
    <button value="cancel">Отмена</button>
  </menu>
</form>
    `;const r=t.querySelector('input[type="file"]'),s=t.querySelector('button[value="ok"]');r.addEventListener("change",()=>{s.disabled=!r.files?.length}),t.addEventListener("close",()=>{const i=t.returnValue==="ok"&&r.files?.item(0);this.onClose.dispatch(i||null)})}open(){this.domElement.showModal()}}let ql=0;async function Zl(e,t,r){const{kernel:s}=this;s.block();const i=new Kl;s.windowSystem.windowFactory.root.ownerDocument.body.append(i.domElement),i.open();const n=await new Promise(h=>i.onClose.add(h));let a=null;if(n)try{if(n.type.startsWith("image/")){const h=URL.createObjectURL(n),d=await ds(h),{naturalWidth:g,naturalHeight:E}=d;a={size:n.size,image:{width:g,height:E,src:h}}}else{const h=await n.arrayBuffer(),d=is(new Uint8Array(h));a={size:n.size,base64:d}}}catch(h){console.warn(h.message)}if(i.domElement.remove(),s.unblock(),!a)return"";const l=s.fs.uploadsDir.resolve("file"+ ++ql);return l.create("file",a),l.toString()}function Jl(e,t,r){return this.kernel.fs.downloadsDir.resolve(r||"data.txt").toString()}function Ql(e,t,r){switch(r){case r&v.MB_OK:return alert(e),1;case r&v.MB_OKCANCEL:return confirm(e)?1:2;case r&v.MB_YESNO:return confirm(e)?6:7;default:return 0}}function eh(e,t,r){return prompt(e||t,r)||""}function th(e,t){return this.kernel._functionNotImplemented("DialogBox"),1}function rh(e,t,r){throw Error("ChoseFolderDialog: Not implemented")}function sh(e){e("ChoseFolderDialog",{a:[_,_,o],r:_},rh),e("DialogBox",{a:[_,c],r:1},th),e("FileLoadDialog",{a:[_,_,_],r:_,kind:"async"},Zl),e("FileSaveDialog",{a:[_,_,_],r:_},Jl),e("MessageBox",{a:[_,_,o],r:o},Ql),e("InputBox",{a:[_,_,_],r:_},eh)}const ih={name:"dialogs",deps:["windows"],register:sh};function nh(e){return this.prj.dir.resolve(e).create("folder")?1:0}function oh(e){const t=this.prj.dir.resolve(e);return t.fileExist()||this.kernel.hasProject(t)?1:0}function ch(e){const t=this.kernel.classes.get(e);return t?t.file.path.resolve("..").toString()+"\\":""}function ah(){return this.prj.dir.toString()}function lh(){return"C:\\Windows"}function hh(e){const t=this.prj.dir.resolve(e).matchGlob();if(!t.length)return 0;const r=t.map(s=>{const i=[["NAME",{type:"STRING",value:s.name}],["SIZE",{type:"FLOAT",value:s.size}],["ATTR",{type:"FLOAT",value:0}],["YEAR",{type:"FLOAT",value:2007}],["MONTH",{type:"FLOAT",value:9}],["DAY",{type:"FLOAT",value:3}],["DAYOFWEEK",{type:"FLOAT",value:1}],["HOUR",{type:"FLOAT",value:4}],["MINUTE",{type:"FLOAT",value:20}],["SECOND",{type:"FLOAT",value:0}]];return{type:"STRUCT",realType:"FILE_ATTRIBUTE",value:new Map(i)}});return this.kernel.createArray(r).key}function uh(e){return e.length===0||e[e.length-1]==="\\"?e:e+"\\"}function dh(e){e("CreateDir",{a:[_],r:o},nh),e("FileExist",{a:[_],r:o},oh),e("GetClassDirectory",{a:[_],r:_},ch),e("GetProjectDirectory",{r:_},ah),e("GetWindowsDirectory",{r:_},lh),e("GetFileList",{a:[_,o],r:c},hh),e("AddSlash",{a:[_],r:_},uh)}const fh={name:"filesystem",deps:["arrays"],register:dh};function gh(e){const t=this.kernel.scenes.get(e);return t?t.scene.x:0}function ph(e){const t=this.kernel.scenes.get(e);return t?t.scene.y:0}function _h(e,t,r){const s=this.kernel.scenes.get(e);return s?(s.setSceneOrg(t,r),1):0}function Eh(e){return this.kernel.scenes.get(e)?.scale??0}function mh(e,t){const r=this.kernel.scenes.get(e);return r?(r.setScale(t),1):0}function Th(e,t,r,s,i,n,a){const l=this.kernel.scenes.get(e)?.scene.toBlob({x:s,y:i,w:n,h:a});if(!l)return 0;const h=t.match(/(?:.*[\\/])?(.+?)(\..*)?$/),d=h&&h.length>1?h[1]:"Screenshot";return l.then(g=>us(g,d)),1}function wh(e){return this.kernel.scenes.get(e)?.scene.background?.key??0}function yh(e,t){const r=this.kernel.scenes.get(e)?.scene;return r?.set({background:r.brushes.get(t)??null})?1:0}function bh(){return 0}function Rh(e){return this.kernel.scenes.get(e)?.scene.hiddenLayers??0}function Oh(e,t){return this.kernel.scenes.get(e)?.scene.set({hiddenLayers:t})?1:0}function Mh(){return 1}function Sh(e,t,r,s,i){return this.kernel.scenes.get(e)?.scene.pen({color:s,rop:i,style:t,width:r}).key??0}function Nh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.color??0}function Ih(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.rop??0}function Ah(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.style??0}function vh(e,t){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.width??0}function xh(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({color:r})?1:0}function Ph(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({rop:r})?1:0}function Dh(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({style:r})?1:0}function kh(e,t,r){return this.kernel.scenes.get(e)?.scene.pens.get(t)?.set({width:r})?1:0}function Lh(e,t,r,s,i,n){const a=this.kernel.scenes.get(e)?.scene;return a?.brush({color:s,hatch:r,rop:n,style:t,image:a.imagesOpaque.get(i)}).key??0}function Ch(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.color??0}function Gh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.rop??0}function Bh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.style??0}function Fh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.hatch??0}function Wh(e,t){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.image?.key??0}function Uh(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({color:r})?1:0}function Vh(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({rop:r})?1:0}function $h(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({style:r})?1:0}function jh(e,t,r){return this.kernel.scenes.get(e)?.scene.brushes.get(t)?.set({hatch:r})?1:0}function Hh(e,t,r){const s=this.kernel.scenes.get(e)?.scene;return s?.brushes.get(t)?.set({image:s.imagesOpaque.get(r)??null})?1:0}function js({kernel:e},t,r,s,i){return e.scenes.get(t)?.scene.font({name:r,size:s,style:i}).key??0}function Xh(e,t,r,s){return js(this,e,t,r,s)}function Yh(e,t,r,s){return js(this,e,t,r*sa,s)}function zh(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.name??""}function Kh(e,t){return(this.kernel.scenes.get(e)?.scene.fonts.get(t)?.size??0)*ra}function qh(e,t){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.style??0}function Zh(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({name:r})?1:0}function Jh(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({size:r})?1:0}function Qh(e,t,r){return this.kernel.scenes.get(e)?.scene.fonts.get(t)?.set({style:r})?1:0}function eu(e,t){return this.kernel.scenes.get(e)?.scene.string(t).key??0}function tu(e,t){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.text??""}function ru(e,t,r){return this.kernel.scenes.get(e)?.scene.strings.get(t)?.set({text:r})?1:0}function su(e,t,r,s,i){const n=this.kernel.scenes.get(e)?.scene;if(!n)return 0;const a=n.strings.get(r);if(!a)return 0;const l=n.fonts.get(t);return l?n.text([{string:a,font:l,fgcolor:s,bgcolor:i}]).key:0}function iu(e,t){return this.kernel.scenes.get(e)?.scene.texts.get(t)?.parts.length??0}function Je({kernel:e},t,r,s){if(s<0)return null;const i=e.scenes.get(t)?.scene.texts.get(r)?.parts;return i&&s<i.length?i[s]:null}function Hs(e,t,r=0){return Je(this,e,t,r)?.font.key??0}function Xs(e,t,r=0){return Je(this,e,t,r)?.string.key??0}function Ys(e,t,r=0){return Je(this,e,t,r)?.fgcolor??0}function zs(e,t,r=0){return Je(this,e,t,r)?.bgcolor??0}function Ks(e,t,r,s,i,n,a){if(r<0)return 0;const l=this.kernel.scenes.get(e)?.scene;if(!l)return 0;const h=l.texts.get(t)?.parts;return!h||r>=h.length?0:(h[r].set({string:l.strings.get(i),font:l.fonts.get(s),fgcolor:n,bgcolor:a}),1)}function nu(e,t,r,s,i,n){return Ks.call(this,e,t,0,r,s,i,n)}function ou(e,t,r,s){if(r<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||r>=n.length)return 0;const a=i.fonts.get(s);return a?(n[r].set({font:a}),1):0}function cu(e,t,r,s){if(r<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.texts.get(t)?.parts;if(!n||r>=n.length)return 0;const a=i.strings.get(s);return a?(n[r].set({string:a}),1):0}function au(e,t,r,s){return Je(this,e,t,r)?.set({fgcolor:s})?1:0}function lu(e,t,r,s){return Je(this,e,t,r)?.set({bgcolor:s})?1:0}function qs(e,t,r,s,i,n,a){if(r<0)return 0;const l=this.kernel.scenes.get(e)?.scene;if(!l)return 0;const h=l.texts.get(t);if(!h)return 0;const d=l.fonts.get(s);if(!d)return 0;const g=l.strings.get(i);if(!g)return 0;const E=r<h.parts.length,T=h.createPart({font:d,string:g,fgcolor:n,bgcolor:a},E);if(E){const m=h.parts.slice();m.splice(r,0,T),h.set({parts:m})}return 1}function hu(e,t,r,s,i,n){return qs.call(this,e,t,1/0,r,s,i,n)}function uu(e,t,r){if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.texts.get(t);if(!i||r>=i.parts.length)return 0;const n=i.parts.slice();return n.splice(r,1),i.set({parts:n},!0),1}function Zs({kernel:e},{prj:t},r,s,i){const n=e.scenes.get(r)?.scene;if(!n)return 0;const a=t.dir.resolve(s),l=a.file();return l?l.image?n.image(l.image,{opaque:i}).key:(re.debugFile&&console.warn(`create(Double)DIB2d: Файл ${a} существует, но формат не image.`),0):0}function Js(e,t){return Zs(this,this,e,t,!0)}function Qs(e,t){return Zs(this,this,e,t)}function du(e,t,r,s){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.getPixel(r,s)??0}function fu(e,t,r,s,i){return this.kernel.scenes.get(e)?.scene.imagesOpaque.get(t)?.setPixel(r,s,i)?1:0}function gu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case v.PEN2D:i=s.pens;break;case v.BRUSH2D:i=s.brushes;break;case v.DOUBLEDIB2D:i=s.images;break;case v.DIB2D:i=s.imagesOpaque;break;case v.STRING2D:i=s.strings;break;case v.FONT2D:i=s.fonts;break;case v.TEXT2D:i=s.texts;break;case v.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(r)?.delete(!0)?1:0}function pu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case v.PEN2D:i=s.pens;break;case v.BRUSH2D:i=s.brushes;break;case v.DOUBLEDIB2D:i=s.images;break;case v.DIB2D:i=s.imagesOpaque;break;case v.STRING2D:i=s.strings;break;case v.FONT2D:i=s.fonts;break;case v.TEXT2D:i=s.texts;break;case v.SPACE3D:throw Error("Не реализовано");default:return 0}let n=1/0;for(const a of i.keys())a>r&&a<n&&(n=a);return n===1/0?0:n}function _u(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;switch(t){case v.PEN2D:i=s.pens;break;case v.BRUSH2D:i=s.brushes;break;case v.DOUBLEDIB2D:i=s.images;break;case v.DIB2D:i=s.imagesOpaque;break;case v.STRING2D:i=s.strings;break;case v.FONT2D:i=s.fonts;break;case v.TEXT2D:i=s.texts;break;case v.SPACE3D:throw Error("Не реализовано");default:return 0}return i.get(r)?.subs.size??0}function Eu(e,t,r){return ir(e,t,r)}function mu(e,t,r,s){return ir(e,t,r,s===1?"transparent":s===2?"syscolor":"rgb")}function Tu(e){return e&4294967295}function wu(e){return qr(e)}function yu(e){return Zr(e)}function bu(e){return Jr(e)}function Ru(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const a=this.prj.dir.resolve(t).file()?.scene?.data;return a?n.paste(a,r,s,i)?.key??0:0}function Ou(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.delete(!0)?1:0}function Mu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":return v.OTGROUP2D;case"line":return v.OTLINE_2D;case"imageView":return r.opaque?v.OTBITMAP_2D:v.OTDOUBLEBITMAP_2D;case"textView":return v.OTTEXT_2D;case"videoView":return 0;case"input":return 26}}function Su(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.data?.name??""}function Nu(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?(s.data.name=r,1):0}function Iu(e,t,r){if(!r)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;let i;if(t){const n=s.objects.get(t);if(!n)return 0;if(n.data?.name===r)return n.key;if(n.type!=="group")return 0;i=n.descendants()}else i=s.objects.values();for(const n of i)if(n.data?.name===r)return n.key;return 0}function Au(e,t){const r=this.kernel.scenes.get(e);if(!r)return 0;const s=r.scene.objects.get(t);if(!s)return 0;const i=r.invmatrix;if(!i)return s.x;const n=s.x,a=s.y,l=n*i[2]+a*i[5]+i[8];return(n*i[0]+a*i[3]+i[6])/l}function vu(e,t){const r=this.kernel.scenes.get(e);if(!r)return 0;const s=r.scene.objects.get(t);if(!s)return 0;const i=r.invmatrix;if(!i)return s.y;const n=s.x,a=s.y,l=n*i[2]+a*i[5]+i[8];return(n*i[1]+a*i[4]+i[7])/l}function xu(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)return 0;const n=i.scene.objects.get(t);if(!n)return 0;let a=r,l=s;const h=i.matrix;if(h){const d=r*h[2]+s*h[5]+h[8];a=(r*h[0]+s*h[3]+h[6])/d,l=(r*h[1]+s*h[4]+h[7])/d}return n.set({x:a,y:l}),1}function Pu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.width??0}function Du(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.height??0}function ku(e,t,r,s){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.set({width:r,height:s})?1:0}function Lu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":case"line":case"input":return r.width;case"imageView":return r.image.width;case"textView":return r.text.width;case"videoView":return r.video.width}}function Cu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!r)return 0;switch(r.type){case"group":case"line":case"input":return r.height;case"imageView":return r.image.height;case"textView":return r.text.height;case"videoView":return r.video.height}}function Gu(e,t,r,s,i,n){const a=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!a)return r[s]=0,i[n]=0,0;switch(a.type){case"group":case"line":case"input":return r[s]=a.width,i[n]=a.height,1;case"imageView":return r[s]=a.image.width,i[n]=a.image.height,1;case"textView":return r[s]=a.text.width,i[n]=a.text.height,1;case"videoView":return r[s]=a.video.width,i[n]=a.video.height,1}}function Bu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r&&(r.type==="textView"||r.type==="imageView")?r.angle:0}function Fu(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const a=n.scene.objects.get(t);if(!a)return 0;let l=r,h=s;const d=n.matrix;if(d){const g=r*d[2]+s*d[5]+d[8];l=(r*d[0]+s*d[3]+d[6])/g,h=(r*d[1]+s*d[4]+d[7])/g}return a.rotate(i,{x:l,y:h}),1}function yr({kernel:e},t,r,s){const i=e.scenes.get(t)?.scene.objects.get(r);if(!i)return 0;const n=s?i.attrib&-2:i.attrib|1;return i.set({attrib:n}),1}function Wu(e,t,r){return yr(this,e,t,!!r)}function Uu(e,t){yr(this,e,t,!0)}function Vu(e,t){yr(this,e,t,!1)}function $u(e,t,r){return this.kernel.scenes.get(e)?.pick(t,r,!0)?.key??0}function ju(){return this.kernel.windowSystem.lastPickedPrimaryKey}function Hu(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?(this.kernel.windowSystem.clipboard=tc(r),1):0}function Xu(e,t,r,s){const i=this.kernel.windowSystem.clipboard;return i?this.kernel.scenes.get(e)?.paste(i,t,r,s)?.key??0:0}function Yu(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!s)return 0;let i=s.attrib;switch(r){case 0:i&=-13;break;case 1:i&=~or,i|=cr;break;case 2:i&=~cr,i|=or;break;default:return 0}return s.set({attrib:i}),1}function zu(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.attrib??0}function Ku(e,t,r,s){const i=this.kernel.scenes.get(e)?.scene.objects.get(t);if(!i)return 0;let{attrib:n}=i;switch(s){case v.ATTRSET:n|=r;break;case v.ATTRRESET:n&=~r;break;case v.ATTRPUT:n=r;break;default:return 0}return i.set({attrib:n}),1}function qu(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let s=1/0;for(const i of r.objects.keys())i>t&&i<s&&(s=i);return s===1/0?0:s}function Zu(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(!i)return 0;const n=s.objects.get(r);return n&&i.x+i.width>=n.x&&n.x+n.width>=i.x&&i.y+i.height>=n.y&&n.y+n.height>=i.y?1:0}function Ju(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[0].key:0}function Qu(e){const t=this.kernel.scenes.get(e)?.scene.order;return t&&t.length>0?t[t.length-1].key:0}function ed(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order,n=i.indexOf(s);return n<1?0:i[n-1].key}function td(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order,n=i.indexOf(s);return n>-1&&n<i.length-1?i[n+1].key:0}function rd(e,t){const r=t-1;if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene.order;return s&&r<s.length?s[r].key:0}function sd(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const n=r.order.indexOf(s);return n<0?0:n+1}function id(e,t,r){const s=r-1;if(s<0)return 0;const i=this.kernel.scenes.get(e)?.scene;if(!i)return 0;const n=i.objects.get(t);if(!n||n.type==="group")return 0;const a=i.order,l=[];for(let h=0;h<a.length;++h){const d=a[h];d!==n&&l.push(d),s===h&&l.push(n)}return s>=a.length&&l.push(n),i.set({order:l}),1}function nd(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order.filter(n=>n!==s);return i.unshift(s),r.set({order:i}),1}function od(e,t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;const s=r.objects.get(t);if(!s||s.type==="group")return 0;const i=r.order.filter(n=>n!==s);return i.push(s),r.set({order:i}),1}function cd(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(!i||i.type==="group")return 0;const n=s.objects.get(r);if(!n||n.type==="group")return 0;const a=s.order.slice(),l=a.indexOf(i);if(l<0)return 0;const h=a.indexOf(n);if(h<0)return 0;const d=a[l];return a[l]=a[h],a[h]=d,s.set({order:a}),1}function ei({kernel:e},t,r,s,i){const n=e.scenes.get(t);if(!n)return 0;const{matrix:a,scene:l}=n;if(a)for(let d=0;d<i.length;d+=2){const g=i[d+0],E=i[d+1],T=g*a[2]+E*a[5]+a[8];i[d+0]=(g*a[0]+E*a[3]+a[6])/T,i[d+1]=(g*a[1]+E*a[4]+a[7])/T}const h=l.line(i,{pen:l.pens.get(r),brush:l.brushes.get(s)});return l.set({order:l.order.concat(h)}),h.key}function ad(e,t,r,...s){return ei(this,e,t,r,s)}function ld(e,t,r,s,i){return ei(this,e,t,r,[s,i])}function hd(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const a=n.scene.objects.get(t);if(a?.type!=="line")return 0;let l=s,h=i;const d=n.matrix;if(d){const g=s*d[2]+i*d[5]+d[8];l=(s*d[0]+i*d[3]+d[6])/g,h=(s*d[1]+i*d[4]+d[7])/g}return a.addPoint({x:l,y:h},r)?1:0}function ud(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const a=n.scene.objects.get(t);if(a?.type!=="line")return 0;let l=s,h=i;const d=n.matrix;if(d){const g=s*d[2]+i*d[5]+d[8];l=(s*d[0]+i*d[3]+d[6])/g,h=(s*d[1]+i*d[4]+d[7])/g}return a.setPoint(r,{x:l,y:h})?1:0}function dd(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="line"&&s.removePoint(r)?1:0}function fd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"&&r.pen?.key||0}function gd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"&&r.brush?.key||0}function pd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="line"?r.length:0}function _d(e,t,r){const s=this.kernel.scenes.get(e);if(!s)return 0;const i=s.scene.objects.get(t),n=i?.type==="line"&&i.point(r);if(!n)return 0;const{x:a,y:l}=n,h=s.invmatrix;if(!h)return a;const d=a*h[2]+l*h[5]+h[8];return(a*h[0]+l*h[3]+h[6])/d}function Ed(e,t,r){const s=this.kernel.scenes.get(e);if(!s)return 0;const i=s.scene.objects.get(t),n=i?.type==="line"&&i.point(r);if(!n)return 0;const{x:a,y:l}=n,h=s.invmatrix;if(!h)return l;const d=a*h[2]+l*h[5]+h[8];return(a*h[1]+l*h[4]+h[7])/d}function md(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="line"&&i.set({brush:s.brushes.get(r)??null})?1:0}function Td(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);return i?.type==="line"&&i.set({pen:s.pens.get(r)??null})?1:0}function wd(e,t,r,s,i,n,a,l){const h=this.kernel.scenes.get(e)?.scene.objects.get(t);if(h?.type!=="line")return 0;const d={angle:r,length:s,fill:!!i},g={angle:n,length:a,fill:!!l};return h.set({start:g,end:d}),1}function yd(e,...t){const r=this.kernel.scenes.get(e)?.scene;if(!r)return 0;let s=!0;const i=t.map(n=>{const a=r.objects.get(n);return(!a||a.parent)&&(s=!1),a});return s?r.group(i).key:0}function bd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type!=="group"?0:(r.set({children:[]}).delete(),1)}function Rd(e,t,r){if(t===r)return 0;const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;const n=s.objects.get(r);if(!n||n.parent)return 0;if(n.type==="group"){let a=i;for(;a=a.parent;)if(a===n)return 0}return i.set({children:i.children.concat(n)}),1}function Od(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;const n=s.objects.get(r);return n?.parent!==i?0:(i.set({children:i.children.filter(a=>a!==n)}),1)}function Md(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="group"?r.children.length:0}function Sd(e,t,r){if(r<0)return 0;const s=this.kernel.scenes.get(e)?.scene.objects.get(t);if(s?.type!=="group")return 0;const i=s.children;return r<i.length?i[r].key:0}function Nd(e,t){return this.kernel.scenes.get(e)?.scene.objects.get(t)?.parent?.key??0}function Id(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.objects.get(t);if(i?.type!=="group")return 0;for(let n=0;n<i.children.length;++n){const a=i.children[n];if(a.key===r)return n+1;if(a.type==="group"){for(const l of a.descendants())if(l.key===r)return n+1}}return 0}function ti({kernel:e},t,r,s,i,n){const a=e.scenes.get(t);if(!a)return 0;const l=a.scene,h=(n?l.imagesOpaque:l.images).get(r);if(!h)return 0;let d=s,g=i;const E=a.matrix;if(E){const m=s*E[2]+i*E[5]+E[8];d=(s*E[0]+i*E[3]+E[6])/m,g=(s*E[1]+i*E[4]+E[7])/m}const T=l.imageView(h,{x:d,y:g,opaque:n});return l.set({order:l.order.concat(T)}),T.key}function Ad(e,t,r,s){return ti(this,e,t,r,s,!0)}function vd(e,t,r,s){return ti(this,e,t,r,s)}function xd(e,t,r,s,i,n,a,l,h,d){const g=this.kernel.scenes.get(e)?.scene.objects.get(t);if(g?.type!=="imageView")return r[s]=0,i[n]=0,a[l]=0,h[d]=0,0;const E=g.area;return r[s]=E?.x??0,i[n]=E?.y??0,a[l]=E?.w??g.image.width,h[d]=E?.h??g.image.height,1}function Pd(e,t,r,s,i,n){const a=this.kernel.scenes.get(e)?.scene.objects.get(t);return a?.type==="imageView"&&a.set({area:{x:r,y:s,w:i,h:n}})?1:0}function Dd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="imageView"&&r.opaque&&r.image.key||0}function kd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="imageView"&&!r.opaque&&r.image.key||0}function Ld(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.imagesOpaque.get(r);if(!i)return 0;const n=s.objects.get(t);return n?.type==="imageView"&&n.opaque&&n.set({image:i})?1:0}function Cd(e,t,r){const s=this.kernel.scenes.get(e)?.scene;if(!s)return 0;const i=s.images.get(r);if(!i)return 0;const n=s.objects.get(t);return n?.type==="imageView"&&!n.opaque&&n.set({image:i})?1:0}function Gd(e,t,r,s,i){const n=this.kernel.scenes.get(e);if(!n)return 0;const a=n.scene,l=a.texts.get(t);if(!l)return 0;let h=r,d=s;const g=n.matrix;if(g){const T=r*g[2]+s*g[5]+g[8];h=(r*g[0]+s*g[3]+g[6])/T,d=(r*g[1]+s*g[4]+g[7])/T}const E=a.textView(l,{x:h,y:d,angle:i});return a.set({order:a.order.concat(E)}),E.key}function Bd(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="textView"&&r.text.key||0}function Fd(e){return this.kernel._functionNotImplemented("emptySpace2d",this),0}function Wd(e){e("GetSpaceOrg2dx",{a:[c],r:o},gh),e("GetSpaceOrg2dy",{a:[c],r:o},ph),e("SetSpaceOrg2d",{a:[c,o,o],r:o},_h),e("EmptySpace2d",{a:[c],r:o},Fd),e("GetScaleSpace2d",{a:[c],r:o},Eh),e("SetScaleSpace2d",{a:[c,o],r:o},mh),e("SaveRectArea2d",{a:[c,_,o,o,o,o,o],r:o},Th),e("GetBkBrush2d",{a:[c],r:c},wh),e("SetBkBrush2d",{a:[c,c],r:o},yh),e("LockSpace2d",{a:[c,o],r:o},bh),e("GetSpaceLayers2d",{a:[c],r:o},Rh),e("SetSpaceLayers2d",{a:[c,o],r:o},Oh),e("SetSpaceRenderEngine2d",{a:[c,o],r:o},Mh),e("CreatePen2d",{a:[c,o,o,X,o],r:c},Sh),e("GetPenColor2d",{a:[c,c],r:X},Nh),e("GetPenRop2d",{a:[c,c],r:o},Ih),e("GetPenStyle2d",{a:[c,c],r:o},Ah),e("GetPenWidth2d",{a:[c,c],r:o},vh),e("SetPenColor2d",{a:[c,c,X],r:o},xh),e("SetPenRop2d",{a:[c,c,o],r:o},Ph),e("SetPenStyle2d",{a:[c,c,o],r:o},Dh),e("SetPenWidth2d",{a:[c,c,o],r:o},kh),e("CreateBrush2d",{a:[c,o,o,X,c,o],r:c},Lh),e("GetBrushColor2d",{a:[c,c],r:X},Ch),e("GetBrushRop2d",{a:[c,c],r:o},Gh),e("GetBrushStyle2d",{a:[c,c],r:o},Bh),e("GetBrushHatch2d",{a:[c,c],r:o},Fh),e("GetBrushDib2d",{a:[c,c],r:c},Wh),e("SetBrushColor2d",{a:[c,c,X],r:o},Uh),e("SetBrushRop2d",{a:[c,c,o],r:o},Vh),e("SetBrushStyle2d",{a:[c,c,o],r:o},$h),e("SetBrushHatch2d",{a:[c,c,o],r:o},jh),e("SetBrushDib2d",{a:[c,c,c],r:o},Hh),e("CreateFont2d",{a:[c,_,o,o],r:c},Xh),e("CreateFont2dpt",{a:[c,_,o,o],r:c},Yh),e("GetFontName2d",{a:[c,c],r:_},zh),e("GetFontSize2d",{a:[c,c],r:o},Kh),e("GetFontStyle2d",{a:[c,c],r:o},qh),e("SetFontName2d",{a:[c,c,_],r:o},Zh),e("SetFontSize2d",{a:[c,c,o],r:o},Jh),e("SetFontStyle2d",{a:[c,c,o],r:o},Qh),e("CreateString2d",{a:[c,_],r:c},eu),e("GetString2d",{a:[c,c],r:_},tu),e("SetString2d",{a:[c,c,_],r:o},ru),e("CreateText2d",{a:[c,c,c,X,X],r:c},su),e("GetTextCount2d",{a:[c,c],r:o},iu),e("GetTextFont2d",{a:[c,c],r:c},Hs),e("GetTextFont2d",{a:[c,c,o],r:c},Hs),e("GetTextString2d",{a:[c,c],r:c},Xs),e("GetTextString2d",{a:[c,c,o],r:c},Xs),e("GetTextFgColor2d",{a:[c,c],r:X},Ys),e("GetTextFgColor2d",{a:[c,c,o],r:X},Ys),e("GetTextBkColor2d",{a:[c,c],r:X},zs),e("GetTextBkColor2d",{a:[c,c,o],r:X},zs),e("SetText2d",{a:[c,c,c,c,X,X],r:o},nu),e("SetText2d",{a:[c,c,o,c,c,X,X],r:o},Ks),e("SetTextFont2d",{a:[c,c,o,c],r:o},ou),e("SetTextString2d",{a:[c,c,o,c],r:o},cu),e("SetTextFgColor2d",{a:[c,c,o,X],r:o},au),e("SetTextBkColor2d",{a:[c,c,o,X],r:o},lu),e("AddText2d",{a:[c,c,c,c,X,X],r:o},hu),e("AddText2d",{a:[c,c,o,c,c,X,X],r:o},qs),e("RemoveText2d",{a:[c,c,o],r:o},uu),e("CreateDib2d",{a:[c,_],r:c},Js),e("CreateRDib2d",{a:[c,_],r:c},Js),e("CreateDoubleDib2d",{a:[c,_],r:c},Qs),e("CreateRDoubleDIB2d",{a:[c,_],r:c},Qs),e("GetDibPixel2d",{a:[c,c,o,o],r:X},du),e("SetDibPixel2d",{a:[c,c,o,o,X],r:o},fu),e("DeleteTool2d",{a:[c,o,c],r:o},gu),e("GetNextTool2d",{a:[c,o,c],r:c},pu),e("GetToolRef2d",{a:[c,o,c],r:o},_u),e("Rgb",{a:[o,o,o],r:X},Eu),e("RgbEx",{a:[o,o,o,o],r:X},mu),e("Rgbf",{a:[o],r:X},Tu),e("GetRValue",{a:[X],r:o},wu),e("GetGValue",{a:[X],r:o},yu),e("GetBValue",{a:[X],r:o},bu),e("CreateObjectFromFile2d",{a:[c,_,o,o,o],r:c},Ru),e("DeleteObject2d",{a:[c,c],r:o},Ou),e("GetObjectType2d",{a:[c,c],r:o},Mu),e("GetObjectName2d",{a:[c,c],r:_},Su),e("SetObjectName2d",{a:[c,c,_],r:o},Nu),e("GetObject2dByName",{a:[c,c,_],r:c},Iu),e("GetObjectOrg2dx",{a:[c,c],r:o},Au),e("GetObjectOrg2dy",{a:[c,c],r:o},vu),e("SetObjectOrg2d",{a:[c,c,o,o],r:o},xu),e("GetObjectWidth2d",{a:[c,c],r:o},Pu),e("GetObjectHeight2d",{a:[c,c],r:o},Du),e("SetObjectSize2d",{a:[c,c,o,o],r:o},ku),e("GetActualWidth2d",{a:[c,c],r:o},Lu),e("GetActualHeight2d",{a:[c,c],r:o},Cu),e("GetActualSize2d",{a:[c,c,I,I],r:o},Gu),e("GetObjectAngle2d",{a:[c,c],r:o},Bu),e("RotateObject2d",{a:[c,c,o,o,o],r:o},Fu),e("SetShowObject2d",{a:[c,c,o],r:o},Wu),e("ShowObject2d",{a:[c,c]},Uu),e("HideObject2d",{a:[c,c]},Vu),e("GetObjectFromPoint2d",{a:[c,o,o],r:c},$u),e("GetLastPrimary2d",{r:c},ju),e("CopyToClipboard2d",{a:[c,c],r:o},Hu),e("PasteFromClipboard2d",{a:[c,o,o,o],r:c},Xu),e("LockObject2d",{a:[c,c,o],r:o},Yu),e("GetObjectAttribute2d",{a:[c,c],r:o},zu),e("SetObjectAttribute2d",{a:[c,c,o,o],r:o},Ku),e("GetNextObject2d",{a:[c,c],r:c},qu),e("IsObjectsIntersect2d",{a:[c,c,c,o],r:o},Zu),e("GetBottomObject2d",{a:[c],r:c},Ju),e("GetTopObject2d",{a:[c],r:c},Qu),e("GetLowerObject2d",{a:[c,c],r:c},ed),e("GetUpperObject2d",{a:[c,c],r:c},td),e("GetObjectFromZOrder2d",{a:[c,o],r:c},rd),e("GetZOrder2d",{a:[c,c],r:o},sd),e("SetZOrder2d",{a:[c,c,o],r:o},id),e("ObjectToBottom2d",{a:[c,c],r:o},nd),e("ObjectToTop2d",{a:[c,c],r:o},od),e("SwapObject2d",{a:[c,c,c],r:o},cd),e("CreatePolyLine2d",{a:[c,c,c],rest:[o,o],r:c},ad),e("CreateLine2d",{a:[c,c,c,o,o],r:c},ld),e("AddPoint2d",{a:[c,c,o,o,o],r:o},hd),e("SetVectorPoint2d",{a:[c,c,o,o,o],r:o},ud),e("DelPoint2d",{a:[c,c,o],r:o},dd),e("GetPenObject2d",{a:[c,c],r:c},fd),e("GetBrushObject2d",{a:[c,c],r:c},gd),e("GetVectorNumPoints2d",{a:[c,c],r:o},pd),e("GetVectorPoint2dx",{a:[c,c,o],r:o},_d),e("GetVectorPoint2dy",{a:[c,c,o],r:o},Ed),e("SetBrushObject2d",{a:[c,c,c],r:c},md),e("SetPenObject2d",{a:[c,c,c],r:c},Td),e("SetLineArrows2d",{a:[c,c,o,o,o,o,o,o],r:o},wd),e("CreateGroup2d",{a:[c],rest:[c],r:c},yd),e("DeleteGroup2d",{a:[c,c],r:o},bd),e("AddGroupItem2d",{a:[c,c,c],r:o},Rd),e("DelGroupItem2d",{a:[c,c,c],r:o},Od),e("GetGroupItemsNum2d",{a:[c,c],r:o},Md),e("GetGroupItem2d",{a:[c,c,o],r:c},Sd),e("GetObjectParent2d",{a:[c,c],r:c},Nd),e("IsGroupContainObject2d",{a:[c,c,c],r:o},Id),e("CreateBitmap2d",{a:[c,c,o,o],r:c},Ad),e("CreateDoubleBitmap2d",{a:[c,c,o,o],r:c},vd),e("GetBitmapSrcRect2d",{a:[c,c,I,I,I,I],r:o},xd),e("SetBitmapSrcRect2d",{a:[c,c,o,o,o,o],r:o},Pd),e("GetDibObject2d",{a:[c,c],r:c},Dd),e("GetDDibObject2d",{a:[c,c],r:c},kd),e("SetDibObject2d",{a:[c,c,c],r:o},Ld),e("SetDDibObject2d",{a:[c,c,c],r:o},Cd),e("CreateRasterText2d",{a:[c,c,o,o,o],r:c},Gd),e("GetTextObject2d",{a:[c,c],r:c},Bd)}const Ud={name:"graphics2d",deps:["windows","streams"],register:Wd};var ri=1e-6,fe=typeof Float32Array<"u"?Float32Array:Array;function Bt(){var e=new fe(9);return fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function si(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function oe(){var e=new fe(16);return fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Vd(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ii(e,t){if(e===t){var r=t[1],s=t[2],i=t[3],n=t[6],a=t[7],l=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=n,e[11]=t[14],e[12]=i,e[13]=a,e[14]=l}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function ni(e,t){var r=t[0],s=t[1],i=t[2],n=t[3],a=t[4],l=t[5],h=t[6],d=t[7],g=t[8],E=t[9],T=t[10],m=t[11],O=t[12],N=t[13],y=t[14],P=t[15],C=r*l-s*a,L=r*h-i*a,W=r*d-n*a,F=s*h-i*l,G=s*d-n*l,D=i*d-n*h,x=g*N-E*O,j=g*y-T*O,Z=g*P-m*O,Q=E*y-T*N,ue=E*P-m*N,le=T*P-m*y,J=C*le-L*ue+W*Q+F*Z-G*j+D*x;return J?(J=1/J,e[0]=(l*le-h*ue+d*Q)*J,e[1]=(i*ue-s*le-n*Q)*J,e[2]=(N*D-y*G+P*F)*J,e[3]=(T*G-E*D-m*F)*J,e[4]=(h*Z-a*le-d*j)*J,e[5]=(r*le-i*Z+n*j)*J,e[6]=(y*W-O*D-P*L)*J,e[7]=(g*D-T*W+m*L)*J,e[8]=(a*ue-l*Z+d*x)*J,e[9]=(s*Z-r*ue-n*x)*J,e[10]=(O*G-N*W+P*C)*J,e[11]=(E*W-g*G-m*C)*J,e[12]=(l*j-a*Q-h*x)*J,e[13]=(r*Q-s*j+i*x)*J,e[14]=(N*L-O*F-y*C)*J,e[15]=(g*F-E*L+T*C)*J,e):null}function $d(e,t,r){var s=t[0],i=t[1],n=t[2],a=t[3],l=t[4],h=t[5],d=t[6],g=t[7],E=t[8],T=t[9],m=t[10],O=t[11],N=t[12],y=t[13],P=t[14],C=t[15],L=r[0],W=r[1],F=r[2],G=r[3];return e[0]=L*s+W*l+F*E+G*N,e[1]=L*i+W*h+F*T+G*y,e[2]=L*n+W*d+F*m+G*P,e[3]=L*a+W*g+F*O+G*C,L=r[4],W=r[5],F=r[6],G=r[7],e[4]=L*s+W*l+F*E+G*N,e[5]=L*i+W*h+F*T+G*y,e[6]=L*n+W*d+F*m+G*P,e[7]=L*a+W*g+F*O+G*C,L=r[8],W=r[9],F=r[10],G=r[11],e[8]=L*s+W*l+F*E+G*N,e[9]=L*i+W*h+F*T+G*y,e[10]=L*n+W*d+F*m+G*P,e[11]=L*a+W*g+F*O+G*C,L=r[12],W=r[13],F=r[14],G=r[15],e[12]=L*s+W*l+F*E+G*N,e[13]=L*i+W*h+F*T+G*y,e[14]=L*n+W*d+F*m+G*P,e[15]=L*a+W*g+F*O+G*C,e}function jd(e,t,r){var s=r[0],i=r[1],n=r[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Hd(e,t,r){var s=r[0],i=r[1],n=r[2],a=Math.sqrt(s*s+i*i+n*n),l,h,d;return a<ri?null:(a=1/a,s*=a,i*=a,n*=a,l=Math.sin(t),h=Math.cos(t),d=1-h,e[0]=s*s*d+h,e[1]=i*s*d+n*l,e[2]=n*s*d-i*l,e[3]=0,e[4]=s*i*d-n*l,e[5]=i*i*d+h,e[6]=n*i*d+s*l,e[7]=0,e[8]=s*n*d+i*l,e[9]=i*n*d-s*l,e[10]=n*n*d+h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function br(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function oi(e,t){var r=t[0],s=t[1],i=t[2],n=t[4],a=t[5],l=t[6],h=t[8],d=t[9],g=t[10];return e[0]=Math.sqrt(r*r+s*s+i*i),e[1]=Math.sqrt(n*n+a*a+l*l),e[2]=Math.sqrt(h*h+d*d+g*g),e}function Xd(e,t){var r=new fe(3);oi(r,t);var s=1/r[0],i=1/r[1],n=1/r[2],a=t[0]*s,l=t[1]*i,h=t[2]*n,d=t[4]*s,g=t[5]*i,E=t[6]*n,T=t[8]*s,m=t[9]*i,O=t[10]*n,N=a+g+O,y=0;return N>0?(y=Math.sqrt(N+1)*2,e[3]=.25*y,e[0]=(E-m)/y,e[1]=(T-h)/y,e[2]=(l-d)/y):a>g&&a>O?(y=Math.sqrt(1+a-g-O)*2,e[3]=(E-m)/y,e[0]=.25*y,e[1]=(l+d)/y,e[2]=(T+h)/y):g>O?(y=Math.sqrt(1+g-a-O)*2,e[3]=(T-h)/y,e[0]=(l+d)/y,e[1]=.25*y,e[2]=(E+m)/y):(y=Math.sqrt(1+O-a-g)*2,e[3]=(l-d)/y,e[0]=(T+h)/y,e[1]=(E+m)/y,e[2]=.25*y),e}function ci(e,t,r,s){var i=t[0],n=t[1],a=t[2],l=t[3],h=i+i,d=n+n,g=a+a,E=i*h,T=i*d,m=i*g,O=n*d,N=n*g,y=a*g,P=l*h,C=l*d,L=l*g,W=s[0],F=s[1],G=s[2];return e[0]=(1-(O+y))*W,e[1]=(T+L)*W,e[2]=(m-C)*W,e[3]=0,e[4]=(T-L)*F,e[5]=(1-(E+y))*F,e[6]=(N+P)*F,e[7]=0,e[8]=(m+C)*G,e[9]=(N-P)*G,e[10]=(1-(E+O))*G,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function Yd(e,t,r,s,i){var n=1/Math.tan(t/2);if(e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0){var a=1/(s-i);e[10]=(i+s)*a,e[14]=2*i*s*a}else e[10]=-1,e[14]=-2*s;return e}var zd=Yd;function Kd(e,t,r,s){var i=t[0],n=t[1],a=t[2],l=s[0],h=s[1],d=s[2],g=i-r[0],E=n-r[1],T=a-r[2],m=g*g+E*E+T*T;m>0&&(m=1/Math.sqrt(m),g*=m,E*=m,T*=m);var O=h*T-d*E,N=d*g-l*T,y=l*E-h*g;return m=O*O+N*N+y*y,m>0&&(m=1/Math.sqrt(m),O*=m,N*=m,y*=m),e[0]=O,e[1]=N,e[2]=y,e[3]=0,e[4]=E*y-T*N,e[5]=T*O-g*y,e[6]=g*N-E*O,e[7]=0,e[8]=g,e[9]=E,e[10]=T,e[11]=0,e[12]=i,e[13]=n,e[14]=a,e[15]=1,e}var Ae=$d;function ee(){var e=new fe(3);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function qd(e){var t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)}function ae(e,t,r){var s=new fe(3);return s[0]=e,s[1]=t,s[2]=r,s}function ai(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Oe(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e}function Zd(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function Jd(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function Qd(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function ef(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function tf(e,t){var r=t[0]-e[0],s=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+s*s+i*i)}function rf(e,t){var r=t[0]-e[0],s=t[1]-e[1],i=t[2]-e[2];return r*r+s*s+i*i}function sf(e){var t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s}function Ft(e,t){var r=t[0],s=t[1],i=t[2],n=r*r+s*s+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function ke(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Qe(e,t,r){var s=t[0],i=t[1],n=t[2],a=r[0],l=r[1],h=r[2];return e[0]=i*h-n*l,e[1]=n*a-s*h,e[2]=s*l-i*a,e}function Le(e,t,r){var s=t[0],i=t[1],n=t[2],a=r[3]*s+r[7]*i+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*s+r[4]*i+r[8]*n+r[12])/a,e[1]=(r[1]*s+r[5]*i+r[9]*n+r[13])/a,e[2]=(r[2]*s+r[6]*i+r[10]*n+r[14])/a,e}function nf(e,t){var r=e[0],s=e[1],i=e[2],n=t[0],a=t[1],l=t[2],h=Math.sqrt((r*r+s*s+i*i)*(n*n+a*a+l*l)),d=h&&ke(e,t)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var ft=Jd,of=Qd,cf=tf,Rr=rf,af=qd,li=sf;(function(){var e=ee();return function(t,r,s,i,n,a){var l,h;for(r||(r=3),s||(s=0),i?h=Math.min(i*r+s,t.length):h=t.length,l=s;l<h;l+=r)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],n(e,e,a),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2];return t}})();function lf(){var e=new fe(4);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function gt(e,t,r,s){var i=new fe(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=s,i}function Or(e,t,r,s,i){return e[0]=t,e[1]=r,e[2]=s,e[3]=i,e}function hf(e,t){var r=t[0],s=t[1],i=t[2],n=t[3],a=r*r+s*s+i*i+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=s*a,e[2]=i*a,e[3]=n*a,e}(function(){var e=lf();return function(t,r,s,i,n,a){var l,h;for(r||(r=4),s||(s=0),i?h=Math.min(i*r+s,t.length):h=t.length,l=s;l<h;l+=r)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],e[3]=t[l+3],n(e,e,a),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2],t[l+3]=e[3];return t}})();function pt(){var e=new fe(4);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function uf(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function df(e,t,r){r=r*.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e}function ff(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],a=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h+a*l,e[1]=i*h+n*l,e[2]=n*h-i*l,e[3]=a*h-s*l,e}function gf(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],a=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h-n*l,e[1]=i*h+a*l,e[2]=n*h+s*l,e[3]=a*h-i*l,e}function pf(e,t,r){r*=.5;var s=t[0],i=t[1],n=t[2],a=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h+i*l,e[1]=i*h-s*l,e[2]=n*h+a*l,e[3]=a*h-n*l,e}function Mr(e,t,r,s){var i=t[0],n=t[1],a=t[2],l=t[3],h=r[0],d=r[1],g=r[2],E=r[3],T,m,O,N,y;return m=i*h+n*d+a*g+l*E,m<0&&(m=-m,h=-h,d=-d,g=-g,E=-E),1-m>ri?(T=Math.acos(m),O=Math.sin(T),N=Math.sin((1-s)*T)/O,y=Math.sin(s*T)/O):(N=1-s,y=s),e[0]=N*i+y*h,e[1]=N*n+y*d,e[2]=N*a+y*g,e[3]=N*l+y*E,e}function _f(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var n=(i+1)%3,a=(i+2)%3;s=Math.sqrt(t[i*3+i]-t[n*3+n]-t[a*3+a]+1),e[i]=.5*s,s=.5/s,e[3]=(t[n*3+a]-t[a*3+n])*s,e[n]=(t[n*3+i]+t[i*3+n])*s,e[a]=(t[a*3+i]+t[i*3+a])*s}return e}var Ef=Or,Sr=hf;(function(){var e=ee(),t=ae(1,0,0),r=ae(0,1,0);return function(s,i,n){var a=ke(i,n);return a<-.999999?(Qe(e,t,i),af(e)<1e-6&&Qe(e,r,i),Ft(e,e),df(s,e,Math.PI),s):a>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(Qe(e,i,n),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+a,Sr(s,s))}})(),(function(){var e=pt(),t=pt();return function(r,s,i,n,a,l){return Mr(e,s,a,l),Mr(t,i,n,l),Mr(r,e,t,2*l*(1-l)),r}})(),(function(){var e=Bt();return function(t,r,s,i){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],Sr(t,_f(t,e))}})();function mf(e,t,r){const s=[],i=Math.ceil(r/8);e.font=t;let n=0;const a=i,l=i,h=i,d=i;let g=0;for(let m=0;m<16;++m){let O=0;for(let N=0;N<16;++N){const y=m*16+N,P=_e[y],{width:C}=e.measureText(P),L=r;s.push({x:O+h,y:g+a,w:C,h:L,asc:a,desc:l,left:h,right:d}),O+=h+Math.ceil(C)+d}g+=a+r+l,n=Math.max(n,O)}return{font:t,fontSize:r,glyphRects:s,width:n,height:g}}function Tf(e,{font:t,glyphRects:r,height:s,width:i}){e.canvas.width=i,e.canvas.height=s,e.font=t,e.fillStyle="white",e.textAlign="left",e.textBaseline="top",e.fontKerning="none",r.forEach(({x:n,y:a},l)=>{e.fillText(_e[l],n,a)})}const wf=2,yf=0,bf=1,Rf=2,Of=3,Mf=4,Sf=5,Nf=6,If=7,Af=8,vf=9,xf=0,_t=1,Pf=2,Df=1,kf=2,Lf=3,hi=4,Cf=5,Gf=6,Bf=0,Ff=1,Wf=0,ui=1,Wt=0,Et=1,Ut=2,Uf=0,Vf=1,$f=2,Vt=0,$t=1,mt=2;class Nr{constructor(t){this.objectsGenerator=t,this.list=new WeakMap,this.cur=null}get(t){const{cur:r}=this;if(r&&r.ctx===t)return r;const s=this.list.get(t);if(s)return this.cur=s;const i=this.objectsGenerator(t);return this.list.set(t,this.cur=i),i}}function Tt(e,t,r){const s=e.createShader(t);if(e.shaderSource(s,r),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){console.log(r.split(`
`).map((a,l)=>`${l+1}: ${a}`).join(`
`));const n=e.getShaderInfoLog(s);throw Error(`Ошибка компиляции шейдера (${t===e.VERTEX_SHADER?"vertex":"fragment"}): ${n}`)}return s}function Ir(e,t,r){const s=e.getUniformLocation(t,r);if(!s)throw Error(`Программа не содержит Uniform '${r}'`);return s}class jf{constructor(){this.entries=new Map}add(t,r,s){let i=this.entries.get(t);i||this.entries.set(t,i=new Map);let n=i.get(r);n?n.push(s):i.set(r,n=[s])}filterInline(t){this.entries.forEach((r,s)=>{r.forEach((i,n)=>{const a=i.filter(t);a.length?r.set(n,a):r.delete(n)}),r.size||this.entries.delete(s)})}}var Hf=`precision mediump float;
#ifdef UV
uniform sampler2D uTexture;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){
#ifndef GOURAUD
vec4 vLightColor4=vec4(1,1,1,1);
#endif
#ifdef UV
gl_FragColor=texture2D(uTexture,vTexCoord)*vLightColor4;
#else
gl_FragColor=vLightColor4;
#endif
}`,Xf=`uniform mat4 uMVP4;
#ifdef GOURAUD
uniform vec3 uWorldLightPos;uniform mat4 uWorldMat4;uniform mat3 uWorldNormalMat;uniform vec3 uAmbientColor;uniform vec4 uTechDiffuseColor4;
#endif
attribute vec4 aPos4;
#ifdef GOURAUD
attribute vec3 aNormal;
#endif
#ifdef UV
attribute vec2 aUv;
#endif
#ifdef GOURAUD
varying vec4 vLightColor4;
#endif
#ifdef UV
varying vec2 vTexCoord;
#endif
void main(){gl_Position=uMVP4*aPos4;
#ifdef GOURAUD
vec3 lightDir=normalize(uWorldLightPos-(uWorldMat4*aPos4).xyz);vec3 worldNormal=normalize(uWorldNormalMat*aNormal);vec3 uLightDiffuse=vec3(1,1,1);float uLightPower=1.;vec3 diffuse=uLightDiffuse*uLightPower*max(dot(worldNormal,lightDir),.0);vec3 GI=uAmbientColor+(uTechDiffuseColor4.rgb*diffuse);vLightColor4=vec4(GI,uTechDiffuseColor4.a);
#endif
#ifdef UV
vTexCoord=aUv;
#endif
}`;let jt=-1;const et=[{usesUV:!1,shadingMode:-1,index:++jt},{usesUV:!1,shadingMode:_t,index:++jt},{usesUV:!0,shadingMode:-1,index:++jt},{usesUV:!0,shadingMode:_t,index:++jt}],di={usesUV:!0,shadingMode:-1,index:-1};class fi{constructor(t,r,s,i){this.ctx=t,this.shaderProgram=r,this.hasNormalsSupport=s,this.hasUVSupport=i,this._activeTech=null,this._activeVAO=null}use(){const{ctx:t}=this;t._activeProgram!==this&&(t._setActiveProgram(this),t.gl.useProgram(this.shaderProgram),this._activeTech=null,this._activeVAO=null,++t.stats.switchesProgram,this.init())}_setActiveTech(t){this._activeTech=t}_setActiveVAO(t){this._activeVAO=t}}const gi=et.map(({usesUV:e,shadingMode:t})=>{const r=[];return e&&r.push("UV"),r.push(t===_t?"GOURAUD":t===Pf?"PHONG":t===xf?"FLAT":"NO_SHADING"),r.map(s=>`#define ${s}
`).join("")}),Yf=gi.map(e=>e+Xf),zf=gi.map(e=>e+Hf),Kf=ee();class pi extends fi{constructor(t,r,s,i){const{gl:n}=t,a=n.createProgram();if(n.attachShader(a,s),n.attachShader(a,i),n.bindAttribLocation(a,Vt,"aPos4"),n.bindAttribLocation(a,$t,"aNormal"),n.bindAttribLocation(a,mt,"aUv"),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS)){const d=n.getProgramInfoLog(a);throw Error(`Ошибка Link Program: ${d}`)}const l=r.shadingMode>-1;super(t,a,l,r.usesUV),this.caps=r,this.uTechDiffuseColor4=null,this.uAmbientColor=null,this.uWorldLightPos=null,this.uWorldMat4=null,this.uWorldNormalMat=null;const h=Ir.bind(null,n,a);this.uVMP4=h("uMVP4"),l&&(this.uTechDiffuseColor4=h("uTechDiffuseColor4"),this.uWorldLightPos=h("uWorldLightPos"),this.uWorldMat4=h("uWorldMat4"),this.uWorldNormalMat=h("uWorldNormalMat"),this.uAmbientColor=h("uAmbientColor")),this.gl=n}init(){this.hasNormalsSupport&&this.gl.uniform3fv(this.uWorldLightPos,this.ctx._lightPosition)}setMVPMatrix(t){this.gl.uniformMatrix4fv(this.uVMP4,!1,t)}setNormalMatrix(t,r){const{gl:s}=this;s.uniformMatrix4fv(this.uWorldMat4,!1,t),s.uniformMatrix3fv(this.uWorldNormalMat,!1,r)}setDiffuse(t){this.gl.uniform4fv(this.uTechDiffuseColor4,t)}setAmbient(t){this.gl.uniform3fv(this.uAmbientColor,of(Kf,this.ctx._ambientColor,t))}useTexture(){}}var qf="precision mediump float;varying vec2 tCoord;uniform vec4 color;uniform bool useTexture;uniform sampler2D tex;void main(){gl_FragColor=useTexture ? texture2D(tex,tCoord)*color : color;}",Zf="attribute vec2 v;attribute vec2 uv;uniform vec4 p;uniform vec4 uvRect;varying vec2 tCoord;void main(){gl_Position=vec4((p.x+p.z*v.x)*2.-1.,(-p.y+p.w*v.y)*2.+1.,0,1);tCoord=vec2(uvRect.x+uvRect.z*uv.x,uvRect.y+uvRect.w*uv.y);}";class Jf extends fi{constructor(t){const{gl:r}=t,s=Tt(r,r.VERTEX_SHADER,Zf),i=Tt(r,r.FRAGMENT_SHADER,qf),n=r.createProgram();if(r.attachShader(n,s),r.attachShader(n,i),r.bindAttribLocation(n,Vt,"v"),r.bindAttribLocation(n,mt,"uv"),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){const l=r.getProgramInfoLog(n);throw Error(`Ошибка Link Program: ${l}`)}super(t,n,!1,!0),this.textureInUse=!1;const a=Ir.bind(null,r,n);this.uPos=a("p"),this.uUVRect=a("uvRect"),this.uColor=a("color"),this.uUseTexture=a("useTexture"),this.gl=t.gl}setColor(t){this.gl.uniform4fv(this.uColor,t)}setPositionAndScale(t,r,s,i){this.gl.uniform4f(this.uPos,t,r,s,i)}setUVRect(t){this.gl.uniform4fv(this.uUVRect,t)}useTexture(t){this.textureInUse!==t&&(this.textureInUse=t,this.gl.uniform1f(this.uUseTexture,+t))}init(){}}var Qf="precision mediump float;uniform sampler2D uTexture;uniform vec4 uTextColor;varying vec2 vTexCoord;void main(){float alpha=texture2D(uTexture,vTexCoord).a*uTextColor.a;gl_FragColor=vec4(uTextColor.rgb,alpha);}";class eg extends pi{constructor(t,r){const{gl:s}=t,i=Tt(s,s.FRAGMENT_SHADER,Qf);super(t,di,r,i),this.uTextColor=Ir(s,this.shaderProgram,"uTextColor")}setTextColor(t){this.gl.uniform4fv(this.uTextColor,t)}}class wt{use(t){const r=this.selectProgram(t);return r.use(),r._activeTech===this||(r._setActiveTech(this),this.apply(r),++t.stats.switchesTech),r}}class tg extends wt{constructor(t){super(),this.material=t,this.passVersion=-1,this.texture=null,this.programCaps=null,this.pass=t.techs[0].passes[0]}prepare(){const{pass:t}=this;if(this.passVersion===t._version)return;this.passVersion=t._version;const s=!!(this.texture=t._getDefaultTextureUnit()?.getTexture()||null),i=t.lightingEnabled?_t:0,n=et.find(a=>a.usesUV===s&&a.shadingMode===i);if(!n)throw Error(`Материал "${this.material.name}": программа с заданными требованиями (usesUV: ${s}, shadingMode: ${i}) не существует`);this.programCaps=n}hasOpacity(){const{pass:t}=this;return t.diffuse[3]<1}getProgramCaps(){return this.prepare(),this.programCaps}selectProgram(t){return this.prepare(),t.meshPrograms[this.programCaps.index]}apply(t){const{ctx:r}=t,{pass:s}=this;r.setDepthWrite(s.depthWrite),r.setDepthCheck(s.depthCheck),this.texture?.use(r),t.setDiffuse(s.diffuse),t.setAmbient(s.ambient)}}class rg extends wt{constructor(t){super(),this.material=t,this.pass=t.techs[0].passes[0]}selectProgram(t){return t.overlayProgram}apply(t){const{pass:r}=this,s=r._getDefaultTextureUnit()?.getTexture();s?(s.use(t.ctx),t.useTexture(!0)):t.useTexture(!1),t.setColor(r.diffuse)}}class sg extends wt{constructor(t,r){super(),this.fontTexture=t,this.colorSource=r}getProgramCaps(){return di}selectProgram(t){return t.textProgram}apply(t){this.fontTexture.use(t.ctx),t.setTextColor(this.colorSource.color)}}const ig=gt(0,0,1,1);class ng extends wt{constructor(t){super(),this.fontTexture=t}selectProgram(t){return t.overlayProgram}apply(t){this.fontTexture.use(t.ctx),t.useTexture(!0),t.setUVRect(ig)}}const Ar=Ze(0,0).getContext("2d",{alpha:!0});class og{constructor(t){this.fontName=t,this.cache=new Nr(this.genFontTexture.bind(this)),this.textOverlayRenderTech=null;const r=Math.round(150/72*20);this.glyphData=mf(Ar,`${r}px ${this.fontName}`,r)}genFontTexture(t){Tf(Ar,this.glyphData);const{gl:r}=t,s=r.createTexture();return t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ar.canvas),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),{ctx:t,texture:s}}use(t){t.setTexture(this.cache.get(t).texture)}getTextOverlayRenderTech(){return this.textOverlayRenderTech||(this.textOverlayRenderTech=new ng(this)),this.textOverlayRenderTech}}class cg{constructor(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesVAO=0,this.switchesFace=0,this.dcOpaque=0,this.dcTransparent=0,this.dcOverlay=0,this.dcTotal=0;const t=this;Object.defineProperty(window,"s",{configurable:!0,get(){return t}})}reset(){this.switchesProgram=0,this.switchesTech=0,this.switchesTexture=0,this.switchesFace=0,this.switchesVAO=0,this.dcOpaque=0,this.dcTransparent=0,this.dcTotal=0,this.dcOverlay=0}}class ag{constructor(t){this.gl=t,this.currentTexture=null,this.uvEnabled=!1,this.normalsEnabled=!1,this.backFacesInUse=!1,this.depthWrite=!0,this.depthCheck=!0,this.blendSFactor=WebGLRenderingContext.ONE,this.blendDFactor=WebGLRenderingContext.ZERO,this._ambientColor=ee(),this._lightPosition=ee(),this.stats=new cg,this._activeProgram=null,t.enable(t.CULL_FACE),t.enableVertexAttribArray(Vt),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.hasIndices32Support=!!t.getExtension("OES_element_index_uint");const r=Yf.map(n=>Tt(t,t.VERTEX_SHADER,n)),s=zf.map(n=>Tt(t,t.FRAGMENT_SHADER,n));this.meshPrograms=et.map((n,a)=>new pi(this,n,r[a],s[a]));const i=r[et.findIndex(n=>n.usesUV&&n.shadingMode<0)];this.textProgram=new eg(this,i),this.overlayProgram=new Jf(this)}_setActiveProgram(t){this._activeProgram=t}reset(){this.stats.reset()}setLighting(t,r){ai(this._ambientColor,t),ai(this._lightPosition,r),this._activeProgram?.init()}enableUV(){this.uvEnabled||(this.uvEnabled=!0,this.gl.enableVertexAttribArray(mt))}disableUV(){this.uvEnabled&&(this.uvEnabled=!1,this.gl.disableVertexAttribArray(mt))}enableNormals(){this.normalsEnabled||(this.normalsEnabled=!0,this.gl.enableVertexAttribArray($t))}disableNormals(){this.normalsEnabled&&(this.normalsEnabled=!1,this.gl.disableVertexAttribArray($t))}useBackFaces(t){if(this.backFacesInUse===t)return;this.backFacesInUse=t;const{gl:r}=this;r.frontFace(t?r.CW:r.CCW),++this.stats.switchesFace}setTexture(t){if(this.currentTexture===t)return;this.currentTexture=t;const{gl:r}=this;r.bindTexture(r.TEXTURE_2D,t),++this.stats.switchesTexture}setDepthWrite(t){this.depthWrite!==t&&(this.depthWrite=t,this.gl.depthMask(t))}setDepthCheck(t){if(this.depthCheck===t)return;this.depthCheck=t;const{gl:r}=this;r.depthFunc(t?r.LESS:r.ALWAYS)}setBlendFunc(t,r){this.blendSFactor===t&&this.blendDFactor===r||(this.blendSFactor=t,this.blendDFactor=r,this.gl.blendFunc(t,r))}}function ve(e){const t=e.split(" ").map(r=>parseFloat(r));return t.length===4&&!t.some(isNaN)?[t[0],t[1],t[2]-t[0],t[3]-t[1]]:null}function lg(e){const t=e.split(" ").slice(0,3).map(r=>parseFloat(r));return t.some(isNaN)?null:[...t,1]}class vr{constructor(t,r,s){this.o=t,this.type=r,this.overlay=null,this.parent=null,this.children=[],this.visible=!0,this.x=0,this.y=0,this.width=0,this.height=0,this.metricsMode=Wf,this.horAlign=Wt,this.horTextAlign=Wt,this.vertAlign=Uf,this.caption="",this.charHeight=12,this.spaceWidth=0,this.color=[1,1,1,1],this.material=null,this.uv=[0,0,1,1],this.uvTL=[0,0,1,1],this.uvTR=[0,0,1,1],this.uvBL=[0,0,1,1],this.uvBR=[0,0,1,1],this.uvL=[0,0,1,1],this.uvR=[0,0,1,1],this.uvT=[0,0,1,1],this.uvB=[0,0,1,1],this.borders=[0,0,0,0],this.textMesh=null,t.overlayElements.set(this.key=t.key(),this),this.name=s?.name??""}drawAt(t,r,s,i,n,a,l){const{visible:h,vertAlign:d,horAlign:g,metricsMode:E,x:T,y:m,width:O,height:N}=this;if(!h)return;const y=E===ui,P=(y?T/a:T)+(g===Ut?i:g===Et?i/2:0)+r,C=(y?m/l:m)+(d===$f?n:d===Vf?n/2:0)+s,L=y?O/a:O,W=y?N/l:N;this.draw(t,P,C,L,W,a,l),this.children.forEach(F=>F.drawAt(t,P,C,L,W,a,l))}setMetricsMode(t){return this.metricsMode=t,this}setChildren(t){return this.children.forEach(r=>r.parent=null),this.children=Array.from(new Set(t)),this.children.forEach(r=>r.parent=this),this}setVisible(t){return this.visible=t,this}setPosition(t,r){return this.x=t,this.y=r,this}setSize(t,r){return this.width=t,this.height=r,this}setAlignment(t,r){return this.horAlign=t,this.vertAlign=r,this}setCaption(t){return this.caption!==t&&(this.caption=t,this.textMesh=null),this}setColor(t,r,s,i){return this.color=[t,r,s,i],this}setMaterial(t){return this.material=t,this}setParam(t,r){switch(t){case"uv_coords":{const i=ve(r);i&&(this.uv=i);break}case"border_material":break;case"border_size":{const i=r.split(" ").map(n=>Math.max(parseInt(n),2));i.length===4&&!i.some(isNaN)&&(this.borders=i);break}case"border_topleft_uv":{const i=ve(r);i&&(this.uvTL=i);break}case"border_topright_uv":{const i=ve(r);i&&(this.uvTR=i);break}case"border_bottomleft_uv":{const i=ve(r);i&&(this.uvBL=i);break}case"border_bottomright_uv":{const i=ve(r);i&&(this.uvBR=i);break}case"border_left_uv":{const i=ve(r);i&&(this.uvL=i);break}case"border_right_uv":{const i=ve(r);i&&(this.uvR=i);break}case"border_top_uv":{const i=ve(r);i&&(this.uvT=i);break}case"border_bottom_uv":{const i=ve(r);i&&(this.uvB=i);break}case"font_name":break;case"alignment":this.horTextAlign=r==="center"?Et:r==="right"?Ut:Wt;break;case"colour":const s=lg(r);s&&(this.color=s);break;case"char_height":{const i=parseInt(r)||12;this.charHeight!==i&&(this.charHeight=i,this.textMesh=null);break}case"space_width":{const i=parseInt(r)||12;this.spaceWidth!==i&&(this.spaceWidth=i,this.textMesh=null);break}default:console.warn(`Неизвестный параметр StringInterface: '${t}'`);break}}}class tt{constructor(t){this.data=t,this.cache=new Nr(this.genBuffers.bind(this)),this.gl=null;const{indices:r,positions:s,positionSize:i}=t,n=this.useIndices32=r instanceof Uint32Array;this.positionSize=i,this.hasIndices=!!r,this.count=r?.length??s.length/i,this.drawMode=t.drawMode??WebGLRenderingContext.TRIANGLES,this.indicesType=n?WebGLRenderingContext.UNSIGNED_INT:WebGLRenderingContext.UNSIGNED_SHORT}genBuffers(t){const{gl:r}=t,{indices:s,positions:i,uvs:n,normals:a}=this.data,l=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,l),r.bufferData(r.ARRAY_BUFFER,i,r.STATIC_DRAW);let h;n?(h=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,h),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW)):h=null;let d;a?(d=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,d),r.bufferData(r.ARRAY_BUFFER,a,r.STATIC_DRAW)):d=null;let g;return s?(g=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,g),r.bufferData(r.ELEMENT_ARRAY_BUFFER,s,r.STATIC_DRAW),this.useIndices32&&!t.hasIndices32Support&&(console.warn("WebGL: Не поддерживаются 32-битные индексы"),this.indicesType=r.UNSIGNED_SHORT,this.count=0)):g=null,{ctx:t,positionsBuffer:l,uvsBuffer:h,normalsBuffer:d,indexBuffer:g}}use(t){if(t._activeVAO===this)return;t._setActiveVAO(this);const{ctx:r}=t,{positionsBuffer:s,uvsBuffer:i,normalsBuffer:n,indexBuffer:a}=this.cache.get(r),{gl:l}=r;l.bindBuffer(l.ARRAY_BUFFER,s),l.vertexAttribPointer(Vt,this.positionSize,l.FLOAT,!1,0,0),i&&t.hasUVSupport?(l.bindBuffer(l.ARRAY_BUFFER,i),l.vertexAttribPointer(mt,2,l.FLOAT,!1,0,0),r.enableUV()):r.disableUV(),n&&t.hasNormalsSupport?(l.bindBuffer(l.ARRAY_BUFFER,n),l.vertexAttribPointer($t,3,l.FLOAT,!1,0,0),r.enableNormals()):r.disableNormals(),a&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a),this.gl=l,++r.stats.switchesVAO}draw(){const{gl:t,drawMode:r,count:s,indicesType:i,hasIndices:n}=this;n?t.drawElements(r,s,i,0):t.drawArrays(r,0,s)}_drawRange(t,r){const{gl:s,drawMode:i,indicesType:n}=this;s.drawElements(i,r,n,t)}}class hg{constructor(t,r,s){this.sharedVAO=t,this.count=s,this.byteOffset=r*(t.useIndices32?4:2)}use(t){this.sharedVAO.use(t)}draw(){this.sharedVAO._drawRange(this.byteOffset,this.count)}}const Ht=new tt({positionSize:2,positions:new Float32Array([0,0,0,-1,1,-1,1,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),drawMode:WebGLRenderingContext.TRIANGLE_FAN});class ug extends vr{constructor(t,r){super(t,"Panel",r)}draw(t,r,s,i,n){const{material:a,uv:l}=this;if(!a)return;const h=a._getPanelOverlayRenderTech().use(t);Ht.use(h),h.setUVRect(l),h.setPositionAndScale(r,s,i,n),Ht.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class dg extends vr{constructor(t,r){super(t,"BorderPanel",r)}draw(t,r,s,i,n,a,l){const{material:h,uv:d,borders:g,uvTL:E,uvT:T,uvTR:m,uvR:O,uvBR:N,uvB:y,uvBL:P,uvL:C,metricsMode:L}=this;if(!h)return;const W=h._getPanelOverlayRenderTech().use(t);Ht.use(W);const F=L===ui,G=F?g[0]/a:g[0],D=F?g[1]/a:g[1],x=F?g[2]/l:g[2],j=F?g[3]/l:g[3],Z=i-G-D,Q=n-x-j;[[[G,x,Z,Q],d],[[0,0,G,x],E],[[G,0,Z,x],T],[[G+Z,0,D,x],m],[[G+Z,x,D,Q],O],[[G+Z,x+Q,D,j],N],[[G,x+Q,Z,j],y],[[0,x+Q,G,j],P],[[0,x,G,Q],C]].forEach(([le,J])=>{W.setUVRect(J),W.setPositionAndScale(r+le[0],s+le[1],le[2],le[3]),Ht.draw(),++t.stats.dcOverlay,++t.stats.dcTotal})}}function _i(e,t,r=Wt,s=0){const{glyphRects:i,fontSize:n,height:a,width:l}=e,h=[...t],d=(s||i[It].w)/n;let g=0;const E=[];let T=0,m=0;{let C={glyphs:[],width:0},L=0;h.forEach(W=>{const F=_e.indexOf(W),G=F>-1?F:It;if(G===Cn){E.push(C),T=Math.max(T,C.width),m+=1,C={glyphs:[],width:0},L=0,C.width=0;return}const D=i[G];if(G===It)(r!==Et||!E.length||C.glyphs.length)&&(C.width+=d,C.glyphs.push(null));else{const x=D.w/n,j=D.h/n;C.width+=x,L=Math.max(L,j),C.glyphs.push(D),++g}}),E.push(C),T=Math.max(T,C.width),m+=L}if(!g)return{caption:t,width:T,height:m,vao:null,align:r};const O=new Float32Array(g*8),N=new Float32Array(g*8),y=new Uint16Array(g*6);{let C=0,L=0;E.forEach(W=>{let F=r===Et?(T-W.width)/2:r===Ut?T-W.width:0;W.glyphs.forEach(G=>{if(!G){F+=d;return}const D=G.w/n,x=G.x-G.left,j=G.y-G.asc,Z=G.left+G.w+G.right,Q=G.asc+G.h+G.desc,ue=Z/n,le=Q/n,J=C*8,We=C*6,Ue=C*4;++C;{const Ve=F-G.left/n,nt=L+G.asc/n;F+=D;const ot=Ve,Rt=Ve,Xe=Ve+ue,ct=Xe,at=nt,lt=nt-le,$r=lt,jr=at;O[J+0]=ot,O[J+1]=at,O[J+2]=Rt,O[J+3]=lt,O[J+4]=Xe,O[J+5]=$r,O[J+6]=ct,O[J+7]=jr}{const Ve=x/l,nt=Ve,ot=(x+Z)/l,Rt=ot,Xe=j/a,ct=(j+Q)/a,at=ct,lt=Xe;N[J+0]=Ve,N[J+1]=Xe,N[J+2]=nt,N[J+3]=ct,N[J+4]=ot,N[J+5]=at,N[J+6]=Rt,N[J+7]=lt}y[We+0]=Ue+0,y[We+1]=Ue+1,y[We+2]=Ue+2,y[We+3]=Ue+0,y[We+4]=Ue+2,y[We+5]=Ue+3}),L-=1})}const P=new tt({positionSize:2,positions:O,uvs:N,indices:y});return{caption:t,width:T,height:m,vao:P,align:r}}class fg extends vr{constructor(t,r){super(t,"TextArea",r),this.tech=t._getFontTexture().getTextOverlayRenderTech()}draw(t,r,s,i,n,a,l){const{caption:h,tech:d,horTextAlign:g,spaceWidth:E}=this;if(!h)return;const{vao:T,width:m}=this.textMesh||(this.textMesh=_i(d.fontTexture.glyphData,h,g,E));if(!T)return;const O=d.use(t);T.use(O);const N=this.charHeight*.75,y=N/a,P=N/l,C=r-(g===Ut?m*y:g===Et?m*y/2:0);O.setPositionAndScale(C,s,y,P),O.setColor(this.color),T.draw(),++t.stats.dcOverlay,++t.stats.dcTotal}}class Xt{constructor(){this.renderIteration=0,this.currentRenderList=null}_setCurrentRenderList(t){this.currentRenderList=t}_setRenderIteration(t){this.renderIteration=t}_techOrVAOChanged(){this.currentRenderList?._removeElement(this)}}class gg{constructor(){this.renderIteration=0,this.gcFilter=t=>t.currentRenderList===this,this.capsGroups=et.map(()=>new jf)}clear(){++this.renderIteration}add(t){if(t._setRenderIteration(this.renderIteration),t.currentRenderList===this)return;t._setCurrentRenderList(this);const r=t.getRenderTech(),s=t.getVAO(),i=r.getProgramCaps();this.capsGroups[i.index].add(r,s,t)}_removeElement(t){t._setCurrentRenderList(null),this.gc()}render(t,r){let s=!1;const{renderIteration:i}=this,{stats:n}=t;for(const a of this.capsGroups)a.entries.forEach((l,h)=>{const d=h.use(t),{hasNormalsSupport:g}=d;l.forEach((E,T)=>{T.use(d),E.forEach(m=>{if(m.currentRenderList!==this){s=!0;return}if(m.renderIteration!==i){m._setCurrentRenderList(null),s=!0;return}t.useBackFaces(m.isMirrored()),g&&d.setNormalMatrix(m.getWorldMatrix(),m.getWorldNormalMatrix()),d.setMVPMatrix(m.getMVPMatrix(r)),T.draw(),++n.dcOpaque,++n.dcTotal})})});s&&this.gc()}gc(){for(const t of this.capsGroups)t.filterInline(this.gcFilter)}}class Ei{constructor(){this.elements=[],this.renderIteration=0}clear(){++this.renderIteration}add(t){t._setRenderIteration(this.renderIteration),t.currentRenderList!==this&&(t._setCurrentRenderList(this),this.elements.push(t))}_removeElement(){}render(t,r){let s=!1;const{renderIteration:i}=this,{stats:n}=t;if(r.node){const a=r.node.getWorldPosition();this.elements.sort((l,h)=>Rr(a,h.getWorldCOM())-Rr(a,l.getWorldCOM()))}else this.elements.sort((a,l)=>li(l.getWorldCOM())-li(a.getWorldCOM()));this.elements.forEach(a=>{if(a.currentRenderList!==this){s=!0;return}if(a.renderIteration!==i){a._setCurrentRenderList(null),s=!0;return}const l=a.getRenderTech(),h=a.getVAO(),d=l.use(t);h.use(d),t.useBackFaces(a.isMirrored()),d.hasNormalsSupport&&d.setNormalMatrix(a.getWorldMatrix(),a.getWorldNormalMatrix()),d.setMVPMatrix(a.getMVPMatrix(r)),h.draw(),++n.dcTotal,++n.dcTransparent}),s&&this.gc()}gc(){this.elements=this.elements.filter(t=>t.currentRenderList===this)}}class pg{constructor(t){this.image=t,this.cache=new Nr(this.genTexture.bind(this))}genTexture(t){const{gl:r}=t,s=r.createTexture();function i(a){t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,a),as(a.width)&&as(a.height)?r.generateMipmap(r.TEXTURE_2D):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE))}const{image:n}=this;return n.complete&&n.naturalHeight?i(n):(t.setTexture(s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array([211,211,211,64])),n.complete||n.addEventListener("load",()=>i(n))),{ctx:t,texture:s}}use(t){t.setTexture(this.cache.get(t).texture)}}const _g=oe(),Eg=Bt(),mi=ee(),mg=ae(0,1,0),Ti=ae(0,0,-1),Tg=ae(1,1,1),wg=gt(1,1,1,1),xr=ee(),Pr=ee(),Dr=ee(),kr=ee(),Lr=ee();function wi({origin:e,dir:t},r,s,i){ft(xr,s,r),ft(Pr,i,r),Qe(Dr,t,Pr);const n=ke(xr,Dr);if(n>-Number.EPSILON&&n<Number.EPSILON)return 1/0;const a=1/n;ft(kr,e,r);const l=ke(kr,Dr)*a;if(l<0||l>1)return 1/0;Qe(Lr,kr,xr);const h=ke(t,Lr)*a;if(h<0||l+h>1)return 1/0;const d=ke(Pr,Lr)*a;return d>Number.EPSILON?d:1/0}const Ce=ee(),Ge=ee(),Be=ee();function yg(e,t){let r=1/0;for(let s=0;s+8<t.length;s+=9){Ce[0]=t[s+0],Ce[1]=t[s+1],Ce[2]=t[s+2],Ge[0]=t[s+3],Ge[1]=t[s+4],Ge[2]=t[s+5],Be[0]=t[s+6],Be[1]=t[s+7],Be[2]=t[s+8];const i=wi(e,Ce,Ge,Be);r>i&&(r=i)}return r}function bg(e,t,r){let s=1/0;for(let i=0;i+2<r.length;i+=3){const n=r[i+0]*3,a=r[i+1]*3,l=r[i+2]*3;Ce[0]=t[n+0],Ce[1]=t[n+1],Ce[2]=t[n+2],Ge[0]=t[a+0],Ge[1]=t[a+1],Ge[2]=t[a+2],Be[0]=t[l+0],Be[1]=t[l+1],Be[2]=t[l+2];const h=wi(e,Ce,Ge,Be);s>h&&(s=h)}return s}function Rg(e,t,r){const[s,i,n]=t;return e[0]=r[0]*s+r[4]*i+r[8]*n,e[1]=r[1]*s+r[5]*i+r[9]*n,e[2]=r[2]*s+r[6]*i+r[10]*n,Ft(e,e)}function Og(e,t,r){return Le(e.origin,t.origin,r),Rg(e.dir,t.dir,r),e}function yi(e){switch(e){case yf:return WebGLRenderingContext.ONE;case bf:return WebGLRenderingContext.ZERO;case Rf:return WebGLRenderingContext.DST_COLOR;case Of:return WebGLRenderingContext.SRC_COLOR;case Mf:return WebGLRenderingContext.ONE_MINUS_DST_COLOR;case Sf:return WebGLRenderingContext.ONE_MINUS_SRC_COLOR;case Nf:return WebGLRenderingContext.DST_ALPHA;case If:return WebGLRenderingContext.SRC_ALPHA;case Af:return WebGLRenderingContext.ONE_MINUS_DST_ALPHA;case vf:return WebGLRenderingContext.ONE_MINUS_SRC_ALPHA;default:return 0}}function Mg(e){switch(e){case Df:return WebGLRenderingContext.POINTS;case kf:return WebGLRenderingContext.LINES;case Lf:return WebGLRenderingContext.LINE_STRIP;case Cf:return WebGLRenderingContext.TRIANGLE_STRIP;case Gf:return WebGLRenderingContext.TRIANGLE_FAN;default:return WebGLRenderingContext.TRIANGLES}}function Cr(){return{origin:ee(),dir:ae(0,0,1)}}const Sg=new tt({positionSize:2,positions:new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),indices:new Uint16Array([0,2,1,0,3,2,0,1,2,0,2,3])});class Ng extends Xt{constructor(t,r,s){super(),this.set=t,this.position=r,this.parentScale=s,this.worldMatrix=oe(),this.localMatrix=oe(),this.worldCOM=ee(),this.rotation=pt(),this.mvpMatrix=oe(),this.worldMatrixVersion=0,this.comWorldMatrixVersion=0,this.shouldUpdateLocalMatrix=!0,this.key=t.o.key()}getMVPMatrix(t){return Ae(this.mvpMatrix,t._getVPMatrix(),this.getWorldMatrix())}getWorldMatrix(){const{set:t}=this;this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,ci(this.localMatrix,this.rotation,this.position,this.parentScale),this.worldMatrixVersion=0);const r=t.node;return this.worldMatrixVersion!==r._worldMatrixVersion&&(this.worldMatrixVersion=r._worldMatrixVersion,Ae(this.worldMatrix,r._getWorldMatrix(),this.localMatrix)),this.worldMatrix}getWorldCOM(){const t=this.set.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Le(this.worldCOM,this.position,t._getWorldMatrix()),br(this.worldCOM,this.getWorldMatrix())),this.worldCOM}getVAO(){return Sg}getRenderTech(){return this.set.material._getMeshRenderTech()}getWorldNormalMatrix(){return Eg}isMirrored(){return!1}_onAttached(){this.worldMatrixVersion=0,this.comWorldMatrixVersion=0}_updateLocalMatrix(){this.shouldUpdateLocalMatrix=!0}}class rt{constructor(t,r){this.o=t,this.node=null,this.visible=!0,t.movables.set(this.key=t.key(),this),this.name=r?.name??""}destroy(){this.detach(),this.o.movables.delete(this.key)}setVisible(t){return this.visible=t,this}detach(){const t=this.node;return t?(t.movables=t.movables.filter(r=>r!==this),this.node=null,this):this}}class Ig extends rt{constructor(t,r){super(t,r),this.commonScale=ae(1,1,1),this.type=Bf,this.material=null,this.billboards=[],t.billboardSets.set(this.key,this)}destroy(){super.destroy(),this.o.billboardSets.delete(this.key)}createBillboard(t,r,s){const i=new Ng(this,ae(t,r,s),this.commonScale);return this.billboards.push(i),i}setCommonDirection(t,r,s){return this}setCommonUpVector(t,r,s){return this}setDimensions(t,r){Oe(this.commonScale,t,r,1);for(const s of this.billboards)s._updateLocalMatrix();return this}setType(t){if(t!==Ff)throw Error(`billboardSet_SetBillboardType: тип ${t} не реализован`);return this.type=t,this}setMaterial(t){if(this.material!==t){this.material=t;for(const r of this.billboards)r._techOrVAOChanged()}return this}_onAttached(){for(const t of this.billboards)t._onAttached()}_setup(t){const{material:r}=this;if(!r)return;const s=r._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements;for(const i of this.billboards)s.add(i)}}const bi=new Map;class Ag{constructor(t){this.info=t,this.texture=null,this.image=null,this.loadImage()}loadImage(){if(this.image)return this.image;const t=dt(this.info.src),r=bi.get(t);if(r)return this.image=r;const s=new Image;return s.crossOrigin="",s.src=t,bi.set(t,s),this.image=s}getTexture(){return this.texture||(this.image||(this.image=this.loadImage()),this.texture=new pg(this.image)),this.texture}}const Yt=ee();class Ri{constructor(t,r){this.center=t,this.sqrRadius=r*r}intersectsWith(t){const{center:r}=this;if(Rr(r,t.origin)<=this.sqrRadius)return!0;ft(Yt,r,t.origin);const s=ke(Yt,t.dir),i=ke(Yt,Yt)-s*s;if(i>this.sqrRadius)return!1;const n=Math.sqrt(this.sqrRadius-i);return s+n>=0}}class vg{constructor(t,r,s){this.parent=t,this.data=r,this.indexOffset=s,this.material=null,this.vao=null,this.materialFound=!1,this.materialName=r.material||"",this.useSharedGeometry=r.useSharedGeometry||!1;const i=r.useSharedGeometry?t.data.sharedGeometry:r.geometry;if(!i)throw Error("Mesh не имеет геометрии");if(i.length>1)throw Error("Mesh с несколькими VertexBuffer не реализованы");const[n]=i;if(!n.positions)throw Error("Mesh без Positions не поддерживается");this.vBufferData=n;const{maxX:a,maxY:l,maxZ:h,minX:d,minY:g,minZ:E}=r.extrema||n.positions.extrema,T=(a+d)/2,m=(l+g)/2,O=(h+E)/2;this.center=ae(T,m,O);const N=Math.max(a-d,l-g,h-E)/2;this.boundingSphere=new Ri(this.center,N)}getCOM(){return this.center}getVertexCount(){return this.vBufferData.vertexCount}getDefaultMaterial(){if(this.materialFound)return this.material;if(this.materialFound=!0,!this.materialName)return null;const t=this.parent.o.materialByName.get(this.materialName)??null;if(!t){const r=this.parent.submeshes.indexOf(this);console.warn(`Ogre: ${this.parent.meta}[${r}]: материал '${this.materialName}' не существует`)}return this.material=t}getVAO(){if(this.vao)return this.vao;if(this.useSharedGeometry){const l=this.indexOffset;let h=this.data.indices.length;return this.vao=new hg(this.parent._getSharedVAO(),l,h)}const{vBufferData:t,data:r}=this,s=new Float32Array(t.positions.coords),i=t.normals?.length?new Float32Array(t.normals):null,n=t.uvs?.length?new Float32Array(t.uvs[0]):null,a=new(r.useIndices32?Uint32Array:Uint16Array)(r.indices);return this.vao=new tt({positionSize:3,positions:s,uvs:n,normals:i,indices:a})}getClosestIntersection(t){return this.boundingSphere.intersectsWith(t)?bg(t,this.vBufferData.positions.coords,this.data.indices):1/0}}class xg{constructor(t,r){this.o=t,this.data=r,this.sharedVAO=null;let s=0;this.submeshes=r.submeshes.map(i=>{const n=new vg(this,i,s);return s+=i.indices.length,n})}_getSharedVAO(){if(this.sharedVAO)return this.sharedVAO;const[t]=this.data.sharedGeometry;let r=!1,s=0;this.data.submeshes.forEach(d=>{d.useIndices32&&(r=!0),s+=d.indices.length});const i=new(r?Uint32Array:Uint16Array)(s);let n=0;this.data.submeshes.forEach(d=>{i.set(d.indices,n),n+=d.indices.length});const a=new Float32Array(t.positions.coords),l=t.normals?.length?new Float32Array(t.normals):null,h=t.uvs?.length?new Float32Array(t.uvs[0]):null;return this.sharedVAO=new tt({positionSize:3,positions:a,uvs:h,normals:l,indices:i})}}class Pg extends rt{constructor(t,r){super(t,r),t.lights.set(this.key,this)}destroy(){super.destroy(),this.o.lights.delete(this.key)}_onAttached(){}_setup(t){t.globalLight=this}}class Dg{constructor(t,r=""){this.pass=t,this.name=r,this.texture=null,this.imageNameUC=null,this.imageFound=!1,t.tech.mat.o.texUnits.set(this.key=t.tech.mat.o.key(),this)}setTexture(t,r){if(r!==wf)throw Error("textureUnitState_SetTexture: Используемый тип текстуры не поддерживается");return this.texture=t?.getTexture()||null,this}setTextureName(t){return this.imageNameUC=t.toUpperCase(),this}getTexture(){return this.imageFound||this.texture?this.texture:(this.imageFound=!0,this.imageNameUC?this.texture=this.pass.tech.mat.o.imageResByNameUC.get(this.imageNameUC)?.getTexture()||null:null)}}class kg{constructor(t){this.tech=t,this.textures=[],this.ambient=ae(1,1,1),this.diffuse=gt(1,1,1,1),this.specular=gt(0,0,0,1),this.emissive=ae(0,0,0),this.shininess=0,this.lightingEnabled=!0,this.shadingMode=_t,this.depthCheck=!0,this.depthWrite=!0,this._glBlendSFactor=WebGLRenderingContext.ONE,this._glBlendDFactor=WebGLRenderingContext.ZERO,this._version=0,t.mat.o.passes.set(this.key=t.mat.o.key(),this)}_getDefaultTextureUnit(){const{textures:t}=this;return t.length?t[0]:null}createTextureUnit(t){const r=new Dg(this,t);return this.textures.push(r),r}setLightingEnabled(t){return this.lightingEnabled=t,this}setAmbient(t,r,s){return Oe(this.ambient,t,r,s),this}setDiffuse(t,r,s,i){return Or(this.diffuse,t,r,s,i),this}setSpecular(t,r,s,i){return Or(this.specular,t,r,s,i),this}setEmissive(t,r,s){return Oe(this.emissive,t,r,s),this}setShininess(t){return this.shininess=t,this}setShadingMode(t){return this.shadingMode=t,this}setDepthCheckEnabled(t){return this.depthCheck=t,this}setDepthWriteEnabled(t){return this.depthWrite=t,this}setSceneBlending(t,r){return this._glBlendSFactor=yi(t)||WebGLRenderingContext.ONE,this._glBlendDFactor=yi(r)||WebGLRenderingContext.ZERO,this}}class Lg{constructor(t){this.mat=t,t.o.techniques.set(this.key=t.o.key(),this),this.passes=[new kg(this)]}pass(t){return t>=0&&t<this.passes.length?this.passes[t]:null}}class Cg{constructor(t,r){this.o=t,this.name=r,this.meshRenderTech=null,this.panelOverlayRenderTech=null,t.materialByKey.set(this.key=t.key(),this),t.materialByName.has(r)||t.materialByName.set(r,this),this.techs=[new Lg(this)]}tech(t){return t>=0&&t<this.techs.length?this.techs[t]:null}_getMeshRenderTech(){return this.meshRenderTech||(this.meshRenderTech=new tg(this)),this.meshRenderTech}_getPanelOverlayRenderTech(){return this.panelOverlayRenderTech||(this.panelOverlayRenderTech=new rg(this)),this.panelOverlayRenderTech}}const st=oe();class Gg extends Xt{constructor(t,r,s,i,n){super(),this.text=t,this.renderTech=r,this.vao=s,this.width=i,this.height=n,this.mvpMatrix=oe(),this.worldCOM=ee(),this.comWorldMatrixVersion=1}getMVPMatrix(t){const{node:r,charHeight:s}=this.text,i=Ae(this.mvpMatrix,t._getViewMatrix(),r._getWorldMatrix()),n=Math.hypot(i[0],i[1],i[2])*s,a=Math.hypot(i[4],i[5],i[6])*s,l=-this.width*n,h=this.height*a;return st[0]=n,st[5]=a,st[12]=i[12]+l,st[13]=i[13]+h,st[14]=i[14],Ae(this.mvpMatrix,t._getProjectionMatrix(),st)}getWorldCOM(){const t=this.text.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,br(this.worldCOM,t._getWorldMatrix())),this.worldCOM}getVAO(){return this.vao}getRenderTech(){return this.renderTech}getWorldMatrix(){throw new Error("Method not implemented.")}getWorldNormalMatrix(){throw new Error("Method not implemented.")}isMirrored(){return!1}_onAttached(){this.comWorldMatrixVersion=1}}class Bg extends rt{constructor(t,r,s){super(t,s),this.textElement=null,this.textElementCreated=!1,this.color=gt(1,1,1,1),this.charHeight=1,t.movableTexts.set(this.key,this),this.caption=r,this.fontName=s?.fontName||""}destroy(){super.destroy(),this.o.movableTexts.delete(this.key)}setCharHeight(t){return this.charHeight=t,this}_onAttached(){this.textElement?._onAttached()}_setup(t){if(!this.textElementCreated&&(this.textElementCreated=!0,this.caption)){const s=this.o._getFontTexture(this.fontName),{vao:i,width:n,height:a}=_i(s.glyphData,this.caption);if(i){const l=new sg(s,this);this.textElement=new Gg(this,l,i,n,a)}}const{textElement:r}=this;r&&t.textElements.add(r)}}class Fg{constructor(t,r=""){this.o=t,this.name=r,this.children=[],this.visible=!1,this.scaleX=1,this.scaleY=1,this.z=0,t.overlays.set(this.key=t.key(),this)}setChildren(t){return this.children.forEach(r=>r.overlay=null),this.children=Array.from(new Set(t)),this.children.forEach(r=>{r.overlay=this,r.parent&&(console.warn("OverlayElement has parent"),r.parent=null)}),this}setZ(t){return this.z=t,this.o.overlayQueue=null,this}setScale(t,r){return this.scaleX=t,this.scaleY=r,this}setVisible(t){return this.visible=t,this.o.overlayQueue=null,this}render(t){const{ctx:r}=t.window,{drawingBufferWidth:s,drawingBufferHeight:i}=r.gl;this.children.forEach(n=>n.drawAt(r,0,0,1,1,s,i))}}class Wg{constructor(t,r){this.window=t,this.bg=ae(.2,.2,.2),this.overlaysEnabled=!0,t.o.viewports.set(this.key=t.o.key(),this),this.camera=r,r._setViewport(this)}setCamera(t){return this.camera!==t&&(this.camera._setViewport(null),this.camera=t._setViewport(this)),this}enableOverlays(t){return this.overlaysEnabled=t,this}setBackground(t,r,s){return Oe(this.bg,t,r,s),this}}class Ug{constructor(t,r,s){this.o=t,this.viewports=new Set,this.x=0,this.y=0,this.width=0,this.height=0,this.wheelPosition=0,this.buttonsPressed=[!1,!1,!1,!1],this.mainViewport=null,t.windows.set(this.key=t.key(),this);const i=this.domElement=document.createElement("canvas");this.width=i.width=r,this.height=i.height=s,i.setAttribute("data-render-window-key",this.key.toString());const n=i.getContext("webgl",{alpha:!1,depth:!0,antialias:!0,desynchronized:!1});this.ctx=new ag(n)}close(){this.o.windows.delete(this.key)}createViewport(t,r){const s=new Wg(this,t);if(this.viewports.size)throw Error("Создание нескольких Viewport не реализовано");return this.mainViewport=s,this.viewports.add(s),s}render(t){const{ctx:r}=this,{gl:s}=r;this.viewports.forEach(i=>{const{camera:n}=i;n._updateActualAspect();const{scene:a}=n,{globalLight:l,opaqueElements:h,textElements:d,transparentElements:g}=a._setup(t);if(r.reset(),s.clearColor(...i.bg,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.setLighting(a.ambient,l?.node.getWorldPosition()||mi),s.enable(s.DEPTH_TEST),h.render(r,n),s.enable(s.BLEND),g.render(r,n),s.disable(s.DEPTH_TEST),r.useBackFaces(!1),d.render(r,n),i.overlaysEnabled){let E;(E=this.o.overlayQueue)||(E=this.o.overlayQueue=[...this.o.overlays.values()].filter(T=>T.visible).sort((T,m)=>T.z-m.z)),E.forEach(T=>T.render(i))}s.disable(s.BLEND)})}}const Oi=ee(),Mi=ee(),Si=ee();class Vg extends rt{constructor(t,r){super(t.o,r),this.scene=t,this.projectionMatrix=oe(),this.vpMatrix=oe(),this.inverseVPMatrix=oe(),this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.vpWorldMatrixVersion=1,this.shouldUpdateInverseVPMatrix=!0,this.inverseVPWorldMatrixVersion=1,this.viewportAspect=10,this.viewport=null,this.nearDist=1,this.farDist=1e3,this.fov=Math.PI/4,this.aspect=1.3333333333333333,this.autoAspect=!0,t.o.cameras.set(this.key,this),r&&this.set(r)}destroy(){super.destroy(),this.o.cameras.delete(this.key)}useViewportAspect(){return!!this.viewport&&this.autoAspect}_setViewport(t){return this.viewport=t,this}set({farDist:t=this.farDist,fov:r=this.fov,nearDist:s=this.nearDist,aspect:i=this.aspect}){return(this.farDist!==t||this.fov!==r||this.nearDist!==s||this.aspect!==i&&!this.useViewportAspect())&&(this.shouldUpdateProjectionMatrix=!0,this.shouldUpdateVPMatrix=!0,this.shouldUpdateInverseVPMatrix=!0),this.farDist=t,this.fov=r,this.nearDist=s,this.aspect=i,this}_updateActualAspect(){if(!this.autoAspect)return;const{domElement:t}=this.viewport.window,r=t.width/t.height;this.viewportAspect!==r&&(this.viewportAspect=r,this.shouldUpdateProjectionMatrix=!0)}_getViewMatrix(){return this.node?._getInverseWorldMatrix()||_g}_getProjectionMatrix(){return this.shouldUpdateProjectionMatrix&&(this.shouldUpdateProjectionMatrix=!1,zd(this.projectionMatrix,this.fov,this.useViewportAspect()?this.viewportAspect:this.aspect,this.nearDist,this.farDist)),this.projectionMatrix}_getVPMatrix(){const{node:t}=this;return t?((this.shouldUpdateVPMatrix||this.vpWorldMatrixVersion!==t._worldMatrixVersion)&&(this.shouldUpdateVPMatrix=!1,this.vpWorldMatrixVersion=t._worldMatrixVersion,Ae(this.vpMatrix,this._getProjectionMatrix(),this._getViewMatrix())),this.vpMatrix):this._getProjectionMatrix()}_getInverseVPMatrix(){const{node:t}=this,r=t?t._worldMatrixVersion:1;return(this.shouldUpdateInverseVPMatrix||this.inverseVPWorldMatrixVersion!==r)&&(this.shouldUpdateInverseVPMatrix=!1,this.inverseVPWorldMatrixVersion=r,ni(this.inverseVPMatrix,this._getVPMatrix())),this.inverseVPMatrix}getRay(t,r,s){const i=this._getInverseVPMatrix(),n=2*t-1,a=1-2*r;return Oe(Oi,n,a,-1),Le(s.origin,Oi,i),Oe(Mi,n,a,0),Le(Si,Mi,i),ft(s.dir,Si,s.origin),Ft(s.dir,s.dir),s}_onAttached(){this.vpWorldMatrixVersion=1,this.inverseVPWorldMatrixVersion=1}_setup(){}}class $g extends Xt{constructor(t,r){super(),this.entity=t,this.submesh=r,this.worldCOM=ee(),this.comWorldMatrixVersion=0,this.material=null,this.vertexCount=r.getVertexCount(),this.material=r.getDefaultMaterial()}setMaterial(t){return this.material!==t&&(this.material=t,this._techOrVAOChanged()),this}_setup(t){const{material:r}=this;r&&(r._getMeshRenderTech().hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}getWorldMatrix(){return this.entity.node._getWorldMatrix()}getWorldNormalMatrix(){return this.entity._getWorldNormalMatrix()}getWorldCOM(){const t=this.entity.node;return this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Le(this.worldCOM,this.submesh.getCOM(),t._getWorldMatrix())),this.worldCOM}getVAO(){return this.submesh.getVAO()}getRenderTech(){return this.material._getMeshRenderTech()}isMirrored(){return this.entity.node._isMirrored()}getMVPMatrix(t){return this.entity._getMVPMatrix(t)}_onAttached(){this.comWorldMatrixVersion=0}}const Ni=oe();class Ii extends rt{constructor(t,{submeshes:r},s){super(t.o,s),this.scene=t,this.mvpMatrix=oe(),this.worldNormalMatrix=Bt(),this.normalWorldMatrixVersion=1,t.o.entities.set(this.key,this),this.subEntities=r.map(i=>new $g(this,i))}destroy(){super.destroy(),this.o.entities.delete(this.key)}subEntity(t){return t>=0&&t<this.subEntities.length?this.subEntities[t]:null}_getMVPMatrix(t){return Ae(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,ii(Ni,t._getInverseWorldMatrix()),si(this.worldNormalMatrix,Ni)),this.worldNormalMatrix}_getClosestIntersection(t){let r=1/0;for(const{submesh:s}of this.subEntities){const i=s.getClosestIntersection(t);r>i&&(r=i)}return r}_onAttached(){this.normalWorldMatrixVersion=1;for(const t of this.subEntities)t._onAttached()}_setup(t){for(const r of this.subEntities)r._setup(t)}}class jg extends wt{selectProgram(t){return t.meshPrograms[0]}apply(t){const{ctx:r}=t;r.setDepthWrite(!0),r.setDepthCheck(!0),t.setDiffuse(wg),t.setAmbient(Tg)}hasOpacity(){return!1}getProgramCaps(){return et[0]}}const Hg=new jg;class Xg extends Xt{constructor(t,r,s){super(),this.object=t,this.drawType=r,this.worldCOM=ee(),this.comWorldMatrixVersion=0,this.coords=[],this.normals=[],this.isComplete=!1,this.vao=null,this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0,this.minZ=1/0,this.maxZ=-1/0,this.center=null,this.boundingSphere=null,this.vertexCount=0,this.renderTech=s?._getMeshRenderTech()||Hg}addVertex(t,r,s){this.minX=Math.min(this.minX,t),this.maxX=Math.max(this.maxX,t),this.minY=Math.min(this.minY,r),this.maxY=Math.max(this.maxY,r),this.minZ=Math.min(this.minZ,s),this.maxZ=Math.max(this.maxZ,s),this.coords.push(t,r,s),++this.vertexCount}addNormal(t,r,s){this.normals.push(t,r,s)}end(){this.isComplete=!0;const{maxX:t,maxY:r,maxZ:s,minX:i,minY:n,minZ:a}=this,l=(t+i)/2,h=(r+n)/2,d=(s+a)/2;this.center=ae(l,h,d);const g=Math.max(t-i,r-n,s-a)/2;this.boundingSphere=new Ri(this.center,g)}getWorldMatrix(){return this.object.node._getWorldMatrix()}getWorldNormalMatrix(){return this.object._getWorldNormalMatrix()}getWorldCOM(){const t=this.object.node;return t?(this.comWorldMatrixVersion!==t._worldMatrixVersion&&(this.comWorldMatrixVersion=t._worldMatrixVersion,Le(this.worldCOM,this.center,t._getWorldMatrix())),this.worldCOM):mi}getVAO(){return this.vao?this.vao:this.vao=new tt({positionSize:3,positions:new Float32Array(this.coords),normals:this.normals.length?new Float32Array(this.normals):null,drawMode:Mg(this.drawType)})}getRenderTech(){return this.renderTech}isMirrored(){return this.object.node._isMirrored()}getMVPMatrix(t){return this.object._getMVPMatrix(t)}getClosestIntersection(t){return this.drawType!==hi||!this.isComplete||!this.boundingSphere.intersectsWith(t)?1/0:yg(t,this.coords)}_setup(t){this.isComplete&&(this.renderTech.hasOpacity()?t.transparentElements:t.opaqueElements).add(this)}_onAttached(){this.comWorldMatrixVersion=0}}const Ai=oe();class vi extends rt{constructor(t,r){super(t.o,r),this.scene=t,this.mvpMatrix=oe(),this.worldNormalMatrix=Bt(),this.normalWorldMatrixVersion=0,this.sections=[],t.o.manualObjects.set(this.key,this)}destroy(){super.destroy(),this.o.manualObjects.delete(this.key)}createSection(t,r){const s=new Xg(this,t,r);return this.sections.push(s),s}clear(){this.sections=[]}_getMVPMatrix(t){return Ae(this.mvpMatrix,t._getVPMatrix(),this.node._getWorldMatrix())}_getWorldNormalMatrix(){const t=this.node;return this.normalWorldMatrixVersion!==t._worldMatrixVersion&&(this.normalWorldMatrixVersion=t._worldMatrixVersion,ii(Ai,t._getInverseWorldMatrix()),si(this.worldNormalMatrix,Ai)),this.worldNormalMatrix}_getClosestIntersection(t){let r=1/0;for(const s of this.sections){const i=s.getClosestIntersection(t);r>i&&(r=i)}return r}_onAttached(){this.normalWorldMatrixVersion=0;for(const t of this.sections)t._onAttached()}_setup(t){for(const r of this.sections)r._setup(t)}}class Yg{constructor(t){this.entries=t,this.length=t.length}getEntry(t){const{entries:r}=this;return t>=0&&t<r.length?r[t]:null}sort(){this.entries.sort((t,r)=>t.distance-r.distance)}}class zg{constructor(t,r){this.scene=t,this.localMatrix=oe(),this.worldMatrix=oe(),this.inverseWorldMatrix=oe(),this.worldPosition=ee(),this.worldRotation=pt(),this.worldScale=ae(1,1,1),this.mirrored=!1,this.shouldUpdateLocalMatrix=!1,this.shouldUpdateWorldMatrix=!1,this.shouldUpdateInverseWorldMatrix=!1,this.shouldUpdateMirroredInfo=!1,this.shouldUpdateWorldPosition=!1,this.shouldUpdateWorldRotation=!1,this.shouldUpdateWorldScale=!1,this.position=ee(),this.scale=ae(1,1,1),this.rotation=pt(),this._worldMatrixVersion=1,this.children=[],this.parent=null,t.o.nodes.set(this.key=t.o.key(),this),this.name=r?.name??""}destroy(){this.children.forEach(t=>{t.parent=null,t.updateWorldMatrixRecursive()}),this.removeParent(),this.scene.o.nodes.delete(this.key)}getChild(t){const{children:r}=this;return t>=0&&t<r.length?r[t]:null}addChild(t){const r=t.parent;if(r){if(r===this)return this;let s=this.parent;for(;s;){if(s===t)throw Error("SceneNode.addChild: child является родительским узлом текущего узла");s=s.parent}}if(t===this)throw Error("SceneNode.addChild: child является текущим узлом");if(t.scene!==this.scene)throw Error("SceneNode.addChild: child принадлежит другой сцене");return t.removeParent(),this.children.push(t),t.parent=this,t.updateWorldMatrixRecursive(),this}updateWorldMatrixRecursive(){if(!this.shouldUpdateWorldMatrix){this.shouldUpdateWorldMatrix=!0,++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldPosition=!0,this.shouldUpdateWorldRotation=!0,this.shouldUpdateWorldScale=!0;for(const t of this.children)t.updateWorldMatrixRecursive()}}updateLocalMatrix(){this.shouldUpdateLocalMatrix||(this.shouldUpdateLocalMatrix=!0,this.updateWorldMatrixRecursive())}updateChildrenMirroredInfoRecursive(){if(!this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!0;for(const t of this.children)t.updateChildrenMirroredInfoRecursive()}}updateMirroredInfo(){if(this.shouldUpdateMirroredInfo)return;const{scale:t}=this;if(this.mirrored!==Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0){this.shouldUpdateMirroredInfo=!0;for(const r of this.children)r.updateChildrenMirroredInfoRecursive()}}removeParent(){const t=this.parent;return t?(t.children=t.children.filter(r=>r!==this),this.parent=null,this):this}setPosition(t,r,s){return Oe(this.position,t,r,s),this.updateLocalMatrix(),this}setRotation(t,r,s,i){return Sr(this.rotation,Ef(this.rotation,t,r,s,i)),this.updateLocalMatrix(),this}resetRotation(){return uf(this.rotation),this.updateLocalMatrix(),this}rotateX(t){return ff(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateY(t){return gf(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}rotateZ(t){return pf(this.rotation,this.rotation,t),this.updateLocalMatrix(),this}setScale(t,r,s){return Oe(this.scale,t,r,s),this.updateLocalMatrix(),this.updateMirroredInfo(),this}_getWorldMatrixForRotation(){++this._worldMatrixVersion,this.shouldUpdateInverseWorldMatrix=!0,this.shouldUpdateWorldRotation=!0;for(const t of this.children)t.updateWorldMatrixRecursive();return this.worldMatrix}_getWorldMatrix(){return this.shouldUpdateWorldMatrix&&(this.shouldUpdateWorldMatrix=!1,this.shouldUpdateLocalMatrix&&(this.shouldUpdateLocalMatrix=!1,ci(this.localMatrix,this.rotation,this.position,this.scale)),this.parent?Ae(this.worldMatrix,this.parent._getWorldMatrix(),this.localMatrix):Vd(this.worldMatrix,this.localMatrix)),this.worldMatrix}_getInverseWorldMatrix(){return this.shouldUpdateInverseWorldMatrix&&(this.shouldUpdateInverseWorldMatrix=!1,ni(this.inverseWorldMatrix,this._getWorldMatrix())),this.inverseWorldMatrix}_isMirrored(){if(this.shouldUpdateMirroredInfo){this.shouldUpdateMirroredInfo=!1;const{scale:t}=this;this.mirrored=Math.sign(t[0])*Math.sign(t[1])*Math.sign(t[2])<0,this.parent?._isMirrored()&&(this.mirrored=!this.mirrored)}return this.mirrored}getWorldPosition(){return this.shouldUpdateWorldPosition&&(this.shouldUpdateWorldPosition=!1,br(this.worldPosition,this._getWorldMatrix())),this.worldPosition}getWorldRotation(){return this.shouldUpdateWorldRotation&&(this.shouldUpdateWorldRotation=!1,Xd(this.worldRotation,this._getWorldMatrix())),this.worldRotation}getWorldScale(){return this.shouldUpdateWorldScale&&(this.shouldUpdateWorldScale=!1,oi(this.worldScale,this._getWorldMatrix())),this.worldScale}}const Gr=ee(),xi=ee(),Kg=ee(),zt=Cr(),yt=ee();class Pi extends zg{constructor(t,r){super(t,r),this.trackingInfo=null,this.movables=[],t.o.sceneNodes.set(this.key,this)}destroy(){super.destroy(),this.movables.forEach(t=>t.node=null),this.scene.o.sceneNodes.delete(this.key)}getMovable(t){const{movables:r}=this;return t>=0&&t<r.length?r[t]:null}attach(t){const r=t.node;if(r){if(r===this)return this;t.detach()}return this.movables.push(t),t.node=this,t._onAttached(this),this}setAutoTracking(t,r,s,i){if(!t)return this.trackingInfo=null,this;let n,a;const{trackingInfo:l}=this;if(l){if(n=l.direction,a=l.orientationMat,l.target===t&&n[0]===r&&n[1]===s&&n[2]===i)return this;Oe(n,r,s,i)}else n=ae(r,s,i),a=oe();Ft(Gr,n);const h=nf(Gr,Ti);return Qe(xi,Gr,Ti),Hd(a,h,xi),this.trackingInfo={target:t,direction:n,orientationMat:a},this}updateTracking(){const{parent:t,trackingInfo:r}=this;if(!r||!t)return;const s=this.getWorldScale(),i=this._getWorldMatrixForRotation();Kd(i,this.getWorldPosition(),r.target.getWorldPosition(),Le(Kg,mg,t._getWorldMatrix())),Ae(i,i,r.orientationMat),jd(i,i,s)}_setup(t){this.updateTracking();for(const r of this.movables)r.visible&&r._setup(t);for(const r of this.children)r._setup(t)}_findIntersections(t,r){let s=!1;for(const i of this.movables){if(!(i instanceof Ii||i instanceof vi))continue;s||(s=!0,Og(zt,t,this._getInverseWorldMatrix()));const n=i._getClosestIntersection(zt);if(n<1/0){Zd(yt,zt.origin,ef(yt,zt.dir,n)),Le(yt,yt,this._getWorldMatrix());const a=cf(t.origin,yt);r.push({movable:i,distance:a})}}for(const i of this.children)i._findIntersections(t,r)}}class qg{constructor(t){this.o=t,this.renderInfo={globalLight:null,opaqueElements:new gg,transparentElements:new Ei,textElements:new Ei},this.frameNumber=0,this.ambient=ee(),t.scenes.set(this.key=t.key(),this),this.root=new Pi(this)}setAmbient(t,r,s){return Oe(this.ambient,t,r,s),this}createSceneNode(t){return new Pi(this,t)}createCamera(t){return new Vg(this,t)}createEntity(t,r){return new Ii(this,t,r)}createManualObject(t){return new vi(this,t)}_setup(t){if(this.frameNumber===t)return this.renderInfo;this.frameNumber=t;const{renderInfo:r}=this;return r.globalLight=null,r.opaqueElements.clear(),r.transparentElements.clear(),r.textElements.clear(),this.root._setup(r),r}rayCast(t){const r=[];return this.root._findIntersections(t,r),new Yg(r)}}class Zg{constructor(){this.windows=new Map,this.scenes=new Map,this.viewports=new Map,this.overlays=new Map,this.overlayElements=new Map,this.entities=new Map,this.manualObjects=new Map,this.nodes=new Map,this.sceneNodes=new Map,this.movables=new Map,this.cameras=new Map,this.billboardSets=new Map,this.lights=new Map,this.movableTexts=new Map,this.materialByKey=new Map,this.materialByName=new Map,this.techniques=new Map,this.passes=new Map,this.texUnits=new Map,this.imageResByNameUC=new Map,this.meshResByNameUC=new Map,this.primaryWindow=null,this.overlayQueue=null,this.fontMap=new Map,this.globalKey=1e3,this.drawNumber=0}_getFontTexture(t){const r=t||"sans-serif",s=r.toUpperCase(),i=this.fontMap.get(s);if(i)return i;const n=new og(r);return this.fontMap.set(s,n),n}key(){return++this.globalKey}createRenderWindow(t,r){const s=new Ug(this,t,r);return this.primaryWindow||=s,s}createScene(){return new qg(this)}createMovableText(t,r){return new Bg(this,t,r)}createLight(t){return new Pg(this,t)}createBillboardSet(t){return new Ig(this,t)}createMaterial(t){return new Cg(this,t)}createOverlayElement(t,r){switch(t){case"Panel":return new ug(this,r);case"BorderPanel":return new dg(this,r);case"TextArea":return new fg(this,r);default:throw Error(`createOverlayElement: тип '${t}' не реализован`)}}createOverlay(t){return new Fg(this,t)}createMesh(t,r){const s=new xg(this,t);return this.meshResByNameUC.set(r.toUpperCase(),s),s}createImage(t,r){const s=new Ag(t);return this.imageResByNameUC.set(r.toUpperCase(),s),s}renderAll(){const t=++this.drawNumber;this.windows.forEach(r=>r.render(t))}}const Di=new Set;function K(...e){Di.size!==Di.add(e[0]).size&&console.warn(...e)}function Jg(e,t,r,s,i){if(!this.kernel.egor.scenes.get(e))return 0;const a=this.kernel.egor.manualObjects.get(t);if(!a)return 0;const l=a.sections[0];return l.addVertex(r,s,i),l.vertexCount}function Qg(e,t,r,s,...i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function ep(e,t,r,s,...i){throw K("ApplyTexture3d",e,t,r,s,i),Error("ApplyTexture3d: Функция не реализована")}function tp(e,t,r,s,i,n){if(!this.kernel.egor.scenes.get(e))return 0;const l=this.kernel.egor.cameras.get(t);return l?this.kernel.egor.createRenderWindow(1e3,1e3).createViewport(l).key:0}function rp(e,t,r,s,i,n,a,l,h,d,g,E,T){const m=this.kernel.egor.scenes.get(e);return m?m.createCamera().key:0}function sp(e,t){throw K("CreateDefCamera3d",e,t),Error("CreateDefCamera3d: Функция не реализована")}function ip(e,t,r,s,i,n,a,l,h,d){throw K("CreateMaterial3d",e,t,r,s,i,n,a,l,h,d),Error("CreateMaterial3d: Функция не реализована")}function np(e){const t=this.kernel.egor.scenes.get(e);if(!t)return 0;const r=t.createManualObject();return r.createSection(hi,null),r.key}function op(e,t){throw K("CreateObjectFromFile3d",e,t),Error("CreateObjectFromFile3d: Функция не реализована")}function cp(e){return this.kernel.egor.createScene().key}function ap(e,t,r,s,i,n){throw K("CreateSurface3d",e,t,r,s,i,n),Error("CreateSurface3d: Функция не реализована")}function lp(e,t,r){throw K("DelPoint3d",e,t,r),Error("DelPoint3d: Функция не реализована")}function hp(e,t,r){throw K("DelPrimitive3d",e,t,r),Error("DelPrimitive3d: Функция не реализована")}function up(e){throw K("DeleteSpace3d",e),Error("DeleteSpace3d: Функция не реализована")}function dp(e,t){throw K("DuplicateObject3d",e,t),Error("DuplicateObject3d: Функция не реализована")}function fp(e,t,r,s){throw K("FitToCamera3d",e,t,r,s),Error("FitToCamera3d: Функция не реализована")}function gp(e,t){throw K("GetActiveCamera3d",e,t),Error("getActiveCamera3d: Функция не реализована")}function pp(e,t,r,s,i){throw K("GetColors3d",e,t,r,s,i),Error("GetColors3d: Функция не реализована")}function _p(e,t){throw K("GetMaterialByName3d",e,t),Error("GetMaterialByName3d: Функция не реализована")}function Ep(e,t){throw K("GetNumPoints3d",e,t),Error("GetNumPoints3d: Функция не реализована")}function mp(e,t){throw K("GetNumPrimitives3d",e,t),Error("GetNumPrimitives3d: Функция не реализована")}function Tp(e,t,r,s,i,n,a,l){throw K("GetObject3dFromPoint2d",e,t,r,s,n,l),Error("GetObject3dFromPoint2d: Функция не реализована")}function wp(e,t,r,s,i,n,a,l){throw K("GetObjectBase3d",e,t,s,n,l),Error("GetObjectBase3d: Функция не реализована")}function yp(e,t,r){throw K("GetObjectBase3dM",e,t,r),Error("GetObjectBase3dM: Функция не реализована")}function bp(e,t){throw K("GetObjectColor3d",e,t),Error("GetObjectColor3d: Функция не реализована")}function Rp(e,t,r){throw K("GetObjectDimension3d",e,t,r),Error("GetObjectDimension3d: Функция не реализована")}function Op(e,t,r){return r}function Mp(e,t,r){throw K("GetObjectPoints3d",e,t,r),Error("GetObjectPoints3d: Функция не реализована")}function Sp(e,t,r,s,i,n,a,l,h){throw K("GetPoint3d",e,t,r,i,a,h),Error("GetPoint3d: Функция не реализована")}function Np(e,t){throw K("GetSpace3d",e,t),Error("getSpace3d: Функция не реализована")}function Ip(e,t,r,s,i){const n=this.kernel.egor.scenes.get(e);return n?n.createManualObject().key:0}function Ap(e,t,r,s,i,n,a,l){throw K("MakeCylinder3d",e,t,r,s,i,n,a,l),Error("MakeCylinder3d: Функция не реализована")}function vp(e,t,r,s,i,n){throw K("MakeGrid3d",e,t,r,s,i,n),Error("MakeGrid3d: Функция не реализована")}function xp(e,t,r,s,i,n){throw K("MakeSphere3d",e,t,r,s,i,n),Error("MakeSphere3d: Функция не реализована")}function Pp(){K("MakeTore3d")}function Dp(e,t,r,s,i,n,a,l){throw K("MakeTube3d",e,t,r,s,i,n,a,l),Error("MakeTube3d: Функция не реализована")}function kp(e){throw K("PopCrdSystem3d",e),Error("PopCrdSystem3d: Функция не реализована")}function Lp(e){throw K("PushCrdSystem3d",e),Error("PushCrdSystem3d: Функция не реализована")}function Cp(e,t){throw K("RemoveTexture3d",e,t),Error("RemoveTexture3d: Функция не реализована")}function Gp(e,t,r,s){throw K("RotateObject3d",e,t,r,s),Error("RotateObject3d: Функция не реализована")}function Bp(e,t,r,s){throw K("RotateObjectPoints3d",e,t,r,s),Error("RotateObjectPoints3d: Функция не реализована")}function Fp(e,t){throw K("SelectLocalCrd3d",e,t),Error("SelectLocalCrd3d: Функция не реализована")}function Wp(e,t){throw K("SelectViewCrd3d",e,t),Error("SelectViewCrd3d: Функция не реализована")}function Up(e){throw K("SelectWorldCrd3d",e),Error("SelectWorldCrd3d: Функция не реализована")}function Vp(e,t,r,s,i){throw K("SetColors3d",e,t,r,s,i),Error("SetColors3d: Функция не реализована")}function $p(e,t,r,s,i){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function jp(e,t,r){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function Hp(e,t,r){throw K("SetObjectMatrix3d",e,t,r),Error("SetObjectMatrix3d: Функция не реализована")}function Xp(e,t,r){throw K("SetObjectPoints3d",e,t,r),Error("SetObjectPoints3d: Функция не реализована")}function Yp(e,t,r,s,i,n){return!this.kernel.egor.scenes.get(e)||!this.kernel.egor.manualObjects.get(t)?0:1}function zp(e,t,r,s,i,...n){return 1}function Kp(e,t,r,s,i,n,a,l,h,d,g){throw K("SweepAndExtrude3d",e,t,r,s,i,n,a,l,h,d,g),Error("SweepAndExtrude3d: Функция не реализована")}function qp(){K("SwitchToCamera3d")}function Zp(e,t,r,s,i,n){throw K("TransformCamera3d",e,t,r,s,i,n),Error("TransformCamera3d: Функция не реализована")}function Jp(e,t,r){throw K("TransformObject3d",e,t,r),Error("TransformObject3d: Функция не реализована")}function Qp(e,t,r){throw K("TransformObjectPoints3d",e,t,r),Error("TransformObjectPoints3d: Функция не реализована")}function e_(e,t,r,s){return!this.kernel.egor.scenes.get(t)||!this.kernel.egor.cameras.get(r)?0:1}function t_(e){e("AddPoint3d",{a:[c,c,o,o,o],r:o},Jg),e("AddPrimitive3d",{a:[c,c,o,X],rest:[o],r:o},Qg),e("ApplyTexture3d",{a:[c,c,c,c],rest:[o],r:o},ep),e("Create3dView2d",{a:[c,c,o,o,o,o],r:c},tp),e("CreateCamera3dEx",{a:[c,_,o,o,X,o,o,o,o,o,o,o,o],r:c},rp),e("CreateDefCamera3d",{a:[c,o],r:c},sp),e("CreateMaterial3d",{a:[c,_,_,X,X,X,X,o,o,o],r:c},ip),e("CreateObject3d",{a:[c],r:c},np),e("CreateObjectFromFile3d",{a:[c,_],r:c},op),e("CreateSpace3d",{a:[c],r:c},cp),e("CreateSurface3d",{a:[c,c,o,o,X,o],r:c},ap),e("DelPoint3d",{a:[c,c,o],r:o},lp),e("DelPrimitive3d",{a:[c,c,o],r:o},hp),e("DeleteSpace3d",{a:[c],r:o},up),e("DuplicateObject3d",{a:[c,c],r:c},dp),e("FitToCamera3d",{a:[c,c,c,o],r:o},fp),e("GetActiveCamera3d",{a:[c,c],r:c},gp),e("GetColors3d",{a:[c,c,o,o,o],r:o},pp),e("GetMaterialByName3d",{a:[c,_],r:c},_p),e("GetNumPoints3d",{a:[c,c],r:o},Ep),e("GetNumPrimitives3d",{a:[c,c],r:o},mp),e("GetObject3dFromPoint2d",{a:[c,c,o,o,ta,I],r:c},Tp),e("GetObjectBase3d",{a:[c,c,I,I,I],r:o},wp),e("GetObjectBase3dM",{a:[c,c,o],r:o},yp),e("GetObjectColor3d",{a:[c,c],r:X},bp),e("GetObjectDimension3d",{a:[c,c,o],r:o},Rp),e("GetObjectMatrix3d",{a:[c,c,o],r:o},Op),e("GetObjectPoints3d",{a:[c,c,o],r:o},Mp),e("GetPoint3d",{a:[c,c,o,I,I,I],r:o},Sp),e("GetSpace3d",{a:[c,c],r:c},Np),e("MakeBar3d",{a:[c,X,o,o,o],r:c},Ip),e("MakeCylinder3d",{a:[c,c,X,o,o,o,o,o],r:c},Ap),e("MakeGrid3d",{a:[c,o,o,o,o,X],r:c},vp),e("MakeSphere3d",{a:[c,c,X,o,o,o],r:c},xp),e("MakeTore3d",{a:[]},Pp),e("MakeTube3d",{a:[c,c,X,o,o,o,o,o],r:c},Dp),e("PopCrdSystem3d",{a:[c],r:o},kp),e("PushCrdSystem3d",{a:[c],r:o},Lp),e("RemoveTexture3d",{a:[c,c],r:o},Cp),e("RotateObject3d",{a:[c,c,o,o],r:o},Gp),e("RotateObjectPoints3d",{a:[c,c,o,o],r:o},Bp),e("SelectLocalCrd3d",{a:[c,c],r:o},Fp),e("SelectViewCrd3d",{a:[c,c],r:o},Wp),e("SelectWorldCrd3d",{a:[c],r:o},Up),e("SetColors3d",{a:[c,c,o,o,o],r:o},Vp),e("SetObjectBase3d",{a:[c,c,o,o,o],r:o},$p),e("SetObjectColor3d",{a:[c,c,X],r:o},jp),e("SetObjectMatrix3d",{a:[c,c,o],r:o},Hp),e("SetObjectPoints3d",{a:[c,c,o],r:o},Xp),e("SetPoint3d",{a:[c,c,o,o,o,o],r:o},Yp),e("SetPrimitive3d",{a:[c,c,o,o,X],rest:[o],r:o},zp),e("SweepAndExtrude3d",{a:[c,c,o,o,o,o,o,o,o,X,o],r:c},Kp),e("SwitchToCamera3d",{a:[]},qp),e("TransformCamera3d",{a:[c,c,o,o,o,o],r:o},Zp),e("TransformObject3d",{a:[c,c,o],r:o},Jp),e("TransformObjectPoints3d",{a:[c,c,o],r:o},Qp),e("_CameraProc3d",{a:[_,c,c,o],r:o},e_)}const r_={name:"graphics3d",deps:["ogre"],register:t_};class xe{constructor(t){this.minV=Math.floor(t.minV),this.minH=Math.floor(t.minH),this.rows=t.rows,this.cols=t.cols,this.m=t.data?new Float64Array(t.data):new Float64Array(this.rows*this.cols)}isSquare(){return this.cols===this.rows}get(t,r){const s=Math.floor(t)-this.minV,i=Math.floor(r)-this.minH;return s<0||i<0||s>=this.rows||i>=this.cols?0:this.m[s*this.cols+i]}set(t,r,s){const i=Math.floor(t)-this.minV,n=Math.floor(r)-this.minH;return i<0||n<0||i>=this.rows||n>=this.cols?0:(this.m[i*this.cols+n]=s,s)}sum(){return this.m.reduce((t,r)=>t+r,0)}glue(t,r,s){const i=this,n=Math.min(i.minH,t.minH+s),a=Math.min(i.minV,t.minV+r),l=Math.max(i.cols+i.minH,t.cols+t.minH+s),h=Math.max(i.rows+i.minV,t.rows+t.minV+r),d=new xe({cols:l-n,rows:h-a,minH:n,minV:a});for(let g=t.minV;g<t.rows+t.minV;g++)for(let E=t.minH;E<t.cols+t.minH;E++)d.set(g+r,E+s,t.get(g,E));for(let g=i.minV;g<i.rows+i.minV;g++)for(let E=i.minH;E<i.cols+i.minH;E++)d.set(g,E,i.get(g,E));return d}add(t){const r=this,s=Math.min(r.minH,t.minH),i=Math.min(r.minV,t.minV),n=Math.max(r.cols+r.minH,t.cols+t.minH),l=Math.max(r.rows+r.minV,t.rows+t.minV)-i,h=n-s,d=new xe({cols:h,rows:l,minH:s,minV:i}),g=Math.min(r.rows,t.rows),E=Math.min(r.cols,t.cols);for(let T=0;T<g;T++)for(let m=0;m<E;m++)d.m[T+h+m]=r.m[T*r.cols+m]+t.m[T+t.cols+m];return d}mul(t){const r=this;if(r.cols!==t.rows)return null;const s=t.cols,i=r.rows,n=new xe({cols:s,rows:i,minH:r.minH,minV:r.minV});for(let a=0;a<i;a++)for(let l=0;l<s;l++){let h=0;for(let d=0;d<r.cols;d++)h+=r.m[a*r.cols+d]*t.m[d*t.cols+l];n.m[a*s+l]=h}return n}det(){if(!this.isSquare())throw Error("Not a square matrix");const t=this.rows;if(t===1)return this.m[0];if(t===2)return this.m[0]*this.m[3]-this.m[1]*this.m[2];const r=Array.from(this.m);let s=1;for(let i=0;i<t;i++){let n=i,a=Math.abs(r[i*t+i]);for(let l=i+1;l<t;l++){const h=Math.abs(r[l*t+i]);h>a&&(a=h,n=l)}if(a===0)return 0;if(n!==i){s=-s;for(let l=i;l<t;l++){const h=r[i*t+l];r[i*t+l]=r[n*t+l],r[n*t+l]=h}}for(let l=i+1;l<t;l++){const h=r[l*t+i]/r[i*t+i];for(let d=i;d<t;d++)r[l*t+d]-=h*r[i*t+d]}s*=r[i*t+i]}return s}obr(){if(!this.isSquare()||this.det()===0)return null;const t=this.rows,r=new xe({cols:this.cols,rows:this.rows,minH:0,minV:0,data:Array.from(this.m)}),s=new xe({cols:this.cols,rows:this.rows,minH:0,minV:0});for(let i=0;i<t;i++)for(let n=0;n<t;n++)s.set(i,n,0),i===n&&s.set(i,n,1);for(let i=0;i<t;i++){let n=r.get(i,i);for(let a=0;a<t;a++)r.set(i,a,r.get(i,a)/n),s.set(i,a,s.get(i,a)/n);for(let a=i+1;a<t;a++){n=r.get(a,i);for(let l=0;l<t;l++)r.set(a,l,r.get(a,l)-r.get(i,l)*n),s.set(a,l,s.get(a,l)-s.get(i,l)*n)}}for(let i=t-1;i>0;i--)for(let n=i-1;n>=0;n--){let a=r.get(n,i);for(let l=0;l<t;l++)r.set(n,l,r.get(n,l)-r.get(i,l)*a),s.set(n,l,s.get(n,l)-s.get(i,l)*a)}return s.minH=this.minH,s.minV=this.minV,s}diag(t){this.fill(0);const r=Math.min(this.rows,this.cols);for(let s=0;s<r;s++)this.set(s,s,t);return 1}fill(t){return this.m.fill(t),1}sortByRow(t,r){const s=t-this.minV;if(s<0||s>=this.rows)return 0;const i=Array.from({length:this.cols},(a,l)=>Array.from({length:this.rows},(h,d)=>this.m[d*this.cols+l])),n=r?(a,l)=>l[s]-a[s]:(a,l)=>a[s]-l[s];return i.sort(n),i.forEach((a,l)=>{a.forEach((h,d)=>{this.m[d*this.cols+l]=h})}),1}sortByColumn(t,r){const s=t-this.minH;if(s<0||s>=this.cols)return 0;const i=Array.from({length:this.rows},(a,l)=>{const h=l*this.cols,d=h+this.cols;return Array.from(this.m.subarray(h,d))}),n=r?(a,l)=>l[s]-a[s]:(a,l)=>a[s]-l[s];return i.sort(n),this.m=new Float64Array(ls(i)),1}data(){const{minH:t,minV:r,cols:s,rows:i,m:n}=this;return{minV:r,minH:t,cols:s,rows:i,data:[...n]}}}function s_(e,t,r,s,i,n){if(n<=0)return 0;const a=Math.floor(r)-Math.floor(t)+1,l=Math.floor(i)-Math.floor(s)+1;if(a<=0||l<=0)return 0;const h=e||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(h,new xe({rows:a,cols:l,minV:t,minH:s})),h}function i_(e,t){return t<=0?0:this.kernel.matrices.delete(e)?1:0}function n_(e,t,r){return r<=0?0:this.kernel.matrices.get(e)?.fill(t)??0}function o_(e,t,r,s){return s<=0?0:this.kernel.matrices.get(e)?.get(t,r)??0}function c_(e,t,r,s,i){return i<=0?0:this.kernel.matrices.get(e)?.set(t,r,s)??0}function a_(e,t){if(t<=0)return 0;throw Error("MEditor: редактор матриц не реализован")}function l_(e,t,r){return r<=0?0:this.kernel.matrices.get(e)?.diag(t)??0}function h_(e,t){if(t<=0)return 0;const r=this.kernel.matrices.get(e);return!r||!r.isSquare()?0:r.det()}function u_(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;const n=this.kernel.matrices.get(t);if(!n)return 0;const a=i.add(n);if(!a)return 0;const l=r||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(l,a),l}function d_(e,t){return t<=0?0:this.kernel.matrices.get(e)?.sum()??0}function f_(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e),n=this.kernel.matrices.get(t);if(!i||!n)return 0;const a=i.mul(n);if(!a)return 0;const l=r||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(l,a),l}function g_(e,t,r,s,i,n){if(n<=0)return 0;const a=this.kernel.matrices.get(e),l=this.kernel.matrices.get(t);if(!a||!l)return 0;const h=r||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(h,a.glue(l,Math.floor(s),Math.floor(i))),h}function p_(e,t,r){if(r<=0)return 0;const s=this.kernel.matrices.get(e);if(!s)return 0;const i=s.obr();if(!i)return 0;const n=t||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(n,i),n}function __(e,t,r){if(r<=0)return 0;const s=this.kernel.matrices.get(e);if(!s)return 0;const i=this.prj.dir.resolve(t).create("file");return i?(i.set({mat:s.data()}),1):0}function E_(e,t,r){if(r<=0)return 0;const s=this.prj.dir.resolve(t).file()?.mat;if(!s)return 0;const i=e||he.freeNegativeKey(this.kernel.matrices);return this.kernel.matrices.set(i,new xe(s)),i}function m_(e,t,r,s){if(s<=0)return 0;const i=this.kernel.matrices.get(e);if(!i)return 0;switch(r){case 1:return i.sortByColumn(t,!1);case 2:return i.sortByColumn(t,!0);case 3:return i.sortByRow(t,!1);case 4:return i.sortByRow(t,!0);default:return 0}}function T_(e,t,r,s,i,n,a,l,h){const d=this.kernel.matrices.get(e);return d?(t[r]=d.minV,s[i]=d.minH,n[a]=d.minV+d.rows-1,l[h]=d.minH+d.cols-1,e):0}function w_(e){e("MCreate",{a:[o,o,o,o,o,o],r:o},s_),e("MDelete",{a:[o,o],r:o},i_),e("MFill",{a:[o,o,o],r:o},n_),e("MGet",{a:[o,o,o,o],r:o},o_),e("MPut",{a:[o,o,o,o,o],r:o},c_),e("MEditor",{a:[o,o]},a_),e("MDiag",{a:[o,o,o],r:o},l_),e("MDet",{a:[o,o],r:o},h_),e("MSum",{a:[o,o],r:o},d_),e("MMul",{a:[o,o,o,o],r:o},f_),e("MGlue",{a:[o,o,o,o,o,o],r:o},g_),e("MObr",{a:[o,o,o],r:o},p_),e("MSaveAs",{a:[o,_,o],r:o},__),e("MLoad",{a:[o,_,o],r:o},E_),e("MSort",{a:[o,o,o,o],r:o},m_),e("MAddC",{a:[o,o,o,o],r:o},u_),e("MDim",{a:[o,I,I,I,I],r:o},T_)}const y_={name:"matrix",register:w_,setup(e){e.matrices=new Map,e.onProjectOpen.add(t=>{t.dir.forEach(r=>{if(!r.mat)return;const s=r.path.basename(),i=parseInt(s.substring(0,s.length-5));isNaN(i)||!i||e.matrices.has(i)||e.matrices.set(i,new xe(r.mat))},!1)})}};function ki(e,t,r,s,i){const n=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!n)return;const a=this.resolve(r);a?.klass.vars.msg&&n.subscribe(a,s,t,i)}function Li(e,t,r){const s=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!s)return;const i=this.resolve(t);i?.klass.vars.msg&&s.unsubscribe(i,r)}function b_(e,t){const r=this.kernel.scenes.get(e);if(!r)return;const s=this.resolve(t);s?.klass.vars.msg&&r.setCapture(s)}function R_(){this.kernel.windowSystem.releaseCapture()}function*O_(e,t,...r){if(this.kernel.recursionLvl>58)return;let s=null;if(t&&(s=this.kernel.classes.get(t),!s))return;/[\*\?]/.test(e)&&this.kernel._functionNotImplemented("SendMessage с path содержащим '*'/'?'",this);const i=this.resolveMany(e,s);if(!i.length)return;const n=new Array(r.length),a=this.klass.vars,l=i[0].klass.vars;for(let h=0;h<r.length;h+=2){const d=a.get(r[h+0]);if(!d)continue;const g=l.get(r[h+1]);g&&(n[h+0]=d,n[h+1]=g)}for(const h of i){if(h===this)return;for(let y=0;y<n.length;y+=2){const P=n[y+0];if(!P)continue;const C=n[y+1];h.vars.setValue(C,this.vars.getNewValue(P))}++this.kernel.recursionLvl,yield*h.computeBranch(),--this.kernel.recursionLvl;const{map:d,values:{newFloats:g,oldFloats:E,newInts:T,oldInts:m,newStrings:O,oldStrings:N}}=h.vars;for(let y=0;y<d.length;++y){const P=d[y];E[P]=g[P],m[P]=T[P],N[P]=O[P]}for(let y=0;y<n.length;y+=2){const P=n[y+0];if(!P)continue;const C=n[y+1];this.setNewValue(P,h.vars.getNewValue(C))}}}function M_(e){e("RegisterObject",{a:[c,c,_,o,o]},ki),e("RegisterObject",{a:[_,c,_,o,o]},ki),e("UnregisterObject",{a:[c,_,o]},Li),e("UnregisterObject",{a:[_,_,o]},Li),e("SetCapture",{a:[c,_,o]},b_),e("ReleaseCapture",{},R_),e("SendMessage",{a:[_,_],rest:[_,_],kind:"generator"},O_)}const S_={name:"messages",deps:["windows"],register:M_,setup(e){e.recursionLvl=0}};function N_(e){if(!e)return 0;const t=_e.indexOf(e[0]);return t<0?0:t}function I_(e){return e<0||e>255?"":_e[e]}function Ci(e,t,r=1){e[t]+=r}function Gi(e,t,r=1){e[t]-=r}function A_(e){return e>1?0:e<-1?Math.PI:Math.acos(e)||0}function v_(e){return e>1?Math.PI/2:e<-1?-Math.PI/2:Math.asin(e)||0}function x_(e,t,r){return e.split(t).join(r)}function P_(e,t,r){return e.substring(0,r)===t.substring(0,r)?1:0}function D_(e,t){return t===0?e>=0?0:Math.PI:t>0?-Math.atan(e/t)+Math.PI/2:-Math.atan(e/t)+Math.PI*1.5}function k_(e){return e>0?(Math.log(e)||0)/Math.LN10:-1e100}function L_(e){return e>0?Math.log(e)||0:-1e100}function C_(e,t){return e>0&&t>0?Math.log(t)/Math.log(e)||0:-1e100}function G_(e,t,r){if(t==="")return-1;for(var s=-1,i=0,n=0;n<r;++n){if(s=e.indexOf(t,i),s<0)return-1;i=s+t.length}return s}function B_(e,t){return e.substring(e.length-t)}function F_(e,t){var r=Math.ceil(10**t);return Math.round(e*r-Number.EPSILON)/r||0}function W_(e,t){return e.substring(t)}function U_(e,t,r){return e.substring(t,Math.max(t,0)+r)}function V_(e){e("Arccos",{a:[o],r:o},A_),e("Arcsin",{a:[o],r:o},v_),e("Ascii",{a:[_],r:o},N_),e("Change",{a:[_,_,_],r:_},x_),e("Chr",{a:[o],r:_},I_),e("Comparei",{a:[_,_,o],r:o},P_),e("Dec",{a:[I,o]},Gi),e("Dec",{a:[I]},Gi),e("GetangleByXY",{a:[o,o],r:o},D_),e("Inc",{a:[I,o]},Ci),e("Inc",{a:[I]},Ci),e("Lg",{a:[o],r:o},k_),e("Ln",{a:[o],r:o},L_),e("Log",{a:[o,o],r:o},C_),e("Pos",{a:[_,_,o],r:o},G_),e("Randomize",{a:[o]},na),e("Right",{a:[_,o],r:_},B_),e("Round",{a:[o,o],r:o},F_),e("Substr",{a:[_,o,o],r:_},U_),e("Substr",{a:[_,o],r:_},W_)}const $_={name:"misc",register:V_};function j_(e){const t=this.prj.dir.resolve(e).file()?.video;if(!t)return 0;const r=he.freeKey(this.kernel.videos);return this.kernel.videos.set(r,t),r}function H_(e,t,r,s,i,n){const a=this.kernel.videos.get(t);if(!a)return 0;const l=this.kernel.scenes.get(e);if(!l)return 0;const h=l.scene;let d=r,g=s;const E=l.matrix;if(E){const O=r*E[2]+s*E[5]+E[8];d=(r*E[0]+s*E[3]+E[6])/O,g=(r*E[1]+s*E[4]+E[7])/O}const T=i>=0||n>=0,m=h.video(a.src,{x:d,y:g,width:Math.max(0,i),height:Math.max(0,n),fixed:T});return h.set({order:h.order.concat(m)}),m.key}function X_(e,t){throw Error("videoSetPos2d: Not implemented")}function Y_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"?r.currentTime()*Cs:0}function z_(e,t,r){const s=this.kernel.scenes.get(e)?.scene.objects.get(t);return s?.type==="videoView"&&s.setCurrentTime(r/Cs)?1:0}function K_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.play()?1:0}function q_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.pause()?1:0}function Z_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.play()?1:0}function J_(e,t){const r=this.kernel.scenes.get(e)?.scene.objects.get(t);return r?.type==="videoView"&&r.stop()?1:0}function Q_(){return v.MCIERR_INVALID_DEVICE_NAME}function eE(){return""}function tE(){return 0}function rE(e){e("OpenVideo",{a:[_,o],r:c},j_),e("CreateVideoFrame2d",{a:[c,c,o,o,o,o,o],r:c},H_),e("VideoSetPos2d",{a:[c,o],r:o},X_),e("FrameGetPos2d",{a:[c,c],r:o},Y_),e("FrameSetPos2d",{a:[c,c,o],r:o},z_),e("VideoPlay2d",{a:[c,c,o,o,o,o],r:o},K_),e("VideoPause2d",{a:[c,c],r:o},q_),e("VideoResume2d",{a:[c,c],r:o},Z_),e("VideoStop2d",{a:[c,c],r:o},J_),e("MciSendString",{a:[_],r:o},Q_),e("MciSendStringStr",{a:[_],r:_},eE),e("SndPlaySound",{a:[_,o],r:o},tE)}const sE={name:"multimedia",deps:["windows"],register:rE,setup(e){e.videos=new Map}},iE=new Map([["ShiftLeft",16],["ShiftRight",16],["ControlLeft",17],["ControlRight",17],["AltLeft",18],["AltRight",18],["CapsLock",20],["Tab",9],["Enter",13],["Escape",27],["Space",32],["Backspace",8],["ArrowUp",38],["ArrowDown",40],["ArrowLeft",37],["ArrowRight",39],["MetaLeft",91],["MetaRight",92],["ContextMenu",93],["Delete",46],["Insert",45],["Home",36],["End",35],["PageUp",33],["PageDown",34],["F1",112],["F2",113],["F3",114],["F4",115],["F5",116],["F6",117],["F7",118],["F8",119],["F9",120],["F10",121],["F11",122],["F12",123],["Digit0",48],["Digit1",49],["Digit2",50],["Digit3",51],["Digit4",52],["Digit5",53],["Digit6",54],["Digit7",55],["Digit8",56],["Digit9",57],["KeyA",65],["KeyB",66],["KeyC",67],["KeyD",68],["KeyE",69],["KeyF",70],["KeyG",71],["KeyH",72],["KeyI",73],["KeyJ",74],["KeyK",75],["KeyL",76],["KeyM",77],["KeyN",78],["KeyO",79],["KeyP",80],["KeyQ",81],["KeyR",82],["KeyS",83],["KeyT",84],["KeyU",85],["KeyV",86],["KeyW",87],["KeyX",88],["KeyY",89],["KeyZ",90]]);function nE(e){if(e>=16&&e<=18||e>=112&&e<=135||e>=37&&e<=40)return!1;switch(e){case 27:case 9:case 20:case 144:case 145:case 42:case 19:case 45:case 46:case 36:case 35:case 33:case 34:case 93:case 91:case 92:return!1}return!0}const it=new Uint8Array(256);function Br(e){return e>=0&&e<256?!!it[e]:!1}function Kt(e){it[1]=e.buttons&1,it[2]=e.buttons&2,it[4]=e.buttons&4}const Bi=new Set;function Fi(e){let t=iE.get(e.code);if(t?it[t]=+(e.type==="keydown"):(Bi.has(e.code)||(Bi.add(e.code),console.warn(`Неизвестная клавиша: ${e.code}`)),t=0),e.winVKey=t,e.type==="keydown"&&nE(t)){const r=_e.indexOf(e.key);e.winChar=r<0?t:r}}function oE(){it.fill(0)}window.addEventListener("keydown",Fi,{capture:!0}),window.addEventListener("keyup",Fi,{capture:!0}),window.addEventListener("pointerdown",Kt,{capture:!0}),window.addEventListener("pointerup",Kt,{capture:!0}),window.addEventListener("pointermove",Kt,{capture:!0}),window.addEventListener("pointercancel",Kt,{capture:!0}),window.addEventListener("blur",oE);const Wi=Symbol("renderWindow.parent");let cE=0,aE=0,lE=0,hE=0,uE=0,dE=0,fE=0,gE=0;const Ui=new Set;function b(...e){Ui.size!==Ui.add(e[0]).size&&console.warn(...e)}const pE=Cr(),Fr=Cr();function _E(e,t){b("AnimationState_AddTime",e,t)}function EE(e){throw b("AnimationState_GetEnabled",e),Error("Not implemented")}function mE(e){throw b("AnimationState_GetLength",e),Error("Not implemented")}function TE(e){throw b("AnimationState_GetLoop",e),Error("Not implemented")}function wE(e){throw b("AnimationState_GetTimePosition",e),Error("Not implemented")}function yE(e){throw b("AnimationState_GetWeight",e),Error("Not implemented")}function bE(e,t){b("AnimationState_SetEnabled",e,t)}function RE(e,t){b("AnimationState_SetLength",e,t)}function OE(e,t){b("AnimationState_SetLoop",e,t)}function ME(e,t){b("AnimationState_SetTimePosition",e,t)}function SE(e,t){b("AnimationState_SetWeight",e,t)}function NE(e,t,r,s,i){throw b("Billboard_GetColour",e,t,r,s,i),Error("Not implemented")}function IE(e,t,r,s){throw b("Billboard_GetPosition",e),Error("Not implemented")}function AE(e){throw b("Billboard_GetRotation",e),Error("Not implemented")}function vE(e,t,r,s,i){b("Billboard_SetColour",e,t,r,s,i)}function xE(e,t,r,s){b("Billboard_SetPosition",e,t,r,s)}function PE(e,t){b("Billboard_SetRotation",e,t)}function DE(e,t,r){return this.kernel.egor.createBillboardSet({name:t||"__BillboardSet_"+cE++,poolSize:r}).key??0}function kE(e,t,r,s){return this.kernel.egor.billboardSets.get(e)?.createBillboard(t,r,s).key??0}function LE(e){b("BillboardSet_Destroy",e)}function CE(e,t){throw b("BillboardSet_GetBillboard",e,t),Error("Not implemented")}function GE(e){throw b("BillboardSet_GetBillboardType",e),Error("Not implemented")}function BE(e,t,r,s){throw b("BillboardSet_GetCommonDirection",e,t,r,s),Error("Not implemented")}function FE(e,t,r,s){throw b("BillboardSet_GetCommonUpVector",e,t,r,s),Error("Not implemented")}function WE(e,t,r){throw b("BillboardSet_GetDefaultDimensions",e,t,r),Error("Not implemented")}function UE(e,t){throw b("BillboardSet_GetMaterialName",e,t),Error("Not implemented")}function VE(e){throw b("BillboardSet_GetNumBillboards",e),Error("Not implemented")}function $E(e,t){b("BillboardSet_RemoveBillboard",e,t)}function jE(e,t){this.kernel.egor.billboardSets.get(e)?.setType(t)}function HE(e,t,r,s){this.kernel.egor.billboardSets.get(e)?.setCommonDirection(t,r,s)}function XE(e,t,r,s){this.kernel.egor.billboardSets.get(e)?.setCommonUpVector(t,r,s)}function YE(e,t,r){this.kernel.egor.billboardSets.get(e)?.setDimensions(t,r)}function zE(e,t){this.kernel.egor.billboardSets.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function KE(e){throw b("Bone_GetManuallyControlled",e),Error("Not implemented")}function qE(e){b("Bone_Reset",e)}function ZE(e,t){b("Bone_SetManuallyControlled",e,t)}function JE(e,t){return this.kernel.egor.scenes.get(e)?.createCamera({name:t||"__Camera_"+aE++}).key??0}function QE(e){b("Camera_Destroy",e)}function em(e){throw b("Camera_GetAspectRatio",e),Error("Not implemented")}function tm(e){throw b("Camera_GetFarClipDistance",e),Error("Not implemented")}function rm(e){throw b("Camera_GetFOV",e),Error("Not implemented")}function sm(e){throw b("Camera_GetNearClipDistance",e),Error("Not implemented")}function im(e){throw b("Camera_GetPolygonMode",e),Error("Not implemented")}function nm(e){throw b("Camera_GetProjectionType",e),Error("Not implemented")}function om(e,t){b("Camera_SetAspectRatio",e,t)}function cm(e,t){this.kernel.egor.cameras.get(e)?.set({farDist:t})}function am(e,t){b("Camera_SetFocalLength",e,t)}function lm(e,t){this.kernel.egor.cameras.get(e)?.set({fov:t})}function hm(e,t,r){b("Camera_SetFrustumOffset",e,t,r)}function um(e,t){this.kernel.egor.cameras.get(e)?.set({nearDist:t})}function dm(e,t){b("Camera_SetPolygonMode",e,t)}function fm(e,t){b("Camera_SetProjectionType",e,t)}function gm(e){return this.kernel.egorRayCastResult?.getEntry(e)?.distance||0}function pm(e){return this.kernel.egorRayCastResult?.getEntry(e)?.movable.key||0}function _m(){return this.kernel.egorRayCastResult?.length||0}function Em(e,t,r,s,i,n,a){const l=this.kernel.egor.scenes.get(e);if(!l){this.kernel.egorRayCastResult=null;return}const{dir:h,origin:d}=Fr;d[0]=t,d[1]=r,d[2]=s,h[0]=i,h[1]=n,h[2]=a,this.kernel.egorRayCastResult=l?.rayCast(Fr)}function mm(){this.kernel.egorRayCastResult?.sort()}function Tm(e){throw b("Compositor_GetEnabled",e),Error("Not implemented")}function wm(e,t){b("Compositor_SetEnabled",e,t)}function ym(e,t,r){if(!r)return 0;const s=this.kernel.egor.scenes.get(e);if(!s)return 0;const i=this.kernel.egor.meshResByNameUC.get(r.toUpperCase());if(!i)throw Error(`Mesh не существует: '${r}'`);return s.createEntity(i,{name:t||"__Entity_"+lE++}).key??0}function bm(e){this.kernel.egor.entities.get(e)?.destroy()}function Rm(e,t){throw b("Entity_GetAnimationState",e,t),Error("Not implemented")}function Om(e,t){throw b("Entity_GetBone",e,t),Error("Not implemented")}function Mm(e,t){throw b("Entity_GetIndexCount",e,t),Error("Not implemented")}function Sm(e,t,r){throw b("Entity_GetMaterial",e,t,r),Error("Not implemented")}function Nm(e){return this.kernel.egor.entities.get(e)?.subEntities.length??0}function Vi(e,t=0){const r=this.kernel.egor.entities.get(e);return r?t>=0?r.subEntity(t)?.vertexCount??0:r.subEntities.reduce((s,i)=>s+i.vertexCount,0):0}function Im(e,t,r){const s=this.kernel.egor.entities.get(e);if(!s)return;const i=this.kernel.egor.materialByName.get(r);i&&s.subEntity(t)?.setMaterial(i)}function Am(e,t){return this.kernel.egor.createLight({name:t||"__Light_"+hE++}).key??0}function vm(e){b("Light_Destroy",e)}function xm(e){throw b("Light_GetPowerScale",e),Error("Not implemented")}function Pm(e,t,r,s,i){b("Light_SetAttenuation",e,t,r,s,i)}function Dm(e,t,r,s){b("Light_SetDiffuseColour",e,t,r,s)}function km(e,t){b("Light_SetPowerScale",e,t)}function Lm(e,t,r,s){b("Light_SetSpecularColour",e,t,r,s)}function Cm(e,t,r,s){b("Light_SetSpotlightRange",e,t,r,s)}function Gm(e,t){b("Light_SetType",e,t)}function Bm(e,t,r){const{egor:s}=this.kernel,i=s.manualObjects.get(e);if(!i)return;const n=s.materialByName.get(t)||null,a=i.createSection(r,n);this.kernel.egorManualObjectsSections.set(i,a)}function Fm(e){this.kernel.egor.manualObjects.get(e)?.clear()}function Wm(e,t,r,s,i){b("ManualObject_Colour",e,t,r,s,i)}function Um(e,t){b("ManualObject_ConvertToMesh",e,t)}function Vm(e,t){return this.kernel.egor.scenes.get(e)?.createManualObject({name:t||"__ManualObject_"+uE++}).key||0}function $m(e){this.kernel.egor.manualObjects.get(e)?.destroy()}function jm(e){const t=this.kernel.egor.manualObjects.get(e);if(!t)return;const r=this.kernel.egorManualObjectsSections.get(t);r&&(r.end(),this.kernel.egorManualObjectsSections.delete(t))}function Hm(e,t){b("ManualObject_EstimateIndexCount",e,t)}function Xm(e,t){b("ManualObject_EstimateVertexCount",e,t)}function Ym(e){throw b("ManualObject_GetDynamic",e),Error("Not implemented")}function zm(e,t){b("ManualObject_Index",e,t)}function Km(e,t,r,s){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addNormal(t,r,s)}function qm(e,t,r,s){const i=this.kernel.egor.manualObjects.get(e);i&&this.kernel.egorManualObjectsSections.get(i)?.addVertex(t,r,s)}function Zm(e,t){b("ManualObject_SetDynamic",e,t)}function Jm(e,t,r){b("ManualObject_TextureCoord",e,t,r)}function Qm(e){return this.kernel.egor.createMaterial(e||"__Material_"+dE++).key}function eT(e){return e&&this.kernel.egor.materialByName.get(e)?.key||0}function tT(e){throw b("Material_GetBestTechnique",e),Error("Not implemented")}function rT(e,t){throw b("Material_GetName",e,t),Error("Not implemented")}function sT(e,t){return this.kernel.egor.materialByKey.get(e)?.tech(t)?.key??0}function iT(e,t){throw b("Material_GetTechniqueByName",e,t),Error("Not implemented")}function nT(e,t,r,s,i,n,a){throw b("Movable_GetBoundingBox",e,t,r,s,i,n,a),Error("Not implemented")}function oT(e){throw b("Movable_GetCastShadows",e),Error("Not implemented")}function cT(e,t,r){const s=this.kernel.egor.movables.get(e);s&&(t[r]=s.name)}function aT(e){return this.kernel.egor.movables.get(e)?.node?.key??0}function lT(e){const t=this.kernel.egor.movables.get(e);return t?t.visible?1:0:-1}function hT(e,t){b("Movable_SetCastShadows",e,t)}function uT(e,t){const r=this.kernel.egor.movables.get(e);r&&this.kernel.egor.sceneNodes.get(t)?.attach(r)}function dT(e,t){this.kernel.egor.movables.get(e)?.setVisible(!!t)}function fT(e,t,r){return this.kernel.egor.createMovableText(t,{name:e||"__MovableText_"+fE++,fontName:r}).key}function gT(e){b("MovableText_Destroy",e)}function pT(e,t){throw b("MovableText_GetCaption",e,t),Error("Not implemented")}function _T(e){throw b("MovableText_GetCharacterHeight",e),Error("Not implemented")}function ET(e,t,r,s,i){throw b("MovableText_GetColor",e,t,r,s,i),Error("Not implemented")}function mT(e,t){throw b("MovableText_GetFontName",e,t),Error("Not implemented")}function TT(e,t,r,s){throw b("MovableText_GetGlobalTranslation",e,t,r,s),Error("Not implemented")}function wT(e,t,r,s){throw b("MovableText_GetLocalTranslation",e,t,r,s),Error("Not implemented")}function yT(e){throw b("MovableText_GetSpaceWidth",e),Error("Not implemented")}function bT(e,t,r){throw b("MovableText_GetTextAlignment",e,t,r),Error("Not implemented")}function RT(e,t){b("MovableText_SetCaption",e,t)}function OT(e,t){this.kernel.egor.movableTexts.get(e)?.setCharHeight(t)}function MT(e,t,r,s,i){b("MovableText_SetColor",e,t,r,s,i)}function ST(e,t){b("MovableText_SetFontName",e,t)}function NT(e,t,r,s){b("MovableText_SetGlobalTranslation",e,t,r,s)}function IT(e,t,r,s){b("MovableText_SetLocalTranslation",e,t,r,s)}function AT(e,t){b("MovableText_SetSpaceWidth",e,t)}function vT(e,t,r){b("MovableText_SetTextAlignment",e,t,r)}function xT(e,t){b("Node_AddChild",e,t)}function PT(e,t){return this.kernel.egor.nodes.get(e)?.getChild(t)?.key||0}function DT(e,t,r,s,i,n,a){const l=this.kernel.egor.nodes.get(e);if(!l)return;const h=l.getWorldPosition();t[r]=h[0],s[i]=h[1],n[a]=h[2]}function kT(e,t,r,s,i,n,a,l,h){const d=this.kernel.egor.nodes.get(e);if(!d)return;const g=d.getWorldRotation();s[i]=g[0],n[a]=g[1],l[h]=g[2],t[r]=g[3]}function LT(e,t,r,s,i,n,a){const l=this.kernel.egor.nodes.get(e);if(!l)return;const h=l.getWorldScale();t[r]=h[0],s[i]=h[1],n[a]=h[2]}function CT(e,t,r){t[r]=this.kernel.egor.nodes.get(e)?.name??""}function GT(e){return this.kernel.egor.nodes.get(e)?.children.length??-1}function BT(e){throw b("Node_GetParent",e),Error("Not implemented")}function FT(e,t,r,s,i,n,a){const l=this.kernel.egor.nodes.get(e);l&&(t[r]=l.position[0],s[i]=l.position[1],n[a]=l.position[2])}function WT(e,t,r,s,i,n,a,l,h){const d=this.kernel.egor.nodes.get(e);d&&(s[i]=d.rotation[0],n[a]=d.rotation[1],l[h]=d.rotation[2],t[r]=d.rotation[3])}function UT(e,t,r,s,i,n,a){const l=this.kernel.egor.nodes.get(e);l&&(t[r]=l.scale[0],s[i]=l.scale[1],n[a]=l.scale[2])}function VT(e,t){b("Node_RemoveChild",e,t)}function $T(e,t){const r=this.kernel.egor.nodes.get(t);if(!r)return;const s=this.kernel.egor.nodes.get(e);s&&r.addChild(s)}function jT(e,t,r,s){this.kernel.egor.nodes.get(e)?.setPosition(t,r,s)}function HT(e,t,r,s,i){throw b("Node_SetRotationAxis",e,t,r,s,i),Error("Node_SetRotationAxis")}function XT(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateX(t).rotateY(r).rotateZ(s)}function YT(e,t,r,s){throw Error()}function zT(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateY(t).rotateX(r).rotateZ(s)}function KT(e,t,r,s){throw Error()}function qT(e,t,r,s){throw Error()}function ZT(e,t,r,s){this.kernel.egor.nodes.get(e)?.resetRotation().rotateZ(t).rotateY(r).rotateX(s)}function JT(e,t,r,s,i){this.kernel.egor.nodes.get(e)?.setRotation(r,s,i,t)}function QT(e,t,r,s){this.kernel.egor.nodes.get(e)?.setScale(t,r,s)}function ew(e,t){const r=this.kernel.egor.overlays.get(e);if(!r)return;const s=this.kernel.egor.overlayElements.get(t);s&&r.setChildren(r.children.concat(s))}function tw(e){return this.kernel.egor.createOverlay(e).key}function rw(e,t,r){throw b("Overlay_FindElementAt",e,t,r),Error("Not implemented")}function sw(e){if(!e)return 0;for(const t of this.kernel.egor.overlays.values())if(t.name===e)return t.key;return 0}function iw(e,t){throw b("Overlay_GetName",e,t),Error("Not implemented")}function nw(e){throw b("Overlay_GetRotate",e),Error("Not implemented")}function ow(e,t,r){throw b("Overlay_GetScale",e,t,r),Error("Not implemented")}function cw(e,t,r){throw b("Overlay_GetScroll",e,t,r),Error("Not implemented")}function aw(e){throw b("Overlay_GetVisible",e),Error("Not implemented")}function lw(e){throw b("Overlay_GetZOrder",e),Error("Not implemented")}function hw(e,t){b("Overlay_RemoveChild",e,t)}function uw(e,t){b("Overlay_SetRotate",e,t)}function dw(e,t,r){this.kernel.egor.overlays.get(e)?.setScale(t,r)}function fw(e,t,r){b("Overlay_SetScroll",e,t,r)}function gw(e,t){this.kernel.egor.overlays.get(e)?.setVisible(!!t)}function pw(e,t){this.kernel.egor.overlays.get(e)?.setZ(t)}function _w(e,t){const r=this.kernel.egor.overlayElements.get(e);if(!r)return;const s=this.kernel.egor.overlayElements.get(t);s&&r.setChildren(r.children.concat(s))}function Ew(e,t){throw b("OverlayContainer_GetChild",e,t),Error("Not implemented")}function mw(e){throw b("OverlayContainer_GetChildCount",e),Error("Not implemented")}function Tw(e,t){b("OverlayContainer_RemoveChild",e,t)}function ww(e,t){if(e!=="BorderPanel"&&e!=="Panel"&&e!=="TextArea")throw Error(`Неизвестный тип OverlayElement: '${e}'`);return this.kernel.egor.createOverlayElement(e,{name:t}).key}function yw(e){if(!e)return 0;for(const t of this.kernel.egor.overlayElements.values())if(t.name===e)return t.key;return 0}function bw(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.horAlign??0,s[i]=n?.vertAlign??0}function Rw(e,t,r){t[r]=this.kernel.egor.overlayElements.get(e)?.caption??""}function Ow(e,t,r,s,i){throw b("OverlayElement_GetColour",e,t,r,s,i),Error("Not implemented")}function Mw(e,t,r){t[r]=this.kernel.egor.overlayElements.get(e)?.material?.name??""}function Sw(e){return this.kernel.egor.overlayElements.get(e)?.metricsMode??0}function Nw(e){return this.kernel.egor.overlayElements.get(e)?.parent?.key??0}function Iw(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.x??0,s[i]=n?.y??0}function Aw(e,t,r,s,i){const n=this.kernel.egor.overlayElements.get(e);t[r]=n?.width??0,s[i]=n?.height??0}function vw(e){const t=this.kernel.egor.overlayElements.get(e);return t?t.visible?1:0:-1}function xw(e){throw b("OverlayElement_IsContainer",e),Error("Not implemented")}function Pw(e,t,r){this.kernel.egor.overlayElements.get(e)?.setAlignment(t,r)}function Dw(e,t){this.kernel.egor.overlayElements.get(e)?.setCaption(t)}function kw(e,t,r,s,i){this.kernel.egor.overlayElements.get(e)?.setColor(t,r,s,i)}function Lw(e,t){this.kernel.egor.overlayElements.get(e)?.setMaterial(this.kernel.egor.materialByName.get(t)??null)}function Cw(e,t){this.kernel.egor.overlayElements.get(e)?.setMetricsMode(t)}function Gw(e,t,r){this.kernel.egor.overlayElements.get(e)?.setPosition(t,r)}function Bw(e,t,r){this.kernel.egor.overlayElements.get(e)?.setSize(t,r)}function Fw(e,t){this.kernel.egor.overlayElements.get(e)?.setVisible(!!t)}function Ww(e,t,r){throw b("ParticleSystem_Create",e,t,r),Error("Not implemented")}function Uw(e,t,r){throw b("ParticleSystem_CreateEx",e,t,r),Error("Not implemented")}function Vw(e){b("ParticleSystem_Destroy",e)}function $w(e,t){b("ParticleSystem_GetName",e,t)}function jw(e){throw b("ParticleSystem_GetParent",e),Error("Not implemented")}function Hw(e){throw b("ParticleSystem_GetVisible",e),Error("Not implemented")}function Xw(e,t){b("ParticleSystem_SetParent",e,t)}function Yw(e,t){b("ParticleSystem_SetVisible",e,t)}function zw(e,t){throw b("Pass_Create",e,t),Error("Not implemented")}function Kw(e,t,r){throw b("Pass_GetAlphaRejectSettings",e,t,r),Error("Not implemented")}function qw(e,t,r,s,i){throw b("Pass_GetAmbient",e,t,r,s,i),Error("Not implemented")}function Zw(e){throw b("Pass_GetColourWriteEnabled",e),Error("Not implemented")}function Jw(e){throw b("Pass_GetCullingMode",e),Error("Not implemented")}function Qw(e){throw b("Pass_GetDepthCheckEnabled",e),Error("Not implemented")}function e0(e){throw b("Pass_GetDepthFunction",e),Error("Not implemented")}function t0(e){throw b("Pass_GetDepthWriteEnabled",e),Error("Not implemented")}function r0(e,t,r,s,i){throw b("Pass_GetDiffuse",e,t,r,s,i),Error("Not implemented")}function s0(e){throw b("Pass_GetLightingEnabled",e),Error("Not implemented")}function i0(e){throw b("Pass_GetPolygonMode",e),Error("Not implemented")}function n0(e,t,r){throw b("Pass_GetSceneBlending",e,t,r),Error("Not implemented")}function o0(e,t,r,s,i){throw b("Pass_GetSelfIllumination",e,t,r,s,i),Error("Not implemented")}function c0(e){throw b("Pass_GetShadingMode",e),Error("Not implemented")}function a0(e){throw b("Pass_GetShininess",e),Error("Not implemented")}function l0(e,t,r,s,i){throw b("Pass_GetSpecular",e,t,r,s,i),Error("Not implemented")}function h0(e,t){throw b("Pass_GetTextureUnitStateByIndex",e,t),Error("Not implemented")}function u0(e,t){throw b("Pass_GetTextureUnitStateByName",e,t),Error("Not implemented")}function d0(e,t,r){b("Pass_SetAlphaRejectSettings",e,t,r)}function f0(e,t,r,s){this.kernel.egor.passes.get(e)?.setAmbient(t,r,s)}function g0(e,t){b("Pass_SetColourWriteEnabled",e,t)}function p0(e,t){b("Pass_SetCullingMode",e,t)}function _0(e,t){this.kernel.egor.passes.get(e)?.setDepthCheckEnabled(!!t)}function E0(e,t){b("Pass_SetDepthFunction",e,t)}function m0(e,t){this.kernel.egor.passes.get(e)?.setDepthWriteEnabled(!!t)}function T0(e,t,r,s,i){this.kernel.egor.passes.get(e)?.setDiffuse(t,r,s,i)}function w0(e,t){this.kernel.egor.passes.get(e)?.setLightingEnabled(!!t)}function y0(e,t){b("Pass_SetPolygonMode",e,t)}function b0(e,t,r){this.kernel.egor.passes.get(e)?.setSceneBlending(t,r)}function R0(e,t,r,s){this.kernel.egor.passes.get(e)?.setEmissive(t,r,s)}function O0(e,t){this.kernel.egor.passes.get(e)?.setShadingMode(t)}function M0(e,t){this.kernel.egor.passes.get(e)?.setShininess(t)}function S0(e,t,r,s,i){this.kernel.egor.passes.get(e)?.setSpecular(t,r,s,i)}function N0(e,t,r){throw b("RenderTexture_Create",e,t,r),Error("Not implemented")}function I0(e){b("RenderTexture_Destroy",e)}function $i(e,t,r,s){const i=e.createRenderWindow(r,s);return t.createFrame(i.domElement).onDisposed.add(i.close.bind(i)),i[Wi]=t,i}function A0(e){const t=this.kernel.scenes.get(e);if(!t)throw Error("Внешние 3D окна не поддерживаются");return $i(this.kernel.egor,t,t.getClientWidth(),t.getClientHeight()).key}function v0(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)throw Error("Внешние 3D окна не поддерживаются");return $i(this.kernel.egor,i,r,s).key}function x0(e,t,r,s){throw b("RenderWindow_CreateEx",e,t,r,s),Error("Not implemented")}function P0(e){b("RenderWindow_Destroy",e)}function D0(e){throw b("RenderWindow_Get",e),Error("Not implemented")}function k0(){throw b("RenderWindow_GetCount"),Error("Not implemented")}function L0(e){throw b("RenderWindow_GetCursorHovered",e),Error("Not implemented")}function C0(e,t,r,s,i){const n=this.kernel.egor.windows.get(e)?.[Wi];t[r]=n?.mouseX??0,s[i]=n?.mouseY??0}function G0(e,t){return Br(t)?1:0}function B0(e,t){const r=t===0?"left":t===1?"right":t===2?"middle":null;return Br(r==="left"?1:r==="right"?2:4)?1:0}function F0(e,t,r,s,i){const n=this.kernel.egor.windows.get(e);t[r]=n?.x??0,s[i]=n?.y??0}function W0(){return this.kernel.egor.primaryWindow?.key??0}function U0(e,t,r,s,i){const n=this.kernel.egor.windows.get(e);t[r]=n?.width??0,s[i]=n?.height??0}function V0(e,t){throw b("RenderWindow_GetViewport",e,t),Error("Not implemented")}function $0(e){return this.kernel.egor.windows.get(e)?.viewports.size??0}function j0(e){return this.kernel.egor.windows.get(e)?.wheelPosition??0}function H0(e,t,r){b("RenderWindow_SetPosition",e,t,r)}function X0(e,t,r){b("RenderWindow_SetSize",e,t,r)}function Y0(e){throw b("RenderWindow_ToggleFullscreen",e),Error("Not implemented")}function z0(e,t,r,s){b("Root_AddResourceLocation",e,t,r,s)}function K0(e){Gs(this.prj.dir.resolve(e))?.split(`\r
`).forEach(r=>{const s=r.trim().toUpperCase();if(!s.startsWith("FILESYSTEM")&&!s.startsWith("ZIP"))return;const i=s.split("=")[1].trim();this.prj.dir.resolve(i).forEach(a=>{if(a.image){const l=a.path.basename(),h=this.kernel.egor.createImage(a.image,l);h.meta=a.path.toString();return}if(a.mesh){const l=a.path.basename(),h=this.kernel.egor.createMesh(a.mesh,l);h.meta=a.path.toString();return}if(a.base64){const l=a.path.basename().toUpperCase(),h=Gs(a.path);if(l.endsWith(".MATERIAL")){const d=h.split(`
`).map(g=>g.trim());for(let g=0;g<d.length;g++){const E=d[g],T=E.startsWith("material ")&&E.replace("material ","").split('"').join("");if(!T)continue;const O=this.kernel.egor.createMaterial(T).techs[0].passes[0];for(let N=g+1;N<d.length;N++){const y=d[N];if(y==="}")break;const P=y.startsWith("shading ")&&y.replace("shading ","");if(P){const D=P.toLowerCase()==="phong"?v.SO_PHONG:v.SO_GOURAUD;O.setShadingMode(D);continue}const C=y.startsWith("ambient ")&&y.replace("ambient ","");if(C){const D=C.split(" ").map(parseFloat);if(D.length<3||D.some(isNaN))continue;O.setAmbient(...D);continue}const L=y.startsWith("diffuse ")&&y.replace("diffuse ","");if(L){const D=L.split(" ").map(parseFloat);if(D.length<4||D.some(isNaN))continue;O.setDiffuse(...D);continue}const W=y.startsWith("specular ")&&y.replace("specular ","");if(W){const D=W.split(" ").map(parseFloat);if(D.length<4||D.some(isNaN))continue;O.setSpecular(...D),D.length>4&&O.setShininess(D[4]);continue}const F=y.startsWith("emissive ")&&y.replace("emissive ","");if(F){const D=F.split(" ").map(parseFloat);if(D.length<3||D.some(isNaN))continue;O.setEmissive(...D),D.length>4&&O.setShininess(D[4]);continue}if(y.startsWith("texture_unit"))for(let D=N+1;D<d.length;D++){const x=d[D];if(x==="}")break;const j=x.startsWith("texture ")&&x.replace("texture ","");if(j){const Z=j.toUpperCase();O.createTextureUnit().setTextureName(Z);continue}}}}}}},!1)})}function q0(){}function Z0(){b("Root_Destroy")}function J0(){throw b("Root_GetTime"),Error("Not implemented")}function Q0(){}function ey(){}function ty(){return 1}function ry(){return this.kernel.egorShouldRender=!0,1}function sy(){return 1}function iy(){b("Root_SaveConfig")}function ny(){return 1}function oy(e){b("Scene_Clear",e)}function cy(e){if(e!=="OctreeSceneManager"&&e!=="BSPSceneManager"&&e!=="TerrainSceneManager")throw Error(`Неподдерживаемый тип сцены: ${e}`);return this.kernel.egor.createScene().key}function ay(e){b("Scene_Destroy",e)}function ly(e,t){throw b("Scene_GetCamera",e,t),Error("Not implemented")}function hy(e,t){if(!t)return 0;const r=this.kernel.egor.scenes.get(e);if(!r)return 0;for(const s of this.kernel.egor.entities.values())if(s.scene===r&&s.name===t)return s.key;return 0}function uy(e,t){throw b("Scene_GetLight",e,t),Error("Not implemented")}function dy(e,t){throw b("Scene_GetParticleSystem",e,t),Error("Not implemented")}function fy(e){return this.kernel.egor.scenes.get(e)?.root.key??0}function gy(e,t){if(!t)return 0;const r=this.kernel.egor.scenes.get(e);if(!r)return 0;for(const s of this.kernel.egor.sceneNodes.values())if(s.scene===r&&s.name===t)return s.key;return 0}function py(e){throw b("Scene_GetShadowTechnique",e),Error("Not implemented")}function _y(e,t){b("Scene_Load",e,t)}function Ey(e,t,r,s){this.kernel.egor.scenes.get(e)?.setAmbient(t,r,s)}function my(e,t,r,s,i,n,a,l){b("Scene_SetFog",e,t,r,s,i,n,a,l)}function Ty(e,t){b("Scene_SetShadowTechnique",e,t)}function wy(e,t,r,s){e&&b("Scene_SetSkyBox",e,t,r,s)}function yy(e,t){b("Scene_SetWorldGeometry",e,t)}function by(e,t){b("SceneNode_AttachObject",e,t)}function Ry(e,t){return this.kernel.egor.scenes.get(e)?.createSceneNode({name:t||"__SceneNode_"+gE++}).key??0}function Oy(e){this.kernel.egor.sceneNodes.get(e)?.destroy()}function My(e,t){b("SceneNode_DetachObject",e,t)}function Sy(e){return this.kernel.egor.sceneNodes.get(e)?.movables.length??-1}function Ny(e,t){return this.kernel.egor.sceneNodes.get(e)?.getMovable(t)?.key||0}function Iy(e){throw b("SceneNode_GetScene",e),Error("Not implemented")}function Ay(e,t,r,s,i){this.kernel.egor.sceneNodes.get(e)?.setAutoTracking(this.kernel.egor.sceneNodes.get(t)??null,r,s,i)}function vy(e,t,r){const s=this.kernel.egor.sceneNodes.get(e);if(!s)return;const i=!!t;if(!r){s.movables.forEach(n=>n.setVisible(i));return}(function n(a){a.movables.forEach(l=>l.setVisible(i)),a.children.forEach(l=>n(l))})(s)}function xy(e,t,r){b("StringInterface_GetParameter",e,t,r)}function Py(e){throw b("StringInterface_GetParameterCount",e),Error("Not implemented")}function Dy(e,t,r){b("StringInterface_GetParameterDescription",e,t,r)}function ky(e,t,r){b("StringInterface_GetParameterName",e,t,r)}function Ly(e,t){throw b("StringInterface_GetParameterType",e,t),Error("Not implemented")}function Cy(e,t,r){const s=this.kernel.egor.overlayElements.get(e);s&&s.setParam(t,r)}function Gy(e,t){throw b("Technique_Create",e,t),Error("Not implemented")}function By(e,t){return this.kernel.egor.techniques.get(e)?.pass(t)?.key??0}function Fy(e,t){throw b("Technique_GetPassByName",e,t),Error("Not implemented")}function Wy(e,t){return this.kernel.egor.passes.get(e)?.createTextureUnit(t).key??0}function Uy(e,t,r){b("TextureUnitState_GetTexture",e,t,r)}function Vy(e,t,r){this.kernel.egor.texUnits.get(e)?.setTexture(this.kernel.egor.imageResByNameUC.get(t.toUpperCase())??null,r)}function $y(e,t,r){throw b("Viewport_AddCompositor",e,t,r),Error("Not implemented")}function jy(e,t,r){const s=this.kernel.egor.cameras.get(t);return s?this.kernel.egor.windows.get(e)?.createViewport(s,r).key??0:0}function Hy(e){b("Viewport_Destroy",e)}function Xy(e,t,r,s){throw b("Viewport_GetBackgroundColour",e,t,r,s),Error("Not implemented")}function Yy(e){throw b("Viewport_GetCamera",e),Error("Not implemented")}function zy(e,t){throw b("Viewport_GetCompositor",e,t),Error("Not implemented")}function Ky(e,t,r,s,i){throw b("Viewport_GetDimensions",e,t,r,s,i),Error("Not implemented")}function qy(e){throw b("Viewport_GetNumCompositors",e),Error("Not implemented")}function Zy(e){throw b("Viewport_GetOverlaysEnabled",e),Error("Not implemented")}function Jy(e,t,r,s,i,n,a,l,h,d,g,E,T,m,O){const{origin:N,dir:y}=this.kernel.egor.viewports.get(e)?.camera.getRay(t,r,Fr)||pE;s[i]=N[0],n[a]=N[1],l[h]=N[2],d[g]=y[0],E[T]=y[1],m[O]=y[2]}function Qy(e,t){b("Viewport_RemoveCompositor",e,t)}function eb(e,t,r,s){this.kernel.egor.viewports.get(e)?.setBackground(t,r,s)}function tb(e,t){const r=this.kernel.egor.cameras.get(t);r&&this.kernel.egor.viewports.get(e)?.setCamera(r)}function rb(e,t,r,s,i){b("Viewport_SetDimensions",e,t,r,s,i)}function sb(e,t){this.kernel.egor.viewports.get(e)?.enableOverlays(!!t)}function ib(e){e("AnimationState_AddTime",{a:[c,o]},_E),e("AnimationState_GetEnabled",{a:[c],r:o},EE),e("AnimationState_GetLength",{a:[c],r:o},mE),e("AnimationState_GetLoop",{a:[c],r:o},TE),e("AnimationState_GetTimePosition",{a:[c],r:o},wE),e("AnimationState_GetWeight",{a:[c],r:o},yE),e("AnimationState_SetEnabled",{a:[c,o]},bE),e("AnimationState_SetLength",{a:[c,o]},RE),e("AnimationState_SetLoop",{a:[c,o]},OE),e("AnimationState_SetTimePosition",{a:[c,o]},ME),e("AnimationState_SetWeight",{a:[c,o]},SE),e("Billboard_GetColour",{a:[c,I,I,I,I]},NE),e("Billboard_GetPosition",{a:[c,I,I,I]},IE),e("Billboard_GetRotation",{a:[c],r:o},AE),e("Billboard_SetColour",{a:[c,o,o,o,o]},vE),e("Billboard_SetPosition",{a:[c,o,o,o]},xE),e("Billboard_SetRotation",{a:[c,o]},PE),e("BillboardSet_Create",{a:[c,_,o],r:c},DE),e("BillboardSet_CreateBillboard",{a:[c,o,o,o],r:c},kE),e("BillboardSet_Destroy",{a:[c]},LE),e("BillboardSet_GetBillboard",{a:[c,o],r:c},CE),e("BillboardSet_GetBillboardType",{a:[c],r:o},GE),e("BillboardSet_GetCommonDirection",{a:[c,I,I,I]},BE),e("BillboardSet_GetCommonUpVector",{a:[c,I,I,I]},FE),e("BillboardSet_GetDefaultDimensions",{a:[c,I,I]},WE),e("BillboardSet_GetMaterialName",{a:[c,ne]},UE),e("BillboardSet_GetNumBillboards",{a:[c],r:o},VE),e("BillboardSet_RemoveBillboard",{a:[c,c]},$E),e("BillboardSet_SetBillboardType",{a:[c,o]},jE),e("BillboardSet_SetCommonDirection",{a:[c,o,o,o]},HE),e("BillboardSet_SetCommonUpVector",{a:[c,o,o,o]},XE),e("BillboardSet_SetDefaultDimensions",{a:[c,o,o]},YE),e("BillboardSet_SetMaterialName",{a:[c,_]},zE),e("Bone_GetManuallyControlled",{a:[c],r:o},KE),e("Bone_Reset",{a:[c]},qE),e("Bone_SetManuallyControlled",{a:[c,o]},ZE),e("Camera_Create",{a:[c,_],r:c},JE),e("Camera_Destroy",{a:[c]},QE),e("Camera_GetAspectRatio",{a:[c],r:o},em),e("Camera_GetFarClipDistance",{a:[c],r:o},tm),e("Camera_GetFOV",{a:[c],r:o},rm),e("Camera_GetNearClipDistance",{a:[c],r:o},sm),e("Camera_GetPolygonMode",{a:[c],r:o},im),e("Camera_GetProjectionType",{a:[c],r:o},nm),e("Camera_SetAspectRatio",{a:[c,o]},om),e("Camera_SetFarClipDistance",{a:[c,o]},cm),e("Camera_SetFocalLength",{a:[c,o]},am),e("Camera_SetFOV",{a:[c,o]},lm),e("Camera_SetFrustumOffset",{a:[c,o,o]},hm),e("Camera_SetNearClipDistance",{a:[c,o]},um),e("Camera_SetPolygonMode",{a:[c,o]},dm),e("Camera_SetProjectionType",{a:[c,o]},fm),e("Collision_GetDistance",{a:[o],r:o},gm),e("Collision_GetObject",{a:[o],r:c},pm),e("Collision_GetResultCount",{r:o},_m),e("Collision_RayCast",{a:[c,o,o,o,o,o,o]},Em),e("Collision_Sort",{},mm),e("Compositor_GetEnabled",{a:[c],r:o},Tm),e("Compositor_SetEnabled",{a:[c,o]},wm),e("Entity_Create",{a:[c,_,_],r:c},ym),e("Entity_Destroy",{a:[c]},bm),e("Entity_GetAnimationState",{a:[c,_],r:c},Rm),e("Entity_GetBone",{a:[c,_],r:c},Om),e("Entity_GetIndexCount",{a:[c,o],r:o},Mm),e("Entity_GetMaterial",{a:[c,o,ne]},Sm),e("Entity_GetSubEntityCount",{a:[c],r:o},Nm),e("Entity_GetVertexCount",{a:[c],r:o},Vi),e("Entity_GetVertexCount",{a:[c,o],r:o},Vi),e("Entity_SetMaterial",{a:[c,o,_]},Im),e("Light_Create",{a:[c,_],r:c},Am),e("Light_Destroy",{a:[c]},vm),e("Light_GetPowerScale",{a:[c],r:o},xm),e("Light_SetAttenuation",{a:[c,o,o,o,o]},Pm),e("Light_SetDiffuseColour",{a:[c,o,o,o]},Dm),e("Light_SetPowerScale",{a:[c,o]},km),e("Light_SetSpecularColour",{a:[c,o,o,o]},Lm),e("Light_SetSpotlightRange",{a:[c,o,o,o]},Cm),e("Light_SetType",{a:[c,o]},Gm),e("ManualObject_Begin",{a:[c,_,o]},Bm),e("ManualObject_Clear",{a:[c]},Fm),e("ManualObject_Colour",{a:[c,o,o,o,o]},Wm),e("ManualObject_ConvertToMesh",{a:[c,_]},Um),e("ManualObject_Create",{a:[c,_],r:c},Vm),e("ManualObject_Destroy",{a:[c]},$m),e("ManualObject_End",{a:[c]},jm),e("ManualObject_EstimateIndexCount",{a:[c,o]},Hm),e("ManualObject_EstimateVertexCount",{a:[c,o]},Xm),e("ManualObject_GetDynamic",{a:[c],r:o},Ym),e("ManualObject_Index",{a:[c,o]},zm),e("ManualObject_Normal",{a:[c,o,o,o]},Km),e("ManualObject_Position",{a:[c,o,o,o]},qm),e("ManualObject_SetDynamic",{a:[c,o]},Zm),e("ManualObject_TextureCoord",{a:[c,o,o]},Jm),e("Material_Create",{a:[_],r:c},Qm),e("Material_Get",{a:[_],r:c},eT),e("Material_GetBestTechnique",{a:[c],r:c},tT),e("Material_GetName",{a:[c,ne]},rT),e("Material_GetTechniqueByIndex",{a:[c,o],r:c},sT),e("Material_GetTechniqueByName",{a:[c,_],r:c},iT),e("Movable_GetBoundingBox",{a:[c,I,I,I,I,I,I]},nT),e("Movable_GetCastShadows",{a:[c],r:o},oT),e("Movable_GetName",{a:[c,ne]},cT),e("Movable_GetParent",{a:[c],r:c},aT),e("Movable_GetVisible",{a:[c],r:o},lT),e("Movable_SetCastShadows",{a:[c,o]},hT),e("Movable_SetParent",{a:[c,c]},uT),e("Movable_SetVisible",{a:[c,o]},dT),e("MovableText_Create",{a:[_,_,_],r:c},fT),e("MovableText_Destroy",{a:[c]},gT),e("MovableText_GetCaption",{a:[c,ne]},pT),e("MovableText_GetCharacterHeight",{a:[c],r:o},_T),e("MovableText_GetColor",{a:[c,I,I,I,I]},ET),e("MovableText_GetFontName",{a:[c,ne]},mT),e("MovableText_GetGlobalTranslation",{a:[c,I,I,I]},TT),e("MovableText_GetLocalTranslation",{a:[c,I,I,I]},wT),e("MovableText_GetSpaceWidth",{a:[c],r:o},yT),e("MovableText_GetTextAlignment",{a:[c,I,I]},bT),e("MovableText_SetCaption",{a:[c,_]},RT),e("MovableText_SetCharacterHeight",{a:[c,o]},OT),e("MovableText_SetColor",{a:[c,o,o,o,o]},MT),e("MovableText_SetFontName",{a:[c,_]},ST),e("MovableText_SetGlobalTranslation",{a:[c,o,o,o]},NT),e("MovableText_SetLocalTranslation",{a:[c,o,o,o]},IT),e("MovableText_SetSpaceWidth",{a:[c,o]},AT),e("MovableText_SetTextAlignment",{a:[c,o,o]},vT),e("Node_AddChild",{a:[c,c]},xT),e("Node_GetChild",{a:[c,o],r:c},PT),e("Node_GetDerivedPosition",{a:[c,I,I,I]},DT),e("Node_GetDerivedRotationQuaternion",{a:[c,I,I,I,I]},kT),e("Node_GetDerivedScale",{a:[c,I,I,I]},LT),e("Node_GetName",{a:[c,ne]},CT),e("Node_GetNumChildren",{a:[c],r:o},GT),e("Node_GetParent",{a:[c],r:c},BT),e("Node_GetPosition",{a:[c,I,I,I]},FT),e("Node_GetRotationQuaternion",{a:[c,I,I,I,I]},WT),e("Node_GetScale",{a:[c,I,I,I]},UT),e("Node_RemoveChild",{a:[c,c]},VT),e("Node_SetParent",{a:[c,c]},$T),e("Node_SetPosition",{a:[c,o,o,o]},jT),e("Node_SetRotationAxis",{a:[c,o,o,o,o]},HT),e("Node_SetRotationEulerXYZ",{a:[c,o,o,o]},XT),e("Node_SetRotationEulerXZY",{a:[c,o,o,o]},YT),e("Node_SetRotationEulerYXZ",{a:[c,o,o,o]},zT),e("Node_SetRotationEulerYZX",{a:[c,o,o,o]},KT),e("Node_SetRotationEulerZXY",{a:[c,o,o,o]},qT),e("Node_SetRotationEulerZYX",{a:[c,o,o,o]},ZT),e("Node_SetRotationQuaternion",{a:[c,o,o,o,o]},JT),e("Node_SetScale",{a:[c,o,o,o]},QT),e("Overlay_AddChild",{a:[c,c]},ew),e("Overlay_Create",{a:[_],r:c},tw),e("Overlay_FindElementAt",{a:[c,o,o],r:c},rw),e("Overlay_Get",{a:[_],r:c},sw),e("Overlay_GetName",{a:[c,ne]},iw),e("Overlay_GetRotate",{a:[c],r:o},nw),e("Overlay_GetScale",{a:[c,I,I]},ow),e("Overlay_GetScroll",{a:[c,I,I]},cw),e("Overlay_GetVisible",{a:[c],r:o},aw),e("Overlay_GetZOrder",{a:[c],r:o},lw),e("Overlay_RemoveChild",{a:[c,c]},hw),e("Overlay_SetRotate",{a:[c,o]},uw),e("Overlay_SetScale",{a:[c,o,o]},dw),e("Overlay_SetScroll",{a:[c,o,o]},fw),e("Overlay_SetVisible",{a:[c,o]},gw),e("Overlay_SetZOrder",{a:[c,o]},pw),e("OverlayContainer_AddChild",{a:[c,c]},_w),e("OverlayContainer_GetChild",{a:[c,o],r:c},Ew),e("OverlayContainer_GetChildCount",{a:[c],r:o},mw),e("OverlayContainer_RemoveChild",{a:[c,c]},Tw),e("OverlayElement_Create",{a:[_,_],r:c},ww),e("OverlayElement_Get",{a:[_],r:c},yw),e("OverlayElement_GetAlignment",{a:[c,I,I]},bw),e("OverlayElement_GetCaption",{a:[c,ne]},Rw),e("OverlayElement_GetColour",{a:[c,I,I,I,I]},Ow),e("OverlayElement_GetMaterialName",{a:[c,ne]},Mw),e("OverlayElement_GetMetricsMode",{a:[c],r:o},Sw),e("OverlayElement_GetParent",{a:[c],r:c},Nw),e("OverlayElement_GetPosition",{a:[c,I,I]},Iw),e("OverlayElement_GetSize",{a:[c,I,I]},Aw),e("OverlayElement_GetVisible",{a:[c],r:o},vw),e("OverlayElement_IsContainer",{a:[c],r:o},xw),e("OverlayElement_SetAlignment",{a:[c,o,o]},Pw),e("OverlayElement_SetCaption",{a:[c,_]},Dw),e("OverlayElement_SetColour",{a:[c,o,o,o,o]},kw),e("OverlayElement_SetMaterialName",{a:[c,_]},Lw),e("OverlayElement_SetMetricsMode",{a:[c,o]},Cw),e("OverlayElement_SetPosition",{a:[c,o,o]},Gw),e("OverlayElement_SetSize",{a:[c,o,o]},Bw),e("OverlayElement_SetVisible",{a:[c,o]},Fw),e("ParticleSystem_Create",{a:[c,_,_],r:c},Ww),e("ParticleSystem_CreateEx",{a:[c,_,_],r:c},Uw),e("ParticleSystem_Destroy",{a:[c]},Vw),e("ParticleSystem_GetName",{a:[c,_]},$w),e("ParticleSystem_GetParent",{a:[c],r:c},jw),e("ParticleSystem_GetVisible",{a:[c],r:o},Hw),e("ParticleSystem_SetParent",{a:[c,c]},Xw),e("ParticleSystem_SetVisible",{a:[c,o]},Yw),e("Pass_Create",{a:[c,_],r:c},zw),e("Pass_GetAlphaRejectSettings",{a:[c,I,I]},Kw),e("Pass_GetAmbient",{a:[c,I,I,I,I]},qw),e("Pass_GetColourWriteEnabled",{a:[c],r:o},Zw),e("Pass_GetCullingMode",{a:[c],r:o},Jw),e("Pass_GetDepthCheckEnabled",{a:[c],r:o},Qw),e("Pass_GetDepthFunction",{a:[c],r:o},e0),e("Pass_GetDepthWriteEnabled",{a:[c],r:o},t0),e("Pass_GetDiffuse",{a:[c,I,I,I,I]},r0),e("Pass_GetLightingEnabled",{a:[c],r:o},s0),e("Pass_GetPolygonMode",{a:[c],r:o},i0),e("Pass_GetSceneBlending",{a:[c,I,I]},n0),e("Pass_GetSelfIllumination",{a:[c,I,I,I,I]},o0),e("Pass_GetShadingMode",{a:[c],r:o},c0),e("Pass_GetShininess",{a:[c],r:o},a0),e("Pass_GetSpecular",{a:[c,I,I,I,I]},l0),e("Pass_GetTextureUnitStateByIndex",{a:[c,o],r:c},h0),e("Pass_GetTextureUnitStateByName",{a:[c,_],r:c},u0),e("Pass_SetAlphaRejectSettings",{a:[c,o,o]},d0),e("Pass_SetAmbient",{a:[c,o,o,o,o]},f0),e("Pass_SetColourWriteEnabled",{a:[c,o]},g0),e("Pass_SetCullingMode",{a:[c,o]},p0),e("Pass_SetDepthCheckEnabled",{a:[c,o]},_0),e("Pass_SetDepthFunction",{a:[c,o]},E0),e("Pass_SetDepthWriteEnabled",{a:[c,o]},m0),e("Pass_SetDiffuse",{a:[c,o,o,o,o]},T0),e("Pass_SetLightingEnabled",{a:[c,o]},w0),e("Pass_SetPolygonMode",{a:[c,o]},y0),e("Pass_SetSceneBlending",{a:[c,o,o]},b0),e("Pass_SetSelfIllumination",{a:[c,o,o,o,o]},R0),e("Pass_SetShadingMode",{a:[c,o]},O0),e("Pass_SetShininess",{a:[c,o]},M0),e("Pass_SetSpecular",{a:[c,o,o,o,o]},S0),e("RenderTexture_Create",{a:[_,o,o],r:c},N0),e("RenderTexture_Destroy",{a:[c]},I0),e("RenderWindow_Create",{a:[c,o,o],r:c},A0),e("RenderWindow_Create2",{a:[c,_,o,o,o,o,o,o],r:c},v0),e("RenderWindow_CreateEx",{a:[c,o,o,o],r:c},x0),e("RenderWindow_Destroy",{a:[c]},P0),e("RenderWindow_Get",{a:[o],r:c},D0),e("RenderWindow_GetCount",{r:o},k0),e("RenderWindow_GetCursorHovered",{a:[c],r:o},L0),e("RenderWindow_GetCursorPosition",{a:[c,I,I]},C0),e("RenderWindow_GetKeyboardButtonPressed",{a:[c,o],r:o},G0),e("RenderWindow_GetMouseButtonPressed",{a:[c,o],r:o},B0),e("RenderWindow_GetPosition",{a:[c,I,I]},F0),e("RenderWindow_GetPrimary",{r:c},W0),e("RenderWindow_GetSize",{a:[c,I,I]},U0),e("RenderWindow_GetViewport",{a:[c,o],r:c},V0),e("RenderWindow_GetViewportCount",{a:[c],r:o},$0),e("RenderWindow_GetWheelPosition",{a:[c],r:o},j0),e("RenderWindow_SetPosition",{a:[c,o,o]},H0),e("RenderWindow_SetSize",{a:[c,o,o]},X0),e("RenderWindow_ToggleFullscreen",{a:[c],r:o},Y0),e("Root_AddResourceLocation",{a:[_,_,_,o]},z0),e("Root_AddResourceLocationFromConfigFile",{a:[_]},K0),e("Root_Create",{a:[_,_,_]},q0),e("Root_Destroy",{},Z0),e("Root_GetTime",{r:o},J0),e("Root_Initialise",{},Q0),e("Root_InitialiseAllResourceGroups",{},ey),e("Root_IsInitialised",{r:o},ty),e("Root_RenderOneFrame",{r:o},ry),e("Root_RestoreConfig",{r:o},sy),e("Root_SaveConfig",{},iy),e("Root_ShowConfigDialog",{r:o},ny),e("Scene_Clear",{a:[c]},oy),e("Scene_Create",{a:[_],r:c},cy),e("Scene_Destroy",{a:[c]},ay),e("Scene_GetCamera",{a:[c,_],r:c},ly),e("Scene_GetEntity",{a:[c,_],r:c},hy),e("Scene_GetLight",{a:[c,_],r:c},uy),e("Scene_GetParticleSystem",{a:[c,_],r:c},dy),e("Scene_GetRootSceneNode",{a:[c],r:c},fy),e("Scene_GetSceneNode",{a:[c,_],r:c},gy),e("Scene_GetShadowTechnique",{a:[c],r:o},py),e("Scene_Load",{a:[c,_]},_y),e("Scene_SetAmbientLight",{a:[c,o,o,o]},Ey),e("Scene_SetFog",{a:[c,o,o,o,o,o,o,o]},my),e("Scene_SetShadowTechnique",{a:[c,o]},Ty),e("Scene_SetSkyBox",{a:[c,o,_,o]},wy),e("Scene_SetWorldGeometry",{a:[c,_]},yy),e("SceneNode_AttachObject",{a:[c,c]},by),e("SceneNode_Create",{a:[c,_],r:c},Ry),e("SceneNode_Destroy",{a:[c]},Oy),e("SceneNode_DetachObject",{a:[c,c]},My),e("SceneNode_GetNumObjects",{a:[c],r:o},Sy),e("SceneNode_GetObject",{a:[c,o],r:c},Ny),e("SceneNode_GetScene",{a:[c],r:c},Iy),e("SceneNode_SetAutoTracking",{a:[c,c,o,o,o]},Ay),e("SceneNode_SetVisible",{a:[c,o,o]},vy),e("StringInterface_GetParameter",{a:[c,_,_]},xy),e("StringInterface_GetParameterCount",{a:[c],r:o},Py),e("StringInterface_GetParameterDescription",{a:[c,o,_]},Dy),e("StringInterface_GetParameterName",{a:[c,o,_]},ky),e("StringInterface_GetParameterType",{a:[c,o],r:o},Ly),e("StringInterface_SetParameter",{a:[c,_,_]},Cy),e("Technique_Create",{a:[c,_],r:c},Gy),e("Technique_GetPassByIndex",{a:[c,o],r:c},By),e("Technique_GetPassByName",{a:[c,_],r:c},Fy),e("TextureUnitState_Create",{a:[c,_],r:c},Wy),e("TextureUnitState_GetTexture",{a:[c,_,c]},Uy),e("TextureUnitState_SetTexture",{a:[c,_,o]},Vy),e("Viewport_AddCompositor",{a:[c,_,o],r:c},$y),e("Viewport_Create",{a:[c,c,o],r:c},jy),e("Viewport_Destroy",{a:[c]},Hy),e("Viewport_GetBackgroundColour",{a:[c,I,I,I]},Xy),e("Viewport_GetCamera",{a:[c],r:c},Yy),e("Viewport_GetCompositor",{a:[c,o],r:c},zy),e("Viewport_GetDimensions",{a:[c,I,I,I,I]},Ky),e("Viewport_GetNumCompositors",{a:[c],r:o},qy),e("Viewport_GetOverlaysEnabled",{a:[c],r:o},Zy),e("Viewport_GetRay",{a:[c,o,o,I,I,I,I,I,I]},Jy),e("Viewport_RemoveCompositor",{a:[c,c]},Qy),e("Viewport_SetBackgroundColour",{a:[c,o,o,o]},eb),e("Viewport_SetCamera",{a:[c,c]},tb),e("Viewport_SetDimensions",{a:[c,o,o,o,o]},rb),e("Viewport_SetOverlaysEnabled",{a:[c,o]},sb)}const nb={name:"ogre",deps:["windows"],register:ib,setup(e){e.egor=new Zg,e.egorShouldRender=!1,e.egorRayCastResult=null,e.egorManualObjectsSections=new WeakMap,e.beforeRender.add(()=>{e.egorShouldRender&&(e.egorShouldRender=!1,e.egor.renderAll())})}},ob=13,cb=10,ab=[1,1,2,2,4,4,4,5,8,10];function ji(e){return e<0||e>9?0:ab[e]}class Hi{constructor(t=null,r=null){this.file=r,t?this.v=new DataView(t.buffer,t.byteOffset,t.byteLength):this.v=new DataView(new ArrayBuffer(0)),this.p=0,this.width=8}copyTo(t,r,s){return r<0||r+s>this.v.byteLength?0:(t.v.byteLength<s?t.v=new DataView(this.v.buffer.slice(r,s)):new Uint8Array(t.v.buffer).set(new Uint8Array(this.v.buffer,r,s)),1)}seek(t){return this.p=t}eof(){return this.p>=this.size()?1:0}pos(){return this.p}size(){return this.v.byteLength}setWidth(t){return this.width=t,1}widthNumber(){const t=ji(this.width);if(t===0)return 0;const r=this.p,s=r+t;if(s>this.size())return 0;switch(this.p=s,this.width){case 0:return this.v.getUint8(r);case 1:return this.v.getInt8(r);case 2:return this.v.getUint16(r,!0);case 3:return this.v.getInt16(r,!0);case 4:return this.v.getUint32(r,!0);case 5:return this.v.getInt32(r,!0);case 6:return this.v.getFloat32(r,!0);case 7:throw Error("Чтение FLOAT40 не поддерживается");case 8:return this.v.getFloat64(r,!0);case 9:throw Error("Чтение FLOAT80 не поддерживается");default:return 0}}resize(t){const r=new Uint8Array(new ArrayBuffer(t));r.set(new Uint8Array(this.v.buffer)),this.v=new DataView(r.buffer)}writeWidthNumber(t){const r=ji(this.width);if(r===0)return 0;const s=this.p,i=s+r;switch(i>this.size()&&this.resize(i),this.p=i,this.width){case 0:return this.v.setUint8(s,t),1;case 1:return this.v.setInt8(s,t),1;case 2:return this.v.setUint16(s,t,!0),2;case 3:return this.v.setInt16(s,t,!0),2;case 4:return this.v.setUint32(s,t,!0),4;case 5:return this.v.setInt32(s,t,!0),4;case 6:return this.v.setFloat32(s,t,!0),4;case 7:throw Error("FLOAT40 не поддерживается");case 8:return this.v.setFloat64(s,t,!0),8;case 9:throw Error("FLOAT80 не поддерживается");default:return 0}}getLine(t,r){const s=this.p,i=Math.min(t,this.size()-s);if(i<=0)return"";let n=0,a="";for(;n<i;){const l=this.v.getUint8(s+n);n++;const h=_e[l];if(a+=h,h===r)break}return this.p+=n,a}line(){const t=this.p,r=this.size()-t;if(r<=0)return"";let s=0,i=0;for(;s<r;){const a=this.v.getUint8(t+s);if(a===0){i=1;break}if(a===ob&&s+1<r&&this.v.getUint8(t+s+1)===cb){i=2;break}s+=1}const n=Nt(new Uint8Array(this.v.buffer,t,s));return this.p=t+s+i,n}writeLine(t){const r=t+`\r
`;let s=this.p;const i=s+r.length;return i>this.size()&&this.resize(i),this.p=i,At(r).forEach((a,l)=>this.v.setUint8(s+l,a)),r.length}write(t){let r=this.p;const s=r+t.length;s>this.size()&&this.resize(s),this.p=s,t.forEach((i,n)=>this.v.setUint8(r+n,i))}bytes(){return new Uint8Array(this.v.buffer)}}function lb(e,t,r){const s=e.toUpperCase(),i=r.toUpperCase(),n=i.includes("CREATE"),a=i.includes("READONLY"),l=he.freeKey(this.kernel.streams);if(s==="FILE"){const h=this.prj.dir.resolve(t);let d=null,g=null;if(n){if(d=h.create("file",{base64:""}),!d)return 0}else{if(d=h.file(),!d)return 0;d.base64?g=ns(d.base64):re.debugFile&&this._warn(`CreateStream: Файл ${h} (${d.size} байт) существует, но формат не base64.`)}return this.kernel.streams.set(l,new Hi(g,a?null:d)),l}return s==="MEMORY"?(this.kernel.streams.set(l,new Hi),l):(console.warn(`Поток типа ${s} не поддерживается`),0)}function hb(e){const t=this.kernel.streams.get(e);if(!t)return 0;if(this.kernel.streams.delete(e),!t.file)return 1;const r=t.bytes();return t.file.set({base64:is(r)}),this.kernel.handleWrite(t.file.path,r),1}function ub(e,t){return this.kernel.streams.get(e)?.seek(t)??0}function db(e){return this.kernel.streams.get(e)?.eof()??0}function fb(e){return this.kernel.streams.get(e)?.pos()??0}function gb(e){return this.kernel.streams.get(e)?.size()??0}function pb(e,t){return this.kernel.streams.get(e)?.setWidth(t)??0}function _b(e){return this.kernel.streams.get(e)?.widthNumber()??0}function Eb(e){return this.kernel.streams.get(e)?.line()??""}function mb(e,t){return this.kernel.streams.get(e)?.writeWidthNumber(t)??0}function Tb(e,t){return this.kernel.streams.get(e)?.writeLine(t)??0}function wb(e,t,r){return this.kernel.streams.get(e)?.getLine(t,r)??""}function yb(e,t,r,s){const i=this.kernel.streams.get(e);if(!i)return 0;const n=this.kernel.streams.get(t);return n?i.copyTo(n,r,s):0}function bb(e){e("CreateStream",{a:[_,_,_],r:c},lb),e("CloseStream",{a:[c],r:o},hb),e("Seek",{a:[c,o],r:o},ub),e("Eof",{a:[c],r:o},db),e("GetPos",{a:[c],r:o},fb),e("GetSize",{a:[c],r:o},gb),e("SetWidth",{a:[c,o],r:o},pb),e("Read",{a:[c],r:o},_b),e("ReadLn",{a:[c],r:_},Eb),e("Write",{a:[c,o],r:o},mb),e("WriteLn",{a:[c,_],r:o},Tb),e("GetLine",{a:[c,o,_],r:_},wb),e("CopyBlock",{a:[c,c,o,o],r:o},yb)}const Rb={name:"streams",register:bb,setup(e){e.streams=new Map}};function Ob(e){return this.kernel._functionNotImplemented(`System(${e})`),0}function Mb(e){return Br(e)?1:0}function Sb(e,t,r,s,i){const n=this.kernel.windows.get(e);if(!n)return t[r]=0,s[i]=0,0;const a=n.mouseX+n.scene.x,l=n.mouseY+n.scene.y,h=n.invmatrix;if(!h)return t[r]=a,s[i]=l,1;const d=a*h[2]+l*h[5]+h[8];return t[r]=(a*h[0]+l*h[3]+h[6])/d,s[i]=(a*h[1]+l*h[4]+h[7])/d,1}function Nb(e){this.kernel.windowSystem.showCursor(e>0)}function Xi(e,t){const r=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!r)return;let s;switch(t){case v.CUR_ARROW:s="auto";break;case v.CUR_CROSS:s="crosshair";break;case v.CUR_TEXT:s="text";break;case v.CUR_NO:s="not-allowed";break;case v.CUR_SIZE:s="move";break;case v.CUR_SIZENESW:s="nesw-resize";break;case v.CUR_SIZENS:s="ns-resize	";break;case v.CUR_SIZENWSE:s="nwse-resize";break;case v.CUR_SIZEWE:s="ew-resize";break;case v.CUR_UPARROW:s="n-resize";break;case v.CUR_WAIT:s="wait";break;case v.CUR_LINK:s="pointer";break;case v.CUR_HELP:s="help";break;default:s="auto";break}r.setCursor(s)}function Yi(e,t){const r=typeof e=="number"?this.kernel.scenes.get(e):this.kernel.windows.get(e);if(!r)return;const s=this.prj.dir.resolve(t).file()?.cursor;r.setCursor(s?`url(${dt(s.src)}), auto`:"default")}function Ib(){return Date.now()-ia}function Ab(e,t,r,s,i,n){const a=new Date;e[t]=a.getFullYear(),r[s]=a.getMonth()+1,i[n]=a.getDate()}function vb(e,t,r,s,i,n,a,l){const h=new Date;e[t]=h.getHours(),r[s]=h.getMinutes(),i[n]=h.getSeconds(),a[l]=h.getMilliseconds()*.1}function xb(e,t,r,...[s,i,n,a,l]){if(r>4)return 0;const h=this.kernel.scenes.get(e)?.scene.objects.get(t);return h?(r<0?delete h.data.hyper:h.data.hyper={mode:r,target:s,object:i,effect:n,window:a,params:l},1):0}function Pb(e,t,r,s){const i=this.kernel.scenes.get(e);if(!i)return;const n=(i.scene.objects.get(s)??i.pick(t,r))?.data?.hyper;n&&i.hyperClick(n,{x:t,y:r})}function Db(){return this.kernel.windowSystem.windowFactory.screenWidth}function kb(){return this.kernel.windowSystem.windowFactory.screenHeight}function Lb(){return 0}function Cb(){return 0}function Gb(){return this.kernel.windowSystem.windowFactory.screenWidth}function Bb(){return this.kernel.windowSystem.windowFactory.screenHeight}function Fb(){return 0}function Wb(){return 0}function Ub(){return 0}function Vb(){return 0}function $b(){return 0}function jb(){return 0}function Hb(e,t){return this.kernel.handleExe(e,t)?1:0}function Xb(e,t,r,s){return this.kernel.handleShell(e,t,r,s)?1:0}function Yb(e){this.kernel.log(e,this)}function zb(e){e("System",{a:[o],rest:[o],r:o},Ob),e("GetAsyncKeyState",{a:[o],r:o},Mb),e("GetMousePos",{a:[_,I,I],r:o},Sb),e("ShowCursor",{a:[o]},Nb),e("LoadCursor",{a:[c,_]},Yi),e("LoadCursor",{a:[_,_]},Yi),e("SetStandartCursor",{a:[c,o]},Xi),e("SetStandartCursor",{a:[_,o]},Xi),e("GetTickCount",{r:o},Ib),e("GetTime",{a:[I,I,I,I]},vb),e("GetDate",{a:[I,I,I]},Ab),e("SetHyperJump2d",{a:[c,c,o],rest:[_],r:o},xb),e("StdHyperJump",{a:[c,o,o,c,o]},Pb),e("GetScreenWidth",{r:o},Db),e("GetScreenHeight",{r:o},kb),e("GetWorkAreaX",{r:o},Lb),e("GetWorkAreaY",{r:o},Cb),e("GetWorkAreaWidth",{r:o},Gb),e("GetWorkAreaHeight",{r:o},Bb),e("GetTitleHeight",{r:o},Fb),e("GetSmallTitleHeight",{r:o},Wb),e("GetFixedFrameWidth",{r:o},Ub),e("GetFixedFrameHeight",{r:o},Vb),e("GetSizeFrameWidth",{r:o},$b),e("GetSizeFrameHeight",{r:o},jb),e("WinExecute",{a:[_,o],r:o},Hb),e("Shell",{a:[_,_,_,o],r:o},Xb),e("LogMessage",{a:[_]},Yb)}const Kb={name:"system",deps:["windows"],register:zb};function qb(e){return e.toString()}function Zb(e,t){return e<0||e>255?"":_e[e]}function Jb(){return this.kernel.fs.appData.toString()}function Qb(e){e("FloatToString",{a:[o],r:_},qb),e("ConvertToAscii",{a:[o,o],r:_},Zb),e("GetSpecialPath",{r:_},Jb)}const eR={name:"tdl",register:Qb},zi=new Set;function Fe(...e){zi.size!==zi.add(e[0]).size&&console.warn(...e)}async function He(e,t){const r=await fetch(`https://stratum.ac.ru/enteronline/api/ta/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await r.json();if(!r.ok)throw Error(s.message);return s}async function tR(e){if(Fe("GetWordInfo",e),!e)return"";const{wordInfo:t}=await He("getWordInfo",{word:e});return t}async function rR(e,t){if(Fe("GetWordInfo",e,t),!e)return;const r=this.kernel.streams.get(t);if(!r)return;const{wordInfo:s}=await He("getWordInfo",{word:e});r.write(At(s)),r.seek(0)}async function sR(e,t,r){if(Fe("GetWordProperty",e,t,r),!e||!r)return"";const{wordProperty:s}=await He("getWordProperty",{word:e,filter:t,propName:r});return s}async function iR(e){if(Fe("GetWordFormCount",e),!e)return 0;const{wordFormCount:t}=await He("getWordFormCount",{word:e});return t}async function nR(e,t,r){if(Fe("GetWordForm",e,t,r),!e)return"";const{wordForm:s}=await He("getWordForm",{word:e,formIndex:t,formProp:r});return s}async function oR(e){if(Fe("FindNextWord",e),!e)return"";const{nextWord:t}=await He("findNextWord",{word:e});return t}async function cR(e){if(Fe("FindPrevWord",e),!e)return"";const{prevWord:t}=await He("findPrevWord",{word:e});return t}async function aR(e,t,r){return Fe("InitAnalyzer",e,t,r),1}function lR(e){e("GetWordInfo",{a:[_],r:_,kind:"async"},tR),e("GetWordInfo",{a:[_,c],kind:"async"},rR),e("GetWordProperty",{a:[_,_,_],r:_,kind:"async"},sR),e("GetWordFormCount",{a:[_],r:o,kind:"async"},iR),e("GetWordForm",{a:[_,o,_],r:_,kind:"async"},nR),e("FindNextWord",{a:[_],r:_,kind:"async"},oR),e("FindPrevWord",{a:[_],r:_,kind:"async"},cR),e("InitAnalyzer",{a:[_,_,_],r:o,kind:"async"},aR)}const hR={name:"textAnalyzer",deps:["streams"],register:lR};async function Ki({src:e,etag:t},r){let s;try{s=await fetch(`${Wn(e)}${t?"?"+t:""}`,r)}catch(n){throw n instanceof Error?Error("Сервер библиотек не отвечает"):n}if(s.status===404)throw Error(`404: Библиотека '${e}' не существует`);const i=await s.json();if(!s.ok)throw Error(i.message||"Неизвестная ошибка");return i}function uR(e,t,r,s){const{children:i}=e,n=i.length?i[0]:null,a=Es(e.scene,t,s).set({x:e.x,y:e.y,attrib:e.attrib});if(n){const l=e.attrib|nr;r?(n.set({attrib:l}),a.set({width:n.width,height:n.height})):n.set({attrib:l,width:1,height:1})}return e.set({children:i.concat(a)}),a}const Me={gspace:"wfzRA-In","scroll-x":"XuJ-kAtH","scroll-y":"W6TE00tK",hidden:"_9uw8jyO-",scene:"cl0-v9U2",frame:"stXveFcA",spacer:"V7VkKPPF"};class dR{constructor(t,r){this.space=t,this.view=r,this.onDisposed=new Ee}dispose(){this.view.remove(),this.space._removeFrame(this)}}class Wr{constructor({system:t,key:r,name:s,project:i,data:n,options:a,x:l=0,y:h=0,matrix:d=null,source:g=null,parent:E=null,sceneChildren:T}){this.isVisible=!0,this.scale=1,this.mouseX=0,this.mouseY=0,this.mouseMoveSubs=new me,this.leftButtonUpSubs=new me,this.leftButtonDownSubs=new me,this.leftButtonDoubleClickSubs=new me,this.rightButtonUpSubs=new me,this.rightButtonDownSubs=new me,this.middleButtonUpSubs=new me,this.middleButtonDownSubs=new me,this.keyDownSubs=new Set,this.keyUpSubs=new Set,this.keyCharSubs=new Set,this.controlNotifySubs=new me,this.commandSubs=new me,this.windowMoveSubs=new Set,this.spaceDoneSubs=new Set,this.sizeSubs=new Set,this.frames=new Set,this.all=new Set([this]),this.clientWidth=0,this.clientHeight=0,this.hiddenBy=null,this.currentCursor="auto",this.cursorOverHyp=!1,this.connectedWindow=null,this.spacer=null,this.scrollX=null,this.scrollY=null,this.scrolledSceneX=NaN,this.scrolledSceneY=NaN,this.lastTouchInfo=null,this.title=s,this.system=t,this.kernel=t.kernel,this.key=r,this.name=s,this.project=i,this.matrix=d,this.invmatrix=d&&Un(d),this.parent=E,this.source=g,this.x=l,this.y=h;const m=this.scene=t.sceneFactory.create(n,i.settings.graphicsBackend);T?.forEach(({key:L,klass:W})=>{const F=t.kernel.classes.get(W)?.image;if(!F||F.prior==="icon"||!F.scene?.data?.objects?.length)return;const G=m.objects.get(L);G?.type==="group"&&uR(G,F.scene.data,F.resizable)}),m.domElement.classList.add(Me.scene);const O=this.domElement=document.createElement("div");O.className=Me.gspace,O.tabIndex=0,O.setAttribute("data-gspace-name",s),O.setAttribute("data-gspace-key",r.toString()),O.append(m.domElement);const N=a.size;if(N?.type==="fixed"&&(this.clientWidth=N.width,this.clientHeight=N.height),N?.type!=="fixed"||a.autoorg||a.hscroll||a.vscroll){const L=ms(m.objects.values());m.set({x:L.x,y:L.y}),this.clientWidth<=0&&(this.clientWidth=L.w),this.clientHeight<=0&&(this.clientHeight=L.h),a.hscroll&&(this.scrollX={min:L.x,max:L.x+(a.autoscroll?0:L.w)}),a.vscroll&&(this.scrollY={min:L.y,max:L.y+(a.autoscroll?0:L.h)})}this.clientWidth<=0&&(this.clientWidth=this.system.windowFactory.screenWidth),this.clientHeight<=0&&(this.clientHeight=this.system.windowFactory.screenHeight),je(O,{...E&&{left:l-E.scene.x+"px",top:h-E.scene.y+"px"},width:this.clientWidth+"px",height:this.clientHeight+"px"});const{pointerTarget:y}=this;y.addEventListener("contextmenu",Kn);const P=this.handlePointer.bind(this);y.addEventListener("pointerdown",P),y.addEventListener("pointermove",P),y.addEventListener("pointerup",P),y.addEventListener("pointercancel",P);const C=this.handleKeyboard.bind(this);O.addEventListener("keydown",C),O.addEventListener("keyup",C),m.onInputChanged.add(this.handleInput.bind(this))}getClientWidth(){return this.domElement.clientWidth||this.clientWidth}getClientHeight(){return this.domElement.clientHeight||this.clientHeight}getWidth(){return this.domElement.offsetWidth||this.clientWidth}getHeight(){return this.domElement.offsetHeight||this.clientHeight}get pointerTarget(){return this.scene.domElement}setTitle(t){this.title=t,this.connectedWindow?.set({title:t})}setConnectedWindow(t){t.onClosed.add(this.onConnectedWindowClosed.bind(this)),this.connectedWindow=t}onConnectedWindowClosed(){this.connectedWindow=null,this.close()}setOpacity(t){const{domElement:r}=this;this.connectedWindow&&!this.isVisible||(t>=1?r.style.removeProperty("opacity"):je(r,{transition:"none",opacity:t.toString()}))}updateMouseCoords(t,r){this.mouseX=t,this.mouseY=r,this.parent?.updateMouseCoords(this.x+t,this.y+r)}syncScrollbars(){const{domElement:t,scene:r,scrollX:s,scrollY:i}=this;s&&(this.scrolledSceneX===r.x?r.set({x:s.min+t.scrollLeft}):t.scrollLeft=r.x-s.min,this.scrolledSceneX=r.x),i&&(this.scrolledSceneY===r.y?r.set({y:i.min+t.scrollTop}):t.scrollTop=r.y-i.min,this.scrolledSceneY=r.y)}beforeRender(){this.syncScrollbars(),this.scene.render()}beforeAll(){this.syncScrollbars()}afterAll(){const{domElement:t,scrollX:r,scrollY:s}=this;if(!r&&!s)return;if(!this.spacer){const d=this.spacer=document.createElement("div");d.className=Me.spacer,t.append(d)}const{spacer:i}=this;let n=r?Math.max(r.max-r.min,0):0,a=s?Math.max(s.max-s.min,0):0;const l=r&&!n,h=s&&!a;if(l||h){const d=ms(this.scene.objects.values());l&&(n=d.w),h&&(a=d.h)}if(r){t.classList.contains(Me["scroll-x"])||t.classList.add(Me["scroll-x"]);const d=Math.round(n)+"px";i.style.width!==d&&(i.style.width=d)}if(s){t.classList.contains(Me["scroll-y"])||t.classList.add(Me["scroll-y"]);const d=Math.round(a)+"px";i.style.height!==d&&(i.style.height=d)}}updateCursor(){const t=this.system.cursorVisible?this.cursorOverHyp?"pointer":this.currentCursor:"none",{domElement:r}=this;r.style.cursor!==t&&(r.style.cursor=t)}setCapture(t){this.system.setCapture(this,t)}subscribe(t,r,s,i){const n=i&1,a=this.scene.objects.get(s)??null;switch(r){case v.WM_MOVE:this.windowMoveSubs.add(t);break;case v.WM_SPACEDONE:this.spaceDoneSubs.add(t);break;case v.WM_SIZE:this.sizeSubs.add(t);break;case v.WM_CONTROLNOTIFY:(a||s===0)&&this.controlNotifySubs.set(t,a);break;case v.WM_COMMAND:(a||!n)&&this.commandSubs.set(t,a);break;case v.WM_MOUSEMOVE:(a||!n)&&this.mouseMoveSubs.set(t,n?a:null);break;case v.WM_LBUTTONDOWN:(a||!n)&&this.leftButtonDownSubs.set(t,n?a:null);break;case v.WM_LBUTTONUP:(a||!n)&&this.leftButtonUpSubs.set(t,n?a:null);break;case v.WM_LBUTTONDBLCLK:(a||!n)&&this.leftButtonDoubleClickSubs.set(t,n?a:null);break;case v.WM_RBUTTONDOWN:(a||!n)&&this.rightButtonDownSubs.set(t,n?a:null);break;case v.WM_RBUTTONUP:(a||!n)&&this.rightButtonUpSubs.set(t,n?a:null);break;case v.WM_MBUTTONDOWN:(a||!n)&&this.middleButtonDownSubs.set(t,n?a:null);break;case v.WM_MBUTTONUP:(a||!n)&&this.middleButtonUpSubs.set(t,n?a:null);break;case v.WM_ALLMOUSEMESSAGE:if(!a&&n)break;const l=n?a:null;this.mouseMoveSubs.set(t,l),this.leftButtonDownSubs.set(t,l),this.leftButtonUpSubs.set(t,l),this.leftButtonDoubleClickSubs.set(t,l),this.rightButtonDownSubs.set(t,l),this.rightButtonUpSubs.set(t,l),this.middleButtonDownSubs.set(t,l),this.middleButtonUpSubs.set(t,l);break;case v.WM_KEYDOWN:this.keyDownSubs.add(t);break;case v.WM_KEYUP:this.keyUpSubs.add(t);break;case dr:this.keyCharSubs.add(t);break;case v.WM_ALLKEYMESSAGE:this.keyDownSubs.add(t),this.keyUpSubs.add(t),this.keyCharSubs.add(t);break;default:t.kernel._functionNotImplemented(`Подписка на ${v[r]}`,t);break}}unsubscribe(t,r){switch(r){case v.WM_MOVE:this.windowMoveSubs.delete(t);break;case v.WM_SPACEDONE:this.spaceDoneSubs.delete(t);break;case v.WM_SIZE:this.sizeSubs.delete(t);break;case v.WM_CONTROLNOTIFY:this.controlNotifySubs.delete(t);break;case v.WM_COMMAND:this.commandSubs.delete(t);break;case v.WM_MOUSEMOVE:this.mouseMoveSubs.delete(t);break;case v.WM_LBUTTONDOWN:this.leftButtonDownSubs.delete(t);break;case v.WM_LBUTTONUP:this.leftButtonUpSubs.delete(t);break;case v.WM_LBUTTONDBLCLK:this.leftButtonDoubleClickSubs.delete(t);break;case v.WM_RBUTTONDOWN:this.rightButtonDownSubs.delete(t);break;case v.WM_RBUTTONUP:this.rightButtonUpSubs.delete(t);break;case v.WM_MBUTTONDOWN:this.middleButtonDownSubs.delete(t);break;case v.WM_MBUTTONUP:this.middleButtonUpSubs.delete(t);break;case v.WM_ALLMOUSEMESSAGE:this.mouseMoveSubs.delete(t),this.leftButtonDownSubs.delete(t),this.leftButtonDoubleClickSubs.delete(t),this.leftButtonUpSubs.delete(t),this.rightButtonDownSubs.delete(t),this.rightButtonUpSubs.delete(t),this.middleButtonDownSubs.delete(t),this.middleButtonUpSubs.delete(t);break;case v.WM_KEYDOWN:this.keyDownSubs.delete(t);break;case v.WM_KEYUP:this.keyUpSubs.delete(t);break;case dr:this.keyCharSubs.delete(t);break;case v.WM_ALLKEYMESSAGE:this.keyDownSubs.delete(t),this.keyUpSubs.delete(t),this.keyCharSubs.delete(t);break}}setWindowOrg(t,r){this.x=t,this.y=r,this.connectedWindow?this.connectedWindow.set({x:t,y:r}):this.parent&&je(this.domElement,{left:t-this.parent.scene.x+"px",top:r-this.parent.scene.y+"px"})}setWindowSize(t,r){this.clientWidth=t,this.clientHeight=r;const{inverseScale:s}=this;je(this.domElement,{width:t*s+"px",height:r*s+"px"})}setWindowPos(t,r,s,i){this.setWindowOrg(t,r),this.setWindowSize(s,i)}setSceneOrg(t,r){this.scene.set({x:t,y:r})}setScrollX(t,r){const{scrollX:s}=this;(!s||s.min!==t||s.max!==r)&&(this.scrollX={min:t,max:r},this.scrolledSceneX=this.scene.x-t)}setScrollY(t,r){const{scrollY:s}=this;(!s||s.min!==t||s.max!==r)&&(this.scrollY={min:t,max:r},this.scrolledSceneY=this.scene.y-t)}setCursor(t){this.currentCursor=t,this.updateCursor()}createFrame(t){t.classList.add(Me.frame),this.domElement.append(t);const r=new dR(this,t);return this.frames.add(r),r}createChild(t){const r=new Wr({...t,parent:this});return this.domElement.append(r.domElement),this.all.add(r),r}pick(t,r,s){let i=t,n=r;const a=this.matrix;if(a){const h=t*a[2]+r*a[5]+a[8];i=(t*a[0]+r*a[3]+a[6])/h,n=(t*a[1]+r*a[4]+a[7])/h}let l=this.scene.pick(i,n);if(s&&(this.system.lastPickedPrimaryKey=l?.key??0),!l)return null;for(;l.parent;)l=l.parent;return l}paste(t,r,s,i){if(!t.objects?.length)return null;let n=t;if(i&v.PFC_ALL){const g={...t};i&v.PFC_PENS&&delete g.pens,i&v.PFC_BRUHS&&delete g.brushes,i&v.PFC_DDIBS&&delete g.images,i&v.PFC_DIBS&&delete g.imagesOpaque,i&v.PFC_STRINGS&&delete g.strings,i&v.PFC_FONTS&&delete g.fonts,i&v.PFC_TEXTS&&delete g.texts,n=g}const a=Es(this.scene,n);if(!(i&v.PFC_MOVEOBJECT))return a;let l=r,h=s;const d=this.matrix;if(d){const g=r*d[2]+s*d[5]+d[8];l=(r*d[0]+s*d[3]+d[6])/g,h=(r*d[1]+s*d[4]+d[7])/g}return a.set({x:l,y:h})}async tryOpenProject(t,r){const s=this.project.dir.resolve(t);let i;try{i=await this.kernel.openProject(s)}catch(n){if(!(n instanceof Error))throw n;console.warn(`Не удалось открыть ${s}: ${n.message}`);return}if(!i){console.warn(`${s} не существует`);return}r&&this.system.hideProjectWindows(this.project,i)}hyperClick(t,r){const{project:s}=this;switch(t.object&&console.warn("Посылка WM_HYPERJUMP не реализована"),t.mode){case nc:{if(t.target){const i=t.window||"",n=t.target,a="WS_BYSPACE",l=r.x-this.scene.x,h=r.y-this.scene.y;requestAnimationFrame(()=>{const d=this.system.createGSpace(s,i,n,a,l,h);this.connectedWindow&&d?.connectedWindow?.set({preserveX:!0})})}break}case oc:{const i=t.target;if(!i)break;this.kernel.handleExe(i);break}case cc:{const i=t.target;if(!i)break;const n=t.params?.toUpperCase().includes("/HIDEWINDOWS");this.tryOpenProject(i,n);break}case ac:break;case lc:{const i=t.target?.toUpperCase();if(!i)break;switch(i){case hc:this.kernel.closeAll();break;case uc:s.close();break;default:console.warn(`Действие '${i}' не реализовано.`);break}break}default:console.warn("Неизвестный тип гиперперехода"),console.log(t)}}toTop(){this.connectedWindow?this.connectedWindow?.toTop():this.parent?.domElement.append(this.domElement)}hide(){this.isVisible=!1,this.connectedWindow?this.connectedWindow.set({visible:!1}):this.domElement.classList.add(Me.hidden)}show(){this.isVisible=!0,this.connectedWindow?this.connectedWindow.set({visible:!0}):this.domElement.classList.remove(Me.hidden)}get actualScale(){return Math.max(this.scale,.1)}get inverseScale(){return 1/this.actualScale}setScale(t){if(this.scale=t,t!==1){const{actualScale:r,inverseScale:s}=this;je(this.domElement,{transform:`scale(${r})`,width:this.clientWidth*s+"px",height:this.clientHeight*s+"px"})}else je(this.domElement,{transform:"none",width:this.clientWidth+"px",height:this.clientHeight+"px"})}_hide(t){this.hiddenBy=t,this.hide()}_restoreIfHiddenBy(t){this.hiddenBy===t&&(this.hiddenBy=null,this.show())}_dispose(){this.parent?.all.delete(this),this.scene.dispose(),this.frames.forEach(t=>t.onDisposed.dispatch()),this.frames.clear(),this.connectedWindow?.remove(),this.handleClose()}_removeFrame(t){this.frames.delete(t)}close(){this.system._closeWindows(this.all)}handlePointer(t){if(!t.isPrimary||t.target!==t.currentTarget)return;this.updateMouseCoords(t.offsetX,t.offsetY);const{captureTarget:r}=this.system;if(r){const s=r.w;if(s.pointerTarget.setPointerCapture(t.pointerId),s!==this)return}this.kernel.canRunMainTask()&&this.kernel.runMainTask(this.sendMouseMessages(t))}*sendMouseMessages(t){const{captureTarget:r}=this.system,{scene:s}=this,i=Math.round(t.offsetX+s.x),n=Math.round(t.offsetY+s.y);let a=s.pick(i,n);for(;a;){const P=a.parent;if(!P)break;a=P}const l=a?.data?.hyper;let h,d;switch(t.type){case"pointerdown":{switch(t.button){case 0:const P=Date.now();this.lastTouchInfo&&P-this.lastTouchInfo.time<300&&Math.abs(i-this.lastTouchInfo.x)<10&&Math.abs(n-this.lastTouchInfo.y)<10?(d=v.WM_LBUTTONDBLCLK,h=this.leftButtonDoubleClickSubs,this.lastTouchInfo=null):(l&&!l.disabled&&this.hyperClick(l,{x:i,y:n}),d=v.WM_LBUTTONDOWN,h=this.leftButtonDownSubs,this.lastTouchInfo={time:P,x:i,y:n});break;case 1:d=v.WM_MBUTTONDOWN,h=this.middleButtonDownSubs;break;case 2:d=v.WM_RBUTTONDOWN,h=this.rightButtonDownSubs;break;default:return}break}case"pointerup":case"pointercancel":{switch(t.button){case 0:d=v.WM_LBUTTONUP,h=this.leftButtonUpSubs;break;case 1:d=v.WM_MBUTTONUP,h=this.middleButtonUpSubs;break;case 2:d=v.WM_RBUTTONUP,h=this.rightButtonUpSubs;break;default:return}break}case"pointermove":{this.cursorOverHyp=!!l&&!l.disabled,this.updateCursor(),d=v.WM_MOUSEMOVE,h=this.mouseMoveSubs;break}default:return}let g=i,E=n;const T=this.invmatrix;if(T){const P=i*T[2]+n*T[5]+T[8];g=(i*T[0]+n*T[3]+T[6])/P,E=(i*T[1]+n*T[4]+T[7])/P}const m=t.buttons&1?1:0,O=t.buttons&2?2:0,N=t.buttons&4?16:0,y=m|O|N;for(const[P,C]of h){if(!(r&&r.w===this&&r.s===P||C.has(a)||C.has(null))||!this.kernel.canHandleProjectUiEvents(P.prj))continue;const{msg:W,xpos:F,ypos:G,fwkeys:D}=P.klass.vars;W&&(P.vars.setValue(W,d),F&&P.vars.setValue(F,g),G&&P.vars.setValue(G,E),D&&P.vars.setValue(D,y),yield*P.compute(!0))}}handleKeyboard(t){t.target!==t.currentTarget||typeof t.winVKey!="number"||this.kernel.canRunMainTask()&&this.kernel.runMainTask(this.sendKeyboardMessages(t))}*sendKeyboardMessages(t){const r=t.winVKey;let s,i;switch(t.type){case"keydown":s=v.WM_KEYDOWN,i=this.keyDownSubs;break;case"keyup":s=v.WM_KEYUP,i=this.keyUpSubs;break;default:return}for(const a of i){const{msg:l,wvkey:h,repeat:d,scancode:g}=a.klass.vars;!l||!this.kernel.canHandleProjectUiEvents(a.prj)||(a.vars.setValue(l,s),h&&a.vars.setValue(h,r),d&&a.vars.setValue(d,1),g&&a.vars.setValue(g,0),yield*a.compute(!0))}const{winChar:n}=t;if(n)for(const a of this.keyCharSubs){const{msg:l,wvkey:h,repeat:d,scancode:g}=a.klass.vars;l&&(a.vars.setValue(l,dr),h&&a.vars.setValue(h,n),d&&a.vars.setValue(d,1),g&&a.vars.setValue(g,0),yield*a.compute(!0))}}handleInput(t){this.kernel.canRunMainTask()&&this.kernel.runMainTask(this.sendControlMessages(t))}*sendControlMessages(t){let r,s;switch(t.type){case"input":r=768,s=1024;break;case"focus":r=s=256;break;case"blur":r=s=512;break;case"click":r=s=0;break;default:return}for(const[i]of this.commandSubs){const{msg:n,_hobject:a,iditem:l,wnotifycode:h}=i.klass.vars;n&&(i.vars.setValue(n,v.WM_COMMAND),a&&i.vars.setValue(a,t.target.key),l&&i.vars.setValue(l,0),h&&i.vars.setValue(h,s),yield*i.compute(!0))}for(const[i,n]of this.controlNotifySubs){if(!(n.has(t.target)||n.has(null)))continue;const{msg:l,_hobject:h,iditem:d,wnotifycode:g}=i.klass.vars;l&&(i.vars.setValue(l,v.WM_CONTROLNOTIFY),h&&i.vars.setValue(h,t.target.key),d&&i.vars.setValue(d,0),g&&i.vars.setValue(g,r),yield*i.compute(!0))}}handleClose(){this.kernel.runParallelTask(this.sendSpaceDoneMessages())}*sendSpaceDoneMessages(){const{key:t,name:r}=this;for(const s of this.spaceDoneSubs){const{msg:i,_hspace:n,_windowName:a}=s.klass.vars;i&&(s.vars.setValue(i,v.WM_SPACEDONE),n&&s.vars.setValue(n,t),a&&s.vars.setValue(a,r),yield*s.computeBranch())}}}function fR(e,t){const r=e.toUpperCase(),s=r.includes("WS_CHILD"),i=r.includes("WS_BYSPACE"),n=r.includes("WS_POPUP"),a=r.includes("WS_NORESIZE"),l=r.includes("WS_AUTOORG"),h=r.includes("WS_SPACESIZE"),d=r.includes("WS_NOCAPTION"),g=r.includes("WS_VSCROLL"),E=r.includes("WS_HSCROLL"),T=r.includes("WS_TOOL"),m=i?{...t}:{};return s&&(m.child=!0),E&&(m.hscroll=!0),g&&(m.vscroll=!0),h&&(m.size={type:"content"}),a&&(m.fixed=!0),n&&(m.popup=!0),l&&(m.autoorg=!0),d||(m.caption=!0),T&&(m.tool=!0),m}class gR{constructor(t,{sceneFactory:r,windowFactory:s}){this.kernel=t,this.scenes=new Map,this.windows=new Map,this.cursorVisible=!0,this.captureTarget=null,this.lastPickedPrimaryKey=0,this.clipboard=null,this.sceneFactory=r,this.windowFactory=s}createGSpace(t,r,s,i,n=0,a=0,l=0,h=0,d=""){let g=r;if(g){const L=this.windows.get(g);if(L)return L}let E=null,T=null,m=null;if(s){const L=this.kernel.classes.get(s),W=L?.scene;if(W)E=W,T={type:"classname",data:L.name},m=L.children;else{const F=t.dir.resolve(s),G=F.file()?.scene;G&&(E=G,T={type:"filename",data:F.toString()})}}if(!g){if(!E)return this.kernel._functionNotImplemented("Пустая сцена без имени"),null;g=E.options?.popup?"@PopupWindow":"MainWindow";const L=this.windows.get(g);if(L)return L}const O=fR(i,E?.options);!O.size&&l>0&&h>0&&(O.size={type:"fixed",width:l,height:h});const N=he.freeKey(this.scenes),y={system:this,project:t,key:N,name:g,x:n,y:a,...E,options:O,source:T,sceneChildren:m},P=O.child&&this.windows.get(d);if(!this.kernel.iterations&&!P&&O.popup&&!O.tool)return console.warn(`Невозможно открыть всплывающее окно '${g}' в координатах ${n}, ${a}`),null;const C=P?P.createChild(y):this.createWindow(y);return this.scenes.set(N,C),this.windows.set(g,C),C}createWindow(t){const r=new Wr(t),{x:s,y:i,name:n}=t,{popup:a=!1,caption:l=!1,tool:h=!1}=t.options,d=this.windowFactory.createWindow({content:r.domElement,x:s,y:i,title:n,popup:a,caption:l,closeOnFocusOut:a&&!h});return r.setConnectedWindow(d),r}setCapture(t,r){this.captureTarget={w:t,s:r}}releaseCapture(){this.captureTarget=null}showCursor(t){this.cursorVisible=t,this.windows.forEach(r=>r.updateCursor())}_closeWindows(t){this.scenes.forEach(r=>{t.has(r)&&(r===this.captureTarget?.w&&(this.captureTarget=null),r._dispose(),this.scenes.delete(r.key),this.windows.delete(r.name))})}clearAll(){this.scenes.clear(),this.windows.clear(),this.cursorVisible=!0,this.lastPickedPrimaryKey=0}hideProjectWindows(t,r){this.windows.forEach(s=>{s.project===t&&s._hide(r)})}closeProjectWindows(t){const r=new Set([...this.windows.values()].filter(s=>s.project===t));this._closeWindows(r),this.windows.forEach(s=>s._restoreIfHiddenBy(t))}}function pR(e,t,r,s,i,n,a,l){return this.kernel.windowSystem.createGSpace(this.prj,e,r,l,s,i,n,a,t)?.key||0}function _R(e){return this.kernel.windows.get(e)?.getClientWidth()??0}function ER(e){return this.kernel.windows.get(e)?.getClientHeight()??0}function mR(e){return this.kernel.scenes.get(e)?.name??""}function TR(e){return this.kernel.windows.get(e)?.x??0}function wR(e){return this.kernel.windows.get(e)?.y??0}function yR(e){return this.kernel.windows.get(e)?.key??0}function bR(e){return this.kernel.windows.get(e)?.getWidth()??0}function RR(e){return this.kernel.windows.get(e)?.getHeight()??0}function OR(e){return this.kernel.windows.get(e)?.title??""}function MR(e,t,r){const s=this.kernel.windows.get(e);return s?(s.setWindowSize(t,r),1):0}function SR(e,t,r,s){const i=this.kernel.windows.get(e);return i?(t>0?i.setScrollX(r,s):i.setScrollY(r,s),1):0}function NR(e,t,r){const s=this.kernel.windows.get(e);return s?(s.setWindowOrg(t,r),1):0}function IR(e,t,r,s,i){const n=this.kernel.windows.get(e);return n?(n.setWindowPos(t,r,s,i),1):0}function AR(e,t,r){const s=this.kernel.windows.get(e);return s?(s.setWindowSize(t,r),1):0}function vR(e,t){const r=this.kernel.windows.get(e);return r?(r.setTitle(t),1):0}function qi(e,t){const r=typeof e=="string"?this.kernel.windows.get(e):this.kernel.scenes.get(e);return r?(r.setOpacity(jn(t,0,100)*.01),1):0}function Zi(){return this.kernel._functionNotImplemented("SetWindowTransparentColor"),1}function Ji(e,t){return t?(this.kernel._functionNotImplemented("SetWindowRegion"),1):0}function xR(){return this.kernel._functionNotImplemented("SetWindowOwner"),1}function PR(e,t){const r=this.kernel.windows.get(e);if(!r)return 0;switch(t){case v.SW_HIDE:r.hide();break;case v.SW_SHOW:case v.SW_NORMAL:r.show();break}return 1}function DR(e){const t=this.kernel.windows.get(e);return t?(t.toTop(),1):0}function kR(e){const t=this.kernel.windows.get(e);return t?(t.close(),1):0}function LR(){return 0}function CR(e){return this.kernel.windows.has(e)?1:0}function GR(e){return this.kernel.windows.get(e)?.isVisible?1:0}function BR(e,t,r){return this.kernel.windowSystem.createGSpace(this.prj,e,t,r)?.key||0}function FR(e,t,r){return this.kernel.windowSystem.createGSpace(this.prj,e,t,r)?.key||0}function WR(){return this.kernel._functionNotImplemented("OpenClassScheme"),1}function UR(){return this.kernel._functionNotImplemented("CloseClassScheme"),1}function VR(){}function $R(){}function jR(){}function HR(e,t){const r=this.kernel.windows.get(e)?.source;return r&&r.type===t.toLowerCase()&&r.data||""}function XR(e){e("CreateWindowEx",{a:[_,_,_,o,o,o,o,_],r:c},pR),e("GetClientWidth",{a:[_],r:o},_R),e("GetClientHeight",{a:[_],r:o},ER),e("GetWindowName",{a:[c],r:_},mR),e("GetWindowOrgX",{a:[_],r:o},TR),e("GetWindowOrgY",{a:[_],r:o},wR),e("GetWindowSpace",{a:[_],r:c},yR),e("GetWindowWidth",{a:[_],r:o},bR),e("GetWindowHeight",{a:[_],r:o},RR),e("GetWindowTitle",{a:[_],r:_},OR),e("SetClientSize",{a:[_,o,o],r:o},MR),e("SetScrollRange",{a:[_,o,o,o],r:o},SR),e("SetWindowOrg",{a:[_,o,o],r:o},NR),e("SetWindowPos",{a:[_,o,o,o,o],r:o},IR),e("SetWindowSize",{a:[_,o,o],r:o},AR),e("SetWindowTitle",{a:[_,_],r:o},vR),e("SetWindowTransparent",{a:[_,o],r:o},qi),e("SetWindowTransparent",{a:[c,o],r:o},qi),e("SetWindowTransparentColor",{a:[_,X],r:o},Zi),e("SetWindowTransparentColor",{a:[c,X],r:o},Zi),e("SetWindowRegion",{a:[_,c],r:o},Ji),e("SetWindowRegion",{a:[c,c],r:o},Ji),e("SetWindowOwner",{a:[c,c],r:o},xR),e("ShowWindow",{a:[_,o],r:o},PR),e("BringWindowToTop",{a:[_],r:o},DR),e("CloseWindow",{a:[_],r:o},kR),e("IsIconic",{a:[_],r:o},LR),e("IsWindowExist",{a:[_],r:o},CR),e("IsWindowVisible",{a:[_],r:o},GR),e("LoadSpaceWindow",{a:[_,_,_],r:c},BR),e("OpenSchemeWindow",{a:[_,_,_],r:c},FR),e("OpenClassScheme",{a:[_,o],r:c},WR),e("CloseClassScheme",{a:[_],r:o},UR),e("CascadeWindows",{},VR),e("Tile",{a:[o]},$R),e("ArrangeIcons",{},jR),e("GetWindowProp",{a:[_,_],r:_},HR)}const YR=[{name:"windows",register:XR,setup(e,t){if(!t)throw Error("Плагин 'windows': не указаны зависимости");const r=new gR(e,t);e.windowSystem=r,e.windows=r.windows,e.scenes=r.scenes,e.beforeProjectClosed.add(s=>r.closeProjectWindows(s)),e.beforeCompute.add(()=>r.windows.forEach(s=>s.beforeAll())),e.afterCompute.add(()=>r.windows.forEach(s=>s.afterAll())),e.beforeRender.add(()=>r.windows.forEach(s=>s.beforeRender()))}},Rb,ba,Ua,hl,fh,Ud,Ml,y_,S_,$_,sE,nb,r_,Kb,ih,eR,Yl,hR];function zR(e){e.style.transformOrigin="top left",e.insertAdjacentHTML("afterend",`
<div id="mobzoom-icons-container">
    <img draggable="false" id="mobzoom-in-btn" src="images/zoom-in-icon.svg" />
    <img draggable="false" id="mobzoom-out-btn" src="images/zoom-out-icon.svg" />
</div>`);const r=document.getElementById("mobzoom-in-btn");r.oncontextmenu=D=>D.preventDefault();const s=document.getElementById("mobzoom-out-btn");s.oncontextmenu=D=>D.preventDefault();const i=new xt(e.ownerDocument.defaultView);let n=1;const a=()=>{if(!isNaN(l))n*=1.05;else if(!isNaN(h))n*=.95;else return!1;return n=Math.min(Math.max(n,.1),1),e.style.transform=`scale(${n})`,e.style.width=`${100/n}%`,e.style.height=`${100/n}%`,!0};let l=NaN;r.onpointerdown=D=>{isNaN(l)&&(i.run(a),r.setPointerCapture(l=D.pointerId))},r.onpointerup=D=>{l===D.pointerId&&(l=NaN)},r.onpointercancel=D=>{l===D.pointerId&&(l=NaN)};let h=NaN;s.onpointerdown=D=>{isNaN(h)&&(i.run(a),s.setPointerCapture(h=D.pointerId))},s.onpointerup=D=>{h===D.pointerId&&(h=NaN)},s.onpointercancel=D=>{h===D.pointerId&&(h=NaN)};const d=new xt(e.ownerDocument.defaultView);let g=null;const E=new Map;let T=0,m=0;function O(D){if(!(E.size>2)){if(E.size<2){g=null,(Math.abs(T)>1||Math.abs(m)>1)&&d.run(()=>(T-=Math.sign(T)*.4,m-=Math.sign(m)*.4,e.scrollLeft-=T,e.scrollTop-=m,Math.abs(T)>1||Math.abs(m)>1));return}D.stopPropagation();{g=[...E.values()];const[x,j]=g;x.x-j.x,x.y-j.y}}}let N=null;function y(D){E.set(D.pointerId,{id:D.pointerId,x:D.screenX,y:D.screenY}),d.stop(),D.isPrimary&&(N=[D.clientX,D.clientY]),O(D)}function P(D){E.delete(D.pointerId),D.isPrimary&&(N=null,C.stop()),O(D)}const C=new xt(e.ownerDocument.defaultView),L=100;let W=[0,0];function F(){const[D,x]=W;if(N){const Q=D-N[0],ue=x-N[1];if(Q**2+ue**2<100)return!1}let j=0,Z=0;if(D<L)j=D-L;else{const Q=window.innerWidth-D;Q<L&&(j=L-Q)}if(j/=40,x<L)Z=x-L;else{const Q=window.innerHeight-x;Q<L&&(Z=L-Q)}return Z/=40,j&&(e.scrollLeft+=Math.E**Math.abs(j)*Math.sign(j)),Z&&(e.scrollTop+=Math.E**Math.abs(Z)*Math.sign(Z)),!0}function G(D){if(!g&&D.isPrimary?(W[0]=D.clientX,W[1]=D.clientY,C.run(F)):C.stop(),!g)return;const x=E.get(D.pointerId);if(x){D.isPrimary||(D.stopPropagation(),T=D.screenX-x.x,m=D.screenY-x.y,e.scrollLeft-=T,e.scrollTop-=m);{const[j,Z]=g;j.x-Z.x,j.y-Z.y}x.x=D.screenX,x.y=D.screenY}}e.addEventListener("pointerdown",y,{capture:!0}),e.addEventListener("pointerup",P),e.addEventListener("pointercancel",P),e.addEventListener("pointermove",G,{capture:!0})}const bt={root:"ca85FLNJ",mywindow:"xTNo9oHR",top:"mzQLXysK",popup:"_7gglv7SA","close-button":"c6XZRF-R"};function KR(){const e=document.createElement("button");return e.textContent="×",e.className=bt["close-button"],e}class qR{constructor(t,{popup:r,content:s,...i},n=null){this.system=t,this.relativeTo=n,this.onClosed=new Ee,this.x=0,this.y=0,this.width=0,this.height=0,this.title="",this.visible=!0,this.scale=1,this.instantClose=!1,this.isClosed=!1,this.hideTimeout=0;const a=this.view=s;if(this.popup=r||!1,this.set(i),this.width=a.clientWidth,this.height=a.clientHeight,queueMicrotask(this.appear.bind(this)),r)i.closeOnFocusOut&&a.addEventListener("focusout",this.onFocusOut.bind(this));else if(i.caption){const l=KR();a.children.item(0)?.append(l),l.addEventListener("click",this.close.bind(this)),this.instantClose=!0}}appear(){this.visible&&(this.view.style.opacity="1")}onFocusOut(t){this.view.contains(t.relatedTarget)||this.close()}close(){this.isClosed||(this.isClosed=!0,this.remove(),this.onClosed.dispatch())}toTop(){}set({x:t=this.x,y:r=this.y,title:s=this.title,visible:i=this.visible,preserveX:n}){const{view:a}=this,{style:l}=a;if(this.title!==s&&(this.view.ariaLabel=`Окно '${s}'`),this.popup){if(n){const h=this.relativeTo?.offsetLeft||0;l.setProperty("left",t+h+"px"),l.setProperty("right","unset")}else l.removeProperty("left"),l.removeProperty("right");if(this.y!==r){const h=this.relativeTo?.offsetTop||0;l.setProperty("top",r+h+"px")}}return this.visible!==i&&(this.view.style.opacity=i?"1":"0",this.hideTimeout&&window.clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>this.view.style.setProperty("display",i?"block":"none"),i?0:250)),this.x=t,this.y=r,this.title=s,this.visible=i,this}makeRelativeTo(t){if(this.popup){const{style:r}=this.view,s=t.offsetLeft();console.log(this.x,s),r.setProperty("left",this.x+s+"px"),r.setProperty("right","unset");const i=t.offsetTop();r.setProperty("top",this.y+i+"px")}}offsetLeft(){return this.view.offsetLeft}offsetTop(){return this.view.offsetTop}remove1(){this.view.style.opacity="0",setTimeout(()=>this.view.remove(),250)}remove(){this.system._removeWindow(this),this.popup?this.remove1():this.remove1()}}const ZR={root:"stratum-player-root"};class JR{constructor(t){this.firstWindow=null;const r=(typeof t=="string"?document.getElementById(t):t)||document.body,s=this.root=document.createElement("div");s.classList.add(bt.root,ZR.root),r.append(s),re.isMobile&&zR(r)}get screenWidth(){return this.root.clientWidth}get screenHeight(){return this.root.clientHeight}_removeWindow(t){this.firstWindow===t&&(this.firstWindow=null)}createWindow(t){const r=t.content;r.classList.add(bt.mywindow,t.popup?bt.popup:bt.top),r.style.opacity="0";let{x:s=0,y:i=0}=t;this.root.appendChild(r),t.popup&&(s=Math.max(s,0),i=Math.max(i,0),r.offsetHeight&&(i=Math.min(i,this.screenHeight-r.offsetHeight-16)),je(r,{left:s+"px",top:i+"px"}));const n=document.activeElement?.hasAttribute("data-gspace-key")?document.activeElement:null,a=new qR(this,{...t,x:s,y:i},n);return!t.popup&&!this.firstWindow&&(this.firstWindow=a),requestAnimationFrame(()=>r.focus({preventScroll:!0})),a}dispose(){this.root.remove()}}class Ur{constructor(t=""){this.name=t,this.type="folder",this.items=new Map}}class Vr{constructor(t,r){this.root=t,this.stdlibDir=r,this.uploadsDir=new ge(this.root,["C:","Uploads"]),this.downloadsDir=new ge(this.root,["C:","Downloads"]),this.appData=new ge(this.root,["C:","Users","User","AppData","Roaming"]),this.loadedLibs=new Set,this.uploadsDir.create("folder"),this.downloadsDir.create("folder")}static async create(){const t=new Ur,r=new ge(t,["C:","library"]),{files:s}=await Ki({src:Fn});return s.forEach(i=>r.resolve(i.path).createWithDirs(i)),new Vr(t,r)}async mountLibrary(t){if(this.loadedLibs.size===this.loadedLibs.add(t.src).size)return;const{files:r}=t.data||await Ki(t,{cache:re.cache});r.forEach(s=>this.path(t.mount?`${t.mount}/${s.path}`:s.path).createWithDirs(s))}path(t){return new ge(this.root,["D:"].concat(t.split("/")))}}class Qi{constructor(t,r={}){this.path=t,this.type="file",this.size=null,this.cls=null,this.image=null,this.scene=null,this.video=null,this.audio=null,this.ttf=null,this.cursor=null,this.stt=null,this.mat=null,this.base64=null,this.mesh=null,this.set(r)}set({size:t=this.size,cls:r=this.cls,image:s=this.image,scene:i=this.scene,video:n=this.video,audio:a=this.audio,ttf:l=this.ttf,cursor:h=this.cursor,stt:d=this.stt,mat:g=this.mat,mesh:E=this.mesh,base64:T=this.base64}){return this.size=t,this.cls=r,this.image=s,this.scene=i,this.video=n,this.audio=a,this.ttf=l,this.cursor=h,this.stt=d,this.mat=g,this.mesh=E,this.base64=T,this}}class ge{constructor(t,r,s){if(this.fs=t,this.parts=r,this.str=null,r[0].length!==2&&r[0][1]!==":")throw Error("Неправильное имя тома диска");this.partsUC=s??r.map(i=>i.toUpperCase())}static splitPath(t){return t.split(/[/\\]/).map(r=>r.trim()).filter(r=>r.length>0)}resolve(t){const r=ge.splitPath(t);if(!r.length)return this;const s=r[0].length===2&&r[0][1]===":",i=s?[r[0]]:this.parts.slice(),n=s?[r[0].toUpperCase()]:this.partsUC.slice();for(let a=s?1:0;a<r.length;++a){const l=r[a];l===".."?i.length>1&&(i.pop(),n.pop()):l!=="."&&(i.push(l),n.push(l.toUpperCase()))}return new ge(this.fs,i,n)}toString(){return this.str?this.str:this.str=this.parts.join("\\")}basename(){return this.parts[this.parts.length-1]}equals(t){if(this===t)return!0;const r=this.partsUC,s=t.partsUC;if(r.length!==s.length)return!1;for(let i=0;i<r.length;++i)if(r[i]!==s[i])return!1;return!0}startsWith(t){const r=this.partsUC,s=t.partsUC;if(r.length<s.length)return!1;for(let i=0;i<s.length;++i)if(r[i]!==s[i])return!1;return!0}static getFolder(t,r,s){let i=t;for(let n=0;n<r.length-(s?0:1);++n){const a=i.items.get(r[n]);if(!a||a.type!=="folder")return null;i=a}return i}create(t,r){const{partsUC:s}=this,i=ge.getFolder(this.fs,s);if(!i)return null;const n=s[s.length-1],a=i.items.get(n);if(t==="folder")return a||i.items.set(n,new Ur),this;if(a)return a.type!=="file"?null:(r&&a.set(r),a);const l=new Qi(this,r);return i.items.set(n,l),l}createWithDirs(t){const{parts:r,partsUC:s}=this;let i=this.fs;for(let h=0;h<r.length-1;++h){let d=i.items.get(s[h]);if(!d)d=new Ur(r[h]),i.items.set(s[h],d);else if(d.type==="file")throw Error(`Невозможно создать директорию ${this}: файл ${d.path} уже существует.`);i=d}const n=s[s.length-1];if(i.items.has(n))throw Error(`Невозможно создать директорию ${this}: файл уже существует.`);const l=new Qi(this,t);return i.items.set(n,l),l}fileExist(){const{partsUC:t}=this,r=ge.getFolder(this.fs,t);if(!r)return!1;const s=t[t.length-1];return r.items.get(s)?.type==="file"}file(){const{partsUC:t}=this,r=ge.getFolder(this.fs,t);if(!r)return re.debugFile&&console.warn(`${this.toString()} не существует`),null;const s=t[t.length-1],i=r.items.get(s);return i?i.type!=="file"?(re.debugFile&&console.warn(`${this.toString()} является каталогом`),null):i:(re.debugFile&&console.warn(`${this.toString()} не существует`),null)}forEach(t,r){const{partsUC:s}=this,i=ge.getFolder(this.fs,s,!0);i&&i.items.forEach(function n(a){a.type==="folder"?r&&a.items.forEach(n):t(a)})}matchGlob(){const{partsUC:t}=this,r=ge.getFolder(this.fs,t);if(!r)return[];const s=t[t.length-1];if(s.includes("*")){const[a,l]=s.split("*");let h;return!a&&!l?h=[".","..",...r.items]:h=[...r.items].filter(([d])=>d.startsWith(a)&&d.endsWith(l)),h.map(d=>{if(typeof d=="string")return{name:d,size:0};const g=d[1];return g.type==="folder"?{name:g.name,size:0}:{name:g.path.basename(),size:g.size??0}})}const i=r.items.get(s);return i?[i.type==="folder"?{name:i.name,size:0}:{name:i.path.basename(),size:i.size??0}]:[]}}class QR{create(t,r){return new Jo(t)}}async function eO(e){const t=await Vr.create(),r=new JR(re.root),s=r.root.ownerDocument.defaultView||window,i=new Qc(t,e,s),a={sceneFactory:new QR,windowFactory:r};for(const l of YR)await i.setupPlugin(l,a);return new ea(i).ready()}const tO="0.7.0";return ut.create=eO,ut.options=re,ut.version=tO,Object.defineProperty(ut,Symbol.toStringTag,{value:"Module"}),ut})({});
;var $GH_COMMIT = 'ffbc041 feat(player): [plugins/db] Рефакторинг плагина';
